### CRM ПРОФИ (минималистичная “как amo, но проще”)

Сейчас в репозитории собран **рабочий каркас CRM** и уже реализован ряд важных улучшений по UX, безопасности и инфраструктуре:
- **Роли доступа** (вся база компаний видна всем; редактирование — по правилам: создатель/ответственный/директор филиала/управляющий/админ)
- **Компании / Контакты / Заметки по компании**
- **Задачи** (с полем под повторы RRULE) + **подсветка статусов/просрочки**
- **Импорт из amoCRM CSV** с дедупликацией компаний по **ИНН → имя+адрес**
- **JWT авторизация** + Django Admin для админки
- **Телефония / Android‑MVP**: кнопка «Позвонить с телефона» и сбор статуса звонков
- **Рассылки**: кампании, получатели по компаниям/контактам, массовое удаление писем
- **Celery + Redis**: фоновые задачи (рассылки, очистка старых звонков), health‑check `/health/`

### Что реализовано (кратко)
- **UI/UX “в наших цветах”**: мини дизайн‑система (карточки/кнопки/таблицы/бейджи), компактное левое меню с иконками, мобильный off‑canvas.
- **Рабочий стол**: блоки **Просрочено / На сегодня / На неделю / Новые назначения** (чтобы при входе сразу видеть, что назначили).
- **Сферы деятельности**: компактный мультиселект (поиск + чекбоксы), удобнее и занимает меньше места.
- **Дубли компаний при создании**: живая проверка + причины совпадения (например: ИНН/КПП/Название/Адрес).
- **Безопасность экспорта базы**: экспорт доступен только админам + **аудит‑лог** всех попыток (успешных/заблокированных).
- **Заметки**: удалять можно только **свои** заметки (и это логируется).
- **Имена пользователей**: в интерфейсе отображается **Имя Фамилия** (логин только для входа).
- **Уведомления**: базовая панель уведомлений (счётчики/прочитано).

### Roadmap (план развития)

#### Android-приложение “Позвонить с телефона” (как «Мои звонки») — на будущее
- **Цель**: сотрудник кликает в CRM по телефону → на Android открывается набор номера (1 тап до звонка).
- **Платформа**: только **Android** (iPhone не планируем).
- **Почему приложение (не PWA)**: стабильные push-уведомления (FCM), работа в фоне, надёжная доставка команд.
- **Как будет работать (MVP)**:
  - **Установка**: на старте ставим **APK вручную** (без Google Play).
  - **Привязка устройства**: приложение логинится в CRM (JWT) и отправляет **FCM token** → CRM сохраняет токен у пользователя.
  - **Клик в CRM**: “Позвонить с телефона” у номера контакта → CRM отправляет push через **Firebase (FCM)** на телефон пользователя.
  - **На телефоне**: приложение получает push и открывает системную звонилку через `ACTION_DIAL` с номером (остаётся нажать “Вызов”).
  - **Логи**: CRM пишет событие “запрос на звонок” (кто, кому, номер, когда).
- **Экраны приложения (MVP)**:
  - Подключение к CRM (логин/пароль или токен)
  - Входящий запрос на звонок (номер + контакт/компания, кнопка “Открыть номер”)
  - (опционально) История последних запросов

#### Установка APK вручную (как будем распространять менеджерам)
- Собираем **release APK** (Android Studio / Gradle `assembleRelease`) и подписываем keystore.
- Раздача:
  - самый простой старт — отправить `app-release.apk` в чат/почту;
  - удобнее — положить APK на домен CRM (например, отдельная ссылка/страница загрузки).
- На телефоне: включить “Установка из неизвестных источников” для браузера/файлового менеджера → установить.
- Обновления: выпускаем новый APK с увеличенным `versionCode` → устанавливаем поверх (или через ту же ссылку).

#### Нужно ли отдельное размещение на VDS / Docker?
- **Отдельный сервис не нужен**: отправка FCM делается из текущего Django (это обычный HTTPS-запрос к Firebase).
- На VDS можно (опционально) хранить APK как файл для скачивания — но это не обязательно для работы “Позвонить с телефона”.

### MVP “Позвонить с телефона” — уже в разработке (polling, без Firebase)
Для быстрого теста мы сделали MVP без внешних сервисов:
- CRM создаёт **CallRequest** (команду на звонок) при клике “Позвонить с телефона” в карточке компании.
- Android-приложение **опрашивает** CRM раз в ~1–2 сек и при получении команды открывает системную звонилку (`ACTION_DIAL`).

#### Как протестировать end-to-end
1) Обнови CRM и применяй миграции:

```bash
cd /opt/proficrm
git pull
docker compose -f docker-compose.yml -f docker-compose.vds.yml up -d --build
docker compose -f docker-compose.yml -f docker-compose.vds.yml exec web python manage.py migrate
```

2) В CRM зайди в компанию → контакт → рядом с телефоном появится кнопка **“Позвонить с телефона”**.

3) Собери APK (Android Studio):
- Открой проект: `android/CRMProfiDialer`
- Build → **Build APK(s)**
- Готовый файл: `android/CRMProfiDialer/app/build/outputs/apk/debug/app-debug.apk`

4) Установи APK на Android (включи “Установка из неизвестных источников”).

5) В приложении:
- Base URL: `https://crm.groupprofi.ru` (или твой домен)
- Логин/пароль CRM
- Нажми **Войти** → включи **Слушать команды**

6) На ПК в CRM нажми **“Позвонить с телефона”** → через 1–2 секунды на телефоне откроется экран набора номера.

#### Ограничения MVP
- Приложение должно быть **открыто** (polling работает внутри приложения). Push/фон — следующий шаг (Firebase FCM).

### Запуск локально (Windows)
1) Установи зависимости:

```bash
cd backend
python -m pip install --user -r requirements.txt
```

2) Создай `backend/.env` (в проекте dot-файлы могут быть заблокированы, поэтому просто скопируй `backend/env.example` в `backend/.env` вручную) и отредактируй при необходимости.

3) Миграции + админ:

```bash
cd backend
python manage.py migrate
python manage.py createsuperuser
python manage.py runserver
```

Админка: `http://127.0.0.1:8000/admin/`

### API
- **Получить токен**: `POST /api/token/` (username/password)
- **Обновить токен**: `POST /api/token/refresh/`
- **Компании**: `/api/companies/`
- **Контакты**: `/api/contacts/`
- **Заметки**: `/api/company-notes/`
- **Задачи**: `/api/tasks/`

### Импорт amoCRM (CSV)
Рекомендуемый путь: в amo выгрузить **CSV** (или сохранить xlsx как CSV).

Команда:

```bash
cd backend
python manage.py import_amo --csv ..\\amocrm_export_contacts_and_companies_2025-12-11.csv --dry-run
python manage.py import_amo --csv ..\\amocrm_export_contacts_and_companies_2025-12-11.csv
```

Важно:
- Поле **`Ответственный`** сопоставляется с пользователями по `username` или по `ФИО` (full_name). Перед импортом заведи пользователей.
- Если у компании есть **ИНН**, он главный ключ дедупликации.

### Деплой на VDS (через Docker)
В корне есть `docker-compose.yml` (Postgres + web) + оверрайды для окружений:
- `docker-compose.dev.yml` — локальная разработка (публикует порты наружу)
- `docker-compose.vds.yml` — VDS (публикует только на localhost для прокси через Nginx)

```bash
docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build
```

Дальше: зайти в контейнер и создать суперпользователя, либо добавить отдельный one-shot сервис (сделаем на следующем шаге).


