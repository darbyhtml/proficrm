### CRM ПРОФИ (минималистичная “как amo, но проще”)

Сейчас в репозитории собран **рабочий каркас CRM** и уже реализован ряд важных улучшений по UX/безопасности:
- **Роли и scope доступа** (по умолчанию всем видна вся база, но админ может ограничить до филиала/своих компаний)
- **Компании / Контакты / Заметки по компании**
- **Задачи** (с полем под повторы RRULE) + **подсветка статусов/просрочки**
- **Импорт из amoCRM CSV** с дедупликацией компаний по **ИНН → имя+адрес**
- **JWT авторизация** + Django Admin для админки

### Что реализовано (кратко)
- **UI/UX “в наших цветах”**: мини дизайн‑система (карточки/кнопки/таблицы/бейджи), компактное левое меню с иконками, мобильный off‑canvas.
- **Рабочий стол**: блоки **Просрочено / На сегодня / На неделю / Новые назначения** (чтобы при входе сразу видеть, что назначили).
- **Сферы деятельности**: компактный мультиселект (поиск + чекбоксы), удобнее и занимает меньше места.
- **Дубли компаний при создании**: живая проверка + причины совпадения (например: ИНН/КПП/Название/Адрес).
- **Безопасность экспорта базы**: экспорт доступен только админам + **аудит‑лог** всех попыток (успешных/заблокированных).
- **Заметки**: удалять можно только **свои** заметки (и это логируется).
- **Имена пользователей**: в интерфейсе отображается **Имя Фамилия** (логин только для входа).
- **Уведомления**: базовая панель уведомлений (счётчики/прочитано).

### Roadmap (план развития)

#### Android-приложение “Позвонить с телефона” (как «Мои звонки») — на будущее
- **Цель**: сотрудник кликает в CRM по телефону → на Android открывается набор номера (1 тап до звонка).
- **Платформа**: только **Android** (iPhone не планируем).
- **Почему приложение (не PWA)**: стабильные push-уведомления (FCM), работа в фоне, надёжная доставка команд.
- **Сценарий**:
  - **Привязка устройства**: в CRM “Мой телефон” → QR-код → приложение сканирует → устройство привязано к аккаунту.
  - **Клик в CRM**: “Позвонить с телефона” у номера контакта → сервер отправляет команду на устройство сотрудника.
  - **На телефоне**: приложение показывает карточку звонка и открывает системную звонилку через `ACTION_DIAL` с уже набранным номером.
  - **Синхронизация**: CRM логирует событие “запрос на звонок” + статус “доставлено/открыто”.
- **Экраны приложения (MVP)**:
  - Подключение/скан QR
  - Входящий запрос на звонок (номер + контакт/компания, кнопки Позвонить/Отмена)
  - (опционально) История последних запросов

### Запуск локально (Windows)
1) Установи зависимости:

```bash
cd backend
python -m pip install --user -r requirements.txt
```

2) Создай `backend/.env` (в проекте dot-файлы могут быть заблокированы, поэтому просто скопируй `backend/env.example` в `backend/.env` вручную) и отредактируй при необходимости.

3) Миграции + админ:

```bash
cd backend
python manage.py migrate
python manage.py createsuperuser
python manage.py runserver
```

Админка: `http://127.0.0.1:8000/admin/`

### API
- **Получить токен**: `POST /api/token/` (username/password)
- **Обновить токен**: `POST /api/token/refresh/`
- **Компании**: `/api/companies/`
- **Контакты**: `/api/contacts/`
- **Заметки**: `/api/company-notes/`
- **Задачи**: `/api/tasks/`

### Импорт amoCRM (CSV)
Рекомендуемый путь: в amo выгрузить **CSV** (или сохранить xlsx как CSV).

Команда:

```bash
cd backend
python manage.py import_amo --csv ..\\amocrm_export_contacts_and_companies_2025-12-11.csv --dry-run
python manage.py import_amo --csv ..\\amocrm_export_contacts_and_companies_2025-12-11.csv
```

Важно:
- Поле **`Ответственный`** сопоставляется с пользователями по `username` или по `ФИО` (full_name). Перед импортом заведи пользователей.
- Если у компании есть **ИНН**, он главный ключ дедупликации.

### Деплой на VDS (через Docker)
В корне есть `docker-compose.yml` (Postgres + web) + оверрайды для окружений:
- `docker-compose.dev.yml` — локальная разработка (публикует порты наружу)
- `docker-compose.vds.yml` — VDS (публикует только на localhost для прокси через Nginx)

```bash
docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build
```

Дальше: зайти в контейнер и создать суперпользователя, либо добавить отдельный one-shot сервис (сделаем на следующем шаге).


