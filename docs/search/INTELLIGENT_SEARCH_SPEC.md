# Интеллектуальный поиск в CRM: инструменты и лучшие практики

Спецификация требований и архитектуры поиска по контрагентам и контактам. Текущая реализация — PostgreSQL (FTS + pg_trgm), см. [SEARCH_BEST_PRACTICES.md](SEARCH_BEST_PRACTICES.md). Цель — оценка перехода на специализированный движок (Typesense / Elasticsearch / Meilisearch).

---

## 1. Требования к поиску

| Требование | Описание |
|------------|----------|
| **Неточные совпадения** | Fuzzy-поиск: опечатки (Левенштейн), морфология (русские склонения), транслитерация (Yantar → Янтарь). |
| **Поиск по полям** | Название/юр.название, ФИО контактов, email, телефоны, ИНН/КПП, адрес, примечания — в одной строке. |
| **Скорость** | Ответ в единицах миллисекунд при десятках/сотнях тысяч компаний. |
| **Релевантность** | Точные совпадения выше; учёт поля, количества совпадений, расстояния опечаток. |
| **Минимум шума** | AND по словам, стоп-слова (ООО, ИП и т.д.), пороги fuzzy, синонимы. |
| **Подсветка** | Совпадения в UI с указанием поля (название, контакт, телефон и т.д.). |
| **Интеграция** | Python-клиент, контейнеризация, синхронизация индекса при изменениях. |

---

## 2. Ограничения текущего решения (PostgreSQL)

- Логика размазана между БД (триггеры, функции) и приложением.
- FTS не учитывает опечатки без ручного pg_trgm + similarity fallback.
- Подсветка и объяснение результатов делаются вручную.
- Риск деградации производительности при росте данных и сложных запросах.

**Вывод:** вынос поиска в специализированный движок даст опечатки, ранжирование и подсветку «из коробки» и упростит код.

---

## 3. Обзор инструментов

### Meilisearch
- **Плюсы:** простой запуск и API, быстрый поиск, fuzzy и префиксы по умолчанию, подсветка, русский (Charabia).
- **Минусы:** нет весов полей (field boosting), ограниченная кастомизация анализа; поиск подстрок (телефоны) — только через префиксы или ручную разбивку при индексации.

### Typesense
- **Плюсы:** веса полей (`query_by_weights`), fuzzy, префиксы, стемминг для русского, подсветка, управление опечатками (`num_typos`, `max_candidates`).
- **Минусы:** поиск по произвольной подстроке в номере — так же через префиксы или доп. поля (суффиксы/фрагменты); данные в RAM.

### Elasticsearch / OpenSearch
- **Плюсы:** полный контроль: анализаторы, морфология, ngram для телефонов, синонимы, fuzziness, бустинг полей, highlight.
- **Минусы:** тяжелее в настройке и эксплуатации (JVM, ресурсы).

### Рекомендация по выбору
- **Максимум качества:** Elasticsearch/OpenSearch.
- **Баланс простоты и возможностей:** Typesense (веса полей, стемминг, подсветка).
- **Минимум усилий:** Meilisearch (приемлемо при готовности к обходным решениям для весов и подстрок).

---

## 4. Интеграция в Python-проект

1. **Развертывание:** Docker-контейнер движка (Typesense/Elastic/Meili), доступ с приложения по HTTP.
2. **Структура документа:** один документ = одна компания; поля: `id`, `name`, `legal_name`, `contacts` (массив/строка), `emails`, `phones`, `inn`, `kpp`, `address`, `notes`, `updated_at`.
3. **Первичная индексация:** management-команда или скрипт — обход компаний, bulk-загрузка в индекс; нормализация (lower, ё→е, цифры из телефонов).
4. **Синхронизация:** при создании/обновлении/удалении компании — вызов API движка (синхронно или через очередь, e.g. Celery).
5. **Поиск в коде:** замена вызовов `CompanySearchService.apply()` на запрос к API движка; преобразование ответа (документы + highlight) в формат для UI.
6. **Настройка:** веса полей, стоп-слова, синонимы, пороги fuzzy, минимальная длина запроса.

---

## 5. Настройка по типам полей

| Группа полей | Рекомендации |
|--------------|--------------|
| **Названия** | Русский анализатор (стемминг), стоп-слова (ООО, ЗАО, ИП, федеральное…), AND по словам, fuzzy 1–2, транслитерация (синонимы или конвертация запроса). |
| **ФИО** | Полное ФИО строкой, стемминг для склонений, префиксы, ограниченный fuzzy (1 опечатка). |
| **Email** | Разбиение по `@` и `.` (или simple-анализатор); регистронезависимость. |
| **Телефоны** | Нормализация E.164; для подстрок — ngram (Elastic) или доп. поля с суффиксами/фрагментами (Typesense/Meili). |
| **ИНН/КПП** | Точное совпадение (keyword); частичный поиск только для длинных фрагментов (≥4 цифр); без fuzzy по цифрам. |
| **Адрес** | Русский анализатор, стоп-слова (ул., г., д.), синонимы (пр-т → проспект). |
| **Примечания** | Низкий вес или fallback-поиск при пустой выдаче по основным полям. |

---

## 6. Минимизация шума

- **AND по словам** — все слова запроса должны присутствовать (где применимо).
- **Ограничение fuzzy** — max 1–2 опечатки, минимальная длина токена для fuzzy (например, ≥4).
- **Стоп-слова и синонимы** — только нужные; не раздувать.
- **Короткие запросы** — не искать по 1–2 символам или возвращать пусто/подсказку.
- **Лимит результатов** — например, 100–1000, чтобы не перегружать UI.

---

## 7. Визуализация и UX

- Использовать **подсветку от движка** (highlight в ответе) и отображать её в UI (например, `<mark>`).
- **Указывать поле совпадения:** «Название: …», «Контакт: …», «Телефон: …», «Примечание: …».
- Сортировка: сначала по релевантности, затем по `updated_at`.
- При пустой выдаче — подсказка проверить ввод или упростить запрос.

---

## 8. Пример конфигурации (Elasticsearch)

- Индекс `companies` с кастомным анализатором `my_russian` (lowercase, ё→е, стоп-слова, русский стеммер).
- Отдельный анализатор для телефонов: только цифры + ngram (min_gram=3, max_gram=4 или 20).
- Поля: `name`, `legal_name`, `contacts`, `emails`, `phones`, `inn` (keyword), `kpp` (keyword), `address`, `notes`, `updated_at`.
- Запрос: `multi_match` по полям с весами (`name^5`, `legal_name^5`, `contacts^3`, …), `operator: "and"`, `fuzziness: "AUTO"`.
- В ответе — `highlight` по нужным полям для подсветки в UI.

Конкретные JSON маппинга и примеры кода — см. полную спецификацию или `SEARCH_ENGINE_ROADMAP.md`.

---

## 9. Заключение

Для умного поиска в CRM целесообразно внедрить **Typesense** (баланс) или **Elasticsearch/OpenSearch** (максимум качества). Это даст:

- Опечатки и морфологию без ручного кода.
- Быстрый отклик за счёт индексов.
- Гибкое ранжирование и веса полей.
- Подсветку и объяснение результатов.
- Упрощение поддержки (логика в одном месте).

Связь с текущим кодом: `backend/companies/search_service.py`, `search_index.py`, `CompanySearchIndex`; при внедрении — новый backend (например, `SearchBackendTypesense` / `SearchBackendElastic`) с тем же интерфейсом, что у `CompanySearchService`.
