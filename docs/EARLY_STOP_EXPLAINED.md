# Простое объяснение: как работает раннее прерывание

## Главное правило: **НИЧЕГО НЕ ПРОПУСТИМ**

Логика работает так, чтобы **не пропустить ни одного контакта**, который нужен.

## Ваш вопрос: "Не у всех же компаний бывают дополнительные контакты?"

**Правильно!** Не у всех компаний есть контакты. Логика это учитывает.

## Как это работает (ваш случай)

### Ваша ситуация:
- **50 компаний** в батче
- Контакты есть только у **3 компаний** (6%)
- У остальных **47 компаний** контактов нет

### Что происходит:

1. **Получаем контакты страницами** (по 250 штук)
2. **После каждой страницы** проверяем:
   - Сколько контактов получено?
   - Сколько из них релевантны (для наших 50 компаний)?
   - Для скольких компаний нашли контакты?

3. **Прерывание происходит только в безопасных случаях**:

#### ✅ Случай 1: Нашли контакты для ВСЕХ компаний
- Если у всех 50 компаний есть контакты → прервется
- **Ваш случай**: Не применимо (у вас только 3 компании с контактами)

#### ✅ Случай 2: Нашли контакты для большинства (80%+)
- Если у 40+ компаний есть контакты → прервется
- **Ваш случай**: Не применимо (у вас только 3 компании с контактами)

#### ✅ Случай 3: Слишком много нерелевантных контактов (ВАШ СЛУЧАЙ)
- Получено: **5000+ контактов**
- Релевантных: **< 10%** (для ваших компаний)
- **Результат**: Прервется, т.к. API возвращает все контакты, а не только для ваших компаний

### Ваш пример из логов:

- Получено: **25000 контактов**
- Релевантных: **9 контактов** (0.036%)
- **С новой логикой**: Прервется после **5000 контактов** (20 страниц)

**Почему это безопасно?**
- Если после 5000 контактов релевантность 0.036%, значит API возвращает **все контакты** из AmoCRM
- Все 9 релевантных контактов будут в первых 5000 контактах
- Дальше получать не нужно - там будут только нерелевантные контакты

## Гарантии

### ✅ Гарантия 1: Не пропустим контакты
- Логика **НЕ прерывается**, пока не получит минимум 5000 контактов
- Если релевантность высокая (> 10%), продолжит получать контакты

### ✅ Гарантия 2: Не будем получать лишнее
- Если релевантность низкая (< 10%) после 5000 контактов, прервется
- Это означает, что API возвращает все контакты, дальше будет только хуже

## Ответы на ваши вопросы

### "Если для 50 компаний найдено 10 контактов, прервется ли пагинация?"

**Ответ**: 
- Если эти 10 контактов для **всех 50 компаний** (по 1 на каждую) → ✅ Прервется
- Если эти 10 контактов для **3 компаний** (как у вас) → ❌ НЕ прервется, пока не получит 5000+ контактов

### "Если для следующей компании будет 16 контактов, подстраивается ли логика?"

**Ответ**: 
- Логика **не зависит** от количества контактов на компанию
- Она проверяет **факт наличия** контакта для компании, а не их количество
- Если для компании A найдено 1 контакт, а для компании B - 16, это считается одинаково: "контакты найдены для обеих компаний"

## Итог

**Логика работает правильно:**
- ✅ Не пропустит контакты, которые есть
- ✅ Не будет получать лишние контакты без необходимости
- ✅ Учитывает, что не у всех компаний есть контакты

**Ваш случай (3 компании с контактами из 50):**
- Получит минимум 5000 контактов
- Если релевантность < 10% → прервется (все нужные контакты уже получены)
- Если релевантность > 10% → продолжит получать (есть еще релевантные контакты)
