# Чек-лист регресса: раздел «Почта»

Цель: после выката быстро убедиться, что рассылки **не дублируются**, **очередь не зависает**, отправка идёт **только в рабочее время**, а ошибки — **понятные и управляемые**.

## 1) Настройки/инфраструктура
- **SMTP включён**: «Почта → Настройки SMTP», отправка теста администратору проходит.
- **MEDIA**: вложения доступны (docker volume `media` примонтирован, файлы открываются).
- **Celery**: воркер и beat запущены, `send_pending_emails` исполняется по расписанию.

## 2) Создание кампании (менеджер)
- **Создать кампанию** без вложения → добавить 2-3 получателя вручную → «Старт».
- Проверить в карточке кампании:
  - **Очередь/Отправлено/Ошибки** корректно меняются.
  - «Отправлено (по логам)» показывает реальную отправку.

## 3) Генерация получателей
- Сгенерировать получателей по фильтрам → убедиться:
  - нет дублей по email в рамках кампании,
  - отписки попадают в статус **«Отписался»**,
  - повторная генерация **не добавляет** уже существующие email.

## 4) Очередь и рабочее время (9:00–18:00 МСК)
- Вне рабочего времени: кампания может быть **в очереди**, но письма **не уходят**.
- В рабочее время: кампания начинает обрабатываться, очередь двигается.
  - Очередь **не должна залипать в PROCESSING** вне рабочего времени (не должно выглядеть как «зависло»).

## 5) Повторная отправка (без дублей)
- В кампании с ошибками нажать **«Повторить ошибки»**:
  - только `FAILED` возвращаются в `PENDING`,
  - `SENT` не трогаются.
- Проверить, что повторная отправка не уходит по уже отправленным адресам.

## 6) Лимиты/квота
- При достижении дневного лимита пользователя:
  - кампания становится **PAUSED**,
  - пользователь видит/получает понятное уведомление.
- При глобальном лимите/лимите в час:
  - отправка останавливается без «залипания» очереди.

## 7) Вложения
- Кампания с вложением:
  - письмо уходит с вложением,
  - если имя файла отличается регистром (Linux): система должна восстановить вложение автоматически.
- Если файла реально нет:
  - кампания ставится на **PAUSED**,
  - нет массового превращения всех получателей в `FAILED`.

## 8) Отписки (админ)
- В «Почта → Кампании» открыть модалку **Отписки**:
  - поиск/пагинация работает,
  - удаление выбранных email работает,
  - очистка всех отписок требует админа.

