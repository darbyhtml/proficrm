# Система уведомлений в CRM

## Обзор

Система уведомлений состоит из двух компонентов:
1. **Уведомления (Notifications)** - хранятся в БД, можно отмечать прочитанными
2. **Напоминания (Reminders)** - генерируются динамически, не хранятся в БД

## Типы уведомлений

### Notification.Kind (хранятся в БД):
- **INFO** - Информационные уведомления
- **TASK** - Уведомления о задачах
- **COMPANY** - Уведомления о компаниях
- **SYSTEM** - Системные уведомления

## Когда отправляются уведомления

### 1. При создании задачи (`task_create`):
- **Кому:** Назначенный сотрудник (если это не создатель задачи)
- **Тип:** TASK
- **Текст:** "Вам назначили задачу"
- **Когда:** Только если `task.assigned_to_id != user.id`

### 2. При изменении статуса задачи на "Выполнена" (`task_set_status`):
- **Кому:** 
  - Ответственный за задачу (assigned_to) - если это не тот, кто выполнил
  - Создатель задачи (created_by) - если это не тот, кто выполнил, и не ответственный
- **Тип:** TASK
- **Текст:** "Задача выполнена"
- **Примечание:** Упрощена логика - убраны уведомления директорам филиалов, РОП и управляющим (слишком много получателей)

### 3. При изменении статуса задачи на другие (не "Выполнена"):
- **Уведомления отключены** - они слишком отвлекают, пользователь может видеть изменения в интерфейсе

### 4. При передаче компаний (`company_bulk_transfer`, `company_transfer`):
- **Кому:** Новый ответственный
- **Тип:** COMPANY
- **Текст:** "Вам передали компанию/компании"

### 5. При создании заметки по компании (`company_note_add`):
- **Кому:** Ответственный за компанию (если это не автор заметки)
- **Тип:** COMPANY
- **Текст:** "Новая заметка по компании"

### 6. Напоминания по договорам (`notifications_panel`):
- **Кому:** Ответственный за компанию
- **Тип:** COMPANY
- **Когда:** 
  - За 30 дней до окончания договора
  - За 14 дней до окончания договора
- **Дедупликация:** Используется `CompanyContractReminder` для предотвращения дублей

## Напоминания (Reminders)

Напоминания генерируются динамически и показываются в колокольчике вместе с уведомлениями:

### 1. Просроченные задачи:
- Задачи, назначенные пользователю, со статусом не "Выполнена" и не "Отменена"
- У которых `due_at < now`
- Показываются до 10 штук

### 2. Задачи на сегодня:
- Задачи, назначенные пользователю, со статусом не "Выполнена" и не "Отменена"
- У которых `due_at.date() == today`
- Показываются до 10 штук

### 3. Договоры, которые скоро заканчиваются:
- Компании, где пользователь ответственный
- У которых `contract_until` в пределах 30 дней
- Показываются до 10 штук
- Если до окончания < 14 дней, добавляется префикс "Срочно: "

## Отображение в UI

- **Колокольчик:** Показывает общее количество (`bell_count = notif_unread_count + reminder_count`)
- **Панель уведомлений:** Разделена на две секции:
  - "Напоминания" - показываются первыми
  - "Новые" - реальные уведомления из БД
- **Обновление:** Polling каждые 15 секунд через `/notifications/poll/`

## Визуальные эффекты

### Отключено (слишком отвлекают):
- Анимация кольца на колокольчике при новых уведомлениях
- Браузерные уведомления (popup) при новых уведомлениях

### Активно:
- Бейдж с количеством уведомлений на колокольчике
- Обновление списка уведомлений каждые 15 секунд (polling)
- Возможность отметить уведомление прочитанным

## Изменения для уменьшения отвлекаемости

### Реализовано:
1. ✅ Уменьшено количество получателей при выполнении задачи (только ответственный и создатель, если это не тот, кто выполнил)
2. ✅ Убраны уведомления о изменении статуса (кроме "Выполнена")
3. ✅ Отключены анимации и браузерные popup-уведомления
