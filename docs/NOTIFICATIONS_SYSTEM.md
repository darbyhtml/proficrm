# Система уведомлений CRM ПРОФИ

## Обзор

Система уведомлений в CRM ПРОФИ работает на основе модели `Notification` и использует polling (без WebSocket) для обновления в реальном времени. Уведомления отображаются в колокольчике в шапке сайта и обновляются каждые 15 секунд.

## Типы уведомлений

В системе есть 4 типа уведомлений (`Notification.Kind`):
- **INFO** - Информационные уведомления
- **TASK** - Уведомления о задачах
- **COMPANY** - Уведомления о компаниях
- **SYSTEM** - Системные уведомления

## Уведомления о задачах

### 1. При создании задачи

**Когда отправляется:**
- При создании новой задачи, если назначенный исполнитель (`assigned_to`) отличается от создателя задачи (`created_by`)

**Кому отправляется:**
- Назначенному исполнителю задачи

**Содержание:**
- **Заголовок:** "Вам назначили задачу"
- **Текст:** Название задачи (`task.title`)
- **Ссылка:** `/tasks/?view_task={task.id}` - ведёт на список задач с открытым модальным окном просмотра задачи

**Пример:**
```
Заголовок: Вам назначили задачу
Текст: Позвонить клиенту
Ссылка: /tasks/?view_task=123e4567-e89b-12d3-a456-426614174000
```

**Особый случай - задачи по организации:**
Если задача создаётся "на все филиалы организации", то:
- **Заголовок:** "Вам назначили задачи"
- **Текст:** "{название задачи} (по организации) · {количество} компаний"
- **Ссылка:** `/tasks/?mine=1`

### 2. При изменении статуса задачи на "Выполнена" (DONE)

**Когда отправляется:**
- Когда статус задачи меняется на "Выполнена"

**Кому отправляется:**
1. **Исполнителю** - пользователю, который изменил статус (если это не создатель)
2. **Ответственному** - пользователю, которому назначена задача (`assigned_to`), если он отличается от исполнителя
3. **Создателю** - пользователю, который создал задачу (`created_by`), если он отличается от исполнителя
4. **Директору филиала / РОП** - всем активным пользователям с ролями `BRANCH_DIRECTOR` или `SALES_HEAD` из филиала компании или ответственного (если у задачи есть компания или ответственный)
5. **Управляющему компанией** - всем активным пользователям с ролью `GROUP_MANAGER`

**Содержание:**
- **Заголовок:** "Задача выполнена"
- **Текст:** Название задачи (`task.title`)
- **Ссылка:** `/tasks/?view_task={task.id}`

**Пример:**
```
Заголовок: Задача выполнена
Текст: Позвонить клиенту
Ссылка: /tasks/?view_task=123e4567-e89b-12d3-a456-426614174000
```

### 3. При изменении статуса задачи на другие статусы (не DONE)

**Когда отправляется:**
- Когда статус задачи меняется на любой другой статус (NEW, IN_PROGRESS, CANCELLED), кроме DONE
- Только если создатель задачи отличается от пользователя, который меняет статус

**Кому отправляется:**
- Создателю задачи (`created_by`)

**Содержание:**
- **Заголовок:** "Статус изменён"
- **Текст:** "{название задачи}: {новый статус}" (например, "Позвонить клиенту: В работе")
- **Ссылка:** `/tasks/?view_task={task.id}`

**Пример:**
```
Заголовок: Статус изменён
Текст: Позвонить клиенту: В работе
Ссылка: /tasks/?view_task=123e4567-e89b-12d3-a456-426614174000
```

## Напоминания (Reminders)

Напоминания - это специальный тип уведомлений, которые отображаются в панели уведомлений отдельно от обычных уведомлений. Они не хранятся в таблице `Notification`, а генерируются динамически.

### Типы напоминаний:

1. **Задачи с дедлайном:**
   - Просроченные задачи (`due_at < now`)
   - Задачи на сегодня (`due_at` в текущий день)
   - Задачи на ближайшую неделю (`due_at` в пределах 7 дней)
   - Задачи на будущее (более 7 дней)

2. **Договоры:**
   - Договоры, срок действия которых истекает в течение 30 дней
   - Если до истечения договора осталось менее 14 дней, добавляется префикс "Срочно: "

## Отображение уведомлений

### В колокольчике (шапка сайта)

- **Счётчик:** Показывает общее количество непрочитанных уведомлений и напоминаний
- **Обновление:** Автоматическое обновление каждые 15 секунд через AJAX polling (`/notifications/poll/`)
- **Отображение:**
  - Сначала показываются напоминания (если есть)
  - Затем показываются новые уведомления (непрочитанные)
  - Максимум 10 непрочитанных уведомлений в панели
  - Если уведомлений больше, показывается ссылка "Показать все"

### Страница всех уведомлений

- **URL:** `/notifications/all/`
- Показывает все уведомления пользователя (прочитанные и непрочитанные)
- Сортировка: новые сверху

### Страница всех напоминаний

- **URL:** `/notifications/reminders/all/`
- Показывает все задачи с дедлайном и договоры с истекающим сроком
- Группировка по категориям (просроченные, на сегодня, на неделю, будущие)

## Действия с уведомлениями

1. **Отметить как прочитанное:**
   - Кнопка "✓" на каждом уведомлении
   - Отправляет POST запрос на `/notifications/{id}/read/`
   - Обновляет поле `is_read = True`

2. **Отметить все как прочитанные:**
   - Кнопка "Прочитано" в панели уведомлений
   - Отправляет POST запрос на `/notifications/mark-all-read/`
   - Помечает все непрочитанные уведомления пользователя как прочитанные

3. **Браузерные уведомления:**
   - Опциональная функция (включается кнопкой "Браузер" в панели уведомлений)
   - Требует разрешения браузера на показ уведомлений
   - Работает только по HTTPS
   - Показывает системные уведомления браузера при поступлении новых уведомлений
   - Настройка сохраняется в `localStorage` (ключ `crm_notif_browser_enabled`)

## Технические детали

### Модель Notification

```python
class Notification(models.Model):
    user = ForeignKey(User)  # Получатель уведомления
    kind = CharField  # Тип: INFO, TASK, COMPANY, SYSTEM
    title = CharField(max_length=200)  # Заголовок
    body = TextField  # Текст уведомления
    url = CharField(max_length=300)  # Ссылка для перехода
    is_read = BooleanField(default=False)  # Прочитано ли
    created_at = DateTimeField(auto_now_add=True)  # Время создания
```

### Функция создания уведомления

```python
from notifications.service import notify

notify(
    user=user_object,
    kind=Notification.Kind.TASK,
    title="Заголовок",
    body="Текст уведомления",
    url="/tasks/?view_task=123",
)
```

### Polling endpoint

- **URL:** `/notifications/poll/`
- **Метод:** GET
- **Ответ:** JSON с данными о непрочитанных уведомлениях и напоминаниях
- **Интервал:** Вызывается каждые 15 секунд из JavaScript

## Логика отправки уведомлений при выполнении задачи

При изменении статуса задачи на "Выполнена" система определяет получателей уведомлений следующим образом:

1. **Определяется филиал:**
   - Если у задачи есть компания с филиалом - используется филиал компании
   - Если у задачи нет филиала компании, но есть ответственный с филиалом - используется филиал ответственного

2. **Собираются получатели:**
   - Исполнитель (кто изменил статус)
   - Ответственный (assigned_to)
   - Создатель (created_by)
   - Все директора филиала и РОП из определённого филиала
   - Все управляющие компанией (GROUP_MANAGER)

3. **Отправляются уведомления:**
   - Каждому получателю отправляется отдельное уведомление
   - Дубликаты исключаются (один пользователь может быть в нескольких ролях)

## Примеры сценариев

### Сценарий 1: Менеджер создаёт задачу себе
- **Статус:** IN_PROGRESS (автоматически)
- **Уведомление:** Не отправляется (создатель = исполнитель)

### Сценарий 2: РОП создаёт задачу менеджеру
- **Статус:** NEW
- **Уведомление:** Отправляется менеджеру "Вам назначили задачу"

### Сценарий 3: Менеджер выполняет задачу, назначенную РОП
- **Уведомления отправляются:**
  - РОП (создатель): "Задача выполнена"
  - Директору филиала (если есть): "Задача выполнена"
  - Управляющему компанией: "Задача выполнена"

### Сценарий 4: Менеджер меняет статус своей задачи на "В работе"
- **Уведомление:** Не отправляется (создатель = исполнитель = тот, кто меняет)

### Сценарий 5: РОП меняет статус задачи менеджера на "Отменена"
- **Уведомление:** Отправляется менеджеру (создателю): "Статус изменён: Отменена"
