# Система уведомлений в CRM

## Обзор

Система уведомлений состоит из двух компонентов:
1. **Уведомления (Notifications)** - хранятся в БД, можно отмечать прочитанными
2. **Напоминания (Reminders)** - генерируются динамически, не хранятся в БД

## Типы уведомлений

### Notification.Kind (хранятся в БД):
- **INFO** - Информационные уведомления
- **TASK** - Уведомления о задачах
- **COMPANY** - Уведомления о компаниях
- **SYSTEM** - Системные уведомления

## Когда отправляются уведомления

### 1. При создании задачи (`task_create`):
- **Кому:** Назначенный сотрудник (если это не создатель задачи)
- **Тип:** TASK
- **Текст:** "Вам назначили задачу"
- **Когда:** Только если `task.assigned_to_id != user.id`

### 2. При изменении статуса задачи на "Выполнена" (`task_set_status`):
- **Кому:** 
  - Исполнитель (кто поменял статус)
  - Ответственный за задачу (assigned_to)
  - Создатель задачи (created_by)
  - Директор филиала / РОП по филиалу компании/ответственного
  - Управляющие группой компаний
- **Тип:** TASK
- **Текст:** "Задача выполнена"

### 3. При изменении статуса задачи на другие (не "Выполнена"):
- **Кому:** Создатель задачи (если это не он меняет статус)
- **Тип:** TASK
- **Текст:** "Статус изменён"

### 4. При передаче компаний (`company_bulk_transfer`, `company_transfer`):
- **Кому:** Новый ответственный
- **Тип:** COMPANY
- **Текст:** "Вам передали компанию/компании"

### 5. При создании заметки по компании (`company_note_add`):
- **Кому:** Ответственный за компанию (если это не автор заметки)
- **Тип:** COMPANY
- **Текст:** "Новая заметка по компании"

### 6. Напоминания по договорам (`notifications_panel`):
- **Кому:** Ответственный за компанию
- **Тип:** COMPANY
- **Когда:** 
  - За 30 дней до окончания договора
  - За 14 дней до окончания договора
- **Дедупликация:** Используется `CompanyContractReminder` для предотвращения дублей

## Напоминания (Reminders)

Напоминания генерируются динамически и показываются в колокольчике вместе с уведомлениями:

### 1. Просроченные задачи:
- Задачи, назначенные пользователю, со статусом не "Выполнена" и не "Отменена"
- У которых `due_at < now`
- Показываются до 10 штук

### 2. Задачи на сегодня:
- Задачи, назначенные пользователю, со статусом не "Выполнена" и не "Отменена"
- У которых `due_at.date() == today`
- Показываются до 10 штук

### 3. Договоры, которые скоро заканчиваются:
- Компании, где пользователь ответственный
- У которых `contract_until` в пределах 30 дней
- Показываются до 10 штук
- Если до окончания < 14 дней, добавляется префикс "Срочно: "

## Отображение в UI

- **Колокольчик:** Показывает общее количество (`bell_count = notif_unread_count + reminder_count`)
- **Панель уведомлений:** Разделена на две секции:
  - "Напоминания" - показываются первыми
  - "Новые" - реальные уведомления из БД
- **Обновление:** Polling каждые 15 секунд через `/notifications/poll/`

## Проблемы и предложения по улучшению

### Текущие проблемы:
1. При выполнении задачи уведомления отправляются слишком многим людям (6+ получателей)
2. Уведомления о изменении статуса могут быть избыточными
3. Напоминания по договорам создаются при каждом запросе (хотя есть дедупликация)

### Предложения:
1. Уменьшить количество получателей при выполнении задачи
2. Убрать уведомления о изменении статуса (кроме "Выполнена")
3. Сделать уведомления менее навязчивыми (меньше визуальных эффектов)
