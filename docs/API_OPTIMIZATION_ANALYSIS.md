# Анализ документации AmoCRM API и оптимизации

## Ключевые выводы из документации

### 1. Companies API (`with=contacts`)

**Из документации:**
- `_embedded[contacts]` возвращает **только `id`** контакта (упрощенный формат)
- Требуется дополнительный запрос для получения полных данных контакта

**Текущая реализация:**
- ✅ Уже учтено: проверяем наличие `custom_fields_values` и запрашиваем полные данные
- ❌ Проблема: делаем 2 запроса (компания + контакты) вместо 1

### 2. Contacts API (`filter[company_id]`)

**Из документации:**
- `filter[company_id]=ID` работает для **одного ID** (не массив!)
- Максимальный `limit` - 250
- Возвращает **полные данные** контакта сразу (с `custom_fields_values`)

**Текущая реализация:**
- ✅ Уже используется в `fetch_contacts_per_company_precise`
- ✅ Для небольших батчей (≤10) - оптимально

### 3. Оптимизация для средних батчей (11-30 компаний)

**Проблема:**
- Для 20 компаний: 20 запросов через `filter[company_id]=ID` = ~3 секунды
- Можно оптимизировать: сначала проверить наличие контактов через `with=contacts`, затем запросить полные данные только для компаний с контактами

**Решение:**
1. Запросить компании с `with=contacts` (быстро, только ID)
2. Собрать все ID контактов
3. Запросить полные данные контактов батчами по 50 ID через `filter[id][]`

**Ожидаемый эффект:**
- Для 20 компаний: 1 запрос компаний + 1-2 запроса контактов = ~1-2 секунды (вместо 3)

### 4. Оптимизация для больших батчей (>30 компаний)

**Текущая реализация:**
- Использует `filter[company_id][]` с массивом (работает как OR)
- Раннее прерывание пагинации

**Проблема:**
- API возвращает все контакты, связанные с любой из компаний
- Релевантность ~0.04-0.08%

**Решение:**
- Оставить как есть (уже оптимизировано с ранним прерыванием)
- Или использовать гибрид: разбить на батчи по 10-15 компаний и использовать точный запрос

## Рекомендуемая оптимизация

### Новая функция: `fetch_contacts_optimized`

**Логика:**
1. **≤10 компаний:** `filter[company_id]=ID` для каждой (уже реализовано)
2. **11-30 компаний:** 
   - Запросить компании с `with=contacts` (1 запрос)
   - Собрать все ID контактов
   - Запросить полные данные контактов батчами через `filter[id][]` (1-2 запроса)
3. **>30 компаний:** Использовать bulk с ранним прерыванием (текущая реализация)

**Ожидаемый эффект:**
- 10 компаний: ~1-2 сек (без изменений)
- 20 компаний: ~1-2 сек (вместо 3 сек) - **улучшение в 1.5-2 раза**
- 50 компаний: ~20-30 сек (без изменений)
