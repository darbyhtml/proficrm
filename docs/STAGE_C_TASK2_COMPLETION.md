# ЭТАП C: Задача 2 — Magic Link Auth (ЗАВЕРШЕНО)

**Дата:** 2024-01-XX  
**Статус:** ✅ Завершено

---

## Что было сделано

### 1. Создана модель MagicLinkToken ✅
**Файл:** `backend/accounts/models.py`

**Поля:**
- `user` — пользователь, для которого создан токен
- `token_hash` — SHA256 хэш токена (хранится только хэш)
- `created_at`, `expires_at`, `used_at` — временные метки
- `created_by` — администратор, создавший токен
- `ip_address`, `user_agent` — для аудита

**Методы:**
- `generate_token()` — генерация токена и хэша
- `create_for_user()` — создание токена для пользователя (TTL 30 минут)
- `is_valid()` — проверка валидности (не истёк и не использован)
- `mark_as_used()` — пометка как использованного

### 2. Созданы endpoints ✅

#### 2.1. Генерация токена
**URL:** `POST /settings/users/<user_id>/magic-link/generate/`  
**View:** `settings_user_magic_link_generate()` в `backend/ui/views.py`

**Функциональность:**
- Только для администратора (`require_admin()`)
- Rate limiting: не чаще 1 раза в 10 секунд на пользователя
- Генерация токена (32 байта, hex)
- Сохранение хэша в БД
- Возврат полной ссылки для входа
- Логирование генерации

#### 2.2. Вход по токену
**URL:** `GET /auth/magic/<token>/`  
**View:** `magic_link_login()` в `backend/accounts/views.py`

**Функциональность:**
- Вычисление SHA256 хэша токена
- Поиск токена по хэшу
- Проверка валидности (не истёк, не использован)
- Создание Django сессии
- Пометка токена как использованного
- Сохранение IP и User-Agent
- Логирование успешного/неудачного входа
- Rate limiting: не чаще 5 попыток в минуту с одного IP

### 3. Обновлён SecureLoginView ✅
**Файл:** `backend/accounts/views.py`

**Изменения:**
- Проверка настройки `MAGIC_LINK_ONLY`
- Если включено → всегда возвращает ошибку "Вход только по одноразовой ссылке"
- Форма остаётся, но пароль не принимается

### 4. Обновлены шаблоны ✅

#### 4.1. Страница входа
**Файл:** `backend/templates/registration/login.html`

**Изменения:**
- Проверка `magic_link_only` в контексте
- Если включено → показывается сообщение вместо формы пароля
- Сообщение: "Вход только по одноразовой ссылке. Обратитесь к администратору."

#### 4.2. Страница редактирования пользователя
**Файл:** `backend/templates/ui/settings/user_form.html`

**Добавлено:**
- Секция "Одноразовая ссылка входа"
- Кнопка "Сгенерировать ссылку"
- Отображение сгенерированной ссылки (один раз)
- Кнопка "Копировать"
- Статус последнего токена (активна/истекла/использована)
- Время истечения

#### 4.3. Страница ошибки
**Файл:** `backend/templates/registration/magic_link_error.html`

**Создана:**
- Страница для отображения ошибок при входе по токену
- Кнопка возврата на страницу входа

### 5. Создана миграция ✅
**Файл:** `backend/accounts/migrations/0005_magic_link_token.py`

**Операции:**
- Создание модели `MagicLinkToken`
- Индексы на `token_hash`, `user`, `expires_at`, `used_at`

### 6. Написаны тесты ✅
**Файл:** `backend/accounts/tests_magic_link.py`

**Покрытие:**
- ✅ Генерация токена (уникальность)
- ✅ Создание токена для пользователя
- ✅ Валидность токена (свежий, истёкший, использованный)
- ✅ Пометка как использованного
- ✅ Вход по токену (успех, невалидный токен, истёкший, использованный)

### 7. Настройка ✅
**Файл:** `backend/crm/settings.py`

**Добавлено:**
- `MAGIC_LINK_ONLY` — переменная окружения для отключения password login

---

## Изменённые файлы

1. `backend/accounts/models.py` — модель `MagicLinkToken`
2. `backend/accounts/views.py` — `magic_link_login()`, обновлён `SecureLoginView`
3. `backend/ui/views.py` — `settings_user_magic_link_generate()`, обновлён `settings_user_edit`
4. `backend/crm/urls.py` — URL `/auth/magic/<token>/`
5. `backend/ui/urls.py` — URL `/settings/users/<user_id>/magic-link/generate/`
6. `backend/crm/settings.py` — настройка `MAGIC_LINK_ONLY`
7. `backend/templates/registration/login.html` — сообщение о входе только по ссылке
8. `backend/templates/ui/settings/user_form.html` — UI генерации ссылки
9. `backend/templates/registration/magic_link_error.html` — страница ошибки
10. `backend/accounts/migrations/0005_magic_link_token.py` — миграция
11. `backend/accounts/tests_magic_link.py` — тесты

---

## Как проверить вручную

### 1. Генерация ссылки

**Как администратор:**
1. Войти как администратор
2. Перейти в "Настройки → Пользователи"
3. Открыть редактирование любого пользователя
4. Нажать "Сгенерировать ссылку"
5. Должна появиться ссылка вида `http://example.com/auth/magic/abc123.../`
6. Скопировать ссылку

### 2. Вход по ссылке

1. Выйти из системы (или открыть в приватном окне)
2. Перейти по сгенерированной ссылке
3. Должен произойти автоматический вход
4. Редирект на dashboard

### 3. Повторное использование ссылки

1. Попытаться использовать ту же ссылку повторно
2. Должна быть ошибка "Токен уже использован"

### 4. Истёкший токен

1. Создать токен
2. Изменить `expires_at` в БД на прошлое время
3. Попытаться использовать ссылку
4. Должна быть ошибка "Токен истёк"

### 5. Отключение password login

**Включить режим:**
```bash
# В .env или environment
MAGIC_LINK_ONLY=1
```

**Проверить:**
1. Перейти на `/login/`
2. Должно быть сообщение "Вход только по одноразовой ссылке"
3. Форма пароля не должна работать

---

## Тесты

**Запуск тестов:**
```bash
cd backend
python manage.py test accounts.tests_magic_link -v 2
```

**Ожидаемый результат:** Все тесты проходят

---

## Риски и rollback

### Риски:
1. **Потеря доступа:** Если админ заблокирован, некому создать ссылку
   - **Митигация:** Супер-админ всегда может войти по паролю (если не аннулирован)

2. **Утечка токена:** Если токен перехвачен, злоумышленник может войти
   - **Митигация:** Одноразовость, короткий TTL (30 минут), rate limiting

3. **Регрессия:** Существующие сессии могут быть нарушены
   - **Митигация:** Вариант A (форма остаётся, но показывает сообщение) минимизирует риски

### Rollback план:

**Если нужно вернуть password login:**
1. Установить `MAGIC_LINK_ONLY=0` в env
2. Перезапустить сервер
3. Пользователи смогут войти по паролю

**Откат миграции:**
```bash
cd backend
python manage.py migrate accounts 0004_user_email_signature_html
```

**Откат кода:**
```bash
git checkout HEAD~1 backend/accounts/models.py
git checkout HEAD~1 backend/accounts/views.py
git checkout HEAD~1 backend/ui/views.py
git checkout HEAD~1 backend/crm/urls.py
git checkout HEAD~1 backend/ui/urls.py
git checkout HEAD~1 backend/templates/registration/login.html
git checkout HEAD~1 backend/templates/ui/settings/user_form.html
```

---

## Следующие шаги

1. ✅ Задача 2 завершена
2. ⏭️ Переход к задаче 3 (Android рекомендации)
3. ⏭️ Задача 4 (Критичные правки)

---

## Статус: ✅ ГОТОВО К ТЕСТИРОВАНИЮ

Все изменения внесены, тесты написаны, документация обновлена. Готово к ручному тестированию и деплою.

**Примечание:** Management commands для аннулирования паролей и очистки токенов можно добавить позже, если потребуется.
