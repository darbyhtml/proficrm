# Варианты получения контактов из AmoCRM API

## Текущая проблема

**Текущий подход (`fetch_contacts_bulk`):**
- Использует `filter[company_id][]` с массивом ID компаний
- API возвращает **все контакты**, связанные с **любой** из указанных компаний
- Результат: 25000 контактов, из которых только 9-20 нужны (0.04-0.08% релевантности)
- Время: ~2 минуты

## Альтернативные подходы

### Вариант 1: Запрос каждой компании с `with=contacts` (уже есть в коде)

**Как работает:**
```python
for company_id in company_ids:
    company_data = client.get(
        f"/api/v4/companies/{company_id}",
        params={"with": "custom_fields,contacts"}
    )
    contacts = company_data.get("_embedded", {}).get("contacts", [])
```

**Плюсы:**
- ✅ Возвращает **только** контакты для этой компании
- ✅ Не нужно фильтровать локально
- ✅ Надежно работает

**Минусы:**
- ❌ Медленно: для 50 компаний = 50 запросов (7 сек при rate limit 7 req/sec)
- ❌ Может вызвать 504 ошибку для больших компаний
- ❌ Контакты могут быть в упрощенном формате (нужен дополнительный запрос)

**Время:** ~7-10 секунд для 50 компаний (но может быть медленнее из-за 504)

### Вариант 2: `filter[company_id]=ID` для каждой компании (уже есть в коде)

**Как работает:**
```python
for company_id in company_ids:
    contacts = client.get_all_pages(
        "/api/v4/contacts",
        params={"filter[company_id]": company_id}  # БЕЗ [] - для одного ID
    )
```

**Плюсы:**
- ✅ Возвращает **только** контакты для этой компании
- ✅ Полные данные контактов (custom_fields)

**Минусы:**
- ❌ Очень медленно: для 50 компаний = 50+ запросов (7+ сек при rate limit)
- ❌ Каждая компания = отдельный запрос

**Время:** ~7-10 секунд для 50 компаний

### Вариант 3: Гибридный подход (РЕКОМЕНДУЕТСЯ)

**Идея:** Использовать разные методы в зависимости от размера батча

**Для небольших батчей (≤10 компаний):**
- Использовать `filter[company_id]=ID` для каждой компании
- Быстро и точно

**Для больших батчей (>10 компаний):**
- Использовать `filter[company_id][]` с массивом
- С ранним прерыванием пагинации

**Реализация:**
```python
def fetch_contacts_bulk_hybrid(client, company_ids):
    if len(company_ids) <= 10:
        # Для небольших батчей - точный запрос для каждой компании
        return fetch_contacts_per_company(client, company_ids)
    else:
        # Для больших батчей - bulk запрос с ранним прерыванием
        return fetch_contacts_bulk(client, company_ids)
```

**Ожидаемое время:**
- 10 компаний: ~1-2 секунды (точный запрос)
- 50 компаний: ~20-30 секунд (bulk с ранним прерыванием)

### Вариант 4: Проверка наличия контактов перед запросом (НЕВОЗМОЖНО)

**Проблема:** AmoCRM API **не предоставляет** способ проверить наличие контактов без их получения.

**Почему нельзя:**
- Нет endpoint для проверки "есть ли контакты у компании"
- Единственный способ - запросить контакты и проверить результат

## Рекомендация

**Использовать гибридный подход (Вариант 3):**

1. **Для батчей ≤10 компаний:** Использовать `filter[company_id]=ID` для каждой компании
   - Быстро (1-2 сек)
   - Точно (только нужные контакты)

2. **Для батчей >10 компаний:** Использовать `filter[company_id][]` с ранним прерыванием
   - Приемлемо быстро (20-30 сек вместо 2 минут)
   - Учитывает ограничения API

## Сравнение подходов

| Подход | Время (50 компаний) | Точность | Надежность |
|--------|---------------------|----------|------------|
| Текущий (bulk) | ~2 минуты | 0.04% | ✅ Высокая |
| `with=contacts` | ~7-10 сек | 100% | ⚠️ Может быть 504 |
| `filter[company_id]=ID` | ~7-10 сек | 100% | ✅ Высокая |
| **Гибридный** | **~20-30 сек** | **100%** | **✅ Высокая** |

## Итог

**Гибридный подход** - оптимальное решение:
- Для небольших батчей: быстро и точно
- Для больших батчей: приемлемо быстро с ранним прерыванием
- Гарантирует получение всех контактов
