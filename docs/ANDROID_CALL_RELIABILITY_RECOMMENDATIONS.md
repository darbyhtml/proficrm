# Android Call Reliability — Рекомендации и Правки

**Дата:** 2024-01-XX  
**Версия:** 1.0

---

## 1. Анализ текущей реализации

### 1.1. Polling механизм

**Текущее состояние:**
- Адаптивная частота polling: 600ms (при команде) → 5s (при пустых ответах)
- Rate limiting: при 429 увеличивается задержка до 20s
- Jitter: случайная задержка ±100ms для предотвращения thundering herd

**Оценка:** ✅ Хорошо оптимизировано

**Рекомендации:**
- **P0:** Текущая реализация достаточна для стабильной работы
- **P1:** Рассмотреть Firebase Cloud Messaging (FCM) для push-уведомлений вместо polling

### 1.2. PhoneNumberNormalizer

**Текущее состояние:**
- Простая нормализация: убирает пробелы, дефисы, скобки, плюсы
- Заменяет "8" на "7" для российских номеров (11 цифр)
- Не поддерживает международные форматы, добавочные номера, короткие номера

**Оценка:** ⚠️ Базовое покрытие, можно улучшить

**Рекомендации:**
- **P0:** Добавить поддержку добавочных номеров (extensions)
- **P1:** Рассмотреть использование `libphonenumber` для более точной нормализации

### 1.3. CallLogObserverManager

**Текущее состояние:**
- ContentObserver для отслеживания изменений CallLog
- Retry схема: 5, 10, 15 секунд после открытия звонилки
- Временное окно: от 2 минут до начала до 15 минут после

**Оценка:** ✅ Хорошо реализовано

**Рекомендации:**
- **P0:** Текущая реализация достаточна
- **P1:** Добавить метрики для отслеживания доли успешных определений через Observer vs Retry

### 1.4. Логирование

**Текущее состояние:**
- ✅ Маскирование чувствительных данных (токены, пароли, номера телефонов)
- ✅ Маскирование device_id
- ✅ Маскирование Authorization headers

**Оценка:** ✅ Хорошо защищено

---

## 2. Рекомендации по приоритетам

### P0: Критичные улучшения (без изменения инфраструктуры)

#### 2.1. Улучшение PhoneNumberNormalizer

**Проблема:** Не поддерживает добавочные номера (extensions)

**Решение:**
```kotlin
fun normalize(phone: String): String {
    // Разделяем основной номер и добавочный
    val parts = phone.split(Regex("""[,\s]+(?:доб|ext|extension|добавочный)[\s:]*""", RegexOption.IGNORE_CASE))
    val mainNumber = parts[0]
    
    var normalized = mainNumber.replace(" ", "")
        .replace("-", "")
        .replace("(", "")
        .replace(")", "")
        .replace("+", "")
    
    // Если номер начинается с 8 и имеет длину российского номера (11 цифр), заменяем 8 на 7
    if (normalized.startsWith("8") && normalized.length == 11) {
        normalized = "7" + normalized.substring(1)
    }
    
    return normalized
}
```

**Файл:** `android/CRMProfiDialer/app/src/main/java/ru/groupprofi/crmprofi/dialer/domain/PhoneNumberNormalizer.kt`

#### 2.2. Улучшение matching в CallLogObserverManager

**Проблема:** Может не находить звонки с добавочными номерами

**Решение:** Использовать улучшенную нормализацию (см. выше)

### P1: Улучшения с минимальной инфраструктурой

#### 2.3. Firebase Cloud Messaging (FCM)

**Преимущества:**
- Мгновенная доставка команд (вместо polling)
- Экономия батареи
- Снижение нагрузки на сервер

**Реализация:**
1. Добавить FCM SDK в Android приложение
2. Создать endpoint на backend для отправки push-уведомлений
3. При получении команды на звонок → отправлять push через FCM
4. Android приложение получает push → открывает звонилку
5. Polling остаётся как fallback

**Файлы:**
- `android/CRMProfiDialer/app/build.gradle` — добавить FCM dependency
- `android/CRMProfiDialer/app/src/main/java/ru/groupprofi/crmprofi/dialer/notifications/FcmService.kt` — новый файл
- `backend/phonebridge/api.py` — добавить отправку push при создании CallRequest

### P2: Долгосрочные улучшения

#### 2.4. Метрики и наблюдаемость

**Добавить:**
- Время доставки команды (от создания до получения на устройстве)
- Время определения результата (от открытия звонилки до отправки статистики)
- Доля успешных определений через Observer vs Retry
- Доля unknown статусов

**Реализация:**
- Добавить telemetry события в `PhoneTelemetry`
- Отображать метрики в админке

---

## 3. Минимальные безопасные правки

### 3.1. Улучшение PhoneNumberNormalizer (P0)

**Файл:** `android/CRMProfiDialer/app/src/main/java/ru/groupprofi/crmprofi/dialer/domain/PhoneNumberNormalizer.kt`

**Изменения:**
- Добавить поддержку добавочных номеров
- Улучшить обработку коротких номеров

### 3.2. Тесты для PhoneNumberNormalizer

**Файл:** `android/CRMProfiDialer/app/src/test/java/ru/groupprofi/crmprofi/dialer/domain/PhoneNumberNormalizerTest.kt`

**Добавить тесты:**
- Номера с добавочными
- Короткие номера
- Международные форматы

---

## 4. Риски

### 4.1. Изменение PhoneNumberNormalizer

**Риск:** Может сломать существующее сопоставление номеров

**Митигация:**
- Добавить тесты перед изменением
- Обратная совместимость (старые номера продолжают работать)

### 4.2. Внедрение FCM

**Риск:** Требует настройки Firebase проекта

**Митигация:**
- Polling остаётся как fallback
- Постепенное внедрение (feature flag)

---

## 5. Следующие шаги

1. ✅ Улучшить PhoneNumberNormalizer (P0)
2. ⏭️ Добавить тесты
3. ⏭️ Рассмотреть FCM (P1)

---

## 6. Выводы

**Текущее состояние:** ✅ Хорошо оптимизировано

**Основные улучшения:**
- PhoneNumberNormalizer: добавить поддержку добавочных номеров (P0)
- FCM: рассмотреть для мгновенной доставки команд (P1)

**Стабильность:** Высокая (адаптивный polling, retry схема, маскирование логов)
