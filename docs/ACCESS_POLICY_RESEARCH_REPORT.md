# Ресёрч: где сейчас проверяются доступы и как это связано с policy

## Что изменилось
- **Реестр ресурсов**: расширен `backend/policy/resources.py` (добавлены ключи для почты/уведомлений и части UI‑действий компаний/задач).
- **Baseline (дефолты)**: расширен `backend/policy/engine.py::baseline_allowed_for_role()` — теперь он знает про новые UI‑страницы/действия и даёт предсказуемый дефолт по ролям.
- **UI enforcement**:
  - `backend/mailer/views.py`: добавлены `enforce()` для страниц и действий (кампании, SMTP, отписки и т.д.).
  - `backend/notifications/views.py`: добавлены `enforce()` для страниц и действий (poll/mark read/all).
  - `backend/ui/views.py`: добавлены `enforce()` для ключевых страниц/действий компаний и задач (список/карточка, CRUD‑действия, экспорт, статусы и т.д.).
- **UI “Доступы”** (`/settings/access/`):
  - кнопка восстановления дефолтов **для страниц**;
  - кнопка восстановления дефолтов **для действий (UI)**.

## Что хранится в БД, а что остаётся в коде
- **В БД (`PolicyRule`)**:
  - явные allow/deny **по ролям** для ключей `ui:*` (страницы и действия), которые вы создаёте/правите в `/settings/access/`.
- **В коде остаётся неизбежно**:
  - **object-level** проверки (например, “менеджер может редактировать только свою компанию/задачу”);
  - **branch-level** ограничения (директор/РОП — в рамках филиала);
  - queryset‑фильтрация (например, видимость задач/кампаний по роли/филиалу).

## Рекомендованный порядок включения
1. Оставить **observe_only** и нажать:
   - “Восстановить дефолтные правила страниц”
   - “Восстановить дефолтные правила действий (UI)”
2. Пройти регрессию по `docs/ACCESS_POLICY_REGRESSION_CHECKLIST.md` и посмотреть `ActivityEvent` с `entity_type=policy`.
3. Только потом включать **enforce** (с галочкой подтверждения).

