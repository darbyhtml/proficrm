# Оптимизация импорта AmoCRM

## Обзор изменений

Реализованы оптимизации для ускорения импорта из AmoCRM в несколько раз при соблюдении лимита 7 API-запросов в секунду.

## Основные оптимизации

### 1. Rate Limiting (7 RPS)
- **Файл**: `backend/amocrm/client.py`
- **Изменения**:
  - Увеличен rate limit с 5 до 7 запросов/сек (0.143 сек между запросами)
  - Добавлен счетчик API-запросов (`_request_count`)
  - Добавлены методы `get_metrics()` и `reset_metrics()` для отслеживания метрик
  - Rate limiting применяется централизованно в методе `_request()`

### 2. Bulk-получение контактов
- **Файл**: `backend/amocrm/migrate.py`
- **Новая функция**: `fetch_contacts_bulk()`
- **Изменения**:
  - Заменен метод получения контактов "по каждой компании" на bulk-запросы
  - Используется `/api/v4/contacts` с `filter[company_id][]` (массив ID)
  - Батчинг по 50 компаний для избежания длинных URL
  - Fallback на получение всех контактов с локальной фильтрацией
  - **Результат**: Вместо N запросов (по одному на компанию) делается ~N/50 запросов

### 3. Bulk-получение заметок контактов
- **Файл**: `backend/amocrm/migrate.py`
- **Новая функция**: `fetch_notes_for_contacts_bulk()`
- **Изменения**:
  - Заменен метод получения заметок "по каждому контакту" на bulk-запросы
  - Используется `/api/v4/notes` с `filter[entity_type]=contacts` и `filter[entity_id][]`
  - Батчинг по 200 контактов
  - **Результат**: Вместо N запросов (по одному на контакт) делается ~N/200 запросов

### 4. Оптимизация записи в БД (устранение N+1)
- **Файл**: `backend/amocrm/migrate.py`
- **Изменения**:
  - Предзагрузка существующих контактов, телефонов и почт для всей пачки
  - Использование `bulk_create()` для создания новых телефонов/почт
  - Использование `bulk_update()` для обновления существующих телефонов
  - Проверка существования через предзагруженные словари вместо `.exists()` в цикле
  - **Результат**: Вместо N*M запросов (N контактов × M телефонов/почт) делается 3 запроса (предзагрузка) + bulk-операции

### 5. Уменьшение логирования
- **Файл**: `backend/amocrm/migrate.py`
- **Изменения**:
  - Логирование только каждые 10 компаний вместо каждой
  - Убрано избыточное отладочное логирование структуры контактов
  - Убрано логирование для каждого контакта при замене на полные данные
  - **Результат**: Меньше операций I/O, ускорение обработки

### 6. Увеличение размера батчей
- **Файл**: `backend/amocrm/migrate.py`
- **Изменения**:
  - Размер батча для задач увеличен с 10 до 20 компаний
  - **Результат**: В 2 раза меньше запросов для задач

### 7. Метрики и мониторинг
- **Файл**: `backend/amocrm/migrate.py`
- **Изменения**:
  - Добавлено логирование метрик в конце импорта:
    - Время выполнения
    - Количество API-запросов
    - Средний RPS
    - Статистика по сущностям

## Ожидаемое ускорение

- **Контакты**: В 10-50 раз быстрее (в зависимости от количества контактов на компанию)
- **Заметки контактов**: В 50-200 раз быстрее (в зависимости от количества заметок)
- **Запись в БД**: В 5-20 раз быстрее (в зависимости от количества телефонов/почт)
- **Общее ускорение**: В 3-10 раз для типичных сценариев

## Обратная совместимость

- Все изменения обратно совместимы
- Старые функции (`fetch_contacts_for_companies`, `fetch_notes_for_contacts`) оставлены для совместимости
- Бизнес-логика не изменена:
  - Сохранена логика "мягкого апдейта" через `raw_fields/amo_values`
  - Сохранено поведение dry-run
  - Сохранены все правила обновления полей

## Проверка работы

### Smoke-тест

Создана команда для проверки скорости импорта:

```bash
python manage.py test_migration_speed \
    --responsible-user-id 123456 \
    --limit 10 \
    --custom-field-id 789012 \
    --custom-value "Новая CRM"
```

Команда выводит:
- Метрики API-запросов (количество, RPS)
- Статистику по сущностям
- Предупреждения, если RPS превышает лимит
- Эффективность использования bulk-методов

### Метрики в логах

После каждого импорта в логах появляется блок:

```
migrate_filtered: ===== МЕТРИКИ ИМПОРТА =====
  Время выполнения: 45.23 сек
  API-запросов: 156
  Средний RPS: 3.45
  Компаний: seen=50, matched=50, batch=50, created=10, updated=40
  Задач: seen=120, created=50, updated=20
  Заметок: seen=200, created=100, updated=50
  Контактов: seen=150, created=80
migrate_filtered: ===== КОНЕЦ МЕТРИК =====
```

## Технические детали

### Rate Limiting

Rate limiting реализован через `time.sleep()` в методе `_request()`:
- Проверяется время с последнего запроса
- Если прошло меньше `MIN_REQUEST_INTERVAL`, выполняется задержка
- Счетчик запросов увеличивается только для авторизованных запросов

### Bulk-запросы контактов

1. Пробуется `filter[company_id][]` с массивом ID (батчи по 50)
2. Если не работает, получаются все контакты и фильтруются локально
3. Фильтрация по `_embedded.companies` и `company_id`

### Bulk-запросы заметок

1. Используется `/api/v4/notes` с `filter[entity_type]=contacts` и `filter[entity_id][]`
2. Батчинг по 200 контактов
3. Группировка заметок по `entity_id` (contact_id)

### Оптимизация БД

1. Предзагрузка всех существующих контактов для пачки
2. Предзагрузка всех телефонов и почт для этих контактов
3. Использование словарей для быстрой проверки существования
4. Bulk-операции для создания/обновления

## Ограничения

- Rate limit: максимум 7 запросов/сек (жестко задано в коде)
- Батчинг контактов: максимум 50 компаний на батч (лимит AmoCRM API)
- Батчинг заметок: максимум 200 контактов на батч (для избежания длинных URL)
- Bulk-create: использует `ignore_conflicts=True` для избежания дубликатов

## Известные проблемы

Нет известных проблем. Все изменения протестированы на компиляцию.

## Дальнейшие улучшения (опционально)

1. Параллельная обработка нескольких батчей (с соблюдением rate limit)
2. Кэширование метаданных полей между запусками
3. Инкрементальный импорт (только измененные записи)
4. Параллельная запись в БД для разных типов сущностей
