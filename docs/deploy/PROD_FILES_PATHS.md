# Где на проде хранятся файлы (статика, медиа, бэкапы)

Актуально для деплоя через `docker-compose.prod.yml` и `deploy_security.sh`. Корень проекта на сервере по умолчанию: **`/opt/proficrm`**.

## Пути на хосте (сервер)

| Назначение | Путь на хосте | Примечание |
|------------|----------------|------------|
| **Корень проекта** | `/opt/proficrm` | Здесь лежат `docker-compose.*.yml`, `.env`, `deploy_security.sh`, `data/`. |
| **Статика (CSS, JS, картинки из приложения)** | `/opt/proficrm/data/staticfiles/` | Заполняется при деплое командой `collectstatic`. Только чтение приложением. |
| **Медиа (загрузки пользователей, вложения)** | `/opt/proficrm/data/media/` | Сюда пишут web и celery. **Бэкапы:** этот каталог нужно включать в резервное копирование. |
| **Бэкапы БД** | `/opt/proficrm/backups/` | Дампы PostgreSQL (скрипт `scripts/backup_postgres.sh`). Не в Docker-томе. |

Если проект развёрнут в другом каталоге (например `/opt/crm`), замените `/opt/proficrm` на свой путь в nginx (см. `nginx/production.conf`) и в скриптах.

## Что лежит внутри `data/media/`

Все загрузки идут в `MEDIA_ROOT` (в контейнере: `/app/backend/media`, на хосте: `.../data/media/`). Подкаталоги создаёт Django по полям `upload_to`:

| Подкаталог | Что хранится |
|------------|----------------|
| `company_notes/ГГГГ/ММ/ДД/` | Вложения к заметкам компаний (файлы, картинки из заметок). |
| `campaign_attachments/ГГГГ/ММ/` | Вложения к рассылкам (mailer). |
| `mobile_apps/` | APK-файлы (phonebridge). |

Картинки и файлы из интерфейса (заметки, рассылки и т.д.) — всегда в `data/media/` в этих подкаталогах.

## Nginx

В `nginx/production.conf` для раздачи статики и медиа используются:

- `/static/` → `alias /opt/proficrm/data/staticfiles/`
- `/media/`  → `alias /opt/proficrm/data/media/`

Путь должен совпадать с каталогом, из которого запускается `deploy_security.sh`. После смены пути перезагрузите nginx: `sudo nginx -t && sudo systemctl reload nginx`.

## Docker (внутри контейнеров)

- **web:** монтируются `./data/staticfiles` и `./data/media` в `/app/backend/staticfiles` и `/app/backend/media`.
- **celery / celery-beat:** монтируется только `./data/media` (запись в медиа).

Относительный путь `./data/...` считается от корня проекта на хосте (например `/opt/proficrm`).

## Рекомендации

1. **Бэкапы:** регулярно копировать `data/media/` и при необходимости `data/staticfiles/` (статика при необходимости восстанавливается через `collectstatic`).
2. **Права:** после деплоя каталоги `data/staticfiles` и `data/media` должны быть доступны на запись процессам из контейнеров (скрипт деплоя выставляет права; при проблемах см. `deploy_security.sh` и комментарии в нём).
3. **Один сервер — один корень:** везде используйте один и тот же путь к проекту (хост, nginx, скрипты), чтобы не было рассинхрона статики и медиа.
