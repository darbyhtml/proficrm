# Правила передачи компаний в CRM

**Дата создания:** 2024-01-XX  
**Версия:** 1.0

---

## 1. Source of Truth

**Поле владения компанией:** `Company.responsible` (ForeignKey на User)

Это единственное поле, определяющее, кто является ответственным за компанию. При передаче компании обновляется именно это поле.

---

## 2. Правила передачи по ролям

### 2.1. Менеджер (MANAGER)

**Может передавать:**
- ✅ ТОЛЬКО компании, где он является ответственным (`company.responsible_id == user.id`)

**Может передавать кому:**
- ✅ Любому менеджеру любого филиала
- ✅ Любому РОП любого филиала
- ✅ Любому директору филиала любого филиала
- ❌ НЕ может передавать управляющему компании (GROUP_MANAGER)
- ❌ НЕ может передавать администратору (ADMIN)

**Где доступна передача:**
- ✅ Карточка компании (если менеджер является ответственным)
- ✅ Список компаний (массовая передача, только своих компаний)

### 2.2. Руководитель отдела продаж (SALES_HEAD)

**Может передавать:**
- ✅ Любую компанию менеджеров СВОЕГО филиала (`company.responsible.branch_id == user.branch_id` И `company.responsible.role == MANAGER`)
- ✅ Компании, где ответственный — РОП СВОЕГО филиала
- ✅ Компании, где ответственный — директор СВОЕГО филиала
- ❌ НЕ может передавать компании других филиалов
- ❌ НЕ может передавать компании, где ответственный — GROUP_MANAGER или ADMIN

**Может передавать кому:**
- ✅ Любому менеджеру любого филиала
- ✅ Любому РОП любого филиала
- ✅ Любому директору филиала любого филиала
- ❌ НЕ может передавать управляющему компании (GROUP_MANAGER)
- ❌ НЕ может передавать администратору (ADMIN)

**Где доступна передача:**
- ✅ Карточка компании (если компания в его филиале)
- ✅ Список компаний (массовая передача, только компаний своего филиала)

### 2.3. Директор филиала (BRANCH_DIRECTOR)

**Права идентичны РОП:**
- ✅ Может передавать любую компанию менеджеров СВОЕГО филиала
- ✅ Может передавать компании РОП и директоров СВОЕГО филиала
- ❌ НЕ может передавать компании других филиалов

**Может передавать кому:**
- ✅ Любому менеджеру любого филиала
- ✅ Любому РОП любого филиала
- ✅ Любому директору филиала любого филиала
- ❌ НЕ может передавать управляющему компании (GROUP_MANAGER)
- ❌ НЕ может передавать администратору (ADMIN)

### 2.4. Управляющий группой компаний (GROUP_MANAGER)

**Может передавать:**
- ✅ Любую компанию кому угодно

**Может передавать кому:**
- ✅ Любому менеджеру любого филиала
- ✅ Любому РОП любого филиала
- ✅ Любому директору филиала любого филиала
- ❌ НЕ может передавать другому управляющему компании (GROUP_MANAGER)
- ❌ НЕ может передавать администратору (ADMIN)

### 2.5. Администратор (ADMIN)

**Может передавать:**
- ✅ Любую компанию кому угодно

**Может передавать кому:**
- ✅ Любому менеджеру любого филиала
- ✅ Любому РОП любого филиала
- ✅ Любому директору филиала любого филиала
- ❌ НЕ может передавать управляющему компании (GROUP_MANAGER)
- ❌ НЕ может передавать другому администратору (ADMIN)

---

## 3. UX массовой передачи

### 3.1. Проверка прав на выбранные компании

**На странице списка компаний:**

1. При выборе компаний (чекбоксы) проверяется:
   - Может ли текущий пользователь передавать каждую выбранную компанию

2. Если хотя бы одна компания не разрешена:
   - ✅ Кнопка "Передать" должна быть **disabled** (серая, неактивная)
   - ✅ При наведении показывать tooltip: *"Одна или несколько выбранных компаний не принадлежат вам (вы не ответственный). Уберите их из выбора или откройте только свои компании."*

3. Если все выбранные компании разрешены:
   - ✅ Кнопка "Передать" активна

### 3.2. Выбор получателя передачи

**Группировка по филиалам:**

В модалке/списке получателей:
- Заголовок: **"Филиал: Екатеринбург"**
- Список пользователей филиала (менеджеры, РОП, директор)
- Заголовок: **"Филиал: Тюмень"**
- Список пользователей филиала
- И т.д.

**Исключения из списка:**
- ❌ Управляющий компании (GROUP_MANAGER) — не показывать
- ❌ Администраторы (ADMIN) — не показывать

**Где применяется:**
- ✅ Карточка компании (одиночная передача)
- ✅ Список компаний (массовая передача)

---

## 4. Backend валидация

### 4.1. Endpoints

#### 4.1.1. Одиночная передача

**URL:** `POST /companies/<uuid:company_id>/transfer/`  
**View:** `company_transfer()` в `backend/ui/views.py`

**Валидация:**
1. Проверка прав на передачу конкретной компании (по правилам выше)
2. Проверка, что новый ответственный разрешён (не GROUP_MANAGER, не ADMIN)
3. Если валидация не пройдена → возврат 403/400 с понятным сообщением

#### 4.1.2. Массовая передача

**URL:** `POST /companies/bulk-transfer/`  
**View:** `company_bulk_transfer()` в `backend/ui/views.py`

**Валидация:**
1. Для каждой выбранной компании проверка прав на передачу
2. Если хотя бы одна компания не разрешена → возврат списка запрещённых компаний с причинами
3. Проверка, что новый ответственный разрешён
4. Если валидация не пройдена → возврат 403/400 с детальным сообщением

**Формат ответа при ошибке:**
```json
{
  "error": "Некоторые компании нельзя передать",
  "forbidden_companies": [
    {"id": "uuid", "name": "Компания 1", "reason": "Вы не являетесь ответственным"},
    {"id": "uuid", "name": "Компания 2", "reason": "Компания из другого филиала"}
  ]
}
```

### 4.2. Функции проверки прав

**Файл:** `backend/companies/permissions.py`

**Новые функции:**
- `can_transfer_company(user, company) -> bool` — может ли пользователь передать конкретную компанию
- `get_transfer_targets(user) -> QuerySet[User]` — список получателей передачи (с группировкой по филиалам для UI)
- `can_transfer_companies(user, company_ids: list) -> dict` — проверка массовой передачи, возвращает список запрещённых

---

## 5. Тестирование

### 5.1. Unit тесты

**Файл:** `backend/companies/tests.py` (или создать новый)

**Тесты для permission logic:**
- ✅ Менеджер может передавать только свои компании
- ✅ Менеджер НЕ может передавать чужие компании
- ✅ РОП может передавать компании своего филиала
- ✅ РОП НЕ может передавать компании другого филиала
- ✅ Директор филиала может передавать компании своего филиала
- ✅ GROUP_MANAGER может передавать любые компании
- ✅ ADMIN может передавать любые компании
- ✅ В списке получателей нет GROUP_MANAGER и ADMIN

**Тесты для bulk transfer:**
- ✅ Массовая передача разрешённых компаний — успех
- ✅ Массовая передача с запрещёнными компаниями — ошибка с деталями
- ✅ Смешанный выбор (разрешённые + запрещённые) — ошибка с деталями

**Тесты для UI контекста:**
- ✅ `transfer_targets` не содержит GROUP_MANAGER и ADMIN
- ✅ `transfer_targets` группируется по филиалам (для шаблонов)

### 5.2. Template safety тесты

**Проверка контекстных ключей:**
- ✅ `transfer_targets` присутствует в контексте
- ✅ Структура данных корректна для группировки по филиалам

---

## 6. Изменения в коде

### 6.1. Backend

**Файлы:**
1. `backend/companies/permissions.py` — добавить функции проверки прав на передачу
2. `backend/ui/views.py` — исправить `company_transfer()` и `company_bulk_transfer()`
3. `backend/companies/tests.py` — добавить тесты

### 6.2. Frontend

**Файлы:**
1. `backend/templates/ui/company_list.html` — обновить UI массовой передачи
2. `backend/templates/ui/company_detail.html` — обновить UI одиночной передачи

---

## 7. Rollback план

**Если что-то пойдёт не так:**
1. Откатить миграции (если были добавлены)
2. Вернуть старую версию `permissions.py`
3. Вернуть старую версию views
4. Вернуть старые шаблоны

**Команды:**
```bash
git checkout HEAD~1 backend/companies/permissions.py
git checkout HEAD~1 backend/ui/views.py
git checkout HEAD~1 backend/templates/ui/company_list.html
git checkout HEAD~1 backend/templates/ui/company_detail.html
```

---

## 8. Риски

1. **Регрессия:** Существующие передачи могут перестать работать
   - **Митигация:** Тесты покрывают все сценарии, обратная совместимость сохранена

2. **Производительность:** Проверка прав на каждую компанию в массовой передаче
   - **Митигация:** Использовать bulk проверку через QuerySet фильтры

3. **UX:** Пользователи могут не понять, почему кнопка disabled
   - **Митигация:** Понятный tooltip с объяснением
