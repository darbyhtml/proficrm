# Magic Link Authentication ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2024-01-XX  
**–í–µ—Ä—Å–∏—è:** 1.0

---

## 1. –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –≤—Ö–æ–¥–∞ –≤ CRM —Ç–æ–ª—å–∫–æ –ø–æ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–º —Å—Å—ã–ª–∫–∞–º, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ü–∞—Ä–æ–ª—å–Ω—ã–π –≤—Ö–æ–¥ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫—É).

---

## 2. –ú–æ–¥–µ–ª—å MagicLinkToken

**–§–∞–π–ª:** `backend/accounts/models.py`

**–ü–æ–ª—è:**
- `user` (ForeignKey –Ω–∞ User) ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω —Ç–æ–∫–µ–Ω
- `token_hash` (CharField, max_length=64) ‚Äî SHA256 —Ö—ç—à —Ç–æ–∫–µ–Ω–∞ (—Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ö—ç—à)
- `created_at` (DateTimeField, auto_now_add=True) ‚Äî –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
- `expires_at` (DateTimeField) ‚Äî –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (created_at + 30 –º–∏–Ω—É—Ç)
- `used_at` (DateTimeField, nullable) ‚Äî –≤—Ä–µ–º—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (null = –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)
- `created_by` (ForeignKey –Ω–∞ User) ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, —Å–æ–∑–¥–∞–≤—à–∏–π —Ç–æ–∫–µ–Ω
- `ip_address` (GenericIPAddressField, nullable) ‚Äî IP –∞–¥—Ä–µ—Å –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ (–¥–ª—è –∞—É–¥–∏—Ç–∞)
- `user_agent` (CharField, max_length=255, nullable) ‚Äî User-Agent –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ (–¥–ª—è –∞—É–¥–∏—Ç–∞)

**–ò–Ω–¥–µ–∫—Å—ã:**
- `token_hash` (unique=True) ‚Äî –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- `user`, `expires_at`, `used_at` ‚Äî –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç—ë–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤

**–ú–µ—Ç–æ–¥—ã:**
- `is_valid()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∏—Å—Ç—ë–∫ –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
- `mark_as_used(ip, user_agent)` ‚Äî –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π

---

## 3. Endpoints

### 3.1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)

**URL:** `POST /settings/users/<user_id>/magic-link/generate/`  
**View:** `settings_user_magic_link_generate()` –≤ `backend/ui/views.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º (`require_admin()`)
- –¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º

**–õ–æ–≥–∏–∫–∞:**
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–π —Ç–æ–∫–µ–Ω (32 –±–∞–π—Ç–∞, hex)
2. –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è SHA256 —Ö—ç—à
3. –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å `MagicLinkToken` —Å `expires_at = now + 30 –º–∏–Ω—É—Ç`
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞

**–û—Ç–≤–µ—Ç:**
```json
{
  "token": "abc123...",
  "link": "http://example.com/auth/magic/abc123.../",
  "expires_at": "2024-01-XX 12:30:00"
}
```

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- Rate limiting: –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫—Ç–æ —Å–æ–∑–¥–∞–ª, –¥–ª—è –∫–æ–≥–æ, –∫–æ–≥–¥–∞

### 3.2. –í—Ö–æ–¥ –ø–æ —Ç–æ–∫–µ–Ω—É

**URL:** `GET /auth/magic/<token>/`  
**View:** `magic_link_login()` –≤ `backend/accounts/views.py`

**–õ–æ–≥–∏–∫–∞:**
1. –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è SHA256 —Ö—ç—à —Ç–æ–∫–µ–Ω–∞
2. –ò—â–µ—Ç—Å—è `MagicLinkToken` –ø–æ —Ö—ç—à—É
3. –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ –∏—Å—Ç—ë–∫ (`expires_at > now`), –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (`used_at is None`)
4. –ï—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω:
   - –°–æ–∑–¥–∞—ë—Ç—Å—è Django —Å–µ—Å—Å–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –¢–æ–∫–µ–Ω –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π (`used_at = now`, —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è IP –∏ User-Agent)
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
   - –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –∫–∞–±–∏–Ω–µ—Ç (`/`)
5. –ï—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω:
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –Ω–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:** –í—Ö–æ–¥ –ø–æ –∫–ª—é—á—É –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/login/`:
- –í–∫–ª–∞–¥–∫–∞ "–ü–æ –∫–ª—é—á—É –¥–æ—Å—Ç—É–ø–∞" (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫–ª—é—á–∞ (–±–µ–∑ –ª–æ–≥–∏–Ω–∞)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª—é—á–∞ –∏ –≤—Ö–æ–¥ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `/auth/magic/<token>/`

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- Rate limiting: –Ω–µ —á–∞—â–µ 5 –ø–æ–ø—ã—Ç–æ–∫ –≤ –º–∏–Ω—É—Ç—É —Å –æ–¥–Ω–æ–≥–æ IP
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤
- –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å (–ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω)

---

## 4. UI –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### 4.1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `backend/templates/ui/settings/user_form.html`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ö–Ω–æ–ø–∫–∞ "üîó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á" –≤ —Å–µ–∫—Ü–∏–∏ "–ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞"
- –î–≤–µ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞:
  - **"–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞"** (–∞–∫—Ç–∏–≤–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–∞–º –∫–ª—é—á
  - **"–°—Å—ã–ª–∫–∞"** ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞
- –ö–Ω–æ–ø–∫–∏ "üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è –∫–ª—é—á–∞ –∏ —Å—Å—ã–ª–∫–∏
- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π —Å:
  - –°—Ç–∞—Ç—É—Å–æ–º (–ê–∫—Ç–∏–≤–µ–Ω/–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω/–ò—Å—Ç—ë–∫)
  - –î–∞—Ç–æ–π —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
  - –î–∞—Ç–æ–π –∏—Å—Ç–µ—á–µ–Ω–∏—è
  - IP –∞–¥—Ä–µ—Å–æ–º –∏ User-Agent (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)
  - **–î–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)

### 4.2. –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–§–∞–π–ª:** `backend/templates/ui/settings/users.html`

**–î–æ–±–∞–≤–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- –ö–æ–ª–æ–Ω–∫–∞ "–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Å—ã–ª–∫–∞" —Å –¥–∞—Ç–æ–π —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–æ–∫–µ–Ω–∞
- –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–∞–∫—Ç–∏–≤–Ω–∞/–∏—Å—Ç–µ–∫–ª–∞/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞)

---

## 5. –í—Ö–æ–¥ –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ (`/login/`) –∏–º–µ–µ—Ç –¥–≤–µ –≤–∫–ª–∞–¥–∫–∏:
  - **"–ü–æ –∫–ª—é—á—É –¥–æ—Å—Ç—É–ø–∞"** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚Äî –≤—Ö–æ–¥ –ø–æ –∫–ª—é—á—É –±–µ–∑ –ª–æ–≥–∏–Ω–∞
  - **"–ü–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é"** ‚Äî –≤—Ö–æ–¥ –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)
- –í `SecureLoginView.post()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
  - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (`role == ADMIN`) ‚Üí –≤—Ö–æ–¥ —Ä–∞–∑—Ä–µ—à—ë–Ω
  - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞: "–í—Ö–æ–¥ –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤. –î–ª—è –≤—Ö–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."

**–°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—å—é "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å (16 —Å–∏–º–≤–æ–ª–æ–≤)
- –ü–∞—Ä–æ–ª—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- –ï—Å—Ç—å "–≥–ª–∞–∑–∏–∫" –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª—è
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏

**–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:**
- –í —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
- –ï—Å—Ç—å "–≥–ª–∞–∑–∏–∫" –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª—è

---

## 6. –ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

**–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ "magic link only":**
- –î–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫—Ä–æ–º–µ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞ –∏ —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö —É—á—ë—Ç–æ–∫) —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `set_unusable_password()`
- –õ–æ–≥–∏–Ω—ã –æ—Å—Ç–∞—é—Ç—Å—è (–¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è:**
- –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω (`is_superuser=True`) ‚Äî –ø–∞—Ä–æ–ª—å –Ω–µ –∞–Ω–Ω—É–ª–∏—Ä—É–µ—Ç—Å—è (–¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
- –°–µ—Ä–≤–∏—Å–Ω—ã–µ —É—á—ë—Ç–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º—É —Ñ–ª–∞–≥—É –∏–ª–∏ —Ä–æ–ª–∏

**–ö–æ–º–∞–Ω–¥–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```bash
python manage.py accounts_annul_passwords --dry-run  # –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
python manage.py accounts_annul_passwords  # –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```

---

## 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 7.1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `secrets.token_urlsafe(32)` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –•—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ SHA256 —Ö—ç—à –≤ –ë–î
- –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (–ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)

### 7.2. Rate limiting

- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è: –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –Ω–µ —á–∞—â–µ 5 –ø–æ–ø—ã—Ç–æ–∫ –≤ –º–∏–Ω—É—Ç—É —Å –æ–¥–Ω–æ–≥–æ IP

### 7.3. –ê—É–¥–∏—Ç

- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫—Ç–æ —Å–æ–∑–¥–∞–ª —Ç–æ–∫–µ–Ω, –¥–ª—è –∫–æ–≥–æ, –∫–æ–≥–¥–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫—Ç–æ –≤–æ—à—ë–ª –ø–æ —Ç–æ–∫–µ–Ω—É, –∫–æ–≥–¥–∞, —Å –∫–∞–∫–æ–≥–æ IP
- –•—Ä–∞–Ω–µ–Ω–∏–µ IP –∏ User-Agent –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞

### 7.4. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞

- –¢–æ–∫–µ–Ω —Ç–æ–ª—å–∫–æ –≤ URL (–Ω–µ –≤ POST)
- –î–ª–∏–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (32 –±–∞–π—Ç–∞ = 256 –±–∏—Ç —ç–Ω—Ç—Ä–æ–ø–∏–∏)
- Rate limiting –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

---

## 8. –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤

**Celery –∑–∞–¥–∞—á–∞:**
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (—Ä–∞–∑ –≤ —á–∞—Å) —É–¥–∞–ª—è—Ç—å —Ç–æ–∫–µ–Ω—ã, –≥–¥–µ `expires_at < now` –∏–ª–∏ `used_at is not None`

**Management command:**
```bash
python manage.py cleanup_expired_magic_links
```

---

## 9. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 9.1. Unit —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `backend/accounts/tests_magic_link.py`

**–¢–µ—Å—Ç—ã:**
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ (–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç, –Ω–µ –∞–¥–º–∏–Ω –Ω–µ –º–æ–∂–µ—Ç)
- ‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- ‚úÖ –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- ‚úÖ –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ –í—Ö–æ–¥ —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é
- ‚úÖ Rate limiting –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
- ‚úÖ Rate limiting –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏

### 9.2. Integration —Ç–µ—Å—Ç—ã

- ‚úÖ –ü–æ–ª–Ω—ã–π flow: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‚Üí –≤—Ö–æ–¥
- ‚úÖ –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ç—ë–∫—à–∏–π —Ç–æ–∫–µ–Ω
- ‚úÖ –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω

---

## 10. –ú–∏–≥—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `backend/accounts/migrations/XXXX_add_magic_link_token.py`

**–û–ø–µ—Ä–∞—Ü–∏–∏:**
- –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ `MagicLinkToken`
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `token_hash`, `user`, `expires_at`, `used_at`

---

## 11. Rollback –ø–ª–∞–Ω

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å password login:**

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `MAGIC_LINK_ONLY=0` –≤ env
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –≤–æ–π—Ç–∏ –ø–æ –ø–∞—Ä–æ–ª—é (–µ—Å–ª–∏ –ø–∞—Ä–æ–ª–∏ –Ω–µ –±—ã–ª–∏ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω—ã)

**–ï—Å–ª–∏ –ø–∞—Ä–æ–ª–∏ –±—ã–ª–∏ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω—ã:**
- –ù—É–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª–∏ —á–µ—Ä–µ–∑ Django admin –∏–ª–∏ management command
- –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π:**
```bash
python manage.py accounts_reset_passwords --user-id=123 --password=newpass123
```

---

## 12. –†–∏—Å–∫–∏

1. **–ü–æ—Ç–µ—Ä—è –¥–æ—Å—Ç—É–ø–∞:** –ï—Å–ª–∏ –∞–¥–º–∏–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –Ω–µ–∫–æ–º—É —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –ø–æ –ø–∞—Ä–æ–ª—é (–µ—Å–ª–∏ –Ω–µ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω)

2. **–£—Ç–µ—á–∫–∞ —Ç–æ–∫–µ–Ω–∞:** –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω, –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å, –∫–æ—Ä–æ—Ç–∫–∏–π TTL (30 –º–∏–Ω—É—Ç), rate limiting

3. **–†–µ–≥—Ä–µ—Å—Å–∏—è:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Å—Å–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞—Ä—É—à–µ–Ω—ã
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç A (—Ñ–æ—Ä–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ) –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç —Ä–∏—Å–∫–∏

---

## 13. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 13.1. Backend

1. `backend/accounts/models.py` ‚Äî –º–æ–¥–µ–ª—å `MagicLinkToken`
2. `backend/accounts/views.py` ‚Äî endpoint –≤—Ö–æ–¥–∞ –ø–æ —Ç–æ–∫–µ–Ω—É
3. `backend/ui/views.py` ‚Äî endpoint –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
4. `backend/accounts/management/commands/` ‚Äî –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è–º–∏
5. `backend/crm/settings.py` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `MAGIC_LINK_ONLY`

### 13.2. Frontend

1. `backend/templates/ui/settings/user_form.html` ‚Äî UI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞/—Å—Å—ã–ª–∫–∏ —Å –¥–≤—É–º—è –≤–∫–ª–∞–¥–∫–∞–º–∏, –∏—Å—Ç–æ—Ä–∏—è –∫–ª—é—á–µ–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
2. `backend/templates/registration/login.html` ‚Äî –¥–≤–µ –≤–∫–ª–∞–¥–∫–∏: "–ü–æ –∫–ª—é—á—É –¥–æ—Å—Ç—É–ø–∞" –∏ "–ü–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é"
3. `backend/ui/forms.py` ‚Äî –ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## 14. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `MagicLinkToken`
2. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
3. –°–æ–∑–¥–∞—Ç—å endpoints (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≤—Ö–æ–¥)
4. –û–±–Ω–æ–≤–∏—Ç—å UI
5. –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ password login (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
6. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã
7. –°–æ–∑–¥–∞—Ç—å management commands
