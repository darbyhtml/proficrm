# ЭТАП B: Задача 1 — Передача компаний (ЗАВЕРШЕНО)

**Дата:** 2024-01-XX  
**Статус:** ✅ Завершено

---

## Что было сделано

### 1. Анализ архитектуры ✅
- Изучена текущая реализация передачи компаний
- Найдены все endpoints и views
- Определены проблемы в текущей логике прав
- Создан документ `COMPANY_TRANSFER_RULES.md` с правилами

### 2. Добавлены функции проверки прав ✅
**Файл:** `backend/companies/permissions.py`

**Новые функции:**
- `can_transfer_company(user, company) -> bool` — проверка прав на передачу одной компании
- `get_transfer_targets(user) -> QuerySet[User]` — список получателей (исключает GROUP_MANAGER и ADMIN, группировка по филиалам)
- `can_transfer_companies(user, company_ids) -> dict` — проверка массовой передачи с деталями
- `_get_transfer_forbidden_reason(user, company) -> str` — причина запрета

**Логика:**
- Менеджер: может передавать ТОЛЬКО свои компании
- РОП/Директор филиала: может передавать компании менеджеров СВОЕГО филиала
- GROUP_MANAGER/ADMIN: может передавать любые компании
- В списке получателей исключены GROUP_MANAGER и ADMIN

### 3. Обновлены views ✅
**Файл:** `backend/ui/views.py`

**Изменения:**
- `company_transfer()` — использует `can_transfer_company()` вместо `_can_edit_company()`
- `company_bulk_transfer()` — использует `can_transfer_companies()` для проверки прав и возврата списка запрещённых
- `company_list()` — использует `get_transfer_targets()` вместо прямого QuerySet
- `company_detail()` — использует `get_transfer_targets()` вместо прямого QuerySet
- Добавлен флаг `can_transfer` для каждой компании в списке (для UI проверки)

**Валидация:**
- Проверка, что новый ответственный не GROUP_MANAGER и не ADMIN
- Детальные сообщения об ошибках при массовой передаче

### 4. Обновлены шаблоны ✅
**Файлы:**
- `backend/templates/ui/company_detail.html` — группировка получателей по филиалам через `{% regroup %}`
- `backend/templates/ui/company_list.html` — группировка получателей по филиалам, JavaScript проверка прав, disabled кнопка при неразрешённых компаниях, tooltip

**UX улучшения:**
- Группировка получателей по филиалам в обоих местах
- Кнопка "Переназначить" становится disabled, если выбрана хотя бы одна неразрешённая компания
- Tooltip с объяснением, почему кнопка disabled
- Data-атрибут `data-can-transfer` на чекбоксах для проверки прав в JavaScript

### 5. Написаны тесты ✅
**Файл:** `backend/companies/tests_transfer.py`

**Покрытие:**
- ✅ Менеджер может передавать только свои компании
- ✅ Менеджер НЕ может передавать чужие компании
- ✅ РОП может передавать компании своего филиала
- ✅ РОП НЕ может передавать компании другого филиала
- ✅ Директор филиала может передавать компании своего филиала
- ✅ GROUP_MANAGER может передавать любые компании
- ✅ ADMIN может передавать любые компании
- ✅ В списке получателей нет GROUP_MANAGER и ADMIN
- ✅ Список получателей группируется по филиалам
- ✅ Массовая передача: все компании разрешены
- ✅ Массовая передача: некоторые компании запрещены
- ✅ Массовая передача РОП: все компании своего филиала разрешены
- ✅ Массовая передача РОП: смешанный выбор
- ✅ Массовая передача админа: все компании разрешены
- ✅ Проверка причин запрета

---

## Изменённые файлы

1. `backend/companies/permissions.py` — добавлены функции проверки прав
2. `backend/ui/views.py` — обновлены views для использования новых функций
3. `backend/templates/ui/company_detail.html` — группировка получателей по филиалам
4. `backend/templates/ui/company_list.html` — группировка, проверка прав в JS, disabled кнопка
5. `backend/companies/tests_transfer.py` — новые тесты

---

## Как проверить вручную

### 1. Одиночная передача

**Как менеджер:**
1. Войти как менеджер
2. Открыть карточку своей компании
3. В форме "Передать другому менеджеру" должны быть получатели, сгруппированные по филиалам
4. GROUP_MANAGER и ADMIN не должны быть в списке
5. Попытаться передать чужую компанию → должна быть ошибка "Нет прав на передачу компании"

**Как РОП:**
1. Войти как РОП
2. Открыть карточку компании менеджера своего филиала
3. Должна быть возможность передать
4. Открыть карточку компании менеджера другого филиала
5. Не должно быть возможности передать

### 2. Массовая передача

**Как менеджер:**
1. Войти как менеджер
2. Открыть список компаний
3. Выбрать свою компанию → кнопка "Переназначить" активна
4. Выбрать чужую компанию → кнопка "Переназначить" disabled с tooltip
5. Выбрать свою + чужую → кнопка disabled
6. В списке получателей должны быть только менеджеры, РОП, директора (группировка по филиалам)

**Как РОП:**
1. Войти как РОП
2. Выбрать компании менеджеров своего филиала → кнопка активна
3. Выбрать компании менеджеров другого филиала → кнопка disabled
4. Смешанный выбор → кнопка disabled

### 3. Backend валидация

**Проверить через curl или Postman:**
```bash
# Попытка передать чужую компанию (должна быть ошибка)
curl -X POST http://localhost:8000/companies/<company_id>/transfer/ \
  -H "Cookie: sessionid=..." \
  -d "responsible_id=<manager_id>"
```

---

## Тесты

**Запуск тестов:**
```bash
cd backend
python manage.py test companies.tests_transfer -v 2
```

**Ожидаемый результат:** Все тесты проходят

---

## Риски и rollback

### Риски:
1. **Регрессия:** Существующие передачи могут перестать работать
   - **Митигация:** Тесты покрывают все сценарии, обратная совместимость сохранена

2. **Производительность:** Проверка прав на каждую компанию в массовой передаче
   - **Митигация:** Использован bulk запрос через `select_related()`

3. **UX:** Пользователи могут не понять, почему кнопка disabled
   - **Митигация:** Понятный tooltip с объяснением

### Rollback план:

**Если что-то пойдёт не так:**
```bash
git checkout HEAD~1 backend/companies/permissions.py
git checkout HEAD~1 backend/ui/views.py
git checkout HEAD~1 backend/templates/ui/company_list.html
git checkout HEAD~1 backend/templates/ui/company_detail.html
```

**Или через git revert:**
```bash
git revert <commit-hash>
```

---

## Следующие шаги

1. ✅ Задача 1 завершена
2. ⏭️ Переход к задаче 2 (Magic link auth)
3. ⏭️ Задача 3 (Android рекомендации)
4. ⏭️ Задача 4 (Критичные правки)

---

## Статус: ✅ ГОТОВО К ТЕСТИРОВАНИЮ

Все изменения внесены, тесты написаны, документация обновлена. Готово к ручному тестированию и деплою.
