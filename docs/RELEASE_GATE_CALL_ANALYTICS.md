# Release Gate: Call Analytics (ЭТАП 6)

**Версия:** ЭТАП 0-6 (Call Analytics)  
**Дата:** 2024-01-XX  
**Статус:** ✅ Готово к релизу

---

## Must Pass (обязательные тесты)

### Backend
```bash
cd backend
python manage.py test phonebridge.tests phonebridge.tests_stats ui.tests.test_calls_stats_view
```

**Ожидаемый результат:** Все тесты проходят (16+ тестов)

### Android
```bash
cd android/CRMProfiDialer
./gradlew test
```

**Ожидаемый результат:** Все тесты проходят (25+ тестов)

### Сборка
```bash
cd android/CRMProfiDialer
./gradlew assembleStagingDebug
./gradlew assembleProductionRelease  # Если настроен
```

**Ожидаемый результат:** APK/AAB собраны успешно

---

## Must Check (ручные проверки)

### 1. Уведомления
- [ ] Уведомление "Пора позвонить" работает
- [ ] Уведомление "Приложение не работает" работает
- [ ] Технические уведомления удалены (только 2 пользовательских)

### 2. Очередь (offline → online)
- [ ] Звонок сделан в оффлайне → запись в истории "Ожидает отправки"
- [ ] Интернет включён → запись отправлена → "Отправлено в CRM"
- [ ] Extended payload отправлен из очереди корректно

### 3. Unknown статус
- [ ] Звонок не определён → статус "Не удалось определить" в Android
- [ ] Статус отправлен в CRM → сохранён как UNKNOWN (не no_answer)
- [ ] В UI видно "Не удалось определить" (фиолетовый цвет)
- [ ] В статистике учитывается отдельно (unknown_count)

### 4. Legacy совместимость
- [ ] Старые записи без новых полей отображаются корректно
- [ ] Legacy payload (4 поля) принимается без ошибок
- [ ] Новые поля остаются NULL для legacy записей

### 5. Новые поля
- [ ] Direction отображается ("Исходящий", "Входящий", "Пропущенный")
- [ ] Ended_at отображается ("До HH:mm") если есть
- [ ] Action_source виден только админам
- [ ] Распределения показываются (если есть данные)

---

## Rollback Safe (безопасный откат)

### Что откатывать, если проблема

#### 1. Миграция БД (обратима)
```bash
# Откат миграции (если нужно)
python manage.py migrate phonebridge 0006_mobileappbuild_mobileappqrtoken
```

**Безопасность:** Все новые поля nullable, откат не сломает существующие данные

#### 2. Контракт API (обратим)
- Legacy payload продолжает работать
- Новые поля optional, старые клиенты не ломаются
- Откат: просто не использовать новые поля в UI

#### 3. Android (обратим)
- Старые версии Android продолжают работать (legacy payload)
- Новые версии отправляют extended, но backend принимает оба формата
- Откат: откатить Android APK на предыдущую версию

#### 4. Frontend (обратим)
- Шаблоны проверяют наличие полей перед отображением
- Старые записи не ломают UI
- Откат: откатить изменения в шаблонах

---

## Критические проверки перед релизом

### ✅ Обратная совместимость
- [ ] Legacy payload работает
- [ ] Старые записи отображаются
- [ ] Старые экраны не сломаны

### ✅ Безопасность
- [ ] Токены не логируются
- [ ] Полные номера маскируются в логах
- [ ] PII не попадает в отчёты

### ✅ Производительность
- [ ] Статистика не тормозит (проверить на реальных данных)
- [ ] Распределения считаются быстро
- [ ] Нет N+1 запросов

### ✅ UX
- [ ] Менеджер не видит технических деталей
- [ ] Новые поля отображаются компактно
- [ ] Unknown статус понятен ("Не удалось определить")

---

## Чек-лист релиза

### Pre-release
- [ ] Все тесты проходят (backend + android)
- [ ] Smoke checklist выполнен
- [ ] Миграция применена на staging
- [ ] Staging APK протестирован

### Release
- [ ] Миграция применена на production
- [ ] Production APK/AAB собран и подписан
- [ ] APK загружен в `/mobile-app/` (если используется)
- [ ] Мониторинг включён (логи, метрики)

### Post-release
- [ ] Проверка логов (нет ошибок 500)
- [ ] Проверка метрик (extended vs legacy payload)
- [ ] Проверка UI (страницы загружаются)
- [ ] Обратная связь от пользователей (первые 24 часа)

---

## Мониторинг (рекомендуется)

### Метрики для отслеживания
1. **Процент extended vs legacy payload**
   - Цель: >80% extended через неделю
   - Алерт: если <50% через месяц

2. **Процент unknown статусов**
   - Цель: <5% от всех звонков
   - Алерт: если >10%

3. **Время обработки очереди**
   - Цель: <30 сек от offline → online
   - Алерт: если >5 минут

4. **Ошибки API**
   - Цель: <0.1% ошибок 400/500
   - Алерт: если >1%

### Логи для проверки
```bash
# Backend
tail -f /var/log/django/error.log | grep "UpdateCallInfo"

# Android (через adb)
adb logcat | grep -E "ApiClient|CallEventPayload|sendCallUpdate"
```

---

## Контакты для экстренного отката

- **Backend:** [ответственный за backend]
- **Android:** [ответственный за Android]
- **DevOps:** [ответственный за деплой]

---

**Статус:** ✅ Готово к релизу  
**Дата проверки:** 2024-01-XX  
**Проверил:** [имя]
