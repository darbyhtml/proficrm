# Тестирование P1 Security Changes

## Что было изменено

1. **SEC-006:** Замена `print()` на `logger` в `amocrm/migrate.py`
2. **SEC-007:** Логирование ошибок вместо `pass` в `accounts/security.py`
3. **SEC-010:** Вынос `_require_admin()` в общий модуль `crm/utils.py`
4. **REL-001:** Добавление транзакции в `company_bulk_transfer`

---

## Шаг 1: Обновление на сервере

```bash
cd /opt/proficrm
git pull
docker-compose -f docker-compose.yml -f docker-compose.vds.yml restart web
```

---

## Шаг 2: Проверка запуска

```bash
docker-compose -f docker-compose.yml -f docker-compose.vds.yml logs web --tail=50
```

**Ожидаемый результат:**
- ✅ Приложение запустилось без ошибок
- ✅ Нет `ImportError` или `ModuleNotFoundError`
- ✅ Нет ошибок связанных с `crm.utils` или `require_admin`

---

## Шаг 3: Проверка SEC-010 (require_admin)

### 3.1. Проверка доступа к админским страницам

Проверьте следующие страницы (должны быть доступны только администратору):

1. **Настройки → Обзор** (`/settings/`)
   - Должна открываться для администратора
   - Для обычного пользователя — редирект с сообщением "Доступ запрещён"

2. **Настройки → Импорт компаний** (`/settings/import/`)
   - Должна открываться для администратора
   - Для обычного пользователя — редирект

3. **Настройки → Импорт задач** (`/settings/import-tasks/`)
   - Должна открываться для администратора

4. **Настройки → amoCRM** (`/settings/amocrm/`)
   - Должна открываться для администратора

5. **Настройки → Активность** (`/settings/activity/`)
   - Должна открываться для администратора

6. **Почта → Настройки SMTP** (`/mail/settings/`)
   - Должна открываться для администратора

**Как проверить:**
- Войдите как администратор — все страницы должны открываться
- Войдите как обычный пользователь (менеджер) — должны быть редиректы с сообщением "Доступ запрещён"

---

## Шаг 4: Проверка REL-001 (транзакция в bulk_transfer)

### 4.1. Массовое переназначение компаний

1. Откройте список компаний: `/companies/`
2. Выберите несколько компаний (чекбоксы слева)
3. Нажмите "Переназначить ответственного"
4. Выберите нового ответственного
5. Нажмите "Применить"

**Ожидаемый результат:**
- ✅ Компании успешно переназначены
- ✅ Сообщение: "Переназначено компаний: N. Новый ответственный: [Имя]"
- ✅ Все выбранные компании имеют нового ответственного
- ✅ Филиал компаний обновлен под филиал нового ответственного

### 4.2. Проверка транзакционности (опционально)

Если есть возможность, проверьте, что при ошибке все изменения откатываются:
- Это сложно проверить без специальной настройки, но транзакция должна работать автоматически

---

## Шаг 5: Проверка SEC-006 (логирование в amocrm)

### 5.1. Проверка логов миграции

Если у вас есть доступ к миграции из amoCRM:

1. Откройте `/settings/amocrm/migrate/`
2. Запустите миграцию (dry-run или реальную)
3. Проверьте логи:

```bash
docker-compose -f docker-compose.yml -f docker-compose.vds.yml logs web | grep -i "AMOCRM\|amocrm" | tail -20
```

**Ожидаемый результат:**
- ✅ Логи содержат структурированные сообщения (не просто print)
- ✅ Логи попадают в файл логов (если настроено)
- ✅ Нет ошибок связанных с logger

**Или проверьте файл логов:**
```bash
docker-compose -f docker-compose.yml -f docker-compose.vds.yml exec web tail -50 /app/backend/logs/crm.log | grep -i amocrm
```

---

## Шаг 6: Проверка SEC-007 (логирование ошибок)

### 6.1. Проверка логов при ошибках безопасности

Это сложно проверить напрямую, но можно проверить логи:

```bash
docker-compose -f docker-compose.yml -f docker-compose.vds.yml logs web | grep -i "warning\|error" | tail -20
```

**Ожидаемый результат:**
- ✅ Если есть ошибки логирования событий безопасности, они должны быть видны в логах (не теряются)

---

## Шаг 7: Проверка основных функций

Убедитесь, что основные функции работают:

- ✅ Просмотр списка компаний
- ✅ Просмотр деталей компании
- ✅ Создание/редактирование компании
- ✅ Просмотр задач
- ✅ Создание/редактирование задач
- ✅ Просмотр контактов
- ✅ Работа с почтой (если используется)

---

## Чеклист проверки

- [ ] Изменения отправлены на сервер (`git pull` выполнен)
- [ ] Контейнер перезапущен (`docker-compose restart web`)
- [ ] Приложение запустилось без ошибок
- [ ] **SEC-010:** Админские страницы доступны администратору
- [ ] **SEC-010:** Админские страницы недоступны обычным пользователям
- [ ] **REL-001:** Массовое переназначение компаний работает
- [ ] **SEC-006:** Логи миграции amoCRM структурированы (если тестировали миграцию)
- [ ] Основные функции работают (компании, задачи, контакты)
- [ ] Нет новых ошибок в логах

---

## Что делать, если что-то не работает

### Если приложение не запускается:

1. Проверьте логи:
   ```bash
   docker-compose -f docker-compose.yml -f docker-compose.vds.yml logs web --tail=100
   ```

2. Проверьте импорты:
   ```bash
   docker-compose -f docker-compose.yml -f docker-compose.vds.yml exec web python -c "from crm.utils import require_admin; print('OK')"
   ```

3. Если есть ошибка `ModuleNotFoundError: No module named 'crm.utils'`:
   - Проверьте, что файл `backend/crm/utils.py` существует
   - Проверьте, что в `backend/crm/__init__.py` нет ошибок

4. Если есть ошибка с `require_admin`:
   - Проверьте, что все импорты обновлены
   - Проверьте синтаксис в `backend/crm/utils.py`

### Если админские страницы не работают:

1. Проверьте, что вы вошли как администратор
2. Проверьте логи на наличие ошибок:
   ```bash
   docker-compose -f docker-compose.yml -f docker-compose.vds.yml logs web | grep -i error | tail -20
   ```

### Если массовое переназначение не работает:

1. Проверьте логи на наличие ошибок
2. Проверьте, что у вас есть права на редактирование выбранных компаний
3. Проверьте, что новый ответственный выбран правильно

---

## Отчет о тестировании

После тестирования заполните:

- [ ] Тестирование пройдено успешно
- [ ] Найдены проблемы (какие): ________________
- [ ] Проблемы исправлены: [ ] Да [ ] Нет
- [ ] Приложение работает корректно: [ ] Да [ ] Нет
- [ ] Готовы к продолжению: [ ] Да [ ] Нет

---

## Быстрая проверка (минимальная)

Если нет времени на полное тестирование, проверьте минимум:

1. ✅ Приложение запустилось
2. ✅ Вход в систему работает
3. ✅ Админские страницы доступны администратору (например, `/settings/`)
4. ✅ Массовое переназначение компаний работает

Если все это работает — можно считать, что основные изменения протестированы.
