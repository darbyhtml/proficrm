# –û—Ç—á—ë—Ç: –§–∏–Ω–∞–ª—å–Ω—ã–π Hardening-–∞—É–¥–∏—Ç –ø–µ—Ä–µ–¥ production

## 1. –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

**production-ready** ‚úÖ

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ–±–ª—é–¥–µ–Ω—ã, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞, edge-cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ cleanup-–ª–æ–≥–∏–∫–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞.

## 2. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç** ‚úÖ

### –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ

#### (1) Cleanup-–ª–æ–≥–∏–∫–∞ –≤ reconcile_campaign_queue –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç failed –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `backend/mailer/tasks.py`, —Å—Ç—Ä–æ–∫–∞ 928  
**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ñ—É–Ω–∫—Ü–∏–∏ `reconcile_campaign_queue()` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ pending –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∫–∞–º–ø–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞–ª–∞—Å—å –∫–∞–∫ `SENT` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è `FAILED` –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π. –≠—Ç–æ –Ω–∞—Ä—É—à–∞–ª–æ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç H (—á–µ—Å—Ç–Ω—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫–∞–º–ø–∞–Ω–∏–∏).

**–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏ –≤ `send_pending_emails` (—Å—Ç—Ä–æ–∫–∏ 862-880) –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç failed. `reconcile_campaign_queue` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–ª—è cleanup –∏ –æ–±—ã—á–Ω–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Ç–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π, –Ω–æ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –º–æ–≥–ª–∞ "–∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å" –ø—Ä–æ–±–ª–µ–º—É.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `has_failed` –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π `SENT` (—Å—Ç—Ä–æ–∫–∏ 927-930). –¢–µ–ø–µ—Ä—å –∫–∞–º–ø–∞–Ω–∏—è —Å failed –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ `SENDING`.

#### (2) Fail-open –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ Redis –≤ rate limiter
**–§–∞–π–ª:** `backend/mailer/services/rate_limiter.py`, —Å—Ç—Ä–æ–∫–∞ 80-81  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—à–∏–±–∫–µ Redis —Ñ—É–Ω–∫—Ü–∏—è `reserve_rate_limit_token()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `(True, 0, None)`, —Ä–∞–∑—Ä–µ—à–∞—è –æ—Ç–ø—Ä–∞–≤–∫—É. –≠—Ç–æ fail-open —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è availability.

**–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π. –í production Redis –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç–∞–±–∏–ª–µ–Ω. –ü—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É, —á–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É. –†–∏—Å–∫ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –º–∏–Ω–∏–º–∞–ª–µ–Ω, —Ç–∞–∫ –∫–∞–∫ Redis –æ–±—ã—á–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å alerting –Ω–∞ –æ—à–∏–±–∫–∏ Redis –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

#### (3) –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –∫–ª—é—á–µ–π Redis
**–§–∞–π–ª:** `backend/mailer/services/rate_limiter.py`, —Å—Ç—Ä–æ–∫–∞ 30  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª—é—á–∏ rate limiter –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ñ–æ—Ä–º–∞—Ç `mailer:rate:hour:...`, –Ω–æ –≤ `settings.py` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `KEY_PREFIX = "crm"`. Django Redis –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –±—É–¥—É—Ç `crm:mailer:rate:hour:...`, —á—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ Redis.

**–†–∏—Å–∫:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –≠—Ç–æ –Ω–µ –±–∞–≥, –∞ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã Django Redis. –ö–ª—é—á–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã –∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–µ–π –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å.

#### (4) "–°–≥–æ—Ä–∞–Ω–∏–µ" —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ SMTP error –ø–æ—Å–ª–µ reserve
**–§–∞–π–ª:** `backend/mailer/tasks.py`, —Å—Ç—Ä–æ–∫–∏ 763-788  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω (`reserve_rate_limit_token` –≤–µ—Ä–Ω—É–ª `True`), –Ω–æ –∑–∞—Ç–µ–º –ø—Ä–æ–∏–∑–æ—à–ª–∞ SMTP –æ—à–∏–±–∫–∞, —Ç–æ–∫–µ–Ω "—Å–≥–æ—Ä–∞–µ—Ç" (–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ). –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ transient error –º—ã –º–æ–∂–µ–º "–ø–æ—Ç—Ä–∞—Ç–∏—Ç—å" —Ç–æ–∫–µ–Ω—ã –±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.

**–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ª—É—á—à–µ –Ω–µ–¥–æ–æ—Ç–ø—Ä–∞–≤–∏—Ç—å, —á–µ–º –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç. –ü—Ä–∏ transient error –∫–∞–º–ø–∞–Ω–∏—è –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `defer_queue`, –∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–µ —Ç–æ–∫–µ–Ω—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å. –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏—è—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞.

## 3. –ö–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: Cleanup-–ª–æ–≥–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç failed –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π SENT.

2. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Redis**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å alerting –Ω–∞ –æ—à–∏–±–∫–∏ Redis –≤ rate limiter –¥–ª—è —Ä–∞–Ω–Ω–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

3. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏ Redis**: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ `rate_limiter.py` –æ —Ñ–æ—Ä–º–∞—Ç–µ –∫–ª—é—á–µ–π —Å —É—á—ë—Ç–æ–º `KEY_PREFIX`.

4. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –î–æ–±–∞–≤–∏—Ç—å structured logging —Å campaign_id –∏ defer_reason –¥–ª—è –ª—É—á—à–µ–π observability –≤ production.

## 4. üî• –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï –î–õ–Ø –ê–†–•–ò–¢–ï–ö–¢–û–†–ê

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ–±–ª—é–¥–µ–Ω—ã: rate limiting –∞—Ç–æ–º–∞—Ä–Ω—ã–π, —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–∏—Å—å–º–∞ –Ω–µ –æ–±—Ö–æ–¥—è—Ç –ª–∏–º–∏—Ç—ã, –≤—Å–µ –ø—Ä–∏—á–∏–Ω—ã –ø–∞—É–∑ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ defer_queue, —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∫–∞–º–ø–∞–Ω–∏–π —á–µ—Å—Ç–Ω—ã–µ –≤–æ –≤—Å–µ—Ö –ø—É—Ç—è—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ cleanup-—Ñ—É–Ω–∫—Ü–∏–∏ `reconcile_campaign_queue` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞. Fail-open –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Redis –æ–ø—Ä–∞–≤–¥–∞–Ω–æ –¥–ª—è availability, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞. –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞, –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç race conditions, –∏ –≥–æ—Ç–æ–≤–∞ –∫ production-–Ω–∞–≥—Ä—É–∑–∫–µ.
