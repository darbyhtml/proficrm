# –û—Ç—á—ë—Ç: Enterprise Finishing Pass

–§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ –¥–ª—è –¥–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–æ enterprise-—É—Ä–æ–≤–Ω—è.

## 1. –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ/–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### (1) –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è consecutive_transient_errors ‚úÖ

**–§–∞–π–ª:** `backend/mailer/migrations/0020_campaignqueue_consecutive_transient_errors.py`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è `consecutive_transient_errors` –≤ –º–æ–¥–µ–ª—å `CampaignQueue`
- –ü–æ–ª–µ –∏–º–µ–µ—Ç –¥–µ—Ñ–æ–ª—Ç 0 –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è circuit breaker (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞ –ø—Ä–∏ >= 10 –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥)

**–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:**
```bash
cd backend
python manage.py migrate mailer
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—É—á–∞—é—Ç –¥–µ—Ñ–æ–ª—Ç 0
- –ü–æ–ª–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –º–æ–¥–µ–ª–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ circuit breaker –ª–æ–≥–∏–∫–µ

### (2) Structured logging –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫ ‚úÖ

**–§–∞–π–ª—ã:** `backend/mailer/tasks.py`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω structured logging –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞:
  - `campaign_id`, `queue_id`, `recipient_id`, `recipient_email`
  - `smtp_message_id`, `provider`, `took_ms`, `rate_limit_count`
- –î–æ–±–∞–≤–ª–µ–Ω structured logging –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏:
  - `campaign_id`, `queue_id`, `campaign_status`
  - `totals: {sent, failed, total}`, `duration_seconds`, `finished_with_errors`
- –î–æ–±–∞–≤–ª–µ–Ω structured logging –¥–ª—è rate limit reserve outcome:
  - `campaign_id`, `allowed`, `current_count`, `max_per_hour`, `key_hour`

**–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:**
```json
{
  "level": "INFO",
  "message": "Email sent successfully",
  "campaign_id": "uuid",
  "recipient_id": "uuid",
  "recipient_email": "user@example.com",
  "smtp_message_id": "...",
  "provider": "smtp_global",
  "took_ms": 123,
  "rate_limit_count": 45
}
```

**–ß—Ç–æ —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å:**
- `emails_sent_per_hour` ‚Äî –∏–∑ –ª–æ–≥–æ–≤ —Å `"Email sent successfully"`
- `emails_failed_per_hour` ‚Äî –∏–∑ –ª–æ–≥–æ–≤ —Å `"Failed to send email"`
- `campaigns_finished_ok` ‚Äî –∏–∑ –ª–æ–≥–æ–≤ —Å `"Campaign finished"` –∏ `finished_with_errors=false`
- `campaigns_finished_with_errors` ‚Äî –∏–∑ –ª–æ–≥–æ–≤ —Å `finished_with_errors=true`
- `top_defer_reasons` ‚Äî –∏–∑ –ª–æ–≥–æ–≤ —Å `"Campaign deferred"`
- `rate_limit_usage` ‚Äî –∏–∑ –ª–æ–≥–æ–≤ —Å `"Rate limit token reserve"`

### (3) –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π playbook ‚úÖ

**–§–∞–π–ª:** `MAILER_ONCALL_PLAYBOOK.md`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π playbook –¥–ª—è on-call –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤
- –í–∫–ª—é—á–∞–µ—Ç:
  - –ë—ã—Å—Ç—Ä—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∑–∞ 60 —Å–µ–∫—É–Ω–¥ (SQL-–∑–∞–ø—Ä–æ—Å—ã, Redis –∫–æ–º–∞–Ω–¥—ã, Celery –ø—Ä–æ–≤–µ—Ä–∫–∏)
  - –ß–∞—Å—Ç—ã–µ —Å–∏–º–ø—Ç–æ–º—ã ‚Üí –ø—Ä–∏—á–∏–Ω—ã ‚Üí –¥–µ–π—Å—Ç–≤–∏—è (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ defer_reason)
  - Runbook-–æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫–∞–∫ –≤–∫–ª—é—á–∏—Ç—å/–ø–∞—É–∑–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Celery)
  - –°–ø–∏—Å–æ–∫ –∞–ª—ë—Ä—Ç–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–µ)
  - –ü–æ–ª–µ–∑–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è on-call –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–ø–µ—Ä–≤—ã–µ –≤–∏–¥—è—Ç —Å–∏—Å—Ç–µ–º—É
- –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏ SQL-–∑–∞–ø—Ä–æ—Å—ã –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- –û–ø–∏—Å–∞–Ω—ã –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø–∞—É–∑ –∏ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π

### (4) –ó–∞—â–∏—Ç–∞ –æ—Ç abuse: throttling + –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏ ‚úÖ

**–§–∞–π–ª—ã:** 
- `backend/mailer/throttle.py` (–Ω–æ–≤—ã–π)
- `backend/mailer/constants.py`
- `backend/mailer/views.py`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**

**A) Throttling –Ω–∞ endpoints:**
- –°–æ–∑–¥–∞–Ω helper `is_user_throttled()` –¥–ª—è throttling –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–µ –ø–æ IP)
- –î–æ–±–∞–≤–ª–µ–Ω throttling –Ω–∞ `campaign_start`: 10 –∑–∞–ø—É—Å–∫–æ–≤/—á–∞—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –î–æ–±–∞–≤–ª–µ–Ω throttling –Ω–∞ `send_test_email`: 5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–∏—Å–µ–º/—á–∞—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ rate limiter)
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**B) –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `MAX_CAMPAIGN_RECIPIENTS = 10000`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `campaign_start`: –µ—Å–ª–∏ `total_recipients > MAX_CAMPAIGN_RECIPIENTS`, —Å—Ç–∞—Ä—Ç –∑–∞–ø—Ä–µ—â—ë–Ω
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "–ö–∞–º–ø–∞–Ω–∏—è —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è, —Ä–∞–∑–±–µ–π—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ"

**Rationale:**
- –û–¥–∏–Ω –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –Ω–∞ –¥–Ω–∏ –æ–¥–Ω–æ–π –±–æ–ª—å—à–æ–π –∫–∞–º–ø–∞–Ω–∏–µ–π
- API –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤/–æ—à–∏–±–æ–∫/–∑–ª–æ–Ω–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- Throttling –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç DoS —á–µ—Ä–µ–∑ –º–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–π –∏–ª–∏ —Å–ø–∞–º —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–∏—Å—å–º–∞–º–∏

## 2. –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
1. `backend/mailer/migrations/0020_campaignqueue_consecutive_transient_errors.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è
2. `backend/mailer/throttle.py` ‚Äî helper –¥–ª—è throttling
3. `MAILER_ONCALL_PLAYBOOK.md` ‚Äî –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π playbook
4. `MAILER_ENTERPRISE_FINISHING_REPORT.md` ‚Äî —ç—Ç–æ—Ç –æ—Ç—á—ë—Ç

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `backend/mailer/constants.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `MAX_CAMPAIGN_RECIPIENTS`
2. `backend/mailer/views.py`:
   - –¥–æ–±–∞–≤–ª–µ–Ω throttling –Ω–∞ `campaign_start` –∏ `send_test_email`
   - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏ –≤ `campaign_start`
3. `backend/mailer/tasks.py`:
   - –¥–æ–±–∞–≤–ª–µ–Ω structured logging –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
   - –¥–æ–±–∞–≤–ª–µ–Ω structured logging –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–π
   - –¥–æ–±–∞–≤–ª–µ–Ω structured logging –¥–ª—è rate limit reserve
4. `backend/mailer/tests.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

## 3. –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä—É–∫–∞–º–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
cd backend
python manage.py migrate mailer
# –î–æ–ª–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
python manage.py shell
>>> from mailer.models import CampaignQueue
>>> q = CampaignQueue.objects.first()
>>> q.consecutive_transient_errors  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ throttling:
1. –ó–∞–π—Ç–∏ –≤ CRM –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä
2. –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é –∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ—ë 11 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
3. 11-–π –∑–∞–ø—É—Å–∫ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É: "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π (10 –∑–∞–ø—É—Å–∫–æ–≤ –≤ —á–∞—Å)"
4. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–∏—Å–µ–º: 6-–µ –ø–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏:
1. –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
2. –î–æ–±–∞–≤–∏—Ç—å >10000 –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (—á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
3. –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
4. –î–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –æ—à–∏–±–∫–∞: "–ö–∞–º–ø–∞–Ω–∏—è —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (X –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π). –ú–∞–∫—Å–∏–º—É–º: 10000"

### –ü—Ä–æ–≤–µ—Ä–∫–∞ structured logging:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Celery:
   ```bash
   docker logs celery_worker --tail 100 | grep "Email sent successfully"
   ```
3. –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ —Å –ø–æ–ª—è–º–∏: `campaign_id`, `recipient_id`, `provider`, `took_ms`
4. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ —Å `"Campaign finished"` –∏ –ø–æ–ª—è–º–∏ `totals`, `duration_seconds`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ playbook:
1. –û—Ç–∫—Ä—ã—Ç—å `MAILER_ONCALL_PLAYBOOK.md`
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ë—ã—Å—Ç—Ä—ã–π –¥–∏–∞–≥–Ω–æ–∑"
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç

## 4. –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø–æ –ª–æ–≥–∞–º

### –ú–µ—Ç—Ä–∏–∫–∏ –∏–∑ structured logs:

**emails_sent_per_hour:**
```python
# –§–∏–ª—å—Ç—Ä –ª–æ–≥–æ–≤: level=INFO, message="Email sent successfully"
# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ hour(created_at)
# COUNT(*) WHERE created_at >= NOW() - INTERVAL '1 hour'
```

**emails_failed_per_hour:**
```python
# –§–∏–ª—å—Ç—Ä –ª–æ–≥–æ–≤: level=ERROR, message —Å–æ–¥–µ—Ä–∂–∏—Ç "Failed to send email"
# COUNT(*) WHERE created_at >= NOW() - INTERVAL '1 hour'
```

**campaigns_finished_ok:**
```python
# –§–∏–ª—å—Ç—Ä –ª–æ–≥–æ–≤: level=INFO, message="Campaign finished", extra.finished_with_errors=false
# COUNT(*) WHERE created_at >= NOW() - INTERVAL '1 hour'
```

**campaigns_finished_with_errors:**
```python
# –§–∏–ª—å—Ç—Ä –ª–æ–≥–æ–≤: level=INFO, message="Campaign finished", extra.finished_with_errors=true
# COUNT(*) WHERE created_at >= NOW() - INTERVAL '1 hour'
```

**top_defer_reasons:**
```python
# –§–∏–ª—å—Ç—Ä –ª–æ–≥–æ–≤: level=INFO, message —Å–æ–¥–µ—Ä–∂–∏—Ç "Campaign deferred"
# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ extra.defer_reason
# COUNT(*) GROUP BY extra.defer_reason
```

**rate_limit_usage:**
```python
# –§–∏–ª—å—Ç—Ä –ª–æ–≥–æ–≤: level=DEBUG, message="Rate limit token reserve"
# extra.current_count –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
# –ú–æ–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
```

**–ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–µ–π –≤ –ª–æ–≥–∞—Ö:**
- `campaign_id` ‚Äî UUID –∫–∞–º–ø–∞–Ω–∏–∏
- `queue_id` ‚Äî UUID –∑–∞–ø–∏—Å–∏ –≤ –æ—á–µ—Ä–µ–¥–∏
- `recipient_id` ‚Äî UUID –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- `recipient_email` ‚Äî email –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
- `smtp_message_id` ‚Äî Message-ID –ø–∏—Å—å–º–∞ (–¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞)
- `provider` ‚Äî –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ (–æ–±—ã—á–Ω–æ "smtp_global")
- `took_ms` ‚Äî –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
- `rate_limit_count` ‚Äî —Ç–µ–∫—É—â–∏–π —Å—á—ë—Ç—á–∏–∫ rate limit
- `totals: {sent, failed, total}` ‚Äî –∏—Ç–æ–≥–∏ –∫–∞–º–ø–∞–Ω–∏–∏
- `duration_seconds` ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏
- `finished_with_errors` ‚Äî –±—ã–ª–∏ –ª–∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- `defer_reason` ‚Äî –ø—Ä–∏—á–∏–Ω–∞ –ø–∞—É–∑—ã
- `deferred_until` ‚Äî –∫–æ–≥–¥–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è
- `consecutive_errors` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫

## 5. üî• –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï –î–õ–Ø –ê–†–•–ò–¢–ï–ö–¢–û–†–ê

–ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å —Ä–∞—Å—Å—ã–ª–æ–∫ –¥–æ–≤–µ–¥—ë–Ω –¥–æ enterprise-—É—Ä–æ–≤–Ω—è. –ó–∞–∫—Ä—ã—Ç—ã –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è enterprise-gaps: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è circuit breaker, –∑–∞–≤–µ—Ä—à–µ–Ω–æ structured logging (—Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –ª–æ–≥–∞–º), —Å–æ–∑–¥–∞–Ω –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π playbook –¥–ª—è on-call –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç abuse (throttling –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ endpoints –∏ –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏). –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞–±–ª—é–¥–∞–µ–º–∞: –ø–æ –ª–æ–≥–∞–º –º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—É –ø–∞—É–∑—ã –∑–∞ 30 —Å–µ–∫—É–Ω–¥, —Å–æ–±—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ (emails_sent_per_hour, campaigns_finished, top_defer_reasons), –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª—ë—Ä—Ç—ã. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞: playbook —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –∏ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏, throttling –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç DoS –∏ —Å–ª—É—á–∞–π–Ω—ã–µ –º–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏ –∑–∞—â–∏—â–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∫–∞–∫ enterprise-CRM: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞, observability –Ω–∞ —É—Ä–æ–≤–Ω–µ, –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª—ë—Ä—Ç—ã –∏–∑ playbook –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å structured logs –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (ELK/Grafana Loki) –¥–ª—è –ø–æ–ª–Ω–æ–π observability.
