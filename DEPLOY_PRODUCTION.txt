=== Production: crm.groupprofi.ru (Docker + Nginx на хосте) ===

1) .env
   cp env.template .env
   Обязательно (entrypoint fail-fast): POSTGRES_PASSWORD, DJANGO_SECRET_KEY, POSTGRES_USER, POSTGRES_DB,
   PUBLIC_BASE_URL, MAILER_FERNET_KEY, DJANGO_ALLOWED_HOSTS, DJANGO_CSRF_TRUSTED_ORIGINS.

2) Каталоги и права (проект в /opt/proficrm или /opt/crm)
   sudo mkdir -p /opt/proficrm/data/staticfiles /opt/proficrm/data/media /opt/proficrm/backups
   sudo chown 1000:1000 /opt/proficrm/data/staticfiles /opt/proficrm/data/media
   В nginx/production.conf заменить /opt/crm на свой PROJECT_ROOT (например /opt/proficrm) в alias для /static/ и /media/.

3) Nginx
   - limit_req_zone в production.conf уже в начале файла.
   - Копировать nginx/production.conf в /etc/nginx/sites-available/crm.production
   - ln -s /etc/nginx/sites-available/crm.production /etc/nginx/sites-enabled/
   - Basic Auth для /admin/: sudo apt install apache2-utils && sudo htpasswd -c /etc/nginx/.htpasswd admin
   - Перед nginx -t: выполнить п.4 (HSTS) хотя бы один раз — создать snippet.
   - nginx -t && sudo systemctl reload nginx

4) HSTS (управляемое переключение SAFE/STRICT без правки конфига)
   Snippet /etc/nginx/snippets/proficrm-hsts.conf генерируется из nginx/snippets/hsts.conf.template.
   Перед первым reload nginx выполнить один раз:
     HSTS_HEADER="max-age=3600" ./scripts/nginx_hsts_apply.sh
   SAFE (по умолчанию):  HSTS_HEADER="max-age=3600" ./scripts/nginx_hsts_apply.sh
   STRICT (1 год + includeSubDomains, без preload):
     HSTS_HEADER="max-age=31536000; includeSubDomains" ./scripts/nginx_hsts_apply.sh
   Скрипт при STRICT выводит предупреждение: убедитесь, что все поддомены имеют HTTPS.
   Затем: sudo systemctl reload nginx

5) SSL (Let's Encrypt)
   sudo apt install certbot python3-certbot-nginx
   sudo certbot --nginx -d crm.groupprofi.ru

6) Деплой
   ./deploy_production.sh

7) Логи и ротация
   - docs/ops/logging.md: logrotate для nginx, max-size для docker (daemon.json: "log-opts": {"max-size":"10m","max-file":"3"}).

8) Бэкапы Postgres
   - docs/ops/backups.md. Скрипт: scripts/backup_postgres.sh. Каталог: /opt/proficrm/backups.
   - Systemd: config/systemd/proficrm-backup.service, proficrm-backup.timer. Fallback: cron.
   - Cron: 15 3 * * * cd /opt/proficrm && ./scripts/backup_postgres.sh >> /var/log/proficrm-backup.log 2>&1
   - Тест восстановления: ./scripts/restore_postgres_test.sh (раз в 1–2 нед., docs/ops/backups.md).

9) Мониторинг (опционально)
   - docs/ops/monitoring.md. scripts/health_check.sh. TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID в .env.
   - Cron: */5 * * * * cd /opt/proficrm && ./scripts/health_check.sh >> /var/log/proficrm-health.log 2>&1

10) Откат
   git log -1 --oneline  # сохранить коммит перед деплоем
   git checkout <prev_commit>
   docker compose -f docker-compose.prod.yml build --no-cache web celery celery-beat
   docker compose -f docker-compose.prod.yml run --rm web python manage.py migrate --noinput
   docker compose -f docker-compose.prod.yml run --rm web python manage.py collectstatic --noinput
   docker compose -f docker-compose.prod.yml up -d

11) Проверки (копипаст)
   ./scripts/smoke_check.sh
   # или по отдельности:

   docker compose -f docker-compose.prod.yml config

   docker compose -f docker-compose.prod.yml exec web id
   # ожидаем: uid=1000(crmuser) gid=1000(crmuser)

   curl -sI https://crm.groupprofi.ru | grep -i strict-transport-security
   # ожидаем: Strict-Transport-Security: max-age=3600 (или 31536000 при STRICT)

   # При пустом DJANGO_SECRET_KEY контейнер падает с ошибкой:
   docker compose -f docker-compose.prod.yml run --rm -e DJANGO_SECRET_KEY= web python -c "pass"
   # ожидаем: ERROR: DJANGO_SECRET_KEY is required and must not be empty. Set it in .env

   # celery/beat с cap_drop ALL:
   docker compose -f docker-compose.prod.yml ps -q celery | xargs -I{} docker inspect {} --format '{{.HostConfig.CapDrop}}'
   # ожидаем: [ALL] или [CAP_... CAP_... ...] (все сброшены = ALL)

   nginx -t
