# План Torture-тестирования CRM ПРОФИ Dialer

## Цель
Проверить устойчивость приложения в экстремальных условиях: отзыв разрешений, плохая сеть, dual SIM, OEM-ограничения, задержки CallLog, гонки.

## Режимы тестирования

### LOCAL_ONLY режим (по умолчанию)
- Телеметрия отправка в CRM **отключена**
- Проверяем: историю звонков, статусы, корреляцию CallLog, работу observer
- **НЕ проверяем:** отправку в CRM, синхронизацию с сервером

### FULL режим (когда включен)
- Телеметрия отправка в CRM **включена**
- Проверяем: всё из LOCAL_ONLY + отправку в CRM, синхронизацию статусов
- **Проверяем:** что статусы отправлены в CRM, что нет дублей на сервере

**ВАЖНО:** Большинство тестов работают в обоих режимах, но некоторые специфичны для FULL режима (помечены).

---

## 1. РАЗРЕШЕНИЯ И ANDROID RESTRICTIONS

### 1.1 Отзыв разрешений во время работы
- **Шаги:**
  1. Запустить приложение, выдать все разрешения
  2. Инициировать звонок (ручной или из CRM)
  3. Во время ожидания результата отозвать READ_CALL_LOG в настройках
  4. Проверить, что observer остановлен, UI обновлен, нет крашей
- **Ожидаемый результат:** Приложение корректно обрабатывает отзыв, показывает UNKNOWN с причиной "permission_revoked", observer остановлен

### 1.2 Запрет POST_NOTIFICATIONS (Android 13+)
- **Шаги:**
  1. Android 13+, выдать POST_NOTIFICATIONS
  2. Запустить сервис, проверить foreground notification
  3. Отозвать POST_NOTIFICATIONS в настройках
  4. Проверить, что сервис продолжает работать, но пользователь предупрежден
- **Ожидаемый результат:** Сервис работает, но статус показывает "NOTIFICATIONS_DISABLED"

### 1.3 Запрет READ_PHONE_STATE
- **Шаги:**
  1. Выдать READ_CALL_LOG, но запретить READ_PHONE_STATE
  2. Попытаться инициировать звонок
  3. Проверить статус готовности
- **Ожидаемый результат:** Статус "NEEDS_PERMISSIONS", звонок не может быть отслежен

### 1.4 Runtime permission revoke (Android 6+)
- **Шаги:**
  1. Запустить приложение с разрешениями
  2. Открыть настройки → Приложения → CRM ПРОФИ → Разрешения
  3. Отозвать READ_CALL_LOG
  4. Вернуться в приложение
- **Ожидаемый результат:** UI обновлен, статус показывает отсутствие разрешений, observer остановлен

---

## 2. CALLLOG DELAY И НЕСОВПАДЕНИЯ

### 2.1 Задержка CallLog 5+ секунд
- **Шаги:**
  1. Инициировать звонок
  2. Завершить звонок (ответ/нет ответа)
  3. Подождать 5-10 секунд
  4. Проверить, что результат определился через повторные проверки
- **Ожидаемый результат:** Результат определен через scheduleCallLogChecks с backoff (1s, 2s, 3s, 5s)

### 2.2 Два звонка на один номер подряд
- **Шаги:**
  1. Позвонить на номер +79001234567
  2. Сразу после завершения позвонить снова на +79001234567
  3. Проверить, что оба звонка корректно отслежены без дублей
- **Ожидаемый результат:** Два отдельных записи в истории с разными callRequestId, нет дублей

### 2.3 Звонок без ответа + занято + успех
- **Шаги:**
  1. Позвонить на номер, не отвечать (NO_ANSWER)
  2. Позвонить снова, получить занято (REJECTED)
  3. Позвонить третий раз, получить ответ (CONNECTED)
  4. Проверить историю
- **Ожидаемый результат (LOCAL_ONLY):** Три записи с корректными статусами в истории
- **Ожидаемый результат (FULL):** Три записи с корректными статусами, все отправлены в CRM (sentToCrm = true)

### 2.4 Race condition: команда пришла, звонок начался, CallLog пуст
- **Шаги:**
  1. Получить команду из CRM
  2. Сразу открыть звонилку и позвонить
  3. Проверить, что CallLog еще пуст
  4. Подождать 1-2 секунды
  5. Проверить, что результат определился
- **Ожидаемый результат:** Первая проверка не находит запись, вторая (через backoff) находит

---

## 3. DUAL SIM / DEFAULT DIALER

### 3.1 Dual SIM устройство
- **Шаги:**
  1. Устройство с двумя SIM картами
  2. Инициировать звонок (ручной или из CRM)
  3. Выбрать SIM1 или SIM2 при звонке
  4. Проверить историю, что subscriptionId сохранен (если доступно)
- **Ожидаемый результат:** Звонок отслежен, subscriptionId сохранен (best-effort)

### 3.2 Не default dialer
- **Шаги:**
  1. Убедиться, что приложение НЕ является default dialer
  2. Инициировать звонок
  3. Проверить, что звонок отслежен через CallLog
- **Ожидаемый результат:** Звонок отслежен, но могут быть ограничения на некоторые события

### 3.3 Диагностика dual SIM
- **Шаги:**
  1. Открыть Settings → Диагностика (long press на versionText в DEBUG)
  2. Проверить секцию "DUAL SIM / DEFAULT DIALER"
- **Ожидаемый результат:** Показано количество SIM, статус default dialer

---

## 4. OEM KILLERS / DOZE / BACKGROUND LIMITS

### 4.1 Xiaomi/MIUI
- **Шаги:**
  1. Устройство Xiaomi/MIUI
  2. Запустить приложение, выдать разрешения
  3. Настроить автозапуск и снять ограничения батареи (через инструкции в Settings)
  4. Выключить экран на 30 минут
  5. Отправить команду из CRM
  6. Проверить, что команда получена
- **Ожидаемый результат:** Команда получена, foreground notification видно

### 4.2 Huawei/Honor
- **Шаги:**
  1. Устройство Huawei/Honor
  2. Настроить защищенные приложения и автозапуск
  3. Выключить экран на 30 минут
  4. Отправить команду из CRM
- **Ожидаемый результат:** Команда получена, сервис работает

### 4.3 Samsung
- **Шаги:**
  1. Устройство Samsung
  2. Настроить "Не оптимизировать" и "Не ограничивать"
  3. Выключить экран на 30 минут
  4. Отправить команду из CRM
- **Ожидаемый результат:** Команда получена, сервис работает

### 4.4 Doze mode
- **Шаги:**
  1. Android 6+, выключить экран
  2. Подождать 1 час (вход в doze)
  3. Отправить команду из CRM
  4. Проверить, что команда получена (может быть задержка)
- **Ожидаемый результат:** Команда получена, возможно в SLOW режиме

---

## 5. NETWORK TORTURE

### 5.1 Airplane mode 3 раза подряд
- **Шаги:**
  1. Включить airplane mode
  2. Подождать 5 секунд
  3. Выключить airplane mode
  4. Повторить 3 раза
  5. Проверить, что нет лавины запросов, backoff ограничен
- **Ожидаемый результат:** При восстановлении сети - burst once, при потере - переход в SLOW, нет спама

### 5.2 Слабая сеть (симуляция)
- **Шаги:**
  1. Использовать Network Link Conditioner или эмулятор с медленной сетью
  2. Отправить команду из CRM
  3. Проверить, что команда получена (может быть задержка)
- **Ожидаемый результат:** Команда получена, backoff применяется при таймаутах

### 5.3 Captive portal / DNS issues
- **Шаги:**
  1. Подключиться к сети с captive portal (требует авторизации)
  2. Попытаться получить команду
  3. Проверить, что ошибки логируются корректно
- **Ожидаемый результат:** Ошибки логируются с типом (timeout, unknown host, SSL), backoff cap 15s

### 5.4 Частые обрывы сети
- **Шаги:**
  1. Быстро включать/выключать WiFi или мобильные данные (10 раз за минуту)
  2. Проверить, что нет ANR, нет лавины запросов
- **Ожидаемый результат:** Нет ANR, при восстановлении - burst once, при потере - SLOW

---

## 6. НАГРУЗОЧНОЕ ТЕСТИРОВАНИЕ

### 6.1 10 команд подряд из CRM
- **Шаги:**
  1. Отправить 10 команд из CRM с интервалом 1 секунда
  2. Проверить, что все команды получены
  3. Проверить, что все звонки отслежены
- **Ожидаемый результат:** Все команды получены, все звонки отслежены, нет дублей

### 6.2 Долгая работа (24 часа)
- **Шаги:**
  1. Запустить приложение
  2. Оставить работать 24 часа
  3. Проверить метрики (429 count, backoff, delivery latency)
- **Ожидаемый результат:** Нет утечек памяти, метрики стабильны, сервис работает

---

## 7. ANDROID VERSIONS

### 7.1 Android 10
- **Шаги:** Выполнить основные тесты на Android 10
- **Ожидаемый результат:** Все функции работают

### 7.2 Android 11
- **Шаги:** Выполнить основные тесты на Android 11
- **Ожидаемый результат:** Все функции работают

### 7.3 Android 12
- **Шаги:** Выполнить основные тесты на Android 12
- **Ожидаемый результат:** Все функции работают, foreground service работает

### 7.4 Android 13
- **Шаги:** Выполнить основные тесты на Android 13, проверить POST_NOTIFICATIONS
- **Ожидаемый результат:** Все функции работают, разрешение запрашивается корректно

### 7.5 Android 14
- **Шаги:** Выполнить основные тесты на Android 14, проверить фоновые ограничения
- **Ожидаемый результат:** Все функции работают, foreground service работает

---

## 8. ДИАГНОСТИКА И ЛОГИРОВАНИЕ

### 8.1 Export диагностического отчета
- **Шаги:**
  1. Открыть Settings
  2. Long press на versionText (DEBUG режим)
  3. Нажать "Копировать" или "Поделиться"
- **Ожидаемый результат:** Отчет сгенерирован, содержит все метрики и статусы

### 8.2 Проверка логов
- **Шаги:**
  1. Выполнить несколько тестов
  2. Открыть LogsActivity (если доступно)
  3. Проверить, что логи содержат диагностическую информацию
- **Ожидаемый результат:** Логи содержат метрики, статусы разрешений, ошибки сети

---

## 9. EDGE CASES

### 9.1 Звонок без завершения (приложение убито)
- **Шаги:**
  1. Инициировать звонок
  2. Убить приложение через настройки
  3. Завершить звонок
  4. Перезапустить приложение
- **Ожидаемый результат:** Звонок отслежен через CallLog при следующем запуске (если в окне времени)

### 9.2 Перезагрузка устройства
- **Шаги:**
  1. Запустить приложение
  2. Перезагрузить устройство
  3. Проверить, что сервис запустился автоматически
- **Ожидаемый результат:** Сервис запущен через BootCompletedReceiver

### 9.3 Низкий заряд батареи
- **Шаги:**
  1. Установить режим энергосбережения
  2. Проверить, что сервис продолжает работать
- **Ожидаемый результат:** Сервис работает, возможно в SLOW режиме

---

## 10. ИНТЕГРАЦИОННОЕ ТЕСТИРОВАНИЕ

### 10.1 Полный цикл: команда → звонок → результат → история → CRM
- **Шаги:**
  1. Отправить команду из CRM
  2. Получить команду в приложении
  3. Позвонить (ручной или автоматический)
  4. Завершить звонок
  5. Проверить историю
  6. Проверить отправку в CRM (если режим FULL)
- **Ожидаемый результат (LOCAL_ONLY):** Команда получена, звонок отслежен, история обновлена, статус корректный
- **Ожидаемый результат (FULL):** Всё из LOCAL_ONLY + статус отправлен в CRM (sentToCrm = true), нет дублей на сервере

### 10.2 Несколько пользователей на одном устройстве
- **Шаги:**
  1. Войти под пользователем A
  2. Выйти
  3. Войти под пользователем B
  4. Проверить, что история не смешана
- **Ожидаемый результат:** История разделена по пользователям (если реализовано)

---

## КРИТЕРИИ ПРИЕМКИ

✅ Приложение не падает при любых отказах разрешений
✅ Call result определяется устойчиво даже при задержках CallLog
✅ Нет дублей истории
✅ Dual SIM не ломает трекинг
✅ При плохой сети нет лавины, backoff ограничен
✅ Есть удобная диагностическая панель и export отчета
✅ Все тесты пройдены на Android 10-14

---

## ЗАМЕТКИ

- Все тесты должны выполняться на реальных устройствах (не эмуляторах) для проверки OEM-поведения
- Для тестов сети можно использовать Network Link Conditioner или эмулятор с настройками сети
- Для тестов разрешений использовать настройки Android, не ADB команды (реалистичнее)
- Логи должны быть доступны через LogsActivity или adb logcat
