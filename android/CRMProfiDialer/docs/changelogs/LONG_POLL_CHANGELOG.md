# Changelog: Long-Polling и Умный Backoff для PullCall

## Цель
Убрать частый polling (650мс) и длинные backoff (30-160 сек), сделать доставку команды "позвонить" максимально быстрой и стабильной БЕЗ пушей и БЕЗ обязательных изменений CRM-сервера.

## Основные изменения

### 1. Long-Polling для получения команд
- **Отдельный OkHttpClient** (`longPollHttpClient`) с увеличенными таймаутами:
  - `readTimeout`: 60 секунд (вместо 30)
  - `callTimeout`: 70 секунд
  - Используется ТОЛЬКО для pullCall запросов
- **Параметр `wait_seconds=25`** в URL для long-polling (если сервер поддерживает)
- **Автоматическое определение поддержки long-poll**: если ответ приходит быстро (< 1 сек), сервер не поддерживает long-poll, переключаемся на адаптивный polling

### 2. Single-Flight механизм
- Гарантируется, что одновременно существует только **один активный pullCall запрос**
- При перезапуске сервиса старый запрос корректно отменяется через `currentPullCallJob?.cancel()`
- Метрики отслеживают количество активных запросов

### 3. Умный Backoff ТОЛЬКО для pullCall
- **Отдельный класс `PullCallBackoff`** (вместо общего `RateLimitBackoff`)
- **Мягкая стратегия**: 1s → 2s → 4s → 8s → 15s (cap 15s) вместо 10s → 20s → 40s → 80s → 160s
- **Отдельные стратегии для разных ошибок**:
  - 429 (Rate Limit): мягкий backoff до 15s
  - Network Error: быстрый backoff до 15s
  - 5xx (Server Error): умеренный backoff до 20s
- **Jitter ±20%** для избежания thundering herd

### 4. Burst Window режим
- **Активируется автоматически** при:
  - Открытии приложения
  - Получении команды
  - Восстановлении сети
- **Длительность**: 60 секунд
- **Частота в burst**: каждые 2 секунды (вместо 650мс)
- **Частота вне burst**: 10 секунд (вместо 2-10 сек с адаптацией)
- **При 429**: немедленный выход из burst в slow режим

### 5. Адаптивный режим работы
- **LONG_POLL**: если сервер поддерживает long-poll (ответ > 1 сек), используем long-poll с таймаутом 25 сек
- **BURST**: активный период (60 сек после команды/открытия приложения) - каждые 2 сек
- **SLOW**: медленный режим (фон/idle) - каждые 10 сек
- **Автоматическое переключение** между режимами на основе:
  - Поддержки long-poll сервером
  - Наличия burst window
  - Ошибок (429, network, server)

### 6. Метрики и диагностика
- **Класс `PullCallMetrics`** для отслеживания:
  - Текущий режим (LONG_POLL / BURST / SLOW)
  - Причина деградации (RATE_LIMIT / NETWORK / SERVER_ERROR)
  - Время последней команды
  - Количество 429 за последний час
  - Latency последнего запроса
  - Количество активных запросов (single-flight)
- **Логирование** каждого цикла с режимом, задержкой и метриками
- **SettingsFragment** показывает режим получения команд в реальном времени

## Измененные файлы

### Новые файлы
1. `network/PullCallBackoff.kt` - умная стратегия backoff для pullCall
2. `network/PullCallMetrics.kt` - метрики для диагностики pullCall

### Измененные файлы
1. `network/ApiClient.kt`
   - Добавлен `longPollHttpClient` с увеличенными таймаутами
   - Метод `pullCall()` теперь принимает параметры `waitSeconds` и `useLongPoll`
   - `PullCallResult` теперь включает `latencyMs` для определения поддержки long-poll

2. `CallListenerService.kt`
   - Полностью переписан polling цикл с поддержкой long-polling
   - Добавлен single-flight механизм через `currentPullCallJob`
   - Реализован burst window режим
   - Интегрирован `PullCallBackoff` вместо общего `RateLimitBackoff` для pullCall
   - Добавлены метрики через `PullCallMetrics`
   - Улучшено логирование с режимами и метриками

3. `ui/settings/SettingsFragment.kt`
   - Добавлен `pullCallModeText` для отображения режима получения команд
   - Автоматическое обновление каждые 2 секунды
   - Показывает режим, причину деградации и время последней команды

4. `res/layout/fragment_settings.xml`
   - Добавлен `TextView` с `id="@+id/pullCallModeText"` для отображения режима pullCall

## Почему теперь быстрее

1. **Long-Polling**: вместо постоянных запросов каждые 650мс, клиент держит соединение открытым до 25 секунд. Если команда появилась - она приходит сразу. Если нет - сервер отвечает через 25 сек, и клиент сразу запускает следующий long-poll.

2. **Мягкий Backoff**: вместо "адских задержек" 30-160 секунд при 429, приложение продолжает пытаться каждые ≤15 секунд. Это означает, что даже в худшем случае команда придет максимум через 15 секунд после восстановления.

3. **Burst Window**: в активные периоды (после команды, открытия приложения) частота выше (2 сек), но не агрессивная (650мс), что избегает rate limit.

4. **Single-Flight**: гарантирует отсутствие лавины запросов - только один активный запрос одновременно.

5. **Адаптация**: автоматически определяет поддержку long-poll сервером и адаптируется. Если сервер не поддерживает - использует burst/slow режимы вместо постоянного спама.

## Критерии приемки

✅ Нет постоянного пулинга каждые ~650мс  
✅ При обычной сети команда "Позвонить" приходит быстро (0-2 сек, когда команда реально появилась)  
✅ При 429 приложение НЕ уходит в задержки 30-160 сек, а деградирует мягко (≤15 сек)  
✅ Нет лавины запросов: один активный запрос одновременно  
✅ Флоу звонков/истории/авторизации не сломан  
✅ Батарея лучше: количество запросов в минуту уменьшается кратно  

## Ручной тест-план

### 1. Тест быстрой доставки команды
- **Шаги**: Нажать "Позвонить" в CRM → измерить время до появления номера на телефоне
- **Ожидаемый результат**: Команда приходит в пределах 0-2 секунд (обычно сразу, если команда появилась во время long-poll цикла)

### 2. Тест восстановления сети
- **Шаги**: Включить airplane mode → подождать 10 сек → вернуть сеть → нажать "Позвонить" в CRM
- **Ожидаемый результат**: После восстановления сети команда приходит быстро (burst window активируется)

### 3. Тест rate limit (если возможно симулировать)
- **Шаги**: Симулировать 429 ответы → проверить поведение
- **Ожидаемый результат**: Приложение не "глохнет" на минуту, продолжает пытаться каждые ≤15 секунд

### 4. Тест фона/экран выключен
- **Шаги**: Выключить экран → подождать 1 минуту → нажать "Позвонить" в CRM
- **Ожидаемый результат**: Команда приходит (может быть небольшая задержка из-за slow режима, но не критично)

### 5. Проверка метрик в Settings
- **Шаги**: Открыть Settings → проверить "Режим получения команд"
- **Ожидаемый результат**: Показывает текущий режим (LONG_POLL / BURST / SLOW), причину деградации (если есть), время последней команды

## Важные замечания

1. **LOCAL_ONLY режим**: pullCall для получения команд работает как и раньше (это входящий канал). Отключена только отправка данных о звонках в CRM.

2. **Обратная совместимость**: Если сервер не поддерживает long-poll (отвечает мгновенно), приложение автоматически переключается на адаптивный polling с burst window.

3. **Батарея**: Количество запросов в минуту уменьшается кратно:
   - Раньше: ~92 запроса/мин (каждые 650мс)
   - Теперь (long-poll): ~2.4 запроса/мин (каждые 25 сек)
   - Теперь (burst): ~30 запросов/мин (каждые 2 сек, только в активные периоды)
   - Теперь (slow): ~6 запросов/мин (каждые 10 сек)

4. **Метрики**: Все метрики доступны через `PullCallMetrics` и логируются в каждом цикле для диагностики.
