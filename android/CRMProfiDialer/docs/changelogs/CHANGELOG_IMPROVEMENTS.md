# Changelog: Улучшения надежности и UI

## Дата: 2026-02-09

### 1. Надежность работы в фоне

#### CallListenerService: START_STICKY вместо START_NOT_STICKY
- **Изменено**: Сервис теперь всегда возвращает `START_STICKY` (кроме ACTION_STOP), чтобы ОС автоматически перезапускала его после убийства процесса
- **Файлы**: `CallListenerService.kt`
- **Обоснование**: Обеспечивает самовосстановление сервиса даже после агрессивного убийства процесса системой

#### Улучшенная кнопка "Разрешить работу в фоне"
- **Добавлено**: Диагностика открытия системных настроек батареи
- **Добавлено**: Fallback с инструкцией, если системный экран не открылся
- **Добавлено**: Проверка результата через 1 секунду для Android 12+
- **Файлы**: `MainActivity.kt`
- **Методы**: `openBatteryOptimizationSettings()`, `showBatteryOptimizationInstructions()`

### 2. Устойчивость токенов (2 недели без вылета)

#### Улучшенная обработка refresh token
- **Изменено**: `AuthInterceptor` больше не очищает токены при 401/403 - это делает только `refreshToken()` при реальном истечении
- **Добавлено**: Хранение времени последнего успешного refresh (`KEY_LAST_REFRESH_SUCCESS_AT`)
- **Добавлено**: Счетчик неудачных попыток refresh с backoff (`KEY_REFRESH_FAILURE_COUNT`)
- **Добавлено**: Проверка временных ошибок - если последний успех был недавно (< 1 часа), не очищаем токены
- **Файлы**: `TokenManager.kt`, `ApiClient.kt`, `AuthInterceptor.kt`
- **Методы**: `saveLastRefreshSuccessAt()`, `incrementRefreshFailureCount()`, `resetRefreshFailureCount()`, улучшенный `refreshToken()`

### 3. Быстрая обработка несостоявшихся звонков

#### Уменьшен таймаут для "команда получена, но звонка не было"
- **Изменено**: Таймаут для PENDING звонков уменьшен с 5 минут до 2.5 минут
- **Изменено**: Таймаут для RESOLVING звонков остался 5 минут
- **Добавлено**: Статус `NO_ACTION` для звонков, которые не были совершены
- **Добавлено**: Автоматическая отправка статуса в CRM при истечении таймаута
- **Файлы**: `PendingCallManager.kt`, `CallHistoryItem.kt`, `CallEventContract.kt`, `CallListenerService.kt`
- **Методы**: `cleanupExpiredPendingCalls()` - теперь различает PENDING и RESOLVING

#### Новый статус NO_ACTION
- **Добавлено**: `CallStatus.NO_ACTION` - "Звонок не совершен"
- **Добавлено**: `CallStatusApi.NO_ACTION` - маппинг в API значение "no_action"
- **Файлы**: `CallHistoryItem.kt`, `CallEventContract.kt`

### 4. Быстрая отправка результатов в CRM

#### Форсированная отправка телеметрии
- **Проверено**: `flushTelemetry()` уже вызывается после всех ключевых событий:
  - После получения команды на звонок
  - После резолва звонка (успешного и UNKNOWN)
  - После отправки статуса истекшего звонка
  - При 429 rate limiting
  - При выходе из аккаунта
- **Файлы**: `CallListenerService.kt`, `MainActivity.kt`

### 5. Новый UI: Bottom Navigation (в процессе)

#### Структура
- **Создано**: `HomeFragment.kt` - фрагмент главной вкладки
- **Планируется**: `DialerFragment.kt` - вкладка "Телефон" для ручного звонка
- **Планируется**: Обновление `MainActivity.kt` для использования Bottom Navigation
- **Планируется**: Фрагменты для "История", "Настройки"

#### Ручной звонок (планируется)
- **Планируется**: Фиксация события `manual_call_initiated` при ручном звонке из вкладки "Телефон"
- **Планируется**: Отслеживание результата ручного звонка и отправка в CRM/аналитику

## Файлы для изменений

### Измененные файлы:
1. `CallListenerService.kt` - START_STICKY, улучшенная обработка expired calls
2. `MainActivity.kt` - улучшенная кнопка батареи
3. `TokenManager.kt` - методы для отслеживания refresh token
4. `ApiClient.kt` - улучшенная логика refresh token с backoff
5. `AuthInterceptor.kt` - убрана очистка токенов при 401/403
6. `PendingCallManager.kt` - уменьшен таймаут для PENDING звонков
7. `CallHistoryItem.kt` - добавлен статус NO_ACTION
8. `CallEventContract.kt` - добавлен CallStatusApi.NO_ACTION

### Новые файлы:
1. `ui/home/HomeFragment.kt` - фрагмент главной вкладки (начало)

## Инструкция для ручного теста

1. **Тест надежности сервиса**:
   - Запустите приложение, убедитесь что сервис работает
   - Убейте процесс через настройки разработчика
   - Проверьте, что сервис автоматически перезапустился (через логи или статус в UI)

2. **Тест кнопки батареи**:
   - Откройте главный экран
   - Если показывается кнопка "Разрешить работу в фоне" - нажмите её
   - Убедитесь, что открывается системный экран настроек батареи
   - Если не открывается - должен появиться диалог с инструкцией

3. **Тест устойчивости токенов**:
   - Войдите в приложение
   - Отключите интернет на 5-10 минут
   - Включите интернет обратно
   - Убедитесь, что приложение не разлогинило (токены не очищены)
   - Проверьте логи - должны быть сообщения о временных ошибках, но не очистка токенов

4. **Тест быстрой обработки несостоявшихся звонков**:
   - Отправьте команду на звонок из CRM
   - НЕ звоните (не открывайте звонилку)
   - Подождите 2.5-3 минуты
   - Проверьте историю - должна появиться запись со статусом "Звонок не совершен" (NO_ACTION)
   - Проверьте, что статус отправлен в CRM

5. **Тест быстрой отправки результатов**:
   - Совершите звонок из приложения
   - Проверьте историю - результат должен появиться быстро (< 30 секунд)
   - Проверьте логи - должен быть вызов `flushTelemetry()` после резолва

## Ограничения и известные проблемы

1. **Bottom Navigation UI**: Создан только `HomeFragment`, остальные фрагменты и обновление MainActivity требуют доработки
2. **Ручной звонок**: Фиксация `manual_call_initiated` еще не реализована (требуется создание DialerFragment)
3. **Серверная поддержка NO_ACTION**: Сервер должен поддерживать статус "no_action" в API (проверить валидацию в `UpdateCallInfoSerializer`)
