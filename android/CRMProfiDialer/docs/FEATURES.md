# Функциональность и экраны CRMProfiDialer

Этот документ описывает основные фичи Android‑приложения CRMProfiDialer и то, как они связаны с CRM.

---

## Обзор

Приложение решает три основные задачи:

1. **Связь с клиентами по телефону**  
   - Приём команд на звонки из CRM.  
   - Инициация звонка через системный dialer.  
   - Определение результата и отправка его обратно в CRM.

2. **Удобная работа оператора**  
   - Главная панель со статусом «готовности».  
   - Ручной набор номера.  
   - История звонков с быстрыми действиями.

3. **Надёжность и поддержка**  
   - Диагностическая панель и отчёты.  
   - Инструкции по OEM/батарее.  
   - Telemetry и torture‑тесты.

---

## Логин и онбординг

### LoginActivity

**Что видит пользователь:**
- экраны ввода логина и пароля;
- кнопку входа;
- ссылку на вход по QR‑коду.

**Как работает:**
- при вводе логина/пароля вызывается `POST /api/token/`;
- при успехе сохраняются токены, происходит переход в `MainActivity`;
- при ошибке — понятное сообщение об ошибке авторизации.

### QRLoginActivity

**Что видит пользователь:**
- экран с камерой и рамкой сканирования QR.

**Как работает:**
- читает QR‑код, полученный из CRM‑веба;
- отправляет его на `POST /api/phone/qr/exchange/`;
- при успехе сохраняет токены и завершает логин, как в обычном сценарии.

### OnboardingActivity

**Что видит пользователь:**
- шаги с просьбой выдать разрешения:
  - доступ к журналу вызовов (`READ_CALL_LOG`),
  - доступ к телефону (`READ_PHONE_STATE`),
  - уведомления (`POST_NOTIFICATIONS` для Android 13+),
  - исключение из оптимизации батареи/фоновой работы;
- короткие пояснения «зачем нужно» каждое разрешение.

**Как работает:**
- проверяет наличие нужных разрешений;
- открывает системные экраны для их выдачи;
- после успешного прохождения онбординга открывает `MainActivity`.

---

## Главный экран (HomeFragment)

**Цель:** дать операторам и поддержке быстрый ответ на вопрос «клиент сейчас живой и готов принимать команды или нет».

**Элементы:**
- **Статус готовности**:
  - зелёный — сервис работает, соединение с сервером есть, разрешения в порядке;
  - жёлтый/красный — есть проблемы (нет прав, сеть, backoff, батарея);
  - подпись/подсказка, что именно не так и какую кнопку нажать, чтобы исправить.
- **Статистика за сегодня**:
  - общее количество звонков;
  - сколько успешных/без ответа/отклонённых/NO_ACTION;
  - skeleton‑плейсхолдер до первой загрузки (без навороченных анимаций).
- **Кнопка «Исправить»** при проблемах:
  - ведёт в соответствующий раздел настроек (разрешения, батарея и т.п.).

**Связь с CRM:**
- на этом экране в основном отображается агрегированная информация из локальной истории и метрик;
- по событиям (например, при длительном отсутствии команд) оператор может быстро открыть диагностику.

---

## Вкладка «Телефон» (DialerFragment)

**Цель:** позволить оператору совершать ручные звонки с учётом истории и аналитики CRM.

**Элементы UI:**
- поле ввода номера:
  - крупный шрифт (удобно считывать с экрана CRM),
  - автоформат в виде `+7 (XXX) XXX‑XX‑XX`;
- кнопка «Позвонить»;
- текст/подсказка о том, что звонок будет зафиксирован.

**Поведение:**
- при нажатии «Позвонить»:
  - создаётся запись в истории с `actionSource = MANUAL`;
  - создаётся `PendingCall`;
  - открывается системная звонилка с номером;
  - запускается отслеживание результата через CallLog.
- при отсутствии `READ_CALL_LOG`:
  - пользователь видит явное предупреждение, что результат нельзя определить;
  - статус звонка будет `UNKNOWN` с пометкой о причине;
  - в CRM (при FULL‑режиме) статус тоже отражает эту неопределённость.

**Связь с CRM:**
- результаты ручных звонков отправляются так же, как автоматические — через `/api/phone/calls/update/`;
- в payload всегда указан `action_source = "manual"`, чтобы аналитика могла различать типы звонков.

---

## Вкладка «История» (HistoryFragment)

**Цель:** единое место, где оператор и поддержка видят все звонки, связанные с этим устройством.

**Элементы UI:**
- список звонков (RecyclerView + ListAdapter + DiffUtil);
- строка поиска с иконкой и hint;
- пустое состояние с поясняющим текстом (когда ещё ничего не было);
- bottom‑sheet с деталями звонка (при тапе):
  - номер,
  - дата/время,
  - статус,
  - длительность,
  - источник (`CRM`, `Ручной` и т.п.).

**Возможности:**
- поиск по номеру;
- быстрые действия:
  - «Перезвонить» (открывает системный dialer);
  - «Скопировать номер».

**Связь с CRM:**
- список формируется на основе локального `CallHistoryStore`;
- каждый элемент в истории соответствует факту, который был (или будет) синхронизирован с CRM;
- флаги `actionSource` и `status` позволяют по журналу увидеть, как именно был совершен звонок.

---

## Вкладка «Настройки» (SettingsFragment)

**Цель:** собрать в одном месте всё, что влияет на стабильность работы приложения.

**Типичные блоки:**
- **Аккаунт**:
  - информация о текущем пользователе;
  - кнопка «Выйти» (через Bottom Navigation есть красная кнопка выхода);
  - при выходе вызывается `flushTelemetry()` и очищаются токены.

- **Разрешения и фоновая работа**:
  - статус CallLog‑разрешений;
  - кнопка «Разрешить работу в фоне» (открывает системные настройки батареи);
  - статус уведомлений (Android 13+).

- **OEM‑инструкции**:
  - кнопка «Инструкции для Xiaomi/Huawei/Samsung»;
  - диалог с шагами, как выключить агрессивные оптимизации.

- **Диагностика**:
  - блок с версией приложения;
  - **dev‑mode**:
    - debug: long‑press по версии открывает диагностику;
    - release: 7 тапов по версии → Toast «Dev mode enabled», затем long‑press → диагностика;
  - кнопки «Копировать» и «Поделиться» отчётом.

**Связь с CRM:**
- через этот экран можно быстро получить диагностический отчёт, который включает:
  - текущий режим работы (LONG_POLL/BURST/SLOW),
  - статистику 429 и backoff,
  - статус сети и разрешений,
  - последние диагностические события.
- отчёт пересылается в поддержку вместе с описанием проблемы.

Подробно — в `guides/DIAGNOSTICS_GUIDE.md`.

---

## Диагностическая панель и отчёты

Диагностика реализована как отдельный диалог, доступный из настроек.

**Содержимое отчёта (кратко):**
- информация о приложении и устройстве;
- статусы разрешений (CallLog, уведомления, foreground‑notification);
- режимы и метрики `pullCall`;
- состояние `CallLogObserver`;
- состояние сети и dual‑SIM/default dialer;
- активные звонки и агрегированная история;
- последние диагностические события (ring‑buffer).

Назначение:
- использовать при обращениях в поддержку;
- быстро локализовать проблемы OEM/сети/разрешений;
- понимать, где именно «ломается» доставка команд.

---

## Дополнительные возможности

### Torture‑тесты и планы

Для проверки надёжности и крайних кейсов есть документация:
- `plans/TORTURE_TEST_PLAN.md` — сценарии из серии «что будет, если…», включая:
  - многократные переключения airplane‑mode,
  - агрессивное убийство процесса,
  - отбор/возврат разрешений,
  - нестабильную сеть и лавину 429;
- `plans/PRE_PROD_CHECKLIST.md` — короткий чеклист перед продом.

### Push / FCM как ускоритель

Приложение готово к включению push‑ускорителя (FCM), но по умолчанию использует только long‑poll.
- флаг `ENABLE_FCM_ACCELERATOR` (см. `CONFIGURATION.md`) управляет включением;
- при настройке FCM push‑сообщения могут будить pullCall‑цикл и сокращать задержку доставки команд.

---

## Рекомендуемый сценарий использования документа

- **Разработчик UI**: смотреть разделы про конкретные фрагменты (Home/Dialer/History/Settings) и `UI_UX_REVOLUTION_REPORT.md`.
- **Back‑end / интегратор**: использовать этот файл вместе с `API_INTEGRATION.md`, чтобы понимать, какие действия в UI порождают какие запросы.
- **Поддержка**: опираться на этот обзор, когда по логам/отчётам нужно понять, где пользователь нажимал и что ожидал увидеть.

