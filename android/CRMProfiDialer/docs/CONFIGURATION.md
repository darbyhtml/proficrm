# Конфигурация и режимы работы CRMProfiDialer

Этот документ описывает:
- какие есть режимы работы приложения по отношению к CRM;
- какие feature‑флаги и настройки влияют на поведение;
- что важно учесть при настройке продакшена.

---

## Режимы отправки данных (TelemetryMode)

Приложение поддерживает, по сути, два основных режима:

- **LOCAL_ONLY**  
  - вся история звонков и метрики остаются только на устройстве;
  - запросы к серверу (обновление результатов, телеметрия) не выполняются;
  - используется для тестов, демо и случаев, когда CRM недоступна/не настроена.

- **FULL**  
  - результаты звонков и телеметрия отправляются в CRM;
  - используются все эндпойнты `/api/phone/*`;
  - это целевой режим для продакшена.

### Где это включается в коде

Режим задаётся прямо в коде в `app/src/main/java/ru/groupprofi/crmprofi/dialer/config/TelemetryMode.kt`:
- `AppFeatures.TELEMETRY_MODE = TelemetryMode.LOCAL_ONLY` — **по умолчанию** (данные не отправляются в CRM);
- чтобы включить CRM, нужно выставить: `TelemetryMode.FULL`.

Проверка «CRM включена?» делается через `AppFeatures.isCrmEnabled()` и используется в `ApiClient` (например, `sendCallUpdate()`, `sendHeartbeat()`, `sendTelemetryBatch()`, `flushTelemetry()`).

---

## Базовый URL и окружения

Базовый URL для Android‑клиента должен соответствовать окружению CRM:

- **Прод** (пример):  
  `https://crm.groupprofi.ru`

- **Stage/dev**: отдельные поддомены или внутренние адреса (например, `https://crm-dev.groupprofi.ru`).

Рекомендации:
- использовать `BuildConfig` или flavor‑зависимые константы для BASE_URL;
- не хардкодить продовый URL в debug‑сборках;
- для каждого окружения явно фиксировать:
  - URL,
  - API‑ключи/настройки (если есть),
  - режим Telemetry (`LOCAL_ONLY` vs `FULL`).

### Где это в коде

`ApiClient` берёт базовый URL из `BuildConfig.BASE_URL` (см. `ru.groupprofi.crmprofi.dialer.network.ApiClient.kt`).

---

## Feature‑флаги

### ENABLE_FCM_ACCELERATOR

Флаг, управляющий использованием Push/FCM как ускорителя доставки команд.

- **По умолчанию**: `false` — приложение работает только через long‑poll/adaptive polling.
- **При включении**:
  - добавляется обработка push‑сообщений типа «CALL_COMMAND_AVAILABLE»;
  - при получении push приложение будит `CallListenerService` и временно переходит в `BURST`‑режим для быстрого получения команды.

### Текущее значение в проекте

Флаг задаётся в `app/src/main/java/ru/groupprofi/crmprofi/dialer/config/TelemetryMode.kt` как:
- `AppFeatures.ENABLE_FCM_ACCELERATOR: Boolean = true/false`

На текущий момент в коде он **включён** (`true`). Если вы не хотите использовать push‑ускоритель — выставьте `false`.

**Важно:**
- включать/оставлять `true` стоит только если Firebase действительно настроен в проекте (SDK/`google-services.json`/манифест/серверный payload);
- даже при наличии push, основная доставка команд всё равно остаётся через `pullCall` (push — только ускоритель).

---

## Разрешения и фоновая работа

Без корректной конфигурации разрешений и фоновой работы приложение не сможет надёжно принимать команды и определять результаты.

### Критичные разрешения

- `READ_CALL_LOG` — доступ к журналу звонков:
  - требуется для определения факта и результата звонков (CONNECTED/NO_ANSWER/REJECTED и т.п.);
  - без него большинство звонков будет иметь статус `UNKNOWN`.

- `READ_PHONE_STATE` — доступ к состоянию телефона:
  - помогает корректно отслеживать активные звонки;
  - используется в диагностике/метриках.

- `POST_NOTIFICATIONS` (Android 13+):
  - требуется для показа foreground‑уведомления сервиса;
  - без него сервис может работать нестабильно (особенно на OEM‑устройствах).

### Фоновая работа и батарея

Для надёжной работы long‑poll сервиса:
- приложение должно быть **исключено** из агрессивной оптимизации батареи;
- для популярных OEM (Xiaomi/Huawei/Samsung и др.) есть отдельные инструкции (кнопка в `SettingsFragment`).

**Рекомендации:**
- во время онбординга и через настройки:
  - провести пользователя по выдаче разрешений;
  - открыть системный экран «Разрешить работу в фоне»;
  - показать OEM‑справку, если системный экран недоступен.

---

## Logging и диагностика

### Логи

- В debug‑сборках разрешено более подробное логирование (DEBUG/VERBOSE).
- В release:
  - шумные уровни логов отключены;
  - чувствительные данные (токены, номера телефонов, device_id) маскируются перед записью и отправкой.

Логи могут отправляться на сервер через `/api/phone/logs/` (см. `API_INTEGRATION.md`).

### Диагностические отчёты

- В debug: long‑press по версии в настройках → сразу открывается отчёт.
- В release: 7 тапов (активация dev‑mode) → long‑press по версии → отчёт.

Отчёт удобно прикладывать к любому тикету в поддержку; структура описана в `guides/DIAGNOSTICS_GUIDE.md`.

---

## Сборка и pre‑prod проверка

Перед выкатыванием новой версии в прод:

- использовать `plans/PRE_PROD_CHECKLIST.md` как **обязательный чеклист**:
  - сборка релизного APK (minify on/off);
  - проверка dev‑mode и диагностического отчёта в release;
  - проверка сценариев без ключевых разрешений;
  - проверка long‑poll и backoff‑поведения (включая airplane‑mode).

- по необходимости использовать `plans/TORTURE_TEST_PLAN.md`:
  - для глубоких сценариев нагрузки и edge‑кейсов;
  - особенно при изменениях в long‑poll, backoff или диагностике.

---

## Настройка продакшена: чеклист

Краткий список того, что должно быть выполнено для настоящего прод‑окружения:

- **CRM и API:**
  - выбран и зафиксирован продовый BASE_URL;
  - проверены все эндпойнты из `API_INTEGRATION.md` (auth, pull, update, heartbeat, telemetry, logs).

- **Режим работы:**
  - приложение собрано в режиме `FULL` (данные реально уходят в CRM);
  - при необходимости локального теста используется отдельная dev‑сборка с `LOCAL_ONLY`.

- **Разрешения и фон:**
  - сценарии выдачи разрешений проверены на целевых версиях Android;
  - проверена работа на популярных OEM (по torture‑плану).

- **Диагностика:**
  - dev‑mode и отчёт диагностики доступны в release;
  - техподдержка знает, где искать `DIAGNOSTICS_GUIDE.md` и как интерпретировать поля.

Подробный пошаговый чеклист — в `plans/PRE_PROD_CHECKLIST.md`.

