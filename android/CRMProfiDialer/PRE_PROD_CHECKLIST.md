# Pre-prod чеклист: «вопросов не осталось»

Короткий чеклист перед выкатом в прод. Все пункты — ручная проверка.

---

## 1. Release build smoke

**Перед запуском:** убедитесь, что `JAVA_HOME` указывает на корректный JDK (например, Android Studio → File → Project Structure → SDK, или установленный JDK 17).

| # | Проверка | Ожидание |
|---|----------|----------|
| 1.1 | Собрать release (minify on, если используете) | Сборка без ошибок |
| 1.2 | Собрать release с minify off (если есть отдельная конфигурация) | Сборка без ошибок |
| 1.3 | Dev mode (7 тапов по версии в Settings) работает только как задумано | 7 тапов → Toast "Dev mode enabled", затем long press → диагностика |
| 1.4 | В release не светится лишнего (нет debug-меню, логов в UI и т.п.) | Только 7-tap dev mode для диагностики |

---

## 2. Permissions UX

| # | Проверка | Ожидание |
|---|----------|----------|
| 2.1 | **Android 13+:** кейс без POST_NOTIFICATIONS | Сервис работает, статус/подсказка про уведомления, нет крашей |
| 2.2 | **Кейс без READ_CALL_LOG:** ручной звонок | Понятное предупреждение в UI («Результат не может быть определён — нет доступа к журналу вызовов») |
| 2.3 | Тот же кейс: запись в истории | Статус UNKNOWN с причиной (missing_calllog_permission / READ_CALL_LOG not granted) |

---

## 3. Idempotency + два звонка подряд

| # | Проверка | Ожидание |
|---|----------|----------|
| 3.1 | Два исходящих на один номер подряд в пределах 10–20 секунд | Две отдельные записи в истории, без дублей и без склейки в одну |
| 3.2 | То же на Xiaomi (если доступно) | Две записи, корректные статусы |
| 3.3 | То же на Samsung (если доступно) | Две записи, корректные статусы |

---

## 4. Long-poll sanity

| # | Проверка | Ожидание |
|---|----------|----------|
| 4.1 | 30 мин в фоне (экран выключен) + команда «позвонить» из CRM | Команда приходит, звонок инициируется/отслеживается |
| 4.2 | Airplane mode 3 раза подряд (вкл → выкл → вкл → выкл → вкл → выкл) | Нет лавины запросов, после восстановления сети — burst once, backoff не «ломается» |

---

## 5. Diagnostics report

| # | Проверка | Ожидание |
|---|----------|----------|
| 5.1 | Отчёт содержит **режим** (LONG_POLL / BURST / SLOW) | Секция «PULLCALL МЕТРИКИ» → текущий режим |
| 5.2 | Отчёт содержит **backoff** (уровень, время в backoff, 429) | Там же: maxBackoffReached, время в backoff, 429 за час |
| 5.3 | Отчёт содержит **last events** (ring-buffer) | Секция «ДИАГНОСТИЧЕСКИЕ СОБЫТИЯ (последние 20)» |
| 5.4 | Отчёт содержит **permissions** | Секция «РАЗРЕШЕНИЯ» (CallLog tracking, Foreground notification) |
| 5.5 | Отчёт содержит **сеть** | Секция «СЕТЬ» (статус, типы) |

**Как проверить:** Release build → 7 тапов по версии → long press → «Копировать» → вставить в заметки и пройтись по секциям выше.

---

## Как пройти чеклист (по шагам)

- **1.1–1.2**  
  В папке `android/CRMProfiDialer`:  
  `./gradlew assembleRelease` (Linux/macOS) или `gradlew.bat assembleRelease` (Windows).  
  При необходимости задайте `JAVA_HOME` на JDK 17. APK: `app/build/outputs/apk/release/`.

- **1.3–1.4**  
  Установить release APK → Настройки → 7 раз тапнуть по блоку «Версия: …» → Toast «Dev mode enabled» → длинный тап по версии → открывается диалог диагностики (Копировать / Поделиться). В release не должно быть отдельного debug-меню и логов в UI.

- **2.1**  
  На устройстве Android 13+ отозвать «Уведомления» для приложения → перезапустить приложение. Ожидание: сервис работает, в статусе/подсказке упоминаются уведомления, крашей нет.

- **2.2–2.3**  
  Отозвать «Журнал вызовов» в настройках приложения → Телефон → ввести номер → Позвонить. Ожидание: после старта звонка в UI текст «Результат не может быть определён — нет доступа к журналу вызовов». В Истории запись со статусом UNKNOWN и причиной (missing_calllog_permission / READ_CALL_LOG not granted).

- **3.1–3.3**  
  Два исходящих на один номер с интервалом 10–20 с. Ожидание: в Истории две отдельные записи, без дублей и без склейки в одну.

- **4.1**  
  Оставить приложение в фоне, экран выключен ~30 мин → из CRM отправить команду «позвонить». Ожидание: команда приходит, звонок инициируется и отслеживается.

- **4.2**  
  Включить/выключить режим полёта 3 раза подряд. Ожидание: нет лавины запросов, после восстановления сети — один burst, backoff ведёт себя корректно.

- **5.1–5.5**  
  Release → 7 тапов по версии → long press → в диалоге «Копировать» → вставить в заметки. Проверить наличие секций: PULLCALL МЕТРИКИ (режим, backoff), ДИАГНОСТИЧЕСКИЕ СОБЫТИЯ (последние 20), РАЗРЕШЕНИЯ, СЕТЬ.

---

## Итог

- Все пункты пройдены → можно считать готовым к прод по этому чеклисту.
- Если какой-то пункт не пройден — зафиксировать и поправить перед выкатом.

**Примечание:** FCM push для продакшена требует отдельной реализации (FcmMessagingServiceImpl + manifest + google-services.json); один флаг недостаточен — см. комментарии в `FcmMessagingService.kt`.
