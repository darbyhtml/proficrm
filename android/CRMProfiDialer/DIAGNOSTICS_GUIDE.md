# Руководство по диагностике CRM ПРОФИ Dialer

## Доступ к диагностической панели

### DEBUG режим
1. Откройте приложение
2. Перейдите в **Settings** (Настройки)
3. Найдите текст с версией приложения (внизу экрана)
4. **Long press** (долгое нажатие) на текст версии
5. Откроется диалог с диагностическим отчетом

### RELEASE режим (dev mode)
1. Откройте приложение
2. Перейдите в **Settings** (Настройки)
3. Найдите текст с версией приложения (внизу экрана)
4. **7 тапов** на текст версии (в течение 2 секунд)
5. Появится Toast "Dev mode enabled"
6. После этого: **Long press** на текст версии → откроется диагностика
7. Счетчик тапов сбрасывается через 2 секунды бездействия

**Примечание:** Dev mode включается только на текущей сессии. При перезапуске приложения нужно включить снова.

---

## Содержимое диагностического отчета

### 1. ПРИЛОЖЕНИЕ
- Версия приложения
- Build type (debug/release)
- Версия Android и SDK
- Производитель и модель устройства

### 2. РАЗРЕШЕНИЯ
- **CallLog tracking:** Статус разрешений для отслеживания звонков
  - OK: READ_CALL_LOG и READ_PHONE_STATE выданы
  - NOT OK: Показаны отсутствующие разрешения
- **Foreground notification:** Статус разрешений для уведомлений
  - OK: POST_NOTIFICATIONS выдано (Android 13+) и уведомления включены
  - NOT OK: Показаны отсутствующие разрешения или выключены уведомления

### 3. PULLCALL МЕТРИКИ
- **Текущий режим:** LONG_POLL / BURST / SLOW
- **Причина деградации:** NONE / RATE_LIMIT / NETWORK_ERROR / SERVER_ERROR
- **Последняя команда:** Время с момента получения последней команды
- **Средняя задержка pullCall:** Средняя задержка последних 20 запросов
- **Средняя задержка доставки:** Средняя задержка от создания команды до получения (если доступно)
- **429 за последний час:** Количество ошибок rate limit
- **Максимальный backoff достигнут:** Максимальный уровень backoff
- **Время в backoff:** Общее время, проведенное в режиме backoff

### 4. CALLLOG OBSERVER
- **Статус:** RUNNING / STOPPED
- **Причина остановки:** Если остановлен, показана причина (например, "READ_CALL_LOG не выдано")

### 5. СЕТЬ
- **Статус:** Доступна / Недоступна
- **Типы:** WiFi / Cellular / Ethernet (если доступно)

### 6. DUAL SIM / DEFAULT DIALER
- **Количество SIM:** Количество SIM-карт в устройстве
- **Dual SIM detected:** Да / Нет
- **Default dialer:** Является ли приложение default dialer

### 7. АКТИВНЫЕ ЗВОНКИ
- **Количество активных:** Количество ожидаемых звонков, которые еще не разрешены
- **Список:** Первые 5 активных звонков с ID, номером (маскированным) и статусом

### 8. ИСТОРИЯ ЗВОНКОВ
- **Всего звонков:** Общее количество звонков в истории
- **Сегодня:** Количество звонков за сегодня
- **По статусам:** Разбивка по статусам (CONNECTED, NO_ANSWER, REJECTED, UNKNOWN)

### 9. ДИАГНОСТИЧЕСКИЕ СОБЫТИЯ (последние 20)
Кольцевой буфер последних 50 событий; в отчёт попадают последние 20. События помогают восстановить «что происходило» перед проблемой (чёрный ящик).

**Типы событий:**
- **APP_OPENED** — приложение открыто (burst активирован)
- **SERVICE_STARTED** — сервис запущен в foreground
- **PULL_CALL_START** — начат запрос pullCall
- **PULL_CALL_RESPONSE** — ответ pullCall (code, latencyMs, mode)
- **PULL_CALL_MODE_CHANGED** — смена режима (LONG_POLL / BURST / SLOW) и причина
- **BACKOFF_ENTER** / **BACKOFF_EXIT** — вход/выход из backoff (429, сеть, сервер)
- **COMMAND_RECEIVED** — получена команда из CRM (source, hasCreatedAt, deliveryLatencyMs при наличии)
- **CALL_RESOLVE_START** — начат поиск результата по CallLog (source, callRequestId)
- **CALL_RESOLVED** — результат определён (status, durationSec, confidence: OBSERVER/RETRY или UNKNOWN)
- **PERMISSION_CHANGED** — изменение разрешений (например READ_CALL_LOG отсутствует/отозвано), не чаще 1 раза в 30 с при том же наборе
- **NETWORK_CHANGED** — сеть доступна/недоступна, не чаще 1 раза в 10 с при флаппинге
- **DIAGNOSTICS_EXPORTED** — отчёт скопирован или отправлен (action=copy/share)

**Безопасность данных:** в событиях нет полных номеров (только маска ***1234), нет токенов и PII. Номера маскируются намеренно.

**Если секция пустая:** значит диагностика открыта до запуска сервиса или до первых действий (pullCall, звонки). Запустите приложение, дождитесь работы сервиса (иконка в шторке), выполните действие (например ручной звонок или команду из CRM) и снова откройте отчёт.

### 10. АВТОРИЗАЦИЯ
- **Статус:** Авторизован / Не авторизован
- **Пользователь:** Имя пользователя (если авторизован)

---

## Использование отчета

### Копирование в буфер обмена
1. Нажмите кнопку **"Копировать"** в диалоге диагностики
2. Отчет будет скопирован в буфер обмена
3. Можете вставить в любое приложение (например, заметки или email)

### Поделиться отчетом
1. Нажмите кнопку **"Поделиться"** в диалоге диагностики
2. Выберите приложение для отправки (email, мессенджер, облако)
3. Отчет будет отправлен как текст

---

## Интерпретация результатов

### Проблемы с разрешениями
- **CallLog tracking: NOT OK** → Нужно выдать READ_CALL_LOG и READ_PHONE_STATE
- **Foreground notification: NOT OK** → Нужно выдать POST_NOTIFICATIONS (Android 13+) и включить уведомления

### Проблемы с сетью
- **Сеть: Недоступна** → Проверьте подключение к интернету
- **429 за последний час: > 0** → Сервер ограничивает запросы, backoff активен
- **Время в backoff: > 0** → Приложение находится в режиме backoff из-за ошибок

### Проблемы с CallLog
- **CallLog Observer: STOPPED** → Observer остановлен из-за отсутствия разрешений или ошибок
- **Последняя команда: > 60 секунд** → Команды не приходят, проверьте сеть и сервер

### Проблемы с производительностью
- **Средняя задержка доставки: > 5000мс** → Высокая задержка доставки команд, проверьте сеть
- **Максимальный backoff достигнут: > 0** → Достигнут максимальный backoff (15s), возможны проблемы с сервером

---

## Частые проблемы и решения

### "CallLog Observer: STOPPED"
**Причина:** Отсутствует разрешение READ_CALL_LOG или оно было отозвано
**Решение:** Выдать разрешение в настройках Android → Приложения → CRM ПРОФИ → Разрешения

### "429 за последний час: > 10"
**Причина:** Слишком много запросов к серверу, rate limit активен
**Решение:** Подождать, backoff автоматически уменьшится. Если проблема постоянна - проверить настройки сервера

### "Сеть: Недоступна"
**Причина:** Нет подключения к интернету
**Решение:** Проверить WiFi/мобильные данные, восстановить подключение

### "Последняя команда: не было"
**Причина:** Команды не приходят из CRM
**Решение:** Проверить подключение к серверу, авторизацию, настройки CRM

---

## Экспорт для поддержки

При обращении в поддержку:
1. Сгенерируйте диагностический отчет
2. Скопируйте его в буфер обмена или поделитесь
3. Отправьте в поддержку вместе с описанием проблемы
4. Укажите время возникновения проблемы и шаги для воспроизведения

---

## Дополнительная диагностика

### Логи приложения
- В DEBUG режиме логи доступны через LogsActivity (если доступно)
- Или через `adb logcat` с фильтром по тегу приложения

### Метрики PullCall
- Метрики обновляются в реальном времени в Settings → "Режим получения команд"
- В DEBUG режиме показываются дополнительные метрики (429 count, backoff time)

### OEM-специфичные проблемы
- Используйте кнопку "Инструкции для Xiaomi/Huawei/Samsung" в Settings
- Следуйте инструкциям для вашего производителя устройства

---

## Контакты поддержки

При возникновении проблем:
1. Соберите диагностический отчет
2. Опишите проблему и шаги для воспроизведения
3. Отправьте отчет и описание в поддержку
