# –ß–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ CRM

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —á–µ–∫–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ mailer.

## üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- [ ] SMTP –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≤–∫–ª—é—á–µ–Ω (`GlobalMailAccount.is_enabled = True`)
- [ ] Redis –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Celery worker –∑–∞–ø—É—â–µ–Ω
- [ ] Celery beat –∑–∞–ø—É—â–µ–Ω
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞
- [ ] –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–º–µ–Ω–µ–¥–∂–µ—Ä

---

## 1. –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–º–ø–∞–Ω–∏–π

### 1.1 –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏
- [ ] –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é —á–µ—Ä–µ–∑ UI
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –≤—Ä—É—á–Ω—É—é (3-5 –∞–¥—Ä–µ—Å–æ–≤)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (—Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π)
- [ ] –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É –∏ —Ç–µ–ª–æ –ø–∏—Å—å–º–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ –∫ –∫–∞–º–ø–∞–Ω–∏–∏
- [ ] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫

### 1.2 –°—Ç–∞—Ç—É—Å—ã –∫–∞–º–ø–∞–Ω–∏–∏
- [ ] –ö–∞–º–ø–∞–Ω–∏—è –≤ —Å—Ç–∞—Ç—É—Å–µ DRAFT –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- [ ] –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ READY —Å–æ–∑–¥–∞—ë—Ç—Å—è CampaignQueue
- [ ] –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ SENDING
- [ ] –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ SENT (–µ—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ) –∏–ª–∏ –æ—Å—Ç–∞—ë—Ç—Å—è SENDING (–µ—Å–ª–∏ –µ—Å—Ç—å failed)

---

## 2. Rate Limiting (100 –ø–∏—Å–µ–º/—á–∞—Å)

### 2.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —Å 101 –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–≤—ã–µ 100 –ø–∏—Å–µ–º –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ 101-–µ –ø–∏—Å—å–º–æ –æ—Ç–ª–æ–∂–µ–Ω–æ (defer_reason = "rate_per_hour")
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ deferred_until —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –Ω–∞—á–∞–ª–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞—Å–∞

### 2.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–∞
- [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –Ω–∞—á–∞–ª–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞—Å–∞ (–∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –≤ Redis –∫–ª—é—á–µ)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏–ª–∞—Å—å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT defer_reason, deferred_until, status 
FROM mailer_campaignqueue 
WHERE defer_reason = 'rate_per_hour';
```

**Redis –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
redis-cli GET "crm:mailer:rate:hour:$(date +%Y-%m-%d:%H)"
```

---

## 3. –ö–≤–æ—Ç–∞ (15000 –ø–∏—Å–µ–º/–º–µ—Å—è—Ü)

### 3.1 –ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –∫–≤–æ—Ç—ã
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `SmtpBzQuota.emails_available = 0` –≤ –ë–î
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –æ—Ç–ª–æ–∂–µ–Ω–∞ (defer_reason = "quota_exhausted")
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ deferred_until —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 3.2 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–≤–æ—Ç—ã
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `SmtpBzQuota.emails_available = 1000`
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `sync_smtp_bz_quota` task –≤—Ä—É—á–Ω—É—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏–ª–∞—Å—å

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT emails_available, last_synced_at, sync_error 
FROM mailer_smtpbzquota 
ORDER BY id DESC LIMIT 1;
```

---

## 4. –†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è (9:00-18:00 –ú–°–ö)

### 4.1 –í–Ω–µ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ 20:00 –ú–°–ö (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mock)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –æ—Ç–ª–æ–∂–µ–Ω–∞ (defer_reason = "outside_hours")
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ deferred_until —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 09:00 —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –ú–°–ö

### 4.2 –ü–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ –≥—Ä–∞–Ω–∏—Ü—É —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é –≤ 17:50 –ú–°–ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ 18:00 –∫–∞–º–ø–∞–Ω–∏—è –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –≤ 09:00 –∫–∞–º–ø–∞–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–¥–µ:**
```python
from mailer.tasks import _is_working_hours
from django.utils import timezone
from zoneinfo import ZoneInfo

msk_now = timezone.now().astimezone(ZoneInfo("Europe/Moscow"))
print(f"MSK time: {msk_now}, is_working: {_is_working_hours()}")
```

---

## 5. Throttling –Ω–∞ API endpoints

### 5.1 Throttling campaign_start (10/—á–∞—Å)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é 10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–≤—ã–µ 10 –∑–∞–ø—É—Å–∫–æ–≤ —É—Å–ø–µ—à–Ω—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ 11-–π –∑–∞–ø—É—Å–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –ª–∏–º–∏—Ç–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —á–µ—Ä–µ–∑ —á–∞—Å –º–æ–∂–Ω–æ —Å–Ω–æ–≤–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å

### 5.2 Throttling send_test_email (5/—á–∞—Å)
- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ 5 —Ä–∞–∑
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ 6-–µ –ø–∏—Å—å–º–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

### 5.3 Throttling –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis
- [ ] –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Redis: `docker stop redis` (–∏–ª–∏ `redis-cli SHUTDOWN`)
- [ ] –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis –æ–±—Ä–∞—Ç–Ω–æ

---

## 6. –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏ (MAX_CAMPAIGN_RECIPIENTS)

### 6.1 –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —Å >10000 –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å MAILER_MAX_CAMPAIGN_RECIPIENTS –Ω–∞ –º–µ–Ω—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∞)
- [ ] –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–ø—É—Å–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```python
from django.conf import settings
print(settings.MAILER_MAX_CAMPAIGN_RECIPIENTS)  # –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 10000
```

---

## 7. Circuit Breaker (transient errors)

### 7.1 –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ transient –æ—à–∏–±–æ–∫
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SMTP –Ω–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ö–æ—Å—Ç/–ø–æ—Ä—Ç (—á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å transient –æ—à–∏–±–∫–∏)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–≤—ã–µ 9 –æ—à–∏–±–æ–∫ –Ω–µ –ø–∞—É–∑–∏—Ä—É—é—Ç –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Å–ª–µ 10-–π –æ—à–∏–±–∫–∏ –∫–∞–º–ø–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—É–∑–∏—Ä—É–µ—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `consecutive_transient_errors >= 10` –≤ CampaignQueue

### 7.2 –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
- [ ] –ü–æ—Å–ª–µ transient –æ—à–∏–±–æ–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ `consecutive_transient_errors` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ 0

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT consecutive_transient_errors, status, defer_reason 
FROM mailer_campaignqueue 
WHERE consecutive_transient_errors > 0;
```

---

## 8. Defer Reasons (–ø—Ä–∏—á–∏–Ω—ã –æ—Ç–ª–æ–∂–µ–Ω–∏—è)

### 8.1 daily_limit
- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å >= `per_user_daily_limit` –ø–∏—Å–µ–º –∑–∞ –¥–µ–Ω—å
- [ ] –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –æ—Ç–ª–æ–∂–µ–Ω–∞ (defer_reason = "daily_limit")
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ deferred_until —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 09:00 —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –ú–°–ö

### 8.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö defer_reason
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤ UI (poll endpoint)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ deferred_until –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —á–µ—Ä–µ–∑ UI

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT defer_reason, COUNT(*) as count 
FROM mailer_campaignqueue 
WHERE defer_reason != '' 
GROUP BY defer_reason;
```

---

## 9. Race Conditions (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π)

### 9.1 –î–≤–∞ –≤–æ—Ä–∫–µ—Ä–∞
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–≤–∞ Celery worker –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–∂–¥–æ–µ –ø–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ—Ç –¥—É–±–ª–µ–π –≤ SendLog

### 9.2 –ì–ª–æ–±–∞–ª—å–Ω—ã–π lock
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ Redis –µ—Å—Ç—å –∫–ª—é—á `crm:mailer:send_pending_emails:lock`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ lock –∏–º–µ–µ—Ç TTL (600 —Å–µ–∫—É–Ω–¥)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–æ—Ä–∫–µ—Ä –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**Redis –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
redis-cli GET "crm:mailer:send_pending_emails:lock"
redis-cli TTL "crm:mailer:send_pending_emails:lock"
```

---

## 10. PII-Safe Logging

### 10.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Celery worker
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ INFO –ª–æ–≥–∞—Ö –ù–ï–¢ –ø–æ–ª–Ω–æ–≥–æ email
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –ø–æ–ª—è: `email_domain`, `email_masked`, `email_hash`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ ERROR –ª–æ–≥–∞—Ö —Ç–æ–ª—å–∫–æ masked email

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:**
```bash
docker logs celery_worker --tail 100 | grep "Email sent successfully"
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª—è: email_domain, email_masked, email_hash
# –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: recipient_email (–ø–æ–ª–Ω—ã–π)
```

---

## 11. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏

### 11.1 –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —Å 5 –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ SENT
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –≤ —Å—Ç–∞—Ç—É—Å–µ SENT
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–∑–¥–∞–Ω—ã –∑–∞–ø–∏—Å–∏ –≤ SendLog

### 11.2 –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–∞–º–∏
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —Å 5 –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏ (1 –Ω–µ–≤–µ—Ä–Ω—ã–π email)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ 4 –ø–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (SENT)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ 1 –ø–æ–ª—É—á–∞—Ç–µ–ª—å –≤ —Å—Ç–∞—Ç—É—Å–µ FAILED
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ SENDING (–Ω–µ SENT)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –µ—Å—Ç—å `finished_with_errors=true`

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT 
    c.id,
    c.status,
    COUNT(CASE WHEN r.status = 'sent' THEN 1 END) as sent,
    COUNT(CASE WHEN r.status = 'failed' THEN 1 END) as failed
FROM mailer_campaign c
LEFT JOIN mailer_campaignrecipient r ON r.campaign_id = c.id
WHERE c.id = '<campaign_id>'
GROUP BY c.id, c.status;
```

---

## 12. Test Email –æ—Ç–ø—Ä–∞–≤–∫–∞

### 12.1 –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∏—Å—å–º–∞
- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ —á–µ—Ä–µ–∑ UI
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–∏—Å—å–º–æ –ø—Ä–∏—à–ª–æ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –≤ SendLog
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è rate limiter (—É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –ª–∏–º–∏—Ç–µ 100/—á–∞—Å)

### 12.2 Throttling —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–∏—Å–µ–º
- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å 5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–∏—Å–µ–º
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ 6-–µ –ø–∏—Å—å–º–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

---

## 13. Unsubscribe (–æ—Ç–ø–∏—Å–∫–∞)

### 13.1 –û—Ç–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É
- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ —Å unsubscribe —Å—Å—ã–ª–∫–æ–π
- [ ] –ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ –æ—Ç–ø–∏—Å–∫–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É Unsubscribe
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Ä–∞—Å—Å—ã–ª–∫–µ —ç—Ç–æ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

### 13.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø–∏—Å–∫–∏ –≤ –Ω–æ–≤–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
- [ ] –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–Ω–µ–µ –æ—Ç–ø–∏—Å–∞–ª—Å—è
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—Ç–ø–∏—Å–∞–≤—à–∏–π—Å—è –ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—â–µ–Ω (—Å—Ç–∞—Ç—É—Å UNSUBSCRIBED)

**SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT email, source, created_at 
FROM mailer_unsubscribe 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## 14. Structured Logging

### 14.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ structured logs
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ structured –ø–æ–ª–µ–π:
  - `campaign_id`
  - `queue_id`
  - `recipient_id`
  - `email_domain`, `email_masked`, `email_hash`
  - `smtp_message_id`
  - `provider`
  - `took_ms`
  - `rate_limit_count`

### 14.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ JSON formatter (–≤ production)
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `DEBUG=False`
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ª–æ–≥–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ extra –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

---

## 15. Celery Tasks

### 15.1 send_pending_emails
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ task –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (celery beat)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ beat –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ task –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏

### 15.2 sync_smtp_bz_quota
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ task –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–≤–æ—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å smtp.bz API
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `last_synced_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

### 15.3 reconcile_campaign_queue
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ task –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–≤–∏—Å—à–∏–µ PROCESSING –∫–∞–º–ø–∞–Ω–∏–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ stuck campaigns

**–ü—Ä–æ–≤–µ—Ä–∫–∞ Celery beat:**
```bash
docker logs celery_beat --tail 100 | grep "beat:"
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ –≤—Å–µ—Ö –∑–∞–¥–∞—á
```

---

## 16. Edge Cases

### 16.1 –ü—É—Å—Ç–∞—è –∫–∞–º–ø–∞–Ω–∏—è
- [ ] –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é –±–µ–∑ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ "–ù–µ—Ç –ø–∏—Å–µ–º –≤ –æ—á–µ—Ä–µ–¥–∏"

### 16.2 –ö–∞–º–ø–∞–Ω–∏—è —Å –Ω–µ–≤–µ—Ä–Ω—ã–º–∏ email
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —Å –Ω–µ–≤–µ—Ä–Ω—ã–º–∏ email –∞–¥—Ä–µ—Å–∞–º–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ–≤–µ—Ä–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ FAILED
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è

### 16.3 SMTP –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π SMTP host/port
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ FAILED
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

### 16.4 Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Redis
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ rate limiter –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fail-open (—Ä–∞–∑—Ä–µ—à–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ throttle –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fail-closed (–±–ª–æ–∫–∏—Ä—É–µ—Ç API)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ Redis

---

## 17. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 17.1 –ë–æ–ª—å—à–∞—è –∫–∞–º–ø–∞–Ω–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —Å 1000 –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –ø–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—É–º–Ω—ã–º)

### 17.2 –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–º–ø–∞–Ω–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å 3 –∫–∞–º–ø–∞–Ω–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–æ–¥–Ω–∞ –∑–∞ –¥—Ä—É–≥–æ–π)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

---

## 18. UI/UX –ø—Ä–æ–≤–µ—Ä–∫–∏

### 18.1 Poll endpoint (–ø—Ä–æ–≥—Ä–µ—Å—Å)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å poll endpoint –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
  - `active_campaign` (—Ç–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞–º–ø–∞–Ω–∏—è)
  - `queued_count` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –æ—á–µ—Ä–µ–¥–∏)
  - `next_campaign_at` (–∫–æ–≥–¥–∞ –Ω–∞—á–Ω—ë—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è)
  - `reason_code` (–ø—Ä–∏—á–∏–Ω–∞ –ø–∞—É–∑—ã, –µ—Å–ª–∏ –µ—Å—Ç—å)
  - `next_run_at` (–∫–æ–≥–¥–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è)

### 18.2 –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –ø–æ–Ω—è—Ç–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

---

## 19. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 19.1 –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –ü—Ä–∏ –æ—Ç–ª–æ–∂–µ–Ω–∏–∏ –∫–∞–º–ø–∞–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ—Ç –¥—É–±–ª–µ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

### 19.2 Audit log
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è —Å –∫–∞–º–ø–∞–Ω–∏—è–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ audit
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/–∑–∞–ø—É—Å–∫ –∫–∞–º–ø–∞–Ω–∏–π —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è

---

## 20. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å

### 20.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ .env
- [ ] –ò–∑–º–µ–Ω–∏—Ç—å `MAILER_MAX_CAMPAIGN_RECIPIENTS` –≤ .env
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Django/Celery
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

- [ ] –ò–∑–º–µ–Ω–∏—Ç—å `MAILER_THROTTLE_CAMPAIGN_START_PER_HOUR` –≤ .env
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Django/Celery
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
```python
from django.conf import settings
print(settings.MAILER_MAX_CAMPAIGN_RECIPIENTS)
print(settings.MAILER_THROTTLE_CAMPAIGN_START_PER_HOUR)
```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- [ ] –ù–µ—Ç –∑–∞–≤–∏—Å—à–∏—Ö –∫–∞–º–ø–∞–Ω–∏–π –≤ PROCESSING
- [ ] –í—Å–µ –ª–∏–º–∏—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í—Å–µ defer reasons –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] PII-safe logging —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Structured logging —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Throttling —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Circuit breaker —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Race conditions –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã

---

## üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### SQL –∑–∞–ø—Ä–æ—Å—ã:
```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏
SELECT c.id, c.name, c.status, q.status, q.defer_reason, q.deferred_until
FROM mailer_campaign c
LEFT JOIN mailer_campaignqueue q ON q.campaign_id = c.id
WHERE c.status IN ('ready', 'sending');

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–æ–∫
SELECT status, COUNT(*) 
FROM mailer_sendlog 
WHERE created_at >= CURRENT_DATE 
GROUP BY status;

-- –ó–∞–≤–∏—Å—à–∏–µ PROCESSING
SELECT id, campaign_id, started_at, 
       EXTRACT(EPOCH FROM (NOW() - started_at))/60 as minutes_stuck
FROM mailer_campaignqueue
WHERE status = 'processing' 
  AND started_at < NOW() - INTERVAL '30 minutes';
```

### Redis –∫–æ–º–∞–Ω–¥—ã:
```bash
# Rate limiter
redis-cli GET "crm:mailer:rate:hour:$(date +%Y-%m-%d:%H)"

# Lock
redis-cli GET "crm:mailer:send_pending_emails:lock"

# Throttle
redis-cli GET "crm:mailer:throttle:campaign_start:user:1"
```

### Celery –∫–æ–º–∞–Ω–¥—ã:
```bash
# –°—Ç–∞—Ç—É—Å –≤–æ—Ä–∫–µ—Ä–æ–≤
celery -A crm inspect active

# Scheduled tasks
celery -A crm inspect scheduled

# –õ–æ–≥–∏
docker logs celery_worker --tail 100
docker logs celery_beat --tail 100
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production-–ø–æ–¥–æ–±–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ staging –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º SMTP
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:** –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö:** –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ –æ—á–∏—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
4. **–í—Ä–µ–º—è:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç –æ–∂–∏–¥–∞–Ω–∏—è (–≥—Ä–∞–Ω–∏—Ü—ã —á–∞—Å–æ–≤, –¥–Ω–µ–π)
5. **Redis/Celery:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
