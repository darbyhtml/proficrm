# Messenger (встроенный чат/виджет) — обзор и локальная разработка

Этот модуль реализует внутренний «мессенджер» CRM (операторская панель диалогов и веб-виджет).

## Feature-флаг

- Включение/выключение через переменную окружения `MESSENGER_ENABLED` (по умолчанию выключен):
  - `MESSENGER_ENABLED=1` — функциональность включена;
  - `MESSENGER_ENABLED=0` — API/UI/виджет отвечают `404` / `{"detail": "Messenger disabled"}`, но маршруты остаются зарегистрированными.
- Проверка флага централизована в `messenger/utils.py` (`ensure_messenger_enabled_api`, `ensure_messenger_enabled_view`).

## База данных и миграции (важно)

Весь проект CRM рассчитан на работу с PostgreSQL. Некоторые старые миграции (`accounts`, `companies`)
используют PostgreSQL-специфичный SQL и **не поддерживаются под SQLite**.

**Рекомендации для разработки и тестов messenger:**  

- Использовать только PostgreSQL через Docker Compose:
  - `docker compose up -d db redis web` (или соответствующую команду из корневого README проекта);
  - выполнять миграции и тесты внутри контейнера `web`.
- Не запускать `python manage.py migrate`/`pytest` на SQLite — часть миграций может падать с ошибками
  вида `sqlite3.OperationalError: near "INDEX": syntax error`, что не отражает состояние боевой БД.

Все миграции приложения `messenger` совместимы с PostgreSQL и интегрируются в общий пайплайн миграций проекта.

## Inbox.branch и глобальный inbox

- При создании `Inbox` филиал (`branch`) задаётся один раз и **не может быть изменён** позже.
- **Глобальный inbox**: поле `branch` может быть пустым (null). Тогда это «общий» виджет: филиал диалога определяется по GeoIP (регион клиента по IP) и правилам маршрутизации (`RoutingRule`). Если правило не найдено, используется филиал по умолчанию (`MESSENGER_DEFAULT_BRANCH_ID` в настройках).
- Для inbox с филиалом: `Conversation.branch` всегда совпадает с `inbox.branch`. Для глобального inbox: `Conversation.branch` задаётся при создании из маршрутизации и не меняется.
- `inbox` у диалога неизменяем после создания.

## GeoIP

- В bootstrap виджета регион клиента может определяться по IP (см. `messenger/geoip.py`). По умолчанию используется бесплатный API ip-api.com (лимит 45 запросов/мин). Включение/выключение: `MESSENGER_GEOIP_ENABLED=0` или `1`.
- Сопоставление с справочником `companies.Region` по полю `name`. Для маппинга английских названий (ip-api.com) на русские в справочнике можно задать `MESSENGER_GEOIP_REGION_MAPPING` в settings (словарь `{"Sverdlovskaya Oblast": "Свердловская область", ...}`).

## Рабочие часы

- В настройках Inbox (форма редактирования) можно включить «Учитывать рабочие часы» и задать расписание по дням недели (1=пн … 7=вс) и часовой пояс.
- При включённой проверке автоназначение диалога оператору выполняется только в указанные часы; вне расписания диалог создаётся без назначения.
- В ответе bootstrap виджета возвращаются поля `outside_working_hours` и `working_hours_message` (по умолчанию «Мы ответим в рабочее время»); текст сообщения задаётся через `MESSENGER_OUTSIDE_WORKING_HOURS_MESSAGE` в settings или env.

## Статус оператора

- У оператора есть статус в `AgentProfile`: онлайн, отошёл, занят, офлайн.
- Автоназначение (round-robin) учитывает только операторов со статусом «онлайн» (пользователи без профиля считаются онлайн для совместимости).
- Сменить статус можно на странице списка диалогов («Мой статус» → выбор и автоотправка формы на `POST /messenger/me/status/`).

## Равномерное распределение и эскалация

- **Распределение**: при автоназначении список кандидатов сортируется по нагрузке (число открытых/ожидающих диалогов у оператора), затем применяется round-robin по этому списку.
- **Эскалация по таймауту (4 мин)**: если назначенный оператор не открыл диалог в течение `MESSENGER_ESCALATION_TIMEOUT_SECONDS` (по умолчанию 240 с), диалог переназначается следующему оператору филиала. Момент «открыл» фиксируется при первом заходе оператора на страницу диалога (`assignee_opened_at`).
- Запуск эскалации по cron: `python manage.py escalate_messenger_conversations` (рекомендуется каждую минуту). Опции: `--timeout N`, `--dry-run`.

## Политика хранения (retention)

- Автозакрытие старых диалогов: `python manage.py close_old_messenger_conversations`
  - По умолчанию переводит диалоги `RESOLVED → CLOSED`, если с последнего сообщения прошло больше `MESSENGER_RETENTION_RESOLVED_TO_CLOSED_DAYS` (по умолчанию 90 дней).
  - Опции: `--days N`, `--dry-run`, `--limit N`.

## GDPR: экспорт и анонимизация

- Экспорт данных контакта (контакт → диалоги → сообщения → метаданные вложений):
  - `python manage.py export_messenger_contact_data --contact-id <uuid> [--pretty]`
- Анонимизация контакта (очистка PII в Contact) и опционально редактирование сообщений/вложений:
  - `python manage.py anonymize_messenger_contact --contact-id <uuid> [--dry-run] [--redact-messages] [--delete-attachments]`
  - `--redact-messages`: заменяет body у входящих сообщений контакта на `[redacted]`
  - `--delete-attachments`: удаляет вложения (и файлы) у входящих сообщений контакта

## Передача на другой филиал

- Доступно только для диалогов **глобального inbox** (inbox без привязки к филиалу).
- **Первому свободному в филиале X**: на странице диалога блок «Передать в филиал» — выбор филиала и кнопка «Первому свободному»; диалог переводится в выбранный филиал и назначается по round-robin с учётом нагрузки.
- **Ручной выбор оператора**: в выпадающем списке «Оператор» для глобального inbox админ видит операторов всех филиалов; при выборе оператора из другого филиала филиал диалога автоматически меняется на филиал выбранного оператора.

## Непрочитанные и badge

- Для оператора: в диалоге хранится `assignee_last_read_at` — время последнего просмотра. При открытии страницы диалога оно обновляется. Непрочитанные = входящие (IN) сообщения с `created_at > assignee_last_read_at` (или все входящие, если поле пусто).
- В меню «Диалоги» отображается badge с суммарным числом непрочитанных по всем диалогам, где пользователь назначен оператором (context processor `messenger_globals`).
- В списке диалогов у каждой строки, где текущий пользователь — назначенный оператор, показывается счётчик непрочитанных.

## Доставлено/прочитано (виджет)

- У сообщения (Message) поле `read_at` — для исходящих (OUT): когда контакт увидел сообщение в виджете.
- В ответах poll и bootstrap в каждое сообщение добавлено поле `read_at` (ISO datetime или null).
- Эндпоинт `POST /api/widget/mark_read/`: тело `widget_token`, `widget_session_token` и `last_message_id` (отметить все OUT с id ≤ этого) или `message_ids` (список id). Виджет вызывает его при отображении сообщений контакту.

## Индикатор «печатает»

- Состояние хранится в Redis с TTL 8 с: `messenger:typing:{conversation_id}:operator`, `messenger:typing:{conversation_id}:contact`.
- **Виджет**: POST `/api/widget/typing/` (widget_token, widget_session_token) — контакт печатает; в ответе poll возвращается `operator_typing`. В виджете отображается «Оператор печатает...», при вводе в поле отправляется сигнал печати (debounce 400 мс).
- **Панель оператора**: GET/POST `/api/messenger/conversations/<id>/typing/` — GET возвращает `{ operator_typing, contact_typing }`, POST отмечает «оператор печатает». На странице диалога: опрос GET каждые 2,5 с для отображения «Клиент печатает», при вводе в поле — POST (debounce 300 мс).

## Офлайн-режим

- В настройках Inbox (блок «Офлайн-режим») можно включить показ настраиваемого сообщения, когда операторов нет или вне рабочих часов.
- В ответе bootstrap при включённой настройке возвращаются `offline_mode` (true, если нет операторов или вне рабочих часов) и `offline_message`. Виджет показывает баннер с этим текстом; отправка сообщений по-прежнему возможна — заявка сохраняется в диалог.

## Вложения

- В настройках Inbox (блок «Вложения») можно включить/выключить вложения в виджете и задать макс. размер файла (МБ). По умолчанию разрешены: изображения (JPEG, PNG, GIF, WebP) и PDF.
- **Виджет**: POST `/api/widget/send/` принимает `multipart/form-data`: `body` (опционально при наличии файлов), `widget_token`, `widget_session_token`, `files` (или `file`). В ответах bootstrap и poll у каждого сообщения есть массив `attachments` с полями `id`, `url`, `original_name`, `content_type`, `size`. Скачивание: GET `/api/widget/attachment/<id>/?widget_token=...&widget_session_token=...`.
- В виджете: кнопка «Прикрепить», вставка из буфера (Ctrl+V) для картинок, отображение вложений (превью изображений, ссылки на файлы).
- **Оператор**: на странице диалога форма отправки с полем «Прикрепить файл»; можно отправить сообщение только с вложениями.

## Оценка диалога

- После закрытия/решения диалога виджет может запросить оценку (звёзды 1–5 или NPS 0–10). В настройках Inbox (блок «Оценка диалога») включается опция и выбирается тип.
- В ответе poll возвращаются `rating_requested`, `rating_type`, `rating_max_score`, если диалог закрыт, ещё не оценён и в inbox включена оценка. Виджет показывает блок с кнопками (звёзды или 0–10) и опциональным полем комментария.
- POST `/api/widget/rate/`: тело `widget_token`, `widget_session_token`, `score`, опционально `comment`. Оценка сохраняется в полях Conversation: `rating_score`, `rating_comment`, `rated_at`. В карточке диалога оператора отображаются оценка и комментарий.

## Widget session token (безопасность публичного API)

Для публичных эндпоинтов виджета (`/api/widget/bootstrap/`, `/api/widget/send/`, `/api/widget/poll/`)
используется отдельный `widget_session_token`:

- `/api/widget/bootstrap/`:
  - принимает `widget_token` (из `Inbox.widget_token`) и данные посетителя;
  - создаёт/находит `Contact` и `Conversation`;
  - генерирует `widget_session_token` через `create_widget_session(...)` (`messenger/utils.py`) и возвращает его в ответе.
- `/api/widget/send/` и `/api/widget/poll/`:
  - требуют одновременную передачу `widget_token` и `widget_session_token`;
  - валидируют токен через `get_widget_session(...)` и используют сохранённый контекст (inbox_id, conversation_id, contact_id).

Дополнительно публичный API виджета должен реализовывать:

- отдельные throttles (rate limit по IP и по inbox/widget_token);
- honeypot-поле в форме отправки;
- ограничение длины текста сообщения (валидация на уровне serializer/view).

Реализация эндпоинтов виджета и throttle-классов выполняется на отдельном этапе (см. план внедрения messenger).

## Cache/Redis для widget_session_token

Widget session-токены (`widget_session_token`) хранятся через стандартный Django cache (`django.core.cache`).

- В `crm/settings.py` настроено:
  - при `DEBUG=0` и наличии `REDIS_URL` используется `django_redis.cache.RedisCache` (подходит для staging/production);
  - иначе — `LocMemCache` (только для локальной разработки).
- Для production/staging **обязательно** задать `REDIS_URL` и включить Redis-кеш (через docker-compose), чтобы:
  - widget-сессии были общими для всех процессов/контейнеров;
  - не было рассинхронизации и неожиданного истечения сессий при перезапуске воркеров.

Если Redis/кеш временно недоступен, widget-сессии и anti-spam CAPTCHA могут временно храниться в **in-memory fallback** текущего процесса (деградация сервиса: сессии не шарятся между воркерами).

Использование `LocMemCache` допустимо только в локальной разработке.

---

## Production: как включить и проверить

### Как включить

1. В окружении (env / docker) задать `MESSENGER_ENABLED=1`.
2. Убедиться, что Redis доступен и в `crm/settings.py` используется кэш на Redis (`REDIS_URL` задан в production).
3. Выполнить миграции: `python manage.py migrate` (на PostgreSQL).

### Как создать Inbox

1. Войти в CRM под учётной записью с правами администратора.
2. Перейти в **Настройки** → карточка **«Чат-виджет»** (или напрямую `/settings/messenger/`).
3. Нажать **«+ Создать Inbox»**.
4. Указать название, выбрать филиал, при необходимости отключить «Активен».
5. Сохранить. Токен виджета (`widget_token`) создаётся автоматически.
6. На странице редактирования Inbox можно скопировать токен, код вставки и открыть демо-страницу виджета.

### Как встроить виджет на сайт

1. В настройках Inbox (**/settings/messenger/inboxes/<id>/**) скопировать **«Код вставки на сайт»**.
2. Вставить код перед `</body>` на всех страницах, где должен отображаться виджет:
   - `<link rel="stylesheet" href="<BASE_URL>/static/messenger/widget.css">`
   - `<script src="<BASE_URL>/static/messenger/widget.js" data-widget-token="<TOKEN>"></script>`
3. `<BASE_URL>` — публичный URL вашей CRM (например `https://crm.example.com`), без завершающего слеша.
4. Не публикуйте `widget_token` в открытом доступе; он виден в коде страницы клиента — это нормально для идентификации виджета, но токен должен быть привязан только к вашему домену/сайту.

### Ленивая загрузка виджета

Чтобы не загружать виджет до первого взаимодействия (скролл или таймер), используйте **widget-loader.js**:

- Один тег перед `</body>`:
  `<script src="<BASE_URL>/static/messenger/widget-loader.js" data-widget-token="<TOKEN>"></script>`
  — без дополнительных атрибутов виджет загрузится сразу (как с обычным widget.js).
- Загрузка через N секунд: `data-load-after="5"` (через 5 секунд).
- Загрузка при первом скролле: `data-load-on-scroll="1"`.
- Можно комбинировать: виджет загрузится при первом скролле **или** через N секунд (что раньше). Пример из настроек Inbox: `data-load-on-scroll="1" data-load-after="5"`.

Лоадер сам подгружает `widget.css` и `widget.js` с тем же токеном; отдельно подключать их не нужно.

### Форматирование сообщений

- В панели оператора сообщения диалога отображаются с простым форматированием: `**жирный**`, автоссылки `http(s)://...`, переводы строк.
- В виджете используется такой же Markdown-подобный рендер: текст экранируется, поддерживаются `**жирный**`, ссылки и переносы строк.
- Эмодзи (Unicode) отображаются «как есть» и в виджете, и в операторской панели.

### Как проверить E2E

1. **Диагностика:** Настройки → Чат-виджет → **«Диагностика»** (`/settings/messenger/health/`). Проверить: MESSENGER_ENABLED, Redis доступен, количество активных Inbox.
2. **Демо-страница:** В карточке Inbox нажать **«Открыть демо»** или перейти `/widget-demo/?token=<widget_token>`. Открыть чат, отправить сообщение.
3. **Операторская панель:** Меню **«Диалоги»** (`/messenger/conversations/`) — убедиться, что новый диалог появился, ответить из панели.
4. **Виджет на тестовом сайте:** Вставить код вставки на тестовую страницу, открыть в браузере, написать сообщение и проверить ответ оператора.

### E2E-тесты (Playwright)

Для проверки полного сквозного сценария «виджет → сообщение → ответ в панели» можно использовать Playwright.

1. Установить Node.js и Playwright (`npx playwright install`).
2. Запустить backend (например, `python backend/manage.py runserver 0.0.0.0:8000`).
3. Создать тестовый Inbox и открыть демо-страницу `/widget-demo/?token=<widget_token>`.
4. Задать переменные окружения:
   - `PLAYWRIGHT_BASE_URL` — базовый URL backend (по умолчанию `http://localhost:8000`);
   - `MESSENGER_TEST_WIDGET_TOKEN` — `widget_token` тестового Inbox;
   - `MESSENGER_ADMIN_EMAIL` / `MESSENGER_ADMIN_PASSWORD` — учётные данные администратора CRM.
5. Запустить тест:
   - из корня репозитория: `npx playwright test e2e/messenger-widget.spec.js`.

Тест открывает демо-виджет, отправляет сообщение от посетителя, затем заходит в панель оператора, находит диалог по тексту сообщения, отправляет ответ и ожидает появления ответа в виджете (через SSE или fallback на poll).

### Нагрузочные тесты widget API (Locust)

Для проверки поведения под нагрузкой и реакции на лимиты/Redis есть `locustfile.py` в корне репозитория.

1. Установить зависимости для нагрузочного теста:
   - `pip install "locust>=2.0"`.
2. Запустить backend (например, `python backend/manage.py runserver 0.0.0.0:8000`).
3. Создать тестовый Inbox и включить Messenger.
4. Задать переменные окружения:
   - `MESSENGER_LOADTEST_BASE_URL` — базовый URL backend (по умолчанию `http://localhost:8000`);
   - `MESSENGER_LOADTEST_WIDGET_TOKEN` — `widget_token` тестового Inbox;
   - опционально `MESSENGER_LOADTEST_SINCE_ID` — начальное значение `since_id` (по умолчанию `0`).
5. Запустить Locust из корня проекта:
   - `locust -f locustfile.py --host=%MESSENGER_LOADTEST_BASE_URL%`.

Профили нагрузки (кол-во пользователей, скорость появления новых пользователей/spawn rate) настраиваются в UI Locust.  
Сценарий имитирует последовательность `bootstrap → send → poll` для множества одновременных посетителей и позволяет наблюдать:
- время ответа widget API;
- долю ответов с 429 (throttle) и 5xx;
- поведение Redis/кеша при росте числа активных сессий.

### Webhook-интеграции Messenger

Для интеграции с внешними системами (CRM/ERP, n8n, Zapier/Make через webhook и т.п.) можно настроить webhook на уровне Inbox.

1. Открыть страницу редактирования Inbox (`/settings/messenger/inboxes/<id>/`).
2. В разделе **«Интеграции (Webhook)»**:
   - включить чекбокс «Включить webhook для этого Inbox»;
   - задать `Webhook URL` (например, URL входящего webhook'а в n8n);
   - при необходимости задать `Секрет для подписи` (shared secret для проверки подлинности запроса);
   - выбрать интересующие события (новый диалог, закрытие, входящие/исходящие сообщения).

Формат запроса:

- Метод: `POST`.
- Заголовки:
  - `Content-Type: application/json`;
  - `X-Messenger-Event`: тип события (`conversation.created`, `conversation.closed`, `message.in`, `message.out`);
  - `X-Messenger-Inbox-Id`: ID Inbox;
  - при заданном секрете: `X-Messenger-Signature` — HMAC-SHA256 от тела запроса по shared secret.
- Тело: JSON вида:

```json
{
  "event": "message.in",
  "message": {
    "id": 123,
    "conversation_id": 456,
    "direction": "in",
    "body": "Текст сообщения",
    "created_at": "2025-01-01T12:34:56+03:00",
    "sender_contact_id": "uuid-..."
  },
  "conversation": {
    "id": 456,
    "inbox_id": 1,
    "branch_id": 10,
    "status": "open"
  }
}
```

Аналогично для `message.out` (будет `sender_user_id`) и для `conversation.created` / `conversation.closed` — только блок `conversation`.

### Автоматизация и автоответ

Для простых сценариев автоматизации добавлен автоответ на первый входящий месседж:

1. Открыть страницу редактирования Inbox (`/settings/messenger/inboxes/<id>/`).
2. В разделе **«Автоматизация и автоответ»**:
   - включить чекбокс «Включить автоответ на первый входящий месседж»;
   - задать текст автоответа.

Поведение:

- автоответ отправляется только для входящих сообщений из виджета (widget API);
- отправляется один раз за диалог, только если:
  - статус диалога `OPEN`;
  - у диалога есть назначенный оператор (`assignee`);
  - ещё не было исходящих сообщений (`direction = "out"`).
- автоответ отправляется от имени назначенного оператора и попадает в тот же поток, что и обычные сообщения (виден в панели и в виджете).

### Мониторинг и алерты

Рекомендуется подключить Messenger к общей системе мониторинга/логирования проекта:

- **Проверка health:** настроить внешний health-check по `/settings/messenger/health/` и/или отдельному nginx location для widget API (`/api/widget/*`) с alert'ом при недоступности или резком росте времени ответа.
- **Redis/кеш:** алерты по:
  - недоступности Redis (connect error в логах, падение количества ключей, рост времени ответа);
  - использованию in-memory fallback (по сообщениям логгера Messenger о деградации).
- **Лимиты/429:** алерты по росту доли ответов `429 Too Many Requests` на widget API (по access‑логам nginx/ingress или метрикам приложения).
- **Ошибки 5xx:** алерты по числу 5xx по endpoint'ам `/api/widget/*` и `/messenger/*`.

Минимально достаточно:

1. Отправлять логи Django/nginx в централизованный логгер (ELK/Sentry/Loki и т.п.).
2. Строить дашборд по кодам ответов для widget API и настраивать алерты на:
   - долю 5xx > X% за N минут;
   - долю 429 > Y% за N минут;
   - недоступность `/settings/messenger/health/` или аномально высокое время ответа.

### Где настройки в /settings

| Раздел | URL | Описание |
|--------|-----|----------|
| Обзор Inbox | `/settings/messenger/` | Список inbox, токен, код вставки, ссылка на демо. |
| Редактирование Inbox | `/settings/messenger/inboxes/<id>/` | Название, филиал (только просмотр), активность, настройки виджета (заголовок, приветствие, цвет, поля email/телефон), регенерация токена. |
| Правила маршрутизации | `/settings/messenger/routing/` | Создание и редактирование правил «регион → филиал/inbox» для новых диалогов. |
| Диагностика | `/settings/messenger/health/` | MESSENGER_ENABLED, доступность Redis, количество активных Inbox. |

Доступ ко всем страницам `/settings/messenger/*` только у пользователей с ролью администратора (или superuser).

