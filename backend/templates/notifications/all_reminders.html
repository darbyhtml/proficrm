{% extends "ui/base.html" %}
{% block title %}Все напоминания — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Все напоминания</h1>
        <div class="text-sm text-brand-dark/70">
          Задач: <b>{{ total_tasks }}</b> · Договоров: <b>{{ total_contracts }}</b>
        </div>
      </div>
    </div>

    {% if overdue_tasks %}
      <div class="bg-white border border-brand-orange/40 rounded-2xl p-4">
        <h2 class="text-lg font-semibold mb-3 text-brand-orange">Просроченные задачи ({{ overdue_tasks.count }})</h2>
        <div class="space-y-2">
          {% for t in overdue_tasks %}
            <button type="button" class="w-full text-left block rounded-xl border border-brand-orange/40 px-4 py-3 bg-brand-orange/10 hover:bg-brand-orange/20" data-edit-task data-task-id="{{ t.id }}">
              <div class="text-sm font-medium">{{ t.title }}</div>
              {% if t.company %}
                <div class="text-xs muted mt-1">{{ t.company.name }}</div>
              {% endif %}
              <div class="text-[11px] muted-2 mt-2">
                Дедлайн: {{ t.due_at|date:"d.m.Y H:i" }}
                <span class="text-brand-orange">(просрочено)</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if today_tasks %}
      <div class="bg-white border border-brand-teal/40 rounded-2xl p-4">
        <h2 class="text-lg font-semibold mb-3 text-brand-teal">Задачи на сегодня ({{ today_tasks.count }})</h2>
        <div class="space-y-2">
          {% for t in today_tasks %}
            <button type="button" class="w-full text-left block rounded-xl border border-brand-teal/40 px-4 py-3 bg-brand-teal/10 hover:bg-brand-teal/20" data-edit-task data-task-id="{{ t.id }}">
              <div class="text-sm font-medium">{{ t.title }}</div>
              {% if t.company %}
                <div class="text-xs muted mt-1">{{ t.company.name }}</div>
              {% endif %}
              <div class="text-[11px] muted-2 mt-2">Дедлайн: {{ t.due_at|date:"d.m.Y H:i" }}</div>
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if week_tasks %}
      <div class="bg-white border rounded-2xl p-4">
        <h2 class="text-lg font-semibold mb-3 text-brand-dark">На этой неделе ({{ week_tasks.count }})</h2>
        <div class="space-y-2">
          {% for t in week_tasks %}
            <button type="button" class="w-full text-left block rounded-xl border border-brand-soft px-4 py-3 bg-brand-soft/20 hover:bg-brand-soft/40" data-edit-task data-task-id="{{ t.id }}">
              <div class="text-sm font-medium">{{ t.title }}</div>
              {% if t.company %}
                <div class="text-xs muted mt-1">{{ t.company.name }}</div>
              {% endif %}
              <div class="text-[11px] muted-2 mt-2">Дедлайн: {{ t.due_at|date:"d.m.Y H:i" }}</div>
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if contract_reminders %}
      <div class="bg-white border rounded-2xl p-4">
        <h2 class="text-lg font-semibold mb-3 text-brand-dark">Договоры ({{ contract_reminders|length }})</h2>
        <div class="space-y-2">
          {% for r in contract_reminders %}
            <a href="{{ r.url }}" class="block rounded-xl border {% if r.days_left and r.days_left < 14 %}border-brand-orange/40 bg-brand-orange/10{% else %}border-brand-soft bg-brand-soft/20{% endif %} px-4 py-3 hover:bg-brand-soft/40">
              <div class="text-sm font-medium">{{ r.title }}</div>
              {% if r.subtitle %}
                <div class="text-xs muted mt-1">{{ r.subtitle }}</div>
              {% endif %}
              {% if r.days_left is not None %}
                <div class="text-[11px] muted-2 mt-2">
                  Осталось дней: <b {% if r.days_left < 14 %}class="text-brand-orange"{% endif %}>{{ r.days_left }}</b>
                </div>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if future_tasks %}
      <div class="bg-white border rounded-2xl p-4">
        <h2 class="text-lg font-semibold mb-3 text-brand-dark/70">Будущие задачи ({{ future_tasks.count }})</h2>
        <div class="space-y-2">
          {% for t in future_tasks %}
            <button type="button" class="w-full text-left block rounded-xl border border-brand-soft px-4 py-3 bg-white opacity-75 hover:bg-brand-soft/20" data-edit-task data-task-id="{{ t.id }}">
              <div class="text-sm font-medium text-brand-dark/70">{{ t.title }}</div>
              {% if t.company %}
                <div class="text-xs muted mt-1">{{ t.company.name }}</div>
              {% endif %}
              <div class="text-[11px] muted-2 mt-2">Дедлайн: {{ t.due_at|date:"d.m.Y H:i" }}</div>
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if not overdue_tasks and not today_tasks and not week_tasks and not contract_reminders and not future_tasks %}
      <div class="bg-white border rounded-2xl p-8 text-center">
        <div class="text-brand-dark/50 text-lg">Напоминаний пока нет</div>
      </div>
    {% endif %}
  </div>

  <!-- Модальное окно для редактирования задач -->
  <div id="taskEditModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
      <div id="taskEditModalContent"></div>
    </div>
  </div>

  <script>
    (function() {
      const modal = document.getElementById('taskEditModal');
      const modalContent = document.getElementById('taskEditModalContent');
      if (!modal || !modalContent) return;

      function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
      }

      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-close-task-modal]');
        if (closeBtn) {
          e.preventDefault();
          closeModal();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });

      // Редактирование задачи
      document.querySelectorAll('[data-edit-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const taskId = this.dataset.taskId;
          const url = `/tasks/${taskId}/edit/?modal=1`;
          
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Ошибка загрузки формы');
            const html = await res.text();
            modalContent.innerHTML = html;
            modal.classList.remove('hidden');
            
            // Инициализация select для типа задачи с задержкой
            setTimeout(function() {
              if (window.initTaskTypeSelects) {
                window.initTaskTypeSelects();
              }
            }, 100);
            
            const form = modalContent.querySelector('[data-task-edit-form]');
            if (form) {
              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                try {
                  const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                  });
                  const data = await res.json();
                  if (data.ok) {
                    closeModal();
                    location.reload();
                  } else {
                    alert('Ошибка: ' + (data.error || 'Не удалось сохранить'));
                  }
                } catch (err) {
                  alert('Ошибка при сохранении: ' + err.message);
                }
              }, { once: true });
            }
          } catch (err) {
            alert('Ошибка загрузки формы: ' + err.message);
          }
        });
      });
    })();
  </script>
{% endblock %}
