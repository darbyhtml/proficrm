{% extends "ui/base.html" %}
{% block title %}Рабочий стол — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-6">
    <div class="flex items-end justify-between">
      <div>
        <h1 class="text-2xl font-semibold">Рабочий стол</h1>
        <div class="text-sm text-brand-dark/70">Сегодняшние задачи и последние изменения</div>
      </div>
      <div class="flex items-center gap-2">
        {% if can_view_cold_call_reports %}
          <button type="button" class="btn btn-outline" id="openColdDay" title="Отчёт по холодным звонкам за день" aria-label="Отчёт по холодным звонкам за день">
            <span class="inline-flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>ХЗ день</span>
            </span>
          </button>
          <button type="button" class="btn btn-outline" id="openColdMonth" title="Отчёт по холодным звонкам за месяц" aria-label="Отчёт по холодным звонкам за месяц">
            <span class="inline-flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M8 2v3M16 2v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M7 10h10M7 14h10M7 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span>ХЗ месяц</span>
            </span>
          </button>
        {% endif %}
        <a href="/tasks/new/" class="btn btn-primary">+ Новая задача</a>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {# 1 строка: На сегодня + Новые задачи #}
      <section class="card card-pad">
        <div class="font-medium mb-3">На сегодня</div>
        {% if tasks_today %}
          <ul class="space-y-2">
            {% for t in tasks_today %}
              <li class="rounded-lg border p-3 {% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}task-overdue{% endif %}">
                <div class="flex items-start justify-between gap-3">
                  <div class="text-sm font-medium">{{ t.title }}</div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    {% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}
                      <span class="badge badge-danger">Срочно</span>
                    {% endif %}
                    <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span>
                  </div>
                </div>
                <div class="text-xs text-brand-dark/70">
                  {% if t.company %}<a class="link" href="/companies/{{ t.company.id }}/">{{ t.company.name }}</a>{% endif %}
                  {% if t.due_at %} · <span class="{% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}text-red-700{% endif %}">{{ t.due_at }}</span>{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm text-brand-dark/70">На сегодня задач нет.</div>
        {% endif %}
      </section>

      <section class="card card-pad">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">Новые задачи</div>
          <a class="text-sm link" href="/tasks/?mine=1&status=new">Все новые</a>
        </div>
        {% if tasks_new %}
          <ul class="space-y-2">
            {% for t in tasks_new %}
              <li class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div class="text-sm font-medium">{{ t.title }}</div>
                  <span class="badge badge-new">Новая</span>
                </div>
                <div class="text-xs text-brand-dark/70">
                  {% if t.company %}<a class="link" href="/companies/{{ t.company.id }}/">{{ t.company.name }}</a>{% endif %}
                  {% if t.created_by %} · назначил: {{ t.created_by }}{% endif %}
                  · {{ t.created_at }}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm text-brand-dark/70">Новых задач нет.</div>
        {% endif %}
      </section>

      {# 2 строка: Просрочено + Договоры #}
      <section class="card card-pad">
        <div class="font-medium mb-3">Просрочено</div>
        {% if overdue %}
          <ul class="space-y-2">
            {% for t in overdue %}
              <li class="rounded-lg border p-3 task-overdue">
                <div class="flex items-start justify-between gap-3">
                  <div class="text-sm font-medium">{{ t.title }}</div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <span class="badge badge-danger">Просрочено</span>
                    <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span>
                  </div>
                </div>
                <div class="text-xs text-brand-dark/70">
                  {% if t.company %}<a class="link" href="/companies/{{ t.company.id }}/">{{ t.company.name }}</a>{% endif %}
                  {% if t.due_at %} · <span class="text-red-700">дедлайн: {{ t.due_at }}</span>{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm text-brand-dark/70">Нет просроченных задач.</div>
        {% endif %}
      </section>

      <section class="card card-pad">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">Договоры</div>
          <a class="text-sm link" href="/companies/?contract_type=&q=">Список компаний</a>
        </div>
        {% if contracts_soon %}
          <ul class="space-y-2">
            {% for item in contracts_soon %}
              <li class="rounded-lg border p-3 {% if item.level == 'danger' %}task-overdue{% else %}bg-brand-orange/10 border-brand-orange/40{% endif %}">
                <div class="flex items-start justify-between gap-3">
                  <div class="text-sm font-medium">
                    <a class="link" href="/companies/{{ item.company.id }}/">{{ item.company.name }}</a>
                  </div>
                  <span class="badge {% if item.level == 'danger' %}badge-danger{% else %}badge-warn{% endif %}">
                    {% if item.days_left is not None %}
                      {{ item.days_left }} дн.
                    {% else %}
                      —
                    {% endif %}
                  </span>
                </div>
                <div class="text-xs text-brand-dark/70 mt-1">
                  {% if item.company.contract_type %}{{ item.company.get_contract_type_display }}{% else %}—{% endif %}
                  {% if item.company.contract_until %} · до <span class="{% if item.level == 'danger' %}text-red-700{% endif %}">{{ item.company.contract_until|date:"d.m.Y" }}</span>{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm text-brand-dark/70">Ближайших окончаний договоров нет.</div>
        {% endif %}
      </section>

      {# 3 строка: Задачи на неделю — на всю ширину #}
      <section class="card card-pad lg:col-span-2">
        <div class="font-medium mb-3">Задачи на неделю</div>
        {% if tasks_week %}
          <ul class="space-y-2">
            {% for t in tasks_week %}
              <li class="rounded-lg border p-3 {% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}task-overdue{% endif %}">
                <div class="flex items-start justify-between gap-3">
                  <div class="text-sm font-medium">{{ t.title }}</div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    {% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}
                      <span class="badge badge-danger">Просрочено</span>
                    {% endif %}
                    <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span>
                  </div>
                </div>
                <div class="text-xs text-brand-dark/70">
                  {% if t.company %}<a class="link" href="/companies/{{ t.company.id }}/">{{ t.company.name }}</a>{% endif %}
                  {% if t.due_at %} · <span class="{% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}text-red-700{% endif %}">{{ t.due_at }}</span>{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm text-brand-dark/70">На ближайшую неделю задач нет.</div>
        {% endif %}
      </section>
    </div>

    <div id="coldCallsModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-coldcalls></div>
      <div class="absolute inset-x-4 top-24 mx-auto max-w-2xl">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium" id="coldCallsTitle">Отчёт</div>
              <div class="text-xs muted-2 mt-1" id="coldCallsSub">—</div>
            </div>
            <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-coldcalls aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <div class="mt-3 flex flex-wrap items-center gap-2">
            <select id="coldCallsMonthSelect" class="w-full md:w-auto rounded-lg border px-3 py-2 text-sm hidden"></select>
            <button type="button" class="btn btn-outline" id="coldCallsRefresh">Обновить</button>
            <button type="button" class="btn btn-primary" id="coldCallsCopy">Скопировать отчёт</button>
          </div>
          <div class="mt-3">
            <textarea id="coldCallsText" class="textarea" rows="12" readonly></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const modal = document.getElementById('coldCallsModal');
      const titleEl = document.getElementById('coldCallsTitle');
      const subEl = document.getElementById('coldCallsSub');
      const txtEl = document.getElementById('coldCallsText');
      const monthSel = document.getElementById('coldCallsMonthSelect');
      const btnDay = document.getElementById('openColdDay');
      const btnMonth = document.getElementById('openColdMonth');
      const btnCopy = document.getElementById('coldCallsCopy');
      const btnRefresh = document.getElementById('coldCallsRefresh');
      if(!modal || !titleEl || !subEl || !txtEl || !btnCopy) return;

      let mode = 'day'; // day|month
      let monthKey = '';

      function open(){ modal.classList.remove('hidden'); }
      function close(){ modal.classList.add('hidden'); }
      modal.querySelectorAll('[data-close-coldcalls]').forEach(b => b.addEventListener('click', close));
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') close(); });

      async function loadDay(){
        mode = 'day';
        if(monthSel) monthSel.classList.add('hidden');
        titleEl.textContent = 'Отчёт по холодным звонкам (день)';
        subEl.textContent = 'Загружаю…';
        txtEl.value = '';
        const res = await fetch('/reports/cold-calls/day/', {credentials:'same-origin'});
        const data = await res.json().catch(() => null);
        if(!data || !data.ok) { subEl.textContent = 'Не удалось загрузить отчёт.'; return; }
        subEl.textContent = `Дата: ${data.date} · Всего: ${data.count}`;
        txtEl.value = data.text || '';
      }

      function fillMonthOptions(opts){
        if(!monthSel) return;
        monthSel.innerHTML = '';
        (opts || []).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.key;
          opt.textContent = o.label;
          monthSel.appendChild(opt);
        });
        monthSel.classList.remove('hidden');
      }

      async function loadMonth(){
        mode = 'month';
        titleEl.textContent = 'Отчёт по холодным звонкам (месяц)';
        subEl.textContent = 'Загружаю…';
        txtEl.value = '';
        const q = monthKey ? `?month=${encodeURIComponent(monthKey)}` : '';
        const res = await fetch('/reports/cold-calls/month/' + q, {credentials:'same-origin'});
        const data = await res.json().catch(() => null);
        if(!data || !data.ok) { subEl.textContent = 'Не удалось загрузить отчёт.'; return; }
        fillMonthOptions(data.available_months || []);
        if(monthSel && data.month) {
          monthSel.value = data.month;
          monthKey = data.month;
        }
        subEl.textContent = `${data.month_label} · Всего: ${data.count}`;
        txtEl.value = data.text || '';
      }

      if(monthSel){
        monthSel.addEventListener('change', () => {
          monthKey = monthSel.value || '';
          loadMonth();
        });
      }
      if(btnRefresh){
        btnRefresh.addEventListener('click', () => {
          if(mode === 'month') loadMonth();
          else loadDay();
        });
      }
      if(btnDay){
        btnDay.addEventListener('click', () => { open(); loadDay(); });
      }
      if(btnMonth){
        btnMonth.addEventListener('click', () => { open(); loadMonth(); });
      }
      btnCopy.addEventListener('click', async () => {
        const text = txtEl.value || '';
        try{
          await navigator.clipboard.writeText(text);
          btnCopy.textContent = 'Скопировано';
          setTimeout(() => btnCopy.textContent = 'Скопировать отчёт', 1200);
        }catch(_e){
          // fallback
          txtEl.focus();
          txtEl.select();
          document.execCommand('copy');
        }
      });
    })();
  </script>
{% endblock %}


