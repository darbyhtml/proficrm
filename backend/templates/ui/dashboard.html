{% extends "ui/base.html" %}
{% block title %}Рабочий стол — CRM ПРОФИ{% endblock %}

{% block extra_head %}
<style>
  /* Анимации появления карточек */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .dashboard-card {
    animation: slideIn 0.3s ease-out;
  }
  .dashboard-card:nth-child(1) { animation-delay: 0.05s; }
  .dashboard-card:nth-child(2) { animation-delay: 0.1s; }
  .dashboard-card:nth-child(3) { animation-delay: 0.15s; }
  .dashboard-card:nth-child(4) { animation-delay: 0.2s; }
  .dashboard-card:nth-child(5) { animation-delay: 0.25s; }
  
  /* Мобильная оптимизация */
  @media (max-width: 640px) {
    .card-pad {
      padding: 12px;
    }
    .dashboard-card {
      min-height: 44px; /* Минимальный размер для touch */
    }
  }
  
  /* Анимация спиннера */
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
{% endblock %}

{% block content %}
  <div class="space-y-6">
    <div class="flex items-end justify-between">
      <div>
        <h1 class="text-2xl font-semibold">Рабочий стол</h1>
        <div class="text-sm text-brand-dark/70">Сегодняшние задачи и последние изменения</div>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        {% if can_view_cold_call_reports %}
          <button type="button" class="btn btn-outline" id="openColdDay" title="Отчёт по холодным звонкам за день" aria-label="Отчёт по холодным звонкам за день">
            <span class="inline-flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>ХЗ день</span>
            </span>
          </button>
          <button type="button" class="btn btn-outline" id="openColdMonth" title="Отчёт по холодным звонкам за месяц" aria-label="Отчёт по холодным звонкам за месяц">
            <span class="inline-flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M8 2v3M16 2v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M7 10h10M7 14h10M7 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span>ХЗ месяц</span>
            </span>
          </button>
        {% endif %}
        <a href="/companies/new/" class="btn btn-secondary text-sm">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          + Компания
        </a>
        <a href="/tasks/new/" class="btn btn-primary">+ Новая задача</a>
      </div>
    </div>

    {# Индикатор обновления #}
    <div id="dashboard-update-indicator" class="hidden fixed top-4 right-4 z-50">
      <div class="flex items-center gap-2 bg-white border border-brand-soft rounded-lg px-3 py-2 shadow-lg">
        <svg class="animate-spin w-4 h-4 text-brand-teal" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
        <span class="text-sm text-brand-dark">Обновление...</span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
      {# 1 строка: На сегодня + Новые задачи #}
      <section class="card card-pad dashboard-card">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">
            На сегодня
            {% if tasks_today %}
              <span class="ml-2 badge badge-new">{{ tasks_today|length }}</span>
            {% endif %}
          </div>
        </div>
        {% if tasks_today %}
          <ul class="space-y-2">
            {% for t in tasks_today %}
              <li>
                <button type="button" class="w-full text-left rounded-lg border p-3 transition-all hover:border-brand-teal/50 hover:bg-brand-soft/20 {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}border-red-300 bg-red-50/50{% else %}border-brand-soft{% endif %}" data-view-task data-task-id="{{ t.id }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="text-sm font-medium">{{ t.title }}</div>
                      <div class="text-xs text-brand-dark/70 mt-1">
                        {% if t.company %}<span>{{ t.company.name }}</span>{% endif %}
                        {% if t.due_at %} · <span class="{% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}text-red-700 font-medium{% endif %}">{{ t.due_at|date:"d.m.Y H:i" }}</span>{% endif %}
                      </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}
                        <span class="badge badge-danger text-xs">Срочно</span>
                      {% endif %}
                      <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span>
                    </div>
                  </div>
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M8 2v3M16 2v3M3 6h18M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6"/>
              <path d="M7 10h10M7 14h10"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">На сегодня задач нет</div>
            <div class="text-xs text-brand-dark/50 mb-4">Отличная работа! Все задачи выполнены.</div>
            <a href="/tasks/new/" class="btn btn-outline text-xs">+ Создать задачу</a>
          </div>
        {% endif %}
      </section>

      <section class="card card-pad dashboard-card" id="section-tasks-new">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">
            Новые задачи
            {% if tasks_new %}
              <span class="ml-2 badge badge-new">{{ tasks_new|length }}</span>
            {% endif %}
          </div>
          {% if tasks_new %}
            <a class="text-sm link" href="/tasks/?mine=1&status=new">Все новые</a>
          {% endif %}
        </div>
        {% if tasks_new %}
          <ul class="space-y-2">
            {% for t in tasks_new %}
              <li>
                <button type="button" class="w-full text-left rounded-lg border border-brand-soft p-3 transition-all hover:border-brand-teal/50 hover:bg-brand-soft/20" data-view-task data-task-id="{{ t.id }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="text-sm font-medium">{{ t.title }}</div>
                      <div class="text-xs text-brand-dark/70 mt-1">
                        {% if t.company %}<span>{{ t.company.name }}</span>{% endif %}
                        {% if t.created_by %} · назначил: {{ t.created_by }}{% endif %}
                        · {{ t.created_at|date:"d.m.Y H:i" }}
                      </div>
                    </div>
                    <span class="badge badge-new flex-shrink-0">Новая</span>
                  </div>
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">Новых задач нет</div>
            <div class="text-xs text-brand-dark/50 mb-4">Новые задачи появятся здесь</div>
            <a href="/tasks/new/" class="btn btn-outline text-xs">+ Создать задачу</a>
          </div>
        {% endif %}
      </section>

      {# 2 строка: Просрочено + Договоры #}
      <section class="card card-pad dashboard-card" id="section-overdue">
        <div class="font-medium mb-3">
          Просрочено
          {% if overdue %}
            <span class="ml-2 badge badge-danger">{{ overdue|length }}</span>
          {% endif %}
        </div>
        {% if overdue %}
          <ul class="space-y-2">
            {% for t in overdue %}
              <li>
                <button type="button" class="w-full text-left rounded-lg border border-red-300 bg-red-50/50 p-3 transition-all hover:border-red-400 hover:bg-red-50" data-view-task data-task-id="{{ t.id }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="text-sm font-medium">{{ t.title }}</div>
                      <div class="text-xs text-brand-dark/70 mt-1">
                        {% if t.company %}<span>{{ t.company.name }}</span>{% endif %}
                        {% if t.due_at %} · <span class="text-red-700 font-medium">дедлайн: {{ t.due_at|date:"d.m.Y H:i" }}</span>{% endif %}
                      </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <span class="badge badge-danger text-xs">Просрочено</span>
                      <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span>
                    </div>
                  </div>
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">Нет просроченных задач</div>
            <div class="text-xs text-brand-dark/50">Отлично! Все задачи в срок.</div>
          </div>
        {% endif %}
      </section>

      <section class="card card-pad dashboard-card" id="section-contracts">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">
            Договоры
            {% if contracts_soon %}
              <span class="ml-2 badge {% if contracts_soon|length > 0 and contracts_soon.0.level == 'danger' %}badge-danger{% else %}badge-warn{% endif %}">{{ contracts_soon|length }}</span>
            {% endif %}
          </div>
          {% if contracts_soon %}
            <a class="text-sm link" href="/companies/?contract_type=&q=">Список компаний</a>
          {% endif %}
        </div>
        {% if contracts_soon %}
          <ul class="space-y-2">
            {% for item in contracts_soon %}
              <li class="group">
                <a href="/companies/{{ item.company.id }}/" class="block rounded-lg border p-3 transition-all {% if item.level == 'danger' %}task-overdue border-red-400{% else %}bg-brand-orange/10 border-brand-orange/40{% endif %} hover:border-brand-teal/50 hover:bg-brand-soft/20">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1">
                      <div class="text-sm font-medium">
                        {{ item.company.name }}
                      </div>
                      <div class="text-xs text-brand-dark/70 mt-1">
                        {% if item.company.contract_type %}{{ item.company.get_contract_type_display }}{% else %}—{% endif %}
                        {% if item.company.contract_until %} · до <span class="{% if item.level == 'danger' %}text-red-700 font-medium{% endif %}">{{ item.company.contract_until|date:"d.m.Y" }}</span>{% endif %}
                      </div>
                    </div>
                    <span class="badge {% if item.level == 'danger' %}badge-danger{% else %}badge-warn{% endif %} flex-shrink-0">
                      {% if item.days_left is not None %}
                        {{ item.days_left }} дн.
                      {% else %}
                        —
                      {% endif %}
                    </span>
                  </div>
                </a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">Ближайших окончаний договоров нет</div>
            <div class="text-xs text-brand-dark/50">Все договоры в порядке</div>
          </div>
        {% endif %}
      </section>

      {# 3 строка: Задачи на неделю — на всю ширину #}
      <section class="card card-pad lg:col-span-2 dashboard-card">
        <div class="font-medium mb-3">
          Задачи на неделю
          {% if tasks_week %}
            <span class="ml-2 badge badge-progress">{{ tasks_week|length }}</span>
          {% endif %}
        </div>
        {% if tasks_week %}
          <ul class="space-y-2">
            {% for t in tasks_week %}
              <li>
                <button type="button" class="w-full text-left rounded-lg border border-brand-soft p-3 transition-all hover:border-brand-teal/50 hover:bg-brand-soft/20 {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}border-red-300 bg-red-50/50{% endif %}" data-view-task data-task-id="{{ t.id }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="text-sm font-medium">{{ t.title }}</div>
                      <div class="text-xs text-brand-dark/70 mt-1">
                        {% if t.company %}<span>{{ t.company.name }}</span>{% endif %}
                        {% if t.due_at %} · <span class="{% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}text-red-700 font-medium{% endif %}">{{ t.due_at|date:"d.m.Y H:i" }}</span>{% endif %}
                      </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}
                        <span class="badge badge-danger text-xs">Просрочено</span>
                      {% endif %}
                      <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span>
                    </div>
                  </div>
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M8 2v3M16 2v3M3 6h18M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6"/>
              <path d="M7 10h10M7 14h10"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">На ближайшую неделю задач нет</div>
            <div class="text-xs text-brand-dark/50 mb-4">Задачи на неделю появятся здесь</div>
            <a href="/tasks/new/" class="btn btn-outline text-xs">+ Создать задачу</a>
          </div>
        {% endif %}
      </section>
    </div>

    {# Модальное окно для просмотра задачи #}
    <div id="taskViewModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-task-view></div>
      <div class="absolute inset-x-4 top-12 mx-auto max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3 mb-4">
            <div class="flex-1">
              <h2 class="text-xl font-semibold text-brand-dark" id="taskViewTitle">Загрузка...</h2>
            </div>
            <button type="button" class="btn btn-outline flex-shrink-0" style="padding:.35rem .5rem;font-size:.75rem" data-close-task-view aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <div id="taskViewContent">
            <div class="text-center py-8">
              <svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-6.219-8.56"/>
              </svg>
              <div class="text-sm text-brand-dark/70">Загрузка задачи...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="coldCallsModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-coldcalls></div>
      <div class="absolute inset-x-4 top-24 mx-auto max-w-2xl">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium" id="coldCallsTitle">Отчёт</div>
              <div class="text-xs muted-2 mt-1" id="coldCallsSub">—</div>
            </div>
            <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-coldcalls aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <div class="mt-3 flex flex-wrap items-center gap-2">
            <select id="coldCallsDaySelect" class="w-full md:w-auto rounded-lg border px-3 py-2 text-sm hidden"></select>
            <select id="coldCallsMonthSelect" class="w-full md:w-auto rounded-lg border px-3 py-2 text-sm hidden"></select>
            <button type="button" class="btn btn-outline" id="coldCallsRefresh">Обновить</button>
            <button type="button" class="btn btn-primary" id="coldCallsCopy">Скопировать отчёт</button>
          </div>
          <div class="mt-3">
            <textarea id="coldCallsText" class="textarea" rows="12" readonly></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const modal = document.getElementById('coldCallsModal');
      const titleEl = document.getElementById('coldCallsTitle');
      const subEl = document.getElementById('coldCallsSub');
      const txtEl = document.getElementById('coldCallsText');
      const monthSel = document.getElementById('coldCallsMonthSelect');
      const daySel = document.getElementById('coldCallsDaySelect');
      const btnDay = document.getElementById('openColdDay');
      const btnMonth = document.getElementById('openColdMonth');
      const btnCopy = document.getElementById('coldCallsCopy');
      const btnRefresh = document.getElementById('coldCallsRefresh');
      if(!modal || !titleEl || !subEl || !txtEl || !btnCopy) return;

      let mode = 'day'; // day|month
      let monthKey = '';
      let selectedDate = '';

      function open(){ modal.classList.remove('hidden'); }
      function close(){ modal.classList.add('hidden'); }
      modal.querySelectorAll('[data-close-coldcalls]').forEach(b => b.addEventListener('click', close));
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') close(); });

      async function loadDay(){
        mode = 'day';
        if(monthSel) monthSel.classList.add('hidden');
        if(daySel) daySel.classList.remove('hidden');
        titleEl.textContent = 'Отчёт по холодным звонкам (день)';
        subEl.textContent = 'Загружаю…';
        txtEl.value = '';

        // Подгружаем список последних 7 дней (для выбора даты)
        try{
          const resDays = await fetch('/reports/cold-calls/last-7-days/', {credentials:'same-origin'});
          const daysData = await resDays.json().catch(() => null);
          if(daysData && daysData.ok && daySel){
            daySel.innerHTML = '';
            (daysData.days || []).forEach(d => {
              const opt = document.createElement('option');
              opt.value = d.date;
              opt.textContent = `${d.label} (${d.count})`;
              daySel.appendChild(opt);
            });
            if(selectedDate){
              daySel.value = selectedDate;
            }else{
              // по умолчанию сегодня (первый/последний — зависит от порядка; у нас от старого к новому)
              if(daySel.options.length) daySel.value = daySel.options[daySel.options.length - 1].value;
              selectedDate = daySel.value;
            }
          }
        }catch(_e){}

        const q = selectedDate ? `?date=${encodeURIComponent(selectedDate)}` : '';
        const res = await fetch('/reports/cold-calls/day/' + q, {credentials:'same-origin'});
        const data = await res.json().catch(() => null);
        if(!data || !data.ok) { subEl.textContent = 'Не удалось загрузить отчёт.'; return; }
        subEl.textContent = `Дата: ${data.date} · Всего: ${data.count}`;
        txtEl.value = data.text || '';
      }

      function fillMonthOptions(opts){
        if(!monthSel) return;
        monthSel.innerHTML = '';
        (opts || []).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.key;
          opt.textContent = o.label;
          monthSel.appendChild(opt);
        });
        monthSel.classList.remove('hidden');
      }

      async function loadWeek(){
        // удалено: отдельный "отчёт за 7 дней" не нужен, оставляем выбор дня из последних 7 дней
      }

      async function loadMonth(){
        mode = 'month';
        if(daySel) daySel.classList.add('hidden');
        titleEl.textContent = 'Отчёт по холодным звонкам (месяц)';
        subEl.textContent = 'Загружаю…';
        txtEl.value = '';
        const q = monthKey ? `?month=${encodeURIComponent(monthKey)}` : '';
        const res = await fetch('/reports/cold-calls/month/' + q, {credentials:'same-origin'});
        const data = await res.json().catch(() => null);
        if(!data || !data.ok) { subEl.textContent = 'Не удалось загрузить отчёт.'; return; }
        fillMonthOptions(data.available_months || []);
        if(monthSel && data.month) {
          monthSel.value = data.month;
          monthKey = data.month;
        }
        subEl.textContent = `${data.month_label} · Всего: ${data.count}`;
        txtEl.value = data.text || '';
      }

      if(monthSel){
        monthSel.addEventListener('change', () => {
          monthKey = monthSel.value || '';
          loadMonth();
        });
      }
      if(daySel){
        daySel.addEventListener('change', () => {
          selectedDate = daySel.value || '';
          loadDay();
        });
      }
      if(btnRefresh){
        btnRefresh.addEventListener('click', () => {
          if(mode === 'month') loadMonth();
          else loadDay();
        });
      }
      if(btnDay){
        btnDay.addEventListener('click', () => { selectedDate = ''; open(); loadDay(); });
      }
      if(btnMonth){
        btnMonth.addEventListener('click', () => { open(); loadMonth(); });
      }
      btnCopy.addEventListener('click', async () => {
        const text = txtEl.value || '';
        try{
          await navigator.clipboard.writeText(text);
          btnCopy.textContent = 'Скопировано';
          setTimeout(() => btnCopy.textContent = 'Скопировать отчёт', 1200);
        }catch(_e){
          // fallback
          txtEl.focus();
          txtEl.select();
          document.execCommand('copy');
        }
      });
    })();
  </script>

  {# Модальное окно для просмотра задач #}
  <script>
    (function(){
      const modal = document.getElementById('taskViewModal');
      const modalContent = document.getElementById('taskViewContent');
      const modalTitle = document.getElementById('taskViewTitle');
      if(!modal || !modalContent || !modalTitle) return;

      function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '<div class="text-center py-8"><svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg><div class="text-sm text-brand-dark/70">Загрузка задачи...</div></div>';
        modalTitle.textContent = 'Загрузка...';
      }

      function openModal() {
        modal.classList.remove('hidden');
      }

      // Закрытие модалки
      modal.querySelectorAll('[data-close-task-view]').forEach(btn => {
        btn.addEventListener('click', closeModal);
      });
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if(e.target === e.currentTarget) closeModal();
      });

      // Открытие задачи в модальном окне
      document.querySelectorAll('[data-view-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const taskId = this.dataset.taskId;
          if(!taskId) return;
          
          openModal();
          
          try {
            // Используем task_list с параметром view_task для просмотра
            const res = await fetch(`/tasks/?view_task=${taskId}`, {
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if(!res.ok) throw new Error('Ошибка загрузки задачи');
            const html = await res.text();
            
            // Парсим HTML и извлекаем модальное окно
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const taskModal = doc.querySelector('#taskViewModal');
            
            if(taskModal) {
              const taskContent = taskModal.querySelector('.card')?.innerHTML || '';
              modalContent.innerHTML = taskContent;
              const titleEl = taskModal.querySelector('h2');
              if(titleEl) modalTitle.textContent = titleEl.textContent.trim();
            } else {
              // Fallback: используем task_edit для редактирования
              const editRes = await fetch(`/tasks/${taskId}/edit/?modal=1`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
              });
              if(editRes.ok) {
                const editHtml = await editRes.text();
                modalContent.innerHTML = editHtml;
                modalTitle.textContent = 'Редактирование задачи';
              } else {
                throw new Error('Не удалось загрузить задачу');
              }
            }
          } catch(e) {
            console.error('Task view error:', e);
            modalContent.innerHTML = '<div class="text-center py-8 text-red-600">Ошибка загрузки задачи</div>';
            modalTitle.textContent = 'Ошибка';
          }
        });
      });
    })();
  </script>

  {# AJAX Polling с индикатором обновления #}
  <script>
    (function(){
      const updateIndicator = document.getElementById('dashboard-update-indicator');
      let pollInterval = null;
      let isPolling = false;
      
      function showUpdateIndicator() {
        if(updateIndicator) updateIndicator.classList.remove('hidden');
      }
      
      function hideUpdateIndicator() {
        if(updateIndicator) updateIndicator.classList.add('hidden');
      }
      
      async function pollDashboard() {
        if(isPolling) return;
        isPolling = true;
        showUpdateIndicator();
        
        try {
          const response = await fetch('/api/dashboard/poll/', {
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json' }
          });
          
          if(response.ok) {
            const data = await response.json();
            // Если есть изменения, можно обновить страницу или обновить только нужные секции
            // Пока просто скрываем индикатор
          }
        } catch(e) {
          console.error('Dashboard poll error:', e);
        } finally {
          hideUpdateIndicator();
          isPolling = false;
        }
      }
      
      // Запускаем polling каждые 30 секунд
      if(updateIndicator) {
        pollInterval = setInterval(pollDashboard, 30000);
        
        // Останавливаем polling при уходе со страницы
        window.addEventListener('beforeunload', () => {
          if(pollInterval) clearInterval(pollInterval);
        });
      }
    })();
  </script>
{% endblock %}


