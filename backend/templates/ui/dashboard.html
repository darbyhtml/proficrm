{% extends "ui/base.html" %}
{% load ui_extras %}
{% block title %}Рабочий стол — CRM ПРОФИ{% endblock %}

{% block extra_head %}
<style>
  /* Анимации появления карточек */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .dashboard-card {
    animation: slideIn 0.3s ease-out;
  }
  .dashboard-card:nth-child(1) { animation-delay: 0.05s; }
  .dashboard-card:nth-child(2) { animation-delay: 0.1s; }
  .dashboard-card:nth-child(3) { animation-delay: 0.15s; }
  .dashboard-card:nth-child(4) { animation-delay: 0.2s; }
  .dashboard-card:nth-child(5) { animation-delay: 0.25s; }
  
  /* Мобильная оптимизация */
  @media (max-width: 640px) {
    .card-pad {
      padding: 12px;
    }
    .dashboard-card {
      min-height: 44px; /* Минимальный размер для touch */
    }
  }
  
  /* Анимация спиннера */
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
{% endblock %}

{% block content %}
  <div class="space-y-6">
    <div class="flex items-end justify-between">
      <div>
        <h1 class="text-2xl font-semibold">Рабочий стол</h1>
        <div class="text-sm text-brand-dark/70">Сегодняшние задачи и последние изменения</div>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        {% if can_view_cold_call_reports %}
          <button type="button" class="btn btn-outline btn-min-h" style="min-height:38px" id="openColdDay" title="Ежедневный отчёт: холодные звонки, входящие звонки, новые компании и контакты" aria-label="Ежедневный отчёт">
            <span class="inline-flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Отчёт за день</span>
            </span>
          </button>
          <button type="button" class="btn btn-outline btn-min-h" style="min-height:38px" id="openColdMonth" title="Месячный отчёт: холодные звонки, входящие звонки, новые компании и контакты" aria-label="Месячный отчёт">
            <span class="inline-flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M8 2v3M16 2v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M7 10h10M7 14h10M7 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span>Отчёт за месяц</span>
            </span>
          </button>
        {% endif %}
        <a href="/companies/new/" class="btn btn-secondary btn-min-h" style="min-height:38px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          + Новая компания
        </a>
        <button type="button" class="btn btn-primary btn-min-h" style="min-height:38px" data-create-task>+ Новая задача</button>
      </div>
    </div>

    {# Индикатор обновления #}
    <div id="dashboard-update-indicator" class="hidden fixed top-4 right-4 z-50">
      <div class="flex items-center gap-2 bg-white border border-brand-soft rounded-lg px-3 py-2 shadow-lg">
        <svg class="animate-spin w-4 h-4 text-brand-teal" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
        <span class="text-sm text-brand-dark">Обновление...</span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
      {# 1 строка: На сегодня + Новые задачи #}
      <section class="card card-pad dashboard-card">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">
            На сегодня
            {% if tasks_today_count > 0 %}
              <span class="ml-2 badge {% if tasks_today_count > 3 %}badge-progress{% else %}badge-new{% endif %}">{{ tasks_today_count }}</span>
            {% endif %}
          </div>
          {% if tasks_today_count > 3 %}
            <a class="text-sm link" href="/tasks/?mine=1&today=1">
              Посмотреть все
              <span class="text-xs text-brand-dark/60">({{ tasks_today_count }})</span>
            </a>
          {% endif %}
        </div>
        {% if tasks_today %}
          <ul class="space-y-2">
            {% for t in tasks_today %}
              <li>
                <button type="button" class="w-full text-left rounded-lg border p-3 transition-all hover:border-brand-teal/50 hover:bg-brand-soft/20 {% if t.due_at and today_start and t.due_at < today_start and t.status != 'done' and t.status != 'cancelled' %}border-red-300 bg-red-50/50{% else %}border-brand-soft{% endif %}" data-view-task data-task-id="{{ t.id }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        {% if t.type %}
                          {% include "ui/partials/task_type_badge.html" with task_type=t.type only %}
                        {% else %}
                          <div class="text-sm font-medium">{{ t.title }}</div>
                        {% endif %}
                      </div>
                      {% if t.description %}
                        <div class="text-xs text-brand-dark/70 mt-1 mb-1" style="line-height:1.4">{{ t.description|truncatechars:100 }}</div>
                      {% endif %}
                      {% include "ui/partials/_task_meta.html" with task=t only %}
                      <div class="text-xs text-brand-dark/70 flex items-center gap-1 flex-wrap mt-1">
                        {% if t.company %}
                          <span>{{ t.company.name }}</span>
                          {% with guessed=t.company.address|guess_ru_tz %}
                          {% with tz=t.company.work_timezone|default:guessed %}
                            {% if tz %}
                              <span class="badge badge-warn badge-xxxs" title="{{ tz }}" data-live-worktime="1" data-company-id="{{ t.company.id }}">
                                <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                                · {{ tz|tz_label }}
                              </span>
                              <span class="hidden" data-work-schedule-display="1" data-company-id="{{ t.company.id }}">{{ t.company.work_schedule|default:"" }}</span>
                            {% endif %}
                          {% endwith %}
                          {% endwith %}
                        {% endif %}
                      </div>
                      {% if t.due_at %}
                        <div class="mt-1.5 flex items-center gap-1.5 {% if t.due_at and today_start and t.due_at < today_start and t.status != 'done' and t.status != 'cancelled' %}text-red-700 font-semibold{% else %}text-brand-dark/80 font-medium{% endif %}">
                          <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 2v3M16 2v3M3 6h18M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6"/>
                          </svg>
                          <span>{{ t.due_at|date:"d.m.Y H:i" }}</span>
                        </div>
                      {% endif %}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %} text-xs">{{ t.get_status_display }}</span>
                    </div>
                  </div>
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M8 2v3M16 2v3M3 6h18M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6"/>
              <path d="M7 10h10M7 14h10"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">На сегодня задач нет</div>
            <div class="text-xs text-brand-dark/50 mb-4">Отличная работа! Все задачи выполнены.</div>
            <button type="button" class="btn btn-outline text-xs" data-create-task>+ Создать задачу</button>
          </div>
        {% endif %}
      </section>

      <section class="card card-pad dashboard-card" id="section-tasks-new">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">
            Новые задачи
            {% if tasks_new_count > 0 %}
              <span class="ml-2 badge badge-new">{{ tasks_new_count }}</span>
            {% endif %}
          </div>
          {% if tasks_new_count > 3 %}
            <a class="text-sm link" href="/tasks/?mine=1&status=new">
              Посмотреть все
              <span class="text-xs text-brand-dark/60">({{ tasks_new_count }})</span>
            </a>
          {% endif %}
        </div>
        {% if tasks_new %}
          <ul class="space-y-2">
            {% for t in tasks_new %}
              <li>
                <button type="button" class="w-full text-left rounded-lg border border-brand-soft p-3 transition-all hover:border-brand-teal/50 hover:bg-brand-soft/20" data-view-task data-task-id="{{ t.id }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        {% if t.type %}
                          {% include "ui/partials/task_type_badge.html" with task_type=t.type only %}
                        {% else %}
                          <div class="text-sm font-medium">{{ t.title }}</div>
                        {% endif %}
                      </div>
                      {% if t.description %}
                        <div class="text-xs text-brand-dark/70 mt-1 mb-1" style="line-height:1.4">{{ t.description|truncatechars:100 }}</div>
                      {% endif %}
                      <div class="text-xs text-brand-dark/70 flex items-center gap-1 flex-wrap">
                        {% if t.company %}
                          <span>{{ t.company.name }}</span>
                          {% with guessed=t.company.address|guess_ru_tz %}
                          {% with tz=t.company.work_timezone|default:guessed %}
                            {% if tz %}
                              <span class="badge badge-warn badge-xxxs" title="{{ tz }}" data-live-worktime="1" data-company-id="{{ t.company.id }}">
                                <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                                · {{ tz|tz_label }}
                              </span>
                              <span class="hidden" data-work-schedule-display="1" data-company-id="{{ t.company.id }}">{{ t.company.work_schedule|default:"" }}</span>
                            {% endif %}
                          {% endwith %}
                          {% endwith %}
                        {% endif %}
                        {% if t.created_by %} · назначил: {{ t.created_by }}{% endif %}
                        {% if not t.due_at %} · {{ t.created_at|date:"d.m.Y H:i" }}{% endif %}
                      </div>
                      {% if t.due_at %}
                        <div class="mt-1.5 flex items-center gap-1.5 {% if t.due_at and t.due_at < local_now %}text-red-700 font-semibold{% else %}text-brand-dark/80 font-medium{% endif %}">
                          <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 2v3M16 2v3M3 6h18M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6"/>
                          </svg>
                          <span>{{ t.due_at|date:"d.m.Y H:i" }}</span>
                        </div>
                      {% endif %}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <span class="badge badge-new text-xs">{{ t.get_status_display }}</span>
                    </div>
                  </div>
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">Новых задач нет</div>
            <div class="text-xs text-brand-dark/50 mb-4">Задачи появятся здесь</div>
            <button type="button" class="btn btn-outline text-xs" data-create-task>+ Создать задачу</button>
          </div>
        {% endif %}
      </section>

      {# 2 строка: Просрочено + Договоры #}
      <section class="card card-pad dashboard-card" id="section-overdue">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">
            Просрочено
            {% if overdue_count > 0 %}
              <span class="ml-2 badge badge-danger">{{ overdue_count }}</span>
            {% endif %}
          </div>
          {% if overdue_count > 3 %}
            <a class="text-sm link" href="/tasks/?mine=1&overdue=1">
              Посмотреть все
              <span class="text-xs text-brand-dark/60">({{ overdue_count }})</span>
            </a>
          {% endif %}
        </div>
        {% if overdue %}
          <ul class="space-y-2">
            {% for t in overdue %}
              <li>
                <button type="button" class="w-full text-left rounded-lg border border-red-300 bg-red-50/50 p-3 transition-all hover:border-red-400 hover:bg-red-50" data-view-task data-task-id="{{ t.id }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        {% if t.type %}
                          {% include "ui/partials/task_type_badge.html" with task_type=t.type only %}
                        {% else %}
                          <div class="text-sm font-medium">{{ t.title }}</div>
                        {% endif %}
                      </div>
                      {% if t.description %}
                        <div class="text-xs text-brand-dark/70 mt-1 mb-1" style="line-height:1.4">{{ t.description|truncatechars:100 }}</div>
                      {% endif %}
                      {% include "ui/partials/_task_meta.html" with task=t only %}
                      <div class="text-xs text-brand-dark/70 flex items-center gap-1 flex-wrap mt-1">
                        {% if t.company %}
                          <span>{{ t.company.name }}</span>
                          {% with guessed=t.company.address|guess_ru_tz %}
                          {% with tz=t.company.work_timezone|default:guessed %}
                            {% if tz %}
                              <span class="badge badge-warn badge-xxxs" title="{{ tz }}" data-live-worktime="1" data-company-id="{{ t.company.id }}">
                                <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                                · {{ tz|tz_label }}
                              </span>
                              <span class="hidden" data-work-schedule-display="1" data-company-id="{{ t.company.id }}">{{ t.company.work_schedule|default:"" }}</span>
                            {% endif %}
                          {% endwith %}
                          {% endwith %}
                        {% endif %}
                      </div>
                      {% if t.due_at %}
                        <div class="mt-1.5 flex items-center gap-1.5 text-red-700 font-semibold">
                          <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 2v3M16 2v3M3 6h18M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6"/>
                          </svg>
                          <span>{{ t.due_at|date:"d.m.Y H:i" }}</span>
                        </div>
                      {% endif %}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %} text-xs">{{ t.get_status_display }}</span>
                    </div>
                  </div>
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">Нет просроченных задач</div>
            <div class="text-xs text-brand-dark/50">Отлично! Все задачи в срок.</div>
          </div>
        {% endif %}
      </section>

      <section class="card card-pad dashboard-card" id="section-contracts">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">
            Договоры
            {% if contracts_soon %}
              <span class="ml-2 badge {% if contracts_soon|length > 0 and contracts_soon.0.level == 'danger' %}badge-danger{% else %}badge-warn{% endif %}">{{ contracts_soon|length }}</span>
            {% endif %}
          </div>
          {% if contracts_soon %}
            <a class="text-sm link" href="/companies/?contract_type=&q=">Список компаний</a>
          {% endif %}
        </div>
        {% if contracts_soon %}
          <ul class="space-y-2">
            {% for item in contracts_soon %}
              <li class="group">
                <a href="/companies/{{ item.company.id }}/" class="block rounded-lg border p-3 transition-all {% if item.level == 'danger' %}task-overdue border-red-400{% else %}bg-brand-orange/10 border-brand-orange/40{% endif %} hover:border-brand-teal/50 hover:bg-brand-soft/20">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1">
                      <div class="text-sm font-medium">
                        {{ item.company.name }}
                      </div>
                      <div class="text-xs text-brand-dark/70 mt-1">
                        {% if item.company.contract_type %}{{ item.company.contract_type.name }}{% else %}—{% endif %}
                        {% if item.company.contract_until %} · до <span class="{% if item.level == 'danger' %}text-red-700 font-medium{% endif %}">{{ item.company.contract_until|date:"d.m.Y" }}</span>{% endif %}
                      </div>
                    </div>
                    <span class="badge {% if item.level == 'danger' %}badge-danger{% else %}badge-warn{% endif %} flex-shrink-0">
                      {% if item.days_left is not None %}
                        {{ item.days_left }} дн.
                      {% else %}
                        —
                      {% endif %}
                    </span>
                  </div>
                </a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">Ближайших окончаний договоров нет</div>
            <div class="text-xs text-brand-dark/50">Все договоры в порядке</div>
          </div>
        {% endif %}
      </section>

      {# 3 строка: Задачи на неделю — на всю ширину для обычных пользователей, на половинку для РОП/директора (если есть запросы на удаление) #}
      <section class="card card-pad {% if (request.user.role == 'sales_head' or request.user.role == 'branch_director') and deletion_requests_count > 0 %}{% else %}lg:col-span-2{% endif %} dashboard-card">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="font-medium">
              Задачи на неделю
              {% if tasks_week_count > 0 %}
                <span class="ml-2 badge badge-progress">{{ tasks_week_count }}</span>
              {% endif %}
            </div>
            {% if week_monday and week_sunday %}
              <div class="text-xs text-brand-dark/60 mt-0.5">
                с {{ week_monday|date:"d.m.Y" }} по {{ week_sunday|date:"d.m.Y" }}
              </div>
            {% endif %}
          </div>
          {% if tasks_week_count > 3 %}
            <a class="text-sm link" href="/tasks/?mine=1">
              Посмотреть все
              <span class="text-xs text-brand-dark/60">({{ tasks_week_count }})</span>
            </a>
          {% endif %}
        </div>
        {% if tasks_week %}
          <ul class="space-y-2">
            {% for t in tasks_week %}
              <li>
                <button type="button" class="w-full text-left rounded-lg border border-brand-soft p-3 transition-all hover:border-brand-teal/50 hover:bg-brand-soft/20 {% if t.due_at and today_start and t.due_at < today_start and t.status != 'done' and t.status != 'cancelled' %}border-red-300 bg-red-50/50{% endif %}" data-view-task data-task-id="{{ t.id }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        {% if t.type %}
                          {% include "ui/partials/task_type_badge.html" with task_type=t.type only %}
                        {% else %}
                          <div class="text-sm font-medium">{{ t.title }}</div>
                        {% endif %}
                      </div>
                      {% if t.description %}
                        <div class="text-xs text-brand-dark/70 mt-1 mb-1" style="line-height:1.4">{{ t.description|truncatechars:100 }}</div>
                      {% endif %}
                      {% include "ui/partials/_task_meta.html" with task=t only %}
                      <div class="text-xs text-brand-dark/70 flex items-center gap-1 flex-wrap mt-1">
                        {% if t.company %}<span>{{ t.company.name }}</span>{% endif %}
                      </div>
                      {% if t.due_at %}
                        <div class="mt-1.5 flex items-center gap-1.5 {% if t.due_at and today_start and t.due_at < today_start and t.status != 'done' and t.status != 'cancelled' %}text-red-700 font-semibold{% else %}text-brand-dark/80 font-medium{% endif %}">
                          <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 2v3M16 2v3M3 6h18M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6"/>
                          </svg>
                          <span>{{ t.due_at|date:"d.m.Y H:i" }}</span>
                        </div>
                      {% endif %}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %} text-xs">{{ t.get_status_display }}</span>
                    </div>
                  </div>
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="w-12 h-12 text-brand-dark/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M8 2v3M16 2v3M3 6h18M4 6v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6"/>
              <path d="M7 10h10M7 14h10"/>
            </svg>
            <div class="text-sm font-medium text-brand-dark/70 mb-1">На ближайшую неделю задач нет</div>
            <div class="text-xs text-brand-dark/50 mb-4">Задачи на неделю появятся здесь</div>
            <button type="button" class="btn btn-outline text-xs" data-create-task>+ Создать задачу</button>
          </div>
        {% endif %}
      </section>

      {# Блок запросов на удаление для РОП/директора #}
      {% if deletion_requests_count > 0 %}
        <section class="card card-pad dashboard-card">
          <div class="flex items-center justify-between mb-3">
            <div class="font-medium">
              Запросы на удаление
              <span class="ml-2 badge badge-progress">{{ deletion_requests_count }}</span>
            </div>
            {% if deletion_requests_count > 3 %}
              <a class="text-sm link" href="/companies/?deletion_requests=1">
                Показать все
                <span class="text-xs text-brand-dark/60">({{ deletion_requests_count }})</span>
              </a>
            {% endif %}
          </div>
          <ul class="space-y-2">
            {% for req in deletion_requests %}
              <li>
                <div class="rounded-lg border border-brand-soft p-3 hover:bg-brand-soft/20 transition-colors">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <div class="text-sm font-medium mb-1">
                        {% if req.company %}
                          <a href="/companies/{{ req.company.id }}/" class="link">{{ req.company.name }}</a>
                        {% else %}
                          {{ req.company_name_snapshot }}
                        {% endif %}
                      </div>
                      {% if req.requested_by %}
                        <div class="text-xs text-brand-dark/70 mb-1">
                          Запросил: {{ req.requested_by.last_name }} {{ req.requested_by.first_name|slice:":1" }}.
                        </div>
                      {% endif %}
                      {% if req.note %}
                        <div class="text-xs text-brand-dark/60 mt-1">{{ req.note|truncatewords:15 }}</div>
                      {% endif %}
                      <div class="text-xs text-brand-dark/50 mt-1">{{ req.created_at|date:"d.m.Y H:i" }}</div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      {% if req.company %}
                        <a href="/companies/{{ req.company.id }}/" class="btn btn-outline btn-sm">Открыть</a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        </section>
      {% endif %}
    </div>

    {# Модальное окно для создания задачи #}
    <div id="taskCreateModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-task-create-modal></div>
      <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
        <div id="taskCreateModalContent"></div>
      </div>
    </div>

    {# Модальное окно для редактирования задачи #}
    <div id="taskEditModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-task-modal></div>
      <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
        <div id="taskEditModalContent"></div>
      </div>
    </div>

    {# Модальное окно для просмотра задачи #}
    <div id="taskViewModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-task-view></div>
      <div class="absolute inset-x-4 top-12 mx-auto max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3 mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2" id="taskViewBadges"></div>
              <h2 class="text-xl font-semibold text-brand-dark" id="taskViewTitle">Загрузка...</h2>
            </div>
            <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-view aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <div id="taskViewContent">
            <div class="text-center py-8">
              <svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-6.219-8.56"/>
              </svg>
              <div class="text-sm text-brand-dark/70">Загрузка задачи...</div>
            </div>
          </div>
          {# Кнопки действий #}
          <div class="flex flex-wrap items-center gap-2 pt-4 mt-4 border-t" id="taskViewActions" style="display:none">
            <button type="button" class="btn btn-outline text-sm" id="taskViewEdit" style="display:none">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
              </svg>
              Редактировать
            </button>
            <form method="post" action="" id="taskViewInProgressForm" style="display:none" class="inline">
              {% csrf_token %}
              <button type="submit" name="status" value="in_progress" class="btn btn-secondary text-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
                  <path d="M8 2v4"/><path d="M16 2v4"/><path d="M8 10h8"/><path d="M8 14h8"/>
                </svg>
                В работу
              </button>
            </form>
            <button type="button" class="btn btn-primary text-sm" id="taskViewComplete" style="display:none">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Выполнено
            </button>
            <button type="button" class="btn btn-outline text-sm" id="taskViewDelete" style="display:none;border-color:rgba(239,68,68,.35);color:#b91c1c;background:rgba(239,68,68,.06)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7"/>
              </svg>
              Удалить
            </button>
          </div>
        </div>
      </div>
    </div>

    {# Модальное окно для выполнения задачи #}
    <div id="taskCompleteModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-task-complete-modal></div>
      <div class="absolute inset-x-4 top-12 mx-auto max-w-md">
        <div class="bg-white border rounded-2xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Отметить задачу как выполненную?</h2>
            <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-complete-modal aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <div class="space-y-4">
            <p class="text-sm text-brand-dark/70">Нужно ли перенести данные задачи в заметки?</p>
            <div class="flex gap-2 pt-2 border-t">
              <button type="button" class="btn btn-primary flex-1" id="taskCompleteWithNote">Да, перенести</button>
              <button type="button" class="btn btn-outline flex-1" id="taskCompleteWithoutNote">Нет, только выполнить</button>
              <button type="button" class="btn btn-outline" data-close-task-complete-modal>Отмена</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Модальное окно для удаления задачи #}
    <div id="taskDeleteModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-task-delete-modal></div>
      <div class="absolute inset-x-4 top-12 mx-auto max-w-md">
        <div class="bg-white border rounded-2xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Удалить задачу?</h2>
            <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-delete-modal aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <div class="space-y-4">
            <p class="text-sm text-brand-dark/70">Нужно ли перенести данные задачи в заметки перед удалением?</p>
            <div class="flex gap-2 pt-2 border-t">
              <button type="button" class="btn btn-primary flex-1" id="taskDeleteWithNote">Да, перенести</button>
              <button type="button" class="btn btn-outline flex-1" id="taskDeleteWithoutNote">Нет, удалить</button>
              <button type="button" class="btn btn-outline" data-close-task-delete-modal>Отмена</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="coldCallsModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-coldcalls></div>
      <div class="absolute inset-x-4 top-24 mx-auto max-w-2xl">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium" id="coldCallsTitle">Отчёт</div>
              <div class="text-xs muted-2 mt-1" id="coldCallsSub">—</div>
            </div>
            <button type="button" class="btn btn-outline btn-sm" data-close-coldcalls aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <div class="mt-3 flex flex-wrap items-center gap-2">
            <select id="coldCallsDaySelect" class="w-full md:w-auto rounded-lg border px-3 py-2 text-sm hidden"></select>
            <select id="coldCallsMonthSelect" class="w-full md:w-auto rounded-lg border px-3 py-2 text-sm hidden"></select>
            <button type="button" class="btn btn-outline" id="coldCallsRefresh">Обновить</button>
            <button type="button" class="btn btn-primary" id="coldCallsCopy">Скопировать отчёт</button>
          </div>
          <div class="mt-3">
            <textarea id="coldCallsText" class="textarea" rows="12" readonly></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const modal = document.getElementById('coldCallsModal');
      const titleEl = document.getElementById('coldCallsTitle');
      const subEl = document.getElementById('coldCallsSub');
      const txtEl = document.getElementById('coldCallsText');
      const monthSel = document.getElementById('coldCallsMonthSelect');
      const daySel = document.getElementById('coldCallsDaySelect');
      const btnDay = document.getElementById('openColdDay');
      const btnMonth = document.getElementById('openColdMonth');
      const btnCopy = document.getElementById('coldCallsCopy');
      const btnRefresh = document.getElementById('coldCallsRefresh');
      if(!modal || !titleEl || !subEl || !txtEl || !btnCopy) return;

      let mode = 'day'; // day|month
      let monthKey = '';
      let selectedDate = '';

      function open(){ modal.classList.remove('hidden'); }
      function close(){ modal.classList.add('hidden'); }
      modal.querySelectorAll('[data-close-coldcalls]').forEach(b => b.addEventListener('click', close));
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') close(); });

      async function loadDay(){
        mode = 'day';
        if(monthSel) monthSel.classList.add('hidden');
        if(daySel) daySel.classList.remove('hidden');
        titleEl.textContent = 'Отчёт по холодным звонкам (день)';
        subEl.textContent = 'Загружаю…';
        txtEl.value = '';

        // Подгружаем список последних 7 дней (для выбора даты)
        try{
          const resDays = await fetch('/reports/cold-calls/last-7-days/', {credentials:'same-origin'});
          const daysData = await resDays.json().catch(() => null);
          if(daysData && daysData.ok && daySel){
            daySel.innerHTML = '';
            (daysData.days || []).forEach(d => {
              const opt = document.createElement('option');
              opt.value = d.date;
              opt.textContent = `${d.label} (${d.count})`;
              daySel.appendChild(opt);
            });
            if(selectedDate){
              daySel.value = selectedDate;
            }else{
              // по умолчанию сегодня (первый/последний — зависит от порядка; у нас от старого к новому)
              if(daySel.options.length) daySel.value = daySel.options[daySel.options.length - 1].value;
              selectedDate = daySel.value;
            }
          }
        }catch(_e){}

        const q = selectedDate ? `?date=${encodeURIComponent(selectedDate)}` : '';
        const res = await fetch('/reports/cold-calls/day/' + q, {credentials:'same-origin'});
        const data = await res.json().catch(() => null);
        if(!data || !data.ok) { subEl.textContent = 'Не удалось загрузить отчёт.'; return; }
        subEl.textContent = `Дата: ${data.date} · Всего: ${data.count}`;
        txtEl.value = data.text || '';
      }

      function fillMonthOptions(opts){
        if(!monthSel) return;
        monthSel.innerHTML = '';
        (opts || []).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.key;
          opt.textContent = o.label;
          monthSel.appendChild(opt);
        });
        monthSel.classList.remove('hidden');
      }

      async function loadWeek(){
        // удалено: отдельный "отчёт за 7 дней" не нужен, оставляем выбор дня из последних 7 дней
      }

      async function loadMonth(){
        mode = 'month';
        if(daySel) daySel.classList.add('hidden');
        titleEl.textContent = 'Отчёт по холодным звонкам (месяц)';
        subEl.textContent = 'Загружаю…';
        txtEl.value = '';
        const q = monthKey ? `?month=${encodeURIComponent(monthKey)}` : '';
        const res = await fetch('/reports/cold-calls/month/' + q, {credentials:'same-origin'});
        const data = await res.json().catch(() => null);
        if(!data || !data.ok) { subEl.textContent = 'Не удалось загрузить отчёт.'; return; }
        fillMonthOptions(data.available_months || []);
        if(monthSel && data.month) {
          monthSel.value = data.month;
          monthKey = data.month;
        }
        subEl.textContent = `${data.month_label} · Всего: ${data.count}`;
        txtEl.value = data.text || '';
      }

      if(monthSel){
        monthSel.addEventListener('change', () => {
          monthKey = monthSel.value || '';
          loadMonth();
        });
      }
      if(daySel){
        daySel.addEventListener('change', () => {
          selectedDate = daySel.value || '';
          loadDay();
        });
      }
      if(btnRefresh){
        btnRefresh.addEventListener('click', () => {
          if(mode === 'month') loadMonth();
          else loadDay();
        });
      }
      if(btnDay){
        btnDay.addEventListener('click', () => { selectedDate = ''; open(); loadDay(); });
      }
      if(btnMonth){
        btnMonth.addEventListener('click', () => { open(); loadMonth(); });
      }
      btnCopy.addEventListener('click', async () => {
        const text = txtEl.value || '';
        try{
          await navigator.clipboard.writeText(text);
          btnCopy.textContent = 'Скопировано';
          setTimeout(() => btnCopy.textContent = 'Скопировать отчёт', 1200);
        }catch(_e){
          // fallback
          txtEl.focus();
          txtEl.select();
          document.execCommand('copy');
        }
      });
    })();
  </script>

  {# Модальное окно для просмотра задач с кнопками действий #}
  <script>
    (function(){
      const modal = document.getElementById('taskViewModal');
      const modalContent = document.getElementById('taskViewContent');
      const modalTitle = document.getElementById('taskViewTitle');
      const modalBadges = document.getElementById('taskViewBadges');
      const modalActions = document.getElementById('taskViewActions');
      const btnEdit = document.getElementById('taskViewEdit');
      const btnInProgress = document.getElementById('taskViewInProgressForm');
      const btnComplete = document.getElementById('taskViewComplete');
      const btnDelete = document.getElementById('taskViewDelete');
      
      if(!modal || !modalContent || !modalTitle) return;

      // Используем глобальную переменную для передачи taskId между скриптами
      window.currentDashboardTaskId = null;
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

      function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '<div class="text-center py-8"><svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg><div class="text-sm text-brand-dark/70">Загрузка задачи...</div></div>';
        modalTitle.textContent = 'Загрузка...';
        if(modalBadges) modalBadges.innerHTML = '';
        if(modalActions) modalActions.style.display = 'none';
        window.currentDashboardTaskId = null;
      }

      function openModal() {
        modal.classList.remove('hidden');
      }

      // Закрытие модалки
      modal.querySelectorAll('[data-close-task-view]').forEach(btn => {
        btn.addEventListener('click', closeModal);
      });
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if(e.target === e.currentTarget) closeModal();
      });

      // Открытие задачи в модальном окне
      document.querySelectorAll('[data-view-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const taskId = this.dataset.taskId;
          if(!taskId) return;
          
          window.currentDashboardTaskId = taskId;
          openModal();
          
          try {
            // Используем оптимизированный endpoint для просмотра задачи
            const res = await fetch(`/tasks/${taskId}/`, {
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if(!res.ok) throw new Error('Ошибка загрузки задачи');
            const html = await res.text();
            
            // Парсим HTML и извлекаем модальное окно
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const taskModal = doc.querySelector('#taskViewModal');
            
            if(taskModal) {
              const card = taskModal.querySelector('.card');
              if(card) {
                // Извлекаем контент (секция space-y-3 с информацией о задаче)
                const contentDiv = card.querySelector('.space-y-3');
                if(contentDiv) {
                  modalContent.innerHTML = contentDiv.outerHTML;
                } else {
                  // Fallback: берем весь контент кроме заголовка
                  const allContent = card.innerHTML;
                  const titleMatch = allContent.match(/<h2[^>]*>.*?<\/h2>/);
                  modalContent.innerHTML = allContent.replace(titleMatch?.[0] || '', '');
                }
                
                const titleEl = taskModal.querySelector('h2');
                if(titleEl) modalTitle.textContent = titleEl.textContent.trim();
                
                // Извлекаем бейдж статуса и кнопку редактирования
                const badgeContainer = taskModal.querySelector('.flex.items-center.gap-2');
                if(badgeContainer && modalBadges) {
                  // Ищем badge (может быть обычный badge или task_type_badge)
                  const badge = badgeContainer.querySelector('.badge, .inline-flex.items-center.gap-1');
                  if(badge) modalBadges.innerHTML = badge.outerHTML;
                }
                
                // Извлекаем данные задачи для определения прав
                // Ищем кнопку редактирования в ВСЕМ модальном окне (может быть ссылка или кнопка с data-edit-task)
                const editLink = taskModal.querySelector('a[href*="/tasks/"][href*="/edit/"]');
                const editButton = taskModal.querySelector('button[data-edit-task]');
                const canEdit = editLink || editButton;
                
                // Определяем статус по классам badge или по тексту
                const statusBadge = taskModal.querySelector('.badge');
                let status = 'new';
                if(statusBadge) {
                  const badgeClasses = statusBadge.className;
                  if(badgeClasses.includes('badge-new')) status = 'new';
                  else if(badgeClasses.includes('badge-progress')) status = 'in_progress';
                  else if(badgeClasses.includes('badge-done')) status = 'done';
                  else if(badgeClasses.includes('badge-cancel')) status = 'cancelled';
                  else {
                    // Fallback: определяем по тексту
                    const statusText = statusBadge.textContent?.trim() || '';
                    if(statusText === 'Новая' || statusText.toLowerCase().includes('новая')) status = 'new';
                    else if(statusText === 'В работе' || statusText.toLowerCase().includes('работа')) status = 'in_progress';
                    else if(statusText === 'Выполнена' || statusText.toLowerCase().includes('выполнена')) status = 'done';
                    else if(statusText === 'Отменена' || statusText.toLowerCase().includes('отменена')) status = 'cancelled';
                  }
                }
                
                // Показываем кнопки действий с учетом прав и статуса
                if(modalActions) {
                  modalActions.style.display = 'flex';
                  
                  // Редактировать - показываем если есть кнопка или ссылка на редактирование
                  if(btnEdit) {
                    btnEdit.style.display = canEdit ? 'inline-flex' : 'none';
                    if(canEdit) {
                      btnEdit.onclick = async () => {
                        const url = `/tasks/${taskId}/edit/?modal=1`;
                        try {
                          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                          if (!res.ok) throw new Error('Ошибка загрузки формы');
                          const html = await res.text();
                          const editModal = document.getElementById('taskEditModal');
                          const editModalContent = document.getElementById('taskEditModalContent');
                          if (editModal && editModalContent) {
                            editModalContent.innerHTML = html;
                            editModal.classList.remove('hidden');
                            // Закрываем текущее модальное окно просмотра
                            taskViewModal.classList.add('hidden');
                            // Инициализация select с небольшой задержкой для гарантии обновления DOM
                            setTimeout(function() {
                              if (window.initTaskTypeSelects) {
                                window.initTaskTypeSelects();
                              }
                            }, 100);
                            // Обработка формы редактирования
                            const form = editModalContent.querySelector('[data-task-edit-form]');
                            if (form) {
                              form.addEventListener('submit', async function(e) {
                                e.preventDefault();
                                const formData = new FormData(form);
                                try {
                                  const res = await fetch(form.action, {
                                    method: 'POST',
                                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                                    body: formData
                                  });
                                  const data = await res.json();
                                  if (data.ok) {
                                    editModal.classList.add('hidden');
                                    location.reload();
                                  } else {
                                    alert('Ошибка: ' + (data.error || 'Не удалось сохранить'));
                                  }
                                } catch (err) {
                                  alert('Ошибка при сохранении: ' + err.message);
                                }
                              }, { once: true });
                            }
                          }
                        } catch (err) {
                          alert('Ошибка загрузки формы: ' + err.message);
                        }
                      };
                    }
                  }
                  
                  // В работу - показываем только если статус "Новая"
                  if(btnInProgress) {
                    btnInProgress.style.display = (status === 'new') ? 'inline-block' : 'none';
                    if(status === 'new') {
                      btnInProgress.action = `/tasks/${taskId}/status/`;
                      // Добавляем обработчик для AJAX отправки формы
                      const submitBtn = btnInProgress.querySelector('button[type="submit"]');
                      if(submitBtn && !btnInProgress.__ajaxBound) {
                        btnInProgress.__ajaxBound = true;
                        btnInProgress.addEventListener('submit', async function(e) {
                          e.preventDefault();
                          const formData = new FormData(btnInProgress);
                          formData.append('csrfmiddlewaretoken', csrftoken);
                          
                          try {
                            const res = await fetch(btnInProgress.action, {
                              method: 'POST',
                              body: formData,
                              headers: {'X-Requested-With': 'XMLHttpRequest'}
                            });
                            const data = await res.json();
                            if(data.success) {
                              window.location.reload();
                            } else {
                              alert(data.error || 'Ошибка при изменении статуса задачи');
                            }
                          } catch(err) {
                            alert('Ошибка: ' + err.message);
                          }
                        });
                      }
                    }
                  }
                  
                  // Выполнено - показываем если статус не "Выполнена"
                  if(btnComplete) {
                    btnComplete.style.display = (status !== 'done') ? 'inline-flex' : 'none';
                  }
                  
                  // Удалить - показываем всегда (права проверит сервер)
                  if(btnDelete) {
                    btnDelete.style.display = 'inline-flex';
                  }
                }
              }
            } else {
              throw new Error('Не удалось загрузить задачу');
            }
          } catch(e) {
            console.error('Task view error:', e);
            modalContent.innerHTML = '<div class="text-center py-8 text-red-600">Ошибка загрузки задачи</div>';
            modalTitle.textContent = 'Ошибка';
            if(modalActions) modalActions.style.display = 'none';
          }
        });
      });

      // Обработка кнопки "Выполнено"
      if(btnComplete) {
        btnComplete.addEventListener('click', function() {
          if(!window.currentDashboardTaskId) return;
          const completeModal = document.getElementById('taskCompleteModal');
          if(completeModal) completeModal.classList.remove('hidden');
        });
      }

      // Обработка кнопки "Удалить"
      if(btnDelete) {
        btnDelete.addEventListener('click', function() {
          if(!window.currentDashboardTaskId) return;
          const deleteModal = document.getElementById('taskDeleteModal');
          if(deleteModal) deleteModal.classList.remove('hidden');
        });
      }
    })();
  </script>

  <script>
    (function() {
      // Модальное окно для создания задачи
      const createModal = document.getElementById('taskCreateModal');
      const createModalContent = document.getElementById('taskCreateModalContent');
      if (!createModal || !createModalContent) return;

      function closeCreateModal() {
        createModal.classList.add('hidden');
        createModalContent.innerHTML = '';
      }

      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-close-task-create-modal]');
        if (closeBtn) {
          e.preventDefault();
          closeCreateModal();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !createModal.classList.contains('hidden')) closeCreateModal();
      });
      createModal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeCreateModal();
      });

      // Создание задачи
      document.querySelectorAll('[data-create-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const companyId = this.dataset.companyId || '';
          const url = `/tasks/new/?modal=1${companyId ? '&company=' + companyId : ''}`;
          
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Ошибка загрузки формы');
            const html = await res.text();
            createModalContent.innerHTML = html;
            createModal.classList.remove('hidden');
            
            // Инициализация select с небольшой задержкой для гарантии обновления DOM
            setTimeout(function() {
              if (window.initTaskTypeSelects) {
                window.initTaskTypeSelects();
              }
              // Инициализация виджета выбора компании
              if (window.initMsSingleWidgets) {
                window.initMsSingleWidgets(createModalContent);
                
                // Устанавливаем выбранную компанию после инициализации виджета
                if (companyId) {
                  const companySelect = createModalContent.querySelector('select[name="company"], select#id_company');
                  if (companySelect) {
                    companySelect.value = companyId;
                    companySelect.dispatchEvent(new Event('change', { bubbles: true }));
                    const msWidget = companySelect.closest('[data-ms-single="1"]');
                    if (msWidget) {
                      const valueEl = msWidget.querySelector('.ms-value');
                      const selectedOption = companySelect.options[companySelect.selectedIndex];
                      if (valueEl && selectedOption) {
                        valueEl.textContent = selectedOption.textContent.trim();
                      }
                    }
                    fetch(`/companies/autocomplete/?id=${encodeURIComponent(companyId)}`, {
                      headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(res => res.json())
                    .then(data => {
                      const company = (data.items || [])[0];
                      if (!company) return;
                      const opt = Array.from(companySelect.options).find(o => o.value === companyId);
                      if (!opt) return;
                      opt.dataset.isBranch = company.is_branch ? '1' : '0';
                      opt.dataset.hasBranches = company.has_branches ? '1' : '0';
                      if (window.updateApplyToOrgForModal) {
                        window.updateApplyToOrgForModal(createModalContent);
                      }
                    })
                    .catch(() => {});
                  }
                }
              }
            }, 100);
            
            const form = createModalContent.querySelector('[data-task-create-form]');
            if (form) {
              const typeSelect = form.querySelector('#id_type');
              const typeErrorBox = form.querySelector('[data-task-type-error]');
              const defaultTypeErrorMsg = 'Пожалуйста, выберите тип задачи в поле «Задача».';

              function setTypeError(msg) {
                if (!typeErrorBox) return;
                const m = (msg || '').trim();
                typeErrorBox.textContent = m;
                typeErrorBox.classList.toggle('hidden', !m);
              }

              if (typeSelect) {
                typeSelect.addEventListener('change', () => {
                  const hasValue = Boolean(typeSelect.value && typeSelect.value !== '0');
                  setTypeError(hasValue ? '' : defaultTypeErrorMsg);
                });
              }

              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                try {
                  const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                  });
                  const data = await res.json();
                  if (data.ok) {
                    closeCreateModal();
                    location.reload();
                  } else {
                    let fieldMessage = '';
                    if (data.errors && data.errors.type) {
                      if (Array.isArray(data.errors.type)) {
                        fieldMessage = data.errors.type.join(', ');
                      } else if (typeof data.errors.type === 'object' && data.errors.type.length) {
                        fieldMessage = Array.from(data.errors.type).join(', ');
                      } else {
                        fieldMessage = String(data.errors.type);
                      }
                    }
                    const msg = fieldMessage || data.error || 'Проверьте заполнение формы задачи.';

                    setTypeError(fieldMessage || '');

                    if (!fieldMessage && window.uiToast) {
                      window.uiToast(msg, 'error');
                    } else if (!fieldMessage) {
                      console.warn('Ошибка создания задачи:', msg);
                    }
                  }
                } catch (err) {
                  if (window.uiToast) {
                    window.uiToast('Ошибка при создании задачи: ' + err.message, 'error');
                  } else {
                    console.error('Ошибка при создании задачи:', err);
                  }
                }
              }, { once: true });
            }
          } catch (err) {
            alert('Ошибка загрузки формы: ' + err.message);
          }
        });
      });

      // Модальное окно для редактирования задачи
      const editModal = document.getElementById('taskEditModal');
      const editModalContent = document.getElementById('taskEditModalContent');
      if (editModal && editModalContent) {
        function closeEditModal() {
          editModal.classList.add('hidden');
          editModalContent.innerHTML = '';
        }

        document.addEventListener('click', (e) => {
          const closeBtn = e.target.closest('[data-close-task-modal]');
          if (closeBtn) {
            e.preventDefault();
            closeEditModal();
          }
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !editModal.classList.contains('hidden')) closeEditModal();
        });
        editModal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) closeEditModal();
        });

        // Редактирование задачи
        document.querySelectorAll('[data-edit-task]').forEach(btn => {
          btn.addEventListener('click', async function() {
            const taskId = this.dataset.taskId;
            const url = `/tasks/${taskId}/edit/?modal=1`;
            
            try {
              const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
              if (!res.ok) throw new Error('Ошибка загрузки формы');
              const html = await res.text();
              editModalContent.innerHTML = html;
              editModal.classList.remove('hidden');
              
              // Закрываем модальное окно просмотра, если открыто
              const viewModal = document.getElementById('taskViewModal');
              if (viewModal) viewModal.classList.add('hidden');
              
              // Инициализация select с небольшой задержкой для гарантии обновления DOM
              setTimeout(function() {
                if (window.initTaskTypeSelects) {
                  window.initTaskTypeSelects();
                }
              }, 100);
              
              const form = editModalContent.querySelector('[data-task-edit-form]');
              if (form) {
                form.addEventListener('submit', async function(e) {
                  e.preventDefault();
                  const formData = new FormData(form);
                  try {
                    const res = await fetch(form.action, {
                      method: 'POST',
                      headers: { 'X-Requested-With': 'XMLHttpRequest' },
                      body: formData
                    });
                    const data = await res.json();
                    if (data.ok) {
                      closeEditModal();
                      location.reload();
                    } else {
                      alert('Ошибка: ' + (data.error || 'Не удалось сохранить'));
                    }
                  } catch (err) {
                    alert('Ошибка при сохранении: ' + err.message);
                  }
                }, { once: true });
              }
            } catch (err) {
              alert('Ошибка загрузки формы: ' + err.message);
            }
          });
        });
      }
    })();
  </script>

  {# Модальные окна для выполнения и удаления задач #}
  <script>
    (function(){
      // Используем глобальную переменную для хранения taskId
      window.currentDashboardTaskId = null;
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

      // Модальное окно выполнения задачи
      const completeModal = document.getElementById('taskCompleteModal');
      const btnComplete = document.getElementById('taskViewComplete');
      
      if(completeModal) {
        function closeCompleteModal() {
          completeModal.classList.add('hidden');
        }

        completeModal.querySelectorAll('[data-close-task-complete-modal]').forEach(b => {
          b.addEventListener('click', closeCompleteModal);
        });
        document.addEventListener('keydown', (e) => {
          if(e.key === 'Escape' && !completeModal.classList.contains('hidden')) closeCompleteModal();
        });
        completeModal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
          if(e.target === e.currentTarget) closeCompleteModal();
        });

        // Открытие модального окна выполнения
        if(btnComplete) {
          btnComplete.addEventListener('click', function() {
            if(window.currentDashboardTaskId) {
              completeModal.classList.remove('hidden');
            }
          });
        }

        document.getElementById('taskCompleteWithNote')?.addEventListener('click', function() {
          if(!window.currentDashboardTaskId) return;
          const formData = new FormData();
          formData.append('status', 'done');
          formData.append('save_to_notes', '1');
          formData.append('csrfmiddlewaretoken', csrftoken);
          
          fetch(`/tasks/${window.currentDashboardTaskId}/status/`, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
          })
          .then(r => r.json())
          .then(data => {
            if(data.success) {
              window.location.reload();
            } else {
              alert(data.error || 'Ошибка при выполнении задачи');
            }
          })
          .catch(err => alert('Ошибка: ' + err.message));
        });

        document.getElementById('taskCompleteWithoutNote')?.addEventListener('click', function() {
          if(!window.currentDashboardTaskId) return;
          const formData = new FormData();
          formData.append('status', 'done');
          formData.append('save_to_notes', '0');
          formData.append('csrfmiddlewaretoken', csrftoken);
          
          fetch(`/tasks/${window.currentDashboardTaskId}/status/`, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
          })
          .then(r => r.json())
          .then(data => {
            if(data.success) {
              window.location.reload();
            } else {
              alert(data.error || 'Ошибка при выполнении задачи');
            }
          })
          .catch(err => alert('Ошибка: ' + err.message));
        });
      }

      // Модальное окно удаления задачи
      const deleteModal = document.getElementById('taskDeleteModal');
      
      if(deleteModal) {
        function closeDeleteModal() {
          deleteModal.classList.add('hidden');
        }

        deleteModal.querySelectorAll('[data-close-task-delete-modal]').forEach(b => {
          b.addEventListener('click', closeDeleteModal);
        });
        document.addEventListener('keydown', (e) => {
          if(e.key === 'Escape' && !deleteModal.classList.contains('hidden')) closeDeleteModal();
        });
        deleteModal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
          if(e.target === e.currentTarget) closeDeleteModal();
        });

        // Открытие модального окна удаления
        const btnDeleteView = document.getElementById('taskViewDelete');
        if(btnDeleteView) {
          btnDeleteView.addEventListener('click', function() {
            if(window.currentDashboardTaskId) {
              deleteModal.classList.remove('hidden');
            }
          });
        }

        document.getElementById('taskDeleteWithNote')?.addEventListener('click', function() {
          if(!window.currentDashboardTaskId) return;
          const formData = new FormData();
          formData.append('save_to_notes', '1');
          formData.append('csrfmiddlewaretoken', csrftoken);
          
          fetch(`/tasks/${window.currentDashboardTaskId}/delete/`, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
          })
          .then(r => r.json())
          .then(data => {
            if(data.success) {
              window.location.reload();
            } else {
              alert(data.error || 'Ошибка при удалении задачи');
            }
          })
          .catch(err => alert('Ошибка: ' + err.message));
        });

        document.getElementById('taskDeleteWithoutNote')?.addEventListener('click', function() {
          if(!window.currentDashboardTaskId) return;
          const formData = new FormData();
          formData.append('save_to_notes', '0');
          formData.append('csrfmiddlewaretoken', csrftoken);
          
          fetch(`/tasks/${window.currentDashboardTaskId}/delete/`, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
          })
          .then(r => r.json())
          .then(data => {
            if(data.success) {
              window.location.reload();
            } else {
              alert(data.error || 'Ошибка при удалении задачи');
            }
          })
          .catch(err => alert('Ошибка: ' + err.message));
        });
      }
    })();
  </script>

  {# AJAX Polling с индикатором обновления #}
  <script>
    (function(){
      const updateIndicator = document.getElementById('dashboard-update-indicator');
      let pollInterval = null;
      let isPolling = false;
      
      function showUpdateIndicator() {
        if(updateIndicator) updateIndicator.classList.remove('hidden');
      }
      
      function hideUpdateIndicator() {
        if(updateIndicator) updateIndicator.classList.add('hidden');
      }
      
      async function pollDashboard() {
        if(isPolling) return;
        isPolling = true;
        showUpdateIndicator();
        
        try {
          const response = await fetch('/api/dashboard/poll/', {
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json' }
          });
          
          if(response.ok) {
            const data = await response.json();
            // Если есть изменения, можно обновить страницу или обновить только нужные секции
            // Пока просто скрываем индикатор
          }
        } catch(e) {
          console.error('Dashboard poll error:', e);
        } finally {
          hideUpdateIndicator();
          isPolling = false;
        }
      }
      
      // Запускаем polling каждые 30 секунд
      if(updateIndicator) {
        pollInterval = setInterval(pollDashboard, 30000);
        
        // Останавливаем polling при уходе со страницы
        window.addEventListener('beforeunload', () => {
          if(pollInterval) clearInterval(pollInterval);
        });
      }
    })();
  </script>
{% endblock %}


