{% for c in companies %}
  <div class="company-card-compact border-b border-brand-soft/50 hover:bg-brand-soft/20 transition-colors" data-company-id="{{ c.id }}" onclick="window.location='/companies/{{ c.id }}/'" style="cursor:pointer">
    <div class="px-4 py-3 flex items-start gap-3">
      <!-- Чекбокс для массовых операций -->
      <div class="pt-0.5" onclick="event.stopPropagation()">
        <input class="bulk-company" type="checkbox" name="company_ids" value="{{ c.id }}" form="bulkTransferForm" data-can-transfer="{% if c.can_transfer %}1{% else %}0{% endif %}" />
      </div>
      
      <!-- Основной контент -->
      <div class="flex-1 min-w-0 space-y-2">
        <!-- Верхняя строка: Название + статусы/маркеры -->
        <div class="flex items-start justify-between gap-3">
          <div class="flex-1 min-w-0">
            <a class="link font-semibold text-base hover:text-brand-orange" href="/companies/{{ c.id }}/" onclick="event.stopPropagation()">
              {% if search_query %}
                <span class="highlight-target" data-text="{{ c.name }}" data-query="{{ search_query }}">{{ c.name }}</span>
              {% else %}
                {{ c.name }}
              {% endif %}
            </a>
            {% if search_query and c.search_match_info %}
              {% if "название" not in c.search_match_info and "ИНН" not in c.search_match_info and "адрес" not in c.search_match_info %}
                <div class="text-xs mt-1" style="color: #f97316; font-weight: 500;">
                  Найдено: {{ c.search_match_info }}
                </div>
              {% endif %}
            {% endif %}
          </div>
          <div class="flex items-center gap-2 shrink-0 flex-wrap">
            {% if c.has_overdue %}
              <span class="badge badge-warn">Просрочки</span>
            {% endif %}
            {% if c.status %}
              <span class="badge">{{ c.status.name }}</span>
            {% endif %}
            {% if c.is_cold_call %}
              <span class="badge" style="background-color: #e0e7ff; color: #4338ca;">Холодный</span>
            {% endif %}
          </div>
        </div>
        
        <!-- Вторая строка: ИНН / регион / сферы -->
        <div class="flex items-center gap-3 text-sm text-brand-dark/70 flex-wrap">
          {% if c.inn %}
            <span>ИНН: {{ c.inn }}</span>
          {% endif %}
          {% if c.region %}
            <span>·</span>
            <span>{{ c.region.name }}</span>
          {% endif %}
          {% if c.spheres_list %}
            <span>·</span>
            <div class="flex items-center gap-1 flex-wrap">
              {% for s in c.spheres_list %}
                <span class="badge badge-sm">{{ s.name }}</span>
              {% endfor %}
              {% if c.spheres_more > 0 %}
                <span class="text-xs">+{{ c.spheres_more }}</span>
              {% endif %}
            </div>
          {% endif %}
          {% if c.responsible %}
            <span>·</span>
            <span>Ответственный: {{ c.responsible }}</span>
          {% endif %}
          {% if c.branch %}
            <span>·</span>
            <span>Филиал: {{ c.branch.name }}</span>
          {% endif %}
        </div>
        
        <!-- Блок заметки (на видном месте) -->
        <div class="mt-2">
          {% if c.display_note %}
            {% with display_note=c.display_note %}
              <div class="bg-brand-soft/30 rounded-lg px-3 py-2 border border-brand-soft/50">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-medium text-brand-dark/80">Заметка:</span>
                  {% if display_note.is_pinned %}
                    <span class="badge badge-warn badge-sm">Закреплено</span>
                  {% endif %}
                  {% if display_note.attachment %}
                    <svg class="w-3 h-3 text-brand-dark/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a2 2 0 00-2.828-2.828L9 10.172 7.172 8.343a4 4 0 115.656 5.656L15.172 7z"/>
                    </svg>
                  {% endif %}
                </div>
                <div class="text-sm text-brand-dark/90 whitespace-pre-line line-clamp-3" title="{{ display_note.text|truncatewords:50 }}">
                  {{ display_note.text|truncatewords:30 }}
                </div>
                <div class="text-xs text-brand-dark/60 mt-1">
                  {{ display_note.author|default:"—" }} · {{ display_note.created_at|date:"d.m.Y H:i" }}
                </div>
              </div>
            {% endwith %}
          {% else %}
            <div class="text-xs text-brand-dark/50 italic">Нет заметок</div>
          {% endif %}
        </div>
      </div>
      
      <!-- Быстрые действия (справа) -->
      <div class="flex items-center gap-1 shrink-0" onclick="event.stopPropagation()">
        <a href="/companies/{{ c.id }}/" class="btn btn-outline btn-sm" title="Открыть">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
          </svg>
        </a>
      </div>
    </div>
  </div>
{% empty %}
  <div class="px-4 py-8 text-center text-brand-dark/60">Ничего не найдено.</div>
{% endfor %}
