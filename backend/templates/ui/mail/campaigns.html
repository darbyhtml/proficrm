{% extends "ui/base.html" %}
{% block title %}Почта — CRM ПРОФИ{% endblock %}

{% block content %}
  <style>
    .btn-icon { transition: all 0.2s ease; }
    .btn-icon:hover { transform: translateY(-1px); }
    .card { transition: box-shadow 0.2s ease; }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    tr { transition: background-color 0.15s ease; }
    details summary { transition: color 0.2s ease; }
  </style>
  
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold">Кампании рассылок</h1>
        {% if is_admin %}
          <div class="muted text-sm">Управление рассылками и аналитика по пользователям</div>
        {% else %}
          <div class="muted text-sm">Создай кампанию → сгенерируй получателей → отправляй батчами.</div>
        {% endif %}
      </div>
      <div class="flex gap-2">
        {% if is_admin %}
          <a class="btn btn-outline" href="/mail/settings/">Настройки SMTP</a>
        {% endif %}
        <a class="btn btn-outline" href="/mail/signature/">Настройка подписи</a>
        <a class="btn btn-primary" href="/mail/campaigns/new/">+ Новая кампания</a>
      </div>
    </div>

    {# Информация о тарифе и квоте smtp.bz #}
    {% if quota %}
      {% if is_admin %}
        {# Полная информация для администратора #}
        <div class="card card-pad" id="quota-card">
          <div class="flex items-center justify-between gap-3 mb-3">
            <div class="font-medium">Тариф smtp.bz</div>
            <div class="flex items-center gap-2 text-xs">
              <span class="text-brand-dark/60" id="quota-auto-refresh-status">Автообновление включено</span>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem" onclick="window.__refreshQuota && window.__refreshQuota(true)">
                Обновить
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div>
              <div class="text-brand-dark/70 mb-1">Тариф:</div>
              <div class="font-medium" id="quota-tariff-name">{{ quota.tariff_name|default:"—" }}</div>
              {% if quota.tariff_renewal_date %}
                <div class="text-xs text-brand-dark/60 mt-1">
                  Продление: <span id="quota-renewal-date">{{ quota.tariff_renewal_date|date:"d.m.Y" }}</span>
                </div>
              {% endif %}
            </div>
            <div>
              <div class="text-brand-dark/70 mb-1">Доступно писем:</div>
              <div class="font-medium {% if quota.emails_available < quota.emails_limit|add:'-'|add:'100' %}text-orange-600{% elif quota.emails_available == 0 %}text-red-600{% else %}text-green-600{% endif %}">
                <span id="quota-emails-available">{{ quota.emails_available }}</span> / <span id="quota-emails-limit">{{ quota.emails_limit }}</span>
              </div>
              {% if quota.last_synced_at %}
                <div class="text-xs text-brand-dark/60 mt-1">
                  Обновлено: <span id="quota-last-synced">{{ quota.last_synced_at|date:"d.m.Y H:i" }}</span>
                </div>
              {% endif %}
            </div>
            <div>
              <div class="text-brand-dark/70 mb-1">Лимит в час:</div>
              <div class="font-medium">
                <span id="quota-sent-per-hour">{{ quota.sent_per_hour }}</span> / <span id="quota-max-per-hour">{{ quota.max_per_hour }}</span>
              </div>
              {% if quota.sync_error %}
                <div class="text-xs text-red-600 mt-1" id="quota-sync-error">
                  Ошибка синхронизации
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% else %}
        {# Упрощенная информация для менеджеров, директоров, РОП и управляющих #}
        <div class="card card-pad" id="quota-card">
          <div class="flex items-center justify-between gap-3 mb-3">
            <div class="font-medium">Лимиты отправки</div>
            <div class="flex items-center gap-2 text-xs">
              <span class="text-brand-dark/60" id="quota-auto-refresh-status">Автообновление включено</span>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem" onclick="window.__refreshQuota && window.__refreshQuota(true)">
                Обновить
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div>
              <div class="text-brand-dark/70 mb-1">Доступно писем на месяц:</div>
              <div class="font-medium {% if quota.emails_available < quota.emails_limit|add:'-'|add:'100' %}text-orange-600{% elif quota.emails_available == 0 %}text-red-600{% else %}text-green-600{% endif %}">
                <span id="quota-emails-available">{{ quota.emails_available }}</span> / <span id="quota-emails-limit">{{ quota.emails_limit }}</span>
              </div>
              {% if quota.tariff_renewal_date %}
                <div class="text-xs text-brand-dark/60 mt-1">
                  Авто-продление: <span id="quota-renewal-date">{{ quota.tariff_renewal_date|date:"d.m.Y" }}</span>
                </div>
              {% endif %}
              {% if quota.last_synced_at %}
                <div class="text-xs text-brand-dark/60 mt-1">
                  Обновлено: <span id="quota-last-synced">{{ quota.last_synced_at|date:"d.m.Y H:i" }}</span>
                </div>
              {% endif %}
            </div>
            <div>
              <div class="text-brand-dark/70 mb-1">Лимит в час (для всех):</div>
              <div class="font-medium">
                <span id="quota-sent-per-hour">{{ quota.sent_per_hour|default:0 }}</span> / <span id="quota-max-per-hour">{{ quota.max_per_hour|default:100 }}</span>
              </div>
            </div>
            <div>
              <div class="text-brand-dark/70 mb-1">Ваш лимит в день:</div>
              <div class="font-medium {% if user_limit_info.is_limit_reached %}text-red-600{% elif user_limit_info.remaining < 20 %}text-orange-600{% else %}text-green-600{% endif %}">
                {{ user_limit_info.sent_today }} / {{ user_limit_info.limit }}
              </div>
              {% if user_limit_info.remaining is not None %}
                <div class="text-xs text-brand-dark/60 mt-1">
                  Осталось: {{ user_limit_info.remaining }} писем
                </div>
              {% endif %}
            </div>
          </div>
          {% if user_limit_info.is_limit_reached %}
            <div class="mt-3 text-xs text-red-600">
              ⚠️ Достигнут дневной лимит отправки. Новые письма будут отправляться завтра.
            </div>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}

    {% if is_admin and analytics %}
      {# Аналитика для администратора — компактно #}
      <div class="card card-pad mb-4">
        <div class="flex items-center justify-between gap-3 mb-3">
          <div class="font-medium">Почта — аналитика (сегодня)</div>
          <button type="button" class="btn btn-outline" style="padding:.25rem .5rem" id="open-unsubscribes-modal">
            Отписки
          </button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 text-sm">
          <div>
            <div class="text-xs text-brand-dark/60">Отправлено</div>
            <div class="font-medium">{{ analytics.total_sent_today }}/{{ analytics.global_limit }}</div>
          </div>
          <div>
            <div class="text-xs text-brand-dark/60">Ошибки</div>
            <div class="font-medium {% if analytics.total_failed_today > 0 %}text-red-600{% endif %}">{{ analytics.total_failed_today }}</div>
          </div>
          <div>
            <div class="text-xs text-brand-dark/60">За час</div>
            <div class="font-medium">{{ analytics.sent_last_hour }}/{{ analytics.max_per_hour }}</div>
          </div>
          <div>
            <div class="text-xs text-brand-dark/60">Кампаний</div>
            <div class="font-medium">{{ analytics.campaigns_stats.total }}</div>
          </div>
          <div>
            <div class="text-xs text-brand-dark/60">Активных</div>
            <div class="font-medium text-green-600">{{ analytics.campaigns_stats.active }}</div>
          </div>
          <div>
            <div class="text-xs text-brand-dark/60">На паузе</div>
            <div class="font-medium text-orange-600">{{ analytics.campaigns_stats.paused }}</div>
          </div>
        </div>

        {% if analytics.smtp_bz %}
          <div class="mt-3 pt-3 border-t">
            <div class="text-xs text-brand-dark/60 mb-2">По данным smtp.bz (последняя минута кеша)</div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
              <div>
                <div class="text-xs text-brand-dark/60">Открытия</div>
                <div class="font-medium">{{ analytics.smtp_bz.opened|default:"—" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/60">Отписки</div>
                <div class="font-medium">{{ analytics.smtp_bz.unsub|default:"—" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/60">Bounce</div>
                <div class="font-medium">{{ analytics.smtp_bz.bounce|default:"—" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/60">Return</div>
                <div class="font-medium">{{ analytics.smtp_bz.return|default:"—" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/60">Cancel</div>
                <div class="font-medium">{{ analytics.smtp_bz.cancel|default:"—" }}</div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      <details class="card card-pad mb-4">
        <summary class="cursor-pointer font-medium">Пользователи (сегодня) — {{ analytics.user_stats|length }}</summary>
        <div class="mt-3 overflow-x-auto">
          <table class="table text-sm">
            <thead>
              <tr>
                <th>Пользователь</th>
                <th>Роль</th>
                <th>Отправлено</th>
                <th>Ошибки</th>
                <th>Кампании</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in analytics.user_stats %}
                <tr class="{% if stat.is_limit_reached %}bg-red-50{% endif %}">
                  <td class="font-medium">
                    {{ stat.user.get_full_name|default:stat.user.username }}
                    <div class="text-xs text-brand-dark/60">
                      {% if stat.user.branch %}{{ stat.user.branch.name }}{% endif %}
                    </div>
                  </td>
                  <td class="muted">{{ stat.user.get_role_display }}</td>
                  <td>
                    <span class="font-medium {% if stat.is_limit_reached %}text-red-600{% endif %}">{{ stat.sent_today }}</span>
                    <span class="muted">/ {{ stat.limit }}</span>
                    {% if stat.remaining is not None %}
                      <div class="text-xs text-brand-dark/60">осталось: {{ stat.remaining }}</div>
                    {% endif %}
                  </td>
                  <td>
                    <span class="font-medium {% if stat.failed_today > 0 %}text-red-600{% endif %}">{{ stat.failed_today }}</span>
                  </td>
                  <td class="muted">
                    <span>{{ stat.active_campaigns }}</span><span class="text-xs text-brand-dark/60"> активных</span>,
                    <span>{{ stat.campaigns_count }}</span><span class="text-xs text-brand-dark/60"> всего</span>
                  </td>
                </tr>
              {% empty %}
                <tr><td class="muted" colspan="5" style="padding:1rem">Нет данных</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>

      {% if analytics.queue_list %}
        <details class="card card-pad mb-4">
          <summary class="cursor-pointer font-medium">Очередь рассылок — {{ analytics.queue_list|length }}</summary>
          <div class="mt-3 overflow-x-auto">
            <table class="table text-sm">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Кампания</th>
                  <th>Статус</th>
                  <th>Создатель</th>
                  <th>В очереди с</th>
                </tr>
              </thead>
              <tbody>
                {% for item in analytics.queue_list %}
                  <tr class="{% if item.status == 'processing' %}bg-green-50{% endif %}">
                    <td class="muted">#{{ item.position }}</td>
                    <td>
                      <a href="/mail/campaigns/{{ item.campaign.id }}/" class="link">{{ item.campaign.name }}</a>
                      {% if not analytics.is_working_time and item.next_working_time %}
                        <div class="text-xs text-blue-600 mt-1">
                          Старт: {{ item.next_working_time|date:"d.m.Y H:i" }} МСК (раб. время 9:00–18:00)
                        </div>
                      {% elif analytics.is_working_time and item.status == 'pending' %}
                        <div class="text-xs text-green-600 mt-1">
                          Старт в ближайшее время (сейчас {{ analytics.current_time_msk }} МСК)
                        </div>
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge {% if item.status == 'processing' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %} text-xs">
                        {% if item.status == 'processing' %}Обрабатывается{% elif item.status == 'pending' %}В очереди{% else %}{{ item.status }}{% endif %}
                      </span>
                    </td>
                    <td class="muted">{{ item.campaign.created_by.get_full_name|default:item.campaign.created_by.username }}</td>
                    <td class="muted">{{ item.queued_at|date:"d.m.Y H:i" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
      {% endif %}
    {% endif %}

    <div class="card overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>Название</th>
              <th>Тема</th>
              <th>Статус</th>
              {% if show_creator_column %}
                <th>Создатель</th>
              {% endif %}
              <th>Создано</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody>
            {% for c in campaigns %}
              <tr onclick="window.location='/mail/campaigns/{{ c.id }}/'" style="cursor:pointer" class="hover:bg-gray-50 transition-colors">
                <td>
                  <a class="link" href="/mail/campaigns/{{ c.id }}/" onclick="event.stopPropagation()">{{ c.name }}</a>
                  {# Уведомления о паузе и рабочем времени #}
                  {% if c.pause_reasons %}
                    <div class="mt-1 text-xs text-orange-600 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                      </svg>
                      <span>Приостановлена: {{ c.pause_reasons.0|truncatewords:8 }}</span>
                    </div>
                  {% elif c.status == 'sending' or c.status == 'ready' %}
                    {% if not c.is_working_time %}
                      <div class="mt-1 text-xs text-blue-600 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        <span>Ожидание рабочего времени ({{ c.current_time_msk }}, 9:00-18:00 МСК)</span>
                      </div>
                    {% else %}
                      <div class="mt-1 text-xs text-green-600 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        <span>Активна, отправка в рабочее время</span>
                      </div>
                    {% endif %}
                  {% endif %}
                  {% if c.queue_entry %}
                    <div class="mt-1 text-xs text-brand-dark/60 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" />
                      </svg>
                      <span>В очереди: {{ c.queue_entry.get_status_display }}</span>
                    </div>
                  {% endif %}
                </td>
                <td class="muted">{{ c.subject }}</td>
                <td><span class="badge {% if c.status == 'sending' %}bg-green-100 text-green-800{% elif c.status == 'paused' %}bg-orange-100 text-orange-800{% elif c.status == 'sent' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-800{% endif %}">{{ c.get_status_display }}</span></td>
                {% if show_creator_column %}
                  <td class="muted">{{ c.created_by|default:"—" }}</td>
                {% endif %}
                <td class="muted">{{ c.created_at|date:"d.m.Y H:i" }}</td>
                <td onclick="event.stopPropagation()">
                  {% if is_admin or c.created_by_id == request.user.id %}
                    <form method="post" action="/mail/campaigns/{{ c.id }}/delete/" onsubmit="return confirm('Удалить кампанию?');">
                      {% csrf_token %}
                      <button type="submit" class="btn-icon btn btn-outline" title="Удалить" style="padding:.25rem .5rem;border-color:#fecaca;color:#dc2626">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td class="muted" colspan="{% if show_creator_column %}6{% else %}5{% endif %}" style="padding:1.25rem 1rem">Кампаний нет.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {# Модальное окно "Отписки" — только для администратора #}
    {% if is_admin %}
      <div id="unsubscribes-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40" data-close-unsubscribes></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
          <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl overflow-hidden">
            <div class="flex items-center justify-between gap-3 px-4 py-3 border-b">
              <div class="font-medium">Отписки</div>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem" data-close-unsubscribes>Закрыть</button>
            </div>

            <div class="p-4 space-y-3">
              <div class="flex flex-col md:flex-row md:items-center gap-2 justify-between">
                <div class="flex items-center gap-2">
                  <input id="unsub-q" class="input" placeholder="Поиск email…" style="min-width:260px" />
                  <button type="button" class="btn btn-outline" id="unsub-refresh" style="padding:.25rem .5rem">Обновить</button>
                </div>
                <div class="flex items-center gap-2">
                  <div class="text-xs text-brand-dark/60" id="unsub-meta">—</div>
                  <button type="button" class="btn btn-outline" id="unsub-clear-all" style="padding:.25rem .5rem;border-color:#fecaca;color:#dc2626">
                    Очистить список
                  </button>
                </div>
              </div>

              <div class="border rounded-lg overflow-hidden">
                <div class="p-3 text-sm" id="unsub-loading" style="display:none">Загрузка…</div>
                <div class="overflow-x-auto">
                  <table class="table text-sm" id="unsub-table">
                    <thead>
                      <tr>
                        <th>Email</th>
                        <th>Источник</th>
                        <th>Причина</th>
                        <th>Обновлено</th>
                        <th style="width:60px"></th>
                      </tr>
                    </thead>
                    <tbody id="unsub-tbody">
                      <tr><td colspan="5" class="muted" style="padding:1rem">Нет данных</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="flex items-center justify-between">
                <div class="text-xs text-brand-dark/60" id="unsub-error" style="display:none;color:#dc2626"></div>
                <button type="button" class="btn btn-outline" id="unsub-load-more" style="display:none;padding:.25rem .5rem">Показать ещё</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    (function () {
      const quotaCard = document.getElementById('quota-card');
      if (!quotaCard) return;

      const REFRESH_MS = 60_000; // 60 сек
      const url = '/mail/quota/poll/';

      function fmtDateTimeMsk(iso) {
        if (!iso) return '—';
        try {
          const d = new Date(iso);
          return d.toLocaleString('ru-RU', {
            timeZone: 'Europe/Moscow',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
          }).replace(',', '');
        } catch (e) {
          return '—';
        }
      }

      function setText(id, value, fallback) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = (value === null || value === undefined || value === '') ? (fallback ?? '—') : String(value);
      }

      async function refreshQuota(isManual) {
        const statusEl = document.getElementById('quota-auto-refresh-status');
        if (statusEl && isManual) statusEl.textContent = 'Обновляю…';

        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          setText('quota-tariff-name', data.tariff_name || '—');
          if (data.tariff_renewal_date) {
            setText('quota-renewal-date', fmtDateTimeMsk(data.tariff_renewal_date).slice(0, 10));
          }
          setText('quota-emails-available', data.emails_available);
          setText('quota-emails-limit', data.emails_limit);
          setText('quota-sent-per-hour', data.sent_per_hour);
          setText('quota-max-per-hour', data.max_per_hour);
          setText('quota-last-synced', data.last_synced_at ? fmtDateTimeMsk(data.last_synced_at) : '—');

          const errEl = document.getElementById('quota-sync-error');
          if (errEl) {
            if (data.sync_error) {
              errEl.style.display = '';
              errEl.textContent = 'Ошибка синхронизации';
              errEl.title = data.sync_error;
            } else {
              errEl.style.display = 'none';
              errEl.title = '';
            }
          }

          if (statusEl) statusEl.textContent = 'Автообновление включено';
        } catch (e) {
          if (statusEl) statusEl.textContent = 'Не удалось обновить';
        }
      }

      window.__refreshQuota = refreshQuota;
      refreshQuota(false);
      setInterval(() => refreshQuota(false), REFRESH_MS);
    })();
  </script>

  {% if is_admin %}
    <script>
      (function () {
        const modal = document.getElementById('unsubscribes-modal');
        const openBtn = document.getElementById('open-unsubscribes-modal');
        if (!modal || !openBtn) return;

        const qInput = document.getElementById('unsub-q');
        const refreshBtn = document.getElementById('unsub-refresh');
        const clearAllBtn = document.getElementById('unsub-clear-all');
        const tbody = document.getElementById('unsub-tbody');
        const meta = document.getElementById('unsub-meta');
        const errorEl = document.getElementById('unsub-error');
        const loadingEl = document.getElementById('unsub-loading');
        const loadMoreBtn = document.getElementById('unsub-load-more');

        const URL_LIST = '/mail/unsubscribes/list/';
        const URL_DELETE = '/mail/unsubscribes/delete/';
        const URL_CLEAR = '/mail/unsubscribes/clear/';

        let state = { q: '', total: 0, offset: 0, limit: 200, items: [] };

        function getCookie(name) {
          const v = `; ${document.cookie}`;
          const parts = v.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }

        function showModal() { modal.classList.remove('hidden'); }
        function hideModal() { modal.classList.add('hidden'); }

        modal.querySelectorAll('[data-close-unsubscribes]').forEach((el) => el.addEventListener('click', hideModal));
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) hideModal();
        });

        function fmt(iso) {
          if (!iso) return '—';
          try {
            const d = new Date(iso);
            return d.toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).replace(',', '');
          } catch (e) { return '—'; }
        }

        function setLoading(v) { loadingEl.style.display = v ? '' : 'none'; }
        function setError(msg) {
          if (!msg) { errorEl.style.display = 'none'; errorEl.textContent = ''; return; }
          errorEl.style.display = ''; errorEl.textContent = msg;
        }

        function render() {
          meta.textContent = `Показано: ${state.items.length} из ${state.total}`;
          if (!state.items.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="muted" style="padding:1rem">Нет данных</td></tr>';
          } else {
            tbody.innerHTML = state.items.map((r) => {
              const email = (r.email || '');
              const source = (r.source || '—');
              const reason = (r.reason || '—');
              const updated = fmt(r.last_seen_at || r.created_at);
              return `
                <tr>
                  <td class="font-medium">${email}</td>
                  <td class="muted">${source}</td>
                  <td class="muted">${reason}</td>
                  <td class="muted">${updated}</td>
                  <td>
                    <button type="button" class="btn btn-outline" data-del="${encodeURIComponent(email)}" style="padding:.15rem .4rem;border-color:#fecaca;color:#dc2626">✕</button>
                  </td>
                </tr>
              `;
            }).join('');
          }
          loadMoreBtn.style.display = (state.items.length < state.total) ? '' : 'none';
        }

        async function loadPage({ reset }) {
          setError('');
          setLoading(true);
          try {
            const q = (qInput.value || '').trim();
            if (reset) state = { q, total: 0, offset: 0, limit: 200, items: [] };

            const url = new URL(URL_LIST, window.location.origin);
            url.searchParams.set('q', state.q);
            url.searchParams.set('limit', String(state.limit));
            url.searchParams.set('offset', String(state.offset));

            const res = await fetch(url.toString(), { credentials: 'same-origin' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Ошибка');

            state.total = data.total || 0;
            state.limit = data.limit || state.limit;
            const page = Array.isArray(data.data) ? data.data : [];
            state.items = reset ? page : state.items.concat(page);
            state.offset = state.items.length;
            render();
          } catch (e) {
            setError('Не удалось загрузить список отписок.');
          } finally {
            setLoading(false);
          }
        }

        async function deleteEmails(emails) {
          setError('');
          try {
            const res = await fetch(URL_DELETE, {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
              body: JSON.stringify({ emails }),
            });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Ошибка');
            state.items = state.items.filter((x) => !emails.includes(((x.email || '').toLowerCase())));
            state.total = Math.max(0, state.total - (data.deleted ? 1 : 0));
            render();
          } catch (e) {
            setError('Не удалось удалить запись.');
          }
        }

        async function clearAll() {
          if (!confirm('Очистить весь список отписок?')) return;
          setError('');
          try {
            const res = await fetch(URL_CLEAR, { method: 'POST', credentials: 'same-origin', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Ошибка');
            state.items = []; state.total = 0; state.offset = 0; render();
          } catch (e) {
            setError('Не удалось очистить список.');
          }
        }

        openBtn.addEventListener('click', () => { showModal(); loadPage({ reset: true }); });
        refreshBtn.addEventListener('click', () => loadPage({ reset: true }));
        loadMoreBtn.addEventListener('click', () => loadPage({ reset: false }));
        clearAllBtn.addEventListener('click', clearAll);
        qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); loadPage({ reset: true }); } });

        tbody.addEventListener('click', (e) => {
          const btn = e.target && e.target.closest ? e.target.closest('[data-del]') : null;
          if (!btn) return;
          const email = decodeURIComponent(btn.getAttribute('data-del') || '');
          if (!email) return;
          if (!confirm(`Удалить из отписок: ${email}?`)) return;
          deleteEmails([email.toLowerCase()]);
        });
      })();
    </script>
  {% endif %}
{% endblock %}


