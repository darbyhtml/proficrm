{% extends "ui/base.html" %}
{% block title %}Почта — CRM ПРОФИ{% endblock %}

{% block content %}
  <style>
    .btn-icon { transition: all 0.2s ease; }
    .btn-icon:hover { transform: translateY(-0.0625rem); }
    .card { transition: box-shadow 0.2s ease; }
    .card:hover { box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.08); }
    tr { transition: background-color 0.15s ease; }
    details summary { transition: color 0.2s ease; }
  </style>
  
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold">Кампании рассылок</h1>
        {% if is_admin %}
          <div class="muted text-sm">Управление рассылками и аналитика по пользователям</div>
        {% else %}
          <div class="muted text-sm">Создай кампанию → сгенерируй получателей → отправляй батчами.</div>
        {% endif %}
      </div>
      <div class="flex gap-2">
        {% if is_admin %}
          <a class="btn btn-outline" href="/mail/admin/">Админ-панель</a>
        {% endif %}
        <a class="btn btn-outline" href="/mail/signature/">Настройка подписи</a>
        <a class="btn btn-primary" href="/mail/campaigns/new/">+ Новая кампания</a>
      </div>
    </div>

    {# Компактный виджет квоты для всех #}
    {% if quota %}
      {% if is_admin %}
        {# Компактный виджет для администратора с ссылкой на админ-панель #}
        <div class="card card-pad bg-gradient-to-r from-brand-soft/20 to-transparent border border-brand-soft/30" id="quota-card">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-6 text-sm">
              <div class="flex items-center gap-2">
                <div class="w-1 h-8 rounded-full {% if quota.emails_available < quota.emails_limit|add:'-'|add:'100' %}bg-orange-400{% elif quota.emails_available == 0 %}bg-red-400{% else %}bg-green-400{% endif %}"></div>
                <div>
                  <div class="text-xs text-brand-dark/60">Квота</div>
                  <div class="font-semibold {% if quota.emails_available < quota.emails_limit|add:'-'|add:'100' %}text-orange-600{% elif quota.emails_available == 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    <span id="quota-emails-available">{{ quota.emails_available }}</span><span class="text-brand-dark/50 font-normal">/{{ quota.emails_limit }}</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-1 h-8 rounded-full bg-brand-teal/70"></div>
                <div>
                  <div class="text-xs text-brand-dark/60">Час</div>
                  <div class="font-semibold">
                    <span id="quota-sent-per-hour">{{ quota.sent_per_hour|default:0 }}</span><span class="text-brand-dark/50 font-normal">/{{ quota.max_per_hour|default:100 }}</span>
                  </div>
                </div>
              </div>
            </div>
            <a href="/mail/admin/?tab=overview" class="btn btn-outline btn-sm hover:bg-brand hover:text-white transition-all">Подробнее →</a>
          </div>
        </div>
      {% else %}
        {# Лимиты для менеджеров, директоров, РОП — понятно и стильно, в духе 2026 #}
        <div class="card card-pad" id="quota-card">
          <div class="flex items-center justify-between gap-2 mb-3">
            <h2 class="text-sm font-semibold text-brand-dark">Лимиты отправки</h2>
          </div>
          <div class="flex items-center justify-between gap-4 flex-wrap">
            <div class="flex items-center gap-6 text-sm">
              <div class="flex items-center gap-3">
                <div class="w-1 h-9 rounded-full shrink-0 {% if quota.emails_available < quota.emails_limit|add:'-'|add:'100' %}bg-orange-400{% elif quota.emails_available == 0 %}bg-red-400{% else %}bg-green-400{% endif %}"></div>
                <div>
                  <div class="font-semibold {% if quota.emails_available < quota.emails_limit|add:'-'|add:'100' %}text-orange-600{% elif quota.emails_available == 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    <span id="quota-emails-available">{{ quota.emails_available }}</span><span class="text-brand-dark/50 font-normal">/{{ quota.emails_limit }}</span>
                  </div>
                  <div class="text-xs muted mt-0.5">писем в месяц (осталось)</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-1 h-9 rounded-full shrink-0 bg-brand-teal/70"></div>
                <div>
                  <div class="font-semibold">
                    <span id="quota-sent-per-hour">{{ quota.sent_per_hour|default:0 }}</span><span class="text-brand-dark/50 font-normal">/{{ quota.max_per_hour|default:100 }}</span>
                  </div>
                  <div class="text-xs muted mt-0.5">отправлено в этот час</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-1 h-9 rounded-full shrink-0 {% if user_limit_info.is_limit_reached %}bg-red-400{% elif user_limit_info.remaining is not None and user_limit_info.remaining < 20 %}bg-orange-400{% else %}bg-green-400{% endif %}"></div>
                <div>
                  <div class="font-semibold {% if user_limit_info.is_limit_reached %}text-red-600{% elif user_limit_info.remaining is not None and user_limit_info.remaining < 20 %}text-orange-600{% else %}text-green-600{% endif %}">
                    {{ user_limit_info.sent_today }}<span class="text-brand-dark/50 font-normal">/{{ user_limit_info.limit }}</span>
                  </div>
                  <div class="text-xs muted mt-0.5">ваш лимит на сегодня</div>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2 text-xs muted shrink-0">
              <span id="quota-auto-refresh-status">Обновляется автоматически</span>
              <button type="button" class="btn btn-outline btn-sm" onclick="window.__refreshQuota && window.__refreshQuota(true)">Обновить</button>
            </div>
          </div>
          {% if user_limit_info.is_limit_reached %}
            <div class="mt-3 pt-3 border-t border-brand-soft/50 text-sm text-red-600 flex items-center gap-2">
              <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126Z"/></svg>
              Дневной лимит исчерпан. Отправка возобновится завтра.
            </div>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}

    {% if is_admin and analytics %}
      {# Компактный виджет аналитики для администратора со ссылкой на админ-панель #}
      <div class="card card-pad mb-4 bg-gradient-to-br from-white to-brand-soft/5 border border-brand-soft/20">
        <div class="flex items-center justify-between gap-3 mb-2">
          <div class="font-semibold text-sm">Статистика (сегодня)</div>
          <div class="flex items-center gap-2">
            <button type="button" class="btn btn-outline btn-sm" id="open-unsubscribes-modal" style="padding:.25rem .5rem">Отписки</button>
            <a href="/mail/admin/?tab=analytics" class="btn btn-outline btn-sm hover:bg-brand hover:text-white transition-all">Подробнее →</a>
          </div>
        </div>
        <div class="grid grid-cols-4 gap-3 text-sm">
          <div class="flex items-center gap-2">
            <div class="w-1 h-8 rounded-full bg-brand-teal/70"></div>
            <div>
              <div class="text-xs text-brand-dark/60">Отправлено</div>
              <div class="font-semibold text-lg">{{ analytics.total_sent_today }}</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-1 h-8 rounded-full {% if analytics.total_failed_today > 0 %}bg-red-400{% else %}bg-gray-300{% endif %}"></div>
            <div>
              <div class="text-xs text-brand-dark/60">Ошибки</div>
              <div class="font-semibold text-lg {% if analytics.total_failed_today > 0 %}text-red-600{% endif %}">{{ analytics.total_failed_today }}</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-1 h-8 rounded-full bg-brand-soft"></div>
            <div>
              <div class="text-xs text-brand-dark/60">Кампаний</div>
              <div class="font-semibold text-lg">{{ analytics.campaigns_stats.total }}</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-1 h-8 rounded-full bg-green-400"></div>
            <div>
              <div class="text-xs text-brand-dark/60">Активных</div>
              <div class="font-semibold text-lg text-green-600">{{ analytics.campaigns_stats.active }}</div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    {% if show_creator_column and branches_for_filter and branches_for_filter|length > 1 or show_creator_column and managers_for_filter and managers_for_filter|length > 1 %}
      <div class="card card-pad overflow-x-auto">
        <form method="get" action="" class="flex items-center gap-3 flex-nowrap min-w-0">
          <span class="text-sm font-medium muted shrink-0">Фильтр:</span>
          {% if branches_for_filter|length > 1 %}
            <select name="branch" class="input w-auto min-w-[10rem] shrink-0" onchange="this.form.submit()">
              <option value="">Все филиалы</option>
              {% for b in branches_for_filter %}
                <option value="{{ b.id }}" {% if filter_branch_id and filter_branch_id|add:0 == b.id %}selected{% endif %}>{{ b.name }}</option>
              {% endfor %}
            </select>
          {% endif %}
          {% if managers_for_filter|length > 1 %}
            <select name="manager" class="input w-auto min-w-[11rem] shrink-0" onchange="this.form.submit()">
              <option value="">Все менеджеры</option>
              {% for u in managers_for_filter %}
                <option value="{{ u.id }}" {% if filter_manager_id and filter_manager_id|add:0 == u.id %}selected{% endif %}>{{ u.get_full_name|default:u.username }}</option>
              {% endfor %}
            </select>
          {% endif %}
          {% if filter_branch_id or filter_manager_id %}
            <a href="?" class="btn btn-outline btn-sm shrink-0">Сбросить</a>
          {% endif %}
        </form>
      </div>
    {% endif %}

    <div class="card overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>Название</th>
              <th>Тема</th>
              <th>Статус</th>
              <th>Прогресс</th>
              {% if show_creator_column %}
                <th>Создатель</th>
              {% endif %}
              <th>Создано</th>
              <th style="width:3.75rem"></th>
            </tr>
          </thead>
          <tbody>
            {% if campaigns_grouped %}
              {% for group in campaigns_grouped %}
                {% if group.branch_name %}
                  <tr class="bg-gradient-to-r from-brand-soft/40 to-brand-soft/20 border-b border-brand-soft/30">
                    <td colspan="{% if show_creator_column %}7{% else %}6{% endif %}" class="font-medium py-1.5 px-3 text-sm">
                      <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 .75.75v3M18 21v-3a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75v3M3 3h12m-1 1v13a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Z" />
                        </svg>
                        <span>Филиал: {{ group.branch_name }}</span>
                      </div>
                    </td>
                  </tr>
                {% endif %}
                {% for m in group.managers %}
                  <tr class="bg-gray-50/60">
                    <td colspan="{% if show_creator_column %}7{% else %}6{% endif %}" class="text-xs py-1 px-3 font-medium text-brand-dark/70">
                      <div class="flex items-center gap-2">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                        </svg>
                        <span>Менеджер: {{ m.user.get_full_name|default:m.user.username }}</span>
                      </div>
                    </td>
                  </tr>
                  {% for c in m.campaigns %}
                    {% include "ui/mail/_campaign_row.html" with campaign=c show_creator_column=show_creator_column is_admin=is_admin %}
                  {% endfor %}
                {% endfor %}
              {% endfor %}
            {% else %}
            {% for c in campaigns %}
              {% include "ui/mail/_campaign_row.html" with campaign=c show_creator_column=show_creator_column is_admin=is_admin %}
            {% empty %}
              <tr><td class="muted" colspan="{% if show_creator_column %}7{% else %}6{% endif %}" style="padding:1.25rem 1rem">Кампаний нет.</td></tr>
            {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if page.has_other_pages %}
        <div class="flex items-center justify-between gap-3 px-4 py-3 border-t border-brand-soft/20 bg-brand-soft/5">
          <span class="text-sm text-brand-dark/60">{{ page.start_index }}–{{ page.end_index }} из {{ paginator.count }}</span>
          <div class="flex items-center gap-2">
            {% if page.has_previous %}
              <a href="?page={{ page.previous_page_number }}{% if filter_branch_id %}&branch={{ filter_branch_id }}{% endif %}{% if filter_manager_id %}&manager={{ filter_manager_id }}{% endif %}" class="btn btn-outline btn-sm">← Назад</a>
            {% endif %}
            {% if page.has_next %}
              <a href="?page={{ page.next_page_number }}{% if filter_branch_id %}&branch={{ filter_branch_id }}{% endif %}{% if filter_manager_id %}&manager={{ filter_manager_id }}{% endif %}" class="btn btn-outline btn-sm">Вперёд →</a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

    {# Модальное окно "Отписки" — только для администратора #}
    {% if is_admin %}
      <div id="unsubscribes-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40" data-close-unsubscribes></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
          <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl overflow-hidden">
            <div class="flex items-center justify-between gap-3 px-4 py-3 border-b">
              <div class="font-medium">Отписки</div>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem" data-close-unsubscribes>Закрыть</button>
            </div>

            <div class="p-4 space-y-3">
              <div class="flex flex-col md:flex-row md:items-center gap-2 justify-between">
                <div class="flex items-center gap-2">
                  <input id="unsub-q" class="input" placeholder="Поиск email…" style="min-width:16.25rem" />
                  <button type="button" class="btn btn-outline" id="unsub-refresh" style="padding:.25rem .5rem">Обновить</button>
                </div>
                <div class="flex items-center gap-2">
                  <div class="text-xs text-brand-dark/60" id="unsub-meta">—</div>
                  <button type="button" class="btn btn-outline" id="unsub-clear-all" style="padding:.25rem .5rem;border-color:#fecaca;color:#dc2626">
                    Очистить список
                  </button>
                </div>
              </div>

              <div class="border rounded-lg overflow-hidden">
                <div class="p-3 text-sm" id="unsub-loading" style="display:none">Загрузка…</div>
                <div class="overflow-x-auto">
                  <table class="table text-sm" id="unsub-table">
                    <thead>
                      <tr>
                        <th>Email</th>
                        <th>Источник</th>
                        <th>Причина</th>
                        <th>Обновлено</th>
                        <th style="width:3.75rem"></th>
                      </tr>
                    </thead>
                    <tbody id="unsub-tbody">
                      <tr><td colspan="5" class="muted" style="padding:1rem">Нет данных</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="flex items-center justify-between">
                <div class="text-xs text-brand-dark/60" id="unsub-error" style="display:none;color:#dc2626"></div>
                <button type="button" class="btn btn-outline" id="unsub-load-more" style="display:none;padding:.25rem .5rem">Показать ещё</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    (function () {
      const quotaCard = document.getElementById('quota-card');
      if (!quotaCard) return;

      const REFRESH_MS = 60_000; // 60 сек
      const url = '/mail/quota/poll/';

      function fmtDateTimeMsk(iso) {
        if (!iso) return '—';
        try {
          const d = new Date(iso);
          return d.toLocaleString('ru-RU', {
            timeZone: 'Europe/Moscow',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
          }).replace(',', '');
        } catch (e) {
          return '—';
        }
      }

      function setText(id, value, fallback) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = (value === null || value === undefined || value === '') ? (fallback ?? '—') : String(value);
      }

      async function refreshQuota(isManual) {
        const statusEl = document.getElementById('quota-auto-refresh-status');
        if (statusEl && isManual) statusEl.textContent = 'Обновляю…';

        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          setText('quota-tariff-name', data.tariff_name || '—');
          if (data.tariff_renewal_date) {
            setText('quota-renewal-date', fmtDateTimeMsk(data.tariff_renewal_date).slice(0, 10));
          }
          setText('quota-emails-available', data.emails_available);
          setText('quota-emails-limit', data.emails_limit);
          setText('quota-sent-per-hour', data.sent_per_hour);
          setText('quota-max-per-hour', data.max_per_hour);
          setText('quota-last-synced', data.last_synced_at ? fmtDateTimeMsk(data.last_synced_at) : '—');

          const errEl = document.getElementById('quota-sync-error');
          if (errEl) {
            if (data.sync_error) {
              errEl.style.display = '';
              errEl.textContent = 'Ошибка синхронизации';
              errEl.title = data.sync_error;
            } else {
              errEl.style.display = 'none';
              errEl.title = '';
            }
          }

          if (statusEl) statusEl.textContent = 'Автообновление включено';
        } catch (e) {
          if (statusEl) statusEl.textContent = 'Не удалось обновить';
        }
      }

      window.__refreshQuota = refreshQuota;
      refreshQuota(false);
      setInterval(() => refreshQuota(false), REFRESH_MS);
    })();
  </script>

  {% if is_admin %}
    <script>
      (function () {
        const modal = document.getElementById('unsubscribes-modal');
        const openBtn = document.getElementById('open-unsubscribes-modal');
        if (!modal || !openBtn) return;

        const qInput = document.getElementById('unsub-q');
        const refreshBtn = document.getElementById('unsub-refresh');
        const clearAllBtn = document.getElementById('unsub-clear-all');
        const tbody = document.getElementById('unsub-tbody');
        const meta = document.getElementById('unsub-meta');
        const errorEl = document.getElementById('unsub-error');
        const loadingEl = document.getElementById('unsub-loading');
        const loadMoreBtn = document.getElementById('unsub-load-more');

        const URL_LIST = '/mail/unsubscribes/list/';
        const URL_DELETE = '/mail/unsubscribes/delete/';
        const URL_CLEAR = '/mail/unsubscribes/clear/';

        let state = { q: '', total: 0, offset: 0, limit: 200, items: [] };

        function getCookie(name) {
          const v = `; ${document.cookie}`;
          const parts = v.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }

        function showModal() { modal.classList.remove('hidden'); }
        function hideModal() { modal.classList.add('hidden'); }

        modal.querySelectorAll('[data-close-unsubscribes]').forEach((el) => el.addEventListener('click', hideModal));
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) hideModal();
        });

        function fmt(iso) {
          if (!iso) return '—';
          try {
            const d = new Date(iso);
            return d.toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).replace(',', '');
          } catch (e) { return '—'; }
        }

        function setLoading(v) { loadingEl.style.display = v ? '' : 'none'; }
        function setError(msg) {
          if (!msg) { errorEl.style.display = 'none'; errorEl.textContent = ''; return; }
          errorEl.style.display = ''; errorEl.textContent = msg;
        }

        function render() {
          meta.textContent = `Показано: ${state.items.length} из ${state.total}`;
          if (!state.items.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="muted" style="padding:1rem">Нет данных</td></tr>';
          } else {
            tbody.innerHTML = state.items.map((r) => {
              const email = (r.email || '');
              const source = (r.source || '—');
              const reason = (r.reason || '—');
              const updated = fmt(r.last_seen_at || r.created_at);
              return `
                <tr>
                  <td class="font-medium">${email}</td>
                  <td class="muted">${source}</td>
                  <td class="muted">${reason}</td>
                  <td class="muted">${updated}</td>
                  <td>
                    <button type="button" class="btn btn-outline" data-del="${encodeURIComponent(email)}" style="padding:.15rem .4rem;border-color:#fecaca;color:#dc2626">✕</button>
                  </td>
                </tr>
              `;
            }).join('');
          }
          loadMoreBtn.style.display = (state.items.length < state.total) ? '' : 'none';
        }

        async function loadPage({ reset }) {
          setError('');
          setLoading(true);
          try {
            const q = (qInput.value || '').trim();
            if (reset) state = { q, total: 0, offset: 0, limit: 200, items: [] };

            const url = new URL(URL_LIST, window.location.origin);
            url.searchParams.set('q', state.q);
            url.searchParams.set('limit', String(state.limit));
            url.searchParams.set('offset', String(state.offset));

            const res = await fetch(url.toString(), { credentials: 'same-origin' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Ошибка');

            state.total = data.total || 0;
            state.limit = data.limit || state.limit;
            const page = Array.isArray(data.data) ? data.data : [];
            state.items = reset ? page : state.items.concat(page);
            state.offset = state.items.length;
            render();
          } catch (e) {
            setError('Не удалось загрузить список отписок.');
          } finally {
            setLoading(false);
          }
        }

        async function deleteEmails(emails) {
          setError('');
          try {
            const res = await fetch(URL_DELETE, {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
              body: JSON.stringify({ emails }),
            });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Ошибка');
            state.items = state.items.filter((x) => !emails.includes(((x.email || '').toLowerCase())));
            state.total = Math.max(0, state.total - (data.deleted ? 1 : 0));
            render();
          } catch (e) {
            setError('Не удалось удалить запись.');
          }
        }

        async function clearAll() {
          if (!confirm('Очистить весь список отписок?')) return;
          setError('');
          try {
            const res = await fetch(URL_CLEAR, { method: 'POST', credentials: 'same-origin', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Ошибка');
            state.items = []; state.total = 0; state.offset = 0; render();
          } catch (e) {
            setError('Не удалось очистить список.');
          }
        }

        openBtn.addEventListener('click', () => { showModal(); loadPage({ reset: true }); });
        refreshBtn.addEventListener('click', () => loadPage({ reset: true }));
        loadMoreBtn.addEventListener('click', () => loadPage({ reset: false }));
        clearAllBtn.addEventListener('click', clearAll);
        qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); loadPage({ reset: true }); } });

        tbody.addEventListener('click', (e) => {
          const btn = e.target && e.target.closest ? e.target.closest('[data-del]') : null;
          if (!btn) return;
          const email = decodeURIComponent(btn.getAttribute('data-del') || '');
          if (!email) return;
          if (!confirm(`Удалить из отписок: ${email}?`)) return;
          deleteEmails([email.toLowerCase()]);
        });
      })();
    </script>
  {% endif %}
{% endblock %}


