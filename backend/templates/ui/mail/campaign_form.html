{% extends "ui/base.html" %}
{% block title %}{% if mode == 'edit' %}Редактировать кампанию{% else %}Новая кампания{% endif %} — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm muted"><a class="link" href="/mail/campaigns/">Почта</a> /</div>
      <h1 class="text-2xl font-semibold">{% if mode == 'edit' %}Редактировать кампанию{% else %}Новая кампания{% endif %}</h1>
      <div class="text-sm text-brand-dark/70 mt-1">
        Отправитель: <b>{{ smtp_from_email|default:"(не задан в настройках SMTP)" }}</b>
        <span class="muted-2">· Reply‑To: {{ request.user.email|default:"(email менеджера не задан)" }}</span>
      </div>
    </div>

    <form method="post" class="card card-pad space-y-3">
      {% csrf_token %}
      <div>
        <label class="block text-sm muted mb-1">Название</label>
        {{ form.name }}
      </div>
      <div>
        <label class="block text-sm muted mb-1">Тема письма</label>
        {{ form.subject }}
      </div>
      <div>
        <label class="block text-sm muted mb-1">Имя отправителя (опционально)</label>
        {{ form.sender_name }}
        <div class="text-xs muted-2 mt-1">Если оставить пустым — будет использовано имя по умолчанию из Почта → Настройки.</div>
      </div>
      <div>
        <div class="flex items-end justify-between gap-2 mb-2">
          <label class="block text-sm muted mb-1">Текст письма</label>
          <div class="flex gap-2">
            <button type="button" class="btn btn-outline" style="padding:.3rem .55rem;font-size:.75rem" id="btn-visual">Визуальный</button>
            <button type="button" class="btn btn-outline" style="padding:.3rem .55rem;font-size:.75rem" id="btn-html">HTML‑код</button>
          </div>
        </div>

        {# Оригинальное поле формы — храним HTML сюда #}
        <div id="html-wrap" class="hidden">
          {{ form.body_html }}
          <div class="text-xs muted-2 mt-1">Можно писать HTML вручную. Plain‑версия будет сгенерирована автоматически.</div>
          <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
            Если добавляете ссылки — учтите, что некоторые почтовики могут чаще отправлять такие письма в спам.
            Это не запрещено, просто предупреждение.
          </div>
        </div>

        {# Визуальный редактор: contenteditable + панель инструментов #}
        <div id="visual-wrap">
          <div class="rounded-lg border border-brand-soft bg-brand-soft/40 px-2 py-1 mb-2 flex flex-nowrap items-center gap-1 text-xs overflow-x-auto">
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="bold" title="Жирный"><b>Ж</b></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="italic" title="Курсив"><i>К</i></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="underline" title="Подчёркивание"><u>Ч</u></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="strikeThrough" title="Зачёркивание"><s>З</s></button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <select id="mailFont" class="select !py-1 !px-2 text-xs" title="Шрифт">
              <option value="">Шрифт</option>
              <option value="Arial" style="font-family:Arial;">Arial</option>
              <option value="Tahoma" style="font-family:Tahoma;">Tahoma</option>
              <option value="Times New Roman" style="font-family:'Times New Roman';">Times New Roman</option>
              <option value="Courier New" style="font-family:'Courier New';">Courier New</option>
            </select>
            <select id="mailSize" class="select !py-1 !px-2 text-xs" title="Размер шрифта">
              <option value="">Размер</option>
              <option value="10" data-html-size="2">10</option>
              <option value="11" data-html-size="2">11</option>
              <option value="12" data-html-size="3">12</option>
              <option value="13" data-html-size="3">13</option>
              <option value="14" data-html-size="4">14</option>
              <option value="15" data-html-size="4">15</option>
              <option value="16" data-html-size="5">16</option>
              <option value="18" data-html-size="6">18</option>
              <option value="20" data-html-size="6">20</option>
              <option value="28" data-html-size="7">28</option>
            </select>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyLeft" title="Выровнять по левому краю">
              <span class="mail-icon-align mail-icon-align-left"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyCenter" title="По центру">
              <span class="mail-icon-align mail-icon-align-center"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyRight" title="Выровнять по правому краю">
              <span class="mail-icon-align mail-icon-align-right"></span>
            </button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="insertUnorderedList" title="Маркированный список">
              <span class="mail-icon-list mail-icon-list-bullet"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="insertOrderedList" title="Нумерованный список">
              <span class="mail-icon-list mail-icon-list-number"></span>
            </button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" id="mailLinkBtn" title="Вставить ссылку">
              <span class="mail-icon-link"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" id="mailUnlinkBtn" title="Убрать ссылку">
              <span class="mail-icon-unlink"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="removeFormat" title="Очистить форматирование">
              <span class="mail-icon-eraser"></span>
            </button>
          </div>

          <div class="rounded-xl border border-brand-soft bg-white p-3 overflow-x-auto">
            <div id="mailEditor" contenteditable="true" class="min-h-[260px] outline-none text-sm" style="white-space:pre-wrap;"></div>
          </div>
          <div class="text-xs muted-2 mt-2">
            Визуальный редактор: шрифты, выравнивание, списки, ссылки. HTML‑код можно посмотреть во вкладке «HTML‑код».
          </div>
        </div>
      </div>

      {% if form.errors %}
        <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">Проверь поля формы.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">{% if mode == 'edit' %}Сохранить{% else %}Создать{% endif %}</button>
        {% if mode == 'edit' %}
          <a class="btn btn-outline" href="/mail/campaigns/{{ campaign.id }}/">Назад</a>
        {% else %}
          <a class="btn btn-outline" href="/mail/campaigns/">Отмена</a>
        {% endif %}
      </div>
    </form>
  </div>

  <script>
    (function () {
      const htmlWrap = document.getElementById("html-wrap");
      const visualWrap = document.getElementById("visual-wrap");
      const btnVisual = document.getElementById("btn-visual");
      const btnHtml = document.getElementById("btn-html");
      const editor = document.getElementById("mailEditor");
      const htmlField = document.querySelector('textarea[name="body_html"]');
      const linkBtn = document.getElementById("mailLinkBtn");
      const unlinkBtn = document.getElementById("mailUnlinkBtn");
      const fontSelect = document.getElementById("mailFont");
      const sizeSelect = document.getElementById("mailSize");

      if (!editor || !htmlField || !btnVisual || !btnHtml) return;

      editor.innerHTML = htmlField.value || "";

      function setActive(btnOn, btnOff) {
        btnOn.classList.add("bg-brand-soft/40");
        btnOff.classList.remove("bg-brand-soft/40");
      }

      function syncToTextarea() {
        htmlField.value = editor.innerHTML || "";
      }

      document.querySelectorAll("[data-cmd]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const cmd = btn.getAttribute("data-cmd");
          if (!cmd) return;
          document.execCommand(cmd, false, null);
          editor.focus();
          syncToTextarea();
        });
      });

      if (linkBtn) {
        linkBtn.addEventListener("click", () => {
          const url = prompt("Ссылка (https://...)");
          if (!url) return;
          document.execCommand("createLink", false, url);
          editor.focus();
          syncToTextarea();
        });
      }

      if (unlinkBtn) {
        unlinkBtn.addEventListener("click", () => {
          document.execCommand("unlink", false, null);
          editor.focus();
          syncToTextarea();
        });
      }

      if (fontSelect) {
        fontSelect.addEventListener("change", () => {
          const v = fontSelect.value;
          if (!v) return;
          document.execCommand("fontName", false, v);
          editor.focus();
          syncToTextarea();
        });
      }

      if (sizeSelect) {
        sizeSelect.addEventListener("change", () => {
          const opt = sizeSelect.selectedOptions[0];
          if (!opt) return;
          const htmlSize = opt.getAttribute("data-html-size") || "3";
          document.execCommand("fontSize", false, htmlSize);
          editor.focus();
          syncToTextarea();
        });
      }

      editor.addEventListener("input", syncToTextarea);

      function showVisual() {
        htmlWrap.classList.add("hidden");
        visualWrap.classList.remove("hidden");
        setActive(btnVisual, btnHtml);
        editor.innerHTML = htmlField.value || "";
      }

      function showHtml() {
        visualWrap.classList.add("hidden");
        htmlWrap.classList.remove("hidden");
        setActive(btnHtml, btnVisual);
        syncToTextarea();
      }

      btnVisual.addEventListener("click", showVisual);
      btnHtml.addEventListener("click", showHtml);

      showVisual();

      document.querySelector("form").addEventListener("submit", () => {
        syncToTextarea();
      });
    })();
  </script>

  <style>
    #mailEditor:empty:before {
      content: "Напишите текст письма...";
      color: rgba(0, 61, 56, 0.45);
      pointer-events: none;
    }
    .mail-icon-align {
      display:inline-block;
      width:16px;
      height:12px;
      position:relative;
    }
    .mail-icon-align::before,
    .mail-icon-align::after {
      content:"";
      position:absolute;
      height:1.5px;
      background-color:#003D38;
      border-radius:1px;
    }
    .mail-icon-align-left::before,
    .mail-icon-align-left::after { left:0; right:0; }
    .mail-icon-align-center::before,
    .mail-icon-align-center::after { left:2px; right:2px; }
    .mail-icon-align-right::before,
    .mail-icon-align-right::after { left:auto; right:0; }
    .mail-icon-align-left::before { width:100%; }
    .mail-icon-align-left::after { width:80%; }
    .mail-icon-align-center::before { width:100%; }
    .mail-icon-align-center::after { width:60%; }
    .mail-icon-align-right::before { width:80%; }
    .mail-icon-align-right::after { width:100%; }
    .mail-icon-align::before { top:2px; }
    .mail-icon-align::after { bottom:2px; }

    .mail-icon-list {
      display:inline-block;
      width:16px;
      height:12px;
      position:relative;
    }
    .mail-icon-list::before,
    .mail-icon-list::after {
      content:"";
      position:absolute;
      left:0;
      right:0;
      height:1.5px;
      background-color:#003D38;
      border-radius:1px;
    }
    .mail-icon-list-bullet::before { left:4px; }
    .mail-icon-list-bullet::after { left:4px; }
    .mail-icon-list-number::before { left:0; }
    .mail-icon-list-number::after { left:0; }
    .mail-icon-list-bullet::marker {
      content:"•";
      position:absolute;
      left:0;
      top:2px;
      color:#003D38;
      font-size:10px;
    }
    .mail-icon-list-number::marker {
      content:"1";
      position:absolute;
      left:0;
      top:2px;
      color:#003D38;
      font-size:9px;
      font-weight:600;
    }
    .mail-icon-list::before { top:2px; }
    .mail-icon-list::after { bottom:2px; }

    .mail-icon-link,
    .mail-icon-unlink {
      display:inline-block;
      width:16px;
      height:12px;
      position:relative;
    }
    .mail-icon-link::before {
      content:"";
      position:absolute;
      width:8px;
      height:8px;
      border:1.5px solid #003D38;
      border-radius:2px;
      top:1px;
      left:2px;
    }
    .mail-icon-link::after {
      content:"";
      position:absolute;
      width:6px;
      height:6px;
      border-top:1.5px solid #003D38;
      border-right:1.5px solid #003D38;
      top:4px;
      left:8px;
      transform:rotate(45deg);
    }
    .mail-icon-unlink::before {
      content:"";
      position:absolute;
      width:8px;
      height:8px;
      border:1.5px solid #003D38;
      border-radius:2px;
      top:1px;
      left:2px;
    }
    .mail-icon-unlink::after {
      content:"";
      position:absolute;
      width:8px;
      height:1.5px;
      background-color:#003D38;
      top:5px;
      left:6px;
      transform:rotate(45deg);
    }

    .mail-icon-eraser {
      display:inline-block;
      width:14px;
      height:10px;
      position:relative;
    }
    .mail-icon-eraser::before {
      content:"";
      position:absolute;
      width:10px;
      height:8px;
      border:1.5px solid #003D38;
      border-radius:1px;
      top:1px;
      left:0;
      transform:skewX(-10deg);
    }
    .mail-icon-eraser::after {
      content:"";
      position:absolute;
      width:6px;
      height:1.5px;
      background-color:#003D38;
      top:3px;
      left:8px;
      transform:rotate(45deg);
    }
  </style>
{% endblock %}


