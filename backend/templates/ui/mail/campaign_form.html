{% extends "ui/base.html" %}
{% block title %}{% if mode == 'edit' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é{% else %}–ù–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è{% endif %} ‚Äî CRM –ü–†–û–§–ò{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm muted"><a class="link" href="/mail/campaigns/">–ü–æ—á—Ç–∞</a> /</div>
      <h1 class="text-2xl font-semibold">{% if mode == 'edit' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é{% else %}–ù–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è{% endif %}</h1>
      <div class="text-sm text-brand-dark/70 mt-1">
        –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: <b>{{ smtp_from_email|default:"(–Ω–µ –∑–∞–¥–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö SMTP)" }}</b>
        <span class="muted-2">¬∑ Reply‚ÄëTo: {{ request.user.email|default:"(email –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–µ –∑–∞–¥–∞–Ω)" }}</span>
      </div>
    </div>

    <form method="post" class="card card-pad space-y-3">
      {% csrf_token %}
      <div>
        <label class="block text-sm muted mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        {{ form.name }}
      </div>
      <div>
        <label class="block text-sm muted mb-1">–¢–µ–º–∞ –ø–∏—Å—å–º–∞</label>
        {{ form.subject }}
      </div>
      <div>
        <label class="block text-sm muted mb-1">–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        {{ form.sender_name }}
        <div class="text-xs muted-2 mt-1">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∏–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –ü–æ—á—Ç–∞ ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏.</div>
      </div>
      <div>
        <div class="flex items-end justify-between gap-2 mb-2">
          <label class="block text-sm muted mb-1">–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞</label>
          <div class="flex gap-2">
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="btn-visual">–í–∏–∑—É–∞–ª—å–Ω—ã–π</button>
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="btn-html">HTML‚Äë–∫–æ–¥</button>
          </div>
        </div>

        {# –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã ‚Äî —Ö—Ä–∞–Ω–∏–º HTML —Å—é–¥–∞ #}
        <div id="html-wrap" class="hidden">
          {{ form.body_html }}
          <div class="text-xs muted-2 mt-1">–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å HTML –≤—Ä—É—á–Ω—É—é. Plain‚Äë–≤–µ—Ä—Å–∏—è –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
          <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
            –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç–µ —Å—Å—ã–ª–∫–∏ ‚Äî —É—á—Ç–∏—Ç–µ, —á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ—á—Ç–æ–≤–∏–∫–∏ –º–æ–≥—É—Ç —á–∞—â–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–∞–∫–∏–µ –ø–∏—Å—å–º–∞ –≤ —Å–ø–∞–º.
            –≠—Ç–æ –Ω–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.
          </div>
        </div>

        {# –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä: contenteditable + –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ #}
        <div id="visual-wrap">
          <div class="flex flex-wrap gap-1 mb-2 text-sm">
            <button type="button" class="btn btn-outline" data-cmd="bold" title="–ñ–∏—Ä–Ω—ã–π"><b>–ñ</b></button>
            <button type="button" class="btn btn-outline" data-cmd="italic" title="–ö—É—Ä—Å–∏–≤"><i>–ö</i></button>
            <button type="button" class="btn btn-outline" data-cmd="underline" title="–ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ"><u>–ß</u></button>
            <button type="button" class="btn btn-outline" data-cmd="strikeThrough" title="–ó–∞—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ"><s>–ó</s></button>

            <select id="mailFont" class="select !py-1 !px-2 text-xs">
              <option value="">–®—Ä–∏—Ñ—Ç</option>
              <option value="Arial">Arial</option>
              <option value="Tahoma">Tahoma</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Courier New">Courier New</option>
            </select>
            <select id="mailSize" class="select !py-1 !px-2 text-xs">
              <option value="">–†–∞–∑–º–µ—Ä</option>
              <option value="2">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
              <option value="3">–û–±—ã—á–Ω—ã–π</option>
              <option value="4">–ö—Ä—É–ø–Ω—ã–π</option>
              <option value="5">–û—á–µ–Ω—å –∫—Ä—É–ø–Ω—ã–π</option>
            </select>

            <button type="button" class="btn btn-outline" data-cmd="justifyLeft" title="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é">‚¨Ö</button>
            <button type="button" class="btn btn-outline" data-cmd="justifyCenter" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚Üî</button>
            <button type="button" class="btn btn-outline" data-cmd="justifyRight" title="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é">‚û°</button>

            <button type="button" class="btn btn-outline" data-cmd="insertUnorderedList" title="–ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
            <button type="button" class="btn btn-outline" data-cmd="insertOrderedList" title="–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">1.</button>

            <button type="button" class="btn btn-outline" id="mailLinkBtn" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É">üîó</button>
            <button type="button" class="btn btn-outline" data-cmd="removeFormat" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">TX</button>
          </div>

          <div class="rounded-xl border border-brand-soft bg-white p-3 overflow-x-auto">
            <div id="mailEditor" contenteditable="true" class="min-h-[260px] outline-none text-sm"></div>
          </div>
          <div class="text-xs muted-2 mt-2">
            –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä: —à—Ä–∏—Ñ—Ç—ã, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ, —Å–ø–∏—Å–∫–∏, —Å—Å—ã–ª–∫–∏. HTML‚Äë–∫–æ–¥ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´HTML‚Äë–∫–æ–¥¬ª.
          </div>
        </div>
      </div>

      {% if form.errors %}
        <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">–ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—è —Ñ–æ—Ä–º—ã.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">{% if mode == 'edit' %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å{% else %}–°–æ–∑–¥–∞—Ç—å{% endif %}</button>
        {% if mode == 'edit' %}
          <a class="btn btn-outline" href="/mail/campaigns/{{ campaign.id }}/">–ù–∞–∑–∞–¥</a>
        {% else %}
          <a class="btn btn-outline" href="/mail/campaigns/">–û—Ç–º–µ–Ω–∞</a>
        {% endif %}
      </div>
    </form>
  </div>

  <script>
    (function () {
      const htmlWrap = document.getElementById("html-wrap");
      const visualWrap = document.getElementById("visual-wrap");
      const btnVisual = document.getElementById("btn-visual");
      const btnHtml = document.getElementById("btn-html");
      const editor = document.getElementById("mailEditor");
      const htmlField = document.querySelector('textarea[name="body_html"]');
      const linkBtn = document.getElementById("mailLinkBtn");
      const fontSelect = document.getElementById("mailFont");
      const sizeSelect = document.getElementById("mailSize");

      if (!editor || !htmlField || !btnVisual || !btnHtml) return;

      editor.innerHTML = htmlField.value || "";

      function setActive(btnOn, btnOff) {
        btnOn.classList.add("bg-brand-soft/40");
        btnOff.classList.remove("bg-brand-soft/40");
      }

      function syncToTextarea() {
        htmlField.value = editor.innerHTML || "";
      }

      document.querySelectorAll("[data-cmd]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const cmd = btn.getAttribute("data-cmd");
          if (!cmd) return;
          document.execCommand(cmd, false, null);
          editor.focus();
          syncToTextarea();
        });
      });

      if (linkBtn) {
        linkBtn.addEventListener("click", () => {
          const url = prompt("–°—Å—ã–ª–∫–∞ (https://...)");
          if (!url) return;
          document.execCommand("createLink", false, url);
          editor.focus();
          syncToTextarea();
        });
      }

      if (fontSelect) {
        fontSelect.addEventListener("change", () => {
          const v = fontSelect.value;
          if (!v) return;
          document.execCommand("fontName", false, v);
          editor.focus();
          syncToTextarea();
        });
      }

      if (sizeSelect) {
        sizeSelect.addEventListener("change", () => {
          const v = sizeSelect.value;
          if (!v) return;
          document.execCommand("fontSize", false, v);
          editor.focus();
          syncToTextarea();
        });
      }

      editor.addEventListener("input", syncToTextarea);

      function showVisual() {
        htmlWrap.classList.add("hidden");
        visualWrap.classList.remove("hidden");
        setActive(btnVisual, btnHtml);
        editor.innerHTML = htmlField.value || "";
      }

      function showHtml() {
        visualWrap.classList.add("hidden");
        htmlWrap.classList.remove("hidden");
        setActive(btnHtml, btnVisual);
        syncToTextarea();
      }

      btnVisual.addEventListener("click", showVisual);
      btnHtml.addEventListener("click", showHtml);

      showVisual();

      document.querySelector("form").addEventListener("submit", () => {
        syncToTextarea();
      });
    })();
  </script>
{% endblock %}


