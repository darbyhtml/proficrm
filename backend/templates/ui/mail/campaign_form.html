{% extends "ui/base.html" %}
{% block title %}{% if mode == 'edit' %}Редактировать кампанию{% else %}Новая кампания{% endif %} — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm muted"><a class="link" href="/mail/campaigns/">Почта</a> /</div>
      <h1 class="text-2xl font-semibold">{% if mode == 'edit' %}Редактировать кампанию{% else %}Новая кампания{% endif %}</h1>
      <div class="text-sm text-brand-dark/70 mt-1">
        Отправитель: <b>{{ smtp_from_email|default:"(не задан в настройках SMTP)" }}</b>
        <span class="muted-2">· Reply‑To: {{ request.user.email|default:"(email менеджера не задан)" }}</span>
      </div>
    </div>

    <form method="post" class="card card-pad space-y-3">
      {% csrf_token %}
      <div>
        <label class="block text-sm muted mb-1">Название</label>
        {{ form.name }}
      </div>
      <div>
        <label class="block text-sm muted mb-1">Тема письма</label>
        {{ form.subject }}
      </div>
      <div>
        <label class="block text-sm muted mb-1">Имя отправителя (опционально)</label>
        {{ form.sender_name }}
        <div class="text-xs muted-2 mt-1">Если оставить пустым — будет использовано имя по умолчанию из Почта → Настройки.</div>
      </div>
      <div>
          <div class="flex items-end justify-between gap-2">
            <label class="block text-sm muted mb-1">HTML</label>
            <div class="flex gap-2">
              <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="btn-visual">Визуальный</button>
              <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="btn-html">HTML‑код</button>
            </div>
          </div>

          {# Оригинальное поле формы — храним HTML сюда #}
          <div id="html-wrap">
            {{ form.body_html }}
            <div class="text-xs muted-2 mt-1">Можно писать HTML вручную. Plain‑версия будет сгенерирована автоматически.</div>
            <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
              Если добавляете ссылки — учтите, что некоторые почтовики могут чаще отправлять такие письма в спам.
              Это не запрещено, просто предупреждение.
            </div>
          </div>

          {# Визуальный редактор #}
          <div id="visual-wrap" class="hidden">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
            <div id="quill-editor" style="min-height:260px;border-radius:12px"></div>
            <div class="text-xs muted-2 mt-2">
              Визуальный редактор: шрифты, выравнивание, списки, цвета, ссылки и изображения.
            </div>
          </div>
      </div>

      {% if form.errors %}
        <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">Проверь поля формы.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">{% if mode == 'edit' %}Сохранить{% else %}Создать{% endif %}</button>
        {% if mode == 'edit' %}
          <a class="btn btn-outline" href="/mail/campaigns/{{ campaign.id }}/">Назад</a>
        {% else %}
          <a class="btn btn-outline" href="/mail/campaigns/">Отмена</a>
        {% endif %}
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script>
    (function () {
      const htmlWrap = document.getElementById("html-wrap");
      const visualWrap = document.getElementById("visual-wrap");
      const btnVisual = document.getElementById("btn-visual");
      const btnHtml = document.getElementById("btn-html");
      const htmlField = document.querySelector('textarea[name="body_html"]');

      function getQuillHtml() {
        const el = document.querySelector('#quill-editor .ql-editor');
        return el ? el.innerHTML : "";
      }

      function setActive(btnOn, btnOff) {
        btnOn.classList.add("bg-brand-soft/40");
        btnOff.classList.remove("bg-brand-soft/40");
      }

      const quill = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'font': [] }, { 'size': [] }],
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            ['link', 'image', 'clean']
          ]
        }
      });
      let isUpdating = false;
      let htmlDebounce = null;

      function syncFromQuill() {
        if (!htmlField || isUpdating) return;
        isUpdating = true;
        const html = getQuillHtml();
        htmlField.value = html;
        isUpdating = false;
      }

      function syncFromHtmlField() {
        if (!htmlField || isUpdating) return;
        isUpdating = true;
        const html = htmlField.value || "";
        quill.clipboard.dangerouslyPasteHTML(html);
        isUpdating = false;
      }

      if (htmlField && htmlField.value) {
        syncFromHtmlField();
      }

      quill.on('text-change', function() {
        syncFromQuill();
      });

      if (htmlField) {
        htmlField.addEventListener('input', () => {
          if (htmlDebounce) clearTimeout(htmlDebounce);
          htmlDebounce = setTimeout(() => {
            syncFromHtmlField();
          }, 250);
        });
      }

      function showVisual() {
        htmlWrap.classList.add("hidden");
        visualWrap.classList.remove("hidden");
        setActive(btnVisual, btnHtml);
        if (htmlField) syncFromHtmlField();
      }
      function showHtml() {
        visualWrap.classList.add("hidden");
        htmlWrap.classList.remove("hidden");
        setActive(btnHtml, btnVisual);
        syncFromQuill();
      }

      btnVisual.addEventListener("click", showVisual);
      btnHtml.addEventListener("click", showHtml);

      showVisual();
    })();
  </script>
{% endblock %}


