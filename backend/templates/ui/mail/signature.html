{% extends "ui/base.html" %}
{% block title %}Почта — подпись{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <div class="text-sm muted"><a class="link" href="/mail/campaigns/">Почта</a> /</div>
        <h1 class="text-2xl font-semibold">Настройка подписи</h1>
        <div class="muted text-sm">Подпись автоматически добавится в конец письма.</div>
        <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
          Если добавляете ссылки — учтите, что некоторые почтовики могут чаще отправлять такие письма в спам.
          Это не запрещено, просто предупреждение.
        </div>
      </div>
      <a class="btn btn-outline" href="/mail/campaigns/">Назад</a>
    </div>

    <form method="post" class="card card-pad space-y-3" id="sigForm">
      {% csrf_token %}

      <div>
        <div class="flex items-end justify-between gap-2 mb-2">
          <label class="block text-sm muted">Подпись</label>
          <div class="flex gap-2">
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="sigBtnVisual">Визуальный</button>
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="sigBtnHtml">HTML‑код</button>
          </div>
        </div>

        {# HTML-режим (оригинальное поле формы) #}
        <div id="sigHtmlWrap" class="hidden">
          {{ form.signature_html }}
          <div class="text-xs muted-2 mt-1">Можно писать HTML вручную.</div>
        </div>

        {# Визуальный редактор: contenteditable + панель инструментов #}
        <div id="sigVisualWrap">
          <div class="rounded-lg border border-brand-soft bg-brand-soft/40 px-2 py-1 mb-2 flex flex-nowrap items-center gap-1 text-xs overflow-x-auto">
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="bold" title="Жирный"><b>Ж</b></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="italic" title="Курсив"><i>К</i></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="underline" title="Подчёркивание"><u>Ч</u></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="strikeThrough" title="Зачёркивание"><s>З</s></button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <select id="sigFont" class="select !py-1 !px-2 text-xs" title="Шрифт">
              <option value="">Шрифт</option>
              <option value="Arial" style="font-family:Arial;">Arial</option>
              <option value="Tahoma" style="font-family:Tahoma;">Tahoma</option>
              <option value="Times New Roman" style="font-family:'Times New Roman';">Times New Roman</option>
              <option value="Courier New" style="font-family:'Courier New';">Courier New</option>
            </select>
            <select id="sigSize" class="select !py-1 !px-2 text-xs" title="Размер шрифта">
              <option value="">Размер</option>
              <option value="10" data-html-size="2">10</option>
              <option value="11" data-html-size="2">11</option>
              <option value="12" data-html-size="3">12</option>
              <option value="13" data-html-size="3">13</option>
              <option value="14" data-html-size="4">14</option>
              <option value="15" data-html-size="4">15</option>
              <option value="16" data-html-size="5">16</option>
              <option value="18" data-html-size="6">18</option>
              <option value="20" data-html-size="6">20</option>
              <option value="28" data-html-size="7">28</option>
            </select>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyLeft" title="Выровнять по левому краю">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="15" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyCenter" title="По центру">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="6" y1="12" x2="18" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyRight" title="Выровнять по правому краю">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="9" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="insertUnorderedList" title="Маркированный список">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <circle cx="3" cy="6" r="1.5" fill="currentColor"></circle>
                <circle cx="3" cy="12" r="1.5" fill="currentColor"></circle>
                <circle cx="3" cy="18" r="1.5" fill="currentColor"></circle>
              </svg>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="insertOrderedList" title="Нумерованный список">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="10" y1="6" x2="21" y2="6"></line>
                <line x1="10" y1="12" x2="21" y2="12"></line>
                <line x1="10" y1="18" x2="21" y2="18"></line>
                <rect x="2" y="3" width="5" height="5" rx="1" fill="none"></rect>
                <text x="4.5" y="7.5" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="currentColor" text-anchor="middle">1</text>
                <rect x="2" y="9" width="5" height="5" rx="1" fill="none"></rect>
                <text x="4.5" y="13.5" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="currentColor" text-anchor="middle">2</text>
                <rect x="2" y="15" width="5" height="5" rx="1" fill="none"></rect>
                <text x="4.5" y="19.5" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="currentColor" text-anchor="middle">3</text>
              </svg>
            </button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" id="sigLinkBtn" title="Вставить ссылку">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" id="sigUnlinkBtn" title="Убрать ссылку">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                <line x1="2" y1="2" x2="22" y2="22"></line>
              </svg>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="removeFormat" title="Очистить форматирование">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 7h16l-1 10H5L4 7z" fill="none"></path>
                <path d="M4 7l1-4h14l1 4" fill="none"></path>
                <line x1="8" y1="11" x2="16" y2="11"></line>
                <line x1="8" y1="14" x2="16" y2="14"></line>
                <path d="M9 17l-1-1 1-1M15 17l1-1-1-1" fill="none"></path>
              </svg>
            </button>
          </div>

          <div class="rounded-xl border border-brand-soft bg-white p-3 overflow-x-auto">
            <div id="sigEditor" contenteditable="true" class="min-h-[220px] outline-none text-sm" style="white-space:pre-wrap;"></div>
          </div>
          <div class="text-xs muted-2 mt-2">
            Можно форматировать текст, добавлять списки и ссылки. Подпись будет добавляться в конец письма как есть.
            <br>
            <strong>Совет:</strong> Вы можете скопировать подпись из Yandex (или другого почтового клиента) и вставить её сюда — изображения и форматирование сохранятся.
          </div>
        </div>
      </div>

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">Сохранить</button>
        <a class="btn btn-outline" href="/mail/campaigns/">Отмена</a>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const form = document.getElementById("sigForm");
      const htmlWrap = document.getElementById("sigHtmlWrap");
      const visualWrap = document.getElementById("sigVisualWrap");
      const btnVisual = document.getElementById("sigBtnVisual");
      const btnHtml = document.getElementById("sigBtnHtml");
      const editor = document.getElementById("sigEditor");
      const htmlField = document.getElementById("id_signature_html");
      const linkBtn = document.getElementById("sigLinkBtn");
      const unlinkBtn = document.getElementById("sigUnlinkBtn");
      const fontSelect = document.getElementById("sigFont");
      const sizeSelect = document.getElementById("sigSize");

      if (!form || !editor || !htmlField || !btnVisual || !btnHtml) return;

      // Инициализация: подставляем существующую подпись
      function loadSignature() {
        const html = htmlField.value || "";
        editor.innerHTML = html;
        // Убеждаемся, что изображения правильно отображаются
        const images = editor.querySelectorAll("img");
        images.forEach((img) => {
          if (!img.style.maxWidth) {
            img.style.maxWidth = "100%";
          }
          if (!img.style.height) {
            img.style.height = "auto";
          }
        });
      }
      loadSignature();

      function setActive(btnOn, btnOff) {
        btnOn.classList.add("bg-brand-soft/40");
        btnOff.classList.remove("bg-brand-soft/40");
      }

      function syncToTextarea() {
        // Сохраняем HTML с сохранением всех атрибутов и стилей
        let html = editor.innerHTML || "";
        // Убеждаемся, что base64 изображения сохраняются полностью
        // (они уже должны быть в innerHTML, но на всякий случай проверяем)
        htmlField.value = html;
      }

      // toolbar commands
      document.querySelectorAll("[data-cmd]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const cmd = btn.getAttribute("data-cmd");
          if (!cmd) return;
          document.execCommand(cmd, false, null);
          editor.focus();
          syncToTextarea();
        });
      });

      if (linkBtn) {
        linkBtn.addEventListener("click", () => {
          const url = prompt("Ссылка (https://...)");
          if (!url) return;
          document.execCommand("createLink", false, url);
          editor.focus();
          syncToTextarea();
        });
      }

      if (unlinkBtn) {
        unlinkBtn.addEventListener("click", () => {
          document.execCommand("unlink", false, null);
          editor.focus();
          syncToTextarea();
        });
      }

      if (fontSelect) {
        fontSelect.addEventListener("change", () => {
          const v = fontSelect.value;
          if (!v) return;
          document.execCommand("fontName", false, v);
          editor.focus();
          syncToTextarea();
        });
      }

      if (sizeSelect) {
        sizeSelect.addEventListener("change", () => {
          const opt = sizeSelect.selectedOptions[0];
          if (!opt) return;
          const htmlSize = opt.getAttribute("data-html-size") || "3";
          document.execCommand("fontSize", false, htmlSize);
          editor.focus();
          syncToTextarea();
        });
      }

      editor.addEventListener("input", syncToTextarea);

      // Обработка вставки из буфера обмена (например, из Yandex)
      editor.addEventListener("paste", (e) => {
        e.preventDefault();
        
        // Получаем данные из буфера обмена
        const clipboardData = e.clipboardData || window.clipboardData;
        const htmlData = clipboardData.getData("text/html");
        const textData = clipboardData.getData("text/plain");
        const items = Array.from(clipboardData.items || []);

        // Проверяем, есть ли изображения в буфере обмена (файлы)
        const imageItem = items.find(item => item.type.indexOf("image") !== -1);
        
        if (imageItem) {
          // Вставка изображения из буфера обмена
          const file = imageItem.getAsFile();
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const img = document.createElement("img");
              img.src = event.target.result; // base64
              img.style.maxWidth = "100%";
              img.style.height = "auto";
              
              const selection = window.getSelection();
              if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(img);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
              } else {
                editor.appendChild(img);
              }
              syncToTextarea();
            };
            reader.readAsDataURL(file);
            return;
          }
        }

        // Если есть HTML, вставляем его
        if (htmlData) {
          // Создаем временный контейнер для обработки HTML
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = htmlData;

          // Если вставили "целое письмо" с <body> — берём только содержимое body.
          const bodyEl = tempDiv.querySelector('body');
          if (bodyEl) {
            const onlyBody = document.createElement('div');
            onlyBody.innerHTML = bodyEl.innerHTML || '';
            tempDiv.innerHTML = '';
            while (onlyBody.firstChild) tempDiv.appendChild(onlyBody.firstChild);
          }

          // CKEditor/Yandex: data-cke-saved-src/href → src/href.
          tempDiv.querySelectorAll('[data-cke-saved-src]').forEach(el => {
            const v = el.getAttribute('data-cke-saved-src');
            if (v && !el.getAttribute('src')) el.setAttribute('src', v);
          });
          tempDiv.querySelectorAll('[data-cke-saved-href]').forEach(el => {
            const v = el.getAttribute('data-cke-saved-href');
            if (v && !el.getAttribute('href')) el.setAttribute('href', v);
          });
          tempDiv.querySelectorAll('[data-cke-saved-src],[data-cke-saved-href]').forEach(el => {
            el.removeAttribute('data-cke-saved-src');
            el.removeAttribute('data-cke-saved-href');
          });

          // Обрабатываем изображения: сохраняем base64 и внешние ссылки
          const images = tempDiv.querySelectorAll("img");
          const hasYandexWebattach = Array.from(images).some(img => {
            const src = (img.getAttribute('src') || '').toString();
            return src.includes('webattach.mail.yandex.net/message_part_real');
          });
          if (hasYandexWebattach && window.uiToast) {
            window.uiToast('В подпись вставлены картинки из Яндекс.Почты по защищённым ссылкам — у получателей они могут не отображаться.', 'error');
          }
          images.forEach((img) => {
            const src = img.getAttribute("src");
            if (src) {
              // Если это base64, оставляем как есть
              if (src.startsWith("data:image/")) {
                // Убеждаемся, что атрибуты стиля сохранены
                if (!img.style.maxWidth) {
                  img.style.maxWidth = "100%";
                }
                if (!img.style.height) {
                  img.style.height = "auto";
                }
              } else if (src.startsWith("http://") || src.startsWith("https://")) {
                // Внешние ссылки оставляем как есть (могут не работать в некоторых почтовиках)
                // Можно было бы конвертировать в base64, но это требует загрузки изображения
                img.style.maxWidth = "100%";
                img.style.height = "auto";
              }
            }
          });

          // Сохраняем все стили и атрибуты элементов
          const allElements = tempDiv.querySelectorAll("*");
          allElements.forEach((el) => {
            // Сохраняем inline стили
            if (el.style && el.style.cssText) {
              el.setAttribute("style", el.style.cssText);
            }
          });

          // Вставляем обработанный HTML
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            
            // Создаем фрагмент из обработанного HTML
            const fragment = document.createDocumentFragment();
            while (tempDiv.firstChild) {
              fragment.appendChild(tempDiv.firstChild);
            }
            range.insertNode(fragment);
            
            // Перемещаем курсор в конец вставленного контента
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
          } else {
            // Если нет выделения, просто добавляем в конец
            while (tempDiv.firstChild) {
              editor.appendChild(tempDiv.firstChild);
            }
          }
        } else if (textData) {
          // Если только текст, вставляем как обычный текст
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const textNode = document.createTextNode(textData);
            range.insertNode(textNode);
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }

        syncToTextarea();
      });

      function showVisual() {
        htmlWrap.classList.add("hidden");
        visualWrap.classList.remove("hidden");
        setActive(btnVisual, btnHtml);
        loadSignature();
      }

      function showHtml() {
        visualWrap.classList.add("hidden");
        htmlWrap.classList.remove("hidden");
        setActive(btnHtml, btnVisual);
        syncToTextarea();
      }

      btnVisual.addEventListener("click", showVisual);
      btnHtml.addEventListener("click", showHtml);

      // По умолчанию открываем визуальный режим
      showVisual();

      form.addEventListener("submit", () => {
        syncToTextarea();
      });
    })();
  </script>
  <style>
    #sigEditor:empty:before {
      content: "Напишите подпись письма...";
      color: rgba(0, 61, 56, 0.45);
      pointer-events: none;
    }
    /* В редакторе подписи не растягиваем картинки */
    #sigEditor img{
      max-width: 100% !important;
      height: auto !important;
      width: auto;
      object-fit: contain;
      display: inline-block;
      vertical-align: middle;
    }
    /* Сохраняем стили таблиц и других элементов из вставленного HTML */
    #sigEditor table {
      border-collapse: collapse;
      max-width: 100%;
    }
    #sigEditor td, #sigEditor th {
      padding: 4px 8px;
      border: 1px solid #ddd;
    }
    .btn-outline svg {
      width: 16px;
      height: 16px;
      stroke: #003D38;
      flex-shrink: 0;
    }
    .btn-outline:hover svg {
      stroke: #002825;
    }
  </style>
{% endblock %}


