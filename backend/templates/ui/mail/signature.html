{% extends "ui/base.html" %}
{% block title %}–ü–æ—á—Ç–∞ ‚Äî –ø–æ–¥–ø–∏—Å—å{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <div class="text-sm muted"><a class="link" href="/mail/campaigns/">–ü–æ—á—Ç–∞</a> /</div>
        <h1 class="text-2xl font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–∏</h1>
        <div class="muted text-sm">–ü–æ–¥–ø–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü –ø–∏—Å—å–º–∞.</div>
        <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
          –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç–µ —Å—Å—ã–ª–∫–∏ ‚Äî —É—á—Ç–∏—Ç–µ, —á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ—á—Ç–æ–≤–∏–∫–∏ –º–æ–≥—É—Ç —á–∞—â–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–∞–∫–∏–µ –ø–∏—Å—å–º–∞ –≤ —Å–ø–∞–º.
          –≠—Ç–æ –Ω–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.
        </div>
      </div>
      <a class="btn btn-outline" href="/mail/campaigns/">–ù–∞–∑–∞–¥</a>
    </div>

    <form method="post" class="card card-pad space-y-3" id="sigForm">
      {% csrf_token %}

      <div>
        <div class="flex items-end justify-between gap-2 mb-2">
          <label class="block text-sm muted">–ü–æ–¥–ø–∏—Å—å</label>
          <div class="flex gap-2">
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="sigBtnVisual">–í–∏–∑—É–∞–ª—å–Ω—ã–π</button>
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="sigBtnHtml">HTML‚Äë–∫–æ–¥</button>
          </div>
        </div>

        {# HTML-—Ä–µ–∂–∏–º (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã) #}
        <div id="sigHtmlWrap" class="hidden">
          {{ form.signature_html }}
          <div class="text-xs muted-2 mt-1">–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å HTML –≤—Ä—É—á–Ω—É—é.</div>
        </div>

        {# –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä: contenteditable + –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ #}
        <div id="sigVisualWrap">
          <div class="rounded-lg border border-brand-soft bg-brand-soft/40 px-2 py-1 mb-2 flex flex-wrap items-center gap-1 text-xs">
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="bold" title="–ñ–∏—Ä–Ω—ã–π"><b>–ñ</b></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="italic" title="–ö—É—Ä—Å–∏–≤"><i>–ö</i></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="underline" title="–ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ"><u>–ß</u></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="strikeThrough" title="–ó–∞—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ"><s>–ó</s></button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <select id="sigFont" class="select !py-1 !px-2 text-xs" title="–®—Ä–∏—Ñ—Ç">
              <option value="">–®—Ä–∏—Ñ—Ç</option>
              <option value="Arial" style="font-family:Arial;">Arial</option>
              <option value="Tahoma" style="font-family:Tahoma;">Tahoma</option>
              <option value="Times New Roman" style="font-family:'Times New Roman';">Times New Roman</option>
              <option value="Courier New" style="font-family:'Courier New';">Courier New</option>
            </select>
            <select id="sigSize" class="select !py-1 !px-2 text-xs" title="–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞">
              <option value="">–†–∞–∑–º–µ—Ä</option>
              <option value="2">10</option>
              <option value="3">11</option>
              <option value="4">12</option>
              <option value="5">13</option>
              <option value="6">14</option>
              <option value="7">16</option>
            </select>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyLeft" title="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é">‚¨Ö</button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyCenter" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚Üî</button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyRight" title="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é">‚û°</button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="insertUnorderedList" title="–ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">‚Ä¢</button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="insertOrderedList" title="–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">1.</button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" id="sigLinkBtn" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É">üîó</button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="removeFormat" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">Tx</button>
          </div>

          <div class="rounded-xl border border-brand-soft bg-white p-3 overflow-x-auto">
            <div id="sigEditor" contenteditable="true" class="min-h-[220px] outline-none text-sm" style="white-space:pre-wrap;"></div>
          </div>
          <div class="text-xs muted-2 mt-2">
            –ú–æ–∂–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç, –¥–æ–±–∞–≤–ª—è—Ç—å —Å–ø–∏—Å–∫–∏ –∏ —Å—Å—ã–ª–∫–∏. –ü–æ–¥–ø–∏—Å—å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤ –∫–æ–Ω–µ—Ü –ø–∏—Å—å–º–∞ –∫–∞–∫ –µ—Å—Ç—å.
          </div>
        </div>
      </div>

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a class="btn btn-outline" href="/mail/campaigns/">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const form = document.getElementById("sigForm");
      const htmlWrap = document.getElementById("sigHtmlWrap");
      const visualWrap = document.getElementById("sigVisualWrap");
      const btnVisual = document.getElementById("sigBtnVisual");
      const btnHtml = document.getElementById("sigBtnHtml");
      const editor = document.getElementById("sigEditor");
      const htmlField = document.getElementById("id_signature_html");
      const linkBtn = document.getElementById("sigLinkBtn");
      const fontSelect = document.getElementById("sigFont");
      const sizeSelect = document.getElementById("sigSize");

      if (!form || !editor || !htmlField || !btnVisual || !btnHtml) return;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å—å
      editor.innerHTML = htmlField.value || "";

      function setActive(btnOn, btnOff) {
        btnOn.classList.add("bg-brand-soft/40");
        btnOff.classList.remove("bg-brand-soft/40");
      }

      function syncToTextarea() {
        htmlField.value = editor.innerHTML || "";
      }

      // toolbar commands
      document.querySelectorAll("[data-cmd]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const cmd = btn.getAttribute("data-cmd");
          if (!cmd) return;
          document.execCommand(cmd, false, null);
          editor.focus();
          syncToTextarea();
        });
      });

      if (linkBtn) {
        linkBtn.addEventListener("click", () => {
          const url = prompt("–°—Å—ã–ª–∫–∞ (https://...)");
          if (!url) return;
          document.execCommand("createLink", false, url);
          editor.focus();
          syncToTextarea();
        });
      }

      if (fontSelect) {
        fontSelect.addEventListener("change", () => {
          const v = fontSelect.value;
          if (!v) return;
          document.execCommand("fontName", false, v);
          editor.focus();
          syncToTextarea();
        });
      }

      if (sizeSelect) {
        sizeSelect.addEventListener("change", () => {
          const v = sizeSelect.value;
          if (!v) return;
          document.execCommand("fontSize", false, v);
          editor.focus();
          syncToTextarea();
        });
      }

      editor.addEventListener("input", syncToTextarea);

      function showVisual() {
        htmlWrap.classList.add("hidden");
        visualWrap.classList.remove("hidden");
        setActive(btnVisual, btnHtml);
        editor.innerHTML = htmlField.value || "";
      }

      function showHtml() {
        visualWrap.classList.add("hidden");
        htmlWrap.classList.remove("hidden");
        setActive(btnHtml, btnVisual);
        syncToTextarea();
      }

      btnVisual.addEventListener("click", showVisual);
      btnHtml.addEventListener("click", showHtml);

      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
      showVisual();

      form.addEventListener("submit", () => {
        syncToTextarea();
      });
    })();
  </script>
  <style>
    #sigEditor:empty:before {
      content: "–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å –ø–∏—Å—å–º–∞...";
      color: rgba(0, 61, 56, 0.45);
      pointer-events: none;
    }
  </style>
{% endblock %}


