{% extends "ui/base.html" %}
{% block title %}Почта — подпись{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <div class="text-sm muted"><a class="link" href="/mail/campaigns/">Почта</a> /</div>
        <h1 class="text-2xl font-semibold">Настройка подписи</h1>
        <div class="muted text-sm">Подпись автоматически добавится в конец письма.</div>
        <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
          Если добавляете ссылки — учтите, что некоторые почтовики могут чаще отправлять такие письма в спам.
          Это не запрещено, просто предупреждение.
        </div>
      </div>
      <a class="btn btn-outline" href="/mail/campaigns/">Назад</a>
    </div>

    <form method="post" class="card card-pad space-y-3" id="sigForm">
      {% csrf_token %}

      <div>
        <div class="flex items-end justify-between gap-2 mb-2">
          <label class="block text-sm muted">Подпись</label>
          <div class="flex gap-2">
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="sigBtnVisual">Визуальный</button>
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="sigBtnHtml">HTML‑код</button>
          </div>
        </div>

        {# HTML-режим (оригинальное поле формы) #}
        <div id="sigHtmlWrap" class="hidden">
          {{ form.signature_html }}
          <div class="text-xs muted-2 mt-1">Можно писать HTML вручную.</div>
        </div>

        {# Визуальный редактор: contenteditable + панель инструментов #}
        <div id="sigVisualWrap">
          <div class="rounded-lg border border-brand-soft bg-brand-soft/40 px-2 py-1 mb-2 flex flex-nowrap items-center gap-1 text-xs overflow-x-auto">
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="bold" title="Жирный"><b>Ж</b></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="italic" title="Курсив"><i>К</i></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="underline" title="Подчёркивание"><u>Ч</u></button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="strikeThrough" title="Зачёркивание"><s>З</s></button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <select id="sigFont" class="select !py-1 !px-2 text-xs" title="Шрифт">
              <option value="">Шрифт</option>
              <option value="Arial" style="font-family:Arial;">Arial</option>
              <option value="Tahoma" style="font-family:Tahoma;">Tahoma</option>
              <option value="Times New Roman" style="font-family:'Times New Roman';">Times New Roman</option>
              <option value="Courier New" style="font-family:'Courier New';">Courier New</option>
            </select>
            <select id="sigSize" class="select !py-1 !px-2 text-xs" title="Размер шрифта">
              <option value="">Размер</option>
              <option value="10" data-html-size="2">10</option>
              <option value="11" data-html-size="2">11</option>
              <option value="12" data-html-size="3">12</option>
              <option value="13" data-html-size="3">13</option>
              <option value="14" data-html-size="4">14</option>
              <option value="15" data-html-size="4">15</option>
              <option value="16" data-html-size="5">16</option>
              <option value="18" data-html-size="6">18</option>
              <option value="20" data-html-size="6">20</option>
              <option value="28" data-html-size="7">28</option>
            </select>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyLeft" title="Выровнять по левому краю">
              <span class="mail-icon-align mail-icon-align-left"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyCenter" title="По центру">
              <span class="mail-icon-align mail-icon-align-center"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="justifyRight" title="Выровнять по правому краю">
              <span class="mail-icon-align mail-icon-align-right"></span>
            </button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="insertUnorderedList" title="Маркированный список">
              <span class="mail-icon-list mail-icon-list-bullet"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="insertOrderedList" title="Нумерованный список">
              <span class="mail-icon-list mail-icon-list-number"></span>
            </button>

            <span class="mx-1 h-4 w-px bg-brand-soft"></span>

            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" id="sigLinkBtn" title="Вставить ссылку">
              <span class="mail-icon-link"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" id="sigUnlinkBtn" title="Убрать ссылку">
              <span class="mail-icon-unlink"></span>
            </button>
            <button type="button" class="btn btn-outline" style="padding:.15rem .4rem" data-cmd="removeFormat" title="Очистить форматирование">
              <span class="mail-icon-eraser"></span>
            </button>
          </div>

          <div class="rounded-xl border border-brand-soft bg-white p-3 overflow-x-auto">
            <div id="sigEditor" contenteditable="true" class="min-h-[220px] outline-none text-sm" style="white-space:pre-wrap;"></div>
          </div>
          <div class="text-xs muted-2 mt-2">
            Можно форматировать текст, добавлять списки и ссылки. Подпись будет добавляться в конец письма как есть.
          </div>
        </div>
      </div>

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">Сохранить</button>
        <a class="btn btn-outline" href="/mail/campaigns/">Отмена</a>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const form = document.getElementById("sigForm");
      const htmlWrap = document.getElementById("sigHtmlWrap");
      const visualWrap = document.getElementById("sigVisualWrap");
      const btnVisual = document.getElementById("sigBtnVisual");
      const btnHtml = document.getElementById("sigBtnHtml");
      const editor = document.getElementById("sigEditor");
      const htmlField = document.getElementById("id_signature_html");
      const linkBtn = document.getElementById("sigLinkBtn");
      const unlinkBtn = document.getElementById("sigUnlinkBtn");
      const fontSelect = document.getElementById("sigFont");
      const sizeSelect = document.getElementById("sigSize");

      if (!form || !editor || !htmlField || !btnVisual || !btnHtml) return;

      // Инициализация: подставляем существующую подпись
      editor.innerHTML = htmlField.value || "";

      function setActive(btnOn, btnOff) {
        btnOn.classList.add("bg-brand-soft/40");
        btnOff.classList.remove("bg-brand-soft/40");
      }

      function syncToTextarea() {
        htmlField.value = editor.innerHTML || "";
      }

      // toolbar commands
      document.querySelectorAll("[data-cmd]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const cmd = btn.getAttribute("data-cmd");
          if (!cmd) return;
          document.execCommand(cmd, false, null);
          editor.focus();
          syncToTextarea();
        });
      });

      if (linkBtn) {
        linkBtn.addEventListener("click", () => {
          const url = prompt("Ссылка (https://...)");
          if (!url) return;
          document.execCommand("createLink", false, url);
          editor.focus();
          syncToTextarea();
        });
      }

      if (unlinkBtn) {
        unlinkBtn.addEventListener("click", () => {
          document.execCommand("unlink", false, null);
          editor.focus();
          syncToTextarea();
        });
      }

      if (fontSelect) {
        fontSelect.addEventListener("change", () => {
          const v = fontSelect.value;
          if (!v) return;
          document.execCommand("fontName", false, v);
          editor.focus();
          syncToTextarea();
        });
      }

      if (sizeSelect) {
        sizeSelect.addEventListener("change", () => {
          const opt = sizeSelect.selectedOptions[0];
          if (!opt) return;
          const htmlSize = opt.getAttribute("data-html-size") || "3";
          document.execCommand("fontSize", false, htmlSize);
          editor.focus();
          syncToTextarea();
        });
      }

      editor.addEventListener("input", syncToTextarea);

      function showVisual() {
        htmlWrap.classList.add("hidden");
        visualWrap.classList.remove("hidden");
        setActive(btnVisual, btnHtml);
        editor.innerHTML = htmlField.value || "";
      }

      function showHtml() {
        visualWrap.classList.add("hidden");
        htmlWrap.classList.remove("hidden");
        setActive(btnHtml, btnVisual);
        syncToTextarea();
      }

      btnVisual.addEventListener("click", showVisual);
      btnHtml.addEventListener("click", showHtml);

      // По умолчанию открываем визуальный режим
      showVisual();

      form.addEventListener("submit", () => {
        syncToTextarea();
      });
    })();
  </script>
  <style>
    #sigEditor:empty:before {
      content: "Напишите подпись письма...";
      color: rgba(0, 61, 56, 0.45);
      pointer-events: none;
    }

    .mail-icon-align {
      display:inline-block;
      width:14px;
      height:10px;
      position:relative;
    }
    .mail-icon-align::before,
    .mail-icon-align::after {
      content:"";
      position:absolute;
      left:0;
      right:0;
      height:2px;
      background-color:#003D38;
      border-radius:999px;
    }
    .mail-icon-align::before { top:1px; }
    .mail-icon-align::after { bottom:1px; opacity:.7; }

    .mail-icon-list {
      display:inline-block;
      width:14px;
      height:10px;
      position:relative;
    }
    .mail-icon-list::before,
    .mail-icon-list::after {
      content:"";
      position:absolute;
      left:5px;
      right:0;
      height:2px;
      background-color:#003D38;
      border-radius:999px;
    }
    .mail-icon-list::before { top:1px; }
    .mail-icon-list::after { bottom:1px; opacity:.7; }

    .mail-icon-link,
    .mail-icon-unlink {
      display:inline-block;
      width:14px;
      height:10px;
      border-radius:999px;
      border:1px solid #003D38;
      position:relative;
    }
    .mail-icon-link::before,
    .mail-icon-unlink::before {
      content:"";
      position:absolute;
      top:3px;
      bottom:3px;
      left:3px;
      right:3px;
      border-top:1px solid #003D38;
    }
    .mail-icon-unlink::after {
      content:"";
      position:absolute;
      left:2px;
      right:2px;
      top:1px;
      bottom:1px;
      border-top:1px solid transparent;
      border-left:1px solid #003D38;
      transform:rotate(-45deg);
    }

    .mail-icon-eraser {
      display:inline-block;
      width:12px;
      height:9px;
      border-radius:2px;
      border:1px solid #003D38;
      transform:skewX(-15deg);
    }
  </style>
{% endblock %}


