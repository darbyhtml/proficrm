{% extends "ui/base.html" %}
{% block title %}Почта — подпись{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <div class="text-sm muted"><a class="link" href="/mail/campaigns/">Почта</a> /</div>
        <h1 class="text-2xl font-semibold">Настройка подписи</h1>
        <div class="muted text-sm">Подпись автоматически добавится в конец письма.</div>
        <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
          Если добавляете ссылки — учтите, что некоторые почтовики могут чаще отправлять такие письма в спам.
          Это не запрещено, просто предупреждение.
        </div>
      </div>
      <a class="btn btn-outline" href="/mail/campaigns/">Назад</a>
    </div>

    <form method="post" class="card card-pad space-y-3">
      {% csrf_token %}
      <div>
        <div class="flex items-end justify-between gap-2 mb-2">
          <label class="block text-sm muted">Подпись (HTML)</label>
          <div class="flex gap-2">
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="btn-visual">Визуальный</button>
            <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="btn-html">HTML‑код</button>
          </div>
        </div>

        {# Оригинальное поле формы — храним HTML сюда #}
        <div id="html-wrap" class="hidden">
          {{ form.signature_html }}
          <div class="text-xs muted-2 mt-1">Можно писать HTML вручную.</div>
        </div>

        {# Визуальный редактор #}
        <div id="visual-wrap">
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
          <div id="quill-editor" style="min-height:260px;border-radius:12px"></div>
          <div class="text-xs muted-2 mt-2">Редактор сохраняет результат в поле HTML автоматически.</div>
        </div>
      </div>

      {% if form.errors %}
        <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">Проверь поля формы.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">Сохранить</button>
        <a class="btn btn-outline" href="/mail/campaigns/">Отмена</a>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script>
    (function () {
      const htmlWrap = document.getElementById("html-wrap");
      const visualWrap = document.getElementById("visual-wrap");
      const btnVisual = document.getElementById("btn-visual");
      const btnHtml = document.getElementById("btn-html");
      const htmlField = document.querySelector('textarea[name="signature_html"]');

      function getQuillHtml(quill) {
        const el = document.querySelector('#quill-editor .ql-editor');
        return el ? el.innerHTML : "";
      }

      function setActive(btnOn, btnOff) {
        btnOn.classList.add("bg-brand-soft/40");
        btnOff.classList.remove("bg-brand-soft/40");
      }

      // init quill с полным набором инструментов (как в письме)
      const quill = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            [{ 'font': [] }, { 'size': [] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link', 'image'],
            ['clean']
          ]
        }
      });
      let isUpdating = false;
      let htmlDebounce = null;

      function syncFromQuill() {
        if (!htmlField) return;
        if (isUpdating) return;
        isUpdating = true;
        const html = getQuillHtml(quill);
        htmlField.value = html;
        isUpdating = false;
      }

      function syncFromHtmlField() {
        if (!htmlField) return;
        if (isUpdating) return;
        isUpdating = true;
        const html = htmlField.value || "";
        quill.clipboard.dangerouslyPasteHTML(html);
        isUpdating = false;
      }

      // initial sync
      if (htmlField && htmlField.value) {
        syncFromHtmlField();
      }

      quill.on('text-change', function() {
        syncFromQuill();
      });

      if (htmlField) {
        htmlField.addEventListener('input', () => {
          if (htmlDebounce) clearTimeout(htmlDebounce);
          htmlDebounce = setTimeout(() => {
            syncFromHtmlField();
          }, 250);
        });
      }

      function showVisual() {
        htmlWrap.classList.add("hidden");
        visualWrap.classList.remove("hidden");
        setActive(btnVisual, btnHtml);
        if (htmlField) syncFromHtmlField();
      }
      function showHtml() {
        visualWrap.classList.add("hidden");
        htmlWrap.classList.remove("hidden");
        setActive(btnHtml, btnVisual);
        syncFromQuill();
      }

      btnVisual.addEventListener("click", showVisual);
      btnHtml.addEventListener("click", showHtml);

      // default: visual
      showVisual();

      // При отправке формы синхронизируем из Quill в textarea
      document.querySelector('form').addEventListener('submit', function() {
        syncFromQuill();
      });
    })();
  </script>
{% endblock %}


