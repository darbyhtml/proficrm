{% extends "ui/base.html" %}
{% block title %}Почта — Настройки{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <h1 class="text-2xl font-semibold">Почта: настройки SMTP</h1>
      <div class="muted text-sm">Для Яндекса обычно: smtp.yandex.ru:587 + STARTTLS + пароль приложения.</div>
    </div>

    {% if key_missing %}
      <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
        Важно: не задан <b>MAILER_FERNET_KEY</b>. Пока он не задан, пароль приложения сохранить нельзя (мы шифруем его перед записью в БД).
      </div>
    {% endif %}

    <details class="card card-pad">
      <summary class="cursor-pointer font-medium">Как подключить Яндекс 360 (быстро)</summary>
      <div class="mt-3 text-sm muted space-y-2">
        <div>1) В Яндексе создайте <b>пароль приложения</b> для почты (не основной пароль).</div>
        <div>2) Заполните SMTP: <span class="font-mono">smtp.yandex.ru</span>, порт <span class="font-mono">587</span>, включите <b>STARTTLS</b>.</div>
        <div>3) Нажмите <b>Проверить отправку</b> — CRM отправит тестовое письмо на ваш адрес.</div>
        <div class="text-xs muted-2">OAuth через `https://oauth.yandex.ru/` возможен только если подтвердится официальная поддержка отправки по OAuth (SMTP XOAUTH2 или Mail API). Если у вас появится такая возможность — переключим без паролей.</div>
      </div>
    </details>

    <form method="post" class="card card-pad space-y-3">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm muted mb-1">SMTP host</label>
          {{ form.smtp_host }}
        </div>
        <div>
          <label class="block text-sm muted mb-1">SMTP port</label>
          {{ form.smtp_port }}
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm">
        {{ form.use_starttls }} <span class="muted">STARTTLS</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm muted mb-1">Логин SMTP</label>
          {{ form.smtp_username }}
        </div>
        <div>
          <label class="block text-sm muted mb-1">Пароль приложения (Яндекс)</label>
          {{ form.smtp_password }}
          <div class="text-xs muted-2 mt-1">{{ form.smtp_password.help_text }}</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="block text-sm muted mb-1">Email отправителя</label>
          {{ form.from_email }}
        </div>
        <div>
          <label class="block text-sm muted mb-1">Имя отправителя</label>
          {{ form.from_name }}
        </div>
        <div>
          <label class="block text-sm muted mb-1">Reply-To</label>
          {{ form.reply_to }}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm muted mb-1">Лимит в минуту</label>
          {{ form.rate_per_minute }}
        </div>
        <div>
          <label class="block text-sm muted mb-1">Лимит в день</label>
          {{ form.rate_per_day }}
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm">
        {{ form.is_enabled }} <span class="muted">Включить отправку</span>
      </div>

      {% if form.errors %}
        <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">Проверь поля формы.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">Сохранить</button>
        <button class="btn btn-outline" type="submit" name="test_send" value="1">Проверить отправку</button>
      </div>
    </form>
  </div>
{% endblock %}


