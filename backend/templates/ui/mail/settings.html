{% extends "ui/base.html" %}
{% block title %}Почта — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <h1 class="text-2xl font-semibold">Почта: настройки SMTP</h1>
      <div class="muted text-sm">
        {% if is_admin %}
          Администратор настраивает SMTP один раз — менеджерам ничего вводить не нужно.
        {% else %}
          SMTP настраивается администратором. Ваш адрес отправителя будет: <b>{{ user_sender_email|default:"(не задан в профиле)" }}</b>
        {% endif %}
      </div>
    </div>

    {% if key_missing %}
      <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
        Важно: не задан <b>MAILER_FERNET_KEY</b>. Пока он не задан, пароль приложения сохранить нельзя (мы шифруем его перед записью в БД).
      </div>
    {% endif %}

    <details class="card card-pad">
      <summary class="cursor-pointer font-medium">Как подключить smtp.bz (FREE) — быстро</summary>
      <div class="mt-3 text-sm muted space-y-2">
        <div>1) В кабинете smtp.bz создайте <b>логин/пароль SMTP</b> (мы их сохраним в БД в зашифрованном виде).</div>
        <div>2) Заполните SMTP: <span class="font-mono">connect.smtp.bz</span>, порт <span class="font-mono">587</span>, включите <b>STARTTLS</b> (альтернатива: порт <span class="font-mono">2525</span>).</div>
        <div>3) Получите <b>API ключ</b> в личном кабинете smtp.bz и введите его в поле ниже. Лимиты и квота будут синхронизироваться автоматически.</div>
        <div>4) Нажмите <b>Проверить отправку</b> — CRM отправит тестовое письмо на ваш email (из профиля).</div>
      </div>
    </details>

    {% if is_admin %}
      <form method="post" class="card card-pad space-y-3">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm muted mb-1">SMTP host</label>
            {{ form.smtp_host }}
          </div>
          <div>
            <label class="block text-sm muted mb-1">SMTP port</label>
            {{ form.smtp_port }}
          </div>
        </div>

        <div class="flex items-center gap-2 text-sm">
          {{ form.use_starttls }} <span class="muted">STARTTLS</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm muted mb-1">Логин SMTP</label>
            {{ form.smtp_username }}
          </div>
          <div>
            <label class="block text-sm muted mb-1">Пароль SMTP</label>
            {{ form.smtp_password }}
            <div class="text-xs muted-2 mt-1">{{ form.smtp_password.help_text }}</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm muted mb-1">Email отправителя (From)</label>
            {{ form.from_email }}
            <div class="text-xs muted-2 mt-1">Все рассылки будут уходить с этого адреса (например: <span class="font-mono">no-reply@groupprofi.ru</span>).</div>
          </div>
          <div>
            <label class="block text-sm muted mb-1">Reply-To (автоматически)</label>
            <div class="input bg-brand-soft/20" style="display:flex;align-items:center">email менеджера из профиля</div>
            <div class="text-xs muted-2 mt-1">Чтобы получатели отвечали конкретному менеджеру.</div>
          </div>
        </div>

        <div>
          <label class="block text-sm muted mb-1">Имя отправителя (по умолчанию)</label>
          {{ form.from_name }}
          <div class="text-xs muted-2 mt-1">Если у пользователя задано ФИО — оно будет использоваться, иначе это значение.</div>
        </div>

        <div class="border-t border-brand-soft pt-3">
          <div class="font-medium mb-2">Интеграция с API smtp.bz</div>
          <div>
            <label class="block text-sm muted mb-1">API ключ smtp.bz</label>
            {{ form.smtp_bz_api_key }}
            <div class="text-xs muted-2 mt-1">{{ form.smtp_bz_api_key.help_text }}</div>
          </div>
          
          {% if has_api_key %}
            <div class="mt-3 p-3 rounded-lg border {% if api_connected %}border-green-300 bg-green-50{% elif api_pending %}border-yellow-300 bg-yellow-50{% else %}border-orange-300 bg-orange-50{% endif %}">
              <div class="text-sm font-medium {% if api_connected %}text-green-900{% elif api_pending %}text-yellow-900{% else %}text-orange-900{% endif %} mb-2">
                {% if api_connected %}
                  ✅ Подключение к API активно
                {% elif api_pending %}
                  ⏳ Ожидание синхронизации...
                {% else %}
                  ⚠️ Ошибка подключения к API
                {% endif %}
              </div>
              {% if quota.last_synced_at %}
                <div class="text-xs {% if api_connected %}text-green-800{% elif api_pending %}text-yellow-800{% else %}text-orange-800{% endif %}">
                  Последняя синхронизация: {{ quota.last_synced_at|date:"d.m.Y H:i" }}
                </div>
              {% elif api_pending %}
                <div class="text-xs text-yellow-800">
                  Синхронизация запущена, ожидайте обновления данных...
                </div>
              {% endif %}
              {% if quota.sync_error %}
                <div class="text-xs text-red-600 mt-1">
                  <b>Ошибка:</b> {{ quota.sync_error|truncatechars:200 }}
                  <div class="mt-1 text-xs">Проверьте правильность API ключа в личном кабинете smtp.bz</div>
                </div>
              {% endif %}
              {% if api_connected and quota.emails_limit > 0 %}
                <div class="text-xs {% if api_connected %}text-green-800{% else %}text-orange-800{% endif %} mt-2">
                  Тариф: <b>{{ quota.tariff_name|default:"—" }}</b> | 
                  Доступно: <b>{{ quota.emails_available }} / {{ quota.emails_limit }}</b> | 
                  Лимит в час: <b>{{ quota.max_per_hour }}</b>
                </div>
              {% endif %}
            </div>
          {% else %}
            <div class="mt-3 p-3 rounded-lg border border-gray-300 bg-gray-50">
              <div class="text-sm font-medium text-gray-700 mb-2">
                ℹ️ API ключ не указан
              </div>
              <div class="text-xs text-gray-600">
                Введите API ключ для автоматической синхронизации квоты и лимитов
              </div>
            </div>
          {% endif %}
        </div>

        <div class="flex items-center gap-2 text-sm">
          {{ form.is_enabled }} <span class="muted">Включить отправку</span>
        </div>

        {% if form.errors %}
          <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">Проверь поля формы.</div>
        {% endif %}

        <div class="flex gap-2">
          <button class="btn btn-primary" type="submit">Сохранить</button>
          <button class="btn btn-outline" type="submit" name="test_send" value="1">Проверить отправку</button>
        </div>
      </form>
    {% else %}
      <div class="card card-pad">
        <div class="text-sm">
          <div class="font-medium mb-1">Отправка настроена администратором</div>
          <div class="muted">При отправке кампаний будет использоваться ваш email как <b>From</b> и <b>Reply-To</b>.</div>
          {% if not user_sender_email %}
            <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
              В вашем профиле не задан email. Адрес отправителя подставить нельзя — попросите администратора заполнить email в карточке пользователя.
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}


