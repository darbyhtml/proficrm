{% extends "ui/base.html" %}
{% block title %}{{ campaign.name }} ‚Äî CRM –ü–†–û–§–ò{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
      <div class="flex-1">
        <div class="text-sm muted mb-1"><a class="link" href="/mail/campaigns/">–ü–æ—á—Ç–∞</a> /</div>
        <div class="flex items-center gap-3 flex-wrap">
          <h1 class="text-2xl font-semibold">{{ campaign.name }}</h1>
          <span class="badge {% if campaign.status == 'sending' %}bg-green-100 text-green-800{% elif campaign.status == 'paused' %}bg-orange-100 text-orange-800{% elif campaign.status == 'sent' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-800{% endif %}">
            {{ campaign.get_status_display }}
          </span>
        </div>
        <div class="text-sm text-brand-dark/70 mt-1">
          <span>–¢–µ–º–∞: <b>{{ campaign.subject }}</b></span>
          {% if campaign.attachment %}
            <span class="ml-3 inline-flex items-center gap-1 text-blue-600">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
              </svg>
              <span>–í–ª–æ–∂–µ–Ω–∏–µ ({{ campaign.attachment.size|filesizeformat }})</span>
            </span>
          {% endif %}
        </div>
        <details class="mt-2">
          <summary class="text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏</summary>
          <div class="text-xs text-brand-dark/60 mt-1 space-y-1">
            <div>From: {{ smtp_from_email|default:"‚Äî" }}</div>
            <div>–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: {{ campaign.sender_name|default:smtp_from_name_default }}</div>
            <div>Reply-To: {{ request.user.email|default:"‚Äî" }}</div>
          </div>
        </details>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <div class="lg:col-span-8 space-y-4">
        <details class="card card-pad">
          <summary class="cursor-pointer font-medium">üìß –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–∏—Å—å–º–∞</summary>
          <div class="mt-3">
            {% if campaign.body_html %}
              {# –ò—Å–ø–æ–ª—å–∑—É–µ–º sandbox –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π #}
              <iframe 
                class="w-full" 
                style="height:300px;border:1px solid rgba(194,226,222,.95);border-radius:8px;background:#fff" 
                srcdoc='<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; padding:14px; color:#003D38} a{color:#01948E} img{max-width:100%;height:auto}</style></head><body>{{ campaign.body_html|safe }}</body></html>'
                sandbox="allow-same-origin"
              ></iframe>
              <details class="mt-2">
                <summary class="text-xs text-brand-dark/50 cursor-pointer">‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏?</summary>
                <div class="text-xs muted-2 mt-1">
                  –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è, –≤–æ–∑–º–æ–∂–Ω–æ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º. 
                  –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∏—Å—å–º–∞—Ö —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–∫ base64 (data:image/...) –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏—Ö –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä.
                </div>
              </details>
            {% else %}
              <div class="text-sm p-3 bg-gray-50 rounded border" style="white-space:pre-wrap">{{ campaign.body_text }}</div>
            {% endif %}
          </div>
        </details>

        <div class="card card-pad">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
            <div>
              <div class="font-medium">üë• –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ ({{ counts.total }})</div>
              <div class="text-sm muted mt-1">–î–æ–±–∞–≤—å—Ç–µ email –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º</div>
            </div>
            <form method="post" action="/mail/campaigns/{{ campaign.id }}/recipients/add/" class="flex gap-2 items-end">
              {% csrf_token %}
              <div style="min-width:240px">
                <label class="block text-xs muted mb-1">–î–æ–±–∞–≤–∏—Ç—å email</label>
                {{ recipient_add_form.email }}
              </div>
              <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
          </div>
        </div>

        {% if recipients_by_company %}
          <div class="card card-pad">
            <div class="font-medium mb-3 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <input type="checkbox" id="selectAllRecipientsGrouped" title="–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ" />
                <span>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ ({{ counts.total }} –≤—Å–µ–≥–æ)</span>
              </div>
              <div class="flex items-center gap-2">
                <a class="btn btn-outline {% if view == 'pending' %}bg-brand-soft/50 font-medium{% endif %}" style="padding:.25rem .6rem;font-size:.75rem" href="?view=pending{% if qs %}&{{ qs }}{% endif %}">–í –æ—á–µ—Ä–µ–¥–∏ ({{ counts.pending }})</a>
                <a class="btn btn-outline {% if view == 'sent' %}bg-brand-soft/50 font-medium{% endif %}" style="padding:.25rem .6rem;font-size:.75rem" href="?view=sent{% if qs %}&{{ qs }}{% endif %}">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ({{ counts.sent }})</a>
                <a class="btn btn-outline {% if view == 'failed' %}bg-brand-soft/50 font-medium{% endif %}" style="padding:.25rem .6rem;font-size:.75rem" href="?view=failed{% if qs %}&{{ qs }}{% endif %}">–û—à–∏–±–∫–∏ ({{ counts.failed }})</a>
                <a class="btn btn-outline {% if view == 'unsub' %}bg-brand-soft/50 font-medium{% endif %}" style="padding:.25rem .6rem;font-size:.75rem" href="?view=unsub{% if qs %}&{{ qs }}{% endif %}">–û—Ç–ø–∏—Å–∫–∏ ({{ counts.unsub }})</a>
                <a class="btn btn-outline {% if view == 'all' %}bg-brand-soft/50 font-medium{% endif %}" style="padding:.25rem .6rem;font-size:.75rem" href="?view=all{% if qs %}&{{ qs }}{% endif %}">–í—Å–µ</a>
              </div>
              {% if page %}
                <form method="post" action="/mail/campaigns/{{ campaign.id }}/recipients/bulk-delete/" id="bulkDeleteForm" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π?');" style="display:none;">
                  {% csrf_token %}
                  <button type="submit" class="btn" style="background:#dc2626;color:#fff;padding:.5rem 1rem;font-size:.875rem">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                </form>
              {% endif %}
            </div>
            <div class="space-y-4">
              {% for company_id, data in recipients_by_company.items %}
                <div class="border border-brand-soft rounded-lg p-4">
                  <div class="font-medium mb-3 flex items-center gap-2">
                    <input type="checkbox" class="company-select-all" data-company-id="{{ company_id }}" title="–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ –≤ —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏" />
                    {% if data.company %}
                      <a href="/companies/{{ data.company.id }}/" class="text-brand-teal hover:underline text-lg">{{ data.company.name }}</a>
                    {% else %}
                      <span class="muted text-lg">–ë–µ–∑ –∫–æ–º–ø–∞–Ω–∏–∏</span>
                    {% endif %}
                    <span class="badge">{{ data.recipients|length }} email{{ data.recipients|length|pluralize:",–æ–≤" }}</span>
                  </div>
                  <div class="space-y-2">
                    {% for r in data.recipients %}
                      <div class="flex items-start justify-between gap-3 p-2 border border-brand-soft/50 rounded hover:bg-brand-soft/20">
                        <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                            <input type="checkbox" name="recipient_ids" value="{{ r.id }}" class="recipient-checkbox company-{{ company_id }}-checkbox" />
                            <span class="font-mono text-sm font-medium">{{ r.email }}</span>
                            <span class="badge {% if r.status == 'failed' %}badge-warn{% elif r.status == 'sent' %}bg-green-100 text-green-800{% elif r.status == 'unsubscribed' %}bg-gray-100 text-gray-800{% endif %} text-xs">{{ r.get_status_display }}</span>
                          </div>
                          {% if r.contact_id and r.contact %}
                            <div class="text-sm text-brand-dark/80">
                              <span class="font-medium">{{ r.contact.last_name }} {{ r.contact.first_name }}</span>
                              {% if r.contact.position %}
                                <span class="muted"> ¬∑ {{ r.contact.position }}</span>
                              {% endif %}
                            </div>
                            <div class="text-xs muted-2 mt-0.5">–∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–∞</div>
                          {% elif data.company and data.company.contact_name %}
                            <div class="text-sm text-brand-dark/80">
                              <span class="font-medium">{{ data.company.contact_name }}</span>
                              {% if data.company.contact_position %}
                                <span class="muted"> ¬∑ {{ data.company.contact_position }}</span>
                              {% endif %}
                            </div>
                            <div class="text-xs muted-2 mt-0.5">–æ—Å–Ω–æ–≤–Ω–æ–π email –∫–æ–º–ø–∞–Ω–∏–∏</div>
                          {% else %}
                            <div class="text-xs muted-2">–æ—Å–Ω–æ–≤–Ω–æ–π email –∫–æ–º–ø–∞–Ω–∏–∏</div>
                          {% endif %}
                        </div>
                        <div class="flex items-center gap-2">
                          <form method="post" action="/mail/campaigns/{{ campaign.id }}/recipients/{{ r.id }}/delete/" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è {{ r.email }}?');" style="display:inline;">
                            {% csrf_token %}
                            <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.7rem" type="submit" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                          </form>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
            
            {% if page.has_other_pages %}
              <div class="border-t border-brand-soft mt-4 pt-4">
                <div class="flex items-center justify-between gap-4 flex-wrap">
                  <div class="flex items-center gap-2">
                    <form method="get" class="flex items-center gap-2" id="perPageForm">
                      <label class="text-sm text-brand-dark/80 whitespace-nowrap">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                      <select name="per_page" class="select" onchange="this.form.submit()" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                        <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                      </select>
                    </form>
                  </div>
                  <div class="flex items-center gap-2">
                    {% if page.has_previous %}
                      <a href="?page={{ page.previous_page_number }}{% if qs %}&{{ qs }}{% endif %}" class="btn btn-outline" style="padding:.35rem .75rem;font-size:.875rem">‚Üê –ù–∞–∑–∞–¥</a>
                    {% endif %}
                    <span class="text-sm text-brand-dark/80">
                      –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page.number }} –∏–∑ {{ page.paginator.num_pages }}
                    </span>
                    {% if page.has_next %}
                      <a href="?page={{ page.next_page_number }}{% if qs %}&{{ qs }}{% endif %}" class="btn btn-outline" style="padding:.35rem .75rem;font-size:.875rem">–í–ø–µ—Ä—ë–¥ ‚Üí</a>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% else %}
              <div class="border-t border-brand-soft mt-4 pt-4">
                <form method="get" class="flex items-center gap-2" id="perPageForm">
                  <label class="text-sm text-brand-dark/80 whitespace-nowrap">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                  <select name="per_page" class="select" onchange="this.form.submit()" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                  </select>
                  {% if qs %}
                    <input type="hidden" name="qs" value="{{ qs }}" />
                  {% endif %}
                </form>
              </div>
            {% endif %}
          </div>
        {% endif %}
        
        <script>
          (function() {
            const selectAllGroupedCheckbox = document.getElementById('selectAllRecipientsGrouped');
            const recipientCheckboxes = document.querySelectorAll('.recipient-checkbox');
            const bulkDeleteForm = document.getElementById('bulkDeleteForm');
            const companySelectAllCheckboxes = document.querySelectorAll('.company-select-all');
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
            function updateBulkDeleteButtons() {
              const checked = document.querySelectorAll('.recipient-checkbox:checked');
              if (checked.length > 0) {
                if (bulkDeleteForm) bulkDeleteForm.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                if (bulkDeleteForm) {
                  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
                  bulkDeleteForm.querySelectorAll('input[name="recipient_ids"]').forEach(el => el.remove());
                  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
                  checked.forEach(cb => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'recipient_ids';
                    input.value = cb.value;
                    bulkDeleteForm.appendChild(input);
                  });
                }
              } else {
                if (bulkDeleteForm) bulkDeleteForm.style.display = 'none';
              }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ "–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ"
            function updateSelectAllCheckboxes() {
              const allChecked = Array.from(recipientCheckboxes).every(c => c.checked);
              const someChecked = Array.from(recipientCheckboxes).some(c => c.checked);
              
              if (selectAllGroupedCheckbox) {
                selectAllGroupedCheckbox.checked = allChecked;
                selectAllGroupedCheckbox.indeterminate = !allChecked && someChecked;
              }
              
              // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –∫–æ–º–ø–∞–Ω–∏–π
              companySelectAllCheckboxes.forEach(companyCheckbox => {
                const companyId = companyCheckbox.getAttribute('data-company-id');
                const companyCheckboxes = document.querySelectorAll('.company-' + companyId + '-checkbox');
                const allCompanyChecked = Array.from(companyCheckboxes).every(c => c.checked);
                const someCompanyChecked = Array.from(companyCheckboxes).some(c => c.checked);
                companyCheckbox.checked = allCompanyChecked;
                companyCheckbox.indeterminate = !allCompanyChecked && someCompanyChecked;
              });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ" –≤ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ (—Å–≤–µ—Ä—Ö—É)
            if (selectAllGroupedCheckbox) {
              selectAllGroupedCheckbox.addEventListener('change', function() {
                recipientCheckboxes.forEach(cb => {
                  cb.checked = this.checked;
                });
                // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã "–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ" –≤ –∫–æ–º–ø–∞–Ω–∏—è—Ö
                companySelectAllCheckboxes.forEach(cb => {
                  cb.checked = this.checked;
                });
                updateBulkDeleteButtons();
              });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è "–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ" –≤ –∫–æ–º–ø–∞–Ω–∏—è—Ö
            companySelectAllCheckboxes.forEach(companyCheckbox => {
              companyCheckbox.addEventListener('change', function() {
                const companyId = this.getAttribute('data-company-id');
                const companyCheckboxes = document.querySelectorAll('.company-' + companyId + '-checkbox');
                companyCheckboxes.forEach(cb => {
                  cb.checked = this.checked;
                });
                updateSelectAllCheckboxes();
                updateBulkDeleteButtons();
              });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
            recipientCheckboxes.forEach(cb => {
              cb.addEventListener('change', function() {
                updateSelectAllCheckboxes();
                updateBulkDeleteButtons();
              });
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateSelectAllCheckboxes();
            updateBulkDeleteButtons();
          })();
        </script>
      </div>

      <div class="lg:col-span-4 space-y-4">
        <div class="card card-pad">
          <div class="font-medium mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
          <div class="flex flex-wrap gap-2">
            <a class="btn btn-outline" href="/mail/campaigns/{{ campaign.id }}/edit/">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <form method="post" action="/mail/campaigns/{{ campaign.id }}/test-send/">
              {% csrf_token %}
              <button class="btn btn-outline" type="submit">–¢–µ—Å—Ç —Å–µ–±–µ</button>
            </form>
            
            {% if campaign.status == 'paused' and counts.pending > 0 %}
              {# –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –¥–ª—è –∫–∞–º–ø–∞–Ω–∏–π –Ω–∞ –ø–∞—É–∑–µ #}
              <form method="post" action="/mail/campaigns/{{ campaign.id }}/resume/">
                {% csrf_token %}
                <button class="btn btn-primary" type="submit">
                  <span class="inline-flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                  </span>
                </button>
              </form>
            {% elif campaign.status == 'sending' or campaign.status == 'ready' %}
              {# –ö–Ω–æ–ø–∫–∞ "–ü–∞—É–∑–∞" –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π #}
              <form method="post" action="/mail/campaigns/{{ campaign.id }}/pause/">
                {% csrf_token %}
                <button class="btn btn-warning" type="submit">
                  <span class="inline-flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="6" y="4" width="4" height="16"></rect>
                      <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                    –ü–∞—É–∑–∞
                  </span>
                </button>
              </form>
            {% elif campaign.status == 'draft' or campaign.status == 'stopped' %}
              {% if counts.pending > 0 %}
                {# –ö–Ω–æ–ø–∫–∞ "–°—Ç–∞—Ä—Ç" –¥–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π #}
                <form method="post" action="/mail/campaigns/{{ campaign.id }}/start/">
                  {% csrf_token %}
                  <button class="btn btn-primary" type="submit">
                    <span class="inline-flex items-center gap-2">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                      </svg>
                      –°—Ç–∞—Ä—Ç
                    </span>
                  </button>
                </form>
              {% endif %}
            {% endif %}
            
            {% if counts.pending == 0 and counts.total > 0 %}
              <form method="post" action="/mail/campaigns/{{ campaign.id }}/recipients/reset/" onsubmit="return confirm('–í–µ—Ä–Ω—É—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ/–æ—à–∏–±–æ—á–Ω—ã–µ email –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏?');">
                {% csrf_token %}
                <button class="btn btn-outline" type="submit">–í–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å</button>
              </form>
              <form method="post" action="/mail/campaigns/{{ campaign.id }}/clear/" onsubmit="return confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é –∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π? –ë—É–¥–µ—Ç –ø–∞—É–∑–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ email.');">
                {% csrf_token %}
                <button class="btn btn-outline" type="submit">–û—á–∏—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</button>
              </form>
            {% endif %}
            {% if can_delete_campaign %}
              <form method="post" action="/mail/campaigns/{{ campaign.id }}/delete/" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é ¬´{{ campaign.name }}¬ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');">
                {% csrf_token %}
                <button class="btn" type="submit" title="–£–¥–∞–ª–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é" style="background:#dc2626;color:#fff">
                  <span class="inline-flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 6h18"></path>
                      <path d="M8 6V4h8v2"></path>
                      <path d="M6 6l1 16h10l1-16"></path>
                      <path d="M10 11v6"></path>
                      <path d="M14 11v6"></path>
                    </svg>
                    –£–¥–∞–ª–∏—Ç—å
                  </span>
                </button>
              </form>
            {% endif %}
          </div>
          
          {% if pause_reasons %}
            <div class="mt-3 p-3 rounded-lg border border-orange-300 bg-orange-50">
              <div class="text-sm font-medium text-orange-900 mb-2">‚ö†Ô∏è –†–∞—Å—Å—ã–ª–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:</div>
              <ul class="text-xs text-orange-800 space-y-1">
                {% for reason in pause_reasons %}
                  <li>‚Ä¢ {{ reason }}</li>
                {% endfor %}
              </ul>
            </div>
          {% elif campaign.status == 'sending' or campaign.status == 'ready' %}
            <div class="mt-3 p-3 rounded-lg border border-green-300 bg-green-50">
              <div class="text-sm font-medium text-green-900">
                ‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                {% if not is_working_time %}
                  <div class="text-xs text-green-800 mt-1">
                    –û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: 9:00-18:00 –ú–°–ö (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ú–°–ö: {{ current_time_msk }})
                  </div>
                {% else %}
                  <div class="text-xs text-green-800 mt-1">
                    –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
          
          <div class="text-xs muted-2 mt-2">
            <div><b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫–∞:</b></div>
            <ul class="list-disc list-inside mt-1 space-y-0.5">
              <li>–†–∞—Å—Å—ã–ª–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è (9:00-18:00 –ú–°–ö)</li>
              <li>–° —É—á–µ—Ç–æ–º –ª–∏–º–∏—Ç–æ–≤ SMTP (–≤ –º–∏–Ω—É—Ç—É, –≤ –¥–µ–Ω—å, –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞)</li>
              <li>–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤ —Ä–∞—Å—Å—ã–ª–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è</li>
              <li>–í–Ω–µ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –Ω–æ –∫–∞–º–ø–∞–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π</li>
            </ul>
            <div class="mt-2">–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ú–°–ö: <b>{{ current_time_msk }}</b></div>
          </div>
        </div>
        

        {# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—á–µ—Ä–µ–¥–∏ #}
        {% if queue_entry %}
          <div class="card card-pad mb-4">
            <div class="font-medium mb-2">–û—á–µ—Ä–µ–¥—å —Ä–∞—Å—Å—ã–ª–æ–∫</div>
            <div class="text-sm">
              <div class="flex items-center gap-2">
                <span class="text-brand-dark/70">–°—Ç–∞—Ç—É—Å –≤ –æ—á–µ—Ä–µ–¥–∏:</span>
                <span class="badge">{{ queue_entry.get_status_display }}</span>
              </div>
              {% if queue_entry.queued_at %}
                <div class="mt-2 text-xs text-brand-dark/60">
                  –ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å: {{ queue_entry.queued_at|date:"d.m.Y H:i" }}
                </div>
              {% endif %}
              {% if queue_entry.status == 'pending' %}
                <div class="mt-2 text-xs text-brand-dark/60">
                  ‚è≥ –ö–∞–º–ø–∞–Ω–∏—è –æ–∂–∏–¥–∞–µ—Ç —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏. –†–∞—Å—Å—ã–ª–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.
                </div>
              {% elif queue_entry.status == 'processing' %}
                <div class="mt-2 text-xs text-green-600">
                  ‚úÖ –ö–∞–º–ø–∞–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ #}
        {% if is_admin %}
          <div class="card card-pad">
            <div class="font-medium mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-brand-dark/70">–û—à–∏–±–æ–∫ —Å–µ–≥–æ–¥–Ω—è (—ç—Ç–∞ –∫–∞–º–ø–∞–Ω–∏—è):</span>
                <span class="font-medium {% if send_stats.failed_today_campaign > 0 %}text-red-600{% endif %}">
                  {{ send_stats.failed_today_campaign }}
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-brand-dark/70">–û—à–∏–±–æ–∫ —Å–µ–≥–æ–¥–Ω—è (–≤—Å–µ–≥–æ):</span>
                <span class="font-medium {% if send_stats.failed_today > 0 %}text-red-600{% endif %}">
                  {{ send_stats.failed_today }}
                </span>
              </div>
            </div>
          </div>
        {% endif %}

        <div class="card card-pad">
          <div class="font-medium mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="text-center p-3 rounded-lg bg-gray-50">
              <div class="text-xs text-brand-dark/60 mb-1">–í—Å–µ–≥–æ</div>
              <div class="text-2xl font-semibold">{{ counts.total }}</div>
            </div>
            <div class="text-center p-3 rounded-lg {% if counts.pending > 0 %}bg-orange-50{% else %}bg-gray-50{% endif %}">
              <div class="text-xs text-brand-dark/60 mb-1">–í –æ—á–µ—Ä–µ–¥–∏</div>
              <div class="text-2xl font-semibold {% if counts.pending > 0 %}text-orange-600{% endif %}">{{ counts.pending }}</div>
            </div>
            <div class="text-center p-3 rounded-lg {% if counts.sent > 0 %}bg-green-50{% else %}bg-gray-50{% endif %}">
              <div class="text-xs text-brand-dark/60 mb-1">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
              <div class="text-2xl font-semibold {% if counts.sent > 0 %}text-green-600{% endif %}">{{ counts.sent }}</div>
            </div>
            <div class="text-center p-3 rounded-lg {% if counts.failed > 0 %}bg-red-50{% else %}bg-gray-50{% endif %}">
              <div class="text-xs text-brand-dark/60 mb-1">–û—à–∏–±–∫–∏</div>
              <div class="text-2xl font-semibold {% if counts.failed > 0 %}text-red-600{% endif %}">{{ counts.failed }}</div>
            </div>
          </div>
        </div>
        
        {# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ #}
        {% if is_admin and error_types %}
          <div class="card card-pad">
            <div class="font-medium mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
            <div class="space-y-3 text-sm">
              {% for error_type, data in error_types.items %}
                <div class="p-3 rounded border border-red-200 bg-red-50">
                  <div class="font-medium text-red-900 mb-1">
                    {{ error_type }}: <span class="text-red-700">{{ data.count }}</span>
                  </div>
                  {% if data.examples %}
                    <div class="text-xs text-red-800 mt-2 space-y-1">
                      <div class="font-medium">–ü—Ä–∏–º–µ—Ä—ã:</div>
                      {% for example in data.examples %}
                        <div class="pl-2 border-l-2 border-red-300">
                          <div class="font-mono text-xs">{{ example.email }}</div>
                          <div class="text-red-700 mt-0.5">{{ example.error|truncatechars:120 }}</div>
                          <div class="text-red-600 text-xs mt-0.5">{{ example.time|date:"d.m.Y H:i" }}</div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            {% if counts.failed > 0 %}
              <div class="text-xs muted-2 mt-3">
                –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫ –≤ –∫–∞–º–ø–∞–Ω–∏–∏: <b>{{ counts.failed }}</b>
                {% if counts.failed > 100 %}
                  (–ø–æ–∫–∞–∑–∞–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º 100)
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endif %}

        <form method="post" action="/mail/campaigns/{{ campaign.id }}/generate/" class="card card-pad space-y-3">
          {% csrf_token %}
          <div class="font-medium">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</div>
          
          <div class="space-y-3 border-t border-brand-soft pt-3">
            <div class="text-sm font-medium">–§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</div>
            <div class="grid grid-cols-1 gap-2">
              <div>
                <label class="block text-xs muted mb-1">–õ–∏–º–∏—Ç</label>
                <input class="input" type="number" name="limit" value="{{ generate_form.limit.value|default:200 }}" min="1" max="5000" />
              </div>
              <div>
                <label class="block text-xs muted mb-1">–§–∏–ª–∏–∞–ª</label>
                <select class="select" name="branch">
                  <option value="">–õ—é–±–æ–π</option>
                  {% for b in branches %}
                    <option value="{{ b.id }}">{{ b.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-xs muted mb-1">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
                <select class="select" name="responsible">
                  <option value="">–õ—é–±–æ–π</option>
                  {% regroup responsibles by branch as branches_list %}
                  {% for branch_group in branches_list %}
                    <optgroup label="–§–∏–ª–∏–∞–ª: {{ branch_group.grouper.name|default:"–ë–µ–∑ —Ñ–∏–ª–∏–∞–ª–∞" }}">
                      {% for u in branch_group.list %}
                        <option value="{{ u.id }}">{{ u }}</option>
                      {% endfor %}
                    </optgroup>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-xs muted mb-1">–°—Ç–∞—Ç—É—Å</label>
                <select class="select" name="status">
                  <option value="">–õ—é–±–æ–π</option>
                  {% for s in statuses %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-xs muted mb-1">–°—Ñ–µ—Ä–∞</label>
                <select class="select" name="sphere">
                  <option value="">–õ—é–±–∞—è</option>
                  {% for s in spheres %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="space-y-3 border-t border-brand-soft pt-3">
            <div class="text-sm font-medium">–í—ã–±–æ—Ä email –∞–¥—Ä–µ—Å–æ–≤</div>
            <div class="space-y-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="include_company_email" value="1" {% if generate_form.include_company_email.value %}checked{% endif %} class="rounded" />
                <span class="text-sm">–í–∫–ª—é—á–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π email –∫–æ–º–ø–∞–Ω–∏–∏</span>
              </label>
              <div class="text-xs muted-2 ml-6">Email –∏–∑ –ø–æ–ª—è "Email (–æ—Å–Ω–æ–≤–Ω–æ–π)" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
              
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="include_contact_emails" value="1" {% if generate_form.include_contact_emails.value %}checked{% endif %} class="rounded" id="include_contact_emails" />
                <span class="text-sm">–í–∫–ª—é—á–∏—Ç—å email'—ã –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</span>
              </label>
              <div class="text-xs muted-2 ml-6">Email'—ã –∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏</div>
              
              <div class="ml-6 space-y-1 border-l-2 border-brand-soft pl-3" id="contact_email_types_container">
                <div class="text-xs muted mb-1">–¢–∏–ø—ã email'–æ–≤:</div>
                {% for choice in generate_form.contact_email_types.field.choices %}
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="contact_email_types" value="{{ choice.0 }}" {% if choice.0 in generate_form.contact_email_types.value %}checked{% endif %} class="rounded" />
                    <span class="text-xs">{{ choice.1 }}</span>
                  </label>
                {% endfor %}
              </div>
            </div>
          </div>
          
            <button class="btn btn-primary w-full" type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</button>
          </form>
          
          <script>
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–æ–≤ email'–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–µ–∫–±–æ–∫—Å–∞
          document.getElementById('include_contact_emails').addEventListener('change', function() {
            document.getElementById('contact_email_types_container').style.display = this.checked ? 'block' : 'none';
          });
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            document.getElementById('contact_email_types_container').style.display = 
              document.getElementById('include_contact_emails').checked ? 'block' : 'none';
          </script>
        </details>
      </div>
    </div>

  </div>
{% endblock %}


