{% extends "ui/base.html" %}
{% load ui_extras messenger_extras %}
{% block title %}–î–∏–∞–ª–æ–≥ #{{ conversation.id }} ‚Äî CRM –ü–†–û–§–ò{% endblock %}

{% block content %}
  <div class="messenger-conversation-detail">
    <div class="flex items-center justify-between gap-4 mb-4">
      <div>
        <a href="{% url 'messenger_conversation_list' %}" class="text-sm text-brand-dark/70 hover:text-brand-teal mb-2 inline-block">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –¥–∏–∞–ª–æ–≥–æ–≤</a>
        <h1 class="text-2xl font-semibold">–î–∏–∞–ª–æ–≥ #{{ conversation.id }}</h1>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
      <div class="lg:col-span-2">
        <div class="card">
          <div class="card-pad">
            <h2 class="text-lg font-semibold mb-4">–°–æ–æ–±—â–µ–Ω–∏—è</h2>
            
            <div id="contactTypingIndicator" class="hidden text-sm text-brand-dark/60 italic mb-2">–ö–ª–∏–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç...</div>
            <div class="space-y-4 mb-4 overflow-y-auto pr-1" id="messagesList" style="max-height: 260px;">
              {% for message in conversation_messages %}
                {% ifchanged message.created_at|date:"d.m.Y" %}
                  <div class="text-center my-2">
                    <span class="inline-block px-3 py-1 rounded-full bg-brand-soft/40 text-xs text-brand-dark/70">
                      {{ message.created_at|date:"d.m.Y" }}
                    </span>
                  </div>
                {% endifchanged %}
                <div class="flex gap-3 {% if message.direction == 'IN' %}flex-row{% else %}flex-row-reverse{% endif %}">
                  <div class="flex-shrink-0">
                    {% if message.direction == 'IN' %}
                      <div class="w-8 h-8 rounded-full bg-brand-teal/20 flex items-center justify-center text-brand-teal font-semibold text-sm">
                        {{ message.sender_contact.name|first|default:"–ö"|upper }}
                      </div>
                    {% else %}
                      <div class="w-8 h-8 rounded-full bg-brand-orange/20 flex items-center justify-center text-brand-orange font-semibold text-sm">
                        {{ message.sender_user.first_name|first|default:message.sender_user.username|first|upper }}
                      </div>
                    {% endif %}
                  </div>
                  <div class="flex-1 {% if message.direction == 'IN' %}text-left{% else %}text-right{% endif %}">
                    <div class="inline-block max-w-[80%] {% if message.direction == 'IN' %}bg-brand-soft/40{% else %}bg-brand-teal/10{% endif %} rounded-lg px-4 py-2">
                      <div class="text-sm font-medium mb-1">
                        {% if message.direction == 'IN' %}
                          {{ message.sender_contact.name|default:"–ö–ª–∏–µ–Ω—Ç" }}
                        {% elif message.direction == 'OUT' %}
                          {{ message.sender_user.get_full_name|default:message.sender_user.username }}
                        {% else %}
                          {{ message.sender_user.get_full_name|default:message.sender_user.username }} (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ)
                        {% endif %}
                      </div>
                      <div class="text-sm text-brand-dark whitespace-pre-wrap wrap-anywhere">{{ message.body|messenger_format }}</div>
                      {% if message.attachments.exists %}
                        <div class="mt-2 space-y-1">
                          {% for attachment in message.attachments.all %}
                            <a href="{{ attachment.file.url }}" target="_blank" class="text-xs text-brand-teal hover:underline inline-flex items-center gap-1">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                              {{ attachment.original_name|default:attachment.file.name|truncatechars:40 }}
                            </a>
                          {% endfor %}
                        </div>
                      {% endif %}
                      <div class="text-xs text-brand-dark/50 mt-1">
                        {{ message.created_at|date:"d.m.Y H:i" }}
                      </div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="text-center py-8 text-brand-dark/60">
                  <p>–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                </div>
              {% endfor %}
            </div>

            {% if not can_reply %}
              <div class="mb-3 rounded-xl border border-brand-orange/40 bg-brand-orange/10 px-4 py-3 text-sm text-brand-dark">
                <div class="font-medium">–†–µ–∂–∏–º —Å—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞: —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä</div>
                <div class="text-sm text-brand-dark/70 mt-1">–ß—Ç–æ–±—ã –æ—Ç–≤–µ—á–∞—Ç—å, –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–∑–Ω–∞—á–∏—Ç—å –º–µ–Ω—è¬ª –≤ –±–ª–æ–∫–µ ¬´–î–µ–π—Å—Ç–≤–∏—è¬ª (–¥–∏–∞–ª–æ–≥ –±—É–¥–µ—Ç –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É).</div>
              </div>
            {% endif %}

            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" id="messageForm" class="border-t border-brand-soft/60 pt-4" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="flex gap-2 items-end">
                <div class="flex-1 min-w-0 space-y-2">
                  <textarea name="body" id="messageBody" class="textarea w-full" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." {% if not can_reply %}disabled{% endif %}></textarea>
                  <div class="flex items-center gap-2">
                    <input type="file" name="attachments" id="messageAttachments" class="hidden" multiple accept="image/*,.pdf" {% if not can_reply %}disabled{% endif %}>
                    <button type="button" onclick="document.getElementById('messageAttachments').click()" class="btn btn-outline btn-sm text-sm" {% if not can_reply %}disabled{% endif %}>üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</button>
                    <span id="messageAttachmentsNames" class="text-xs text-brand-dark/60 truncate max-w-[200px]"></span>
                  </div>
                  <div class="flex items-center gap-2 mt-1">
                    <select id="cannedResponsesSelect" class="select text-xs w-full">
                      <option value="">–®–∞–±–ª–æ–Ω –æ—Ç–≤–µ—Ç–∞...</option>
                    </select>
                    <button type="button" id="cannedResponsesApply" class="btn btn-outline btn-sm text-xs">–í—Å—Ç–∞–≤–∏—Ç—å</button>
                  </div>
                  <p class="text-[11px] text-brand-dark/50">–®–∞–±–ª–æ–Ω—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Messenger¬ª.</p>
                </div>
                <div class="flex flex-col gap-2 flex-shrink-0">
                  <button type="submit" name="action" value="send_out" id="sendOutButton" class="btn btn-primary" {% if not can_reply %}disabled{% endif %}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                  <button type="submit" name="action" value="send_internal" class="btn btn-outline btn-sm" {% if not can_reply %}disabled{% endif %}>–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ</button>
                </div>
              </div>
              <p class="text-xs text-brand-dark/50 mt-2">–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–ª–æ–∂–µ–Ω–∏—è –±–µ–∑ —Ç–µ–∫—Å—Ç–∞. –ú–∞–∫—Å. 5 –ú–ë –Ω–∞ —Ñ–∞–π–ª, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ PDF. –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å.</p>
            </form>
            <script>
              document.getElementById('messageAttachments').addEventListener('change', function() {
                var names = Array.from(this.files).map(function(f) { return f.name; }).join(', ');
                document.getElementById('messageAttachmentsNames').textContent = names || '';
              });
            </script>
          </div>
        </div>
      </div>

      <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ -->
      <div class="lg:col-span-1">
        <div class="card mb-4">
          <div class="card-pad">
            <h3 class="text-sm font-semibold mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <dl class="space-y-2 text-sm">
              <div>
                <dt class="text-brand-dark/60">–ö–æ–Ω—Ç–∞–∫—Ç</dt>
                <dd class="font-medium">
                  {{ conversation.contact.name|default:conversation.contact.email|default:conversation.contact.phone|default:"–ë–µ–∑ –∏–º–µ–Ω–∏" }}
                  {% if conversation.contact.email %}
                    <br><span class="text-xs text-brand-dark/60">{{ conversation.contact.email }}</span>
                  {% endif %}
                  {% if conversation.contact.phone %}
                    <br><span class="text-xs text-brand-dark/60">{{ conversation.contact.phone }}</span>
                  {% endif %}
                </dd>
              </div>
              <div>
                <dt class="text-brand-dark/60">–§–∏–ª–∏–∞–ª</dt>
                <dd class="font-medium">{{ conversation.branch.name }}</dd>
              </div>
              {% if conversation.region %}
                <div>
                  <dt class="text-brand-dark/60">–†–µ–≥–∏–æ–Ω</dt>
                  <dd class="font-medium">{{ conversation.region.name }}</dd>
                </div>
              {% endif %}
              <div>
                <dt class="text-brand-dark/60">–°–æ–∑–¥–∞–Ω</dt>
                <dd class="font-medium">{{ conversation.created_at|date:"d.m.Y H:i" }}</dd>
              </div>
              {% if conversation.last_message_at %}
                <div>
                  <dt class="text-brand-dark/60">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</dt>
                  <dd class="font-medium">{{ conversation.last_message_at|date:"d.m.Y H:i" }}</dd>
                </div>
              {% endif %}
              <div>
                <dt class="text-brand-dark/60">–°—Ç–∞—Ç—É—Å</dt>
                <dd class="font-medium">
                  {% if conversation.status == 'open' %}
                    <span class="badge badge-new">–û—Ç–∫—Ä—ã—Ç</span>
                  {% elif conversation.status == 'pending' %}
                    <span class="badge badge-progress">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>
                  {% elif conversation.status == 'resolved' %}
                    <span class="badge badge-done">–†–µ—à—ë–Ω</span>
                  {% elif conversation.status == 'closed' %}
                    <span class="badge badge-cancel">–ó–∞–∫—Ä—ã—Ç</span>
                  {% endif %}
                </dd>
              </div>
              <div>
                <dt class="text-brand-dark/60">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</dt>
                <dd class="font-medium">
                  {% if conversation.priority == 10 %}
                    <span class="badge badge-xs">–ù–∏–∑–∫–∏–π</span>
                  {% elif conversation.priority == 20 %}
                    <span class="badge badge-xs">–û–±—ã—á–Ω—ã–π</span>
                  {% elif conversation.priority == 30 %}
                    <span class="badge badge-warn badge-xs">–í—ã—Å–æ–∫–∏–π</span>
                  {% endif %}
                </dd>
              </div>
              {% if conversation.rating_score is not None %}
                <div>
                  <dt class="text-brand-dark/60">–û—Ü–µ–Ω–∫–∞</dt>
                  <dd class="font-medium">
                    {{ conversation.rating_score }}{% if conversation.rated_at %} ¬∑ {{ conversation.rated_at|date:"d.m.Y H:i" }}{% endif %}
                    {% if conversation.rating_comment %}<br><span class="text-sm font-normal text-brand-dark/70">{{ conversation.rating_comment }}</span>{% endif %}
                  </dd>
                </div>
              {% endif %}
            </dl>
          </div>
        </div>

        <div class="card">
          <div class="card-pad">
            <h3 class="text-sm font-semibold mb-3">–î–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="flex flex-wrap gap-2 mb-3">
              <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" class="inline">
                {% csrf_token %}
                <button type="submit" name="action" value="assign_me" class="btn btn-outline btn-sm">–ù–∞–∑–Ω–∞—á–∏—Ç—å –º–µ–Ω—è</button>
              </form>
              {% if conversation.status == 'open' or conversation.status == 'pending' %}
              <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" class="inline">
                {% csrf_token %}
                <button type="submit" name="action" value="close" class="btn btn-outline btn-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
              </form>
              {% endif %}
            </div>
            <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" class="space-y-3">
              {% csrf_token %}
              
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">–°—Ç–∞—Ç—É—Å</label>
                <select name="status" class="select text-sm w-full">
                  <option value="open" {% if conversation.status == 'open' %}selected{% endif %}>–û—Ç–∫—Ä—ã—Ç</option>
                  <option value="pending" {% if conversation.status == 'pending' %}selected{% endif %}>–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                  <option value="resolved" {% if conversation.status == 'resolved' %}selected{% endif %}>–†–µ—à—ë–Ω</option>
                  <option value="closed" {% if conversation.status == 'closed' %}selected{% endif %}>–ó–∞–∫—Ä—ã—Ç</option>
                </select>
              </div>

              {% if is_global_inbox %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">–ü–µ—Ä–µ–¥–∞—Ç—å –≤ —Ñ–∏–ª–∏–∞–ª</label>
                <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" class="flex gap-2">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="transfer_to_branch">
                  <select name="branch_id" class="select text-sm flex-1" required>
                    <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª ‚Äî</option>
                    {% for b in branches %}
                      {% if b.id != conversation.branch_id %}
                        <option value="{{ b.id }}">{{ b.name }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-outline btn-sm whitespace-nowrap">–ü–µ—Ä–≤–æ–º—É —Å–≤–æ–±–æ–¥–Ω–æ–º—É</button>
                </form>
                <p class="text-xs text-brand-dark/50 mt-1">–î–∏–∞–ª–æ–≥ –ø–µ—Ä–µ–π–¥—ë—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª–∏–∞–ª –∏ –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä–≤–æ–º—É —Å–≤–æ–±–æ–¥–Ω–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.</p>
              </div>
              {% endif %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">–û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                <select name="assignee" class="select text-sm w-full">
                  <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                  {% for assignee in assignees %}
                    <option value="{{ assignee.id }}" {% if conversation.assignee_id == assignee.id %}selected{% endif %}>{{ assignee }}{% if assignee.branch_id and is_global_inbox %} ({{ assignee.branch.name }}){% endif %}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select name="priority" class="select text-sm w-full">
                  <option value="10" {% if conversation.priority == 10 %}selected{% endif %}>–ù–∏–∑–∫–∏–π</option>
                  <option value="20" {% if conversation.priority == 20 %}selected{% endif %}>–û–±—ã—á–Ω—ã–π</option>
                  <option value="30" {% if conversation.priority == 30 %}selected{% endif %}>–í—ã—Å–æ–∫–∏–π</option>
                </select>
              </div>

              <button type="submit" name="action" value="update" class="btn btn-primary w-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    const conversationId = {{ conversation.id }};
    const typingUrl = '/api/messenger/conversations/' + conversationId + '/typing/';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') && document.querySelector('[name=csrfmiddlewaretoken]').value;
    const indicator = document.getElementById('contactTypingIndicator');
    const messageBody = document.getElementById('messageBody');
    const cannedSelect = document.getElementById('cannedResponsesSelect');
    const cannedApply = document.getElementById('cannedResponsesApply');
    const messagesList = document.getElementById('messagesList');

    function scrollMessagesToBottom() {
      if (messagesList) {
        messagesList.scrollTop = messagesList.scrollHeight;
      }
    }

    function fetchTyping() {
      fetch(typingUrl, { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          if (data && data.contact_typing && indicator) {
            indicator.classList.remove('hidden');
          } else if (indicator) {
            indicator.classList.add('hidden');
          }
        })
        .catch(function() {});
    }

    var typingPollTimer = null;
    function startTypingPoll() {
      if (typingPollTimer) return;
      fetchTyping();
      typingPollTimer = setInterval(fetchTyping, 2500);
    }
    function stopTypingPoll() {
      if (typingPollTimer) { clearInterval(typingPollTimer); typingPollTimer = null; }
    }
    startTypingPoll();
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) stopTypingPoll(); else startTypingPoll();
    });

    var typingSendTimer = null;
    function sendOperatorTyping() {
      if (!csrfToken) return;
      fetch(typingUrl, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
        body: '{}'
      }).catch(function() {});
    }
    if (messageBody) {
      messageBody.addEventListener('input', function() {
        clearTimeout(typingSendTimer);
        typingSendTimer = setTimeout(sendOperatorTyping, 300);
      });
      // Ctrl+Enter / Cmd+Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      var sendOutButton = document.getElementById('sendOutButton');
      messageBody.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          if (sendOutButton && !sendOutButton.disabled) {
            sendOutButton.click();
          }
        }
      });
    }

    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    scrollMessagesToBottom();

    // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤ (canned responses)
    if (cannedSelect && cannedApply) {
      fetch('/api/messenger/canned-responses/', { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : []; })
        .then(function(data) {
          if (!Array.isArray(data)) return;
          data.forEach(function(item) {
            if (!item || !item.id) return;
            var opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.title || ('–®–∞–±–ª–æ–Ω #' + item.id);
            opt.dataset.body = item.body || '';
            cannedSelect.appendChild(opt);
          });
        })
        .catch(function() {});

      cannedApply.addEventListener('click', function() {
        if (!messageBody) return;
        var selected = cannedSelect.options[cannedSelect.selectedIndex];
        if (!selected || !selected.dataset.body) return;
        var body = selected.dataset.body;
        if (!body) return;
        if (!messageBody.value) {
          messageBody.value = body;
        } else {
          var sep = messageBody.value.endsWith('\n') ? '' : '\n';
          messageBody.value = messageBody.value + sep + body;
        }
        messageBody.focus();
      });
    }
  })();
  </script>
{% endblock %}
