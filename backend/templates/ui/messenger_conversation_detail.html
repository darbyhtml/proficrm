{% extends "ui/base.html" %}
{% load ui_extras messenger_extras %}
{% block title %}Диалог #{{ conversation.id }} — CRM ПРОФИ{% endblock %}

{% block content %}
    <div class="messenger-conversation-detail">
    <div class="flex items-center justify-between gap-4 mb-4">
      <div>
        <a href="{% url 'messenger_conversations_unified' %}" class="text-sm text-brand-dark/70 hover:text-brand-teal mb-2 inline-block">← Назад к диалогам</a>
        <h1 class="text-2xl font-semibold">Диалог #{{ conversation.id }}</h1>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Основная лента сообщений -->
      <div class="lg:col-span-2">
        <div class="card flex flex-col min-h-0" style="max-height: calc(100vh - 220px);">
          <div class="card-pad flex flex-col h-full min-h-0">
            <h2 class="text-lg font-semibold mb-4">Сообщения</h2>
            
            <div id="contactTypingIndicator" class="hidden text-sm text-brand-dark/60 italic mb-2">Клиент печатает...</div>
            <div class="space-y-4 mb-4 overflow-y-auto pr-1 flex-1 min-h-0" id="messagesList">
              {% for message in conversation_messages %}
                {% ifchanged message.created_at|date:"d.m.Y" %}
                  <div class="text-center my-2">
                    <span class="inline-block px-3 py-1 rounded-full bg-brand-soft/40 text-xs text-brand-dark/70">
                      {{ message.created_at|date:"d.m.Y" }}
                    </span>
                  </div>
                {% endifchanged %}
                <div class="flex gap-3 {% if message.direction == 'IN' %}flex-row{% else %}flex-row-reverse{% endif %}">
                  <div class="flex-shrink-0">
                    {% if message.direction == 'IN' %}
                      <div class="w-8 h-8 rounded-full bg-brand-teal/20 flex items-center justify-center text-brand-teal font-semibold text-sm">
                        {{ message.sender_contact.name|first|default:"К"|upper }}
                      </div>
                    {% else %}
                      <div class="w-8 h-8 rounded-full bg-brand-orange/20 flex items-center justify-center text-brand-orange font-semibold text-sm">
                        {{ message.sender_user.first_name|first|default:message.sender_user.username|first|upper }}
                      </div>
                    {% endif %}
                  </div>
                  <div class="flex-1 {% if message.direction == 'IN' %}text-left{% else %}text-right{% endif %}">
                    <div class="inline-block max-w-[80%] {% if message.direction == 'IN' %}bg-brand-soft/40{% else %}bg-brand-teal/10{% endif %} rounded-lg px-4 py-2">
                      <div class="text-sm font-medium mb-1">
                        {% if message.direction == 'IN' %}
                          {{ message.sender_contact.name|default:"Клиент" }}
                        {% elif message.direction == 'OUT' %}
                          {{ message.sender_user.get_full_name|default:message.sender_user.username }}
                        {% else %}
                          {{ message.sender_user.get_full_name|default:message.sender_user.username }} (внутреннее)
                        {% endif %}
                      </div>
                      <div class="text-sm text-brand-dark whitespace-pre-wrap wrap-anywhere">{{ message.body|messenger_format }}</div>
                      {% if message.attachments.exists %}
                        <div class="mt-2 space-y-1">
                          {% for attachment in message.attachments.all %}
                            <a href="{{ attachment.file.url }}" target="_blank" class="text-xs text-brand-teal hover:underline inline-flex items-center gap-1">
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                              {{ attachment.original_name|default:attachment.file.name|truncatechars:40 }}
                            </a>
                          {% endfor %}
                        </div>
                      {% endif %}
                      <div class="text-xs text-brand-dark/50 mt-1">
                        {{ message.created_at|date:"d.m.Y H:i" }}
                      </div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="text-center py-8 text-brand-dark/60">
                  <p>Сообщений пока нет</p>
                </div>
              {% endfor %}
            </div>

            {% if not can_reply %}
              <div class="mb-3 rounded-xl border border-brand-orange/40 bg-brand-orange/10 px-4 py-3 text-sm text-brand-dark">
                <div class="font-medium">Режим супервизора: только просмотр</div>
                <div class="text-sm text-brand-dark/70 mt-1">Чтобы отвечать, нажмите «Назначить меня» в блоке «Действия» (диалог будет взят в работу).</div>
              </div>
            {% endif %}

            <!-- Форма отправки сообщения -->
            <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" id="messageForm" class="border-t border-brand-soft/60 pt-3" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="file" name="attachments" id="messageAttachments" class="hidden" multiple accept="image/*,.pdf" {% if not can_reply %}disabled{% endif %}>
              
              <!-- Компактная строка ввода -->
              <div class="flex items-end gap-2">
                <!-- Поле ввода -->
                <div class="flex-1 min-w-0">
                  <textarea name="body" id="messageBody" class="textarea w-full resize-none" rows="2" placeholder="Введите сообщение..." {% if not can_reply %}disabled{% endif %}></textarea>
                  <!-- Имена прикрепленных файлов -->
                  <div id="messageAttachmentsNames" class="text-xs text-brand-dark/60 truncate mt-1 px-1"></div>
                </div>
                
                <!-- Кнопки действий -->
                <div class="flex items-end gap-1.5 flex-shrink-0">
                  <!-- Прикрепить файл -->
                  <button type="button" onclick="document.getElementById('messageAttachments').click()" class="btn btn-outline btn-sm p-2" title="Прикрепить файл" {% if not can_reply %}disabled{% endif %}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                    </svg>
                  </button>
                  
                  <!-- Шаблоны ответов -->
                  <div class="flex items-center gap-1">
                    <select id="cannedResponsesSelect" class="select text-xs w-24" title="Шаблон ответа">
                      <option value="">Шаблон...</option>
                    </select>
                    <button type="button" id="cannedResponsesApply" class="btn btn-outline btn-sm p-1.5 text-brand-dark/60 hover:text-brand-teal transition-colors" title="Вставить шаблон">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                      </svg>
                    </button>
                  </div>
                  
                  <!-- Внутреннее сообщение -->
                  <button type="submit" name="action" value="send_internal" class="btn btn-outline btn-sm p-2" title="Внутреннее сообщение" {% if not can_reply %}disabled{% endif %}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <path d="M9 9h6M9 15h6"/>
                    </svg>
                  </button>
                  
                  <!-- Отправить -->
                  <button type="submit" name="action" value="send_out" id="sendOutButton" class="btn btn-primary p-2.5" title="Отправить (Ctrl+Enter)" {% if not can_reply %}disabled{% endif %}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                  </button>
                </div>
              </div>
              
              <!-- Компактная подсказка -->
              <p class="text-[10px] text-brand-dark/40 mt-1.5 px-1">Ctrl+Enter — отправить • Макс. 5 МБ</p>
            </form>
            <script>
              document.getElementById('messageAttachments').addEventListener('change', function() {
                var names = Array.from(this.files).map(function(f) { return f.name; }).join(', ');
                document.getElementById('messageAttachmentsNames').textContent = names || '';
              });
            </script>
          </div>
        </div>
      </div>

      <!-- Боковая панель с информацией и действиями -->
      <div class="lg:col-span-1">
        <div class="card mb-4">
          <div class="card-pad">
            <h3 class="text-sm font-semibold mb-3">Информация</h3>
            <dl class="space-y-2 text-sm">
              <div>
                <dt class="text-brand-dark/60">Контакт</dt>
                <dd class="font-medium">
                  {{ conversation.contact.name|default:conversation.contact.email|default:conversation.contact.phone|default:"Без имени" }}
                  {% if conversation.contact.email %}
                    <br><span class="text-xs text-brand-dark/60">{{ conversation.contact.email }}</span>
                  {% endif %}
                  {% if conversation.contact.phone %}
                    <br><span class="text-xs text-brand-dark/60">{{ conversation.contact.phone }}</span>
                  {% endif %}
                </dd>
              </div>
              <div>
                <dt class="text-brand-dark/60">Филиал</dt>
                <dd class="font-medium">{{ conversation.branch.name }}</dd>
              </div>
              {% if conversation.region %}
                <div>
                  <dt class="text-brand-dark/60">Регион</dt>
                  <dd class="font-medium">{{ conversation.region.name }}</dd>
                </div>
              {% endif %}
              <div>
                <dt class="text-brand-dark/60">Создан</dt>
                <dd class="font-medium">{{ conversation.created_at|date:"d.m.Y H:i" }}</dd>
              </div>
              {% if conversation.last_message_at %}
                <div>
                  <dt class="text-brand-dark/60">Последнее сообщение</dt>
                  <dd class="font-medium">{{ conversation.last_message_at|date:"d.m.Y H:i" }}</dd>
                </div>
              {% endif %}
              <div>
                <dt class="text-brand-dark/60">Статус</dt>
                <dd class="font-medium">
                  {% if conversation.status == 'open' %}
                    <span class="badge badge-new">Открыт</span>
                  {% elif conversation.status == 'pending' %}
                    <span class="badge badge-progress">В ожидании</span>
                  {% elif conversation.status == 'resolved' %}
                    <span class="badge badge-done">Решён</span>
                  {% elif conversation.status == 'closed' %}
                    <span class="badge badge-cancel">Закрыт</span>
                  {% endif %}
                </dd>
              </div>
              <div>
                <dt class="text-brand-dark/60">Приоритет</dt>
                <dd class="font-medium">
                  {% if conversation.priority == 10 %}
                    <span class="badge badge-xs">Низкий</span>
                  {% elif conversation.priority == 20 %}
                    <span class="badge badge-xs">Обычный</span>
                  {% elif conversation.priority == 30 %}
                    <span class="badge badge-warn badge-xs">Высокий</span>
                  {% endif %}
                </dd>
              </div>
              {% if conversation.rating_score is not None %}
                <div>
                  <dt class="text-brand-dark/60">Оценка</dt>
                  <dd class="font-medium">
                    {{ conversation.rating_score }}{% if conversation.rated_at %} · {{ conversation.rated_at|date:"d.m.Y H:i" }}{% endif %}
                    {% if conversation.rating_comment %}<br><span class="text-sm font-normal text-brand-dark/70">{{ conversation.rating_comment }}</span>{% endif %}
                  </dd>
                </div>
              {% endif %}
            </dl>
          </div>
        </div>

        <div class="card">
          <div class="card-pad">
            <h3 class="text-sm font-semibold mb-3">Действия</h3>
            <div class="flex flex-wrap gap-2 mb-3">
              <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" class="inline">
                {% csrf_token %}
                <button type="submit" name="action" value="assign_me" class="btn btn-outline btn-sm">Назначить меня</button>
              </form>
              {% if conversation.status == 'open' or conversation.status == 'pending' %}
              <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" class="inline">
                {% csrf_token %}
                <button type="submit" name="action" value="close" class="btn btn-outline btn-sm">Закрыть</button>
              </form>
              {% endif %}
            </div>
            <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" class="space-y-3">
              {% csrf_token %}
              
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Статус</label>
                <select name="status" class="select text-sm w-full">
                  <option value="open" {% if conversation.status == 'open' %}selected{% endif %}>Открыт</option>
                  <option value="pending" {% if conversation.status == 'pending' %}selected{% endif %}>В ожидании</option>
                  <option value="resolved" {% if conversation.status == 'resolved' %}selected{% endif %}>Решён</option>
                  <option value="closed" {% if conversation.status == 'closed' %}selected{% endif %}>Закрыт</option>
                </select>
              </div>

              {% if is_global_inbox %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Передать в филиал</label>
                <form method="post" action="{% url 'messenger_conversation_detail' conversation.id %}" class="flex gap-2">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="transfer_to_branch">
                  <select name="branch_id" class="select text-sm flex-1" required>
                    <option value="">— выберите филиал —</option>
                    {% for b in branches %}
                      {% if b.id != conversation.branch_id %}
                        <option value="{{ b.id }}">{{ b.name }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-outline btn-sm whitespace-nowrap">Первому свободному</button>
                </form>
                <p class="text-xs text-brand-dark/50 mt-1">Диалог перейдёт в выбранный филиал и будет назначен первому свободному оператору.</p>
              </div>
              {% endif %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Оператор</label>
                <select name="assignee" class="select text-sm w-full">
                  <option value="">Не назначен</option>
                  {% for assignee in assignees %}
                    <option value="{{ assignee.id }}" {% if conversation.assignee_id == assignee.id %}selected{% endif %}>{{ assignee }}{% if assignee.branch_id and is_global_inbox %} ({{ assignee.branch.name }}){% endif %}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Приоритет</label>
                <select name="priority" class="select text-sm w-full">
                  <option value="10" {% if conversation.priority == 10 %}selected{% endif %}>Низкий</option>
                  <option value="20" {% if conversation.priority == 20 %}selected{% endif %}>Обычный</option>
                  <option value="30" {% if conversation.priority == 30 %}selected{% endif %}>Высокий</option>
                </select>
              </div>

              <button type="submit" name="action" value="update" class="btn btn-primary w-full">Сохранить изменения</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    const conversationId = {{ conversation.id }};
    const typingUrl = '/api/messenger/conversations/' + conversationId + '/typing/';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') && document.querySelector('[name=csrfmiddlewaretoken]').value;
    const indicator = document.getElementById('contactTypingIndicator');
    const messageBody = document.getElementById('messageBody');
    const cannedSelect = document.getElementById('cannedResponsesSelect');
    const cannedApply = document.getElementById('cannedResponsesApply');
    const messagesList = document.getElementById('messagesList');

    function scrollMessagesToBottom() {
      if (messagesList) {
        messagesList.scrollTop = messagesList.scrollHeight;
      }
    }

    function fetchTyping() {
      fetch(typingUrl, { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          if (data && data.contact_typing && indicator) {
            indicator.classList.remove('hidden');
          } else if (indicator) {
            indicator.classList.add('hidden');
          }
        })
        .catch(function() {});
    }

    var typingPollTimer = null;
    function startTypingPoll() {
      if (typingPollTimer) return;
      fetchTyping();
      typingPollTimer = setInterval(fetchTyping, 2500);
    }
    function stopTypingPoll() {
      if (typingPollTimer) { clearInterval(typingPollTimer); typingPollTimer = null; }
    }
    startTypingPoll();
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) stopTypingPoll(); else startTypingPoll();
    });

    var typingSendTimer = null;
    function sendOperatorTyping() {
      if (!csrfToken) return;
      fetch(typingUrl, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
        body: '{}'
      }).catch(function() {});
    }
    if (messageBody) {
      messageBody.addEventListener('input', function() {
        clearTimeout(typingSendTimer);
        typingSendTimer = setTimeout(sendOperatorTyping, 300);
      });
      // Ctrl+Enter / Cmd+Enter для отправки исходящего сообщения
      var sendOutButton = document.getElementById('sendOutButton');
      messageBody.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          if (sendOutButton && !sendOutButton.disabled) {
            sendOutButton.click();
          }
        }
      });
    }

    // Автоскролл к последнему сообщению при загрузке
    scrollMessagesToBottom();

    // Загрузка шаблонов ответов (canned responses)
    if (cannedSelect && cannedApply) {
      fetch('/api/messenger/canned-responses/', { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : []; })
        .then(function(data) {
          if (!Array.isArray(data)) return;
          data.forEach(function(item) {
            if (!item || !item.id) return;
            var opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.title || ('Шаблон #' + item.id);
            opt.dataset.body = item.body || '';
            cannedSelect.appendChild(opt);
          });
        })
        .catch(function() {});

      cannedApply.addEventListener('click', function() {
        if (!messageBody) return;
        var selected = cannedSelect.options[cannedSelect.selectedIndex];
        if (!selected || !selected.dataset.body) return;
        var body = selected.dataset.body;
        if (!body) return;
        if (!messageBody.value) {
          messageBody.value = body;
        } else {
          var sep = messageBody.value.endsWith('\n') ? '' : '\n';
          messageBody.value = messageBody.value + sep + body;
        }
        messageBody.focus();
      });
    }
  })();
  </script>
{% endblock %}
