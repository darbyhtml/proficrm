{% extends "ui/base.html" %}
{% block title %}Задачи — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Задачи</h1>
        <div class="text-sm text-brand-dark/70">Фильтры: мои / просрочено / статус</div>
      </div>
      <a href="/tasks/new/" class="btn btn-primary">+ Новая задача</a>
    </div>

    <form class="bg-white border rounded-2xl p-4 grid grid-cols-1 md:grid-cols-5 gap-3" method="get">
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Статус</label>
        <select name="status" class="w-full rounded-lg border px-3 py-2">
          <option value="">Любой</option>
          <option value="new" {% if status == 'new' %}selected{% endif %}>Новая</option>
          <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>В работе</option>
          <option value="done" {% if status == 'done' %}selected{% endif %}>Выполнена</option>
          <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Отменена</option>
        </select>
      </div>
      <div class="flex items-end gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          <input type="checkbox" name="mine" value="1" {% if mine == '1' %}checked{% endif %} />
          Мои
        </label>
      </div>
      <div class="flex items-end gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          <input type="checkbox" name="today" value="1" {% if today == '1' %}checked{% endif %} />
          На сегодня
        </label>
      </div>
      <div class="flex items-end gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          <input type="checkbox" name="overdue" value="1" {% if overdue == '1' %}checked{% endif %} />
          Просрочено
        </label>
      </div>
      <div class="flex items-end gap-2">
        <button class="btn btn-primary" type="submit">Фильтр</button>
        <a class="btn btn-outline" href="/tasks/">Сброс</a>
      </div>
    </form>

    <div class="bg-white border rounded-2xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th class="text-left px-4 py-3">Задача</th>
              <th class="text-left px-4 py-3">Компания</th>
              <th class="text-left px-4 py-3">Кому</th>
              <th class="text-left px-4 py-3">Дедлайн</th>
              <th class="text-left px-4 py-3" style="min-width:140px">Статус</th>
              <th class="text-left px-4 py-3">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for t in page.object_list %}
              <tr class="{% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}task-overdue{% endif %}">
                <td>
                  <div class="flex items-start justify-between gap-3">
                    <div class="font-medium">{{ t.title }}</div>
                    {% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}
                      <span class="badge badge-danger flex-shrink-0">Просрочено</span>
                    {% endif %}
                  </div>
                  <div class="text-xs text-brand-dark/70">{{ t.description|truncatechars:120 }}</div>
                </td>
                <td>
                  {% if t.company %}<a class="link" href="/companies/{{ t.company.id }}/">{{ t.company.name }}</a>{% else %}—{% endif %}
                </td>
                <td>{{ t.assigned_to }}</td>
                <td class="muted">
                  <span class="{% if t.due_at and t.due_at < now and t.status != 'done' and t.status != 'cancelled' %}text-red-700{% endif %}">{{ t.due_at|default:"—" }}</span>
                </td>
                <td style="min-width:140px">
                  <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span>
                </td>
                <td>
                  {% if request.user.is_superuser or request.user.role == 'admin' or t.assigned_to_id == request.user.id %}
                    <form method="post" action="/tasks/{{ t.id }}/status/" class="flex flex-wrap gap-2">
                      {% csrf_token %}
                      <button name="status" value="in_progress" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem">В работу</button>
                      <button name="status" value="done" class="btn btn-primary" style="padding:.35rem .6rem;font-size:.75rem">Выполнено</button>
                    </form>
                  {% else %}
                    <span class="muted-2 text-xs">—</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td class="muted" colspan="6" style="padding:1.25rem 1rem">Задач нет.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="flex items-center justify-between px-4 py-3 border-t text-sm">
        <div class="text-brand-dark/70">Стр. {{ page.number }} / {{ page.paginator.num_pages }}</div>
        <div class="flex gap-2">
          {% if page.has_previous %}
            <a class="rounded-lg border border-brand-soft px-3 py-1.5 hover:bg-brand-soft/40" href="?status={{ status }}&mine={{ mine }}&today={{ today }}&overdue={{ overdue }}&page={{ page.previous_page_number }}">Назад</a>
          {% endif %}
          {% if page.has_next %}
            <a class="rounded-lg border border-brand-soft px-3 py-1.5 hover:bg-brand-soft/40" href="?status={{ status }}&mine={{ mine }}&today={{ today }}&overdue={{ overdue }}&page={{ page.next_page_number }}">Вперёд</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}


