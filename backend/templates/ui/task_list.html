{% extends "ui/base.html" %}
{% block title %}Задачи — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Задачи</h1>
        <div class="text-sm text-brand-dark/70">Фильтры: мои / просрочено / статус</div>
      </div>
      <a href="/tasks/new/" class="btn btn-primary">+ Новая задача</a>
    </div>

    <form class="bg-white border rounded-2xl p-4 grid grid-cols-1 md:grid-cols-5 gap-3" method="get">
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Статус</label>
        <select name="status" class="select">
          <option value="">Любой</option>
          <option value="new" {% if status == 'new' %}selected{% endif %}>Новая</option>
          <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>В работе</option>
          <option value="done" {% if status == 'done' %}selected{% endif %}>Выполнена</option>
          <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Отменена</option>
        </select>
      </div>
      <div class="flex items-end gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          <input type="checkbox" name="mine" value="1" {% if mine == '1' %}checked{% endif %} />
          Мои
        </label>
      </div>
      <div class="flex items-end gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          <input type="checkbox" name="today" value="1" {% if today == '1' %}checked{% endif %} />
          На сегодня
        </label>
      </div>
      <div class="flex items-end gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          <input type="checkbox" name="overdue" value="1" {% if overdue == '1' %}checked{% endif %} />
          Просрочено
        </label>
      </div>
      <div class="flex items-end gap-2">
        <button class="btn btn-primary" type="submit">Фильтр</button>
        <a class="btn btn-outline" href="/tasks/">Сброс</a>
      </div>
    </form>

    {% if is_admin %}
      <form method="post" action="/tasks/bulk-reassign/" id="bulkReassignForm" class="bg-white border rounded-2xl p-4 mb-4">
        {% csrf_token %}
        <div class="flex flex-wrap items-end gap-3">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm text-brand-dark/80 mb-1">Переназначить на:</label>
            <select name="assigned_to_id" class="select w-full" required>
              <option value="">Выберите сотрудника</option>
              {% for u in transfer_targets %}
                <option value="{{ u.id }}">{{ u }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex gap-2">
            <button type="submit" name="apply_mode" value="selected" class="btn btn-primary">Переназначить выбранные</button>
            <button type="submit" name="apply_mode" value="filtered" class="btn btn-outline">Переназначить все по фильтру</button>
          </div>
        </div>
        <input type="hidden" name="status" value="{{ status }}" />
        <input type="hidden" name="mine" value="{{ mine }}" />
        <input type="hidden" name="overdue" value="{{ overdue }}" />
        <input type="hidden" name="today" value="{{ today }}" />
      </form>
    {% endif %}

    <div class="bg-white border rounded-2xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              {% if is_admin %}
                <th class="text-left px-4 py-3" style="width:40px">
                  <input type="checkbox" id="bulkSelectAll" title="Выбрать все" />
                </th>
              {% endif %}
              <th class="text-left px-4 py-3">Задача</th>
              <th class="text-left px-4 py-3">Компания</th>
              <th class="text-left px-4 py-3">Кому</th>
              <th class="text-left px-4 py-3">Дедлайн</th>
              <th class="text-left px-4 py-3" style="min-width:140px">Статус</th>
              <th class="text-left px-4 py-3">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for t in page.object_list %}
              <tr class="{% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}task-overdue{% endif %}">
                {% if is_admin %}
                  <td>
                    <input type="checkbox" name="task_ids" value="{{ t.id }}" form="bulkReassignForm" class="task-checkbox" />
                  </td>
                {% endif %}
                <td>
                  <div class="flex items-start justify-between gap-3">
                    <div class="font-medium">{{ t.title }}</div>
                    {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}
                      <span class="badge badge-danger flex-shrink-0">Просрочено</span>
                    {% endif %}
                  </div>
                  <div class="text-xs text-brand-dark/70">{{ t.description|truncatechars:120 }}</div>
                </td>
                <td>
                  {% if t.company %}<a class="link" href="/companies/{{ t.company.id }}/">{{ t.company.name }}</a>{% else %}—{% endif %}
                </td>
                <td>{{ t.assigned_to }}</td>
                <td class="muted">
                  <span class="{% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}text-red-700{% endif %}">{{ t.due_at|default:"—" }}</span>
                </td>
                <td style="min-width:140px">
                  <span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span>
                </td>
                <td>
                  <div class="flex flex-wrap items-center gap-2">
                    {% if t.can_edit_task %}
                      <a class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" href="/tasks/{{ t.id }}/edit/" title="Редактировать" aria-label="Редактировать">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </a>
                    {% endif %}
                    {% if t.can_manage_status %}
                      <form method="post" action="/tasks/{{ t.id }}/status/" class="flex flex-wrap gap-2">
                        {% csrf_token %}
                        <button name="status" value="in_progress" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem">В работу</button>
                        <button name="status" value="done" class="btn btn-primary" style="padding:.35rem .6rem;font-size:.75rem">Выполнено</button>
                      </form>
                    {% endif %}
                    {% if t.can_delete_task %}
                      <form method="post" action="/tasks/{{ t.id }}/delete/" onsubmit="return confirm('Удалить задачу?');">
                        {% csrf_token %}
                        <button class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem;border-color:rgba(220,38,38,.5);color:#b91c1c;">
                          Удалить
                        </button>
                      </form>
                    {% endif %}
                    {% if not t.can_edit_task and not t.can_manage_status %}
                      <span class="muted-2 text-xs">—</span>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr><td class="muted" colspan="{% if is_admin %}7{% else %}6{% endif %}" style="padding:1.25rem 1rem">Задач нет.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="border-t px-4 py-3 flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-2">
          <form method="get" class="flex items-center gap-2" id="perPageForm">
            <label class="text-sm text-brand-dark/70 whitespace-nowrap">На странице:</label>
            <select name="per_page" class="select" onchange="document.getElementById('perPageForm').submit()" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
              <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
            </select>
            {% if status %}<input type="hidden" name="status" value="{{ status }}" />{% endif %}
            {% if mine %}<input type="hidden" name="mine" value="{{ mine }}" />{% endif %}
            {% if overdue %}<input type="hidden" name="overdue" value="{{ overdue }}" />{% endif %}
            {% if today %}<input type="hidden" name="today" value="{{ today }}" />{% endif %}
          </form>
        </div>
        <div>
          {% include "ui/_pagination.html" with page=page qs=qs %}
        </div>
      </div>
    </div>
  </div>

  {% if is_admin %}
    <script>
      (function(){
        const form = document.getElementById('bulkReassignForm');
        const selectAll = document.getElementById('bulkSelectAll');
        const checkboxes = document.querySelectorAll('.task-checkbox');
        
        if (selectAll) {
          selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
          });
        }
        
        checkboxes.forEach(cb => {
          cb.addEventListener('change', function() {
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            if (selectAll) {
              selectAll.checked = allChecked;
              selectAll.indeterminate = someChecked && !allChecked;
            }
          });
        });
      })();
    </script>
  {% endif %}
{% endblock %}


