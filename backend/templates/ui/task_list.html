{% extends "ui/base.html" %}
{% load ui_extras %}
{% block title %}Задачи — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="tasks-layout">
    <div class="flex items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Задачи</h1>
        <div class="text-sm text-brand-dark/70">
          Фильтры: мои / просрочено / статус
          {% if tasks_count is not None %}
            <span class="ml-2 font-medium text-brand-dark">· Найдено: {{ tasks_count }}</span>
          {% endif %}
        </div>
      </div>
      <button type="button" class="btn btn-primary" data-create-task>+ Новая задача</button>
    </div>

    <style>
      /* Ровные отступы между основными блоками (фильтры / bulk / таблица) */
      .tasks-layout > .tasks-layout-block + .tasks-layout-block{
        margin-top:1.75rem;
      }

      /* Bulk-действия в «Задачах»: единый UI в обёртке .task-bulk-panel (без !important) */
      .task-bulk-panel #task-bulk-reschedule,
      .task-bulk-panel #task-bulk-actions .task-bulk-block{
        background:#fff;
        border:1px solid var(--brand-soft);
        border-radius:0.75rem;
        box-shadow:0 1px 3px rgba(0,61,56,.06);
        padding:0.875rem 1rem;
        margin:0;
      }

      .task-bulk-panel #task-bulk-reschedule form,
      .task-bulk-panel #task-bulk-actions .task-bulk-row{
        display:flex;
        align-items:center;
        gap:1rem;
        flex-wrap:wrap;
        margin:0;
        padding:0;
        border:0;
        background:transparent;
      }

      .task-bulk-panel #task-bulk-reschedule .tbr-label,
      .task-bulk-panel #task-bulk-actions .task-bulk-head{
        display:flex;
        align-items:center;
        gap:0.5rem;
        flex-shrink:0;
        font-size:0.875rem;
        font-weight:500;
        color:rgba(0,61,56,.85);
        min-width:10.5rem;
      }

      .task-bulk-panel #task-bulk-reschedule .tbr-icon,
      .task-bulk-panel #task-bulk-actions .task-bulk-icon{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        width:2rem;
        height:2rem;
        border-radius:0.5rem;
        background:rgba(1,148,142,.12);
        color:var(--brand-teal);
        flex-shrink:0;
      }

      .task-bulk-panel #task-bulk-reschedule .tbr-sep,
      .task-bulk-panel #task-bulk-actions .task-bulk-sep{
        width:1px;
        align-self:stretch;
        background:rgba(0,61,56,.25);
        border-radius:999px;
        min-height:2rem;
        flex-shrink:0;
      }

      .task-bulk-panel #task-bulk-reschedule .tbr-fields,
      .task-bulk-panel #task-bulk-actions .task-bulk-controls{
        display:flex;
        align-items:center;
        gap:0.5rem;
        flex-wrap:wrap;
        min-width:0;
        flex:1 1 auto;
      }

      .task-bulk-panel #task-bulk-reschedule .tbr-fields input[type="datetime-local"],
      .task-bulk-panel #task-bulk-actions .task-bulk-controls select{
        min-height:2.25rem;
        padding:0.5rem 0.625rem;
        font-size:0.875rem;
        line-height:1.25;
        border:1px solid rgba(194,226,222,.8);
        border-radius:0.5rem;
        background:#fff;
        box-sizing:border-box;
        min-width:11rem;
        max-width:18rem;
      }

      .task-bulk-panel #task-bulk-reschedule .tbr-fields .custom-datetime-picker{
        flex-shrink:0;
        min-width:11rem;
        max-width:18rem;
      }
      .task-bulk-panel #task-bulk-reschedule .tbr-fields .custom-datetime-picker .input{width:100%;}

      .task-bulk-panel #task-bulk-reschedule .tbr-fields .btn,
      .task-bulk-panel #task-bulk-actions .task-bulk-controls .btn{
        min-height:2.25rem;
        padding:0.5rem 0.75rem;
        font-size:0.875rem;
        box-sizing:border-box;
      }

      /* Модалка подтверждения переноса: плавное появление */
      #bulkRescheduleConfirmModal{opacity:0; transition:opacity .18s ease;}
      #bulkRescheduleConfirmModal.is-open{opacity:1;}
      #bulkRescheduleConfirmModal .bulk-modal-panel{transform:translateY(8px) scale(.98); transition:transform .18s ease;}
      #bulkRescheduleConfirmModal.is-open .bulk-modal-panel{transform:translateY(0) scale(1);}
    </style>

    <form class="bg-white border border-brand-soft/60 rounded-2xl px-3 py-2.5 flex flex-wrap items-center gap-x-4 gap-y-2 tasks-layout-block" method="get" id="taskFilterForm" data-user-id="{{ request.user.id }}">
      <div class="flex items-center gap-2 flex-shrink-0">
        <span class="flex items-center gap-1.5 text-brand-dark/50" title="Статус">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <select name="status" class="select text-sm py-1.5" style="min-width:6.875rem">
            <option value="">Любой статус</option>
          <option value="new" {% if status == 'new' %}selected{% endif %}>Новая</option>
          <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>В работе</option>
          <option value="done" {% if status == 'done' %}selected{% endif %}>Выполнена</option>
          <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Отменена</option>
          </select>
        </span>
        <span class="flex items-center gap-1.5 text-brand-dark/50" title="Исполнитель">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
          <select name="assigned_to" class="select text-sm py-1.5" style="min-width:8.75rem">
            <option value="">Любой исполнитель</option>
          {% regroup filter_assignees by branch as branches_list %}
          {% for branch_group in branches_list %}
            <optgroup label="Филиал: {{ branch_group.grouper.name|default:"Без филиала" }}">
              {% for u in branch_group.list %}
                <option value="{{ u.id }}" {% if assigned_to|default:'' == u.id|stringformat:'s' %}selected{% endif %}>{{ u }}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
          </select>
        </span>
      </div>
      <div class="flex items-center gap-1 border-l border-brand-soft/70 pl-3 flex-shrink-0">
        <label class="inline-flex items-center gap-1.5 text-xs text-brand-dark/80 cursor-pointer whitespace-nowrap py-1 px-1.5 rounded hover:bg-brand-soft/30 transition-colors">
          <input type="checkbox" name="mine" value="1" {% if mine == '1' %}checked{% endif %} class="rounded border-brand-soft/80" />
          <span>Мои</span>
        </label>
        <label class="inline-flex items-center gap-1.5 text-xs text-brand-dark/80 cursor-pointer whitespace-nowrap py-1 px-1.5 rounded hover:bg-brand-soft/30 transition-colors">
          <input type="checkbox" name="today" value="1" {% if today == '1' %}checked{% endif %} class="rounded border-brand-soft/80" />
          <span>Сегодня</span>
        </label>
        <label class="inline-flex items-center gap-1.5 text-xs text-brand-dark/80 cursor-pointer whitespace-nowrap py-1 px-1.5 rounded hover:bg-brand-soft/30 transition-colors">
          <input type="checkbox" name="overdue" value="1" {% if overdue == '1' %}checked{% endif %} class="rounded border-brand-soft/80" />
          <span>Просрочено</span>
        </label>
        <label class="inline-flex items-center gap-1.5 text-xs text-brand-dark/80 cursor-pointer whitespace-nowrap py-1 px-1.5 rounded hover:bg-brand-soft/30 transition-colors" title="Показать выполненные задачи">
          <input type="checkbox" name="show_done" value="1" {% if show_done == '1' %}checked{% endif %} class="rounded border-brand-soft/80" />
          <span>Выполн.</span>
        </label>
      </div>
      <div class="flex items-center gap-2 flex-shrink-0 ml-auto">
        <label class="inline-flex items-center gap-1.5 text-xs text-brand-dark/80 cursor-pointer whitespace-nowrap py-1 px-1.5 rounded hover:bg-brand-soft/30 transition-colors" title="При возврате в «Задачи» фильтры восстановятся">
          <input type="checkbox" id="rememberTaskFilters" class="rounded border-brand-soft/80" />
          <span>Запомнить</span>
        </label>
        <button type="button" class="btn btn-outline btn-sm flex items-center gap-1.5 py-1.5 px-2.5 text-sm" id="dateFilterBtn">
          <svg class="w-3.5 h-3.5 text-brand-dark/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          <span>Период</span>
          {% if date_from or date_to %}
            <span class="text-[10px] bg-brand-orange/25 text-brand-dark px-1 rounded">✓</span>
          {% endif %}
        </button>
        <button class="btn btn-primary btn-sm py-1.5 px-3 text-sm" type="submit">Применить</button>
        <a class="btn btn-outline btn-sm py-1.5 px-2.5 text-sm" href="/tasks/" id="taskFilterResetBtn">Сброс</a>
      </div>
      <!-- Скрытые поля для фильтра по датам (внутри формы, чтобы не ломать вертикальные отступы между блоками) -->
      <input type="hidden" name="date_from" id="dateFromInput" value="{{ date_from|default:'' }}" />
      <input type="hidden" name="date_to" id="dateToInput" value="{{ date_to|default:'' }}" />
    </form>

    {% if can_bulk_actions %}
    <div class="task-bulk-panel tasks-layout-block">
      <div class="tasks-layout-block" style="position: sticky; top: .75rem; z-index: 30;">
        <div class="flex items-center justify-between gap-3 mb-2">
          <p class="text-sm font-medium text-brand-dark/80 m-0">Массовые действия с задачами</p>
          <div class="flex items-center gap-2">
            <span class="text-xs text-brand-dark/60" aria-live="polite">
              Выбрано: <b id="bulkSelectedCount">0</b>
            </span>
            <button type="button" class="btn btn-outline btn-sm opacity-60 pointer-events-none" id="bulkClearSelectionBtn" title="Снять все галочки" disabled aria-disabled="true">Снять выбор</button>
          </div>
        </div>
      </div>
    {% if can_bulk_reschedule %}
      <div id="task-bulk-reschedule" class="tasks-layout-block">
        <p class="text-xs text-brand-dark/60 mb-2 font-medium">Массовый перенос дедлайна: укажите <strong>новую дату</strong>, на которую нужно перенести задачи, и нажмите кнопку справа — дедлайн изменится у отмеченных галочкой задач.</p>
        <form method="post" action="{% url 'task_bulk_reschedule' %}" id="bulkRescheduleForm">
          {% csrf_token %}
          <span class="tbr-label">
            <span class="tbr-icon">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </span>
            Новая дата дедлайна
          </span>
          <span class="tbr-sep" aria-hidden="true"></span>
          <div class="tbr-fields">
            <input type="datetime-local" name="due_at" id="bulkRescheduleDateTime"
              value=""
              title="На эту дату будут перенесены выбранные задачи (рабочие часы 8:00–17:50)"
              aria-label="Новая дата дедлайна для переноса"
              autocomplete="off"
            />
            <button type="button"
                    data-apply-mode="selected"
                    class="btn btn-primary opacity-60 pointer-events-none"
                    title="Перенести дедлайн только у отмеченных галочкой задач"
                    disabled
                    aria-disabled="true">
              Перенести выбранные
            </button>
          </div>
          <input type="hidden" name="status" value="{{ status }}" />
          <input type="hidden" name="mine" value="{{ mine }}" />
          <input type="hidden" name="overdue" value="{{ overdue }}" />
          <input type="hidden" name="today" value="{{ today }}" />
          <input type="hidden" name="assigned_to" value="{{ assigned_to|default:'' }}" />
          <input type="hidden" name="show_done" value="{{ show_done|default:'' }}" />
          <input type="hidden" name="date_from" value="{{ date_from|default:'' }}" />
          <input type="hidden" name="date_to" value="{{ date_to|default:'' }}" />
        </form>
      </div>
    {% endif %}

    {% if is_admin %}
      <div id="task-bulk-actions" class="tasks-layout-block">
        <div class="task-bulk-block">
          <form method="post" action="{% url 'task_bulk_reassign' %}" id="bulkReassignForm">
            {% csrf_token %}
            <div class="task-bulk-row">
              <div class="task-bulk-head">
                <span class="task-bulk-icon">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                </span>
                <span>Переназначить на</span>
              </div>
              <span class="task-bulk-sep" aria-hidden="true"></span>
              <div class="task-bulk-controls">
                <select name="assigned_to_id" required>
                  <option value="">Выберите сотрудника</option>
                  {% regroup transfer_targets by branch as branches_list %}
                  {% for branch_group in branches_list %}
                    <optgroup label="Филиал: {{ branch_group.grouper.name|default:"Без филиала" }}">
                      {% for u in branch_group.list %}
                        <option value="{{ u.id }}">{{ u }} ({{ u.get_role_display }})</option>
                      {% endfor %}
                    </optgroup>
                  {% endfor %}
                </select>
                <button type="submit" name="apply_mode" value="selected" class="btn btn-primary opacity-60 pointer-events-none" title="Переназначить только отмеченные галочкой задачи" disabled aria-disabled="true">Переназначить выбранные</button>
              </div>
            </div>
            <input type="hidden" name="status" value="{{ status }}" />
            <input type="hidden" name="mine" value="{{ mine }}" />
            <input type="hidden" name="overdue" value="{{ overdue }}" />
            <input type="hidden" name="today" value="{{ today }}" />
            <input type="hidden" name="assigned_to" value="{{ assigned_to|default:'' }}" />
            <input type="hidden" name="show_done" value="{{ show_done|default:'' }}" />
            <input type="hidden" name="date_from" value="{{ date_from|default:'' }}" />
            <input type="hidden" name="date_to" value="{{ date_to|default:'' }}" />
          </form>
        </div>
      </div>
    {% endif %}
    </div>
    {% endif %}

    <div class="bg-white border rounded-2xl overflow-hidden tasks-layout-block">
      <div class="overflow-x-auto">
        <table class="table w-full" style="table-layout: fixed; min-width: 60rem;">
          <colgroup>
            {% if show_task_checkboxes %}<col style="width: 2.25rem;" />{% endif %}
            <col style="width: 13rem;" />
            <col />
            <col />
            <col />
            <col style="width: 12rem;" />
            <col style="width: 5.5rem;" />
            <col style="width: 6rem;" />
            <col style="width: 7.5rem;" />
          </colgroup>
          <thead>
            <tr>
              {% if show_task_checkboxes %}
                <th class="text-center px-1 py-2 w-9 shrink-0" style="width: 2.25rem;">
                  <input type="checkbox" id="bulkSelectAll" title="Выбрать все" class="rounded" />
                </th>
              {% endif %}
              <th class="text-left px-2 py-2">
                <a href="?{% if qs %}{{ qs }}&{% endif %}sort=title&dir={% if sort_field == 'title' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'title' %}text-brand-orange font-bold{% endif %}">
                  Задача
                  <div class="flex flex-col gap-0.5">
                    <svg class="w-3 h-3 {% if sort_field == 'title' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                    <svg class="w-3 h-3 {% if sort_field == 'title' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </a>
              </th>
              <th class="text-left px-2 py-2">
                <a href="?{% if qs %}{{ qs }}&{% endif %}sort=company&dir={% if sort_field == 'company' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'company' %}text-brand-orange font-bold{% endif %}">
                  Компания
                  <div class="flex flex-col gap-0.5">
                    <svg class="w-3 h-3 {% if sort_field == 'company' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                    <svg class="w-3 h-3 {% if sort_field == 'company' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </a>
              </th>
              <th class="text-left px-2 py-2">
                <a href="?{% if qs %}{{ qs }}&{% endif %}sort=assignee&dir={% if sort_field == 'assignee' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'assignee' %}text-brand-orange font-bold{% endif %}">
                  Кому
                  <div class="flex flex-col gap-0.5">
                    <svg class="w-3 h-3 {% if sort_field == 'assignee' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                    <svg class="w-3 h-3 {% if sort_field == 'assignee' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </a>
              </th>
              <th class="text-left px-2 py-2">
                <a href="?{% if qs %}{{ qs }}&{% endif %}sort=created_by&dir={% if sort_field == 'created_by' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'created_by' %}text-brand-orange font-bold{% endif %}">
                  Кто
                  <div class="flex flex-col gap-0.5">
                    <svg class="w-3 h-3 {% if sort_field == 'created_by' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                    <svg class="w-3 h-3 {% if sort_field == 'created_by' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </a>
              </th>
              <th class="text-left px-2 py-2">
                <a href="?{% if qs %}{{ qs }}&{% endif %}sort=due_at&dir={% if sort_field == 'due_at' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'due_at' %}text-brand-orange font-bold{% endif %}">
                  Дедлайн
                  <div class="flex flex-col gap-0.5">
                    <svg class="w-3 h-3 {% if sort_field == 'due_at' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                    <svg class="w-3 h-3 {% if sort_field == 'due_at' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </a>
              </th>
              <th class="text-left px-2 py-2">
                <a href="?{% if qs %}{{ qs }}&{% endif %}sort=status&dir={% if sort_field == 'status' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'status' %}text-brand-orange font-bold{% endif %}">
                  Статус
                  <div class="flex flex-col gap-0.5">
                    <svg class="w-3 h-3 {% if sort_field == 'status' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                    <svg class="w-3 h-3 {% if sort_field == 'status' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </a>
              </th>
              <th class="text-left px-2 py-2">Действия</th>
              <th class="text-left px-2 py-2">
                <a href="?{% if qs %}{{ qs }}&{% endif %}sort=created_at&dir={% if sort_field == 'created_at' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'created_at' %}text-brand-orange font-bold{% endif %}">
                  Дата создания
                  <div class="flex flex-col gap-0.5">
                    <svg class="w-3 h-3 {% if sort_field == 'created_at' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                    <svg class="w-3 h-3 {% if sort_field == 'created_at' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </a>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for t in page.object_list %}
              {% if sort_field == 'company' %}
                {% ifchanged t.company_id %}
                  <tr class="bg-brand-soft/20">
                    <td class="px-4 py-2 text-xs text-brand-dark/70 font-medium" colspan="{% if show_task_checkboxes %}8{% else %}7{% endif %}">
                      {% if t.company %}
                        Компания: <a class="link" href="/companies/{{ t.company.id }}/">{{ t.company.name }}</a>
                      {% else %}
                        Без компании
                      {% endif %}
                    </td>
                  </tr>
                {% endifchanged %}
              {% endif %}
              <tr class="{% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}task-overdue{% endif %}">
                {% if show_task_checkboxes %}
                  <td style="width:2.8125rem;min-width:2.8125rem;max-width:2.8125rem">
                    <input type="checkbox" name="task_ids" value="{{ t.id }}" class="task-checkbox" aria-label="Выбрать задачу" />
                  </td>
                {% endif %}
                <td class="px-2 py-2" style="width:13rem;min-width:13rem;max-width:13rem;word-wrap:break-word;overflow-wrap:break-word">
                  <div class="flex items-start gap-2">
                    {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}
                      <div class="flex items-center justify-center w-5 h-5 rounded-full border-2 border-red-600 flex-shrink-0" title="Просрочено">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M12 8v4"/>
                          <path d="M12 16h.01"/>
                        </svg>
                      </div>
                    {% endif %}
                    <div class="flex-1" style="line-height:1.4">
                      <div class="mb-0.5">
                        {% if t.type %}
                          {% include "ui/partials/task_type_badge.html" with task_type=t.type only %}
                        {% elif t.title %}
                          <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-800">
                            {{ t.title }}
                          </span>
                        {% else %}
                          <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">Без статуса</span>
                        {% endif %}
                      </div>
                      {% if t.description %}
                        <div class="text-xs text-brand-dark/70 mt-1" style="line-height:1.3">{{ t.description }}</div>
                      {% endif %}
                      {% include "ui/partials/_task_meta.html" with task=t hide_created_by=True only %}
                    </div>
                  </div>
                </td>
                <td class="px-2 py-2 min-w-0 break-words">
                  {% if t.company %}
                    <div style="line-height:1.4">
                      <a class="link" href="/companies/{{ t.company.id }}/">{{ t.company.name }}</a>
                      {# приоритет: сохранённый вручную, затем авто по адресу #}
                      {% with guessed=t.company.address|guess_ru_tz %}
                      {% with tz=t.company.work_timezone|default:guessed %}
                        {% if tz %}
                          <div class="mt-1">
                            <span class="badge badge-warn badge-xxxs" title="{{ tz }}" data-live-worktime="1" data-company-id="{{ t.company.id }}">
                              <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                              · {{ tz|tz_label }}
                            </span>
                          </div>
                          <span class="hidden" data-work-schedule-display="1" data-company-id="{{ t.company.id }}">{{ t.company.work_schedule|default:"" }}</span>
                        {% endif %}
                      {% endwith %}
                      {% endwith %}
                    </div>
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="px-2 py-2 min-w-0 break-words"><span style="line-height:1.4">{{ t.assigned_to|default:"—" }}</span></td>
                <td class="px-2 py-2 min-w-0 break-words"><span style="line-height:1.4">{{ t.created_by|default:"—" }}</span></td>
                <td class="muted px-2 py-2 min-w-0 break-words" style="width:12rem;min-width:12rem;max-width:12rem;">
                  <span class="{% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}text-red-700{% endif %}" style="line-height:1.4">{{ t.due_at|default:"—" }}</span>
                </td>
                <td class="px-2 py-2" style="width:5.5rem;min-width:5.5rem;max-width:5.5rem;"><span class="badge {% if t.status == 'new' %}badge-new{% elif t.status == 'in_progress' %}badge-progress{% elif t.status == 'done' %}badge-done{% elif t.status == 'cancelled' %}badge-cancel{% endif %}">{{ t.get_status_display }}</span></td>
                <td class="px-2 py-2 w-24 shrink-0">
                  <div class="grid grid-cols-2 gap-1">
                    {% if t.can_edit_task %}
                      <button type="button" class="flex items-center justify-center w-6 h-6 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors" data-edit-task data-task-id="{{ t.id }}" title="Редактировать" aria-label="Редактировать">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M12 20h9"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                        </svg>
                      </button>
                    {% else %}
                      <div></div>
                    {% endif %}
                    {% if t.can_manage_status and t.status != 'in_progress' %}
                      <form method="post" action="/tasks/{{ t.id }}/status/" class="inline">
                        {% csrf_token %}
                        <button name="status" value="in_progress" class="flex items-center justify-center w-6 h-6 rounded bg-brand-orange hover:opacity-90 text-white transition-colors" title="В работу" aria-label="В работу">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
                            <path d="M8 2v4"/>
                            <path d="M16 2v4"/>
                            <path d="M8 10h8"/>
                            <path d="M8 14h8"/>
                          </svg>
                        </button>
                      </form>
                    {% elif t.can_manage_status %}
                      <div></div>
                    {% else %}
                      <div></div>
                    {% endif %}
                    {% if t.can_manage_status and t.status != 'done' %}
                      <button
                        type="button"
                        class="flex items-center justify-center w-6 h-6 rounded bg-brand-teal hover:bg-brand-dark text-white transition-colors"
                        title="Выполнено"
                        aria-label="Выполнено"
                        data-task-complete
                        data-task-id="{{ t.id }}"
                      >
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                      </button>
                    {% else %}
                      <div></div>
                    {% endif %}
                    {% if t.can_delete_task %}
                      <button
                        type="button"
                        class="flex items-center justify-center w-6 h-6 rounded bg-white border border-red-200 hover:bg-red-50 transition-colors"
                        title="Удалить"
                        aria-label="Удалить"
                        data-task-delete
                        data-task-id="{{ t.id }}"
                      >
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7"/>
                        </svg>
                      </button>
                    {% else %}
                      <div></div>
                    {% endif %}
                  </div>
                </td>
                <td class="muted px-2 py-2" style="width:7.5rem;min-width:7.5rem;max-width:7.5rem;word-wrap:break-word;overflow-wrap:break-word;"><span style="line-height:1.4">{{ t.created_at|date:"d.m.Y H:i" }}</span></td>
              </tr>
            {% empty %}
              <tr><td class="muted" colspan="{% if show_task_checkboxes %}8{% else %}7{% endif %}" style="padding:1.25rem 1rem">Задач нет.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="border-t px-4 py-3 flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-2">
          <form method="get" class="flex items-center gap-2" id="perPageForm">
            <label class="text-sm text-brand-dark/70 whitespace-nowrap">На странице:</label>
            <select name="per_page" class="select" onchange="document.getElementById('perPageForm').submit()" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
              <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
            </select>
            {% if status %}<input type="hidden" name="status" value="{{ status }}" />{% endif %}
            {% if mine %}<input type="hidden" name="mine" value="{{ mine }}" />{% endif %}
            {% if overdue %}<input type="hidden" name="overdue" value="{{ overdue }}" />{% endif %}
            {% if today %}<input type="hidden" name="today" value="{{ today }}" />{% endif %}
            {% if show_done %}<input type="hidden" name="show_done" value="{{ show_done }}" />{% endif %}
            {% if sort %}<input type="hidden" name="sort" value="{{ sort }}" />{% endif %}
          </form>
        </div>
        <div>
          {% include "ui/_pagination.html" with page=page qs=qs %}
        </div>
      </div>
    </div>
  </div>

  {% if view_task %}
    <div id="taskViewModal" class="fixed inset-0 z-[200]" style="display:block">
      <div class="fixed inset-0 bg-black/35" data-close-task-view></div>
      <div class="absolute inset-x-4 top-12 mx-auto max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3 mb-4">
            <div class="flex-1">
              <div class="flex items-center justify-between gap-2 mb-2">
                <div class="flex items-center gap-2">
                  {# Задача (тип задачи) - используем TaskType если есть #}
                  {% if view_task.type %}
                    {% include "ui/partials/task_type_badge.html" with task_type=view_task.type only %}
                  {% endif %}
                  {% if view_task.can_edit_task %}
                    <button type="button" class="btn btn-outline btn-sm" data-edit-task data-task-id="{{ view_task.id }}">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Редактировать
                    </button>
                  {% endif %}
                </div>
                {# Системный статус справа #}
                <span class="badge {% if view_task.status == 'new' %}badge-new{% elif view_task.status == 'in_progress' %}badge-progress{% elif view_task.status == 'done' %}badge-done{% elif view_task.status == 'cancelled' %}badge-cancel{% endif %}">
                  {{ view_task.get_status_display }}
                </span>
              </div>
              <h2 class="text-xl font-semibold text-brand-dark">{{ view_task.title }}</h2>
              {% if view_task.description %}
                <div class="text-sm text-brand-dark/70 mt-2 whitespace-pre-wrap">{{ view_task.description }}</div>
              {% endif %}
            </div>
            <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-view aria-label="Закрыть" title="Закрыть">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          
          <div class="space-y-3 pt-3 border-t">
            {% if view_task.company %}
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-brand-dark/60 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="text-xs text-brand-dark/60 mb-0.5">Компания</div>
                  <a href="/companies/{{ view_task.company.id }}/" class="link font-medium">{{ view_task.company.name }}</a>
                </div>
              </div>
            {% endif %}
            
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-brand-dark/60 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              <div class="flex-1 min-w-0">
                <div class="text-xs text-brand-dark/60 mb-0.5">Ответственный</div>
                <div class="font-medium">{{ view_task.assigned_to|default:"Не назначен" }}</div>
              </div>
            </div>
            
            {% if view_task.created_at %}
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-brand-dark/60 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="text-xs text-brand-dark/60 mb-0.5">Поставлена</div>
                  <div class="font-medium">{{ view_task.created_at|date:"d.m.Y H:i" }}</div>
                </div>
              </div>
            {% endif %}
            
            {% if view_task.due_at %}
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-brand-dark/60 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="text-xs text-brand-dark/60 mb-0.5">Дедлайн</div>
                  <div class="font-medium {% if view_task.due_at < local_now %}text-red-700{% endif %}">{{ view_task.due_at|date:"d.m.Y H:i" }}</div>
                </div>
              </div>
            {% endif %}
            
            {% if view_task.completed_at %}
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-brand-dark/60 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="text-xs text-brand-dark/60 mb-0.5">Выполнена</div>
                  <div class="font-medium text-green-700">{{ view_task.completed_at|date:"d.m.Y H:i" }}</div>
                </div>
              </div>
            {% endif %}
            
            {% if view_task_overdue_days and view_task_overdue_days > 0 %}
              <div class="flex items-start gap-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium text-red-800">Задача была просрочена</div>
                  <div class="text-xs text-red-600 mt-0.5">
                    Выполнена на {{ view_task_overdue_days }} {% if view_task_overdue_days == 1 %}день{% elif view_task_overdue_days < 5 %}дня{% else %}дней{% endif %} позже дедлайна
                  </div>
                </div>
              </div>
            {% elif view_task.due_at and view_task.completed_at and view_task.completed_at <= view_task.due_at %}
              <div class="flex items-start gap-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium text-green-800">Задача выполнена в срок</div>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if show_task_checkboxes %}
    <script>
      (function(){
        const selectAll = document.getElementById('bulkSelectAll');
        const selectedCountEl = document.getElementById('bulkSelectedCount');
        const clearBtn = document.getElementById('bulkClearSelectionBtn');
        function getCheckboxes() { return document.querySelectorAll('.task-checkbox'); }
        const rescheduleForm = document.getElementById('bulkRescheduleForm');
        const reassignForm = document.getElementById('bulkReassignForm');
        
        function injectSelectedTaskIdsToForm(formEl) {
          if (!formEl) return 0;
          formEl.querySelectorAll('input[name="task_ids"][data-injected="1"]').forEach(el => el.remove());
          const checked = document.querySelectorAll('.task-checkbox:checked');
          checked.forEach(function(cb) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'task_ids';
            input.value = cb.value;
            input.setAttribute('data-injected', '1');
            formEl.appendChild(input);
          });
          return checked.length;
        }

        function getSelectedCount() {
          return document.querySelectorAll('.task-checkbox:checked').length;
        }

        function clearSelection() {
          getCheckboxes().forEach(cb => { cb.checked = false; });
          if (selectAll) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
          }
          updateBulkButtonsState();
        }

        if (selectAll) {
          selectAll.addEventListener('change', function() {
            getCheckboxes().forEach(cb => cb.checked = this.checked);
            updateBulkButtonsState();
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener('click', function() {
            clearSelection();
          });
        }
        
        function updateBulkButtonsState() {
          const dateInput = document.getElementById('bulkRescheduleDateTime');
          const hasDate = !!(dateInput && dateInput.value);
          const checked = getSelectedCount();
          const hasSelected = checked > 0;

          if (selectedCountEl) selectedCountEl.textContent = String(checked);
          if (clearBtn) {
            clearBtn.disabled = !hasSelected;
            clearBtn.classList.toggle('opacity-60', !hasSelected);
            clearBtn.classList.toggle('pointer-events-none', !hasSelected);
            clearBtn.setAttribute('aria-disabled', hasSelected ? 'false' : 'true');
          }

          if (rescheduleForm) {
            const btnSelected = rescheduleForm.querySelector('button[data-apply-mode="selected"]');
            if (btnSelected) {
              const enabled = hasDate && hasSelected;
              btnSelected.disabled = !enabled;
              btnSelected.classList.toggle('opacity-60', !enabled);
              btnSelected.classList.toggle('pointer-events-none', !enabled);
              btnSelected.setAttribute('aria-disabled', enabled ? 'false' : 'true');
              if (!hasDate) {
                btnSelected.title = 'Укажите новую дату дедлайна';
              } else if (!hasSelected) {
                btnSelected.title = 'Выберите хотя бы одну задачу (чекбоксы слева)';
              } else {
                btnSelected.title = 'Перенести дедлайн только у отмеченных галочкой задач';
              }
            }
          }

          if (reassignForm) {
            const selectAssignee = reassignForm.querySelector('select[name="assigned_to_id"]');
            const hasAssignee = !!(selectAssignee && selectAssignee.value);
            const btnReassignSelected = reassignForm.querySelector('button[name="apply_mode"][value="selected"]');

            if (btnReassignSelected) {
              const enabled = hasAssignee && hasSelected;
              btnReassignSelected.disabled = !enabled;
              btnReassignSelected.classList.toggle('opacity-60', !enabled);
              btnReassignSelected.classList.toggle('pointer-events-none', !enabled);
              btnReassignSelected.setAttribute('aria-disabled', enabled ? 'false' : 'true');
              if (!hasAssignee) {
                btnReassignSelected.title = 'Выберите сотрудника';
              } else if (!hasSelected) {
                btnReassignSelected.title = 'Выберите хотя бы одну задачу (чекбоксы слева)';
              } else {
                btnReassignSelected.title = 'Переназначить только отмеченные галочкой задачи';
              }
            }
          }
        }

        getCheckboxes().forEach(cb => {
          cb.addEventListener('change', function() {
            const all = Array.from(getCheckboxes());
            const allChecked = all.length > 0 && all.every(cb => cb.checked);
            const someChecked = all.some(cb => cb.checked);
            if (selectAll) {
              selectAll.checked = allChecked;
              selectAll.indeterminate = someChecked && !allChecked;
            }
            updateBulkButtonsState();
          });
        });

        updateBulkButtonsState();

        if (reassignForm) {
          const selectAssignee = reassignForm.querySelector('select[name=\"assigned_to_id\"]');
          if (selectAssignee) {
            selectAssignee.addEventListener('change', updateBulkButtonsState);
          }
          // При сабмите на "Переназначить выбранные" всегда дублируем отмеченные task_ids в форму.
          reassignForm.addEventListener('submit', function(e) {
            const submitter = e.submitter;
            if (!submitter || submitter.name !== 'apply_mode' || submitter.value !== 'selected') {
              return;
            }
            const checked = document.querySelectorAll('.task-checkbox:checked');
            if (!checked.length) {
              e.preventDefault();
              alert('Выберите хотя бы одну задачу (чекбоксы слева).');
              return;
            }
            reassignForm.querySelectorAll('input[name=\"task_ids\"][data-injected=\"1\"]').forEach(el => el.remove());
            checked.forEach(function(cb) {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'task_ids';
              input.value = cb.value;
              input.setAttribute('data-injected', '1');
              reassignForm.appendChild(input);
            });
          });
        }

        // Массовый перенос дедлайна: красивое подтверждение (модалка) + preview/count с сервера
        if (rescheduleForm) {
          // Защита от нативного submit (Enter в поле даты и т.п.): всегда инжектим task_ids.
          rescheduleForm.addEventListener('submit', function(e) {
            // Если submit пришёл не из нашего сценария подтверждения — всё равно инжектим выбранные.
            const count = injectSelectedTaskIdsToForm(rescheduleForm);
            if (!count) {
              e.preventDefault();
              alert('Выберите хотя бы одну задачу (чекбоксы слева).');
            }
          });

          const modal = document.getElementById('bulkRescheduleConfirmModal');
          const modalTitle = document.getElementById('bulkRescheduleModalTitle');
          const modalDate = document.getElementById('bulkRescheduleModalDate');
          const modalCount = document.getElementById('bulkRescheduleModalCount');
          const modalHint = document.getElementById('bulkRescheduleModalHint');
          const modalSample = document.getElementById('bulkRescheduleModalSample');
          const modalSampleWrap = document.getElementById('bulkRescheduleModalSampleWrap');
          const modalError = document.getElementById('bulkRescheduleModalError');
          const btnCancel = document.getElementById('bulkRescheduleModalCancel');
          const btnConfirm = document.getElementById('bulkRescheduleModalConfirm');

          let pendingMode = null;
          let lastPreviewCount = 0;
          const STRONG_CONFIRM_THRESHOLD = 200;

          const dateInput = document.getElementById('bulkRescheduleDateTime');
          if (dateInput) {
            dateInput.addEventListener('change', function() {
              updateBulkButtonsState();
              if (modal && !modal.classList.contains('hidden')) {
                btnConfirm.disabled = true;
                btnConfirm.classList.add('opacity-60','pointer-events-none');
                modalHint.textContent = 'Параметры переноса изменились. Закройте окно и откройте его заново, чтобы пересчитать задачи.';
              }
            });
          }

          function fmtIso(iso){
            try{
              if(!iso) return '—';
              // iso like 2026-02-05T17:00:00+03:00 -> show 05.02.2026 17:00
              const d = new Date(iso);
              if(Number.isNaN(d.getTime())) return String(iso).replace('T',' ').slice(0,16);
              return d.toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
            }catch(_){ return String(iso).replace('T',' ').slice(0,16); }
          }

          function openModal(){
            if(!modal) return false;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            requestAnimationFrame(() => modal.classList.add('is-open'));
            document.body.style.overflow = 'hidden';
            return true;
          }
          function closeModal(){
            if(!modal) return;
            modal.classList.remove('is-open');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
          }
          function setLoading(){
            modalError.classList.add('hidden');
            modalCount.textContent = 'Считаем…';
            modalHint.textContent = '';
            modalSample.innerHTML = '';
            modalSampleWrap.classList.add('hidden');
            btnConfirm.disabled = true;
            btnConfirm.classList.add('opacity-60','pointer-events-none');
            lastPreviewCount = 0;
          }
          function setError(msg){
            modalError.textContent = msg || 'Не удалось получить предварительный просмотр.';
            modalError.classList.remove('hidden');
            modalCount.textContent = '—';
          }
          function setReady(data){
            const count = Number(data && data.count || 0);
            const cap = Number(data && data.cap || 5000);
            lastPreviewCount = count;
            modalCount.textContent = String(count);

            if (count >= cap) {
              modalHint.textContent = `Внимание: выбран предел (${cap}). Сузьте фильтр и повторите.`;
            } else if (count === 0) {
              modalHint.textContent = 'По текущим условиям задач для переноса нет.';
            } else {
              const req = data && data.requested_count != null ? Number(data.requested_count) : null;
              if (req != null && req !== count) {
                modalHint.textContent = `Из выбранных задач доступно для переноса: ${count} (выбрано: ${req}).`;
              }
            }

            const sample = (data && data.sample) ? data.sample : [];
            if (Array.isArray(sample) && sample.length){
              modalSampleWrap.classList.remove('hidden');
              modalSample.innerHTML = sample.map((t) => {
                const c = t.company ? ` — ${t.company}` : '';
                const due = t.due_at ? fmtIso(t.due_at) : '—';
                return `<div class="flex items-start justify-between gap-3 py-1.5">
  <div class="min-w-0">
    <div class="text-sm font-medium text-brand-dark truncate">${(t.title || 'Задача')}</div>
    <div class="text-xs text-brand-dark/60 truncate">${c ? c.slice(3) : ''}</div>
  </div>
  <div class="text-xs text-brand-dark/70 whitespace-nowrap">было: ${due}</div>
</div>`;
              }).join('');
            }

            if (count === 0 || count >= cap){
              btnConfirm.disabled = true;
              btnConfirm.classList.add('opacity-60','pointer-events-none');
              return;
            }
            btnConfirm.disabled = false;
            btnConfirm.classList.remove('opacity-60','pointer-events-none');
          }

          function csrfToken(){
            const el = rescheduleForm.querySelector('input[name="csrfmiddlewaretoken"]');
            return el ? el.value : '';
          }

          async function fetchPreview(formData){
            const res = await fetch('/tasks/bulk-reschedule/preview/', {
              method: 'POST',
              headers: { 'X-CSRFToken': csrfToken() },
              body: formData,
            });
            const data = await res.json().catch(()=>null);
            if(!res.ok || !data || data.ok !== true){
              const err = data && (data.error || data.detail) ? (data.error || data.detail) : 'Ошибка preview.';
              throw new Error(err);
            }
            return data;
          }

          if (btnCancel) btnCancel.addEventListener('click', function(e){ e.preventDefault(); closeModal(); });
          if (modal) modal.addEventListener('click', function(e){ if(e.target === modal) closeModal(); });
          document.addEventListener('keydown', function(e){ if(e.key === 'Escape' && modal && !modal.classList.contains('hidden')) closeModal(); });

          if (btnConfirm) btnConfirm.addEventListener('click', function(e){
            e.preventDefault();
            if (!pendingMode) return;
            // Гарантируем, что apply_mode уйдёт в POST даже при programmatic submit()
            rescheduleForm.querySelectorAll('input[name="apply_mode"][data-injected="1"]').forEach(el => el.remove());
            const m = document.createElement('input');
            m.type = 'hidden';
            m.name = 'apply_mode';
            m.value = pendingMode;
            m.setAttribute('data-injected', '1');
            rescheduleForm.appendChild(m);

            const count = injectSelectedTaskIdsToForm(rescheduleForm);
            if (!count) {
              alert('Выберите хотя бы одну задачу (чекбоксы слева).');
              return;
            }

            // Сабмитим максимально надёжно: через временный submit-элемент.
            // Так мы избегаем кейсов, когда programmatic submit уходит без ожидаемых полей.
            const tmpSubmit = document.createElement('button');
            tmpSubmit.type = 'submit';
            tmpSubmit.style.display = 'none';
            tmpSubmit.setAttribute('data-injected', '1');
            rescheduleForm.appendChild(tmpSubmit);
            try {
              closeModal();
              if (typeof rescheduleForm.requestSubmit === 'function') {
                rescheduleForm.requestSubmit(tmpSubmit);
              } else {
                tmpSubmit.click();
              }
            } finally {
              tmpSubmit.remove();
            }
          });

          async function handleBulkReschedule(mode) {
            pendingMode = 'selected';
            const dateInput = document.getElementById('bulkRescheduleDateTime');
            const dateLabel = dateInput && dateInput.value ? dateInput.value.replace('T', ' ') : '';
            if (!dateLabel) {
              alert('Укажите новую дату дедлайна.');
              return;
            }

            if (!openModal()) {
              // fallback: если модалка не открылась, не блокируем стандартный submit
              rescheduleForm.submit();
              return;
            }
            modalTitle.textContent = 'Подтвердите перенос выбранных';
            let tz = '';
            try {
              tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
            } catch (_e) {
              tz = '';
            }
            modalDate.textContent = tz ? `${dateLabel} (${tz})` : dateLabel;
            setLoading();

            // Подготовка данных для preview
            const fd = new FormData();
            fd.append('apply_mode', pendingMode);
            fd.append('due_at', dateInput.value);

            const checked = document.querySelectorAll('.task-checkbox:checked');
            if (!checked.length) {
              closeModal();
              alert('Выберите хотя бы одну задачу (чекбоксы слева).');
              return;
            }
            checked.forEach(cb => fd.append('task_ids', cb.value));

            try{
              const data = await fetchPreview(fd);
              setReady(data);
            }catch(err){
              setError(err && err.message ? err.message : String(err));
            }
          }

          const applyButtons = rescheduleForm.querySelectorAll('button[data-apply-mode]');
          applyButtons.forEach((btn) => {
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              const mode = this.getAttribute('data-apply-mode') || 'selected';
              handleBulkReschedule(mode);
            });
          });
        }
      })();
    </script>
  {% endif %}

  <!-- Модалка подтверждения массового переноса дедлайна -->
  <div id="bulkRescheduleConfirmModal" class="hidden fixed inset-0 z-[210] items-center justify-center bg-black/40 px-4">
    <div class="bulk-modal-panel w-full max-w-xl rounded-2xl border border-brand-soft bg-white shadow-2xl overflow-hidden">
      <div class="px-5 py-4 border-b border-brand-soft/70 flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div id="bulkRescheduleModalTitle" class="text-base font-semibold text-brand-dark">Подтверждение</div>
          <div class="text-xs text-brand-dark/60 mt-0.5">
            Новая дата дедлайна: <b id="bulkRescheduleModalDate">—</b>
          </div>
        </div>
        <button id="bulkRescheduleModalCancel" type="button" class="btn btn-outline btn-sm">Закрыть</button>
      </div>

      <div class="px-5 py-4 space-y-3">
        <div class="flex flex-wrap items-center gap-2">
          <span class="badge badge-new">К задачам применится перенос</span>
          <span class="text-sm text-brand-dark/80">Количество: <b id="bulkRescheduleModalCount">—</b></span>
        </div>

        <div id="bulkRescheduleModalError" class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded-xl px-4 py-2"></div>
        <div id="bulkRescheduleModalHint" class="text-sm text-brand-dark/70"></div>

        <div id="bulkRescheduleModalSampleWrap" class="hidden">
          <div class="text-xs font-medium text-brand-dark/70 mb-2">Примеры задач (первые несколько):</div>
          <div id="bulkRescheduleModalSample" class="divide-y divide-brand-soft/60 border border-brand-soft/70 rounded-xl px-3 py-2 bg-brand-soft/10"></div>
          <div class="text-[11px] text-brand-dark/50 mt-1">Показаны только несколько задач для ориентира. Будут изменены все задачи из выбранного режима.</div>
        </div>
      </div>

      <div class="px-5 py-4 border-t border-brand-soft/70 flex items-center justify-end gap-2 bg-white">
        <button id="bulkRescheduleModalConfirm" type="button" class="btn btn-primary opacity-60 pointer-events-none" disabled>Подтвердить перенос</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно для создания задач -->
  <div id="taskCreateModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-create-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
      <div id="taskCreateModalContent"></div>
    </div>
  </div>

  <!-- Модальное окно для редактирования задач -->
  <div id="taskEditModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
      <div id="taskEditModalContent"></div>
    </div>
  </div>

  {% if view_task %}
    <script>
      (function(){
        const modal = document.getElementById('taskViewModal');
        if (!modal) return;
        
        // Модальное окно уже видимо (нет класса hidden), но убедимся
        modal.classList.remove('hidden');
        
        const closeBtns = modal.querySelectorAll('[data-close-task-view]');
        function closeM() {
          modal.style.display = 'none';
          // Убираем параметр view_task из URL без перезагрузки
          const url = new URL(window.location);
          url.searchParams.delete('view_task');
          window.history.replaceState({}, '', url);
        }
        
        closeBtns.forEach(b => b.addEventListener('click', closeM));
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.style.display !== 'none') closeM();
        });
        
        // Закрытие при клике на затемнение
        const overlay = modal.querySelector('.bg-black\\/35');
        if (overlay) {
          overlay.addEventListener('click', function(e) {
            if (e.target === this) closeM();
          });
        }
      })();
    </script>
  {% endif %}

  <script>
    (function() {
      const modal = document.getElementById('taskEditModal');
      const modalContent = document.getElementById('taskEditModalContent');
      if (!modal || !modalContent) return;

      // Закрытие модалки
      function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
      }
      // Делегирование для динамически добавленных кнопок закрытия
      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-close-task-modal]');
        if (closeBtn) {
          e.preventDefault();
          closeModal();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });

      // Редактирование задачи
      document.querySelectorAll('[data-edit-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const taskId = this.dataset.taskId;
          const url = `/tasks/${taskId}/edit/?modal=1`;
          
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Ошибка загрузки формы');
            const html = await res.text();
            modalContent.innerHTML = html;
            modal.classList.remove('hidden');
            
            // Инициализация select для типа задачи с задержкой
            setTimeout(function() {
              if (window.initTaskTypeSelects) {
                window.initTaskTypeSelects();
              }
              // Инициализация виджета выбора компании
              if (window.initMsSingleWidgets) {
                window.initMsSingleWidgets(modalContent);
              }
            }, 100);
            
            // Обработка формы
            const form = modalContent.querySelector('[data-task-edit-form]');
            if (form) {
              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                try {
                  const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                  });
                  const data = await res.json();
                  if (data.ok) {
                    closeModal();
                    // Обновляем строку задачи в таблице без перезагрузки страницы
                    const taskRow = document.querySelector(`[data-task-id="${taskId}"]`)?.closest('tr');
                    if (taskRow) {
                      // Обновляем бейдж статуса
                      const badgeCell = taskRow.querySelector('[data-task-badge]');
                      if (badgeCell && data.type_name) {
                        // Здесь можно обновить бейдж через AJAX или просто перезагрузить страницу
                        location.reload();
                      } else {
                        location.reload();
                      }
                    } else {
                      location.reload();
                    }
                  } else {
                    alert('Ошибка: ' + (data.error || 'Не удалось сохранить'));
                  }
                } catch (err) {
                  alert('Ошибка при сохранении: ' + err.message);
                }
              });
            }
          } catch (err) {
            alert('Ошибка загрузки формы: ' + err.message);
          }
        });
      });
    })();
  </script>

  <script>
    (function() {
      const modal = document.getElementById('taskCreateModal');
      const modalContent = document.getElementById('taskCreateModalContent');
      if (!modal || !modalContent) return;

      // Закрытие модалки
      function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
      }
      // Делегирование для динамически добавленных кнопок закрытия
      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-close-task-create-modal]');
        if (closeBtn) {
          e.preventDefault();
          closeModal();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });

      // Создание задачи
      document.querySelectorAll('[data-create-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const companyId = this.dataset.companyId || new URLSearchParams(window.location.search).get('company') || '';
          const url = `/tasks/new/?modal=1${companyId ? '&company=' + companyId : ''}`;
          
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Ошибка загрузки формы');
            const html = await res.text();
            modalContent.innerHTML = html;
            modal.classList.remove('hidden');
            
            // Инициализация select для типа задачи с задержкой
            setTimeout(function() {
              if (window.initTaskTypeSelects) {
                window.initTaskTypeSelects();
              }
              // Инициализация виджета выбора компании
              if (window.initMsSingleWidgets) {
                window.initMsSingleWidgets(modalContent);
                
                // Устанавливаем выбранную компанию после инициализации виджета
                if (companyId) {
                  const companySelect = modalContent.querySelector('select[name="company"], select#id_company');
                  if (companySelect) {
                    companySelect.value = companyId;
                    companySelect.dispatchEvent(new Event('change', { bubbles: true }));
                    const msWidget = companySelect.closest('[data-ms-single="1"]');
                    if (msWidget) {
                      const valueEl = msWidget.querySelector('.ms-value');
                      const selectedOption = companySelect.options[companySelect.selectedIndex];
                      if (valueEl && selectedOption) {
                        valueEl.textContent = selectedOption.textContent.trim();
                      }
                    }
                    fetch(`/companies/autocomplete/?id=${encodeURIComponent(companyId)}`, {
                      headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(res => res.json())
                    .then(data => {
                      const company = (data.items || [])[0];
                      if (!company) return;
                      const opt = Array.from(companySelect.options).find(o => o.value === companyId);
                      if (!opt) return;
                      opt.dataset.isBranch = company.is_branch ? '1' : '0';
                      opt.dataset.hasBranches = company.has_branches ? '1' : '0';
                      if (window.updateApplyToOrgForModal) {
                        window.updateApplyToOrgForModal(modalContent);
                      }
                    })
                    .catch(() => {});
                  }
                }
              }
            }, 100);
            
            // Обработка формы
            const form = modalContent.querySelector('[data-task-create-form]');
            if (form) {
              const typeSelect = form.querySelector('#id_type');
              const typeErrorBox = form.querySelector('[data-task-type-error]');
              const defaultTypeErrorMsg = 'Пожалуйста, выберите тип задачи в поле «Задача».';

              function setTypeError(msg) {
                if (!typeErrorBox) return;
                const m = (msg || '').trim();
                typeErrorBox.textContent = m;
                typeErrorBox.classList.toggle('hidden', !m);
              }

              if (typeSelect) {
                typeSelect.addEventListener('change', () => {
                  // Скрываем ошибку сразу при выборе, и показываем сразу при возврате к пустому значению
                  const hasValue = Boolean(typeSelect.value && typeSelect.value !== '0');
                  setTypeError(hasValue ? '' : defaultTypeErrorMsg);
                });
              }

              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                
                try {
                  const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                  });
                  const data = await res.json();
                  if (data.ok) {
                    closeModal();
                    location.reload();
                  } else {
                    // Извлекаем ошибку для поля "type"
                    let fieldMessage = '';
                    if (data.errors && data.errors.type) {
                      if (Array.isArray(data.errors.type)) {
                        fieldMessage = data.errors.type.join(', ');
                      } else if (typeof data.errors.type === 'object' && data.errors.type.length) {
                        fieldMessage = Array.from(data.errors.type).join(', ');
                      } else {
                        fieldMessage = String(data.errors.type);
                      }
                    }
                    const msg = fieldMessage || data.error || 'Проверьте заполнение формы задачи.';

                    // Показываем ошибку под полем "Задача"
                    setTypeError(fieldMessage || '');

                    // Если ошибка не по полю "type", показываем toast
                    if (!fieldMessage) {
                      if (window.uiToast) {
                        window.uiToast(msg, 'error');
                      } else {
                        console.warn('Ошибка создания задачи:', msg);
                      }
                    }
                  }
                } catch (err) {
                  if (window.uiToast) {
                    window.uiToast('Ошибка при создании задачи: ' + err.message, 'error');
                  } else {
                    console.error('Ошибка при создании задачи:', err);
                  }
                }
              });
            }
          } catch (err) {
            alert('Ошибка загрузки формы: ' + err.message);
          }
        });
      });
    })();
  </script>

  <!-- Модальное окно для выбора периода -->
  <div id="dateFilterModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-date-filter></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg">
      <div class="bg-white border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Выберите период</h2>
          <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-date-filter aria-label="Закрыть" title="Закрыть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        
        <div class="space-y-4">
          <!-- Быстрые кнопки -->
          <div class="grid grid-cols-2 gap-2">
            <button type="button" class="btn btn-outline text-sm date-quick-btn" data-period="today">Сегодня</button>
            <button type="button" class="btn btn-outline text-sm date-quick-btn" data-period="week">Неделя</button>
            <button type="button" class="btn btn-outline text-sm date-quick-btn" data-period="month">Месяц</button>
            <button type="button" class="btn btn-outline text-sm date-quick-btn" data-period="year">Год</button>
          </div>
          
          <div class="border-t pt-4">
            <div class="text-sm text-brand-dark/70 mb-2">Или выберите конкретные даты:</div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">С</label>
                <input type="date" id="dateFromPicker" class="input" value="{{ date_from|default:'' }}" />
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">По</label>
                <input type="date" id="dateToPicker" class="input" value="{{ date_to|default:'' }}" />
              </div>
            </div>
          </div>
          
          <div class="flex gap-2 pt-2 border-t">
            <button type="button" class="btn btn-primary flex-1" id="applyDateFilter">Применить</button>
            <button type="button" class="btn btn-outline" id="clearDateFilter">Очистить</button>
            <button type="button" class="btn btn-outline" data-close-date-filter>Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const modal = document.getElementById('dateFilterModal');
      const btn = document.getElementById('dateFilterBtn');
      const dateFromInput = document.getElementById('dateFromInput');
      const dateToInput = document.getElementById('dateToInput');
      const dateFromPicker = document.getElementById('dateFromPicker');
      const dateToPicker = document.getElementById('dateToPicker');
      const applyBtn = document.getElementById('applyDateFilter');
      const clearBtn = document.getElementById('clearDateFilter');
      if (!modal || !btn || !dateFromInput || !dateToInput || !dateFromPicker || !dateToPicker) return;

      // Закрытие модалки
      function closeModal() {
        modal.classList.add('hidden');
      }
      modal.querySelectorAll('[data-close-date-filter]').forEach(b => {
        b.addEventListener('click', closeModal);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
      });

      // Открытие модалки
      btn.addEventListener('click', () => {
        modal.classList.remove('hidden');
      });

      // Быстрые кнопки
      document.querySelectorAll('.date-quick-btn').forEach(b => {
        b.addEventListener('click', function() {
          const period = this.dataset.period;
          const today = new Date();
          let fromDate, toDate;
          
          if (period === 'today') {
            fromDate = toDate = new Date(today);
          } else if (period === 'week') {
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Понедельник
            fromDate = new Date(today);
            fromDate.setDate(diff);
            toDate = new Date(fromDate);
            toDate.setDate(toDate.getDate() + 6);
          } else if (period === 'month') {
            fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
            toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          } else if (period === 'year') {
            fromDate = new Date(today.getFullYear(), 0, 1);
            toDate = new Date(today.getFullYear(), 11, 31);
          }
          
          if (fromDate && toDate) {
            dateFromPicker.value = fromDate.toISOString().split('T')[0];
            dateToPicker.value = toDate.toISOString().split('T')[0];
          }
        });
      });

      // Применение фильтра
      applyBtn.addEventListener('click', () => {
        dateFromInput.value = dateFromPicker.value || '';
        dateToInput.value = dateToPicker.value || '';
        document.getElementById('taskFilterForm').submit();
      });

      // Очистка фильтра
      clearBtn.addEventListener('click', () => {
        dateFromPicker.value = '';
        dateToPicker.value = '';
        dateFromInput.value = '';
        dateToInput.value = '';
        document.getElementById('taskFilterForm').submit();
      });
    })();
  </script>

  <script>
    // Запоминание фильтров задач (localStorage, per-user). Восстановление только при заходе на /tasks/ без querystring.
    (function() {
      const form = document.getElementById('taskFilterForm');
      const rememberCb = document.getElementById('rememberTaskFilters');
      const resetBtn = document.getElementById('taskFilterResetBtn');
      if (!form || !rememberCb) return;

      const userId = (form.dataset && form.dataset.userId) ? String(form.dataset.userId) : 'anon';
      // Ключи с userId, чтобы после перелогина не подтягивались чужие фильтры
      const LS_PREF_KEY = `proficrm:${userId}:tasks:remember_filters`;
      const LS_QS_KEY = `proficrm:${userId}:tasks:filters_qs`;
      const SS_RESTORED_KEY = `proficrm:${userId}:tasks:restored_once`;

      function setPref(v) {
        try { localStorage.setItem(LS_PREF_KEY, v ? '1' : '0'); } catch (e) {}
      }
      function getPref() {
        try { return localStorage.getItem(LS_PREF_KEY) === '1'; } catch (e) { return false; }
      }
      function setSavedQs(qs) {
        try {
          if (!qs) localStorage.removeItem(LS_QS_KEY);
          else localStorage.setItem(LS_QS_KEY, qs);
        } catch (e) {}
      }
      function getSavedQs() {
        try { return localStorage.getItem(LS_QS_KEY) || ''; } catch (e) { return ''; }
      }

      function buildQsFromForm() {
        const fd = new FormData(form);
        const params = new URLSearchParams();
        for (const [k, v] of fd.entries()) {
          if (v === undefined || v === null) continue;
          const s = String(v);
          if (!s) continue;
          if (k === 'page') continue; // всегда возвращаемся на 1 страницу
          params.append(k, s);
        }
        // sort/dir/per_page могут быть в qs через пагинацию/шапку; если пользователь сейчас на странице с ними, они будут в fd? (обычно нет)
        // Поэтому дополнительно берём их из URL текущей страницы.
        const current = new URLSearchParams(window.location.search || '');
        ['sort', 'dir', 'per_page'].forEach(key => {
          const val = current.get(key);
          if (val && !params.has(key)) params.set(key, val);
        });
        return params.toString();
      }

      // Инициализация чекбокса
      rememberCb.checked = getPref();
      rememberCb.addEventListener('change', () => {
        setPref(rememberCb.checked);
        if (!rememberCb.checked) setSavedQs('');
      });

      // Сохранение при применении фильтров
      form.addEventListener('submit', () => {
        if (!rememberCb.checked) return;
        const qs = buildQsFromForm();
        setSavedQs(qs);
      });

      // Сброс должен очищать сохранённое, иначе оно тут же восстановится на чистом /tasks/
      if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
          e.preventDefault();
          // Жёсткий сброс: очищаем сохранённое и выключаем режим запоминания
          setSavedQs('');
          rememberCb.checked = false;
          setPref(false);
          window.location.href = '/tasks/';
        });
      }

      // Автовосстановление при заходе на /tasks/ без querystring
      (function restoreOnLoad() {
        if (!rememberCb.checked) return;
        if (window.location.search && window.location.search.length > 1) return;
        const saved = getSavedQs();
        if (!saved) return;
        // Защита от петли/дребезга: 1 раз на вкладку
        try {
          if (sessionStorage.getItem(SS_RESTORED_KEY) === '1') return;
          sessionStorage.setItem(SS_RESTORED_KEY, '1');
        } catch (e) {}
        window.location.replace('/tasks/?' + saved);
      })();
    })();
  </script>

  <!-- Модальное окно для подтверждения удаления задачи с переносом в заметки -->
  <div id="taskDeleteModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-delete-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-md">
      <div class="bg-white border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Удалить задачу?</h2>
          <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-delete-modal aria-label="Закрыть" title="Закрыть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <p class="text-sm text-brand-dark/70">Нужно ли перенести данные задачи в заметки?</p>
          <div class="flex gap-2 pt-2 border-t">
            <button type="button" class="btn btn-primary flex-1" id="taskDeleteWithNote">Да, перенести</button>
            <button type="button" class="btn btn-outline flex-1" id="taskDeleteWithoutNote">Нет, удалить</button>
            <button type="button" class="btn btn-outline" data-close-task-delete-modal>Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для подтверждения выполнения задачи с переносом в заметки -->
  <div id="taskCompleteModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-complete-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-md">
      <div class="bg-white border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Отметить задачу как выполненную?</h2>
          <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-complete-modal aria-label="Закрыть" title="Закрыть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <p class="text-sm text-brand-dark/70">Нужно ли перенести данные задачи в заметки?</p>
          <div class="flex gap-2 pt-2 border-t">
            <button type="button" class="btn btn-primary flex-1" id="taskCompleteWithNote">Да, перенести</button>
            <button type="button" class="btn btn-outline flex-1" id="taskCompleteWithoutNote">Нет, только выполнить</button>
            <button type="button" class="btn btn-outline" data-close-task-complete-modal>Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      let currentTaskId = null;
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

      // Модальное окно удаления задачи
      const deleteModal = document.getElementById('taskDeleteModal');
      const deleteBtns = document.querySelectorAll('[data-task-delete]');
      
      deleteBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          currentTaskId = this.dataset.taskId;
          deleteModal.classList.remove('hidden');
        });
      });

      function closeDeleteModal() {
        deleteModal.classList.add('hidden');
        currentTaskId = null;
      }

      deleteModal.querySelectorAll('[data-close-task-delete-modal]').forEach(b => {
        b.addEventListener('click', closeDeleteModal);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !deleteModal.classList.contains('hidden')) closeDeleteModal();
      });
      deleteModal.querySelector('.bg-black\\/35')?.addEventListener('click', function(e) {
        if (e.target === this) closeDeleteModal();
      });

      document.getElementById('taskDeleteWithNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('save_to_notes', '1');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/delete/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при удалении задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      document.getElementById('taskDeleteWithoutNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('save_to_notes', '0');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/delete/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при удалении задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      // Модальное окно выполнения задачи
      const completeModal = document.getElementById('taskCompleteModal');
      const completeBtns = document.querySelectorAll('[data-task-complete]');
      
      completeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          currentTaskId = this.dataset.taskId;
          completeModal.classList.remove('hidden');
        });
      });

      function closeCompleteModal() {
        completeModal.classList.add('hidden');
        currentTaskId = null;
      }

      completeModal.querySelectorAll('[data-close-task-complete-modal]').forEach(b => {
        b.addEventListener('click', closeCompleteModal);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !completeModal.classList.contains('hidden')) closeCompleteModal();
      });
      completeModal.querySelector('.bg-black\\/35')?.addEventListener('click', function(e) {
        if (e.target === this) closeCompleteModal();
      });

      document.getElementById('taskCompleteWithNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('status', 'done');
        formData.append('save_to_notes', '1');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/status/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при изменении статуса задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      document.getElementById('taskCompleteWithoutNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('status', 'done');
        formData.append('save_to_notes', '0');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/status/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при изменении статуса задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });
    })();
  </script>
{% endblock %}


