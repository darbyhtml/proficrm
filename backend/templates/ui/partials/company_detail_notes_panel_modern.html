<div class="card card-pad">
  <div class="flex items-center justify-between mb-3">
    <div class="font-medium text-lg">–ó–∞–º–µ—Ç–∫–∏</div>
    {% if can_edit_company %}
      <button type="button" class="btn btn-primary btn-sm" onclick="document.querySelector('#noteFormModernInline textarea[name=&quot;text&quot;]')?.focus();">
        + –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
      </button>
    {% endif %}
  </div>

  {% if can_edit_company %}
    <div class="mb-4">
      <!-- –®–∞–±–ª–æ–Ω—ã –∑–∞–º–µ—Ç–æ–∫ -->
      <div class="flex flex-wrap gap-2 mb-2" id="noteTemplatesModern">
        <button type="button" class="btn btn-outline btn-xs note-template-btn" data-template="important">‚≠ê –í–∞–∂–Ω–æ</button>
        <button type="button" class="btn btn-outline btn-xs note-template-btn" data-template="callback">üìû –ü–µ—Ä–µ–∑–≤–æ–Ω</button>
        <button type="button" class="btn btn-outline btn-xs note-template-btn" data-template="quote">üí∞ –ö–ü/—Å—á—ë—Ç</button>
        <button type="button" class="btn btn-outline btn-xs note-template-btn" data-template="reject">‚ùå –û—Ç–∫–∞–∑/–ø—Ä–∏—á–∏–Ω–∞</button>
      </div>
      <form class="space-y-2" method="post" action="/companies/{{ company.id }}/notes/add/" enctype="multipart/form-data" id="noteFormModernInline" data-company-id="{{ company.id }}" data-user-id="{{ request.user.id }}">
        {% csrf_token %}
        <input id="noteFileModernInline" type="file" name="attachment" class="hidden" />
        <input id="noteFilesMultipleModernInline" type="file" name="attachments" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp,.txt,.csv" />
        <div class="note-input-bar note-files-zone flex items-end gap-1 rounded-xl border border-brand-soft bg-white px-2 py-1.5 min-h-[52px] focus-within:ring-2 focus-within:ring-brand-teal/30 focus-within:border-brand-teal/50 transition-colors">
          <div class="flex-1 min-w-0">
            {{ note_form.text }}
          </div>
          <label for="noteFilesMultipleModernInline" class="flex-shrink-0 p-2 rounded-lg text-brand-dark/60 hover:text-brand-teal hover:bg-brand-soft/40 cursor-pointer transition-colors" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã (PDF, DOC, XLS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –î–æ 15 –ú–ë, –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤)" aria-label="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.5-8.5l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          </label>
          <button type="submit" class="btn btn-primary btn-sm flex-shrink-0 py-2 px-3" title="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="noteAddFileChipsModernInline" class="flex flex-wrap gap-2"></div>
      </form>
    </div>
  {% endif %}

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫ -->
  <div id="notes-modern-content" class="space-y-3">
    {% for n in notes %}
      <div class="relative group rounded-lg border p-3 bg-white/80 hover:bg-white transition-colors" data-note-item>
        <div class="flex items-start justify-between gap-3">
          <div class="text-xs text-brand-dark/70 mb-1">
            {{ n.created_at }} ¬∑ {{ n.author|default:"‚Äî" }}
            {% if n.is_pinned %}¬∑ <span class="inline-flex items-center gap-1 badge badge-warn badge-sm">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 17v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span>–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ</span>
            </span>{% endif %}
            {% if n.edited_at %}¬∑ <span class="muted-2">—Ä–µ–¥. {{ n.edited_at|date:"d.m.Y" }}</span>{% endif %}
          </div>
          <div class="flex items-center gap-2 shrink-0">
            {% if can_edit_company %}
              <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/pin/" style="display:none">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline btn-sm" title="{% if n.is_pinned %}–û—Ç–∫—Ä–µ–ø–∏—Ç—å{% else %}–ó–∞–∫—Ä–µ–ø–∏—Ç—å{% endif %}" aria-label="{% if n.is_pinned %}–û—Ç–∫—Ä–µ–ø–∏—Ç—å{% else %}–ó–∞–∫—Ä–µ–ø–∏—Ç—å{% endif %}">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 17v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </form>
            {% endif %}
            {% if n.author_id == request.user.id or is_admin or is_group_manager or not n.author_id and company.responsible_id == request.user.id %}
              <button
                type="button"
                class="btn btn-outline btn-sm"
                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                data-note-edit
                data-note-id="{{ n.id }}"
                data-note-text="{{ n.text|default:'' }}"
                data-note-file="{{ n.attachment_name|default:'' }}"
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/delete/" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?');" style="display:inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline btn-sm btn-danger" title="–£–¥–∞–ª–∏—Ç—å" aria-label="–£–¥–∞–ª–∏—Ç—å">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </form>
            {% endif %}
          </div>
        </div>
        <div class="text-sm whitespace-pre-line wrap-anywhere" data-note-body>{{ n.text }}</div>
        {% if n.attachment or n.note_attachments.all %}
          <div class="mt-2 flex flex-wrap gap-2">
            {% if n.attachment %}
              <div class="note-file-chip">
                <span class="truncate max-w-[140px]">{{ n.attachment_name|default:"–§–∞–π–ª" }}</span>
                <span class="text-brand-dark/50 text-xs">{{ n.attachment_size|filesizeformat }}</span>
                {% with ext=n.attachment_ext|upper %}
                  {% if ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                    <button type="button" class="note-file-link text-xs js-image-open" data-img-url="/companies/{{ company.id }}/notes/{{ n.id }}/file/open/" data-img-download="/companies/{{ company.id }}/notes/{{ n.id }}/file/download/" data-img-title="{{ n.attachment_name|default:'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                  {% else %}
                    <a class="note-file-link text-xs" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/open/">–û—Ç–∫—Ä—ã—Ç—å</a>
                  {% endif %}
                {% endwith %}
                <a class="note-file-link text-xs" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/download/">–°–∫–∞—á–∞—Ç—å</a>
              </div>
            {% endif %}
            {% for att in n.note_attachments.all %}
              <div class="note-file-chip">
                <span class="truncate max-w-[140px]">{{ att.file_name|default:"–§–∞–π–ª" }}</span>
                <span class="text-brand-dark/50 text-xs">{{ att.file_size|filesizeformat }}</span>
                <a class="note-file-link text-xs" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/attachments/{{ att.id }}/open/">–û—Ç–∫—Ä—ã—Ç—å</a>
                <a class="note-file-link text-xs" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/attachments/{{ att.id }}/download/">–°–∫–∞—á–∞—Ç—å</a>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% empty %}
      <div class="text-sm text-brand-dark/50 italic py-4 text-center">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>
    {% endfor %}
  </div>
</div>
