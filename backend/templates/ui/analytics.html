{% extends "ui/base.html" %}
{% block title %}Аналитика — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold">Аналитика</h1>
        <div class="text-sm text-brand-dark/70">
          Период: <b>{% if period == "month" %}Месяц{% else %}День{% endif %}</b> · {{ period_label }}
        </div>
      </div>
      <div class="flex gap-2">
        <a class="btn btn-outline" href="/analytics/?period=day">День</a>
        <a class="btn btn-outline" href="/analytics/?period=month">Месяц</a>
      </div>
    </div>

    {% for g in groups %}
      <section class="card card-pad">
        <div class="flex items-center justify-between gap-3">
          <div class="font-medium">
            {% if g.branch %}Филиал: {{ g.branch.name }}{% else %}Без филиала{% endif %}
          </div>
          <div class="text-xs muted-2">Показаны звонки (до 5000 записей на период) + подтверждённые холодные</div>
        </div>

        <div class="mt-3 overflow-x-auto">
          <table class="table w-full">
            <thead>
              <tr>
                <th>Сотрудник</th>
                <th class="text-right">Звонков</th>
                <th class="text-right">Холодных (подтв.)</th>
                <th class="text-right">Отметок «холодный»</th>
                <th>Детали</th>
              </tr>
            </thead>
            <tbody>
              {% for r in g.rows %}
                <tr>
                  <td class="whitespace-nowrap">{{ r.user }}</td>
                  <td class="text-right">{{ r.calls_total }}</td>
                  <td class="text-right">{{ r.cold_calls }}</td>
                  <td class="text-right">{{ r.cold_marks }}</td>
                  <td class="min-w-[240px]">
                    <details>
                      <summary class="link">Показать звонки</summary>
                      <div class="mt-2 space-y-1 text-sm">
                        {% for call in r.calls %}
                          <div class="flex flex-wrap items-center gap-2">
                            <span class="font-mono text-xs">{{ call.created_at|date:"d.m.Y H:i:s" }}</span>
                            <span class="font-mono text-xs">{{ call.phone_raw }}</span>
                            {% if call.is_cold_call %}
                              <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Холодный</span>
                            {% endif %}
                            {% if call.contact %}
                              <span class="muted-2">· {{ call.contact }}</span>
                            {% endif %}
                            {% if call.company %}
                              <a class="link" href="/companies/{{ call.company.id }}/">({{ call.company.name }})</a>
                            {% endif %}
                          </div>
                        {% empty %}
                          <div class="muted-2">Нет звонков за период.</div>
                        {% endfor %}
                      </div>
                    </details>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    {% empty %}
      <div class="card card-pad">Нет данных.</div>
    {% endfor %}
  </div>
{% endblock %}


