{% extends "ui/base.html" %}
{% load ui_extras %}
{% block title %}Диалоги — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="messenger-conversations-layout">
    <div class="flex items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Диалоги</h1>
        <div class="text-sm text-brand-dark/70">
          Фильтры: статус / филиал / оператор / регион
          {% if page.paginator.count is not None %}
            <span class="ml-2 font-medium text-brand-dark">· Найдено: {{ page.paginator.count }}</span>
          {% endif %}
        </div>
      </div>
    </div>

    <style>
      .messenger-conversations-layout > .messenger-conversations-layout-block + .messenger-conversations-layout-block {
        margin-top: 1.75rem;
      }
    </style>

    <form class="bg-white border border-brand-soft/60 rounded-2xl px-3 py-2.5 flex flex-wrap items-center gap-x-4 gap-y-2 messenger-conversations-layout-block" method="get" id="conversationFilterForm">
      <div class="flex items-center gap-2 flex-shrink-0">
        <span class="flex items-center gap-1.5 text-brand-dark/50" title="Статус">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <select name="status" class="select text-sm py-1.5" style="min-width: 8rem">
            <option value="">Любой статус</option>
            <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Открыт</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>В ожидании</option>
            <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Решён</option>
            <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Закрыт</option>
          </select>
        </span>
        <span class="flex items-center gap-1.5 text-brand-dark/50" title="Филиал">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
          <select name="branch" class="select text-sm py-1.5" style="min-width: 10rem">
            <option value="">Любой филиал</option>
            {% for branch in branches %}
              <option value="{{ branch.id }}" {% if branch_id|default:'' == branch.id|stringformat:'s' %}selected{% endif %}>{{ branch.name }}</option>
            {% endfor %}
          </select>
        </span>
        <span class="flex items-center gap-1.5 text-brand-dark/50" title="Оператор">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
          <select name="assignee" class="select text-sm py-1.5" style="min-width: 10rem">
            <option value="">Любой оператор</option>
            {% for assignee in assignees %}
              <option value="{{ assignee.id }}" {% if assignee_id|default:'' == assignee.id|stringformat:'s' %}selected{% endif %}>{{ assignee }}</option>
            {% endfor %}
          </select>
        </span>
        <span class="flex items-center gap-1.5 text-brand-dark/50" title="Регион">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <select name="region" class="select text-sm py-1.5" style="min-width: 10rem">
            <option value="">Любой регион</option>
            {% for region in regions %}
              <option value="{{ region.id }}" {% if region_id|default:'' == region.id|stringformat:'s' %}selected{% endif %}>{{ region.name }}</option>
            {% endfor %}
          </select>
        </span>
      </div>
      <div class="flex items-center gap-2 flex-shrink-0 ml-auto">
        <select name="per_page" class="select text-sm py-1.5" style="min-width: 6rem">
          <option value="25" {% if per_page == 25 %}selected{% endif %}>25 на стр.</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50 на стр.</option>
          <option value="100" {% if per_page == 100 %}selected{% endif %}>100 на стр.</option>
          <option value="200" {% if per_page == 200 %}selected{% endif %}>200 на стр.</option>
        </select>
        <a class="btn btn-outline btn-sm py-1.5 px-2.5 text-sm" href="/messenger/conversations/">Сброс</a>
      </div>
    </form>

    <div class="card messenger-conversations-layout-block">
      <div class="card-pad">
        {% if page.object_list %}
          <table class="table">
            <thead>
              <tr>
                <th style="width: 1rem"></th>
                <th>
                  <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}sort=last_message_at&dir={% if sort == 'last_message_at' and dir == 'desc' %}asc{% else %}desc{% endif %}" class="link">
                    Последнее сообщение
                    {% if sort == 'last_message_at' %}
                      {% if dir == 'desc' %}↓{% else %}↑{% endif %}
                    {% endif %}
                  </a>
                </th>
                <th>Контакт</th>
                <th>Филиал</th>
                <th>Регион</th>
                <th>
                  <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}sort=status&dir={% if sort == 'status' and dir == 'desc' %}asc{% else %}desc{% endif %}" class="link">
                    Статус
                    {% if sort == 'status' %}
                      {% if dir == 'desc' %}↓{% else %}↑{% endif %}
                    {% endif %}
                  </a>
                </th>
                <th>Оператор</th>
                <th>
                  <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}sort=priority&dir={% if sort == 'priority' and dir == 'desc' %}asc{% else %}desc{% endif %}" class="link">
                    Приоритет
                    {% if sort == 'priority' %}
                      {% if dir == 'desc' %}↓{% else %}↑{% endif %}
                    {% endif %}
                  </a>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for conversation in page.object_list %}
                <tr class="cursor-pointer hover:bg-brand-soft/20" onclick="window.location.href='{% url 'messenger_conversation_detail' conversation.id %}'">
                  <td>
                    {% if conversation.status == 'open' %}
                      <span class="badge badge-new badge-xs">Новый</span>
                    {% elif conversation.status == 'pending' %}
                      <span class="badge badge-progress badge-xs">Ожидание</span>
                    {% elif conversation.status == 'resolved' %}
                      <span class="badge badge-done badge-xs">Решён</span>
                    {% elif conversation.status == 'closed' %}
                      <span class="badge badge-cancel badge-xs">Закрыт</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if conversation.last_message_at %}
                      {{ conversation.last_message_at|date:"d.m.Y H:i" }}
                    {% else %}
                      <span class="text-brand-dark/50">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="font-medium">{{ conversation.contact.name|default:conversation.contact.email|default:conversation.contact.phone|default:"Без имени" }}</div>
                    {% if conversation.contact.email %}
                      <div class="text-xs text-brand-dark/60">{{ conversation.contact.email }}</div>
                    {% endif %}
                  </td>
                  <td>{{ conversation.branch.name }}</td>
                  <td>
                    {% if conversation.region %}
                      {{ conversation.region.name }}
                    {% else %}
                      <span class="text-brand-dark/50">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if conversation.status == 'open' %}
                      <span class="badge badge-new">Открыт</span>
                    {% elif conversation.status == 'pending' %}
                      <span class="badge badge-progress">В ожидании</span>
                    {% elif conversation.status == 'resolved' %}
                      <span class="badge badge-done">Решён</span>
                    {% elif conversation.status == 'closed' %}
                      <span class="badge badge-cancel">Закрыт</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if conversation.assignee %}
                      {{ conversation.assignee }}
                    {% else %}
                      <span class="text-brand-dark/50">Не назначен</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if conversation.priority == 10 %}
                      <span class="badge badge-xs">Низкий</span>
                    {% elif conversation.priority == 20 %}
                      <span class="badge badge-xs">Обычный</span>
                    {% elif conversation.priority == 30 %}
                      <span class="badge badge-warn badge-xs">Высокий</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          {% if page.has_other_pages %}
            <div class="mt-4 flex items-center justify-between">
              <div class="text-sm text-brand-dark/70">
                Страница {{ page.number }} из {{ page.paginator.num_pages }}
              </div>
              <div class="flex items-center gap-2">
                {% if page.has_previous %}
                  <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page.previous_page_number }}" class="btn btn-outline btn-sm">← Назад</a>
                {% endif %}
                {% if page.has_next %}
                  <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page.next_page_number }}" class="btn btn-outline btn-sm">Вперёд →</a>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% else %}
          <div class="text-center py-8 text-brand-dark/60">
            <p class="text-lg mb-2">Диалоги не найдены</p>
            <p class="text-sm">Попробуйте изменить фильтры</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    // Автоматическое применение фильтров при изменении
    (function() {
      const form = document.getElementById('conversationFilterForm');
      if (!form) return;
      const selects = form.querySelectorAll('select');
      selects.forEach(select => {
        select.addEventListener('change', () => {
          form.submit();
        });
      });
    })();
  </script>
{% endblock %}
