{% extends "ui/base.html" %}
{% load ui_extras %}
{% block title %}{{ company.name }} — CRM ПРОФИ{% endblock %}

{% block content %}
  <style>
    .modern-tab-panel {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
    }
    .modern-tab-panel.modern-tab-panel-active {
      opacity: 1;
      transform: translateY(0);
    }
    /* Современные чипы вложений и зона прикрепления файлов */
    .note-file-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.8125rem;
      background: rgba(194, 226, 222, 0.25);
      border: 1px solid rgba(194, 226, 222, 0.7);
      color: var(--brand-dark);
    }
    .note-file-chip a, .note-file-chip .note-file-link { color: #01948E; text-decoration: none; }
    .note-file-chip a:hover, .note-file-chip .note-file-link:hover { text-decoration: underline; }
    .note-files-zone {
      border: 1px dashed rgba(1, 148, 142, 0.4);
      border-radius: 0.75rem;
      padding: 1rem;
      background: rgba(1, 148, 142, 0.04);
      transition: background 0.2s, border-color 0.2s;
    }
    .note-files-zone:hover { background: rgba(1, 148, 142, 0.08); border-color: rgba(1, 148, 142, 0.5); }
    .note-files-zone.has-files { border-style: solid; background: rgba(194, 226, 222, 0.15); }
    /* Строка ввода заметки (мессенджер-стиль): один контейнер с тенью, нижняя панель с иконками */
    .note-input-bar.note-files-zone {
      border: none;
      padding: 0;
      background: transparent;
    }
    .note-input-bar.note-files-zone.has-files { background: rgba(194, 226, 222, 0.08); }
    .note-input-bar .note-input-bar-field {
      min-height: 2.25rem;
      max-height: 12rem;
      resize: none;
      overflow-y: auto;
      border: none;
      background: transparent;
      box-shadow: none;
      font-size: 0.9375rem;
      line-height: 1.45;
    }
    .note-input-bar .note-input-bar-field::placeholder { color: #94a3b8; }
    .note-input-bar .note-input-bar-field:focus { outline: none; }

    /* Карточки вложений (компактные, по макету) */
    .note-attachment-cards { display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .note-attachment-card {
      position: relative;
      width: 4.5rem;
      flex-shrink: 0;
      background: #fff;
      border: 1px solid rgba(194, 226, 222, 0.8);
      border-radius: 0.5rem;
      overflow: hidden;
      cursor: pointer;
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    .note-attachment-card:hover { border-color: rgba(1, 148, 142, 0.5); box-shadow: 0 2px 8px rgba(0, 61, 56, 0.08); }
    .note-attachment-card__preview {
      width: 100%;
      height: 3.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(194, 226, 222, 0.15);
      overflow: hidden;
    }
    .note-attachment-card__preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .note-attachment-card__icon {
      width: 100%;
      height: 4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(194, 226, 222, 0.2);
      color: var(--brand-dark);
    }
    .note-attachment-card__icon svg { width: 2rem; height: 2rem; }
    .note-attachment-card__icon--pdf { color: #b91c1c; }
    .note-attachment-card__icon--doc { color: #1d4ed8; }
    .note-attachment-card__icon--xls { color: #15803d; }
    .note-attachment-card__icon--ppt { color: #c2410c; }
    .note-attachment-card__icon--img { color: #01948E; }
    .note-attachment-card__icon--file { color: #475569; }
    .note-attachment-card__name {
      padding: 0.3rem 0.35rem;
      font-size: 0.625rem;
      line-height: 1.2;
      color: var(--brand-dark);
      text-align: center;
      word-break: break-all;
      max-height: 2.4em;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .note-attachment-card--editable .note-attachment-card__delete {
      position: absolute;
      top: 0.15rem;
      right: 0.15rem;
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      background: rgba(0, 61, 56, 0.75);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      line-height: 1;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 2;
    }
    .note-attachment-card--editable:hover .note-attachment-card__delete { opacity: 1; }
    .note-attachment-card__delete:hover { background: #b91c1c; }
    .note-attachments-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; }
    .note-attachments-header .note-attachment-card { cursor: default; }

    /* Классический вид: бар заметок с рамкой и фоном (глобальные стили выше сбрасывают их) */
    #companyDetailClassic .note-input-bar.note-files-zone {
      border: 1px solid rgba(194, 226, 222, 0.8);
      padding: 0.5rem 0.75rem;
      background: #fff;
    }
    #companyDetailClassic .note-input-bar.note-files-zone.has-files {
      background: rgba(194, 226, 222, 0.12);
    }
    /* В модалке редактирования заметки — без рамки */
    #companyDetailClassic #noteEditModal .note-files-zone {
      border: none;
      padding: 0.25rem 0 0;
      background: transparent;
    }
    #companyDetailClassic #noteAddFileChips,
    #companyDetailClassic #noteEditExistingCards,
    #companyDetailClassic #noteEditNewFilesChips {
      gap: 0.5rem;
    }
  </style>
  <!-- Классический режим (текущий layout) -->
  <div id="companyDetailClassic" class="{% if detail_view_mode != 'classic' %}hidden{% endif %}">
  <div class="space-y-6">
    <!-- Первый блок: заголовок карточки в классическом режиме -->
    <div class="bg-white border-b border-brand-soft/50 rounded-2xl px-6 md:px-8 py-3 md:py-4 flex items-start justify-between gap-4">
      <div class="flex-1 min-w-0">
        <!-- Крошки + некликабельное название компании -->
        <div class="flex items-center justify-between gap-3 mb-2">
          <div class="text-xs text-brand-dark/60 truncate">
            <a class="underline hover:text-brand-teal" href="/companies/">Компании</a>
            <span class="mx-1">/</span>
            <span class="font-medium text-brand-dark/80 truncate">{{ company.name }}</span>
          </div>
        </div>

        <!-- Иконка компании + редактируемое название -->
        <div class="flex items-start gap-3">
          <div class="hidden sm:flex w-11 h-11 rounded-2xl bg-brand-soft/60 items-center justify-center text-brand-dark/70 shrink-0">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <rect x="4" y="3" width="16" height="18" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 8h8M8 12h5M8 16h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="min-w-0 space-y-1">
            {% if can_edit_company %}
              <div class="inline-field-wrapper w-full min-w-0" data-inline-field="name" data-company-id="{{ company.id }}">
                <div class="relative" data-dd-root>
                  <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                    <h1 class="text-2xl font-semibold inline-field-display min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.name }}</h1>
                    <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                  </div>
                  <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                  </div>
                </div>
                <div class="inline-field-edit hidden mt-2 w-full">
                  <input class="input w-full text-xl py-2 min-h-[2.75rem]" data-inline-input maxlength="255" value="{{ company.name|default:'' }}" placeholder="Название компании" />
                  <div class="flex gap-1 mt-2">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <h1 class="text-2xl font-semibold truncate">
                {{ company.name }}
              </h1>
            {% endif %}

            <!-- Реквизиты: ИНН / КПП / Область/регион -->
            <div class="text-xs text-brand-dark/70 mt-2 flex flex-wrap items-center gap-x-2 gap-y-1">
              {% if can_edit_company %}
                <span>ИНН:</span>
                <span class="inline-field-wrapper" data-inline-field="inn" data-company-id="{{ company.id }}">
                  <span class="relative inline-block" data-dd-root>
                    <span class="inline-field-trigger inline-field-trigger-inline group" data-dd-toggle title="Клик: скопировать или изменить">
                      <span class="font-mono inline-field-display">{{ company.inn|default:"—" }}</span>
                      <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                    </span>
                    <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                    </div>
                  </span>
                  <span class="inline-field-edit hidden ml-2 align-middle">
                    <input class="input" data-inline-input maxlength="255" value="{{ company.inn|default:'' }}" style="width:20rem" placeholder="Можно несколько: через /, запятую, пробел" />
                    <button type="button" class="btn btn-primary btn-xs ml-1" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-xs ml-1" data-inline-cancel>Отмена</button>
                    <span class="text-xs text-red-600 ml-2 hidden" data-inline-error></span>
                  </span>
                </span>

                <span class="mx-1 text-brand-soft/80">·</span>
                <span>КПП:</span>
                <span class="inline-field-wrapper" data-inline-field="kpp" data-company-id="{{ company.id }}">
                  <span class="relative inline-block" data-dd-root>
                    <span class="inline-field-trigger inline-field-trigger-inline group" data-dd-toggle title="Клик: скопировать или изменить">
                      <span class="font-mono inline-field-display">{{ company.kpp|default:"—" }}</span>
                      <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                    </span>
                    <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                    </div>
                  </span>
                  <span class="inline-field-edit hidden ml-2 align-middle">
                    <input class="input" data-inline-input maxlength="20" value="{{ company.kpp|default:'' }}" style="width:13.75rem" />
                    <button type="button" class="btn btn-primary btn-xs ml-1" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-xs ml-1" data-inline-cancel>Отмена</button>
                    <span class="text-xs text-red-600 ml-2 hidden" data-inline-error></span>
                  </span>
                </span>

                <span class="mx-1 text-brand-soft/80">·</span>
                <span>Область/регион:</span>
                {% if can_edit_company %}
                  <span class="inline-field-wrapper inline-block ml-1" data-inline-field="region" data-company-id="{{ company.id }}">
                    <span class="relative inline-block" data-dd-root>
                      <span class="inline-field-trigger inline-field-trigger-inline group" data-dd-toggle title="Клик: скопировать или изменить">
                        <span class="inline-field-display min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.region.name|default:"—" }}</span>
                        <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                      </span>
                      <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                      </div>
                    </span>
                    <span class="inline-field-edit hidden ml-2 align-middle">
                      {{ quick_form.region }}
                      <button type="button" class="btn btn-primary btn-sm hidden" data-inline-save>Сохранить</button>
                      <span class="text-xs text-red-600 ml-2 hidden" data-inline-error></span>
                    </span>
                  </span>
                {% else %}
                  <span class="font-mono">{{ company.region.name|default:"—" }}</span>
                {% endif %}
              {% else %}
                {% if company.inn %}ИНН: <span class="font-mono">{{ company.inn }}</span>{% endif %}
                {% if company.kpp %} <span class="mx-1">·</span> КПП: <span class="font-mono">{{ company.kpp }}</span>{% endif %}
                {% if company.region %} <span class="mx-1">·</span> Область/регион: <span class="font-mono">{{ company.region.name }}</span>{% endif %}
              {% endif %}
            </div>
          </div>
        </div>

        {% if delete_req %}
          {% if can_delete_company or can_request_delete %}
          <div class="mt-3 rounded-xl border border-brand-orange/60 bg-brand-orange/15 px-4 py-3 text-sm text-brand-dark">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-medium">Запрос на удаление</div>
                <div class="text-xs muted-2 mt-1">
                  От: <b>{{ delete_req.requested_by|default:"—" }}</b> · {{ delete_req.created_at }}
                </div>
                {% if delete_req.note %}
                  <div class="mt-2 whitespace-pre-line">{{ delete_req.note }}</div>
                {% endif %}
              </div>
              {% if can_delete_company %}
                <div class="flex flex-col gap-2 shrink-0">
                  <button type="button" class="btn btn-outline btn-sm" id="openCancelDeleteReqModal">Отменить запрос</button>
                  <form method="post" action="/companies/{{ company.id }}/delete-request/{{ delete_req.id }}/approve/" onsubmit="return confirm('Подтвердить удаление компании?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-sm btn-danger">Подтвердить удаление</button>
                  </form>
                </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        {% endif %}
        {% if pinned_note %}
          <div class="mt-3 rounded-xl border border-brand-orange/30 bg-white/95 shadow-sm overflow-hidden" style="border-left:4px solid var(--brand-orange);">
            <div class="px-4 py-3">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0 flex-1">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="badge badge-warn badge-sm">Закреплено</span>
                    <span class="text-xs text-brand-dark/60">{{ pinned_note.author|default:"—" }} · {{ pinned_note.created_at }}</span>
                  </div>
                  {% if pinned_note.text %}
                    <div id="pinnedNotePreview" class="mt-2 text-sm text-brand-dark/90 whitespace-pre-line">{{ pinned_note.text|truncatechars:220 }}</div>
                    <div id="pinnedNoteFull" class="mt-2 text-sm text-brand-dark/90 whitespace-pre-line hidden">{{ pinned_note.text }}</div>
                    <button type="button" id="pinnedNoteExpandBtn" class="mt-1.5 text-xs text-brand-teal hover:underline font-medium" data-expanded="0">Развернуть</button>
                  {% endif %}
                </div>
                {% if can_edit_company %}
                  <form method="post" action="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/pin/" class="shrink-0">
                    {% csrf_token %}
                    <button type="submit" class="p-2 rounded-lg text-brand-dark/50 hover:text-brand-dark hover:bg-brand-soft/30 transition-colors" title="Открепить" aria-label="Открепить">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z"/><path d="M12 17v5"/></svg>
                    </button>
                  </form>
                {% endif %}
              </div>
              {% if pinned_note.attachment or pinned_note.note_attachments.all %}
                <div class="mt-3 pt-3 border-t border-brand-soft/50 note-attachment-cards">
                  {% if pinned_note.attachment %}
                    {% url 'company_note_attachment_open' company.id pinned_note.id as pinned_main_open_url %}
                    {% url 'company_note_attachment_download' company.id pinned_note.id as pinned_main_download_url %}
                    {% with ext=pinned_note.attachment_ext|upper %}
                      {% if ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                        {% include "ui/partials/company_note_attachment_card.html" with open_url=pinned_main_open_url download_url=pinned_main_download_url filename=pinned_note.attachment_name|default:"Файл" size=pinned_note.attachment_size|filesizeformat ext=ext is_image=True editable=False %}
                      {% else %}
                        {% include "ui/partials/company_note_attachment_card.html" with open_url=pinned_main_open_url download_url=pinned_main_download_url filename=pinned_note.attachment_name|default:"Файл" size=pinned_note.attachment_size|filesizeformat ext=ext is_image=False editable=False %}
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                  {% for att in pinned_note.note_attachments.all %}
                    {% url 'company_note_attachment_by_id_open' company.id pinned_note.id att.id as pinned_extra_open_url %}
                    {% url 'company_note_attachment_by_id_download' company.id pinned_note.id att.id as pinned_extra_download_url %}
                    {% with ext=att.file_ext|upper %}
                      {% if ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                        {% include "ui/partials/company_note_attachment_card.html" with open_url=pinned_extra_open_url download_url=pinned_extra_download_url filename=att.file_name size=att.file_size|filesizeformat ext=ext is_image=True editable=False %}
                      {% else %}
                        {% include "ui/partials/company_note_attachment_card.html" with open_url=pinned_extra_open_url download_url=pinned_extra_download_url filename=att.file_name size=att.file_size|filesizeformat ext=ext is_image=False editable=False %}
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
          <script>
            (function(){
              var btn = document.getElementById('pinnedNoteExpandBtn');
              var preview = document.getElementById('pinnedNotePreview');
              var full = document.getElementById('pinnedNoteFull');
              if (!btn || !full || !preview) return;
              if ((full.textContent || '').length <= 220) { btn.style.display = 'none'; return; }
              btn.addEventListener('click', function(){
                var exp = btn.getAttribute('data-expanded') === '1';
                if (exp) {
                  full.classList.add('hidden');
                  preview.classList.remove('hidden');
                  btn.textContent = 'Развернуть';
                  btn.setAttribute('data-expanded', '0');
                } else {
                  preview.classList.add('hidden');
                  full.classList.remove('hidden');
                  btn.textContent = 'Свернуть';
                  btn.setAttribute('data-expanded', '1');
                }
              });
            })();
          </script>
        {% endif %}
        {% if can_edit_company %}
          <div class="mt-2">
            <!-- Дополнительный отступ под закреплённой заметкой и предупреждением об удалении -->
          </div>
        {% endif %}
      </div>

      <!-- Правая колонка: переключатель вида + действия -->
      <div class="flex flex-col items-end gap-3 shrink-0">
        <!-- Переключатель режимов просмотра (иконки) -->
        <div class="flex items-center gap-1 bg-brand-soft/30 rounded-lg p-1" role="group" aria-label="Режим просмотра карточки">
          <button type="button" id="viewModeClassicDetail" class="view-mode-detail-btn p-2 rounded-md transition-colors {% if detail_view_mode == 'classic' %}bg-white text-brand-teal shadow-sm{% else %}text-brand-dark/70 hover:text-brand-dark{% endif %}" data-mode="classic" title="Классический вид" aria-label="Классический вид">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </button>
          <button type="button" id="viewModeModernDetail" class="view-mode-detail-btn p-2 rounded-md transition-colors {% if detail_view_mode == 'modern' %}bg-white text-brand-teal shadow-sm{% else %}text-brand-dark/70 hover:text-brand-dark{% endif %}" data-mode="modern" title="Современный вид" aria-label="Современный вид">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
          </button>
        </div>

        <!-- Ключевые действия с компанией -->
        <div class="flex flex-wrap justify-end gap-2 text-xs">
          {% if can_edit_company %}
            <a class="btn btn-outline btn-sm" href="/companies/{{ company.id }}/edit/">Редактировать данные</a>
          {% endif %}

          {% if can_delete_company %}
            <button type="button" class="btn btn-outline btn-sm btn-danger" id="openDeleteCompanyModal">Удалить компанию</button>
          {% elif can_request_delete %}
            <button type="button" class="btn btn-outline btn-sm btn-danger" id="openDeleteRequestModal">
              {% if delete_req %}Отменить запрос на удаление{% else %}Запросить удаление{% endif %}
            </button>
          {% endif %}

          <!-- Копирование ссылки на карточку -->
          <button type="button" class="btn btn-outline btn-sm" data-copy-text="{{ request.build_absolute_uri }}" title="Копировать ссылку" aria-label="Копировать ссылку">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
          </button>

          <!-- Поиск по карточке: переключаемся в современный вид и открываем поиск -->
          <button type="button" class="btn btn-outline btn-sm" id="quickSearchBtnClassic" title="Поиск по карточке" aria-label="Поиск по карточке">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </button>
        </div>

        <!-- Служебная информация -->
        <div class="text-[11px] text-brand-dark/60 text-right mt-1 space-y-0.5">
          <div><span class="text-brand-dark/50">Ответственный:</span> {{ company.responsible }}</div>
          <div><span class="text-brand-dark/50">Филиал:</span> {{ company.branch }}</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-2">
      <section class="card card-pad lg:col-span-2">
        <div class="font-medium mb-3">Данные</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <div class="md:col-span-2">
            <div class="text-brand-dark/50">Организация</div>
            <div class="flex flex-wrap items-center gap-2">
              {% if org_head %}
                {% if org_head.id == company.id %}
                  <span class="badge">Головная</span>
                  <div class="font-medium">{{ org_head.name }}</div>
                {% else %}
                  <span class="badge">Филиал</span>
                  <a class="link font-medium" href="/companies/{{ org_head.id }}/">{{ org_head.name }}</a>
                {% endif %}
              {% else %}
                <span class="text-brand-dark/70">—</span>
              {% endif %}
              {% if org_branches %}
                <span class="muted-2 text-xs">· филиалов: {{ org_branches|length }}</span>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Юр. название</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="legal_name" data-company-id="{{ company.id }}">
                <div class="relative" data-dd-root>
                  <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                    <div class="inline-field-display min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.legal_name|default:"—" }}</div>
                    <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                  </div>
                  <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                  </div>
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <input class="input w-full" data-inline-input maxlength="255" value="{{ company.legal_name|default:'' }}" />
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div>{{ company.legal_name|default:"—" }}</div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Сайт</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="website" data-company-id="{{ company.id }}" data-inline-display-kind="website">
                <div class="relative" data-dd-root>
                  <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                    <div class="inline-field-display flex items-center gap-2 min-w-0" data-inline-display>
                      {% if company.website %}
                        {% if "://" in company.website %}
                          <span class="link break-all">{{ company.website }}</span>
                        {% elif company.website|slice:":2" == "//" %}
                          <span class="link break-all">{{ company.website }}</span>
                        {% else %}
                          <span class="link break-all">{{ company.website }}</span>
                        {% endif %}
                      {% else %}
                        <span class="text-brand-dark/70" data-inline-website-empty>—</span>
                      {% endif %}
                    </div>
                    <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                  </div>
                  <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 w-full" data-open-website>Открыть ссылку</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit title="Редактировать сайт">Изменить</button>
                  </div>
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <input class="input w-full" data-inline-input maxlength="255" value="{{ company.website|default:'' }}" placeholder="https://example.com" />
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div class="max-w-full">
                {% if company.website %}
                  {% if "://" in company.website %}
                    <a class="link break-all" href="{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                  {% elif company.website|slice:":2" == "//" %}
                    <a class="link break-all" href="https:{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                  {% else %}
                    <a class="link break-all" href="https://{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Вид деятельности</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="activity_kind" data-company-id="{{ company.id }}" data-inline-display-kind="multiline">
                <div class="relative" data-dd-root>
                  <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                    <div class="inline-field-display whitespace-pre-line min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.activity_kind|default:"—" }}</div>
                    <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                  </div>
                  <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                  </div>
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <textarea class="input w-full" data-inline-input rows="3" maxlength="255" style="min-height:88px;resize:vertical">{{ company.activity_kind|default:'' }}</textarea>
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div class="whitespace-pre-line">{{ company.activity_kind|default:"—" }}</div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Численность сотрудников</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="employees_count" data-company-id="{{ company.id }}">
                <div class="relative" data-dd-root>
                  <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                    <div class="inline-field-display min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.employees_count|default:"—" }}</div>
                    <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                  </div>
                  <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                  </div>
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <input class="input w-full" type="number" min="0" data-inline-input value="{{ company.employees_count|default:'' }}" placeholder="Напр.: 120" />
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div>{{ company.employees_count|default:"—" }}</div>
            {% endif %}
          </div>
          {# "Рабочее время" убрано: дублировало "Режим работы" #}
          <div>
            <div class="text-brand-dark/50">Часовой пояс</div>
            {# приоритет: сохранённый вручную, затем авто по адресу #}
            {% with guessed=company.address|guess_ru_tz %}
            {% with tz=company.work_timezone|default:guessed %}
              {% if can_edit_company %}
                <div class="inline-field-wrapper" data-inline-field="work_timezone" data-company-id="{{ company.id }}" data-inline-display-kind="timezone">
                  <div class="inline-field-display cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit>
                    {% if tz %}
                      <span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1">
                        <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                        · {{ tz|tz_label }}
                      </span>
                    {% else %}
                      —
                    {% endif %}
                  </div>
                  <div class="inline-field-edit hidden mt-1">
                    <select class="select w-full" data-inline-input>
                      <option value="" {% if not company.work_timezone %}selected{% endif %}>Авто (по адресу)</option>
                      <option value="Europe/Kaliningrad" {% if company.work_timezone == "Europe/Kaliningrad" %}selected{% endif %}>Калининград (UTC+02)</option>
                      <option value="Europe/Moscow" {% if company.work_timezone == "Europe/Moscow" %}selected{% endif %}>Москва / СПБ (UTC+03)</option>
                      <option value="Europe/Samara" {% if company.work_timezone == "Europe/Samara" %}selected{% endif %}>Самара (UTC+04)</option>
                      <option value="Asia/Yekaterinburg" {% if company.work_timezone == "Asia/Yekaterinburg" %}selected{% endif %}>Екатеринбург / Тюмень (UTC+05)</option>
                      <option value="Asia/Omsk" {% if company.work_timezone == "Asia/Omsk" %}selected{% endif %}>Омск (UTC+06)</option>
                      <option value="Asia/Novosibirsk" {% if company.work_timezone == "Asia/Novosibirsk" %}selected{% endif %}>Новосибирск (UTC+07)</option>
                      <option value="Asia/Krasnoyarsk" {% if company.work_timezone == "Asia/Krasnoyarsk" %}selected{% endif %}>Красноярск (UTC+07)</option>
                      <option value="Asia/Irkutsk" {% if company.work_timezone == "Asia/Irkutsk" %}selected{% endif %}>Иркутск (UTC+08)</option>
                      <option value="Asia/Yakutsk" {% if company.work_timezone == "Asia/Yakutsk" %}selected{% endif %}>Якутск (UTC+09)</option>
                      <option value="Asia/Vladivostok" {% if company.work_timezone == "Asia/Vladivostok" %}selected{% endif %}>Владивосток (UTC+10)</option>
                      <option value="Asia/Sakhalin" {% if company.work_timezone == "Asia/Sakhalin" %}selected{% endif %}>Сахалин (UTC+11)</option>
                      <option value="Asia/Magadan" {% if company.work_timezone == "Asia/Magadan" %}selected{% endif %}>Магадан (UTC+11)</option>
                      <option value="Asia/Kamchatka" {% if company.work_timezone == "Asia/Kamchatka" %}selected{% endif %}>Камчатка (UTC+12)</option>
                    </select>
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                  </div>
                </div>
              {% else %}
                {% if tz %}
                  <div>
                    <span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1">
                      <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                      · {{ tz|tz_label }}
                    </span>
                  </div>
                {% else %}
                  —
                {% endif %}
              {% endif %}
            {% endwith %}
            {% endwith %}
          </div>
          <div>
            <div class="text-brand-dark/50">Режим работы</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="work_schedule" data-company-id="{{ company.id }}" data-inline-display-kind="multiline">
                <div class="relative" data-dd-root>
                  <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                    <div class="inline-field-display whitespace-pre-line font-mono text-xs min-w-0 hover:text-brand-dark/80 transition-colors" data-work-schedule-display="1" data-company-id="{{ company.id }}">{{ company.work_schedule|default:"—" }}</div>
                    <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                  </div>
                  <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                  </div>
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <textarea class="input w-full font-mono text-xs" data-inline-input rows="5" style="min-height:6rem;resize:vertical">{{ company.work_schedule|default:'' }}</textarea>
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="muted-2 mt-1" style="font-size:0.6875rem;">Можно вставить как с сайта (любой формат) — при сохранении приведётся к виду «Пн–Пт: 09:00–18:00».</div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div class="whitespace-pre-line font-mono text-xs" data-work-schedule-display="1" data-company-id="{{ company.id }}">{{ company.work_schedule|default:"—" }}</div>
            {% endif %}
          </div>
          {% if not contacts %}
          <div>
            <div class="text-brand-dark/50">Руководитель</div>
            <div>{{ company.contact_name|default:"—" }}</div>
          </div>
          {% endif %}
          <div class="{% if contract_alert == 'danger' %}rounded-xl border border-red-400/40 bg-red-500/5 p-2 -m-2{% elif contract_alert == 'warn' %}rounded-xl border border-brand-orange/50 bg-brand-orange/10 p-2 -m-2{% endif %}">
            <div class="text-brand-dark/50 flex items-center gap-2">
              <span>Договор</span>
              {% if contract_alert == 'danger' %}
                <span class="badge badge-danger badge-sm">Срочно</span>
              {% elif contract_alert == 'warn' %}
                <span class="badge badge-warn badge-sm">Напоминание</span>
              {% endif %}
            </div>
            {% if can_edit_company %}
            <div class="relative mt-1" data-dd-root>
              <div class="inline-field-trigger group flex items-start justify-between gap-2 cursor-pointer rounded-lg hover:bg-brand-soft/20 -mx-1 px-1 py-0.5" data-dd-toggle title="Клик: скопировать или изменить">
                <div class="text-sm min-w-0" data-contract-display>
                  {% if company.contract_type %}{{ company.contract_type.name }}{% else %}—{% endif %}
                  {% if company.contract_type.is_annual %}
                    {% if company.contract_amount is not None %}
                      <span class="muted-2">· сумма: {{ company.contract_amount|floatformat:2 }} ₽</span>
                      {% if company.contract_amount < 25000 %}
                        <span class="badge badge-danger badge-sm ml-1">Меньше 25 000</span>
                      {% elif company.contract_amount < 70000 %}
                        <span class="badge badge-warn badge-sm ml-1">Меньше 70 000</span>
                      {% endif %}
                    {% else %}
                      <span class="muted-2">· сумма не указана</span>
                    {% endif %}
                  {% else %}
                    {% if company.contract_until %}
                      <span class="muted-2">· до {{ company.contract_until|date:"d.m.Y" }}</span>
                      {% if contract_days_left is not None %}
                        <span class="muted-2">· осталось {{ contract_days_left }} дн.</span>
                      {% endif %}
                    {% endif %}
                  {% endif %}
                </div>
                <svg class="inline-field-pencil shrink-0" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
              </div>
              <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-contract-copy>Скопировать</button>
                <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-open-contract-modal>Изменить</button>
              </div>
            </div>
            {% else %}
            <div class="text-sm mt-1">
              {% if company.contract_type %}{{ company.contract_type.name }}{% else %}—{% endif %}
              {% if company.contract_type.is_annual %}
                {% if company.contract_amount is not None %}
                  <span class="muted-2">· сумма: {{ company.contract_amount|floatformat:2 }} ₽</span>
                  {% if company.contract_amount < 25000 %}
                    <span class="badge badge-danger badge-sm ml-1">Меньше 25 000</span>
                  {% elif company.contract_amount < 70000 %}
                    <span class="badge badge-warn badge-sm ml-1">Меньше 70 000</span>
                  {% endif %}
                {% else %}
                  <span class="muted-2">· сумма не указана</span>
                {% endif %}
              {% else %}
                {% if company.contract_until %}
                  <span class="muted-2">· до {{ company.contract_until|date:"d.m.Y" }}</span>
                  {% if contract_days_left is not None %}
                    <span class="muted-2">· осталось {{ contract_days_left }} дн.</span>
                  {% endif %}
                {% endif %}
              {% endif %}
            </div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Телефон (основной)</div>
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="font-mono text-xs" data-company-main-phone-display>{{ company.phone|format_phone|default:"—" }}</div>
                {% with info=company.phone|phone_local_info %}
                  {% if info %}<div class="mt-1" data-company-main-phone-local><span class="badge badge-warn badge-xxxs">{{ info }}</span></div>{% endif %}
                {% endwith %}
                {% if not company.phone|phone_local_info %}
                  {% with guessed=company.address|guess_ru_tz %}
                  {% with tz=company.work_timezone|default:guessed %}
                    {% if tz %}<div class="mt-1"><span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1"><span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span> · {{ tz|tz_label }}</span></div>{% endif %}
                  {% endwith %}
                  {% endwith %}
                {% endif %}
                {% if can_edit_company %}
                  <div class="hidden mt-1" data-company-main-phone-edit>
                    <input class="input text-xs" data-company-main-phone-input value="{{ company.phone|default:'' }}" placeholder="+7..." style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:15rem" />
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-company-main-phone-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-company-main-phone-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-company-main-phone-error></div>
                  </div>
                {% endif %}
              </div>

              {% if company.phone %}
                <div class="relative shrink-0" data-dd-root>
                  <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                  <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-call-phone" data-phone="{{ company.phone }}" data-company="{{ company.id }}" data-contact="">Позвонить</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-copy-phone="{{ company.phone }}">Скопировать</button>

                    {% if can_edit_company %}
                      {# Важно: для AJAX-режима обе формы должны быть в DOM, иначе после отметки нечего показывать. #}
                      <form
                        method="post"
                        action="/companies/{{ company.id }}/cold-call/toggle/"
                        class="js-cold-call-form"
                        data-confirm="Вы действительно хотите отметить звонок как холодный?"
                        data-cold-entity="company"
                        data-cold-id="{{ company.id }}"
                        data-cold-kind="toggle"
                        style="{% if company.primary_contact_is_cold_call or company.primary_cold_marked_at %}display:none{% endif %}"
                      >
                        {% csrf_token %}
                        <input type="hidden" name="confirmed" value="1">
                        <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Отметить холодным</button>
                      </form>
                      {% if view_is_admin %}
                      <form
                          method="post"
                          action="/companies/{{ company.id }}/cold-call/reset/"
                          class="js-cold-call-form"
                          data-confirm="Откатить отметку холодного звонка?"
                          data-cold-entity="company"
                          data-cold-id="{{ company.id }}"
                          data-cold-kind="reset"
                          style="{% if not company.primary_contact_is_cold_call %}display:none{% endif %}"
                        >
                          {% csrf_token %}
                          <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Снять отметку</button>
                        </form>
                      {% endif %}

                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-main-phone>Изменить</button>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="mt-1 text-xs text-brand-dark/70 {% if not company.primary_contact_is_cold_call and not company.primary_cold_marked_at %}hidden{% endif %}" data-cold-info="company:{{ company.id }}">
              <span class="font-medium">Холодный звонок:</span>
              {% if company.primary_cold_marked_at %}
                <span>{{ company.primary_cold_marked_at|date:"d.m.Y H:i" }}</span>
              {% endif %}
              {% if company.primary_cold_marked_by %}
                <span>({{ company.primary_cold_marked_by }})</span>
              {% endif %}
              {% if not company.primary_contact_is_cold_call and company.primary_cold_marked_at %}
                <span class="opacity-80">(откат)</span>
              {% endif %}
            </div>
            <div class="mt-1">
              {% if can_edit_company %}
                <div class="phone-comment-wrapper" data-phone-type="main" data-company-id="{{ company.id }}">
                  <div class="phone-comment-display text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70 transition-colors" data-edit-comment style="white-space: pre-wrap;">{% if company.phone_comment %}{{ company.phone_comment }}{% else %}Комментарий{% endif %}</div>
                  <div class="phone-comment-edit hidden mt-1">
                    <textarea class="input text-xs" placeholder="Комментарий к номеру" maxlength="255" data-comment-input rows="2" style="padding:.35rem .5rem;font-size:.75rem;min-height:3.25rem;resize:vertical">{{ company.phone_comment|default:'' }}</textarea>
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-save-comment>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-cancel-comment>Отмена</button>
                    </div>
                  </div>
                </div>
              {% elif company.phone_comment %}
                <div class="text-xs text-brand-dark/50 mt-1" style="white-space: pre-wrap;">{{ company.phone_comment }}</div>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between gap-2">
              <button type="button" class="flex items-center gap-2 text-brand-dark/50 hover:text-brand-dark/70 transition-colors cursor-pointer" data-toggle-additional-phones aria-expanded="false">
                <svg class="w-5 h-5 text-orange-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" style="transform: rotate(0deg); stroke-width: 3;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                </svg>
                <span>Дополнительные телефоны</span>
                {% if company.phones.all %}
                  <span class="text-xs text-brand-dark/40 font-normal" data-additional-phones-count>({{ company.phones.all|length }})</span>
                {% endif %}
              </button>
              {% if can_edit_company %}
                <div class="relative shrink-0" data-dd-root>
                  <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                  <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-add-company-phone>Добавить телефон</button>
                    <a class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" href="/companies/{{ company.id }}/edit/">Открыть редактирование</a>
                  </div>
                </div>
              {% endif %}
            </div>

            {% if can_edit_company %}
              <div class="hidden mt-2" data-company-phone-add>
                <div class="flex items-start gap-2 flex-wrap">
                  <input class="input text-xs" data-company-phone-add-input placeholder="+7..." style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:15rem" />
                  <button type="button" class="btn btn-primary btn-sm" data-company-phone-add-save>Сохранить</button>
                  <button type="button" class="btn btn-outline btn-sm" data-company-phone-add-cancel>Отмена</button>
                </div>
                <div class="text-xs text-red-600 mt-1 hidden" data-company-phone-add-error></div>
                <div class="muted-2 mt-1" style="font-size:0.6875rem;">Можно вставить несколько (Enter/запятая/точка с запятой) — добавится несколько номеров.</div>
              </div>
            {% endif %}

            <div class="space-y-2 mt-2 hidden overflow-hidden transition-all duration-300 ease-in-out" data-company-phones-list style="max-height: 0;">
              {% for phone in company.phones.all %}
                <div>
                  <div class="flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="font-mono text-xs" data-company-phone-display="{{ phone.id }}">{{ phone.value|format_phone }}</div>
                      {% with info=phone.value|phone_local_info %}
                        {% if info %}<div class="mt-1" data-company-phone-local="{{ phone.id }}"><span class="badge badge-warn badge-xxxs">{{ info }}</span></div>{% endif %}
                      {% endwith %}
                      {% if not phone.value|phone_local_info %}
                        {% with guessed=company.address|guess_ru_tz %}
                        {% with tz=company.work_timezone|default:guessed %}
                          {% if tz %}<div class="mt-1"><span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1"><span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span> · {{ tz|tz_label }}</span></div>{% endif %}
                        {% endwith %}
                        {% endwith %}
                      {% endif %}
                      {% if can_edit_company %}
                        <div class="hidden mt-1" data-company-phone-edit="{{ phone.id }}">
                          <input class="input text-xs" data-company-phone-input value="{{ phone.value|default:'' }}" placeholder="+7..." style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:15rem" />
                          <div class="flex gap-1 mt-1">
                            <button type="button" class="btn btn-primary btn-sm" data-company-phone-save="{{ phone.id }}">Сохранить</button>
                            <button type="button" class="btn btn-outline btn-sm" data-company-phone-cancel="{{ phone.id }}">Отмена</button>
                          </div>
                          <div class="text-xs text-red-600 mt-1 hidden" data-company-phone-error="{{ phone.id }}"></div>
                        </div>
                      {% endif %}
                    </div>
                    {% if phone.value %}
                      <div class="relative shrink-0" data-dd-root>
                        <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                        <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                          <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-call-phone" data-phone="{{ phone.value }}" data-company="{{ company.id }}" data-contact="">Позвонить</button>
                          <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-copy-phone="{{ phone.value }}">Скопировать</button>

                          {% if can_edit_company %}
                            <form
                              method="post"
                              action="/company-phones/{{ phone.id }}/cold-call/toggle/"
                              class="js-cold-call-form"
                              data-confirm="Вы действительно хотите отметить звонок как холодный?"
                              data-cold-entity="company_phone"
                              data-cold-id="{{ phone.id }}"
                              data-cold-kind="toggle"
                              style="{% if phone.is_cold_call or phone.cold_marked_at %}display:none{% endif %}"
                            >
                              {% csrf_token %}
                              <input type="hidden" name="confirmed" value="1">
                              <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Отметить холодным</button>
                            </form>
                            {% if view_is_admin %}
                              <form
                                method="post"
                                action="/company-phones/{{ phone.id }}/cold-call/reset/"
                                class="js-cold-call-form"
                                data-confirm="Откатить отметку холодного звонка?"
                                data-cold-entity="company_phone"
                                data-cold-id="{{ phone.id }}"
                                data-cold-kind="reset"
                                style="{% if not phone.is_cold_call %}display:none{% endif %}"
                              >
                                {% csrf_token %}
                                <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Снять отметку</button>
                              </form>
                            {% endif %}

                            <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-company-phone="{{ phone.id }}">Изменить</button>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}
                  </div>
                  <div class="mt-1 text-xs text-brand-dark/70 {% if not phone.is_cold_call and not phone.cold_marked_at %}hidden{% endif %}" data-cold-info="company_phone:{{ phone.id }}">
                    <span class="font-medium">Холодный звонок:</span>
                    {% if phone.cold_marked_at %}
                      <span>{{ phone.cold_marked_at|date:"d.m.Y H:i" }}</span>
                    {% endif %}
                    {% if phone.cold_marked_by %}
                      <span>({{ phone.cold_marked_by.first_name }} {{ phone.cold_marked_by.last_name|default:"" }})</span>
                    {% endif %}
                    {% if not phone.is_cold_call and phone.cold_marked_at %}
                      <span class="opacity-80">(откат)</span>
                    {% endif %}
                  </div>
                  <div class="mt-1">
                    {% if can_edit_company %}
                      <div class="phone-comment-wrapper" data-phone-type="company" data-phone-id="{{ phone.id }}">
                        <div class="phone-comment-display text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70 transition-colors" data-edit-comment style="white-space: pre-wrap;">{% if phone.comment %}{{ phone.comment }}{% else %}Комментарий{% endif %}</div>
                        <div class="phone-comment-edit hidden mt-1">
                          <textarea class="input text-xs" placeholder="Комментарий к номеру" maxlength="255" data-comment-input rows="2" style="padding:.35rem .5rem;font-size:.75rem;min-height:3.25rem;resize:vertical">{{ phone.comment|default:'' }}</textarea>
                          <div class="flex gap-1 mt-1">
                            <button type="button" class="btn btn-primary btn-sm" data-save-comment>Сохранить</button>
                            <button type="button" class="btn btn-outline btn-sm" data-cancel-comment>Отмена</button>
                          </div>
                        </div>
                      </div>
                    {% elif phone.comment %}
                      <div class="text-xs text-brand-dark/50 mt-1" style="white-space: pre-wrap;">{{ phone.comment }}</div>
                    {% endif %}
                  </div>
                </div>
              {% empty %}
                <div class="text-xs muted-2">—</div>
              {% endfor %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Email адреса</div>
            <div class="space-y-1">
              {% if company.email %}
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <div class="font-mono text-xs" data-company-main-email-display>{{ company.email }}</div>
                    <div class="text-xs text-brand-dark/50">(основной)</div>
                    {% if can_edit_company %}
                      <div class="hidden mt-1" data-company-main-email-edit>
                        <input class="input text-xs" data-company-main-email-input value="{{ company.email|default:'' }}" placeholder="email@example.com" style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:17.5rem" />
                        <div class="flex gap-1 mt-1">
                          <button type="button" class="btn btn-primary btn-sm" data-company-main-email-save>Сохранить</button>
                          <button type="button" class="btn btn-outline btn-sm" data-company-main-email-cancel>Отмена</button>
                        </div>
                        <div class="text-xs text-red-600 mt-1 hidden" data-company-main-email-error></div>
                      </div>
                    {% endif %}
                  </div>
                  <div class="relative shrink-0" data-dd-root>
                    <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                    <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-copy-email" data-email="{{ company.email }}">Скопировать</button>
                      {% if can_edit_company %}
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-main-email>Изменить</button>
                      {% endif %}
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-add-email-to-campaign" data-email="{{ company.email }}" data-company-id="{{ company.id }}">Добавить в рассылку</button>
                    </div>
                  </div>
                </div>
              {% endif %}
              {% for email in company.emails.all %}
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <a href="mailto:{{ email.value }}" class="font-mono text-xs text-brand-teal hover:underline" data-company-email-display="{{ email.id }}" title="Написать">{{ email.value }}</a>
                    {% if can_edit_company %}
                      <div class="hidden mt-1" data-company-email-edit="{{ email.id }}">
                        <input class="input text-xs" data-company-email-input value="{{ email.value|default:'' }}" placeholder="email@example.com" style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:17.5rem" />
                        <div class="flex gap-1 mt-1">
                          <button type="button" class="btn btn-primary btn-sm" data-company-email-save="{{ email.id }}">Сохранить</button>
                          <button type="button" class="btn btn-outline btn-sm" data-company-email-cancel="{{ email.id }}">Отмена</button>
                        </div>
                        <div class="text-xs text-red-600 mt-1 hidden" data-company-email-error="{{ email.id }}"></div>
                      </div>
                    {% endif %}
                  </div>
                  <div class="relative shrink-0" data-dd-root>
                    <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                    <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-copy-email" data-email="{{ email.value }}">Скопировать</button>
                      {% if can_edit_company %}
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-company-email="{{ email.id }}">Изменить</button>
                      {% endif %}
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-add-email-to-campaign" data-email="{{ email.value }}" data-company-id="{{ company.id }}">Добавить в рассылку</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
              {% if not company.email and not company.emails.all %}
                —
              {% endif %}
            </div>
          </div>
          {% if not contacts %}
          <div>
            <div class="text-brand-dark/50">Контакт (ФИО)</div>
            <div>{{ company.contact_name|default:"—" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Контакт (должность)</div>
            <div>{{ company.contact_position|default:"—" }}</div>
          </div>
          {% endif %}
          <div class="md:col-span-2">
            <div class="text-brand-dark/50">Адрес</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="address" data-company-id="{{ company.id }}" data-inline-display-kind="multiline">
                <div class="relative" data-dd-root>
                  <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                    <div class="inline-field-display whitespace-pre-line min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.address|default:"—" }}</div>
                    <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                  </div>
                  <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                  </div>
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <textarea class="input w-full" data-inline-input rows="3" maxlength="500" style="min-height:5.5rem;resize:vertical">{{ company.address|default:'' }}</textarea>
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div class="whitespace-pre-line">{{ company.address|default:"—" }}</div>
            {% endif %}
          </div>
        </div>

      </section>

      {# Модалка: добавить email в кампанию #}
      <div id="addEmailToCampaignModal" class="fixed inset-0 bg-black/35 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-5 w-full max-w-md space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Добавить email в кампанию</div>
            <button type="button" class="text-brand-dark/60 hover:text-red-600 transition-colors js-close-add-email-modal" title="Закрыть">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="text-xs muted-2">Email: <span id="addEmailValue" class="font-mono"></span></div>
          <div>
            <label class="block text-xs muted mb-1">Кампания</label>
            <select id="addEmailCampaignSelect" class="select"></select>
          </div>
          <div class="flex gap-2 justify-end pt-1">
            <button type="button" class="btn btn-outline js-close-add-email-modal">Отмена</button>
            <button type="button" class="btn btn-primary" id="addEmailConfirmBtn">Добавить</button>
          </div>
        </div>
      </div>

      {# Немодальная панель: создать/редактировать контакт (фон НЕ блокируем, чтобы можно было копировать) #}
      <div id="contactPanel" class="fixed right-4 bottom-4 z-[120] hidden" style="width: min(45rem, calc(100vw - 2rem));">
        <div class="bg-white border border-brand-soft rounded-2xl shadow-2xl p-5 max-h-[85vh] overflow-auto">
          <div id="contactPanelBody"></div>
        </div>
      </div>

      <section class="card card-pad">
        <div class="font-medium mb-3">Быстро</div>
        {% if can_edit_company %}
          <button type="button" class="btn btn-primary w-full" data-create-task data-company-id="{{ company.id }}">+ Поставить задачу</button>
          <div class="mt-3">
            <div class="text-xs text-brand-dark/70 mb-1">Передать другому менеджеру</div>
            <form method="post" action="/companies/{{ company.id }}/transfer/" class="flex gap-2">
              {% csrf_token %}
              <select name="responsible_id" class="select">
                <option value="">Выберите ответственного…</option>
                {% regroup transfer_targets by branch as branches_list %}
                {% for branch_group in branches_list %}
                  <optgroup label="Филиал: {{ branch_group.grouper.name|default:"Без филиала" }}">
                    {% for u in branch_group.list %}
                      <option value="{{ u.id }}">{{ u }} ({{ u.get_role_display }})</option>
                    {% endfor %}
                  </optgroup>
                {% endfor %}
              </select>
              <button class="btn btn-outline" type="submit">Передать</button>
            </form>
            <div class="text-xs muted-2 mt-1">При передаче филиал компании обновится под филиал нового ответственного.</div>
          </div>
        {% else %}
          <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
            У вас доступ <b>только на просмотр</b>. Редактировать может ответственный / руководитель филиала / управляющий / администратор.
          </div>
        {% endif %}
        <div class="mt-4 border-t pt-4">
          <div class="font-medium mb-2">Статус и сферы</div>
          {% if can_edit_company %}
            <form method="post" action="/companies/{{ company.id }}/update/" class="space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Статус</label>
                {{ quick_form.status|safe }}
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Сферы</label>
                <div class="ms" data-ms="1" data-placeholder="Выберите сферы">
                  <button type="button" class="ms-btn">
                    <span class="ms-value"></span>
                    <span class="ms-muted">▼</span>
                  </button>
                  <div class="ms-panel hidden">
                    <div class="ms-top">
                      <input class="input ms-search" placeholder="Поиск" />
                      <a href="#" class="btn btn-outline btn-sm" data-ms-clear>Снять</a>
                    </div>
                    <div class="ms-list"></div>
                  </div>
                  <div class="hidden">
                    {{ quick_form.spheres }}
                  </div>
                </div>
              </div>
              <button class="btn btn-outline w-full" type="submit">Сохранить</button>
            </form>
          {% else %}
            <div class="text-sm text-brand-dark/70 space-y-2">
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">Статус</div>
                <div>{{ company.status|default:"—" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">Сферы</div>
                <div class="flex flex-wrap gap-1">
                  {% for s in company.spheres.all %}
                    <span class="badge inline-flex items-center gap-1">
                      {{ s.name }}
                      {% if s.is_important %}
                        <span
                          class="inline-flex items-center justify-center rounded-full border border-brand-orange/80 text-brand-orange bg-white"
                          style="width:1.05rem;height:1.05rem;border-width:1.5px;"
                          title="Важная сфера: решение об обучении принимает головная организация или требуется особое внимание"
                        >
                          <span style="font-size:0.65rem;line-height:1;font-weight:700;">?</span>
                        </span>
                      {% endif %}
                    </span>
                  {% empty %}
                    <span class="text-brand-dark/70">—</span>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {% if org_head and org_head.id == company.id %}
        {% if org_branches %}
          <section class="card card-pad">
            <div class="font-medium mb-3">Филиалы организации</div>
            <div class="space-y-2">
              {% for b in org_branches %}
                <a class="block rounded-lg border p-3 hover:bg-brand-soft/20" href="/companies/{{ b.id }}/">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="text-sm font-medium">{{ b.name }}</div>
                      <div class="text-xs muted-2">ИНН: {{ b.inn|default:"—" }} · Ответственный: {{ b.responsible|default:"—" }} · Филиал: {{ b.branch|default:"—" }}</div>
                    </div>
                  </div>
                </a>
              {% endfor %}
            </div>
          </section>
        {% endif %}
      {% endif %}

      <section class="card card-pad">
        <div class="flex items-end justify-between gap-3 mb-3">
          <div class="font-medium">Контакты</div>
          {% if can_edit_company %}
            <a class="btn btn-outline" href="/companies/{{ company.id }}/contacts/new/?modal=1" data-contact-panel-open>+ Добавить контакт</a>
          {% endif %}
        </div>
        {% if contacts %}
          <div class="space-y-3">
            {% for c in contacts %}
              <div class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <div class="text-sm font-medium">{{ c.last_name }} {{ c.first_name }}</div>
                    <div class="text-xs text-brand-dark/70">
                      {{ c.position }}
                    </div>

                    {# Инлайновый комментарий к контакту — сразу под должностью #}
                    {% if c.note %}
                      <div class="mt-1 rounded-md border border-amber-200 bg-amber-50/70 px-2 py-1">
                        <div class="text-[11px] font-semibold text-amber-900 uppercase tracking-wide mb-0">
                          Комментарий к контакту
                        </div>
                        <div class="text-[10px] text-brand-dark/90 whitespace-pre-line leading-relaxed">
                          {{ c.note }}
                        </div>
                      </div>
                    {% elif can_edit_company %}
                      <div class="mt-1">
                        <a
                          href="/contacts/{{ c.id }}/edit/?modal=1"
                          class="inline-flex items-center gap-1.5 text-[11px] px-2 py-1 rounded-full border border-dashed border-brand-soft text-brand-dark/70 hover:bg-brand-soft/40 hover:text-brand-dark transition-colors"
                          data-contact-panel-open
                          title="Добавить важный комментарий к контакту"
                        >
                          <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                          <span>Комментарий к контакту</span>
                        </a>
                      </div>
                    {% endif %}

                    {% if c.is_cold_call or c.cold_marked_at %}
                      <div class="mt-1 text-xs text-brand-dark/70">
                        <span class="font-medium">Холодный звонок:</span>
                        {% if c.cold_marked_at %}
                          <span>{{ c.cold_marked_at|date:"d.m.Y H:i" }}</span>
                        {% endif %}
                        {% if c.cold_marked_by %}
                          <span>({{ c.cold_marked_by.first_name }} {{ c.cold_marked_by.last_name|default:"" }})</span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                  {% if can_edit_company %}
                    <div class="flex items-center gap-2">
                      <a class="btn btn-outline btn-sm" href="/contacts/{{ c.id }}/edit/?modal=1" data-contact-panel-open title="Редактировать" aria-label="Редактировать">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </a>
                      <form method="post" action="/contacts/{{ c.id }}/delete/" onsubmit="return confirm('Удалить контакт?');" style="display:inline">
                        {% csrf_token %}
                        <button class="btn btn-outline btn-sm btn-danger" title="Удалить контакт" aria-label="Удалить контакт">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  {% endif %}
                </div>
                <div class="mt-2 space-y-3">
                  <div>
                    <div class="text-brand-dark/50 text-xs mb-1">Email</div>
                    <div class="space-y-1">
                      {% for e in c.emails.all %}
                        <div class="flex items-center justify-between gap-2">
                          <div class="min-w-0">
                            <a href="mailto:{{ e.value }}" class="font-mono text-xs text-brand-teal hover:underline truncate block" title="Написать">{{ e.value }}</a>
                          </div>
                          <div class="relative shrink-0" data-dd-root>
                            <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                            <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                              <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-copy-email" data-email="{{ e.value }}">Скопировать</button>
                              <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-add-email-to-campaign" data-email="{{ e.value }}" data-company-id="{{ company.id }}">Добавить в рассылку</button>
                            </div>
                          </div>
                        </div>
                      {% empty %}
                        <div class="text-brand-dark/70 text-sm">—</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div>
                    <div class="text-brand-dark/50 text-xs mb-1">Телефон</div>
                    <div class="space-y-2">
                      {% for p in c.phones.all %}
                        <div>
                          <div class="flex items-center justify-between gap-2">
                            <div class="min-w-0">
                              <div class="font-mono text-xs">{{ p.value|format_phone }}</div>
                              {% with info=p.value|phone_local_info %}
                                {% if info %}<div class="mt-1"><span class="badge badge-warn badge-xxxs">{{ info }}</span></div>{% endif %}
                              {% endwith %}
                              {% if not p.value|phone_local_info %}
                                {% with guessed=company.address|guess_ru_tz %}
                                {% with tz=company.work_timezone|default:guessed %}
                                  {% if tz %}<div class="mt-1"><span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1"><span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span> · {{ tz|tz_label }}</span></div>{% endif %}
                                {% endwith %}
                                {% endwith %}
                              {% endif %}
                            </div>
                            {% if p.value %}
                              <div class="relative shrink-0" data-dd-root>
                                <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                                <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                                  <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-call-phone" data-phone="{{ p.value }}" data-company="{{ company.id }}" data-contact="{{ c.id }}">Позвонить</button>
                                  <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-copy-phone="{{ p.value }}">Скопировать</button>
                                  {% if can_edit_company %}
                                    <form method="post" action="/contact-phones/{{ p.id }}/cold-call/toggle/" class="js-cold-call-form" data-confirm="Вы действительно хотите отметить звонок как холодный?" data-cold-entity="contact_phone" data-cold-id="{{ p.id }}" data-cold-kind="toggle" style="{% if p.is_cold_call or p.cold_marked_at %}display:none{% endif %}">
                                      {% csrf_token %}
                                      <input type="hidden" name="confirmed" value="1">
                                      <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Отметить холодным</button>
                                    </form>
                                    {% if view_is_admin %}
                                      <form method="post" action="/contact-phones/{{ p.id }}/cold-call/reset/" class="js-cold-call-form" data-confirm="Откатить отметку холодного звонка?" data-cold-entity="contact_phone" data-cold-id="{{ p.id }}" data-cold-kind="reset" style="{% if not p.is_cold_call %}display:none{% endif %}">
                                        {% csrf_token %}
                                        <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Снять отметку</button>
                                      </form>
                                    {% endif %}
                                  {% endif %}
                                </div>
                              </div>
                            {% endif %}
                          </div>
                          <div class="mt-1 text-xs text-brand-dark/70 {% if not p.is_cold_call and not p.cold_marked_at %}hidden{% endif %}" data-cold-info="contact_phone:{{ p.id }}">
                            <span class="font-medium">Холодный звонок:</span>
                            {% if p.cold_marked_at %}<span>{{ p.cold_marked_at|date:"d.m.Y H:i" }}</span>{% endif %}
                            {% if p.cold_marked_by %}<span>({{ p.cold_marked_by.first_name }} {{ p.cold_marked_by.last_name|default:"" }})</span>{% endif %}
                            {% if not p.is_cold_call and p.cold_marked_at %}<span class="opacity-80">(откат)</span>{% endif %}
                          </div>
                          <div class="mt-1">
                            {% if can_edit_company %}
                              <div class="phone-comment-wrapper" data-phone-type="contact" data-phone-id="{{ p.id }}">
                                <div class="phone-comment-display text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70 transition-colors" data-edit-comment style="white-space: pre-wrap;">{% if p.comment %}{{ p.comment }}{% else %}Комментарий{% endif %}</div>
                                <div class="phone-comment-edit hidden mt-1">
                                  <textarea class="input text-xs" placeholder="Комментарий к номеру" maxlength="255" data-comment-input rows="2" style="padding:.35rem .5rem;font-size:.75rem;min-height:3.25rem;resize:vertical">{{ p.comment|default:'' }}</textarea>
                                  <div class="flex gap-1 mt-1">
                                    <button type="button" class="btn btn-primary btn-sm" data-save-comment>Сохранить</button>
                                    <button type="button" class="btn btn-outline btn-sm" data-cancel-comment>Отмена</button>
                                  </div>
                                </div>
                              </div>
                            {% elif p.comment %}
                              <div class="text-xs text-brand-dark/50" style="white-space: pre-wrap;">{{ p.comment }}</div>
                            {% endif %}
                          </div>
                        </div>
                      {% empty %}
                        <div class="text-brand-dark/70 text-sm">—</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70 py-4 text-center">
            Контактов нет.
            {% if can_edit_company %}
              <div class="mt-3">
                <a class="btn btn-primary" href="/companies/{{ company.id }}/contacts/new/?modal=1" data-contact-panel-open>+ Добавить контакт</a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </section>

      <section class="card card-pad">
        <div class="flex items-center justify-between mb-3 gap-3">
          <div class="font-medium">Последние задачи</div>
          <button
            type="button"
            class="inline-flex items-center gap-1 text-xs text-brand-dark/70 hover:text-brand-dark"
            id="taskHistoryButton"
            title="История задач"
            aria-label="История задач"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 8v4l3 2"></path>
              <path d="M4 13a8 8 0 1 0 2.3-5.7L4 9"></path>
              <path d="M4 3v6h6"></path>
            </svg>
            <span class="hidden sm:inline">История</span>
          </button>
        </div>
        {% if tasks %}
          <div class="space-y-2">
            {% for t in tasks %}
              <div class="rounded-lg border p-3 {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}task-overdue{% endif %} cursor-pointer hover:bg-brand-soft/20 transition-colors" data-view-task data-task-id="{{ t.id }}" onclick="event.stopPropagation();">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <div class="flex items-start gap-2 mb-0.5">
                      {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}
                        <div class="flex items-center justify-center w-5 h-5 rounded-full border-2 border-red-600 flex-shrink-0 mt-0.5" title="Просрочено">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 8v4"/>
                            <path d="M12 16h.01"/>
                          </svg>
                        </div>
                      {% endif %}
                      <div class="flex-1">
                        {% if t.type %}
                          {% include "ui/partials/task_type_badge.html" with task_type=t.type only %}
                        {% elif t.title %}
                          <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-800">
                            {{ t.title }}
                          </span>
                        {% else %}
                          <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">Без статуса</span>
                        {% endif %}
                      </div>
                    </div>
                    {% if t.description %}
                      <div class="text-xs text-brand-dark/70 mt-1" style="line-height:1.3">{{ t.description|truncatechars:120 }}</div>
                    {% endif %}
                    {% include "ui/partials/_task_meta.html" with task=t only %}
                    <div class="text-xs text-brand-dark/70 mt-1">
                      {{ t.get_status_display }}
                      {% if t.assigned_to %} · {{ t.assigned_to }}{% endif %}
                    </div>
                  </div>
                  <div class="text-right flex-shrink-0">
                    <div class="text-xs {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}text-red-700 font-medium{% else %}text-brand-dark/70{% endif %}">
                      {% if t.due_at %}дедлайн: {{ t.due_at }}{% else %}—{% endif %}
                    </div>
                    <div class="mt-1 inline-flex gap-1 justify-end flex-wrap">
                      {% if t.can_edit_task %}
                        <button
                          type="button"
                          class="flex items-center justify-center w-6 h-6 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors"
                          data-edit-task
                          data-task-id="{{ t.id }}"
                          title="Редактировать"
                          aria-label="Редактировать"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                          </svg>
                        </button>
                      {% endif %}

                      {% if t.can_manage_status and t.status != 'in_progress' %}
                        <form method="post" action="/tasks/{{ t.id }}/status/" class="inline">
                          {% csrf_token %}
                          <button
                            name="status"
                            value="in_progress"
                            class="flex items-center justify-center w-6 h-6 rounded bg-brand-orange hover:opacity-90 text-white transition-colors"
                            title="В работу"
                            aria-label="В работу"
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
                              <path d="M8 2v4"/>
                              <path d="M16 2v4"/>
                              <path d="M8 10h8"/>
                              <path d="M8 14h8"/>
                            </svg>
                          </button>
                        </form>
                      {% endif %}

                      {% if t.can_manage_status and t.status != 'done' %}
                        <button
                          type="button"
                          class="flex items-center justify-center w-6 h-6 rounded bg-brand-teal hover:bg-brand-dark text-white transition-colors"
                          title="Выполнено"
                          aria-label="Выполнено"
                          data-task-complete
                          data-task-id="{{ t.id }}"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"/>
                          </svg>
                        </button>
                      {% endif %}

                      {% if t.can_delete_task %}
                        <button
                          type="button"
                          class="flex items-center justify-center w-6 h-6 rounded bg-white border border-red-200 hover:bg-red-50 transition-colors"
                          title="Удалить"
                          aria-label="Удалить"
                          data-task-delete
                          data-task-id="{{ t.id }}"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7"/>
                          </svg>
                        </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">Задач по компании пока нет.</div>
        {% endif %}
        <div class="mt-3">
          {% if can_edit_company %}
            <button type="button" class="btn btn-outline" data-create-task data-company-id="{{ company.id }}">+ Добавить задачу</button>
          {% endif %}
        </div>
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Заметки</div>
        {% if can_edit_company %}
          <form class="space-y-2" method="post" action="/companies/{{ company.id }}/notes/add/" enctype="multipart/form-data" id="noteForm" data-company-id="{{ company.id }}" data-user-id="{{ request.user.id }}">
            {% csrf_token %}
            <input id="noteFile" type="file" name="attachment" class="hidden" />
            <input id="noteFilesMultiple" type="file" name="attachments" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp,.txt,.csv" />
            <span id="noteAddFilesSummary" class="sr-only" aria-hidden="true"></span>
            <button type="button" class="hidden" id="noteAddFilesRemoveAll" title="Удалить все">Очистить</button>
            <div class="note-input-bar note-files-zone flex items-start gap-2 rounded-xl border border-brand-soft bg-white px-3 py-2 min-h-[52px]" id="noteAddFilesZone">
              <label for="noteFilesMultiple" id="noteAttachMultipleLabel" class="flex-shrink-0 p-2 rounded-lg text-[#64748b] hover:text-brand-teal hover:bg-black/5 cursor-pointer transition-colors" title="Прикрепить файлы" aria-label="Прикрепить файлы">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
              </label>
              <div class="flex-1 min-w-0">
                {{ note_form.text }}
              </div>
              <button type="submit" class="flex-shrink-0 p-2 rounded-lg bg-[#01948E] text-white hover:bg-[#017a75] transition-colors" title="Отправить (Ctrl+Enter)" aria-label="Отправить">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
              </button>
            </div>
            <div id="noteAddFileChips" class="note-attachment-cards flex flex-wrap gap-2 mt-2"></div>
          </form>
        {% else %}
          <div class="text-sm text-brand-dark/70">Нет прав на добавление заметок по этой компании.</div>
        {% endif %}

        <div class="mt-4">
          <div class="max-h-96 overflow-y-auto pr-1 space-y-3">
            {% for n in notes %}
            <div class="relative group rounded-lg border p-3 bg-white/80 hover:bg-white transition-colors" data-note-item>
              <div class="flex items-start justify-between gap-3">
                <div class="text-xs text-brand-dark/70 mb-1">
                  {{ n.created_at }} · {{ n.author|default:"—" }}
                  {% if n.is_pinned %}· <span class="badge badge-warn badge-sm">Закреплено</span>{% endif %}
                  {% if n.edited_at %}· <span class="muted-2">ред. {{ n.edited_at|date:"d.m.Y" }}</span>{% endif %}
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  {% if can_edit_company %}
                    <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/pin/" style="display:inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline btn-sm" title="{% if n.is_pinned %}Открепить{% else %}Закрепить{% endif %}" aria-label="{% if n.is_pinned %}Открепить{% else %}Закрепить{% endif %}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M12 17v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </form>
                  {% endif %}

                  {% if n.author_id == request.user.id or is_admin or is_group_manager or not n.author_id and company.responsible_id == request.user.id %}
                    <button
                      type="button"
                      class="btn btn-outline btn-sm"
                      title="Редактировать"
                      aria-label="Редактировать"
                      data-note-edit
                      data-note-id="{{ n.id }}"
                      data-note-text="{{ n.text|default:'' }}"
                      data-note-file="{{ n.attachment_name|default:'' }}"
                      data-note-main-ext="{{ n.attachment_ext|upper }}"
                      data-note-attachment-ids="{% for att in n.note_attachments.all %}{{ att.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                      data-note-attachment-names="{% for att in n.note_attachments.all %}{{ att.file_name|default:'Файл' }}{% if not forloop.last %}|||{% endif %}{% endfor %}"
                      data-note-attachment-exts="{% for att in n.note_attachments.all %}{{ att.file_ext|upper }}{% if not forloop.last %}|||{% endif %}{% endfor %}"
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/delete/" onsubmit="return confirm('Удалить заметку?');" style="display:inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline btn-sm btn-danger" title="Удалить" aria-label="Удалить">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
              <div class="text-sm whitespace-pre-line wrap-anywhere" data-note-body>{{ n.text }}</div>
              {% if n.attachment or n.note_attachments.all %}
                <div class="mt-2 note-attachment-cards">
                  {% if n.attachment %}
                    {% url 'company_note_attachment_open' company.id n.id as note_main_open_url %}
                    {% url 'company_note_attachment_download' company.id n.id as note_main_download_url %}
                    {% with ext=n.attachment_ext|upper %}
                      {% if ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                        {% include "ui/partials/company_note_attachment_card.html" with open_url=note_main_open_url download_url=note_main_download_url filename=n.attachment_name|default:"Файл" size=n.attachment_size|filesizeformat ext=ext is_image=True editable=False %}
                      {% else %}
                        {% include "ui/partials/company_note_attachment_card.html" with open_url=note_main_open_url download_url=note_main_download_url filename=n.attachment_name|default:"Файл" size=n.attachment_size|filesizeformat ext=ext is_image=False editable=False %}
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                  {% for att in n.note_attachments.all %}
                    {% url 'company_note_attachment_by_id_open' company.id n.id att.id as note_extra_open_url %}
                    {% url 'company_note_attachment_by_id_download' company.id n.id att.id as note_extra_download_url %}
                    {% with ext=att.file_ext|upper %}
                      {% if ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                        {% include "ui/partials/company_note_attachment_card.html" with open_url=note_extra_open_url download_url=note_extra_download_url filename=att.file_name size=att.file_size|filesizeformat ext=ext is_image=True editable=False %}
                      {% else %}
                        {% include "ui/partials/company_note_attachment_card.html" with open_url=note_extra_open_url download_url=note_extra_download_url filename=att.file_name size=att.file_size|filesizeformat ext=ext is_image=False editable=False %}
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            {% empty %}
              <div class="text-sm text-brand-dark/70">Пока нет заметок.</div>
            {% endfor %}
          </div>
        </div>
      </section>
    </div>

    <div id="noteEditModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-noteedit></div>
      <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-medium" id="noteEditTitle">Редактировать заметку</div>
              <div class="text-xs muted-2 mt-1" id="noteEditSubtitle">После сохранения появится метка «ред.»</div>
            </div>
            <button type="button" class="btn btn-outline btn-sm" data-close-noteedit aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <form method="post" id="noteEditForm" class="mt-3 space-y-4" enctype="multipart/form-data" data-company-id="{{ company.id }}">
            {% csrf_token %}
            <div>
              <label class="block text-xs font-medium text-brand-dark/70 mb-1">Текст</label>
              <textarea name="text" id="noteEditText" class="textarea" rows="5" placeholder="Текст заметки..."></textarea>
            </div>
            <div class="note-files-zone rounded-xl p-4">
              <div class="note-attachments-header">
                <span class="text-xs font-medium text-brand-dark/70">Вложения</span>
                <button type="button" class="text-xs text-brand-teal hover:underline hidden" id="noteEditRemoveAllBtn" title="Удалить все">Удалить все</button>
              </div>
              <div id="noteEditExistingCards" class="note-attachment-cards mt-2"></div>
              <div id="noteEditFileCurrent" class="text-sm text-brand-dark/80 mt-2 hidden">Основной файл: не выбран</div>
              <div id="noteEditFileSelected" class="text-xs text-brand-teal mb-2 hidden"></div>
              <div class="flex flex-wrap items-center gap-2 mt-2">
                <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white border border-brand-soft/80 text-brand-dark/80 hover:bg-brand-soft/30 cursor-pointer transition-colors text-sm font-medium" for="noteEditFile">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  Заменить основной файл
                </label>
                <input type="file" name="attachment" id="noteEditFile" class="hidden" />
                <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white border border-brand-soft/80 text-brand-dark/80 hover:bg-brand-soft/30 cursor-pointer transition-colors text-sm font-medium" for="noteEditFilesMultiple">
                  Добавить файлы
                </label>
                <input type="file" name="attachments" multiple id="noteEditFilesMultiple" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp,.txt,.csv" />
              </div>
              <div class="mt-2 flex items-center gap-2 hidden" id="noteEditRemoveRow">
                <label class="inline-flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="noteEditRemoveFile" />
                  <span class="text-brand-dark/70">Удалить основной файл при сохранении</span>
                </label>
                <input type="hidden" name="remove_attachment" id="noteEditRemoveHidden" value="0" />
              </div>
              <input type="hidden" name="remove_attachment_ids" id="noteEditRemoveAttachmentIds" value="" />
              <div id="noteEditNewFilesChips" class="note-attachment-cards mt-2"></div>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary" type="submit">Сохранить</button>
              <button class="btn btn-outline" type="button" data-close-noteedit>Отмена</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {# Просмотр изображений (вложения заметок) в модалке #}
    <div id="imagePreviewModal" class="fixed inset-0 z-[220] hidden">
      <div class="fixed inset-0 bg-black/60" data-close-img></div>
      <div class="absolute inset-x-4 top-10 mx-auto max-w-5xl">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
          <div class="flex items-center justify-between gap-3 px-4 py-3 border-b">
            <div class="min-w-0">
              <div class="text-sm font-medium truncate" id="imagePreviewTitle">Изображение</div>
              <div class="text-xs muted-2 truncate" id="imagePreviewHint">Esc — закрыть · колесо/тач — масштаб в браузере</div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <a class="btn btn-outline btn-sm" id="imagePreviewOpenLink" href="#" target="_blank" rel="noopener">В новой вкладке</a>
              <a class="btn btn-outline btn-sm" id="imagePreviewDownloadLink" href="#" target="_blank" rel="noopener">Скачать</a>
              <button type="button" class="btn btn-outline btn-sm" data-close-img aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
          </div>
          <div class="bg-black/5 p-3 flex items-center justify-center" style="max-height:85vh;">
            <div id="imagePreviewLoader" class="text-sm text-brand-dark/70 py-10">Загрузка…</div>
            <img id="imagePreviewImg" alt="" class="hidden rounded-xl border border-brand-soft bg-white" style="max-height:80vh; max-width:100%; object-fit:contain;" />
          </div>
        </div>
      </div>
    </div>

    {% if can_request_delete %}
      <div id="deleteRequestModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-delreq></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Запросить удаление компании</div>
                <div class="text-xs muted-2 mt-1">Опишите причину — запрос уйдёт РОП и директору филиала.</div>
              </div>
              <button type="button" class="btn btn-outline btn-sm" data-close-delreq aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete-request/" class="mt-3 space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Примечание</label>
                <div class="flex flex-wrap gap-2 mb-2">
                  <button type="button" class="btn btn-outline btn-xs" data-delreq-template="Карточка задвоена">Карточка задвоена</button>
                  <button type="button" class="btn btn-outline btn-xs" data-delreq-template="Предприятие ликвидировано">Предприятие ликвидировано</button>
                </div>
                <textarea name="note" class="textarea" rows="5" placeholder="Почему нужно удалить карточку?">{{ delete_req.note|default:"" }}</textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary" type="submit">Отправить запрос</button>
                <button class="btn btn-outline" type="button" data-close-delreq>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}


    {% if can_delete_company %}
      <div id="deleteCompanyModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-delcompany></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium" style="color:#b91c1c">Удалить компанию</div>
                <div class="text-xs muted-2 mt-1">
                  Удаление необратимо. Заметки будут удалены, задачи/контакты отвяжутся от компании.
                  Если у компании есть клиентские филиалы — они станут самостоятельными (головными).
                </div>
              </div>
              <button type="button" class="btn btn-outline btn-sm" data-close-delcompany aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete/" class="mt-3 space-y-2" onsubmit="return confirm('Точно удалить компанию?');">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Комментарий (не обязательно)</label>
                <textarea name="reason" class="textarea" rows="3" placeholder="Причина удаления"></textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary btn-danger" type="submit">Удалить</button>
                <button class="btn btn-outline" type="button" data-close-delcompany>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if can_delete_company and delete_req %}
      <div id="cancelDeleteReqModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-cancelreq></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Отменить запрос на удаление</div>
                <div class="text-xs muted-2 mt-1">Менеджеру уйдёт уведомление с причиной.</div>
              </div>
              <button type="button" class="btn btn-outline btn-sm" data-close-cancelreq aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete-request/{{ delete_req.id }}/cancel/" class="mt-3 space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Почему отменили?</label>
                <textarea name="decision_note" class="textarea" rows="4" placeholder="Причина отмены" required></textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-outline" type="submit">Отменить запрос</button>
                <button class="btn btn-outline" type="button" data-close-cancelreq>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}


    {% if can_edit_company %}
      <button type="button" id="openContractModal" class="hidden" aria-hidden="true"></button>
      <div id="contractModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-contract></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Изменить договор</div>
                <div class="text-xs muted-2 mt-1">Вид договора, срок действия или сумма (для годового).</div>
              </div>
              <button type="button" class="btn btn-outline btn-sm" data-close-contract aria-label="Закрыть" title="Закрыть">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/contract/update/" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2" id="contractForm">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Вид</label>
                <select name="contract_type" class="w-full rounded-lg border px-3 py-2" id="contractTypeSelect">
                  <option value="">—</option>
                  {% for ct in contract_types %}
                    <option value="{{ ct.id }}" {% if company.contract_type_id == ct.id %}selected{% endif %} data-is-annual="{{ ct.is_annual|yesno:'true,false' }}">
                      {{ ct.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div id="contractUntilField">
                <label class="block text-xs text-brand-dark/70 mb-1">Действует до (не обязательно)</label>
                {{ contract_form.contract_until }}
              </div>
              <div id="contractAmountField" style="display: none;">
                <label class="block text-xs text-brand-dark/70 mb-1">Сумма договора</label>
                <input type="number" name="contract_amount" step="0.01" min="0" class="w-full rounded-lg border px-3 py-2" value="{{ contract_amount_value }}" placeholder="0.00">
              </div>
              <div class="md:col-span-2 flex gap-2">
                <button class="btn btn-primary" type="submit">Сохранить</button>
                <button class="btn btn-outline" type="button" data-close-contract>Отмена</button>
              </div>
            </form>
            <script>
              (function() {
                const contractTypeSelect = document.getElementById('contractTypeSelect');
                const contractUntilField = document.getElementById('contractUntilField');
                const contractAmountField = document.getElementById('contractAmountField');
                
                function toggleContractFields() {
                  if (!contractTypeSelect) return;
                  const selectedOption = contractTypeSelect.options[contractTypeSelect.selectedIndex];
                  const isAnnual = selectedOption.dataset.isAnnual === 'true';
                  
                  if (isAnnual) {
                    contractUntilField.style.display = 'none';
                    contractAmountField.style.display = 'block';
                  } else {
                    contractUntilField.style.display = 'block';
                    contractAmountField.style.display = 'none';
                  }
                }
                
                if (contractTypeSelect) {
                  contractTypeSelect.addEventListener('change', toggleContractFields);
                  toggleContractFields(); // Инициализация при загрузке
                }
              })();
            </script>
          </div>
        </div>
      </div>
    {% endif %}

    <script>
      (function(){
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }
        
        const contractModal = document.getElementById('contractModal');
        const openContract = document.getElementById('openContractModal');
        if (contractModal && openContract) {
          const closeBtns = contractModal.querySelectorAll('[data-close-contract]');
          function openM() { contractModal.classList.remove('hidden'); }
          function closeM() { contractModal.classList.add('hidden'); }
          openContract.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeM();
          });
        }

        const delReqModal = document.getElementById('deleteRequestModal');
        const openDelReq = document.getElementById('openDeleteRequestModal');
        if (delReqModal && openDelReq) {
          const closeBtns = delReqModal.querySelectorAll('[data-close-delreq]');
          const noteTa = delReqModal.querySelector('textarea[name="note"]');
          function openM() {
            delReqModal.classList.remove('hidden');
            try { noteTa && noteTa.focus(); } catch(_e) {}
          }
          function closeM() { delReqModal.classList.add('hidden'); }
          openDelReq.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });

          // Быстрые варианты примечаний
          delReqModal.querySelectorAll('[data-delreq-template]').forEach(btn => {
            btn.addEventListener('click', function() {
              if (!noteTa) return;
              const tpl = (this.getAttribute('data-delreq-template') || '').trim();
              if (!tpl) return;
              const cur = (noteTa.value || '');
              const curTrim = cur.trim();
              if (curTrim) {
                const next = curTrim + '\n' + tpl;
                noteTa.value = next;
              } else {
                noteTa.value = tpl;
              }
              try {
                noteTa.focus();
                noteTa.selectionStart = noteTa.selectionEnd = noteTa.value.length;
              } catch(_e) {}
            });
          });
        }

        const delCompanyModal = document.getElementById('deleteCompanyModal');
        const openDelCompany = document.getElementById('openDeleteCompanyModal');
        if (delCompanyModal && openDelCompany) {
          const closeBtns = delCompanyModal.querySelectorAll('[data-close-delcompany]');
          function openM() { delCompanyModal.classList.remove('hidden'); }
          function closeM() { delCompanyModal.classList.add('hidden'); }
          openDelCompany.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }

        const cancelReqModal = document.getElementById('cancelDeleteReqModal');
        const openCancelReq = document.getElementById('openCancelDeleteReqModal');
        if (cancelReqModal && openCancelReq) {
          const closeBtns = cancelReqModal.querySelectorAll('[data-close-cancelreq]');
          function openM() { cancelReqModal.classList.remove('hidden'); }
          function closeM() { cancelReqModal.classList.add('hidden'); }
          openCancelReq.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }


        // Ждем, пока DOM готов и uiToast определена
        function initCallPhone() {
          const uiToast = window.uiToast || function(text, type) {
            try {
              console.log('[toast]', text, type);
              // Простой fallback: показываем alert, если uiToast не загружена
              if (type === 'error') {
                alert('Ошибка: ' + text);
              } else {
                alert(text);
              }
            } catch(_e) {}
          };
          const csrftoken = getCookie('csrftoken');
          
          // Подтверждение перед отметкой холодного звонка обрабатывается в base.html

          // Старая логика с data-disabled больше не используется - кнопка показывается только если is_cold_call = False

          document.querySelectorAll('.js-call-phone').forEach(btn => {
            btn.addEventListener('click', async () => {
              // Получаем номер из data-phone (в БД хранится в виде +7XXXXXXXXXX)
              let phone = btn.dataset.phone || '';
              // Убираем все нецифровые символы, кроме ведущего +
              phone = phone.replace(/[^\d+]/g, '');
              
              // Если номер уже в формате +7XXXXXXXXXX (12 символов), оставляем как есть
              if (phone.startsWith('+7') && phone.length === 12) {
                // Уже нормализован, ничего не делаем
              }
              // Если начинается с +7, но длина не 12 - возможно лишние символы
              else if (phone.startsWith('+7')) {
                // Оставляем только +7 и следующие 10 цифр
                const digits = phone.substring(2).replace(/\D/g, '');
                if (digits.length === 10) {
                  phone = '+7' + digits;
                }
              }
              // Если начинается с 8 и 11 цифр => +7XXXXXXXXXX
              else if (phone.startsWith('8') && phone.length === 11) {
                phone = '+7' + phone.substring(1);
              }
              // Если начинается с 7 и 11 цифр => +7XXXXXXXXXX
              else if (phone.startsWith('7') && phone.length === 11) {
                phone = '+7' + phone.substring(1);
              }
              // Если 10 цифр => +7XXXXXXXXXX
              else if (/^\d{10}$/.test(phone)) {
                phone = '+7' + phone;
              }
              // Если ничего не подошло, пытаемся извлечь 10 цифр из конца
              else {
                const digits = phone.replace(/\D/g, '');
                if (digits.length >= 10) {
                  const last10 = digits.slice(-10);
                  phone = '+7' + last10;
                }
              }
              const companyId = btn.dataset.company || '';
              const contactId = btn.dataset.contact || '';
              // Не делаем btn.disabled=true: на disabled в ряде браузеров пропадает подсказка (title).
              // Вместо этого ставим лок и защищаемся от повторных кликов.
              if (btn.dataset.busy === '1') return;
              btn.dataset.busy = '1';
              btn.classList.add('opacity-60');
              uiToast('Отправляю команду на телефон…', 'info');
              try {
                const body = new URLSearchParams({phone, company_id: companyId, contact_id: contactId});
                const res = await fetch('/phone/call/', {
                  method: 'POST',
                  headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
                  body: body.toString()
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.ok) throw new Error(data.detail || 'Ошибка');
                uiToast('Отправлено на телефон ✓', 'success');
                // Новая логика: кнопка "отметить холодный" больше не активируется автоматически
                // Пользователь может отметить холодный звонок в любое время через кнопку
                btn.dataset.busy = '0';
                btn.classList.remove('opacity-60');
              } catch (e) {
                btn.dataset.busy = '0';
                btn.classList.remove('opacity-60');
                uiToast('Не удалось отправить на телефон: ' + (e && e.message ? e.message : e), 'error');
              }
            });
          });
        }
        
        // Инициализируем после загрузки DOM и проверяем, что uiToast доступна
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCallPhone);
        } else {
          // Если DOM уже загружен, ждем немного, чтобы uiToast успела определиться
          setTimeout(initCallPhone, 100);
        }

        // Note edit modal (classic + modern)
        function isModernActive() {
          const modernRoot = document.getElementById('companyDetailModern');
          return !!(modernRoot && !modernRoot.classList.contains('hidden'));
        }

        // Classic modal (только для classic-режима)
        const noteEditModal = document.getElementById('noteEditModal');
        const noteEditForm = document.getElementById('noteEditForm');
        const noteEditText = document.getElementById('noteEditText');
        const noteEditFile = document.getElementById('noteEditFile');
        const noteEditFileCurrent = document.getElementById('noteEditFileCurrent');
        const noteEditFileSelected = document.getElementById('noteEditFileSelected');
        const noteEditRemoveFile = document.getElementById('noteEditRemoveFile');
        const noteEditRemoveHidden = document.getElementById('noteEditRemoveHidden');
        const noteEditTitle = document.getElementById('noteEditTitle');
        const noteEditSubtitle = document.getElementById('noteEditSubtitle');
        const noteEditRemoveRow = document.getElementById('noteEditRemoveRow');

        // Modern modal (используется ТОЛЬКО в modern-режиме)
        const noteEditModalModern = document.getElementById('noteEditModalModern');
        const noteEditFormModern = document.getElementById('noteEditFormModern');
        const noteEditTextModern = document.getElementById('noteEditTextModern');
        const noteEditFileModern = document.getElementById('noteEditFileModern');
        const noteEditFileCurrentModern = document.getElementById('noteEditFileCurrentModern');
        const noteEditFileSelectedModern = document.getElementById('noteEditFileSelectedModern');
        const noteEditRemoveFileModern = document.getElementById('noteEditRemoveFileModern');
        const noteEditRemoveHiddenModern = document.getElementById('noteEditRemoveHiddenModern');
        const noteEditTitleModern = document.getElementById('noteEditTitleModern');
        const noteEditSubtitleModern = document.getElementById('noteEditSubtitleModern');
        const noteEditRemoveRowModern = document.getElementById('noteEditRemoveRowModern');

        // Обновление блока заметок на вкладке "Обзор" без полной перезагрузки страницы
        async function refreshOverviewNotes() {
          const modernRoot = document.getElementById('companyDetailModern');
          if (!modernRoot) return;

          const url = new URL(window.location.href);
          url.searchParams.set('view', 'modern');

          const resp = await fetch(url.toString(), {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          if (!resp.ok) {
            throw new Error('Failed to reload overview');
          }

          const html = await resp.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newModernRoot = doc.getElementById('companyDetailModern');
          if (!newModernRoot) {
            throw new Error('No modern root in response');
          }
          const newOverview = newModernRoot.querySelector('[data-modern-tab-panel=\"overview\"]');
          const currentModernRoot = document.getElementById('companyDetailModern');
          const currentOverview = currentModernRoot && currentModernRoot.querySelector('[data-modern-tab-panel=\"overview\"]');
          if (newOverview && currentOverview && currentOverview.parentNode) {
            currentOverview.parentNode.replaceChild(newOverview, currentOverview);
            // После замены контента пересчитываем необходимость кнопок "Развернуть"
            if (window.updateOverviewNoteExpand) {
              try { window.updateOverviewNoteExpand(); } catch (_e) {}
            }
          } else {
            throw new Error('Overview panel not found');
          }
        }

        // Делаем функцию доступной глобально, чтобы к ней могли обращаться другие скрипты
        window.refreshOverviewNotes = refreshOverviewNotes;

        // Открытие/закрытие classic-модалки редактирования (не используем в modern)
        let openNoteEditClassic = null;
        let closeNoteEditClassic = null;
        if (noteEditModal && noteEditForm && noteEditText) {
          const closeBtns = noteEditModal.querySelectorAll('[data-close-noteedit]');
          const noteEditExistingCards = document.getElementById('noteEditExistingCards');
          const noteEditRemoveIds = document.getElementById('noteEditRemoveAttachmentIds');
          const noteEditFilesMulti = document.getElementById('noteEditFilesMultiple');
          const noteEditRemoveAllBtn = document.getElementById('noteEditRemoveAllBtn');
          const companyId = noteEditForm.getAttribute('data-company-id') || '{{ company.id }}';
          var editIconSvg = { pdf: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2 5 5h-5V4zm-2 8v4H9v-4H7v6h10v-6h-2zm-2-2h2v2H9v-2z"/></svg>', doc: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 16H6V4h7v5h5v9zm-3-5H9v2h2v2H9v2h2v-2h2v-2h-2v-2z"/></svg>', xls: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm1 11h-4v2h4v2h-4v2h2v-1h2v-4h-2v1h-2v-2zm-2-5V4h5l-5 5z"/></svg>', ppt: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm1 9h-2v4h2v-1h1c.55 0 1-.45 1-1v-1c0-.55-.45-1-1-1h-2v-1zm0-5V4h5l-5 5z"/></svg>', file: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/><path d="M14 2v6h6"/></svg>' };
          function editIconClass(ext) { return ext === 'PDF' ? 'pdf' : (ext === 'DOC' || ext === 'DOCX') ? 'doc' : (ext === 'XLS' || ext === 'XLSX') ? 'xls' : (ext === 'PPT' || ext === 'PPTX') ? 'ppt' : 'file'; }
          function editIsImage(ext) { return ['PNG','JPG','JPEG','GIF','WEBP'].indexOf(ext) >= 0; }
          function updateEditRemoveAllVisibility() {
            var hasExisting = noteEditExistingCards && noteEditExistingCards.children.length > 0;
            var hasNew = noteEditFilesMulti && noteEditFilesMulti.files && noteEditFilesMulti.files.length > 0;
            if (noteEditRemoveAllBtn) noteEditRemoveAllBtn.classList.toggle('hidden', !hasExisting && !hasNew);
          }
          openNoteEditClassic = function(noteId, noteText, fileName, attachmentIdsStr, attachmentNamesStr, mainExtStr, attachmentExtsStr) {
            noteEditForm.action = `/companies/{{ company.id }}/notes/${noteId}/edit/`;
            noteEditText.value = noteText || '';
            if (noteEditFile) noteEditFile.value = '';
            if (noteEditFileSelected) noteEditFileSelected.textContent = '';
            if (noteEditRemoveFile) noteEditRemoveFile.checked = false;
            if (noteEditRemoveHidden) noteEditRemoveHidden.value = '0';
            if (noteEditFileCurrent) { noteEditFileCurrent.classList.add('hidden'); noteEditFileCurrent.innerHTML = 'Основной файл: не выбран'; }
            if (noteEditRemoveRow) noteEditRemoveRow.classList.add('hidden');
            if (noteEditRemoveIds) noteEditRemoveIds.value = '';
            if (noteEditFilesMulti) noteEditFilesMulti.value = '';
            const ids = (attachmentIdsStr || '').split(',').map(s => s.trim()).filter(Boolean);
            const names = (attachmentNamesStr || '').split('|||').map(s => s.trim());
            const exts = (attachmentExtsStr || '').split('|||').map(s => s.trim().toUpperCase());
            const mainExt = (mainExtStr || '').toUpperCase();
            if (noteEditExistingCards) {
              noteEditExistingCards.innerHTML = '';
              noteEditExistingCards.dataset.extraIds = ids.join(',');
              noteEditExistingCards.dataset.noteId = noteId;
              if (fileName) {
                var openUrl = '/companies/' + companyId + '/notes/' + noteId + '/file/open/';
                var downloadUrl = '/companies/' + companyId + '/notes/' + noteId + '/file/download/';
                var isImg = editIsImage(mainExt);
                var ic = editIconClass(mainExt);
                var prev = isImg ? '<div class="note-attachment-card__preview"><img src="' + openUrl + '" alt="" /></div>' : '<div class="note-attachment-card__preview"><div class="note-attachment-card__icon note-attachment-card__icon--' + ic + '">' + (editIconSvg[ic] || editIconSvg.file) + '</div></div>';
                var mainCard = document.createElement('div');
                mainCard.className = 'note-attachment-card note-attachment-card--editable';
                mainCard.dataset.main = '1';
                mainCard.innerHTML = '<button type="button" class="note-attachment-card__delete" aria-label="Удалить вложение" data-note-attachment-remove></button>' + prev + '<div class="note-attachment-card__name">' + (fileName.replace(/</g,'&lt;').replace(/"/g,'&quot;')) + '</div>';
                mainCard.querySelector('[data-note-attachment-remove]').textContent = '\u00D7';
                mainCard.querySelector('[data-note-attachment-remove]').addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); if (noteEditRemoveFile) noteEditRemoveFile.checked = true; if (noteEditRemoveHidden) noteEditRemoveHidden.value = '1'; mainCard.remove(); updateEditRemoveAllVisibility(); });
                noteEditExistingCards.appendChild(mainCard);
              }
              ids.forEach(function(id, i) {
                var name = names[i] || 'Файл';
                var ext = exts[i] || '';
                var openUrl = '/companies/' + companyId + '/notes/' + noteId + '/attachments/' + id + '/open/';
                var downloadUrl = '/companies/' + companyId + '/notes/' + noteId + '/attachments/' + id + '/download/';
                var isImg = editIsImage(ext);
                var ic = editIconClass(ext);
                var prev = isImg ? '<div class="note-attachment-card__preview"><img src="' + openUrl + '" alt="" /></div>' : '<div class="note-attachment-card__preview"><div class="note-attachment-card__icon note-attachment-card__icon--' + ic + '">' + (editIconSvg[ic] || editIconSvg.file) + '</div></div>';
                var card = document.createElement('div');
                card.className = 'note-attachment-card note-attachment-card--editable';
                card.dataset.attachmentId = id;
                card.innerHTML = '<button type="button" class="note-attachment-card__delete" aria-label="Удалить вложение" data-note-attachment-remove></button>' + prev + '<div class="note-attachment-card__name">' + (name.replace(/</g,'&lt;').replace(/"/g,'&quot;')) + '</div>';
                card.querySelector('[data-note-attachment-remove]').textContent = '\u00D7';
                card.querySelector('[data-note-attachment-remove]').addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); var cur = (noteEditRemoveIds.value || '').split(',').filter(Boolean); cur.push(id); noteEditRemoveIds.value = cur.join(','); card.remove(); updateEditRemoveAllVisibility(); });
                noteEditExistingCards.appendChild(card);
              });
            }
            renderEditNewFilesCards();
            updateEditRemoveAllVisibility();
            if (noteEditRemoveAllBtn) {
              noteEditRemoveAllBtn.onclick = function() {
                if (noteEditRemoveFile) noteEditRemoveFile.checked = true;
                if (noteEditRemoveHidden) noteEditRemoveHidden.value = '1';
                if (noteEditRemoveIds && noteEditExistingCards && noteEditExistingCards.dataset.extraIds) noteEditRemoveIds.value = noteEditExistingCards.dataset.extraIds;
                if (noteEditFilesMulti) noteEditFilesMulti.value = '';
                if (noteEditExistingCards) noteEditExistingCards.innerHTML = '';
                var newWrap = document.getElementById('noteEditNewFilesChips');
                if (newWrap) newWrap.innerHTML = '';
                updateEditRemoveAllVisibility();
              };
            }
            noteEditModal.classList.remove('hidden');
            setTimeout(() => { try{ noteEditText.focus(); }catch(_e){} }, 0);
          };
          function renderEditNewFilesCards() {
            var newWrap = document.getElementById('noteEditNewFilesChips');
            if (!newWrap || !noteEditFilesMulti) return;
            var files = noteEditFilesMulti.files ? Array.prototype.slice.call(noteEditFilesMulti.files) : [];
            newWrap.innerHTML = '';
            var extFromName = function(n){ var m=(n||'').match(/\.([^.]+)$/); return (m?m[1]:'').toUpperCase(); };
            var formatSize = function(b){ if(!b) return ''; if(b<1024) return b+' Б'; if(b<1024*1024) return (b/1024).toFixed(1)+' КБ'; return (b/1024/1024).toFixed(1)+' МБ'; };
            files.forEach(function(f, idx) {
              var name = f.name || 'Файл';
              var ext = extFromName(name);
              var isImg = editIsImage(ext) || (f.type && f.type.indexOf('image/') === 0);
              var card = document.createElement('div');
              card.className = 'note-attachment-card note-attachment-card--editable';
              card.setAttribute('data-edit-new-index', idx);
              var prev;
              if (isImg && typeof URL !== 'undefined' && URL.createObjectURL) {
                var u = URL.createObjectURL(f);
                prev = '<div class="note-attachment-card__preview"><img src="' + u + '" alt="" /></div>';
                card._objUrl = u;
              } else {
                var ic = editIconClass(ext);
                prev = '<div class="note-attachment-card__preview"><div class="note-attachment-card__icon note-attachment-card__icon--' + ic + '">' + (editIconSvg[ic] || editIconSvg.file) + '</div></div>';
              }
              card.innerHTML = '<button type="button" class="note-attachment-card__delete" aria-label="Удалить вложение" data-note-attachment-remove></button>' + prev + '<div class="note-attachment-card__name">' + (name.replace(/</g,'&lt;').replace(/"/g,'&quot;')) + '</div>';
              card.querySelector('[data-note-attachment-remove]').textContent = '\u00D7';
              card.querySelector('[data-note-attachment-remove]').addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                if (card._objUrl && URL.revokeObjectURL) URL.revokeObjectURL(card._objUrl);
                var list = Array.prototype.slice.call(noteEditFilesMulti.files);
                var i = parseInt(card.getAttribute('data-edit-new-index'), 10);
                if (i >= 0 && i < list.length) { list.splice(i, 1); var dt = new DataTransfer(); list.forEach(function(x){ dt.items.add(x); }); noteEditFilesMulti.files = dt.files; }
                renderEditNewFilesCards();
                updateEditRemoveAllVisibility();
              });
              newWrap.appendChild(card);
            });
            updateEditRemoveAllVisibility();
          }
          if (noteEditFilesMulti) noteEditFilesMulti.addEventListener('change', renderEditNewFilesCards);

          closeNoteEditClassic = function() { noteEditModal.classList.add('hidden'); };

          closeBtns.forEach(b => b.addEventListener('click', closeNoteEditClassic));
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeNoteEditClassic();
          });
          if (noteEditFile && noteEditFileSelected) {
            noteEditFile.addEventListener('change', () => {
              const f = noteEditFile.files && noteEditFile.files.length ? noteEditFile.files[0] : null;
              noteEditFileSelected.textContent = f ? ('Выбран: ' + f.name) : '';
              if (noteEditRemoveFile) noteEditRemoveFile.checked = false;
              if (noteEditRemoveHidden) noteEditRemoveHidden.value = '0';
            });
          }
          if (noteEditRemoveFile) {
            noteEditRemoveFile.addEventListener('change', () => {
              if (noteEditRemoveHidden) noteEditRemoveHidden.value = noteEditRemoveFile.checked ? '1' : '0';
              if (noteEditRemoveFile.checked && noteEditFile) {
                noteEditFile.value = '';
                if (noteEditFileSelected) noteEditFileSelected.textContent = '';
              }
            });
          }

          // Сохранение заметки из classic-модалки без полной перезагрузки страницы
          if (typeof window.fetch === 'function') {
            noteEditForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const formData = new FormData(noteEditForm);
              try {
                const resp = await fetch(noteEditForm.action, {
                  method: 'POST',
                  body: formData,
                  headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                closeNoteEditClassic();
                if (!resp.ok) {
                  window.location.reload();
                  return;
                }
                const companyDetailClassic = document.getElementById('companyDetailClassic');
                const isClassicView = companyDetailClassic && !companyDetailClassic.classList.contains('hidden');
                if (isClassicView) {
                  window.location.href = noteEditForm.action.replace(/\/notes\/\d+\/edit\/?$/, '/');
                  return;
                }
                if (window.uiToast) window.uiToast('Заметка обновлена.', 'success');
                try {
                  await refreshOverviewNotes();
                } catch (_e) {}
              } catch (e) {
                window.location.reload();
              }
            });
          }
        }

        // Открытие/закрытие modern-модалки (используется только в modern)
        let openNoteEditModern = null;
        let openNoteCreateModern = null;
        let closeNoteEditModern = null;
        if (noteEditModalModern && noteEditFormModern && noteEditTextModern) {
          const closeBtnsModern = noteEditModalModern.querySelectorAll('[data-close-noteedit-modern]');

          closeNoteEditModern = function() { noteEditModalModern.classList.add('hidden'); };

          const noteEditExtraListModern = document.getElementById('noteEditExtraAttachmentsListModern');
          const noteEditRemoveIdsModern = document.getElementById('noteEditRemoveAttachmentIdsModern');
          const noteEditFilesMultiModern = document.getElementById('noteEditFilesMultipleModern');
          const noteEditFilesMultiNamesModern = document.getElementById('noteEditFilesMultipleNamesModern');
          openNoteEditModern = function(noteId, noteText, fileName, attachmentIdsStr, attachmentNamesStr) {
            noteEditFormModern.action = `/companies/{{ company.id }}/notes/${noteId}/edit/`;
            noteEditTextModern.value = noteText || '';
            if (noteEditFileModern) noteEditFileModern.value = '';
            if (noteEditFileSelectedModern) noteEditFileSelectedModern.textContent = '';
            if (noteEditRemoveFileModern) noteEditRemoveFileModern.checked = false;
            if (noteEditRemoveHiddenModern) noteEditRemoveHiddenModern.value = '0';
            if (noteEditFileCurrentModern) noteEditFileCurrentModern.innerHTML = fileName ? '<span class="note-file-chip inline-flex"><span class="truncate max-w-[180px]">' + (fileName.replace(/</g,'&lt;').replace(/"/g,'&quot;')) + '</span> (основной)</span>' : 'Основной файл: не выбран';
            if (noteEditTitleModern) noteEditTitleModern.textContent = 'Редактировать заметку';
            if (noteEditSubtitleModern) noteEditSubtitleModern.classList.remove('hidden');
            if (noteEditRemoveRowModern) noteEditRemoveRowModern.style.display = 'flex';
            if (noteEditRemoveIdsModern) noteEditRemoveIdsModern.value = '';
            if (noteEditFilesMultiModern) noteEditFilesMultiModern.value = '';
            if (noteEditFilesMultiNamesModern) noteEditFilesMultiNamesModern.textContent = '';
            const ids = (attachmentIdsStr || '').split(',').map(s => s.trim()).filter(Boolean);
            const names = (attachmentNamesStr || '').split('|||').map(s => s.trim());
            if (noteEditExtraListModern) {
              noteEditExtraListModern.innerHTML = '';
              ids.forEach((id, i) => {
                const name = names[i] || 'Файл';
                const label = document.createElement('label');
                label.className = 'note-file-chip inline-flex items-center gap-2 cursor-pointer';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'note-edit-remove-attachment-modern';
                cb.dataset.attachmentId = id;
                cb.addEventListener('change', () => {
                  if (!noteEditRemoveIdsModern) return;
                  const checked = noteEditExtraListModern.querySelectorAll('.note-edit-remove-attachment-modern:checked');
                  noteEditRemoveIdsModern.value = Array.from(checked).map(c => c.dataset.attachmentId).join(',');
                });
                label.appendChild(cb);
                var sp = document.createElement('span');
                sp.textContent = name;
                label.appendChild(sp);
                var sp2 = document.createElement('span');
                sp2.className = 'text-brand-dark/50 text-xs';
                sp2.textContent = ' (удалить)';
                label.appendChild(sp2);
                noteEditExtraListModern.appendChild(label);
              });
            }
            noteEditModalModern.classList.remove('hidden');
            setTimeout(() => { try{ noteEditTextModern.focus(); }catch(_e){} }, 0);
          };

          openNoteCreateModern = function() {
            noteEditFormModern.action = `/companies/{{ company.id }}/notes/add/`;
            if (noteEditTitleModern) noteEditTitleModern.textContent = 'Новая заметка';
            if (noteEditSubtitleModern) noteEditSubtitleModern.classList.add('hidden');
            if (noteEditTextModern) noteEditTextModern.value = '';
            if (noteEditFileModern) noteEditFileModern.value = '';
            if (noteEditFileSelectedModern) noteEditFileSelectedModern.textContent = '';
            if (noteEditRemoveFileModern) noteEditRemoveFileModern.checked = false;
            if (noteEditRemoveHiddenModern) noteEditRemoveHiddenModern.value = '0';
            if (noteEditFileCurrentModern) noteEditFileCurrentModern.textContent = 'Основной файл: не выбран';
            if (noteEditRemoveRowModern) noteEditRemoveRowModern.style.display = 'none';
            noteEditModalModern.classList.remove('hidden');
            setTimeout(() => { try{ noteEditTextModern.focus(); }catch(_e){} }, 0);
          };

          closeBtnsModern.forEach(b => b.addEventListener('click', closeNoteEditModern));
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeNoteEditModern();
          });

          if (noteEditFileModern && noteEditFileSelectedModern) {
            noteEditFileModern.addEventListener('change', () => {
              const f = noteEditFileModern.files && noteEditFileModern.files.length ? noteEditFileModern.files[0] : null;
              noteEditFileSelectedModern.textContent = f ? ('Выбран: ' + f.name) : '';
              if (noteEditRemoveFileModern) noteEditRemoveFileModern.checked = false;
              if (noteEditRemoveHiddenModern) noteEditRemoveHiddenModern.value = '0';
            });
          }
          if (noteEditRemoveFileModern) {
            noteEditRemoveFileModern.addEventListener('change', () => {
              if (noteEditRemoveHiddenModern) noteEditRemoveHiddenModern.value = noteEditRemoveFileModern.checked ? '1' : '0';
              if (noteEditRemoveFileModern.checked && noteEditFileModern) {
                noteEditFileModern.value = '';
                if (noteEditFileSelectedModern) noteEditFileSelectedModern.textContent = '';
              }
            });
          }

          if (typeof window.fetch === 'function') {
            noteEditFormModern.addEventListener('submit', async (e) => {
              e.preventDefault();
              const formData = new FormData(noteEditFormModern);
              try {
                const resp = await fetch(noteEditFormModern.action, {
                  method: 'POST',
                  body: formData,
                  headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                closeNoteEditModern();
                if (!resp.ok) {
                  window.location.reload();
                  return;
                }
                if (window.uiToast) window.uiToast('Заметка обновлена.', 'success');
                try { await refreshOverviewNotes(); } catch (_e) {}
              } catch (e) {
                window.location.reload();
              }
            });
          }
        }

        // Экспорт modern-функций в глобальную область, чтобы использовать их из любых обработчиков
        if (openNoteEditModern) {
          window.openNoteEditModern = openNoteEditModern;
        }
        if (openNoteCreateModern) {
          window.openNoteCreateModern = openNoteCreateModern;
        }

        // Единая точка входа: создание заметки
        // В modern-режиме всегда открываем modern-модалку,
        // в classic — фокусируем классическую форму.
        window.openNoteCreate = function() {
          if (typeof window.openNoteCreateModern === 'function' && (isModernActive())) {
            window.openNoteCreateModern();
            return;
          }
          const classicForm = document.getElementById('noteForm');
          const classicTextarea = classicForm ? classicForm.querySelector('textarea[name="text"]') : null;
          if (classicTextarea) {
            setTimeout(() => classicTextarea.focus(), 0);
            classicForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        };

        // Единая точка входа: редактирование заметки (modern → modern-модалка, classic → classic-модалка)
        window.openNoteEditSmart = function(noteId, noteText, fileName, sourceEl, attachmentIdsStr, attachmentNamesStr, mainExtStr, attachmentExtsStr) {
          const fromModern = !!(sourceEl && sourceEl.closest && sourceEl.closest('#companyDetailModern'));
          if ((isModernActive() || fromModern) && typeof openNoteEditModern === 'function') {
            openNoteEditModern(noteId, noteText, fileName, attachmentIdsStr, attachmentNamesStr);
            return;
          }
          if (typeof openNoteEditClassic === 'function') {
            openNoteEditClassic(noteId, noteText, fileName, attachmentIdsStr, attachmentNamesStr, mainExtStr, attachmentExtsStr);
          }
        };

        // Делегирование клика по кнопкам редактирования (и в classic, и в modern)
        document.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-note-edit]');
          if (!btn) return;
          e.preventDefault();
          const id = btn.getAttribute('data-note-id');
          const txt = btn.getAttribute('data-note-text') || '';
          const fn = btn.getAttribute('data-note-file') || '';
          const attIds = btn.getAttribute('data-note-attachment-ids') || '';
          const attNames = btn.getAttribute('data-note-attachment-names') || '';
          const mainExt = btn.getAttribute('data-note-main-ext') || '';
          const attExts = btn.getAttribute('data-note-attachment-exts') || '';
          if (id && window.openNoteEditSmart) window.openNoteEditSmart(id, txt, fn, btn, attIds, attNames, mainExt, attExts);
        });

        // Делегирование клика по кнопкам добавления заметки (modern)
        document.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-note-add-modern]');
          if (!btn) return;
          e.preventDefault();
          // В modern-виде принудительно используем modern-модалку,
          // чтобы не открывался классический режим.
          if (typeof window.openNoteCreateModern === 'function') {
            window.openNoteCreateModern();
          } else if (typeof window.openNoteCreate === 'function') {
            window.openNoteCreate();
          }
        });

        // Контекстное меню заметки (классический режим — оставляем без изменений, использует noteMenuModal)
        (function() {
          const menuModal = document.getElementById('noteMenuModal');
          if (!menuModal) return;

          let currentId = null;
          let currentPinned = false;

          function openMenu(id, isPinned) {
            currentId = id;
            currentPinned = !!isPinned;
            menuModal.classList.remove('hidden');
            const pinBtn = menuModal.querySelector('[data-note-menu-action="pin"]');
            const unpinBtn = menuModal.querySelector('[data-note-menu-action="unpin"]');
            if (pinBtn && unpinBtn) {
              if (currentPinned) {
                pinBtn.classList.add('hidden');
                unpinBtn.classList.remove('hidden');
              } else {
                pinBtn.classList.remove('hidden');
                unpinBtn.classList.add('hidden');
              }
            }
          }

          function closeMenu() {
            menuModal.classList.add('hidden');
          }

          // Классический режим: явные кнопки с data-note-menu-btn внутри classic-блока
          document.addEventListener('click', (e) => {
            const btn = e.target.closest('#companyDetailClassic [data-note-menu-btn]');
            if (!btn) return;
            const id = btn.getAttribute('data-note-id');
            const pinned = btn.getAttribute('data-note-pinned') === '1';
            if (id) openMenu(id, pinned);
          });

          menuModal.querySelectorAll('[data-note-menu-close]').forEach(el => {
            el.addEventListener('click', closeMenu);
          });

          menuModal.querySelectorAll('[data-note-menu-action]').forEach(el => {
            el.addEventListener('click', async () => {
              const action = el.getAttribute('data-note-menu-action');
              if (!currentId || !action) return;

              if (action === 'edit') {
                const btn = document.querySelector(`[data-note-edit][data-note-id="${currentId}"]`);
                if (btn) btn.click();
                closeMenu();
                return;
              }

              let selector = null;
              if (action === 'pin' || action === 'unpin') {
                selector = `form[action$="/notes/${currentId}/pin/"]`;
              } else if (action === 'delete') {
                selector = `form[action$="/notes/${currentId}/delete/"]`;
              }
              const form = selector ? document.querySelector(selector) : null;
              if (!form) return;

              if (action === 'delete') {
                if (!confirm('Удалить заметку?')) return;
              }

              if (typeof window.fetch !== 'function') {
                form.submit();
                return;
              }

              try {
                const formData = new FormData(form);
                await fetch(form.action, {
                  method: 'POST',
                  body: formData,
                  headers: {'X-Requested-With': 'XMLHttpRequest'}
                });
              } catch (e) {
                window.location.reload();
              }
            });
          });
        })();

        // Контекстное меню заметки на вкладке "Обзор" (modern, компактный поповер)
        (function() {
          function initModernNoteMenu() {
            const modernRoot = document.getElementById('companyDetailModern');
            const menu = document.getElementById('noteMenuModern');
            if (!modernRoot || !menu) return;

            let currentId = null;
            let currentPinned = false;
            let anchorBtn = null;
            let currentText = '';
            let currentFile = '';
            let currentAttIds = '';
            let currentAttNames = '';

            function openMenu(id, isPinned) {
              currentId = id;
              currentPinned = !!isPinned;
              const pinBtn = menu.querySelector('[data-note-menu-modern-action="pin"]');
              const unpinBtn = menu.querySelector('[data-note-menu-modern-action="unpin"]');
              if (pinBtn && unpinBtn) {
                if (currentPinned) {
                  pinBtn.classList.add('hidden');
                  unpinBtn.classList.remove('hidden');
                } else {
                  pinBtn.classList.remove('hidden');
                  unpinBtn.classList.add('hidden');
                }
              }

              // Позиционируем поповер рядом с кнопкой
              if (anchorBtn) {
                const rect = anchorBtn.getBoundingClientRect();
                const menuRect = menu.firstElementChild.getBoundingClientRect();
                const top = rect.bottom + window.scrollY + 4;
                let left = rect.right + window.scrollX - menuRect.width;
                const maxLeft = window.scrollX + document.documentElement.clientWidth - menuRect.width - 8;
                if (left > maxLeft) left = maxLeft;
                if (left < window.scrollX + 8) left = window.scrollX + 8;
                menu.style.top = top + 'px';
                menu.style.left = left + 'px';
              }

              menu.classList.remove('hidden');
            }

            function closeMenu() {
              menu.classList.add('hidden');
              anchorBtn = null;
              currentText = '';
              currentFile = '';
              currentAttIds = '';
              currentAttNames = '';
            }

            modernRoot.addEventListener('click', (e) => {
              const btn = e.target.closest('[data-note-menu-btn-modern]');
              if (!btn) return;
              e.preventDefault();
              e.stopPropagation();
              const id = btn.getAttribute('data-note-id');
              const pinned = btn.getAttribute('data-note-pinned') === '1';
              anchorBtn = btn;
              currentText = btn.getAttribute('data-note-text') || '';
              currentFile = btn.getAttribute('data-note-file') || '';
              currentAttIds = btn.getAttribute('data-note-attachment-ids') || '';
              currentAttNames = btn.getAttribute('data-note-attachment-names') || '';
              if (id) openMenu(id, pinned);
            });

            // Закрытие по клику вне меню
            document.addEventListener('click', (e) => {
              if (menu.classList.contains('hidden')) return;
              if (e.target.closest('#noteMenuModern')) return;
              if (e.target.closest('[data-note-menu-btn-modern]')) return;
              closeMenu();
            });

            document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape') closeMenu();
            });

            menu.querySelectorAll('[data-note-menu-modern-action]').forEach(el => {
              el.addEventListener('click', async () => {
                const action = el.getAttribute('data-note-menu-modern-action');
                if (!currentId || !action) return;

                if (action === 'edit') {
                  // В modern-режиме всегда в приоритете modern-модалка
                  if (typeof window.openNoteEditModern === 'function') {
                    window.openNoteEditModern(currentId, currentText, currentFile, currentAttIds, currentAttNames);
                  } else if (typeof window.openNoteEditSmart === 'function') {
                    window.openNoteEditSmart(currentId, currentText, currentFile, anchorBtn, currentAttIds, currentAttNames);
                  } else {
                    const btn = document.querySelector(`[data-note-edit][data-note-id="${currentId}"]`);
                    if (btn) btn.click();
                  }
                  closeMenu();
                  return;
                }

                let selector = null;
                if (action === 'pin' || action === 'unpin') {
                  selector = `form[action$="/notes/${currentId}/pin/"]`;
                } else if (action === 'delete') {
                  selector = `form[action$="/notes/${currentId}/delete/"]`;
                }
                const form = selector ? document.querySelector(selector) : null;
                if (!form) return;

                if (action === 'delete') {
                  if (!confirm('Удалить заметку?')) return;
                }

                if (typeof window.fetch !== 'function') {
                  form.submit();
                  return;
                }
                
                try {
                  const formData = new FormData(form);
                  await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {'X-Requested-With': 'XMLHttpRequest'}
                  });
                  try {
                    await refreshOverviewNotes();
                    closeMenu();
                  } catch (_e) {
                    window.location.reload();
                  }
                } catch (e) {
                  window.location.reload();
                }
              });
            });
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initModernNoteMenu);
          } else {
            initModernNoteMenu();
          }
        })();
      })();
    </script>

    <script>
      (function(){
        const input = document.getElementById('noteFile');
        const inputMulti = document.getElementById('noteFilesMultiple');
        const zone = document.getElementById('noteAddFilesZone');
        const cardsWrap = document.getElementById('noteAddFileChips');
        const summaryEl = document.getElementById('noteAddFilesSummary');
        const removeAllBtn = document.getElementById('noteAddFilesRemoveAll');

        function extFromName(name) {
          var m = (name || '').match(/\.([^.]+)$/);
          return (m ? m[1] : '').toUpperCase();
        }
        function isImageExt(ext) {
          return ['PNG','JPG','JPEG','GIF','WEBP'].indexOf(ext) >= 0;
        }
        function formatSize(bytes) {
          if (!bytes) return '';
          if (bytes < 1024) return bytes + ' Б';
          if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' КБ';
          return (bytes/1024/1024).toFixed(1) + ' МБ';
        }
        function iconClass(ext) {
          if (ext === 'PDF') return 'pdf';
          if (ext === 'DOC' || ext === 'DOCX') return 'doc';
          if (ext === 'XLS' || ext === 'XLSX') return 'xls';
          if (ext === 'PPT' || ext === 'PPTX') return 'ppt';
          return 'file';
        }
        var iconSvg = {
          pdf: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2 5 5h-5V4zm-2 8v4H9v-4H7v6h10v-6h-2zm-2-2h2v2H9v-2z"/></svg>',
          doc: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 16H6V4h7v5h5v9zm-3-5H9v2h2v2H9v2h2v-2h2v-2h-2v-2z"/></svg>',
          xls: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm1 11h-4v2h4v2h-4v2h2v-1h2v-4h-2v1h-2v-2zm-2-5V4h5l-5 5z"/></svg>',
          ppt: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm1 9h-2v4h2v-1h1c.55 0 1-.45 1-1v-1c0-.55-.45-1-1-1h-2v-1zm0-5V4h5l-5 5z"/></svg>',
          file: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/><path d="M14 2v6h6"/></svg>'
        };

        function renderAddCards() {
          if (!cardsWrap) return;
          var files = inputMulti && inputMulti.files ? Array.prototype.slice.call(inputMulti.files) : [];
          cardsWrap.innerHTML = '';
          if (summaryEl) summaryEl.textContent = files.length ? files.length + ' файл(ов)' : '';
          if (removeAllBtn) { removeAllBtn.classList.toggle('hidden', files.length === 0); }
          if (zone) zone.classList.toggle('has-files', files.length > 0);
          files.forEach(function(f, idx) {
            var name = f.name || 'Файл';
            var ext = extFromName(name);
            var size = formatSize(f.size);
            var isImg = isImageExt(ext) || (f.type && f.type.indexOf('image/') === 0);
            var card = document.createElement('div');
            card.className = 'note-attachment-card note-attachment-card--editable';
            card.setAttribute('data-index', idx);
            var previewHtml;
            if (isImg && typeof URL !== 'undefined' && URL.createObjectURL) {
              var objUrl = URL.createObjectURL(f);
              previewHtml = '<div class="note-attachment-card__preview"><img src="' + objUrl + '" alt="" /></div>';
              card._objUrl = objUrl;
            } else {
              var ic = iconClass(ext);
              previewHtml = '<div class="note-attachment-card__preview"><div class="note-attachment-card__icon note-attachment-card__icon--' + ic + '">' + (iconSvg[ic] || iconSvg.file) + '</div></div>';
            }
            card.innerHTML = '<button type="button" class="note-attachment-card__delete" aria-label="Удалить вложение" data-note-attachment-remove>&times;</button>' +
              previewHtml +
              '<div class="note-attachment-card__name" title="' + name.replace(/"/g, '&quot;') + '">' + (name.replace(/</g,'&lt;').replace(/"/g,'&quot;')) + '</div>';
            cardsWrap.appendChild(card);
          });
        }

        function removeFileAt(index) {
          if (!inputMulti || !inputMulti.files) return;
          var files = Array.prototype.slice.call(inputMulti.files);
          if (index < 0 || index >= files.length) return;
          files.splice(index, 1);
          var dt = new DataTransfer();
          files.forEach(function(f) { dt.items.add(f); });
          inputMulti.files = dt.files;
          renderAddCards();
        }

        if (inputMulti) {
          inputMulti.addEventListener('change', renderAddCards);
        }
        if (cardsWrap) {
          cardsWrap.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-note-attachment-remove]');
            if (!btn) return;
            var card = btn.closest('.note-attachment-card');
            if (!card) return;
            e.preventDefault();
            e.stopPropagation();
            var idx = parseInt(card.getAttribute('data-index'), 10);
            if (card._objUrl && typeof URL !== 'undefined' && URL.revokeObjectURL) URL.revokeObjectURL(card._objUrl);
            removeFileAt(idx);
          });
        }
        if (removeAllBtn) {
          removeAllBtn.addEventListener('click', function() {
            if (inputMulti) inputMulti.value = '';
            renderAddCards();
          });
        }
        if (document.getElementById('noteAttachBtn') && input) {
          document.getElementById('noteAttachBtn').addEventListener('click', function() { input.click(); });
        }
      })();
    </script>

    <script>
      // Черновик заметки в карточке компании: сохраняем текст локально, чтобы не терялся при переходах.
      (function(){
        const form = document.getElementById('noteForm');
        if (!form) return;

        const textarea = form.querySelector('textarea[name="text"]');
        if (!textarea) return;

        const companyId = form.getAttribute('data-company-id') || '';
        const userId = form.getAttribute('data-user-id') || '';
        const storageKey = `companyNoteDraft:v1:${userId}:${companyId}`;

        function normalize(s) {
          return String(s || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
        }

        function getDraft() {
          try { return localStorage.getItem(storageKey) || ''; } catch (_e) { return ''; }
        }
        function setDraft(v) {
          try { localStorage.setItem(storageKey, v); } catch (_e) {}
        }
        function clearDraft() {
          try { localStorage.removeItem(storageKey); } catch (_e) {}
        }

        // Если последний добавленный note совпадает с черновиком — считаем, что он сохранён, и очищаем.
        const draft = getDraft();
        if (draft) {
          const firstNoteBody = document.querySelector('[data-note-item] [data-note-body]');
          if (firstNoteBody) {
            const noteText = normalize(firstNoteBody.textContent || '');
            if (noteText && noteText === normalize(draft)) {
              clearDraft();
            }
          }
        }

        // Восстановление черновика (только если поле пустое/не тронуто сервером)
        const current = normalize(textarea.value);
        const draft2 = getDraft();
        let lastSavedValue = '';
        if (!current && draft2) {
          textarea.value = draft2;
          lastSavedValue = draft2;
          textarea.dispatchEvent(new Event('input', { bubbles: true }));
        } else {
          lastSavedValue = textarea.value || '';
        }

        // Автосохранение по мере ввода (debounce)
        let t = null;
        textarea.addEventListener('input', () => {
          const v = textarea.value || '';
          const normalized = normalize(v);
          // Если пользователь вручную очистил поле — сразу убираем черновик, чтобы после перезагрузки не подгружался
          if (!normalized) {
            clearDraft();
            lastSavedValue = '';
            if (t) window.clearTimeout(t);
            return;
          }
          if (t) window.clearTimeout(t);
          t = window.setTimeout(() => {
            const v2 = textarea.value || '';
            const normalized2 = normalize(v2);
            if (normalized2 !== normalize(lastSavedValue)) {
              setDraft(v2);
              lastSavedValue = v2;
            }
          }, 250);
        });

        // На случай быстрых переходов — сохраняем при уходе со страницы (только если значение изменилось)
        window.addEventListener('beforeunload', () => {
          const v = textarea.value || '';
          const normalized = normalize(v);
          if (normalized && normalized !== normalize(lastSavedValue)) {
            setDraft(v);
          }
        });

        // Ctrl+Enter / Cmd+Enter — отправить заметку
        textarea.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            if (typeof form.requestSubmit === 'function') form.requestSubmit(); else form.submit();
          }
        });

        // После успешной отправки заметки очищаем черновик,
        // чтобы старое несохранённое сообщение не всплывало снова.
        form.addEventListener('submit', () => {
          // Небольшая задержка, чтобы не мешать возможным редиректам
          setTimeout(() => clearDraft(), 500);
        });
      })();
    </script>

    {% if view_can_view_activity %}
      <details class="card card-pad">
        <summary class="cursor-pointer font-medium">История действий</summary>
        <div class="mt-3">
          {% if activity %}
            <div class="space-y-2">
              {% for ev in activity %}
                <div class="rounded-lg border p-3 text-sm">
                  <div class="text-xs text-brand-dark/70 mb-1">{{ ev.created_at }} · {{ ev.actor|default:"—" }}</div>
                  <div>{{ ev.message|default:ev.get_verb_display }}</div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-brand-dark/70">Пока пусто.</div>
          {% endif %}
        </div>
      </details>
    {% endif %}
  </div>

  </div>
  <!-- Конец классического режима -->

  <div id="noteMenuModal" class="fixed inset-0 z-[205] hidden">
    <div class="fixed inset-0 bg-black/35" data-note-menu-close></div>
    <div class="absolute inset-x-4 top-28 mx-auto max-w-xs">
      <div class="card card-pad space-y-2">
        <div class="font-medium text-sm">Действия с заметкой</div>
        <div class="space-y-1 text-sm">
          <button type="button" class="btn btn-outline btn-sm w-full justify-start" data-note-menu-action="edit">Изменить</button>
          <button type="button" class="btn btn-outline btn-sm w-full justify-start" data-note-menu-action="pin">Закрепить</button>
          <button type="button" class="btn btn-outline btn-sm w-full justify-start" data-note-menu-action="unpin">Открепить</button>
          <button type="button" class="btn btn-outline btn-sm w-full justify-start text-red-600" data-note-menu-action="delete">Удалить</button>
        </div>
      </div>
    </div>
  </div>

  <div id="noteMenuModern" class="hidden fixed z-[210]">
    <div class="card overflow-hidden shadow-xl border border-brand-soft/80 bg-white rounded-xl min-w-[180px]">
      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-note-menu-modern-action="edit">
        Изменить
      </button>
      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-note-menu-modern-action="pin">
        Закрепить
      </button>
      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-note-menu-modern-action="unpin">
        Открепить
      </button>
      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 text-red-600" data-note-menu-modern-action="delete">
        Удалить
      </button>
    </div>
  </div>

  <!-- Современный режим (новый layout) -->
  <div id="companyDetailModern" class="{% if detail_view_mode != 'modern' %}hidden{% endif %}">
    {# Модалка заметки для Modern (создание/редактирование) #}
    <div id="noteEditModalModern" class="fixed inset-0 z-[230] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-noteedit-modern></div>
      <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-medium" id="noteEditTitleModern">Редактировать заметку</div>
              <div class="text-xs muted-2 mt-1" id="noteEditSubtitleModern">После сохранения появится метка «ред.»</div>
            </div>
            <button type="button" class="btn btn-outline btn-sm" data-close-noteedit-modern aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <form method="post" id="noteEditFormModern" class="mt-3 space-y-4" enctype="multipart/form-data">
            {% csrf_token %}
            <div>
              <label class="block text-xs font-medium text-brand-dark/70 mb-1">Текст</label>
              <textarea name="text" id="noteEditTextModern" class="textarea" rows="5" placeholder="Текст заметки..."></textarea>
            </div>
            <div class="note-files-zone rounded-xl p-4">
              <div class="text-xs font-medium text-brand-dark/70 mb-2">Вложения</div>
              <div id="noteEditFileCurrentModern" class="text-sm text-brand-dark/80 mb-2">Основной файл: не выбран</div>
              <div id="noteEditFileSelectedModern" class="text-xs text-brand-teal mb-2 hidden"></div>
              <div class="flex flex-wrap items-center gap-2">
                <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white border border-brand-soft/80 text-brand-dark/80 hover:bg-brand-soft/30 cursor-pointer transition-colors text-sm font-medium" for="noteEditFileModern">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  Заменить основной файл
                </label>
                <input type="file" name="attachment" id="noteEditFileModern" class="hidden" />
                <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white border border-brand-soft/80 text-brand-dark/80 hover:bg-brand-soft/30 cursor-pointer transition-colors text-sm font-medium" for="noteEditFilesMultipleModern">
                  Добавить файлы
                </label>
                <input type="file" name="attachments" multiple id="noteEditFilesMultipleModern" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp,.txt,.csv" />
              </div>
              <div class="mt-2 flex items-center gap-2" id="noteEditRemoveRowModern">
                <label class="inline-flex items-center gap-2 text-xs cursor-pointer">
                  <input type="checkbox" id="noteEditRemoveFileModern" />
                  <span class="text-brand-dark/70">Удалить основной файл при сохранении</span>
                </label>
                <input type="hidden" name="remove_attachment" id="noteEditRemoveHiddenModern" value="0" />
              </div>
              <div id="noteEditExtraAttachmentsListModern" class="flex flex-wrap gap-2 mt-3"></div>
              <input type="hidden" name="remove_attachment_ids" id="noteEditRemoveAttachmentIdsModern" value="" />
              <div id="noteEditFilesMultipleNamesModern" class="text-xs text-brand-dark/50 mt-2"></div>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary" type="submit">Сохранить</button>
              <button class="btn btn-outline" type="button" data-close-noteedit-modern>Отмена</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Sticky header (modern) -->
    <div class="sticky top-0 z-30 mb-4">
      <div class="bg-white/95 backdrop-blur border-b border-brand-soft/60 shadow-sm px-4 sm:px-6 md:px-8 py-2.5 md:py-3.5 flex items-start justify-between gap-4">
        <div class="flex-1 min-w-0">
          <!-- Крошки + некликабельное название компании -->
          <div class="flex items-center justify-between gap-3 mb-1.5">
            <div class="text-[11px] sm:text-xs text-brand-dark/60 truncate">
              <a class="underline hover:text-brand-teal" href="/companies/">Компании</a>
              <span class="mx-1">/</span>
              <span class="font-medium text-brand-dark/80 truncate">{{ company.name }}</span>
            </div>
          </div>

          <!-- Иконка компании + редактируемое название + реквизиты -->
          <div class="flex items-start gap-3">
            <div class="hidden sm:flex w-11 h-11 rounded-2xl bg-brand-soft/60 items-center justify-center text-brand-dark/70 shrink-0">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="4" y="3" width="16" height="18" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 8h8M8 12h5M8 16h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="min-w-0">
              {% if can_edit_company %}
                <div class="inline-field-wrapper w-full min-w-0" data-inline-field="name" data-company-id="{{ company.id }}">
                  <div class="relative" data-dd-root>
                    <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                      <h1 class="text-xl md:text-2xl font-semibold inline-field-display min-w-0 hover:text-brand-teal transition-colors">{{ company.name }}</h1>
                      <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                    </div>
                    <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                    </div>
                  </div>
                  <div class="inline-field-edit hidden mt-1 w-full">
                    <input class="input w-full text-lg py-2 min-h-[2.5rem]" data-inline-input maxlength="255" value="{{ company.name|default:'' }}" placeholder="Название компании" />
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                  </div>
                </div>
              {% else %}
                <h1 class="text-xl md:text-2xl font-semibold truncate">{{ company.name }}</h1>
              {% endif %}

              <!-- Статус / ключевые метки -->
              <div class="mt-1 flex flex-wrap items-center gap-2 text-xs">
                {% if company.status %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-brand-soft/60 text-brand-dark/80 px-2 py-0.5 border border-brand-soft/80">
                    <span class="w-1.5 h-1.5 rounded-full bg-brand-teal"></span>
                    <span>{{ company.status }}</span>
                  </span>
                {% endif %}
                {% if company.contract_type %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-brand-soft/40 text-brand-dark/80 px-2 py-0.5 border border-brand-soft/80">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M7 3h10a2 2 0 0 1 2 2v12.5a1.5 1.5 0 0 1-2.4 1.2L12 15.5l-4.6 3.2A1.5 1.5 0 0 1 5 17.5V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>{{ company.contract_type.name }}</span>
                  </span>
                {% endif %}
              </div>

              <div class="text-xs text-brand-dark/60 mt-1 flex flex-wrap items-center gap-x-2 gap-y-1">
                {% if can_edit_company %}
                  <span>ИНН:</span>
                  <span class="inline-field-wrapper" data-inline-field="inn" data-company-id="{{ company.id }}">
                    <span class="relative inline-block" data-dd-root>
                      <span class="inline-field-trigger inline-field-trigger-inline group" data-dd-toggle title="Клик: скопировать или изменить">
                        <span class="font-mono inline-field-display">{{ company.inn|default:"—" }}</span>
                        <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                      </span>
                      <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                      </div>
                    </span>
                    <span class="inline-field-edit hidden ml-1 align-middle">
                      <input class="input text-xs" data-inline-input maxlength="255" value="{{ company.inn|default:'' }}" style="width:12.5rem;padding:.25rem .5rem;font-size:.75rem" placeholder="ИНН" />
                      <button type="button" class="btn btn-primary btn-xs ml-1" data-inline-save>✓</button>
                      <button type="button" class="btn btn-outline btn-xs ml-1" data-inline-cancel>✕</button>
                      <span class="text-xs text-red-600 ml-1 hidden" data-inline-error></span>
                    </span>
                  </span>
                  <span class="mx-1 text-brand-soft/80">·</span>
                  <span>КПП:</span>
                  <span class="inline-field-wrapper" data-inline-field="kpp" data-company-id="{{ company.id }}">
                    <span class="relative inline-block" data-dd-root>
                      <span class="inline-field-trigger inline-field-trigger-inline group" data-dd-toggle title="Клик: скопировать или изменить">
                        <span class="font-mono inline-field-display">{{ company.kpp|default:"—" }}</span>
                        <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                      </span>
                      <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                      </div>
                    </span>
                    <span class="inline-field-edit hidden ml-1 align-middle">
                      <input class="input text-xs" data-inline-input maxlength="20" value="{{ company.kpp|default:'' }}" style="width:10rem;padding:.25rem .5rem;font-size:.75rem" />
                      <button type="button" class="btn btn-primary btn-xs ml-1" data-inline-save>✓</button>
                      <button type="button" class="btn btn-outline btn-xs ml-1" data-inline-cancel>✕</button>
                      <span class="text-xs text-red-600 ml-1 hidden" data-inline-error></span>
                    </span>
                  </span>
                  <span class="mx-1 text-brand-soft/80">·</span>
                  <span>Область/регион:</span>
                  {% if can_edit_company %}
                    <span class="inline-field-wrapper inline-block ml-1" data-inline-field="region" data-company-id="{{ company.id }}">
                      <span class="relative inline-block" data-dd-root>
                        <span class="inline-field-trigger inline-field-trigger-inline group" data-dd-toggle title="Клик: скопировать или изменить">
                          <span class="inline-field-display min-w-0 hover:text-brand-teal transition-colors">{{ company.region.name|default:"—" }}</span>
                          <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                        </span>
                        <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                          <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                          <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                        </div>
                      </span>
                      <span class="inline-field-edit hidden ml-2 align-middle">
                        {{ quick_form.region }}
                        <button type="button" class="btn btn-primary btn-sm hidden" data-inline-save>Сохранить</button>
                        <span class="text-xs text-red-600 ml-2 hidden" data-inline-error></span>
                      </span>
                    </span>
                  {% else %}
                    <span class="font-mono">{{ company.region.name|default:"—" }}</span>
                  {% endif %}
                {% else %}
                  <span>ИНН: {{ company.inn|default:"—" }}</span>
                  {% if company.kpp %}
                    <span class="mx-1">·</span>
                    <span>КПП: {{ company.kpp }}</span>
                  {% endif %}
                  {% with guessed=company.address|guess_ru_tz %}
                  {% with tz=company.work_timezone|default:guessed %}
                    <span class="mx-1">·</span>
                    <span>Часовой пояс:</span>
                    {% if tz %}
                      <span class="badge badge-warn badge-xxxs">
                        <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                        · {{ tz|tz_label }}
                      </span>
                    {% else %}
                      <span>—</span>
                    {% endif %}
                  {% endwith %}
                  {% endwith %}
                {% endif %}
              </div>

              <!-- Индикатор несохранённых изменений -->
              <div id="unsavedChangesIndicatorModern" class="hidden mt-2 text-xs text-brand-orange flex items-center gap-2">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <span>Есть несохранённые изменения</span>
                <button type="button" class="btn btn-outline btn-xxs ml-auto" id="saveAllChangesModern">Сохранить всё</button>
                <button type="button" class="btn btn-outline btn-xxs" id="cancelAllChangesModern">Отменить</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Правая колонка: переключатель вида + ключевые действия -->
        <div class="flex flex-col items-end gap-2 shrink-0">
          <!-- Переключатель Classic / Modern -->
          <div class="flex items-center gap-1 bg-brand-soft/30 rounded-full p-1" role="group" aria-label="Режим просмотра карточки">
            <button type="button" id="viewModeClassicDetailModern" class="view-mode-detail-btn px-2.5 py-1.5 rounded-full text-xs md:text-[13px] transition-colors {% if detail_view_mode == 'classic' %}bg-white text-brand-teal shadow-sm{% else %}text-brand-dark/70 hover:text-brand-dark{% endif %}" data-mode="classic" title="Классический вид" aria-label="Классический вид">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </button>
            <button type="button" id="viewModeModernDetailModern" class="view-mode-detail-btn px-2.5 py-1.5 rounded-full text-xs md:text-[13px] transition-colors {% if detail_view_mode == 'modern' %}bg-white text-brand-teal shadow-sm{% else %}text-brand-dark/70 hover:text-brand-dark{% endif %}" data-mode="modern" title="Современный вид" aria-label="Современный вид">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
              </svg>
            </button>
          </div>

          <!-- Ключевые действия по компании -->
          <div class="flex flex-wrap justify-end gap-1.5 text-[11px] sm:text-xs">
            {% if can_edit_company %}
              <button type="button" class="btn btn-primary btn-xs md:btn-sm" data-quick-action="task">
                + Добавить задачу
              </button>
              <a class="btn btn-outline btn-xs md:btn-sm" href="/companies/{{ company.id }}/edit/">Редактировать</a>
            {% endif %}

            {% if can_delete_company %}
              <button type="button" class="btn btn-outline btn-xs md:btn-sm btn-danger" id="openDeleteCompanyModal">Удалить</button>
            {% elif can_request_delete %}
              <button type="button" class="btn btn-outline btn-xs md:btn-sm btn-danger" id="openDeleteRequestModal">
                {% if delete_req %}Отменить запрос{% else %}Запросить удаление{% endif %}
              </button>
            {% endif %}

            <!-- Копирование ссылки и поиск по карточке -->
            <div class="flex items-center gap-1 bg-brand-soft/20 rounded-full p-1" id="quickActionsModern">
              <button type="button" class="quick-action-btn p-1.5 rounded hover:bg-white transition-colors" data-copy-text="{{ request.build_absolute_uri }}" title="Копировать ссылку" aria-label="Копировать ссылку">
                <svg class="w-4 h-4 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                </svg>
              </button>
              <button type="button" class="quick-action-btn p-1.5 rounded hover:bg-white transition-colors" id="quickSearchBtnModern" title="Поиск по карточке (/) (Ctrl+K)" aria-label="Поиск">
                <svg class="w-4 h-4 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Статус + ответственный/филиал в компактном виде -->
          <div class="flex items-center gap-2 text-[11px] text-brand-dark/60 justify-end">
            <div class="hidden sm:block text-right space-y-0.5">
              <div><span class="text-brand-dark/50">Ответственный:</span> {{ company.responsible }}</div>
              <div><span class="text-brand-dark/50">Филиал:</span> {{ company.branch }}</div>
            </div>
            <!-- Dropdown только для смены статуса -->
            <div class="relative" id="companyActionsDropdownModern">
              <button type="button" class="btn btn-outline btn-xs p-1.5" id="companyActionsBtnModern" title="Статус и доп. действия (.)" aria-label="Статус и доп. действия">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                </svg>
              </button>
              <div class="hidden absolute right-0 top-full mt-1 bg-white border border-brand-soft rounded-lg shadow-lg z-50 min-w-[180px]" id="companyActionsMenuModern">
                {% if statuses %}
                  <div class="px-3 py-2">
                    <div class="text-xs text-brand-dark/60 mb-1">Статус компании</div>
                    <select class="select w-full text-sm" id="quickStatusChangeModern" data-company-id="{{ company.id }}">
                      <option value="">—</option>
                      {% for status in statuses %}
                        <option value="{{ status.id }}" {% if company.status_id == status.id %}selected{% endif %}>{{ status.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Вкладки Modern (как в новом дизайне) — визуально скрываем переключатели, но оставляем логику -->
    <div class="mb-3 hidden">
          <div class="flex items-center gap-1 overflow-x-auto no-scrollbar py-1 rounded-full bg-white/80 border border-brand-soft/60 px-1 w-full">
        <button type="button" class="modern-tab-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-brand-soft/40 text-brand-dark hover:bg-brand-soft/60 whitespace-nowrap" data-modern-tab-btn="overview">
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <rect x="3" y="4" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" />
              <rect x="14" y="4" width="7" height="4" rx="1.5" stroke="currentColor" stroke-width="2" />
              <rect x="14" y="10" width="7" height="10" rx="1.5" stroke="currentColor" stroke-width="2" />
              <rect x="3" y="13" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" />
            </svg>
            <span>Обзор</span>
          </span>
        </button>
        <button type="button" class="modern-tab-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-white text-brand-dark/70 hover:text-brand-dark hover:bg-brand-soft/20 whitespace-nowrap" data-modern-tab-btn="notes">
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 3h7.5L19 7.5V19a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M14.5 3.5V8H19" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
            <span>Заметки</span>
          </span>
          {% with notes_count=notes|length %}
            {% if notes_count %}
              <span class="ml-2 inline-flex items-center justify-center rounded-full bg-brand-soft px-2 py-0.5 text-xs text-brand-dark/70">{{ notes_count }}</span>
            {% endif %}
          {% endwith %}
        </button>
        <button type="button" class="modern-tab-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-white text-brand-dark/70 hover:text-brand-dark hover:bg-brand-soft/20 whitespace-nowrap" data-modern-tab-btn="tasks">
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M5 7h6M5 12h4M5 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="m15 7 2 2 3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Задачи</span>
          </span>
          {% with tasks_count=tasks|length %}
            {% if tasks_count %}
              <span class="ml-2 inline-flex items-center justify-center rounded-full bg-brand-soft px-2 py-0.5 text-xs text-brand-dark/70">{{ tasks_count }}</span>
            {% endif %}
          {% endwith %}
        </button>
        <button type="button" class="modern-tab-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-white text-brand-dark/70 hover:text-brand-dark hover:bg-brand-soft/20 whitespace-nowrap" data-modern-tab-btn="contacts">
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="12" cy="7" r="3" stroke="currentColor" stroke-width="2"/>
              <path d="M5 20c.8-3 3.1-5 7-5s6.2 2 7 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Контакты</span>
          </span>
          {% with contacts_count=contacts|length %}
            {% if contacts_count %}
              <span class="ml-2 inline-flex items-center justify-center rounded-full bg-brand-soft px-2 py-0.5 text-xs text-brand-dark/70">{{ contacts_count }}</span>
            {% endif %}
          {% endwith %}
        </button>
        <button type="button" class="modern-tab-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-white text-brand-dark/70 hover:text-brand-dark hover:bg-brand-soft/20 whitespace-nowrap" data-modern-tab-btn="deals">
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M5 7h9a3 3 0 0 1 0 6H7a3 3 0 0 0 0 6h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Сделки</span>
          </span>
          {% with deals_count=deals|length %}
            {% if deals_count %}
              <span class="ml-2 inline-flex items-center justify-center rounded-full bg-brand-soft px-2 py-0.5 text-xs text-brand-dark/70">{{ deals_count }}</span>
            {% endif %}
          {% endwith %}
        </button>
        <button type="button" class="modern-tab-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-white text-brand-dark/70 hover:text-brand-dark hover:bg-brand-soft/20 whitespace-nowrap" data-modern-tab-btn="data">
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <ellipse cx="12" cy="5" rx="6" ry="3" stroke="currentColor" stroke-width="2"/>
              <path d="M6 9c0 1.66 2.7 3 6 3s6-1.34 6-3" stroke="currentColor" stroke-width="2"/>
              <path d="M6 13c0 1.66 2.7 3 6 3s6-1.34 6-3" stroke="currentColor" stroke-width="2"/>
              <path d="M6 9v10c0 1.66 2.7 3 6 3s6-1.34 6-3V9" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>Данные</span>
          </span>
        </button>
      </div>
    </div>

    <!-- Контент вкладок: используем только «Обзор» как основной современный layout -->
    <div id="companyModernTabPanels">
      <!-- Обзор -->
      <div class="modern-tab-panel modern-tab-panel-active" data-modern-tab-panel="overview">
        <div class="bg-white rounded-2xl border border-brand-soft/60 shadow-sm py-5 px-6 md:px-8">
          <!-- Короткий сводный бар по компании -->
          <div class="mb-4 flex flex-wrap items-center justify-between gap-3">
            <div class="text-sm font-medium text-brand-dark">
              Обзор по компании
            </div>
            <div class="flex flex-wrap items-center gap-2 text-[11px] text-brand-dark/70">
              <span class="inline-flex items-center gap-1 rounded-full bg-brand-soft/40 px-2 py-0.5 border border-brand-soft/70">
                <svg class="w-3 h-3 text-brand-dark/70" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M7 3h7.5L19 7.5V19a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M14.5 3.5V8H19" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                </svg>
                <span>Заметки: {{ notes|length }}</span>
              </span>
              <span class="inline-flex items-center gap-1 rounded-full bg-brand-soft/40 px-2 py-0.5 border border-brand-soft/70">
                <svg class="w-3 h-3 text-brand-dark/70" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M9 11l3 3L21 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Задачи: {{ tasks|length }}</span>
              </span>
              <span class="inline-flex items-center gap-1 rounded-full bg-brand-soft/40 px-2 py-0.5 border border-brand-soft/70">
                <svg class="w-3 h-3 text-brand-dark/70" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <circle cx="12" cy="7" r="3" stroke="currentColor" stroke-width="2"/>
                  <path d="M5 20c.8-3 3.1-5 7-5s6.2 2 7 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Контакты: {{ contacts|length }}</span>
              </span>
            </div>
          </div>

          <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 items-start">
            <!-- Левая широкая колонка: закрепленная заметка, ближайшие задачи, аккордеоны -->
            <div class="space-y-6 xl:col-span-8">
              <!-- Закрепленная заметка -->
              <section aria-labelledby="pinned-note-heading-modern">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2 text-brand-dark">
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-brand-soft/40 text-brand-orange">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M7 3h7.5L19 7.5V19a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        <path d="M14.5 3.5V8H19" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                      </svg>
                    </span>
                    <span id="pinned-note-heading-modern" class="font-semibold text-base">Закрепленная заметка</span>
                  </div>
                  <div class="flex items-center gap-2 text-sm text-brand-dark/60">
                    <button type="button" class="hover:text-brand-teal transition-colors" onclick="window.switchModernCompanyTab?.('notes');">
                      Все заметки{% if notes %} ({{ notes|length }}){% endif %}
                    </button>
                    {% if can_edit_company %}
                      <button type="button" class="text-brand-teal hover:underline text-sm" data-note-add-modern>+ Добавить</button>
                    {% endif %}
                  </div>
                </div>

                {% if display_note %}
                  <!-- Карточка основной заметки -->
                  <div class="relative rounded-xl overflow-hidden {% if display_note.is_pinned %}bg-[#FFF8F1] border border-amber-200{% else %}bg-white border border-brand-soft/60{% endif %}">
                    <div class="p-4">
                      <div class="flex items-start justify-between gap-2 mb-2">
                        <div class="flex items-center gap-2 min-w-0">
                          {% if display_note.is_pinned %}
                            <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-xs font-medium bg-amber-100/80 text-amber-900 border border-amber-200/80 shrink-0">
                              <svg class="w-3.5 h-3.5 text-amber-700" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 17v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                              </svg>
                              <span>Закреплено</span>
                            </span>
                          {% endif %}
                        </div>
                        {% if can_edit_company %}
                          <button
                            type="button"
                            class="shrink-0 text-brand-dark/60 hover:text-brand-dark text-lg leading-none p-0.5"
                            data-note-menu-btn-modern
                            data-note-id="{{ display_note.id }}"
                            data-note-pinned="{% if display_note.is_pinned %}1{% else %}0{% endif %}"
                            data-note-text="{{ display_note.text|default:'' }}"
                            data-note-file="{{ display_note.attachment_name|default:'' }}"
                            data-note-attachment-ids="{% for att in display_note.note_attachments.all %}{{ att.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                            data-note-attachment-names="{% for att in display_note.note_attachments.all %}{{ att.file_name|default:'Файл' }}{% if not forloop.last %}|||{% endif %}{% endfor %}"
                            aria-label="Действия с заметкой"
                            title="Действия с заметкой"
                          >⋯</button>
                        {% endif %}
                      </div>

                      <div class="text-sm mb-2">
                        <span class="font-semibold text-brand-dark">{{ display_note.author|default:"—" }}</span>
                        <span class="text-brand-dark/50"> · </span>
                        <span class="text-brand-dark/60">{{ display_note.created_at|date:"d.m.Y, H:i" }}</span>
                      </div>

                      {% if display_note.text %}
                        <div class="text-sm text-brand-dark/90 whitespace-pre-line line-clamp-4" id="displayNoteText">{{ display_note.text }}</div>
                        <div class="mt-2 flex justify-center">
                          <button
                            type="button"
                            class="text-sm text-brand-orange hover:underline expand-collapse-btn hidden"
                            data-note-expand-toggle="1"
                          >
                            <span class="expand-text">Развернуть</span>
                            <span class="collapse-text hidden">Свернуть</span>
                          </button>
                        </div>
                      {% endif %}

                      {% if display_note.attachment or display_note.note_attachments.all %}
                        <div class="mt-3 pt-3 border-t border-brand-soft/50 flex flex-wrap gap-2">
                          {% if display_note.attachment %}
                            <div class="note-file-chip">
                              <span class="truncate max-w-[140px]">{{ display_note.attachment_name|default:"Файл" }}</span>
                              <span class="text-brand-dark/50 text-xs">{{ display_note.attachment_size|filesizeformat }}</span>
                              {% with ext=display_note.attachment_ext|upper %}
                                {% if ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                                  <button type="button" class="note-file-link text-xs js-image-open" data-img-url="/companies/{{ company.id }}/notes/{{ display_note.id }}/file/open/" data-img-download="/companies/{{ company.id }}/notes/{{ display_note.id }}/file/download/" data-img-title="{{ display_note.attachment_name|default:'Изображение' }}">Открыть</button>
                                {% else %}
                                  <a class="note-file-link text-xs" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ display_note.id }}/file/open/">Открыть</a>
                                {% endif %}
                              {% endwith %}
                              <a class="note-file-link text-xs" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ display_note.id }}/file/download/">Скачать</a>
                            </div>
                          {% endif %}
                          {% for att in display_note.note_attachments.all %}
                            <div class="note-file-chip">
                              <span class="truncate max-w-[140px]">{{ att.file_name|default:"Файл" }}</span>
                              <span class="text-brand-dark/50 text-xs">{{ att.file_size|filesizeformat }}</span>
                              <a class="note-file-link text-xs" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ display_note.id }}/attachments/{{ att.id }}/open/">Открыть</a>
                              <a class="note-file-link text-xs" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ display_note.id }}/attachments/{{ att.id }}/download/">Скачать</a>
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    {% if can_edit_company and display_note.is_pinned %}
                      <form method="post" action="/companies/{{ company.id }}/notes/{{ display_note.id }}/pin/" style="display:none">{% csrf_token %}<button type="submit">.</button></form>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="text-sm text-brand-dark/50 italic py-6 text-center rounded-lg border border-brand-soft/40 bg-white/50">Нет заметок</div>
                  {% if can_edit_company %}
                    <button type="button" class="mt-3 w-full text-center text-sm text-brand-teal hover:underline py-2" data-note-add-modern>Добавить первую заметку</button>
                  {% endif %}
                {% endif %}

                {% if notes_overview_preview %}
                  <div class="mt-3 space-y-2">
                    {% for n in notes_overview_preview %}
                      <div class="w-full rounded-lg bg-white border border-brand-soft/60 p-3">
                        <div class="flex items-start justify-between gap-2 mb-1">
                          <div class="text-sm">
                            <span class="font-semibold text-brand-dark">{{ n.author|default:"—" }}</span>
                            <span class="text-brand-dark/50"> · </span>
                            <span class="text-brand-dark/60">{{ n.created_at|date:"d.m, H:i" }}</span>
                          </div>
                          {% if can_edit_company %}
                            <button
                              type="button"
                              class="shrink-0 text-brand-dark/60 hover:text-brand-dark text-lg leading-none p-0.5"
                              data-note-menu-btn-modern
                              data-note-id="{{ n.id }}"
                              data-note-pinned="{% if n.is_pinned %}1{% else %}0{% endif %}"
                              data-note-text="{{ n.text|default:'' }}"
                              data-note-file="{{ n.attachment_name|default:'' }}"
                              data-note-attachment-ids="{% for att in n.note_attachments.all %}{{ att.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                              data-note-attachment-names="{% for att in n.note_attachments.all %}{{ att.file_name|default:'Файл' }}{% if not forloop.last %}|||{% endif %}{% endfor %}"
                              aria-label="Действия с заметкой"
                              title="Действия с заметкой"
                            >⋯</button>
                          {% endif %}
                        </div>
                        {% if n.text %}
                          <div
                            class="mt-0.5 text-sm text-brand-dark/90 whitespace-pre-line line-clamp-4"
                            data-note-preview-text="{{ n.id }}"
                          >
                            {{ n.text }}
                          </div>
                          <button
                            type="button"
                            class="mt-1 text-xs text-brand-orange hover:underline hidden"
                            data-note-preview-toggle="{{ n.id }}"
                          >
                            <span class="expand-text">Развернуть</span>
                            <span class="collapse-text hidden">Свернуть</span>
                          </button>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </section>

              <!-- Ближайшие задачи -->
              <section aria-labelledby="upcoming-tasks-heading-modern">
                <div class="card card-pad bg-transparent shadow-none border-none p-0">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2 text-brand-dark">
                      <div class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-brand-soft/40 text-brand-dark/80">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M9 11l3 3L21 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </div>
                      <div id="upcoming-tasks-heading-modern" class="font-medium text-base">Ближайшие задачи</div>
                    </div>
                    <button type="button" class="text-xs text-brand-dark/60 hover:text-brand-teal" onclick="window.switchModernCompanyTab?.('tasks');">
                      Все задачи{% if tasks %} ({{ tasks|length }}){% endif %}
                    </button>
                  </div>
                  {% if upcoming_tasks %}
                    <div class="space-y-2">
                      {% for task in upcoming_tasks %}
                        <div class="rounded-lg border border-brand-soft/70 bg-white px-3 py-3 hover:bg-brand-soft/20 transition-colors cursor-pointer" onclick="window.location='/tasks/{{ task.id }}/'">
                          <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0">
                              <div class="flex items-center gap-2">
                                {% if task.type %}
                                  {% include "ui/partials/task_type_badge.html" with task_type=task.type only %}
                                {% elif task.title %}
                                  <div class="font-medium text-sm truncate">{{ task.title }}</div>
                                {% endif %}
                              </div>
                              {% if task.description %}
                                <div class="text-sm text-brand-dark/80 mt-1 line-clamp-2">{{ task.description }}</div>
                              {% endif %}
                              {% include "ui/partials/_task_meta.html" with task=task hide_created_by=False only %}
                            </div>
                            <div class="flex flex-col items-end gap-1 shrink-0">
                              <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 text-emerald-800 border border-emerald-200 px-2 py-0.5 text-[11px]">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                <span>Предстоящая</span>
                              </span>
                              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-50 text-red-500 border border-red-100">
                                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                  <path d="M6 4h10l2 4-2 4H6v8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                              </span>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="text-sm text-brand-dark/50 italic py-4 text-center">Нет активных задач</div>
                    {% if can_edit_company %}
                      <div class="mt-2">
                        <button type="button" class="btn btn-outline btn-sm w-full" data-create-task data-company-id="{{ company.id }}" data-task-template="callback">Поставить задачу на перезвон</button>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              </section>

              <!-- Аккордеоны: Все заметки / Все задачи -->
              <section class="space-y-3">
                <details id="modernNotesDetails" class="group rounded-2xl border border-brand-soft/70 bg-white/80 overflow-hidden">
                  <summary class="flex items-center justify-between px-4 py-2.5 md:px-5 cursor-pointer select-none text-sm font-medium text-brand-dark">
                    <span class="flex items-center gap-2">
                      <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-brand-soft/40 text-brand-dark/70">
                        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M7 3h7.5L19 7.5V19a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                          <path d="M14.5 3.5V8H19" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                      </span>
                      <span>Все заметки{% if notes %} ({{ notes|length }}){% endif %}</span>
                    </span>
                    <span class="ml-4 inline-flex items-center text-brand-dark/40 transition-transform group-open:rotate-180">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </span>
                  </summary>
                  <div class="border-t border-brand-soft/60 px-4 pt-3 pb-4 md:px-5">
                    {% include "ui/partials/company_detail_notes_panel_modern.html" %}
                  </div>
                </details>

                <details id="modernTasksDetails" class="group rounded-2xl border border-brand-soft/70 bg-white/80 overflow-hidden">
                  <summary class="flex items-center justify-between px-4 py-2.5 md:px-5 cursor-pointer select-none text-sm font-medium text-brand-dark">
                    <span class="flex items-center gap-2">
                      <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-brand-soft/40 text-brand-dark/70">
                        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M5 7h6M5 12h4M5 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="m15 7 2 2 3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </span>
                      <span>Все задачи{% if tasks %} ({{ tasks|length }}){% endif %}</span>
                    </span>
                    <span class="ml-4 inline-flex items-center text-brand-dark/40 transition-transform group-open:rotate-180">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </span>
                  </summary>
                  <div class="border-t border-brand-soft/60 px-4 pt-3 pb-4 md:px-5">
                    {% include "ui/partials/company_detail_tasks_panel_modern.html" %}
                  </div>
                </details>
              </section>
            </div>

            <!-- Правая узкая колонка: ключевые сведения, контакты, реквизиты -->
            <div class="space-y-4 xl:col-span-4">
              <!-- Ключевые сведения -->
              <div class="card card-pad">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2 text-brand-dark">
                    <div class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-brand-soft/40 text-brand-dark/80">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M4 21V10.5L12 3l8 7.5V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 21v-6h6v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="font-medium text-base">Ключевые сведения</div>
                  </div>
                </div>
                <div class="space-y-2 text-sm">
                  <div><span class="text-brand-dark/50">Ответственный:</span> {{ company.responsible|default:"—" }}</div>
                  <div><span class="text-brand-dark/50">Филиал:</span> {{ company.branch|default:"—" }}</div>
                  {% if company.activity_kind %}
                    <div><span class="text-brand-dark/50">Сфера:</span> <span class="whitespace-pre-line">{{ company.activity_kind }}</span></div>
                  {% endif %}
                  <div>
                    <span class="text-brand-dark/50">Вид договора:</span>
                    {% if company.contract_type %}
                      <span>{{ company.contract_type.name }}</span>
                    {% else %}
                      <span>—</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Контактная информация -->
              <div class="card card-pad">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2 text-brand-dark">
                    <div class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-brand-soft/40 text-brand-dark/80">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="font-medium text-base">Контактная информация</div>
                  </div>
                </div>
                <div class="space-y-2 text-sm">
                  <div>
                    <span class="text-brand-dark/50">Телефон:</span>
                    <span class="font-mono">{{ company.phone|format_phone|default:"—" }}</span>
                  </div>
                  <div>
                    <span class="text-brand-dark/50">Email:</span>
                    {% if company.email %}
                      <a href="mailto:{{ company.email }}" class="text-brand-teal hover:underline">{{ company.email }}</a>
                    {% elif company.emails.all %}
                      {% for email in company.emails.all|slice:":1" %}
                        <a href="mailto:{{ email.value }}" class="text-brand-teal hover:underline">{{ email.value }}</a>
                      {% endfor %}
                    {% else %}
                      <span>—</span>
                    {% endif %}
                  </div>
                  <div>
                    <div class="text-brand-dark/50 mb-0.5">Адрес</div>
                    <div class="text-sm whitespace-pre-line">{{ company.address|default:"—" }}</div>
                  </div>
                </div>
              </div>

              <!-- Контакты (N) -->
              <div class="card card-pad">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2 text-brand-dark">
                    <div class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-brand-soft/40 text-brand-dark/80">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <circle cx="12" cy="7" r="3" stroke="currentColor" stroke-width="2"/>
                        <path d="M5 20c.8-3 3.1-5 7-5s6.2 2 7 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </div>
                    <div class="font-medium text-base">Контакты{% if contacts %} ({{ contacts|length }}){% endif %}</div>
                  </div>
                  <button type="button" class="text-xs text-brand-dark/60 hover:text-brand-teal" onclick="window.switchModernCompanyTab?.('contacts');">
                    Все контакты
                  </button>
                </div>
                {% with main_contact=contacts|first %}
                  {% if main_contact %}
                    <div class="border rounded-lg p-3">
                      <div class="flex items-start justify-between gap-3">
                        <div class="flex items-start gap-3 min-w-0">
                          <div class="w-10 h-10 rounded-full bg-brand-soft/50 flex items-center justify-center text-sm font-medium text-brand-dark/80">
                            {{ main_contact.first_name|default:""|slice:":1" }}{{ main_contact.last_name|default:""|slice:":1" }}
                          </div>
                          <div class="min-w-0">
                            <div class="flex items-center gap-2">
                              <div class="font-medium text-sm truncate">{{ main_contact.first_name }} {{ main_contact.last_name }}</div>
                              <span class="inline-flex items-center gap-1 rounded-full bg-brand-soft/60 text-brand-orange px-2 py-0.5 text-[11px]">
                                <span class="w-1.5 h-1.5 rounded-full bg-brand-orange/80"></span>
                                <span>Основной</span>
                              </span>
                            </div>
                            {% if main_contact.position %}
                              <div class="text-xs text-brand-dark/70 mt-0.5 truncate">{{ main_contact.position }}</div>
                            {% endif %}
                            {% if main_contact.phones.all %}
                              {% for phone in main_contact.phones.all|slice:":1" %}
                                <div class="text-xs text-brand-dark/70 mt-1 truncate">{{ phone.value }}</div>
                              {% endfor %}
                            {% elif company.phone %}
                              <div class="text-xs text-brand-dark/70 mt-1 truncate">{{ company.phone }}</div>
                            {% endif %}
                            {% if main_contact.emails.all %}
                              {% for email in main_contact.emails.all|slice:":1" %}
                                <div class="text-xs mt-1 truncate">
                                  <a href="mailto:{{ email.value }}" class="text-brand-teal hover:underline" title="Написать">{{ email.value }}</a>
                                </div>
                              {% endfor %}
                            {% endif %}
                          </div>
                        </div>
                        <div class="flex flex-col items-end gap-2 shrink-0">
                          <div class="flex flex-wrap gap-2 justify-end">
                            {% if main_contact.phones.all %}
                              {% for phone in main_contact.phones.all|slice:":1" %}
                                <button
                                  type="button"
                                  class="btn btn-outline btn-xs js-call-phone"
                                  data-phone="{{ phone.value }}"
                                  data-company="{{ company.id }}"
                                  data-contact="{{ main_contact.id }}"
                                  title="Позвонить"
                                >
                                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true" class="mr-1">
                                    <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  </svg>
                                  <span>Позвонить</span>
                                </button>
                              {% endfor %}
                            {% elif company.phone %}
                              <button
                                type="button"
                                class="btn btn-outline btn-xs js-call-phone"
                                data-phone="{{ company.phone }}"
                                data-company="{{ company.id }}"
                                data-contact=""
                                title="Позвонить"
                              >
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true" class="mr-1">
                                  <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Позвонить</span>
                              </button>
                            {% endif %}
                            {% if main_contact.emails.all %}
                              {% for email in main_contact.emails.all|slice:":1" %}
                                <a
                                  class="btn btn-outline btn-xs"
                                  href="mailto:{{ email.value }}"
                                  title="Письмо"
                                >
                                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true" class="mr-1">
                                    <path d="M4 6h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="m22 8-10 7L2 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  </svg>
                                  <span>Письмо</span>
                                </a>
                              {% endfor %}
                            {% endif %}
                          </div>
                          {% if can_edit_company %}
                            <a
                              class="text-xs text-brand-dark/60 hover:text-brand-teal"
                              href="/contacts/{{ main_contact.id }}/edit/?modal=1"
                              data-contact-panel-open
                            >
                              Редактировать контакт
                            </a>
                          {% endif %}
                        </div>
                      </div>

                      {% if contacts|length > 1 %}
                        <div class="mt-3 pt-3 border-t border-brand-soft/60 space-y-2">
                          {% for contact in contacts|slice:"1:4" %}
                            <div class="flex items-start justify-between gap-2 text-xs text-brand-dark/80">
                              <div class="min-w-0">
                                <div class="font-medium truncate">{{ contact.first_name }} {{ contact.last_name }}</div>
                                {% if contact.position %}
                                  <div class="text-[11px] text-brand-dark/60 truncate">{{ contact.position }}</div>
                                {% endif %}
                              </div>
                              {% with phones=contact.phones.all %}
                                {% if phones %}
                                  {% for phone in phones|slice:":1" %}
                                    <div class="ml-2 text-[11px] text-brand-dark/70 truncate">{{ phone.value }}</div>
                                  {% endfor %}
                                {% endif %}
                              {% endwith %}
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="text-sm text-brand-dark/50 italic py-4 text-center">Нет контактов</div>
                    {% if can_edit_company %}
                      <div class="mt-2">
                        <a class="btn btn-primary btn-sm w-full" href="/companies/{{ company.id }}/contacts/new/?modal=1" data-contact-panel-open>+ Добавить контакт</a>
                      </div>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              </div>

              <!-- Реквизиты -->
              <div class="card card-pad">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2 text-brand-dark">
                    <div class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-brand-soft/40 text-brand-dark/80">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M4 4h16v16H4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 8h8M8 12h5M8 16h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="font-medium text-base">Реквизиты</div>
                  </div>
                </div>
                <div class="space-y-1 text-sm">
                  <div><span class="text-brand-dark/50">ИНН:</span> <span class="font-mono">{{ company.inn|default:"—" }}</span></div>
                  <div><span class="text-brand-dark/50">КПП:</span> <span class="font-mono">{{ company.kpp|default:"—" }}</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Заметки -->
      <div class="modern-tab-panel hidden" data-modern-tab-panel="notes">
        <div class="card card-pad">
          <div class="text-sm text-brand-dark/60">
            Полный список заметок находится в блоке «Все заметки» на обзоре.
          </div>
        </div>
      </div>

      <!-- Задачи -->
      <div class="modern-tab-panel hidden" data-modern-tab-panel="tasks">
        <div class="card card-pad">
          <div class="text-sm text-brand-dark/60">
            Все задачи отображаются в блоке «Все задачи» на обзоре.
          </div>
        </div>
      </div>

      <!-- Контакты -->
      <div class="modern-tab-panel hidden" data-modern-tab-panel="contacts">
        <div class="card card-pad">
          <div class="flex items-end justify-between gap-3 mb-3">
            <div class="font-medium text-lg">Контакты</div>
            {% if can_edit_company %}
              <a class="btn btn-primary btn-sm" href="/companies/{{ company.id }}/contacts/new/?modal=1" data-contact-panel-open>+ Добавить контакт</a>
            {% endif %}
          </div>

          {% if contacts %}
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              {% for contact in contacts %}
                <div class="border rounded-2xl p-4 bg-white/90 shadow-sm">
                  <div class="flex items-start gap-3">
                    <div class="flex-shrink-0">
                      <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-brand-soft text-xs font-semibold text-brand-dark/70">
                        {{ contact.first_name|default_if_none:""|slice:":1" }}{{ contact.last_name|default_if_none:""|slice:":1" }}
                      </div>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between gap-2">
                        <div class="min-w-0">
                          <div class="font-medium text-sm truncate">{{ contact.first_name }} {{ contact.last_name }}</div>
                          {% if contact.position %}
                            <div class="text-xs text-brand-dark/70 mt-1 truncate">{{ contact.position }}</div>
                          {% endif %}
                        </div>
                        {% if can_edit_company %}
                          <a class="btn btn-outline btn-xxs shrink-0" href="/contacts/{{ contact.id }}/edit/?modal=1" data-contact-panel-open title="Редактировать" aria-label="Редактировать контакт">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/></svg>
                          </a>
                        {% endif %}
                      </div>

                      {% with phones=contact.phones.all %}
                        {% if phones %}
                          <div class="text-xs text-brand-dark/80 mt-2 space-y-1">
                            {% for phone in phones|slice:":2" %}
                              <div class="flex items-center gap-2">
                                <span>{{ phone.value|format_phone }}</span>
                              </div>
                            {% endfor %}
                          </div>
                        {% endif %}
                      {% endwith %}

                      {% if contact.emails.all %}
                        <div class="text-xs text-brand-dark/80 mt-2 space-y-1">
                          {% for email in contact.emails.all|slice:":2" %}
                            <div class="truncate">
                              <a href="mailto:{{ email.value }}" class="text-brand-teal hover:underline" title="Написать">{{ email.value }}</a>
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}

                      <div class="mt-3 flex flex-wrap gap-2">
                        {% with primary_phone=contact.phones.all|first %}
                          {% if primary_phone %}
                            <button type="button" class="btn btn-outline btn-xs js-call-phone" data-phone="{{ primary_phone.value }}" data-company="{{ company.id }}" data-contact="{{ contact.id }}" title="Позвонить">
                              Позвонить
                            </button>
                          {% endif %}
                        {% endwith %}
                        {% if contact.emails.all %}
                          {% with first_email=contact.emails.all|first %}
                            <a class="btn btn-outline btn-xs" href="mailto:{{ first_email.value }}" title="Письмо">Письмо</a>
                          {% endwith %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-brand-dark/50 italic py-4 text-center">
              Нет контактов
              {% if can_edit_company %}
                <div class="mt-3">
                  <a class="btn btn-primary" href="/companies/{{ company.id }}/contacts/new/?modal=1" data-contact-panel-open>+ Добавить контакт</a>
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Сделки -->
      <div class="modern-tab-panel hidden" data-modern-tab-panel="deals">
        <div class="card card-pad">
          <div class="flex items-center justify-between mb-3">
            <div class="font-medium">Сделки</div>
            {% if can_edit_company %}
              <button type="button" class="btn btn-outline btn-sm" id="openDealCreateModern">+ Добавить сделку</button>
            {% endif %}
          </div>
          <div class="text-sm text-brand-dark/70">
            {% if deals %}
              <div class="space-y-3">
                {% for d in deals %}
                  <div class="rounded-lg border p-3 bg-white/80 hover:bg-white transition-colors">
                    <div class="flex items-start justify-between gap-3">
                      <div class="min-w-0">
                        <div class="text-xs text-brand-dark/60 mb-1">{{ d.created_at|date:"d.m.Y H:i" }} · {{ d.created_by|default:"—" }}</div>
                        <div class="font-medium text-sm whitespace-pre-line">{{ d.program|default:"—" }}</div>
                        <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
                          <div><span class="text-brand-dark/50">Стоимость/чел:</span> {{ d.price_per_person|default:"—" }}</div>
                          <div><span class="text-brand-dark/50">Слушателей:</span> {{ d.listeners_count|default:"—" }}</div>
                          <div><span class="text-brand-dark/50">Итого:</span> {{ d.total_amount|default:"—" }}</div>
                        </div>
                      </div>
                      {% if can_edit_company %}
                        <form method="post" action="/companies/{{ company.id }}/deals/{{ d.id }}/delete/" onsubmit="return confirm('Удалить сделку?');">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-outline btn-sm btn-danger" title="Удалить" aria-label="Удалить">Удалить</button>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-sm text-brand-dark/50 italic py-4 text-center">Пока нет сделок</div>
            {% endif %}
          </div>

          {% if can_edit_company %}
            <div id="dealCreateFormModern" class="hidden mt-4 border-t pt-4">
              <form class="space-y-3" method="post" action="/companies/{{ company.id }}/deals/add/">
                {% csrf_token %}
                <div>
                  <div class="text-sm text-brand-dark/70 mb-1">Программа обучения</div>
                  <textarea name="program" class="input w-full" rows="3" maxlength="1000" placeholder="Например: Метрологическое обеспечение производственной деятельности, дист, 72 ч с 10.12.2024 по 18.12.2024"></textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <div class="text-sm text-brand-dark/70 mb-1">Стоимость за человека</div>
                    <input name="price_per_person" class="input w-full" type="number" step="0.01" min="0" placeholder="0.00" />
                  </div>
                  <div>
                    <div class="text-sm text-brand-dark/70 mb-1">Количество слушателей</div>
                    <input name="listeners_count" class="input w-full" type="number" step="1" min="0" placeholder="0" />
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button type="submit" class="btn btn-primary btn-sm">Сохранить</button>
                  <button type="button" class="btn btn-outline btn-sm" id="closeDealCreateModern">Отмена</button>
                </div>
              </form>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Данные -->
      <div class="modern-tab-panel hidden" data-modern-tab-panel="data">
        <div class="card card-pad" id="all-data-section-modern">
          <div class="flex items-center justify-between mb-3">
            <div class="font-medium">Данные компании</div>
            {% if can_edit_company %}
              <a class="btn btn-outline btn-sm" href="/companies/{{ company.id }}/edit/">Редактировать</a>
            {% endif %}
          </div>
          <!-- Используем ту же структуру, что и в Classic -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="md:col-span-2">
              <div class="text-brand-dark/50">Организация</div>
              <div class="flex flex-wrap items-center gap-2">
                {% if org_head %}
                  {% if org_head.id == company.id %}
                    <span class="badge">Головная</span>
                    <div class="font-medium">{{ org_head.name }}</div>
                  {% else %}
                    <span class="badge">Филиал</span>
                    <a class="link font-medium" href="/companies/{{ org_head.id }}/">{{ org_head.name }}</a>
                  {% endif %}
                {% else %}
                  <span class="text-brand-dark/70">—</span>
                {% endif %}
                {% if org_branches %}
                  <span class="muted-2 text-xs">· филиалов: {{ org_branches|length }}</span>
                {% endif %}
              </div>
            </div>
            <div>
              <div class="text-brand-dark/50">Юр. название</div>
              {% if can_edit_company %}
                <div class="inline-field-wrapper" data-inline-field="legal_name" data-company-id="{{ company.id }}">
                  <div class="relative" data-dd-root>
                    <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                      <div class="inline-field-display min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.legal_name|default:"—" }}</div>
                      <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                    </div>
                    <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                    </div>
                  </div>
                  <div class="inline-field-edit hidden mt-1">
                    <input class="input w-full" data-inline-input maxlength="255" value="{{ company.legal_name|default:'' }}" />
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                  </div>
                </div>
              {% else %}
                <div>{{ company.legal_name|default:"—" }}</div>
              {% endif %}
            </div>
            <div>
              <div class="text-brand-dark/50">Сайт</div>
              {% if can_edit_company %}
                <div class="inline-field-wrapper" data-inline-field="website" data-company-id="{{ company.id }}" data-inline-display-kind="website">
                  <div class="relative" data-dd-root>
                    <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                      <div class="inline-field-display flex items-center gap-2 min-w-0" data-inline-display>
                        {% if company.website %}
                          {% if "://" in company.website %}
                            <a class="link break-all" data-inline-website-link href="{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                          {% elif company.website|slice:":2" == "//" %}
                            <a class="link break-all" data-inline-website-link href="https:{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                          {% else %}
                            <a class="link break-all" data-inline-website-link href="https://{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                          {% endif %}
                        {% else %}
                          <span class="text-brand-dark/70" data-inline-website-empty>—</span>
                        {% endif %}
                      </div>
                      <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                    </div>
                    <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-open-website>Открыть ссылку</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit title="Редактировать сайт">Изменить</button>
                    </div>
                  </div>
                  <div class="inline-field-edit hidden mt-1">
                    <input class="input w-full" data-inline-input maxlength="255" value="{{ company.website|default:'' }}" placeholder="https://example.com" />
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                  </div>
                </div>
              {% else %}
                <div class="max-w-full">
                  {% if company.website %}
                    {% if "://" in company.website %}
                      <a class="link break-all" href="{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                    {% elif company.website|slice:":2" == "//" %}
                      <a class="link break-all" href="https:{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                    {% else %}
                      <a class="link break-all" href="https://{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                    {% endif %}
                  {% else %}
                    —
                  {% endif %}
                </div>
              {% endif %}
            </div>
            <div>
              <div class="text-brand-dark/50">Вид деятельности</div>
              {% if can_edit_company %}
                <div class="inline-field-wrapper" data-inline-field="activity_kind" data-company-id="{{ company.id }}" data-inline-display-kind="multiline">
                  <div class="relative" data-dd-root>
                    <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                      <div class="inline-field-display whitespace-pre-line min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.activity_kind|default:"—" }}</div>
                      <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                    </div>
                    <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                    </div>
                  </div>
                  <div class="inline-field-edit hidden mt-1">
                    <textarea class="input w-full" data-inline-input rows="3" maxlength="255" style="min-height:5.5rem;resize:vertical">{{ company.activity_kind|default:'' }}</textarea>
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                  </div>
                </div>
              {% else %}
                <div class="whitespace-pre-line">{{ company.activity_kind|default:"—" }}</div>
              {% endif %}
            </div>
            <div>
              <div class="text-brand-dark/50">Численность сотрудников</div>
              {% if can_edit_company %}
                <div class="inline-field-wrapper" data-inline-field="employees_count" data-company-id="{{ company.id }}">
                  <div class="relative" data-dd-root>
                    <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                      <div class="inline-field-display min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.employees_count|default:"—" }}</div>
                      <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                    </div>
                    <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                    </div>
                  </div>
                  <div class="inline-field-edit hidden mt-1">
                    <input class="input w-full" type="number" min="0" data-inline-input value="{{ company.employees_count|default:'' }}" placeholder="Напр.: 120" />
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                  </div>
                </div>
              {% else %}
                <div>{{ company.employees_count|default:"—" }}</div>
              {% endif %}
            </div>
            <div>
              <div class="text-brand-dark/50">Часовой пояс</div>
              {% with guessed=company.address|guess_ru_tz %}
              {% with tz=company.work_timezone|default:guessed %}
                {% if can_edit_company %}
                  <div class="inline-field-wrapper" data-inline-field="work_timezone" data-company-id="{{ company.id }}" data-inline-display-kind="timezone">
                    <div class="flex items-start justify-between gap-2">
                      <div class="inline-field-display min-w-0 cursor-default hover:text-brand-dark/80 transition-colors">
                        {% if tz %}
                          <span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1">
                            <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                            · {{ tz|tz_label }}
                          </span>
                        {% else %}
                          —
                        {% endif %}
                      </div>
                      <div class="relative shrink-0" data-dd-root>
                        <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                        <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                          <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                          <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                        </div>
                      </div>
                    </div>
                    <div class="inline-field-edit hidden mt-1">
                      <select class="select w-full" data-inline-input>
                        <option value="" {% if not company.work_timezone %}selected{% endif %}>Авто (по адресу)</option>
                        <option value="Europe/Kaliningrad" {% if company.work_timezone == "Europe/Kaliningrad" %}selected{% endif %}>Калининград (UTC+02)</option>
                        <option value="Europe/Moscow" {% if company.work_timezone == "Europe/Moscow" %}selected{% endif %}>Москва / СПБ (UTC+03)</option>
                        <option value="Europe/Samara" {% if company.work_timezone == "Europe/Samara" %}selected{% endif %}>Самара (UTC+04)</option>
                        <option value="Asia/Yekaterinburg" {% if company.work_timezone == "Asia/Yekaterinburg" %}selected{% endif %}>Екатеринбург / Тюмень (UTC+05)</option>
                        <option value="Asia/Omsk" {% if company.work_timezone == "Asia/Omsk" %}selected{% endif %}>Омск (UTC+06)</option>
                        <option value="Asia/Novosibirsk" {% if company.work_timezone == "Asia/Novosibirsk" %}selected{% endif %}>Новосибирск (UTC+07)</option>
                        <option value="Asia/Krasnoyarsk" {% if company.work_timezone == "Asia/Krasnoyarsk" %}selected{% endif %}>Красноярск (UTC+07)</option>
                        <option value="Asia/Irkutsk" {% if company.work_timezone == "Asia/Irkutsk" %}selected{% endif %}>Иркутск (UTC+08)</option>
                        <option value="Asia/Yakutsk" {% if company.work_timezone == "Asia/Yakutsk" %}selected{% endif %}>Якутск (UTC+09)</option>
                        <option value="Asia/Vladivostok" {% if company.work_timezone == "Asia/Vladivostok" %}selected{% endif %}>Владивосток (UTC+10)</option>
                        <option value="Asia/Sakhalin" {% if company.work_timezone == "Asia/Sakhalin" %}selected{% endif %}>Сахалин (UTC+11)</option>
                        <option value="Asia/Magadan" {% if company.work_timezone == "Asia/Magadan" %}selected{% endif %}>Магадан (UTC+11)</option>
                        <option value="Asia/Kamchatka" {% if company.work_timezone == "Asia/Kamchatka" %}selected{% endif %}>Камчатка (UTC+12)</option>
                      </select>
                      <div class="flex gap-1 mt-1">
                        <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                        <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                      </div>
                      <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                    </div>
                  </div>
                {% else %}
                  {% if tz %}
                    <div>
                      <span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1">
                        <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                        · {{ tz|tz_label }}
                      </span>
                    </div>
                  {% else %}
                    —
                  {% endif %}
                {% endif %}
              {% endwith %}
              {% endwith %}
            </div>
            <div class="md:col-span-2">
              <div class="text-brand-dark/50">Адрес</div>
              {% if can_edit_company %}
                <div class="inline-field-wrapper" data-inline-field="address" data-company-id="{{ company.id }}" data-inline-display-kind="multiline">
                  <div class="relative" data-dd-root>
                    <div class="inline-field-trigger group" data-dd-toggle title="Клик: скопировать или изменить">
                      <div class="inline-field-display whitespace-pre-line min-w-0 hover:text-brand-dark/80 transition-colors">{{ company.address|default:"—" }}</div>
                      <svg class="inline-field-pencil" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125"/></svg>
                    </div>
                    <div class="hidden absolute left-0 mt-1 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-copy>Скопировать</button>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-inline-edit>Изменить</button>
                    </div>
                  </div>
                  <div class="inline-field-edit hidden mt-1">
                    <textarea class="input w-full" data-inline-input rows="3" maxlength="500" style="min-height:5.5rem;resize:vertical">{{ company.address|default:'' }}</textarea>
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                  </div>
                </div>
              {% else %}
                <div class="whitespace-pre-line">{{ company.address|default:"—" }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Поиск по карточке (скрыт по умолчанию) -->
    <div id="cardSearchModern" class="hidden mb-4">
      <div class="card card-pad">
        <div class="flex items-center gap-2">
          <input type="text" id="cardSearchInputModern" class="input flex-1" placeholder="Поиск по карточке (ИНН, телефон, комментарий, статус...)">
          <button type="button" class="btn btn-outline btn-sm" id="cardSearchCloseModern">✕</button>
        </div>
        <div id="cardSearchResultsModern" class="mt-2 text-sm text-brand-dark/60 hidden"></div>
      </div>
    </div>

    <!-- Старые блоки Modern (inline + details) удалены: теперь всё во вкладках -->
  </div>
  <!-- Конец современного режима -->

  <!-- Модальное окно для создания задачи -->
  <div id="taskCreateModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-create-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
      <div id="taskCreateModalContent"></div>
    </div>
  </div>

  <!-- Модальное окно для редактирования задач -->
  <div id="taskEditModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
      <div id="taskEditModalContent"></div>
    </div>
  </div>

  <script>
    (function() {
      // Просмотр изображений (вложения заметок) без новой вкладки
      const imgModal = document.getElementById('imagePreviewModal');
      const imgEl = document.getElementById('imagePreviewImg');
      const imgTitle = document.getElementById('imagePreviewTitle');
      const imgLoader = document.getElementById('imagePreviewLoader');
      const openLink = document.getElementById('imagePreviewOpenLink');
      const dlLink = document.getElementById('imagePreviewDownloadLink');

      function closeImgModal() {
        if (!imgModal) return;
        imgModal.classList.add('hidden');
        if (imgEl) {
          imgEl.classList.add('hidden');
          imgEl.removeAttribute('src');
          imgEl.alt = '';
        }
        if (imgLoader) imgLoader.style.display = '';
        if (imgTitle) imgTitle.textContent = 'Изображение';
        if (openLink) openLink.setAttribute('href', '#');
        if (dlLink) dlLink.setAttribute('href', '#');
      }

      function openImgModal(url, downloadUrl, title) {
        if (!imgModal || !imgEl) return;
        const u = (url || '').toString().trim();
        if (!u) return;
        if (imgTitle) imgTitle.textContent = (title || 'Изображение').toString();
        if (openLink) openLink.setAttribute('href', u);
        if (dlLink) dlLink.setAttribute('href', (downloadUrl || u).toString());
        if (imgLoader) imgLoader.style.display = '';
        imgEl.classList.add('hidden');
        imgEl.alt = (title || 'Изображение').toString();
        imgEl.onload = function() {
          if (imgLoader) imgLoader.style.display = 'none';
          imgEl.classList.remove('hidden');
        };
        imgEl.onerror = function() {
          if (imgLoader) imgLoader.textContent = 'Не удалось загрузить изображение.';
        };
        imgEl.src = u;
        imgModal.classList.remove('hidden');
      }

      // Делегирование кликов по кнопке "Открыть" для картинок
      document.addEventListener('click', function(e) {
        const btn = e.target.closest('.js-image-open');
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        openImgModal(
          btn.getAttribute('data-img-url') || '',
          btn.getAttribute('data-img-download') || '',
          btn.getAttribute('data-img-title') || 'Изображение'
        );
      });

      // Клик по карточке вложения (режим просмотра): картинка — модалка, PDF — новая вкладка, остальные — скачать
      document.addEventListener('click', function(e) {
        if (e.target.closest('[data-note-attachment-remove]')) return;
        const card = e.target.closest('.note-attachment-card:not(.note-attachment-card--editable)');
        if (!card) return;
        e.preventDefault();
        e.stopPropagation();
        const openUrl = card.getAttribute('data-open') || '';
        const downloadUrl = card.getAttribute('data-download') || openUrl;
        const isImage = card.getAttribute('data-is-image') === '1';
        const isPdf = card.getAttribute('data-is-pdf') === '1';
        const title = card.querySelector('.note-attachment-card__name')?.textContent?.trim() || 'Файл';
        if (isImage && openUrl && typeof openImgModal === 'function') {
          openImgModal(openUrl, downloadUrl, title);
        } else if ((isImage || isPdf) && openUrl) {
          window.open(openUrl, '_blank', 'noopener');
        } else if (downloadUrl) {
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.setAttribute('download', '');
          a.target = '_blank';
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
      });
      document.addEventListener('keydown', function(e) {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        const card = e.target.closest('.note-attachment-card:not(.note-attachment-card--editable)');
        if (!card) return;
        e.preventDefault();
        card.click();
      });

      // Закрытие модалки
      if (imgModal) {
        imgModal.querySelectorAll('[data-close-img]').forEach(b => b.addEventListener('click', function(e){ e.preventDefault(); closeImgModal(); }));
        imgModal.querySelector('[data-close-img]')?.addEventListener('click', function(e){ e.preventDefault(); closeImgModal(); });
        imgModal.querySelector('.bg-black\\/60')?.addEventListener('click', function(e){
          if (e.target === e.currentTarget) closeImgModal();
        });
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && !imgModal.classList.contains('hidden')) closeImgModal();
        });
      }

      // Модальное окно для создания задачи
      const createModal = document.getElementById('taskCreateModal');
      const createModalContent = document.getElementById('taskCreateModalContent');
      if (createModal && createModalContent) {
        function closeCreateModal() {
          createModal.classList.add('hidden');
          createModalContent.innerHTML = '';
        }
        
        document.addEventListener('click', (e) => {
          const closeBtn = e.target.closest('[data-close-task-create-modal]');
          if (closeBtn) {
            e.preventDefault();
            closeCreateModal();
          }
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !createModal.classList.contains('hidden')) closeCreateModal();
        });
        createModal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) closeCreateModal();
        });
        
        // Создание задачи
        document.querySelectorAll('[data-create-task]').forEach(btn => {
          btn.addEventListener('click', async function() {
            const companyId = this.dataset.companyId || '';
            const template = this.dataset.taskTemplate || '';
            let url = `/tasks/new/?modal=1${companyId ? '&company=' + companyId : ''}`;
            
            // Если шаблон "callback", добавляем предзаполнение даты
            if (template === 'callback') {
              const tomorrow = new Date();
              tomorrow.setDate(tomorrow.getDate() + 1);
              tomorrow.setHours(10, 0, 0, 0);
              url += `&due_at=${tomorrow.toISOString().slice(0, 16)}`;
            }
            
            try {
              const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
              if (!res.ok) throw new Error('Ошибка загрузки формы');
              const html = await res.text();
              createModalContent.innerHTML = html;
              createModal.classList.remove('hidden');
              
              // Если шаблон "callback", предзаполняем описание
              if (template === 'callback') {
                setTimeout(() => {
                  const descField = createModalContent.querySelector('textarea[name="description"]');
                  if (descField) {
                    descField.value = 'Перезвон клиенту';
                    descField.focus();
                  }
                }, 200);
              }
              
              // Инициализация select с небольшой задержкой для гарантии обновления DOM
              setTimeout(function() {
                if (window.initTaskTypeSelects) {
                  window.initTaskTypeSelects();
                }
                // Инициализация виджета выбора компании
                if (window.initMsSingleWidgets) {
                  window.initMsSingleWidgets(createModalContent);
                  
                  // Устанавливаем выбранную компанию после инициализации виджета
                  if (companyId) {
                    const companySelect = createModalContent.querySelector('select[name="company"], select#id_company');
                    if (companySelect) {
                      // Проставляем выбранное значение и обновляем ms‑виджет
                      companySelect.value = companyId;
                      companySelect.dispatchEvent(new Event('change', { bubbles: true }));
                      const msWidget = companySelect.closest('[data-ms-single="1"]');
                      if (msWidget) {
                        const valueEl = msWidget.querySelector('.ms-value');
                        const selectedOption = companySelect.options[companySelect.selectedIndex];
                        if (valueEl && selectedOption) {
                          valueEl.textContent = selectedOption.textContent.trim();
                        }
                      }
                      // Гарантированно подтягиваем флаги is_branch / has_branches и обновляем галку
                      fetch(`/companies/autocomplete/?id=${encodeURIComponent(companyId)}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                      })
                      .then(res => res.json())
                      .then(data => {
                        const company = (data.items || [])[0];
                        if (!company) return;
                        const opt = Array.from(companySelect.options).find(o => o.value === companyId);
                        if (!opt) return;
                        opt.dataset.isBranch = company.is_branch ? '1' : '0';
                        opt.dataset.hasBranches = company.has_branches ? '1' : '0';
                        if (window.updateApplyToOrgForModal) {
                          window.updateApplyToOrgForModal(createModalContent);
                        }
                      })
                      .catch(err => console.error('Ошибка загрузки компании:', err));
                    }
                  }
                }
              }, 150);
              
              const form = createModalContent.querySelector('[data-task-create-form]');
              if (form) {
                const typeSelect = form.querySelector('#id_type');
                const typeErrorBox = form.querySelector('[data-task-type-error]');
                const defaultTypeErrorMsg = 'Пожалуйста, выберите тип задачи в поле «Задача».';

                function setTypeError(msg) {
                  if (!typeErrorBox) return;
                  const m = (msg || '').trim();
                  typeErrorBox.textContent = m;
                  typeErrorBox.classList.toggle('hidden', !m);
                }

                if (typeSelect) {
                  typeSelect.addEventListener('change', () => {
                    const hasValue = Boolean(typeSelect.value && typeSelect.value !== '0');
                    setTypeError(hasValue ? '' : defaultTypeErrorMsg);
                  });
                }

                form.addEventListener('submit', async function(e) {
                  e.preventDefault();

                  // Защита от повторной отправки формы при медленном интернете / двойном клике
                  if (form.dataset.submitting === '1') {
                    return;
                  }
                  form.dataset.submitting = '1';

                  const submitBtn = form.querySelector('button[type="submit"]');
                  let originalBtnText = '';
                  if (submitBtn) {
                    originalBtnText = submitBtn.dataset.originalText || submitBtn.textContent || '';
                    submitBtn.dataset.originalText = originalBtnText;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Создание...';
                  }

                  const formData = new FormData(form);
                  try {
                    const res = await fetch(form.action, {
                      method: 'POST',
                      headers: { 'X-Requested-With': 'XMLHttpRequest' },
                      body: formData
                    });
                    
                    // Проверяем, является ли ответ JSON
                    const contentType = res.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                      const text = await res.text();
                      throw new Error('Сервер вернул не JSON ответ. Возможно, произошла ошибка на сервере.');
                    }
                    
                    const data = await res.json();
                    if (data.ok) {
                      closeCreateModal();
                      location.reload();
                    } else {
                      // Мягкая подсветка ошибки: показываем сообщение под полем «Задача»
                      let fieldMessage = '';
                      if (data.errors && data.errors.type) {
                        if (Array.isArray(data.errors.type)) {
                          fieldMessage = data.errors.type.join(', ');
                        } else if (typeof data.errors.type === 'object' && data.errors.type.length) {
                          fieldMessage = Array.from(data.errors.type).join(', ');
                        } else {
                          fieldMessage = String(data.errors.type);
                        }
                      }

                      const msg = fieldMessage || data.error || 'Проверьте заполнение формы задачи.';

                      setTypeError(fieldMessage || '');

                      if (!fieldMessage && window.uiToast) {
                        window.uiToast(msg, 'error');
                      } else if (!fieldMessage) {
                        console.warn('Ошибка создания задачи:', msg);
                      }
                    }
                  } catch (err) {
                    if (window.uiToast) {
                      window.uiToast('Ошибка при создании задачи: ' + err.message, 'error');
                    } else {
                      console.error('Ошибка при создании задачи:', err);
                    }
                  } finally {
                    form.dataset.submitting = '0';
                    if (submitBtn) {
                      submitBtn.disabled = false;
                      submitBtn.textContent = originalBtnText || submitBtn.dataset.originalText || submitBtn.textContent;
                    }
                  }
                }, { once: true });
              }
            } catch (err) {
              alert('Ошибка загрузки формы: ' + err.message);
            }
          });
        });
      }
      
      const modal = document.getElementById('taskEditModal');
      const modalContent = document.getElementById('taskEditModalContent');
      if (!modal || !modalContent) return;

      // Закрытие модалки
      function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
      }
      // Делегирование для динамически добавленных кнопок закрытия
      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-close-task-modal]');
        if (closeBtn) {
          e.preventDefault();
          closeModal();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });

      // Редактирование задачи
      document.querySelectorAll('[data-edit-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const taskId = this.dataset.taskId;
          const url = `/tasks/${taskId}/edit/?modal=1`;
          
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Ошибка загрузки формы');
            const html = await res.text();
            modalContent.innerHTML = html;
            modal.classList.remove('hidden');
            
            // Инициализация select для типа задачи с задержкой
            setTimeout(function() {
              if (window.initTaskTypeSelects) {
                window.initTaskTypeSelects();
              }
              // Инициализация виджета выбора компании
              if (window.initMsSingleWidgets) {
                window.initMsSingleWidgets(modalContent);
              }
            }, 100);
            
            // Обработка формы
            const form = modalContent.querySelector('[data-task-edit-form]');
            if (form) {
              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                
                try {
                  const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                  });
                  const data = await res.json();
                  if (data.ok) {
                    closeModal();
                    location.reload();
                  } else {
                    alert('Ошибка: ' + (data.error || 'Не удалось сохранить'));
                  }
                } catch (err) {
                  alert('Ошибка при сохранении: ' + err.message);
                }
              }, { once: true });
            }
          } catch (err) {
            alert('Ошибка загрузки формы: ' + err.message);
          }
        });
      });
    })();
  </script>

  <script>
    // Кнопка поиска из классического режима: плавный переход в Modern + открытие поиска
    (function() {
      const classicSearchBtn = document.getElementById('quickSearchBtnClassic');
      if (!classicSearchBtn) return;

      classicSearchBtn.addEventListener('click', function() {
        const viewModernBtn = document.getElementById('viewModeModernDetail');
        if (viewModernBtn) {
          viewModernBtn.click();
        }
        setTimeout(function() {
          const modernSearchBtn = document.getElementById('quickSearchBtnModern');
          if (modernSearchBtn) {
            modernSearchBtn.click();
          }
        }, 120);
      });
    })();
  </script>

  <div id="taskHistoryModal" class="fixed inset-0 z-[190] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-history></div>
    <div class="absolute inset-x-4 top-10 mx-auto max-w-3xl max-h-[90vh] overflow-y-auto">
      <div class="card card-pad">
        <div class="flex items-start justify-between gap-3 mb-4">
          <div class="flex-1">
            <h2 class="text-xl font-semibold text-brand-dark">История задач</h2>
            <div class="text-xs text-brand-dark/70">
              Выполненные задачи по компании «{{ company.name|default:"(без названия)" }}»
            </div>
          </div>
          <button
            type="button"
            class="btn btn-outline btn-sm flex-shrink-0"
            data-close-task-history
            aria-label="Закрыть"
            title="Закрыть"
          >
            ✕
          </button>
        </div>
        <div id="taskHistoryContent">
          <div class="text-center py-8">
            <svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"></path>
            </svg>
            <div class="text-sm text-brand-dark/70">Загрузка истории задач...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Гарантированная инициализация modern-модалки заметок после загрузки DOM.
    // Нужна, потому что основной скрипт может выполниться до вставки разметки modern-блока.
    (function() {
      function initModernNoteModal() {
        const modal = document.getElementById('noteEditModalModern');
        const form = document.getElementById('noteEditFormModern');
        const textarea = document.getElementById('noteEditTextModern');
        if (!modal || !form || !textarea) return;

        const fileInput = document.getElementById('noteEditFileModern');
        const fileCurrent = document.getElementById('noteEditFileCurrentModern');
        const fileSelected = document.getElementById('noteEditFileSelectedModern');
        const removeFile = document.getElementById('noteEditRemoveFileModern');
        const removeHidden = document.getElementById('noteEditRemoveHiddenModern');
        const titleEl = document.getElementById('noteEditTitleModern');
        const subtitleEl = document.getElementById('noteEditSubtitleModern');
        const removeRow = document.getElementById('noteEditRemoveRowModern');
        const extraList = document.getElementById('noteEditExtraAttachmentsListModern');
        const removeIds = document.getElementById('noteEditRemoveAttachmentIdsModern');
        const filesMulti = document.getElementById('noteEditFilesMultipleModern');
        const filesMultiNames = document.getElementById('noteEditFilesMultipleNamesModern');

        function closeModal() {
          modal.classList.add('hidden');
        }

        function openEdit(id, text, fileName, attachmentIdsStr, attachmentNamesStr) {
          form.action = `/companies/{{ company.id }}/notes/${id}/edit/`;
          textarea.value = text || '';
          if (fileInput) fileInput.value = '';
          if (fileSelected) fileSelected.textContent = '';
          if (removeFile) removeFile.checked = false;
          if (removeHidden) removeHidden.value = '0';
          if (fileCurrent) fileCurrent.innerHTML = fileName ? '<span class="note-file-chip inline-flex"><span class="truncate max-w-[180px]">' + (fileName.replace(/</g,'&lt;').replace(/"/g,'&quot;')) + '</span> (основной)</span>' : 'Основной файл: не выбран';
          if (titleEl) titleEl.textContent = 'Редактировать заметку';
          if (subtitleEl) subtitleEl.classList.remove('hidden');
          if (removeRow) removeRow.style.display = 'flex';
          if (removeIds) removeIds.value = '';
          if (filesMulti) filesMulti.value = '';
          if (filesMultiNames) filesMultiNames.textContent = '';
          const ids = (attachmentIdsStr || '').split(',').map(s => s.trim()).filter(Boolean);
          const names = (attachmentNamesStr || '').split('|||').map(s => s.trim());
          if (extraList) {
            extraList.innerHTML = '';
            ids.forEach((attId, i) => {
              const name = names[i] || 'Файл';
              const label = document.createElement('label');
              label.className = 'note-file-chip inline-flex items-center gap-2 cursor-pointer';
              const cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.className = 'note-edit-remove-attachment-modern';
              cb.dataset.attachmentId = attId;
              cb.addEventListener('change', () => {
                if (!removeIds) return;
                const checked = extraList.querySelectorAll('.note-edit-remove-attachment-modern:checked');
                removeIds.value = Array.from(checked).map(c => c.dataset.attachmentId).join(',');
              });
              label.appendChild(cb);
              var sp = document.createElement('span');
              sp.textContent = name;
              label.appendChild(sp);
              var sp2 = document.createElement('span');
              sp2.className = 'text-brand-dark/50 text-xs';
              sp2.textContent = ' (удалить)';
              label.appendChild(sp2);
              extraList.appendChild(label);
            });
          }
          modal.classList.remove('hidden');
          setTimeout(() => { try { textarea.focus(); } catch (_e) {} }, 0);
        }

        function openCreate() {
          form.action = `/companies/{{ company.id }}/notes/add/`;
          if (titleEl) titleEl.textContent = 'Новая заметка';
          if (subtitleEl) subtitleEl.classList.add('hidden');
          textarea.value = '';
          if (fileInput) fileInput.value = '';
          if (fileSelected) fileSelected.textContent = '';
          if (removeFile) removeFile.checked = false;
          if (removeHidden) removeHidden.value = '0';
          if (fileCurrent) fileCurrent.textContent = 'Основной файл: не выбран';
          if (removeRow) removeRow.style.display = 'none';
          modal.classList.remove('hidden');
          setTimeout(() => { try { textarea.focus(); } catch (_e) {} }, 0);
        }

        // Обновление заголовка/состояния файла при выборе
        if (fileInput && fileSelected) {
          fileInput.addEventListener('change', () => {
            const f = fileInput.files && fileInput.files.length ? fileInput.files[0] : null;
            fileSelected.textContent = f ? ('Выбран: ' + f.name) : '';
            if (removeFile) removeFile.checked = false;
            if (removeHidden) removeHidden.value = '0';
          });
        }
        if (removeFile) {
          removeFile.addEventListener('change', () => {
            if (removeHidden) removeHidden.value = removeFile.checked ? '1' : '0';
            if (removeFile.checked && fileInput) {
              fileInput.value = '';
              if (fileSelected) fileSelected.textContent = '';
            }
          });
        }

        // Отправка формы через AJAX с обновлением блока «Обзор»
        if (typeof window.fetch === 'function') {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            try {
              const resp = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
              });
              closeModal();
              if (!resp.ok) {
                window.location.reload();
                return;
              }
              if (window.uiToast) window.uiToast('Заметка обновлена.', 'success');
              try { await window.refreshOverviewNotes?.(); } catch (_e) {}
            } catch (err) {
              window.location.reload();
            }
          });
        }

        modal.querySelectorAll('[data-close-noteedit-modern]').forEach(btn => {
          btn.addEventListener('click', closeModal);
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeModal();
        });

        // Публикуем функции глобально для использования в других обработчиках
        window.openNoteEditModern = openEdit;
        window.openNoteCreateModern = openCreate;
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initModernNoteModal);
      } else {
        initModernNoteModal();
      }
    })();
  </script>

  <script>
    // История выполненных задач по компании (модалка)
    (function() {
      const btn = document.getElementById('taskHistoryButton');
      const modal = document.getElementById('taskHistoryModal');
      const content = document.getElementById('taskHistoryContent');

      if (!btn || !modal || !content) return;

      function openModal() {
        modal.classList.remove('hidden');
      }

      function closeModal() {
        modal.classList.add('hidden');
      }

      modal.querySelectorAll('[data-close-task-history]').forEach(el => {
        el.addEventListener('click', closeModal);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeModal();
        }
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });

      btn.addEventListener('click', async () => {
        openModal();
        content.innerHTML = `
          <div class="text-center py-8">
            <svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"></path>
            </svg>
            <div class="text-sm text-brand-dark/70">Загрузка истории задач...</div>
          </div>
        `;
        try {
          const res = await fetch(`/companies/{{ company.id }}/tasks/history/`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          if (!res.ok) {
            throw new Error('Ошибка загрузки истории задач');
          }
          const html = await res.text();
          content.innerHTML = html;

          // Повторно инициализируем обработчики открытия задачи в модальном окне по data-view-task
          if (typeof window.updateRelativeTimes === 'function') {
            window.updateRelativeTimes();
          }
        } catch (err) {
          console.error('Error loading task history:', err);
          const msg = err && err.message ? err.message : 'Ошибка загрузки истории задач';
          content.innerHTML = `<div class="text-center py-8 text-red-600">${msg}</div>`;
          if (window.uiToast) window.uiToast(msg, 'error');
        }
      });
    })();
  </script>

  <!-- Модальное окно для подтверждения удаления задачи с переносом в заметки -->
  <div id="taskDeleteModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-delete-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-md">
      <div class="bg-white border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Удалить задачу?</h2>
          <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-delete-modal aria-label="Закрыть" title="Закрыть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <p class="text-sm text-brand-dark/70">Нужно ли перенести данные задачи в заметки?</p>
          <div class="flex gap-2 pt-2 border-t">
            <button type="button" class="btn btn-primary flex-1" id="taskDeleteWithNote">Да, перенести</button>
            <button type="button" class="btn btn-outline flex-1" id="taskDeleteWithoutNote">Нет, удалить</button>
            <button type="button" class="btn btn-outline" data-close-task-delete-modal>Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для подтверждения выполнения задачи с переносом в заметки -->
  <div id="taskCompleteModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-complete-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-md">
      <div class="bg-white border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Отметить задачу как выполненную?</h2>
          <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-complete-modal aria-label="Закрыть" title="Закрыть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <p class="text-sm text-brand-dark/70">Нужно ли перенести данные задачи в заметки?</p>
          <div class="flex gap-2 pt-2 border-t">
            <button type="button" class="btn btn-primary flex-1" id="taskCompleteWithNote">Да, перенести</button>
            <button type="button" class="btn btn-outline flex-1" id="taskCompleteWithoutNote">Нет, только выполнить</button>
            <button type="button" class="btn btn-outline" data-close-task-complete-modal>Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      let currentTaskId = null;
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name=csrf-token]')?.content;

      // Модальное окно удаления задачи
      const deleteModal = document.getElementById('taskDeleteModal');
      const deleteBtns = document.querySelectorAll('[data-task-delete]');
      
      deleteBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          currentTaskId = this.dataset.taskId;
          deleteModal.classList.remove('hidden');
        });
      });

      function closeDeleteModal() {
        deleteModal.classList.add('hidden');
        currentTaskId = null;
      }

      deleteModal.querySelectorAll('[data-close-task-delete-modal]').forEach(b => {
        b.addEventListener('click', closeDeleteModal);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !deleteModal.classList.contains('hidden')) closeDeleteModal();
      });
      deleteModal.querySelector('.bg-black\\/35')?.addEventListener('click', function(e) {
        if (e.target === this) closeDeleteModal();
      });

      document.getElementById('taskDeleteWithNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('save_to_notes', '1');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/delete/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при удалении задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      document.getElementById('taskDeleteWithoutNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('save_to_notes', '0');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/delete/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при удалении задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      // Модальное окно выполнения задачи
      const completeModal = document.getElementById('taskCompleteModal');
      const completeBtns = document.querySelectorAll('[data-task-complete]');
      
      completeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          currentTaskId = this.dataset.taskId;
          completeModal.classList.remove('hidden');
        });
      });

      function closeCompleteModal() {
        completeModal.classList.add('hidden');
        currentTaskId = null;
      }

      completeModal.querySelectorAll('[data-close-task-complete-modal]').forEach(b => {
        b.addEventListener('click', closeCompleteModal);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !completeModal.classList.contains('hidden')) closeCompleteModal();
      });
      completeModal.querySelector('.bg-black\\/35')?.addEventListener('click', function(e) {
        if (e.target === this) closeCompleteModal();
      });

      document.getElementById('taskCompleteWithNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('status', 'done');
        formData.append('save_to_notes', '1');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/status/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при изменении статуса задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      document.getElementById('taskCompleteWithoutNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('status', 'done');
        formData.append('save_to_notes', '0');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/status/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при изменении статуса задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });
    })();

    // Обработка комментариев к телефонам
    (function() {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name=csrf-token]')?.content;
      
      // Обработчик клика на комментарий для редактирования
      document.addEventListener('click', function(e) {
        const editBtn = e.target.closest('[data-edit-comment]');
        if (!editBtn) return;
        
        const wrapper = editBtn.closest('.phone-comment-wrapper');
        if (!wrapper) return;
        
        const display = wrapper.querySelector('.phone-comment-display');
        const edit = wrapper.querySelector('.phone-comment-edit');
        const input = wrapper.querySelector('[data-comment-input]');
        
        if (display && edit && input) {
          display.classList.add('hidden');
          edit.classList.remove('hidden');
          input.focus();
          input.select();
        }
      });

      // Сохранение комментария
      document.addEventListener('click', function(e) {
        const saveBtn = e.target.closest('[data-save-comment]');
        if (!saveBtn) return;
        
        const wrapper = saveBtn.closest('.phone-comment-wrapper');
        if (!wrapper) return;
        
        const phoneType = wrapper.dataset.phoneType;
        const phoneId = wrapper.dataset.phoneId;
        const companyId = wrapper.dataset.companyId;
        const input = wrapper.querySelector('[data-comment-input]');
        
        if (!input) return;
        
        const comment = input.value.trim();
        let url = '';
        
        if (phoneType === 'main') {
          url = `/companies/${companyId}/main-phone/comment/`;
        } else if (phoneType === 'company') {
          url = `/company-phones/${phoneId}/comment/`;
        } else if (phoneType === 'contact') {
          url = `/contact-phones/${phoneId}/comment/`;
        } else {
          return;
        }
        
        const formData = new FormData();
        formData.append('comment', comment);
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(url, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            const display = wrapper.querySelector('.phone-comment-display');
            const edit = wrapper.querySelector('.phone-comment-edit');
            
            if (display && edit) {
              display.textContent = data.comment || 'Комментарий';
              display.classList.remove('hidden');
              edit.classList.add('hidden');
            }
          } else {
            alert(data.error || 'Ошибка при сохранении комментария');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      // Отмена редактирования
      document.addEventListener('click', function(e) {
        const cancelBtn = e.target.closest('[data-cancel-comment]');
        if (!cancelBtn) return;
        
        const wrapper = cancelBtn.closest('.phone-comment-wrapper');
        if (!wrapper) return;
        
        const display = wrapper.querySelector('.phone-comment-display');
        const edit = wrapper.querySelector('.phone-comment-edit');
        const input = wrapper.querySelector('[data-comment-input]');
        
        if (display && edit && input) {
          // Восстанавливаем исходное значение
          const originalComment = display.textContent.trim();
          input.value = originalComment === 'Комментарий' ? '' : originalComment;
          
          display.classList.remove('hidden');
          edit.classList.add('hidden');
        }
      });

      // Сохранение по Enter, отмена по Escape
      document.addEventListener('keydown', function(e) {
        const input = e.target.closest('[data-comment-input]');
        if (!input) return;
        
        const wrapper = input.closest('.phone-comment-wrapper');
        if (!wrapper) return;
        
        // В textarea Enter/Shift+Enter должны вставлять перенос строки.
        // Быстрое сохранение: Ctrl+Enter / Cmd+Enter.
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          const saveBtn = wrapper.querySelector('[data-save-comment]');
          if (saveBtn) saveBtn.click();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          const cancelBtn = wrapper.querySelector('[data-cancel-comment]');
          if (cancelBtn) cancelBtn.click();
        }
      });

      // Инлайн-редактирование базовых полей компании (как комментарии)
      (function() {
        // Не запускаем, если нет доступа к редактированию (инлайн-блоков нет)
        if (!document.querySelector('.inline-field-wrapper[data-company-id]')) return;

        function showError(wrapper, msg) {
          const err = wrapper.querySelector('[data-inline-error]');
          if (!err) return;
          err.textContent = (msg || '').trim();
          err.classList.toggle('hidden', !err.textContent);
        }

        function openEdit(wrapper) {
          const display = wrapper.querySelector('.inline-field-display');
          const edit = wrapper.querySelector('.inline-field-edit');
          const input = wrapper.querySelector('[data-inline-input]');
          if (!display || !edit || !input) return;
          if (wrapper.dataset.inlineOriginal === undefined) {
            wrapper.dataset.inlineOriginal = (input.value !== undefined ? input.value : (input.textContent || ''));
          }
          showError(wrapper, '');
          display.classList.add('hidden');
          edit.classList.remove('hidden');
          try {
            input.focus();
            if (input.select) input.select();
          } catch (e) {}
        }

        function closeEdit(wrapper, restore) {
          const display = wrapper.querySelector('.inline-field-display');
          const edit = wrapper.querySelector('.inline-field-edit');
          const input = wrapper.querySelector('[data-inline-input]');
          if (!display || !edit || !input) return;
          if (restore && wrapper.dataset.inlineOriginal !== undefined) {
            if (input.value !== undefined) input.value = wrapper.dataset.inlineOriginal;
            else input.textContent = wrapper.dataset.inlineOriginal;
          }
          showError(wrapper, '');
          display.classList.remove('hidden');
          edit.classList.add('hidden');
        }

        function normalizeWebsiteHref(raw) {
          const v = (raw || '').trim();
          if (!v) return '';
          if (v.includes('://')) return v;
          if (v.startsWith('//')) return 'https:' + v;
          return 'https://' + v;
        }

        function updateWebsiteDisplay(wrapper, newValue) {
          const display = wrapper.querySelector('[data-inline-display]');
          if (!display) return;
          const href = normalizeWebsiteHref(newValue);
          display.innerHTML = '';
          if (newValue && newValue.trim()) {
            const a = document.createElement('a');
            a.className = 'link break-all';
            a.href = href;
            a.target = '_blank';
            a.rel = 'noopener';
            a.textContent = newValue.trim();
            display.appendChild(a);
          } else {
            const span = document.createElement('span');
            span.className = 'text-brand-dark/70';
            span.textContent = '—';
            display.appendChild(span);
          }
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-outline btn-xs';
          btn.setAttribute('data-inline-edit', '');
          btn.title = 'Редактировать сайт';
          btn.textContent = 'Изменить';
          display.appendChild(btn);
        }

        function escapeHtml(s){
          return String(s || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        function updateTimezoneDisplay(wrapper, payload){
          const display = wrapper.querySelector('.inline-field-display');
          if (!display) return;
          const companyId = (wrapper.dataset.companyId || '').trim();
          const effectiveTz = (payload && payload.effective_tz) ? String(payload.effective_tz) : '';
          const label = (payload && payload.effective_label) ? String(payload.effective_label) : '';
          const nowHhmm = (payload && payload.effective_now_hhmm) ? String(payload.effective_now_hhmm) : '';

          if (!effectiveTz) {
            display.textContent = '—';
            return;
          }

          display.innerHTML =
            `<span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="${escapeHtml(companyId)}">` +
              `<span data-live-time data-live-tz="${escapeHtml(effectiveTz)}">${escapeHtml(nowHhmm || '--:--')}</span>` +
              ` · ${escapeHtml(label || effectiveTz)}` +
            `</span>`;
        }

        function updateCompanyTimezoneEverywhere(companyId, payload){
          const cid = (companyId || '').toString().trim();
          if (!cid) return;
          const effectiveTz = (payload && payload.effective_tz) ? String(payload.effective_tz) : '';
          const label = (payload && payload.effective_label) ? String(payload.effective_label) : '';
          const nowHhmm = (payload && payload.effective_now_hhmm) ? String(payload.effective_now_hhmm) : '';
          if (!effectiveTz) return;

          // 1) Все "бейджи TZ" в карточке компании
          document.querySelectorAll(`[data-company-tz-badge="1"][data-company-id="${cid}"]`).forEach(el => {
            try{
              el.innerHTML =
                `<span data-live-time data-live-tz="${escapeHtml(effectiveTz)}">${escapeHtml(nowHhmm || '--:--')}</span>` +
                ` · ${escapeHtml(label || effectiveTz)}`;
            }catch(_e){}
          });

          // 2) Все live-time элементы, которые привязаны к компании (рабочее время/статус звонка)
          document.querySelectorAll(`[data-live-worktime="1"][data-company-id="${cid}"] [data-live-time]`).forEach(span => {
            try{
              span.setAttribute('data-live-tz', effectiveTz);
              if (nowHhmm) span.textContent = nowHhmm;
            }catch(_e){}
          });
        }

        // Открыть редактирование (кнопка «Изменить» в меню инлайн-блока или в блоке сайта)
        document.addEventListener('click', function(e) {
          const editBtn = e.target.closest('[data-inline-edit]');
          if (!editBtn) return;
          const wrapper = editBtn.closest('.inline-field-wrapper');
          if (!wrapper) return;
          e.preventDefault();
          document.querySelectorAll('[data-dd-menu]').forEach(m => m.classList.add('hidden'));
          openEdit(wrapper);
        });

        // Скопировать текст инлайн-блока (кнопка «Скопировать» в меню)
        document.addEventListener('click', async function(e) {
          const copyBtn = e.target.closest('[data-inline-copy]');
          if (!copyBtn) return;
          const wrapper = copyBtn.closest('.inline-field-wrapper');
          if (!wrapper) return;
          e.preventDefault();
          const display = wrapper.querySelector('.inline-field-display');
          const text = display ? (display.textContent || '').trim() : '';
          if (!text) return;
          try {
            await navigator.clipboard.writeText(text);
            if (window.uiToast) window.uiToast('Скопировано', 'success');
          } catch (_err) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try {
              document.execCommand('copy');
              if (window.uiToast) window.uiToast('Скопировано', 'success');
            } catch (_e2) {
              if (window.uiToast) window.uiToast('Не удалось скопировать', 'error');
            }
            document.body.removeChild(ta);
          }
          document.querySelectorAll('[data-dd-menu]').forEach(m => m.classList.add('hidden'));
        });

        // Открыть ссылку (поле «Сайт»)
        document.addEventListener('click', function(e) {
          const openBtn = e.target.closest('[data-open-website]');
          if (!openBtn) return;
          const wrapper = openBtn.closest('.inline-field-wrapper[data-inline-field="website"]');
          if (!wrapper) return;
          e.preventDefault();
          const link = wrapper.querySelector('.inline-field-display a[href]');
          const input = wrapper.querySelector('[data-inline-input]');
          let url = link ? (link.getAttribute('href') || '').trim() : '';
          if (!url && input) url = (input.value || '').trim();
          if (url) {
            if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'https://' + url;
            window.open(url, '_blank', 'noopener');
          }
          document.querySelectorAll('[data-dd-menu]').forEach(m => m.classList.add('hidden'));
        });

        // Отмена
        document.addEventListener('click', function(e) {
          const cancelBtn = e.target.closest('[data-inline-cancel]');
          if (!cancelBtn) return;
          const wrapper = cancelBtn.closest('.inline-field-wrapper');
          if (!wrapper) return;
          e.preventDefault();
          closeEdit(wrapper, true);
        });

        // Сохранение
        document.addEventListener('click', function(e) {
          const saveBtn = e.target.closest('[data-inline-save]');
          if (!saveBtn) return;
          const wrapper = saveBtn.closest('.inline-field-wrapper');
          if (!wrapper) return;

          const field = (wrapper.dataset.inlineField || '').trim();
          const companyId = (wrapper.dataset.companyId || '').trim();
          const input = wrapper.querySelector('[data-inline-input]');
          if (!field || !companyId || !input) return;

          const value = (input.value !== undefined ? input.value : (input.textContent || '')).toString();

          const formData = new FormData();
          formData.append('field', field);
          formData.append('value', value);
          formData.append('csrfmiddlewaretoken', csrftoken);

          fetch(`/companies/${companyId}/inline/`, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
          .then(r => r.json().then(data => ({ ok: r.ok, status: r.status, data })))
          .then(({ ok, data }) => {
            if (!ok || !data.ok) {
              const msg = (data && (data.error || (data.errors && data.errors[field] && data.errors[field][0]))) || 'Ошибка сохранения.';
              showError(wrapper, msg);
              return;
            }

            const newVal = (data.value ?? '').toString();
            wrapper.dataset.inlineOriginal = newVal;

            // Обновляем display во всех блоках с этим полем (шапка + сайдбар)
            if (wrapper.dataset.inlineDisplayKind === 'website') {
              document.querySelectorAll(`.inline-field-wrapper[data-inline-field="${field}"][data-company-id="${companyId}"]`).forEach(w => {
                updateWebsiteDisplay(w, newVal);
              });
            } else if (wrapper.dataset.inlineDisplayKind === 'timezone') {
              updateTimezoneDisplay(wrapper, data);
              updateCompanyTimezoneEverywhere(companyId, data);
            } else {
              const placeholder = '—';
              const text = newVal && newVal.trim() ? newVal : placeholder;
              document.querySelectorAll(`.inline-field-wrapper[data-inline-field="${field}"][data-company-id="${companyId}"]`).forEach(w => {
                const display = w.querySelector('.inline-field-display');
                if (display) display.textContent = text;
              });
            }

            closeEdit(wrapper, false);
            try {
              if (window.UIWorktime && typeof window.UIWorktime.tick === 'function') {
                window.UIWorktime.tick();
              }
            } catch (_e) {}
          })
          .catch(err => {
            showError(wrapper, 'Ошибка: ' + err.message);
          });
        });

        // Автосохранение для поля "region": как только выбрали значение в селекте — сразу сохраняем
        document.addEventListener('change', function(e) {
          const select = e.target.closest('select[data-inline-input]');
          if (!select) return;
          const wrapper = select.closest('.inline-field-wrapper');
          if (!wrapper) return;
          if ((wrapper.dataset.inlineField || '').trim() !== 'region') return;
          const saveBtn = wrapper.querySelector('[data-inline-save]');
          if (saveBtn) {
            saveBtn.click();
          }
        });

        // Быстрые клавиши: Ctrl/Cmd+Enter сохранить, Esc отмена
        document.addEventListener('keydown', function(e) {
          const input = e.target.closest('[data-inline-input]');
          if (!input) return;
          const wrapper = input.closest('.inline-field-wrapper');
          if (!wrapper) return;

          if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            const saveBtn = wrapper.querySelector('[data-inline-save]');
            if (saveBtn) saveBtn.click();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            const cancelBtn = wrapper.querySelector('[data-inline-cancel]');
            if (cancelBtn) cancelBtn.click();
          }
        });
      })();

      // Добавление email в рассылочную кампанию (модалка)
      (function() {
        const modal = document.getElementById('addEmailToCampaignModal');
        const emailSpan = document.getElementById('addEmailValue');
        const select = document.getElementById('addEmailCampaignSelect');
        const confirmBtn = document.getElementById('addEmailConfirmBtn');
        if (!modal || !emailSpan || !select || !confirmBtn) return;

        let currentEmail = '';
        let currentCompanyId = '';

        function openModal(email, companyId) {
          currentEmail = email;
          currentCompanyId = companyId;
          emailSpan.textContent = email;
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        }

        function closeModal() {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          currentEmail = '';
          currentCompanyId = '';
        }

        async function loadCampaigns() {
          select.innerHTML = '<option value="">Загрузка...</option>';
          const res = await fetch('/mail/campaigns/pick/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || 'Не удалось загрузить кампании');
          const items = data.campaigns || [];
          if (!items.length) {
            select.innerHTML = '<option value="">Нет доступных кампаний</option>';
            return;
          }
          select.innerHTML = items.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        document.addEventListener('click', async (e) => {
          const btn = e.target.closest('.js-add-email-to-campaign');
          if (btn) {
            e.preventDefault();
            const email = btn.dataset.email || '';
            const companyId = btn.dataset.companyId || '';
            if (!email) return;
            openModal(email, companyId);
            try {
              await loadCampaigns();
            } catch (err) {
              alert('Ошибка: ' + err.message);
              closeModal();
            }
            return;
          }
          if (e.target === modal || e.target.closest('.js-close-add-email-modal')) {
            closeModal();
          }
        });

        confirmBtn.addEventListener('click', async () => {
          const campaignId = select.value;
          if (!campaignId) {
            alert('Выберите кампанию');
            return;
          }
          const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
          const fd = new FormData();
          fd.append('campaign_id', campaignId);
          fd.append('email', currentEmail);
          fd.append('company_id', currentCompanyId);
          if (csrf) fd.append('csrfmiddlewaretoken', csrf);

          try {
            const res = await fetch('/mail/campaigns/add-email/', { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await res.json();
            if (!data.ok) {
              alert(data.error || 'Не удалось добавить email');
              return;
            }
            alert(data.message || 'Email добавлен');
            closeModal();
          } catch (err) {
            alert('Ошибка: ' + err.message);
          }
        });
      })();
    })();
  </script>

  <script>
    // Копирование email при клике
    (function() {
      document.querySelectorAll('.js-copy-email').forEach(el => {
        el.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          const email = this.dataset.email || this.textContent.trim();
          if (!email) return;
          
          try {
            await navigator.clipboard.writeText(email);
            if (window.uiToast) {
              window.uiToast('Email скопирован: ' + email, 'success');
            }
          } catch (err) {
            // Fallback для старых браузеров
            const textarea = document.createElement('textarea');
            textarea.value = email;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand('copy');
              if (window.uiToast) {
                window.uiToast('Email скопирован: ' + email, 'success');
              }
            } catch (e) {
              if (window.uiToast) {
                window.uiToast('Не удалось скопировать email', 'error');
              }
            }
            document.body.removeChild(textarea);
          }
        });
      });
    })();
  </script>

  <script>
    // Dropdown меню для телефонов/email + копирование телефона + инлайн-редактирование phone/email
    (function() {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name=csrf-token]')?.content;

      function closeAll() {
        document.querySelectorAll('[data-dd-menu]').forEach(m => m.classList.add('hidden'));
      }

      document.addEventListener('click', function(e) {
        const toggle = e.target.closest('[data-dd-toggle]');
        if (toggle) {
          e.preventDefault();
          e.stopPropagation();
          const root = toggle.closest('[data-dd-root]');
          if (!root) return;
          const menu = root.querySelector('[data-dd-menu]');
          if (!menu) return;
          const isOpen = !menu.classList.contains('hidden');
          closeAll();
          if (!isOpen) menu.classList.remove('hidden');
          return;
        }
        // клик вне меню -> закрываем
        if (!e.target.closest('[data-dd-menu]')) closeAll();
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeAll();
      });

      // Договор: Скопировать (текст из data-contract-display)
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-contract-copy]');
        if (!btn) return;
        e.preventDefault();
        const root = btn.closest('[data-dd-root]');
        const display = root ? root.querySelector('[data-contract-display]') : null;
        const text = (display && display.textContent) ? display.textContent.trim() : '';
        if (!text) return;
        try {
          await navigator.clipboard.writeText(text);
          if (window.uiToast) window.uiToast('Скопировано', 'success');
        } catch (_err) {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            if (window.uiToast) window.uiToast('Скопировано', 'success');
          } catch (e2) {
            if (window.uiToast) window.uiToast('Не удалось скопировать', 'error');
          }
          document.body.removeChild(textarea);
        }
        closeAll();
      });

      // Договор: Изменить — открыть модалку
      document.addEventListener('click', function(e) {
        if (!e.target.closest('[data-open-contract-modal]')) return;
        e.preventDefault();
        closeAll();
        document.getElementById('openContractModal')?.click();
      });

      // Copy phone
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-copy-phone]');
        if (!btn) return;
        e.preventDefault();
        const phone = (btn.getAttribute('data-copy-phone') || '').trim();
        if (!phone) return;
        try {
          await navigator.clipboard.writeText(phone);
          if (window.uiToast) window.uiToast('Телефон скопирован: ' + phone, 'success');
        } catch (_err) {
          const textarea = document.createElement('textarea');
          textarea.value = phone;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            if (window.uiToast) window.uiToast('Телефон скопирован: ' + phone, 'success');
          } catch (e2) {
            if (window.uiToast) window.uiToast('Не удалось скопировать телефон', 'error');
          }
          document.body.removeChild(textarea);
        }
      });

      function showErr(el, msg) {
        if (!el) return;
        el.textContent = (msg || '').trim();
        el.classList.toggle('hidden', !el.textContent);
      }

      // Open edit blocks from menu
      document.addEventListener('click', function(e) {
        const btnMainPhone = e.target.closest('[data-edit-main-phone]');
        if (btnMainPhone) {
          e.preventDefault();
          closeAll();
          const edit = document.querySelector('[data-company-main-phone-edit]');
          const display = document.querySelector('[data-company-main-phone-display]');
          if (edit && display) {
            display.classList.add('hidden');
            edit.classList.remove('hidden');
            edit.querySelector('[data-company-main-phone-input]')?.focus();
          }
          return;
        }
        const btnPhone = e.target.closest('[data-edit-company-phone]');
        if (btnPhone) {
          e.preventDefault();
          closeAll();
          const id = btnPhone.getAttribute('data-edit-company-phone');
          const edit = document.querySelector(`[data-company-phone-edit="${id}"]`);
          const display = document.querySelector(`[data-company-phone-display="${id}"]`);
          if (edit && display) {
            display.classList.add('hidden');
            edit.classList.remove('hidden');
            edit.querySelector('[data-company-phone-input]')?.focus();
          }
          return;
        }
        const btnMainEmail = e.target.closest('[data-edit-main-email]');
        if (btnMainEmail) {
          e.preventDefault();
          closeAll();
          const edit = document.querySelector('[data-company-main-email-edit]');
          const display = document.querySelector('[data-company-main-email-display]');
          if (edit && display) {
            display.classList.add('hidden');
            edit.classList.remove('hidden');
            edit.querySelector('[data-company-main-email-input]')?.focus();
          }
          return;
        }
        const btnEmail = e.target.closest('[data-edit-company-email]');
        if (btnEmail) {
          e.preventDefault();
          closeAll();
          const id = btnEmail.getAttribute('data-edit-company-email');
          const edit = document.querySelector(`[data-company-email-edit="${id}"]`);
          const display = document.querySelector(`[data-company-email-display="${id}"]`);
          if (edit && display) {
            display.classList.add('hidden');
            edit.classList.remove('hidden');
            edit.querySelector('[data-company-email-input]')?.focus();
          }
          return;
        }

        const btnAddCompanyPhone = e.target.closest('[data-add-company-phone]');
        if (btnAddCompanyPhone) {
          e.preventDefault();
          closeAll();
          const box = document.querySelector('[data-company-phone-add]');
          if (box) {
            box.classList.remove('hidden');
            box.querySelector('[data-company-phone-add-input]')?.focus();
          }
          return;
        }
      });

      // Cancel buttons
      document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-company-main-phone-cancel]');
        if (btn) {
          e.preventDefault();
          const edit = document.querySelector('[data-company-main-phone-edit]');
          const display = document.querySelector('[data-company-main-phone-display]');
          edit?.classList.add('hidden');
          display?.classList.remove('hidden');
          showErr(document.querySelector('[data-company-main-phone-error]'), '');
          return;
        }
        const btn2 = e.target.closest('[data-company-phone-cancel]');
        if (btn2) {
          e.preventDefault();
          const id = btn2.getAttribute('data-company-phone-cancel');
          document.querySelector(`[data-company-phone-edit="${id}"]`)?.classList.add('hidden');
          document.querySelector(`[data-company-phone-display="${id}"]`)?.classList.remove('hidden');
          showErr(document.querySelector(`[data-company-phone-error="${id}"]`), '');
          return;
        }
        const b3 = e.target.closest('[data-company-main-email-cancel]');
        if (b3) {
          e.preventDefault();
          document.querySelector('[data-company-main-email-edit]')?.classList.add('hidden');
          document.querySelector('[data-company-main-email-display]')?.classList.remove('hidden');
          showErr(document.querySelector('[data-company-main-email-error]'), '');
          return;
        }
        const b4 = e.target.closest('[data-company-email-cancel]');
        if (b4) {
          e.preventDefault();
          const id = b4.getAttribute('data-company-email-cancel');
          document.querySelector(`[data-company-email-edit="${id}"]`)?.classList.add('hidden');
          document.querySelector(`[data-company-email-display="${id}"]`)?.classList.remove('hidden');
          showErr(document.querySelector(`[data-company-email-error="${id}"]`), '');
          return;
        }

        const addCancel = e.target.closest('[data-company-phone-add-cancel]');
        if (addCancel) {
          e.preventDefault();
          const box = document.querySelector('[data-company-phone-add]');
          box?.classList.add('hidden');
          showErr(document.querySelector('[data-company-phone-add-error]'), '');
          return;
        }
      });

      async function postForm(url, data) {
        const fd = new FormData();
        for (const [k, v] of Object.entries(data)) fd.append(k, v);
        if (csrftoken) fd.append('csrfmiddlewaretoken', csrftoken);
        const res = await fetch(url, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const json = await res.json().catch(() => ({}));
        return { ok: res.ok, data: json };
      }

      // Save: main phone
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-main-phone-save]');
        if (!btn) return;
        e.preventDefault();
        const input = document.querySelector('[data-company-main-phone-input]');
        const err = document.querySelector('[data-company-main-phone-error]');
        const display = document.querySelector('[data-company-main-phone-display]');
        if (!input || !display) return;
        const val = (input.value || '').trim();
        const companyId = '{{ company.id }}';
        const { ok, data } = await postForm(`/companies/${companyId}/main-phone/update/`, { phone: val });
        if (!ok || !data.success) {
          showErr(err, data.error || 'Ошибка сохранения телефона.');
          return;
        }
        display.textContent = data.display || '—';
        const local = document.querySelector('[data-company-main-phone-local]');
        if (local && data.local_info !== undefined) {
          // local может быть контейнером с badge внутри
          const badge = local.querySelector('.badge');
          if (badge) {
            badge.textContent = data.local_info || '';
          } else {
            local.textContent = data.local_info || '';
          }
          local.classList.toggle('hidden', !(data.local_info || '').trim());
        }
        document.querySelector('[data-company-main-phone-edit]')?.classList.add('hidden');
        display.classList.remove('hidden');
        showErr(err, '');
      });

      // Save: company phone
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-phone-save]');
        if (!btn) return;
        e.preventDefault();
        const id = btn.getAttribute('data-company-phone-save');
        const input = document.querySelector(`[data-company-phone-edit="${id}"] [data-company-phone-input]`);
        const err = document.querySelector(`[data-company-phone-error="${id}"]`);
        const display = document.querySelector(`[data-company-phone-display="${id}"]`);
        if (!input || !display) return;
        const val = (input.value || '').trim();
        const { ok, data } = await postForm(`/company-phones/${id}/update/`, { phone: val });
        if (!ok || !data.success) {
          showErr(err, data.error || 'Ошибка сохранения телефона.');
          return;
        }
        display.textContent = data.display || '—';
        const local = document.querySelector(`[data-company-phone-local="${id}"]`);
        if (local && data.local_info !== undefined) {
          const badge = local.querySelector('.badge');
          if (badge) {
            badge.textContent = data.local_info || '';
          } else {
            local.textContent = data.local_info || '';
          }
          local.classList.toggle('hidden', !(data.local_info || '').trim());
        }
        document.querySelector(`[data-company-phone-edit="${id}"]`)?.classList.add('hidden');
        display.classList.remove('hidden');
        showErr(err, '');
      });

      function extractPhonesForAdd(text) {
        const src = String(text || '');
        const re = /(\+?\d[\d()\s\-]{8,}\d)/g;
        const matches = [];
        let m;
        while ((m = re.exec(src)) !== null) matches.push(m[1]);
        const candidates = matches.length ? matches : src.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean);
        return candidates.map(s => (s || '').trim()).filter(Boolean);
      }

      function renderCompanyPhoneItem(phoneId, rawPhone, displayText) {
        const companyId = '{{ company.id }}';
        return `
          <div>
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="font-mono text-xs" data-company-phone-display="${phoneId}">${displayText || '—'}</div>
                <div class="text-[11px] muted-2 mt-0.5 ${rawPhone ? '' : 'hidden'}" data-company-phone-local="${phoneId}"></div>
                <div class="hidden mt-1" data-company-phone-edit="${phoneId}">
                  <input class="input text-xs" data-company-phone-input value="${rawPhone || ''}" placeholder="+7..." style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:15rem" />
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-company-phone-save="${phoneId}">Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-company-phone-cancel="${phoneId}">Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-company-phone-error="${phoneId}"></div>
                </div>
              </div>
              <div class="relative shrink-0" data-dd-root>
                <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                  <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-call-phone" data-phone="${rawPhone || ''}" data-company="${companyId}" data-contact="">Позвонить</button>
                  <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-copy-phone="${rawPhone || ''}">Скопировать</button>
                  <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-company-phone="${phoneId}">Изменить</button>
                </div>
              </div>
            </div>
            <div class="mt-1">
              <div class="phone-comment-wrapper" data-phone-type="company" data-phone-id="${phoneId}">
                <div class="phone-comment-display text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70 transition-colors" data-edit-comment style="white-space: pre-wrap;">Комментарий</div>
                <div class="phone-comment-edit hidden mt-1">
                  <textarea class="input text-xs" placeholder="Комментарий к номеру" maxlength="255" data-comment-input rows="2" style="padding:.35rem .5rem;font-size:.75rem;min-height:3.25rem;resize:vertical"></textarea>
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-save-comment>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-cancel-comment>Отмена</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Save: add company phone(s)
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-phone-add-save]');
        if (!btn) return;
        e.preventDefault();
        const companyId = '{{ company.id }}';
        const input = document.querySelector('[data-company-phone-add-input]');
        const err = document.querySelector('[data-company-phone-add-error]');
        const list = document.querySelector('[data-company-phones-list]');
        if (!input || !list) return;
        const raw = (input.value || '').trim();
        const items = extractPhonesForAdd(raw);
        if (!items.length) {
          showErr(err, 'Введите телефон.');
          return;
        }
        showErr(err, '');

        for (const phoneRaw of items) {
          const { ok, data } = await postForm(`/companies/${companyId}/phones/create/`, { phone: phoneRaw });
          if (!ok || !data.success) {
            showErr(err, data.error || 'Ошибка добавления телефона.');
            return;
          }
          // Убираем "—" если он был в пустом списке
          const emptyMark = list.querySelector('.muted-2');
          if (emptyMark && emptyMark.textContent.trim() === '—') emptyMark.remove();
          const wrapper = document.createElement('div');
          wrapper.innerHTML = renderCompanyPhoneItem(data.id, data.phone, data.display);
          // Добавляем как отдельный элемент списка (вверх)
          list.prepend(wrapper.firstElementChild);
          // Заполняем local_info если пришёл
          if (data.local_info) {
            const el = list.querySelector(`[data-company-phone-local="${data.id}"]`);
            if (el) {
              el.textContent = data.local_info;
              el.classList.remove('hidden');
            }
          }
        }

        input.value = '';
        document.querySelector('[data-company-phone-add]')?.classList.add('hidden');
      });

      // Bulk paste into add phone input
      document.addEventListener('paste', function(e) {
        const t = e.target;
        if (!t || !t.closest || !t.closest('[data-company-phone-add]')) return;
        if (!t.matches('[data-company-phone-add-input]')) return;
        const txt = (e.clipboardData || window.clipboardData).getData('text');
        const items = extractPhonesForAdd(txt);
        if (items.length <= 1) return;
        e.preventDefault();
        t.value = items.join('\n');
      });

      // Save: main email
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-main-email-save]');
        if (!btn) return;
        e.preventDefault();
        const input = document.querySelector('[data-company-main-email-input]');
        const err = document.querySelector('[data-company-main-email-error]');
        const display = document.querySelector('[data-company-main-email-display]');
        if (!input || !display) return;
        const val = (input.value || '').trim();
        const companyId = '{{ company.id }}';
        const { ok, data } = await postForm(`/companies/${companyId}/main-email/update/`, { email: val });
        if (!ok || !data.success) {
          showErr(err, data.error || 'Ошибка сохранения email.');
          return;
        }
        display.textContent = data.email || '';
        document.querySelector('[data-company-main-email-edit]')?.classList.add('hidden');
        display.classList.remove('hidden');
        showErr(err, '');
      });

      // Save: company email
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-email-save]');
        if (!btn) return;
        e.preventDefault();
        const id = btn.getAttribute('data-company-email-save');
        const input = document.querySelector(`[data-company-email-edit="${id}"] [data-company-email-input]`);
        const err = document.querySelector(`[data-company-email-error="${id}"]`);
        const display = document.querySelector(`[data-company-email-display="${id}"]`);
        if (!input || !display) return;
        const val = (input.value || '').trim();
        const { ok, data } = await postForm(`/company-emails/${id}/update/`, { email: val });
        if (!ok || !data.success) {
          showErr(err, data.error || 'Ошибка сохранения email.');
          return;
        }
        display.textContent = data.email || '';
        document.querySelector(`[data-company-email-edit="${id}"]`)?.classList.add('hidden');
        display.classList.remove('hidden');
        showErr(err, '');
      });
    })();
  </script>

  <script>
    // Открытие модалки задачи из карточки компании
    (function() {
      const modal = document.getElementById('taskViewModal');
      if (!modal) {
        // Создаем модалку, если её нет (как на dashboard)
        const modalHtml = `
          <div id="taskViewModal" class="fixed inset-0 z-[200] hidden">
            <div class="fixed inset-0 bg-black/35" data-close-task-view></div>
            <div class="absolute inset-x-4 top-12 mx-auto max-w-2xl max-h-[90vh] overflow-y-auto">
              <div class="card card-pad">
                <div class="flex items-start justify-between gap-3 mb-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2" id="taskViewBadges"></div>
                    <h2 class="text-xl font-semibold text-brand-dark" id="taskViewTitle">Загрузка...</h2>
                  </div>
                  <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-view aria-label="Закрыть" title="Закрыть">✕</button>
                </div>
                <div id="taskViewContent">
                  <div class="text-center py-8">
                    <svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 12a9 9 0 11-6.219-8.56"/>
                    </svg>
                    <div class="text-sm text-brand-dark/70">Загрузка задачи...</div>
                  </div>
                </div>
                <div class="flex flex-wrap items-center gap-2 pt-4 mt-4 border-t" id="taskViewActions" style="display:none">
                  <button type="button" class="btn btn-outline btn-sm" id="taskViewEdit" style="display:none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                    </svg>
                    Редактировать
                  </button>
                  <form method="post" action="" id="taskViewInProgressForm" style="display:none" class="inline">
                    {% csrf_token %}
                    <button type="submit" name="status" value="in_progress" class="btn btn-secondary text-sm">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
                        <path d="M8 2v4"/><path d="M16 2v4"/><path d="M8 10h8"/><path d="M8 14h8"/>
                      </svg>
                      В работу
                    </button>
                  </form>
                  <button type="button" class="btn btn-primary btn-sm" id="taskViewComplete" style="display:none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Выполнено
                  </button>
                  <button type="button" class="btn btn-outline btn-sm btn-danger" id="taskViewDelete" style="display:none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7"/>
                    </svg>
                    Удалить
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      const modalContent = document.getElementById('taskViewContent');
      const modalTitle = document.getElementById('taskViewTitle');
      const modalBadges = document.getElementById('taskViewBadges');
      const modalActions = document.getElementById('taskViewActions');
      const btnEdit = document.getElementById('taskViewEdit');
      const btnInProgress = document.getElementById('taskViewInProgressForm');
      const btnComplete = document.getElementById('taskViewComplete');
      const btnDelete = document.getElementById('taskViewDelete');
      
      function closeModal() {
        if (modal) modal.classList.add('hidden');
        if (modalContent) modalContent.innerHTML = '<div class="text-center py-8"><svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg><div class="text-sm text-brand-dark/70">Загрузка задачи...</div></div>';
        if (modalTitle) modalTitle.textContent = 'Загрузка...';
        if (modalBadges) modalBadges.innerHTML = '';
        if (modalActions) modalActions.style.display = 'none';
      }
      
      function openModal() {
        if (modal) modal.classList.remove('hidden');
      }
      
      // Закрытие модалки
      if (modal) {
        modal.querySelectorAll('[data-close-task-view]').forEach(btn => {
          btn.addEventListener('click', closeModal);
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
        });
        modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) closeModal();
        });
      }

      // Инициализация обработчиков открытия задачи в модальном окне
      function initTaskViewModalTriggers(root) {
        const scope = root || document;
        scope.querySelectorAll('[data-view-task]').forEach(btn => {
          if (btn._taskViewBound) return;
          btn._taskViewBound = true;

          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const taskId = this.dataset.taskId;
            if (!taskId) return;

            openModal();

            try {
              const res = await fetch(`/tasks/${taskId}/`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
              });
              if (!res.ok) {
                let errorMsg = 'Ошибка загрузки задачи';
                if (res.status === 403) {
                  errorMsg = 'Нет прав на просмотр этой задачи';
                } else if (res.status === 404) {
                  errorMsg = 'Задача не найдена';
                }
                throw new Error(errorMsg);
              }
              const html = await res.text();

              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              const taskModal = doc.querySelector('#taskViewModal');

              if (taskModal) {
                const card = taskModal.querySelector('.card');
                if (card) {
                  const contentDiv = card.querySelector('.space-y-3');
                  if (contentDiv) {
                    if (modalContent) modalContent.innerHTML = contentDiv.outerHTML;
                  } else {
                    const allContent = card.innerHTML;
                    const titleMatch = allContent.match(/<h2[^>]*>.*?<\/h2>/);
                    if (modalContent) modalContent.innerHTML = allContent.replace(titleMatch?.[0] || '', '');
                  }

                  const titleEl = taskModal.querySelector('h2');
                  if (titleEl && modalTitle) modalTitle.textContent = titleEl.textContent.trim();

                  const badgeContainer = taskModal.querySelector('.flex.items-center.gap-2');
                  if (badgeContainer && modalBadges) {
                    const badge = badgeContainer.querySelector('.badge, .inline-flex.items-center.gap-1');
                    if (badge) modalBadges.innerHTML = badge.outerHTML;
                  }

                  const editLink = taskModal.querySelector('a[href*="/tasks/"][href*="/edit/"]');
                  const editButton = taskModal.querySelector('button[data-edit-task]');
                  const canEdit = editLink || editButton;

                  const statusBadge = taskModal.querySelector('.badge');
                  let status = 'new';
                  if (statusBadge) {
                    const badgeText = statusBadge.textContent.toLowerCase();
                    if (badgeText.includes('работа') || badgeText.includes('progress')) status = 'in_progress';
                    else if (badgeText.includes('выполн') || badgeText.includes('done')) status = 'done';
                    else if (badgeText.includes('отмен') || badgeText.includes('cancel')) status = 'cancelled';
                  }

                  if (modalActions) {
                    modalActions.style.display = 'flex';

                    if (btnEdit) {
                      btnEdit.style.display = canEdit ? 'inline-flex' : 'none';
                      if (canEdit) {
                        btnEdit.onclick = async () => {
                          const url = `/tasks/${taskId}/edit/?modal=1`;
                          try {
                            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                            if (!res.ok) throw new Error('Ошибка загрузки формы');
                            const html = await res.text();
                            const editModal = document.getElementById('taskEditModal');
                            const editModalContent = document.getElementById('taskEditModalContent');
                            if (editModal && editModalContent) {
                              editModalContent.innerHTML = html;
                              editModal.classList.remove('hidden');
                              if (modal) modal.classList.add('hidden');
                              if (window.initTaskTypeSelects) window.initTaskTypeSelects();
                              if (window.initMsSingleWidgets) window.initMsSingleWidgets(editModalContent);
                            }
                          } catch (err) {
                            console.error('Error loading edit form:', err);
                            if (window.uiToast) window.uiToast('Ошибка загрузки формы редактирования', 'error');
                          }
                        };
                      }
                    }

                    if (btnInProgress) {
                      btnInProgress.style.display = (status === 'new' && canEdit) ? 'inline-block' : 'none';
                      if (status === 'new' && canEdit) {
                        btnInProgress.action = `/tasks/${taskId}/status/`;
                      }
                    }

                    if (btnComplete) {
                      btnComplete.style.display = (status !== 'done' && status !== 'cancelled' && canEdit) ? 'inline-flex' : 'none';
                      if (status !== 'done' && status !== 'cancelled' && canEdit) {
                        btnComplete.onclick = () => {
                          const completeModal = document.getElementById('taskCompleteModal');
                          if (completeModal) {
                            completeModal.classList.remove('hidden');
                            if (modal) modal.classList.add('hidden');
                            const form = completeModal.querySelector('form');
                            if (form) form.action = `/tasks/${taskId}/status/`;
                          }
                        };
                      }
                    }

                    if (btnDelete) {
                      btnDelete.style.display = canEdit ? 'inline-flex' : 'none';
                      if (canEdit) {
                        btnDelete.onclick = () => {
                          const deleteModal = document.getElementById('taskDeleteModal');
                          if (deleteModal) {
                            deleteModal.classList.remove('hidden');
                            if (modal) modal.classList.add('hidden');
                            const form = deleteModal.querySelector('form');
                            if (form) form.action = `/tasks/${taskId}/delete/`;
                          }
                        };
                      }
                    }
                  }
                }
              }
            } catch (error) {
              console.error('Error loading task:', error);
              const errorMsg = error.message || 'Ошибка загрузки задачи';
              if (modalContent) modalContent.innerHTML = `<div class="text-center py-8 text-red-600">${errorMsg}</div>`;
              if (window.uiToast) window.uiToast(errorMsg, 'error');
            }
          });
        });
      }

      // Инициализируем сразу для уже отрисованных задач
      initTaskViewModalTriggers(document);
      // Делаем функцию доступной глобально, чтобы можно было вызывать после подгрузки HTML (история задач)
      window.initTaskViewModalTriggers = initTaskViewModalTriggers;
    })();
  </script>
  <script>
    // Немодальная панель контакта: открывается поверх, но НЕ блокирует фон (можно копировать данные из карточки)
    (function() {
      const panel = document.getElementById('contactPanel');
      const body = document.getElementById('contactPanelBody');
      if (!panel || !body) return;

      let currentAbort = null;
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };

      function enhanceContactForm() {
        const root = body.querySelector('[data-contact-form-root]');
        if (!root) return;

        const EMAIL_TYPE_GROUPS = {
          work: ['work'],
          personal: ['personal'],
          other: ['other'],
        };
        const PHONE_TYPE_GROUPS = {
          work: ['work', 'work_direct', 'fax'],
          personal: ['mobile', 'home'],
          other: ['other'],
        };

        function getValueInput(row, prefix) {
          return row.querySelector(`input[name^="${prefix}-"][name$="-value"]`);
        }

        function getIdInput(row, prefix) {
          return row.querySelector(`input[type="hidden"][name^="${prefix}-"][name$="-id"]`);
        }

        function getDeleteInput(row, prefix) {
          return row.querySelector(`input[type="checkbox"][name^="${prefix}-"][name$="-DELETE"]`);
        }

        function isRowEmpty(row, prefix) {
          const valueInput = getValueInput(row, prefix);
          const idInput = getIdInput(row, prefix);
          const hasErrors = !!row.querySelector('.text-brand-orange');
          const hasValue = valueInput && valueInput.value.trim() !== '';
          const hasId = idInput && idInput.value;
          return !hasErrors && !hasValue && !hasId;
        }

        function setupTypeToggle(row, kind) {
          const toggleRoot = row.querySelector('[data-type-toggle]');
          if (!toggleRoot) return;
          const select = row.querySelector('select');
          if (!select) return;
          const cfg = kind === 'email' ? EMAIL_TYPE_GROUPS : PHONE_TYPE_GROUPS;
          const buttons = Array.from(toggleRoot.querySelectorAll('[data-type-group]'));

          function applyActive() {
            buttons.forEach(btn => {
              const group = btn.dataset.typeGroup;
              const values = cfg[group] || [];
              if (values.includes(select.value)) {
                btn.classList.add('bg-brand-soft', 'border-brand-teal', 'text-brand-dark');
                btn.classList.remove('border-transparent');
              } else {
                btn.classList.remove('bg-brand-soft', 'border-brand-teal', 'text-brand-dark');
                btn.classList.add('border-transparent');
              }
            });
          }

          buttons.forEach(btn => {
            btn.addEventListener('click', () => {
              const group = btn.dataset.typeGroup;
              const values = cfg[group] || [];
              if (!values.length) return;
              if (values.includes(select.value)) {
                applyActive();
                return;
              }
              const optionValues = Array.from(select.options).map(o => o.value);
              const target = values.find(v => optionValues.includes(v));
              if (!target) return;
              select.value = target;
              applyActive();
            });
          });

          applyActive();
        }

        function initRow(row, prefix, kind) {
          // Скрываем пустые строки
          if (isRowEmpty(row, prefix)) {
            row.classList.add('hidden');
          } else {
            row.classList.remove('hidden');
          }

          const delBtn = row.querySelector('[data-row-delete]');
          if (delBtn) {
            delBtn.addEventListener('click', () => {
              const valueInput = getValueInput(row, prefix);
              const idInput = getIdInput(row, prefix);
              const delInput = getDeleteInput(row, prefix);
              const hasId = idInput && idInput.value;
              const hasValue = valueInput && valueInput.value.trim() !== '';
              const msg = hasId || hasValue ? 'Действительно хотите удалить?' : 'Удалить строку?';
              if (!window.confirm(msg)) return;

              if (hasId && delInput) {
                delInput.checked = true;
                row.classList.add('hidden');
              } else if (valueInput) {
                valueInput.value = '';
                row.classList.add('hidden');
              } else {
                row.classList.add('hidden');
              }
            });
          }

          if (kind === 'email' || kind === 'phone') {
            setupTypeToggle(row, kind);
          }
        }

        function setupFormset(prefix, kind) {
          const container = root.querySelector(`[data-${prefix}-container]`);
          if (!container) return;

          const rows = Array.from(container.querySelectorAll(`[data-form-row="${prefix}"]`));
          rows.forEach(row => initRow(row, prefix, kind));

          const addBtn = root.querySelector(`[data-${prefix}-add]`);
          if (addBtn) {
            addBtn.addEventListener('click', () => {
              const currentRows = Array.from(container.querySelectorAll(`[data-form-row="${prefix}"]`));
              const emptyRow = currentRows.find(r => isRowEmpty(r, prefix) || r.classList.contains('hidden'));
              if (!emptyRow) {
                if (window.uiToast) {
                  window.uiToast(prefix === 'emails' ? 'Больше полей для email не осталось' : 'Больше полей для телефонов не осталось', 'info');
                }
                return;
              }
              emptyRow.classList.remove('hidden');
              const valueInput = getValueInput(emptyRow, prefix);
              const delInput = getDeleteInput(emptyRow, prefix);
              if (valueInput) valueInput.value = '';
              if (delInput) delInput.checked = false;
              const select = emptyRow.querySelector('select');
              if (select && select.options.length) {
                // Сбрасываем тип к первому варианту, если это новая строка
                const idInput = getIdInput(emptyRow, prefix);
                if (!idInput || !idInput.value) {
                  select.value = select.options[0].value;
                }
              }
              if (kind === 'email' || kind === 'phone') {
                setupTypeToggle(emptyRow, kind);
              }
              if (valueInput) {
                setTimeout(() => valueInput.focus(), 10);
              }
            });
          }
        }

        setupFormset('emails', 'email');
        setupFormset('phones', 'phone');
      }

      function openPanel() {
        panel.classList.remove('hidden');
      }
      function closePanel() {
        panel.classList.add('hidden');
        body.innerHTML = '';
        if (currentAbort) {
          try { currentAbort.abort(); } catch (_e) {}
          currentAbort = null;
        }
      }

      // Drag & Drop для панели
      const panelHeader = panel.querySelector('.bg-white');
      if (panelHeader) {
        panelHeader.style.cursor = 'move';
        panelHeader.addEventListener('mousedown', (e) => {
          if (e.target.closest('button, input, select, textarea, a')) return;
          isDragging = true;
          const rect = panel.getBoundingClientRect();
          dragOffset.x = e.clientX - rect.left;
          dragOffset.y = e.clientY - rect.top;
          panel.style.cursor = 'move';
          e.preventDefault();
        });
      }

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const maxX = window.innerWidth - panel.offsetWidth;
        const maxY = window.innerHeight - panel.offsetHeight;
        let x = e.clientX - dragOffset.x;
        let y = e.clientY - dragOffset.y;
        x = Math.max(0, Math.min(x, maxX));
        y = Math.max(0, Math.min(y, maxY));
        panel.style.left = x + 'px';
        panel.style.right = 'auto';
        panel.style.top = y + 'px';
        panel.style.bottom = 'auto';
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          panel.style.cursor = '';
        }
      });

      async function loadForm(url) {
        currentAbort = new AbortController();
        const res = await fetch(url, { signal: currentAbort.signal, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (!res.ok) throw new Error('Ошибка загрузки формы');
        const html = await res.text();
        body.innerHTML = html;
        openPanel();
        enhanceContactForm();
        const firstInput = panel.querySelector("input");
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 50);
        }
      }

      async function submitForm(form) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.textContent : '';
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Сохранение...';
        }
        
        try {
          const fd = new FormData(form);
          // Убеждаемся, что modal=1 всегда в форме
          if (!fd.has('modal')) {
            fd.append('modal', '1');
          }
          
          const res = await fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: fd
          });
          
          const ct = (res.headers.get('content-type') || '').toLowerCase();
          
          // Пробуем сначала как JSON
          if (ct.includes('application/json')) {
            const data = await res.json();
            if (data.ok) {
              if (window.uiToast) window.uiToast('Контакт сохранён', 'success');
              closePanel();
              window.location.reload();
              return;
            }
            if (data.html) {
              body.innerHTML = data.html;
              enhanceContactForm();
              return;
            }
            throw new Error(data.error || 'Ошибка сохранения');
          }
          
          // Если вернули HTML (не должно быть, но на всякий случай)
          const html = await res.text();
          // Проверяем, не редирект ли это
          if (res.redirected || res.status === 302 || html.includes('window.location') || html.includes('location.href')) {
            // Это редирект - просто обновляем страницу
            closePanel();
            window.location.reload();
            return;
          }
          
          // Иначе показываем HTML в панели (ошибка валидации)
          body.innerHTML = html;
          enhanceContactForm();
          
        } catch (error) {
          console.error('Ошибка при сохранении контакта:', error);
          if (window.uiToast) {
            window.uiToast('Ошибка сохранения: ' + error.message, 'error');
          } else {
            alert('Ошибка сохранения: ' + error.message);
          }
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }
      }

      // Открытие панели по кнопке (делегирование на body для динамически добавленных элементов)
      document.body.addEventListener('click', (e) => {
        const a = e.target.closest('[data-contact-panel-open]');
        if (a) {
          e.preventDefault();
          const url = a.getAttribute('href');
          if (!url) return;
          loadForm(url).catch(() => {
            if (window.uiToast) window.uiToast('Ошибка загрузки', 'error');
          });
          return;
        }
        if (e.target.closest('[data-contact-panel-close]')) {
          e.preventDefault();
          closePanel();
          return;
        }
      });

      // Закрытие по Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && panel && !panel.classList.contains('hidden')) {
          closePanel();
        }
      });

      // Submit внутри панели
      panel.addEventListener('submit', (e) => {
        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;
        if (!form.matches('[data-contact-panel-form]')) return;
        e.preventDefault();
        submitForm(form).catch(() => {
          if (window.uiToast) window.uiToast('Ошибка сохранения', 'error');
        });
      });
    })();
  </script>

  <script>
    // Управление сворачиванием дополнительных телефонов
    (function() {
      const toggleBtn = document.querySelector('[data-toggle-additional-phones]');
      const phonesList = document.querySelector('[data-company-phones-list]');
      
      if (toggleBtn && phonesList) {
        // Инициализация: по умолчанию свернуто
        toggleBtn.setAttribute('aria-expanded', 'false');
        phonesList.style.maxHeight = '0';
        phonesList.classList.add('hidden');
        
        toggleBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
          toggleBtn.setAttribute('aria-expanded', !isExpanded);
          
          // Плавная анимация раскрытия/сворачивания
          if (isExpanded) {
            // Сворачиваем
            const currentHeight = phonesList.scrollHeight;
            phonesList.style.maxHeight = currentHeight + 'px';
            phonesList.offsetHeight; // Принудительная перерисовка
            phonesList.style.maxHeight = '0';
            setTimeout(() => {
              phonesList.classList.add('hidden');
            }, 300);
          } else {
            // Разворачиваем
            phonesList.classList.remove('hidden');
            phonesList.style.maxHeight = '0';
            phonesList.offsetHeight; // Принудительная перерисовка
            const targetHeight = phonesList.scrollHeight;
            phonesList.style.maxHeight = targetHeight + 'px';
            setTimeout(() => {
              // Убираем ограничение после анимации для корректного отображения
              phonesList.style.maxHeight = 'none';
            }, 300);
          }
          
          // Обновляем иконку
          const icon = toggleBtn.querySelector('svg');
          if (icon) {
            icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(90deg)';
            icon.style.transition = 'transform 0.3s ease';
          }
        });
      }
    })();

  </script>

  <script>
    // Переключение режима просмотра карточки компании (classic/modern)
    (function() {
      const viewModeClassicBtn = document.getElementById('viewModeClassicDetail');
      const viewModeModernBtn = document.getElementById('viewModeModernDetail');
      const viewModeClassicBtnModern = document.getElementById('viewModeClassicDetailModern');
      const viewModeModernBtnModern = document.getElementById('viewModeModernDetailModern');
      const companyDetailClassic = document.getElementById('companyDetailClassic');
      const companyDetailModern = document.getElementById('companyDetailModern');
      
      // Получаем текущий режим из data-атрибута или localStorage
      let currentViewMode = '{{ detail_view_mode|default:"classic" }}';
      
      // Проверяем localStorage как fallback
      if (!currentViewMode || currentViewMode === 'undefined') {
        const stored = localStorage.getItem('company_detail_view_mode');
        if (stored && (stored === 'classic' || stored === 'modern')) {
          currentViewMode = stored;
        } else {
          currentViewMode = 'classic';
        }
      }
      
      // Функция переключения режима
      function switchViewMode(mode) {
        if (mode !== 'classic' && mode !== 'modern') return;
        
        currentViewMode = mode;
        
        // Обновляем UI
        if (mode === 'classic') {
          if (companyDetailClassic) companyDetailClassic.classList.remove('hidden');
          if (companyDetailModern) companyDetailModern.classList.add('hidden');
          
          // Обновляем активное состояние кнопок в classic режиме
          if (viewModeClassicBtn) {
            viewModeClassicBtn.classList.add('bg-white', 'text-brand-teal', 'shadow-sm');
            viewModeClassicBtn.classList.remove('text-brand-dark/70');
          }
          if (viewModeModernBtn) {
            viewModeModernBtn.classList.remove('bg-white', 'text-brand-teal', 'shadow-sm');
            viewModeModernBtn.classList.add('text-brand-dark/70');
          }
          
          // Обновляем активное состояние кнопок в modern режиме (если они видны)
          if (viewModeClassicBtnModern) {
            viewModeClassicBtnModern.classList.add('bg-white', 'text-brand-teal', 'shadow-sm');
            viewModeClassicBtnModern.classList.remove('text-brand-dark/70');
          }
          if (viewModeModernBtnModern) {
            viewModeModernBtnModern.classList.remove('bg-white', 'text-brand-teal', 'shadow-sm');
            viewModeModernBtnModern.classList.add('text-brand-dark/70');
          }
        } else {
          if (companyDetailClassic) companyDetailClassic.classList.add('hidden');
          if (companyDetailModern) companyDetailModern.classList.remove('hidden');
          
          // Обновляем активное состояние кнопок в classic режиме
          if (viewModeClassicBtn) {
            viewModeClassicBtn.classList.remove('bg-white', 'text-brand-teal', 'shadow-sm');
            viewModeClassicBtn.classList.add('text-brand-dark/70');
          }
          if (viewModeModernBtn) {
            viewModeModernBtn.classList.add('bg-white', 'text-brand-teal', 'shadow-sm');
            viewModeModernBtn.classList.remove('text-brand-dark/70');
          }
          
          // Обновляем активное состояние кнопок в modern режиме
          if (viewModeClassicBtnModern) {
            viewModeClassicBtnModern.classList.remove('bg-white', 'text-brand-teal', 'shadow-sm');
            viewModeClassicBtnModern.classList.add('text-brand-dark/70');
          }
          if (viewModeModernBtnModern) {
            viewModeModernBtnModern.classList.add('bg-white', 'text-brand-teal', 'shadow-sm');
            viewModeModernBtnModern.classList.remove('text-brand-dark/70');
          }
        }
        
        // Сохраняем в localStorage (fallback)
        try {
          localStorage.setItem('company_detail_view_mode', mode);
        } catch (e) {
          console.warn('Не удалось сохранить режим в localStorage:', e);
        }
        
        // Сохраняем на сервере
        const formData = new FormData();
        formData.append('view_mode', mode);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');
        
        fetch('/preferences/ui/company-detail-view-mode/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        }).catch(err => {
          console.warn('Не удалось сохранить режим на сервере:', err);
        });
      }
      
      // Обработчики кнопок в classic режиме
      if (viewModeClassicBtn) {
        viewModeClassicBtn.addEventListener('click', (e) => {
          e.preventDefault();
          switchViewMode('classic');
        });
      }
      
      if (viewModeModernBtn) {
        viewModeModernBtn.addEventListener('click', (e) => {
          e.preventDefault();
          switchViewMode('modern');
        });
      }
      
      // Обработчики кнопок в modern режиме
      if (viewModeClassicBtnModern) {
        viewModeClassicBtnModern.addEventListener('click', (e) => {
          e.preventDefault();
          switchViewMode('classic');
        });
      }
      
      if (viewModeModernBtnModern) {
        viewModeModernBtnModern.addEventListener('click', (e) => {
          e.preventDefault();
          switchViewMode('modern');
        });
      }
      
      // Инициализация: применяем сохраненный режим, если он отличается от текущего
      const initialMode = '{{ detail_view_mode|default:"classic" }}';
      if (initialMode !== currentViewMode) {
        switchViewMode(currentViewMode);
      }
      
      // Экспортируем функцию для использования в других скриптах
      window.switchCompanyDetailViewMode = switchViewMode;
      window.getCompanyDetailViewMode = () => currentViewMode;
    })();
  </script>

  <script>
    // Dropdown действий в Modern режиме
    (function() {
      const btn = document.getElementById('companyActionsBtnModern');
      const menu = document.getElementById('companyActionsMenuModern');
      if (!btn || !menu) return;
      
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        menu.classList.toggle('hidden');
      });
      
      // Закрытие при клике вне меню
      document.addEventListener('click', function(e) {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add('hidden');
        }
      });
    })();
  </script>

  <script>
    // Копирование телефона
    (function() {
      document.addEventListener('click', function(e) {
        const copyBtn = e.target.closest('[data-copy-phone]');
        if (!copyBtn) return;
        
        const phone = copyBtn.getAttribute('data-copy-phone');
        if (!phone) return;
        
        navigator.clipboard.writeText(phone).then(() => {
          const originalText = copyBtn.innerHTML;
          copyBtn.innerHTML = '<svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
          setTimeout(() => {
            copyBtn.innerHTML = originalText;
          }, 1000);
        }).catch(err => {
          console.error('Не удалось скопировать:', err);
        });
      });
    })();
  </script>

  <script>
    // Обработчик формы заметок в modern режиме (inline)
    (function(){
      const input = document.getElementById('noteFileModernInline');
      const inputMulti = document.getElementById('noteFilesMultipleModernInline');
      const name = document.getElementById('noteFileNameModernInline');
      const chipsWrap = document.getElementById('noteAddFileChipsModernInline');
      const zone = document.getElementById('noteFormModernInline') && document.getElementById('noteFormModernInline').querySelector('.note-files-zone');
      if (inputMulti) {
        inputMulti.addEventListener('change', function() {
          var files = inputMulti.files || [];
          if (name) name.textContent = files.length ? 'Выбрано: ' + files.length + ' файл(ов)' : '';
          if (zone) zone.classList.toggle('has-files', files.length > 0);
          if (chipsWrap) {
            chipsWrap.innerHTML = '';
            for (var i = 0; i < files.length; i++) {
              var f = files[i];
              var size = f.size ? (f.size < 1024 ? f.size + ' Б' : (f.size < 1024*1024 ? (f.size/1024).toFixed(1) + ' КБ' : (f.size/1024/1024).toFixed(1) + ' МБ')) : '';
              var chip = document.createElement('span');
              chip.className = 'note-file-chip';
              chip.innerHTML = '<span class="truncate max-w-[160px]" title="' + (f.name || '').replace(/"/g, '&quot;') + '">' + (f.name || 'Файл') + '</span>' + (size ? ' <span class="text-brand-dark/50 text-xs">' + size + '</span>' : '');
              chipsWrap.appendChild(chip);
            }
          }
        });
      }
      var btn = document.getElementById('noteAttachBtnModernInline');
      if (btn && input) { btn.addEventListener('click', function() { input.click(); }); }
      if (input) input.addEventListener('change', function() { if (name) name.textContent = (input.files && input.files[0]) ? input.files[0].name : ''; });

      // Ctrl+Enter / Cmd+Enter — отправить заметку
      const form = document.getElementById('noteFormModernInline');
      if (form) {
        var textarea = form.querySelector('textarea[name="text"]');
        if (textarea) textarea.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            if (typeof form.requestSubmit === 'function') form.requestSubmit(); else form.submit();
          }
        });
      }
      if (form && typeof window.fetch === 'function') {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(form);
          try {
            const resp = await fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!resp.ok) throw new Error('Failed to submit note');

            // Очищаем черновик СРАЗУ после успешной отправки (до обновления панели)
            const companyId = form.getAttribute('data-company-id') || '';
            const userId = form.getAttribute('data-user-id') || '';
            const storageKey = `companyNoteDraft:v1:${userId}:${companyId}`;
            try { localStorage.removeItem(storageKey); } catch (_e) {}

            // Очищаем форму
            const textarea = form.querySelector('textarea[name="text"]');
            if (textarea) textarea.value = '';
            if (input) input.value = '';
            if (inputMulti) inputMulti.value = '';
            if (name) name.textContent = '';
            if (chipsWrap) chipsWrap.innerHTML = '';
            if (zone) zone.classList.remove('has-files');

            // Обновляем Обзор (и заметки на нём/кнопки "Развернуть") и панель заметок
            if (window.refreshOverviewNotes) {
              try { await window.refreshOverviewNotes(); } catch (_e) {}
            }

            // Обновляем вкладку "Заметки" целиком, но сохраняя активность вкладки
            try {
              const url = new URL(window.location.href);
              url.searchParams.set('view', 'modern');
              const resp2 = await fetch(url.toString(), {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
              });
              if (resp2.ok) {
                const html = await resp2.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newModernRoot = doc.getElementById('companyDetailModern');
                const newNotes = newModernRoot && newModernRoot.querySelector('[data-modern-tab-panel="notes"]');
                const currentModernRoot = document.getElementById('companyDetailModern');
                const currentNotes = currentModernRoot && currentModernRoot.querySelector('[data-modern-tab-panel="notes"]');
                if (newNotes && currentNotes && currentNotes.parentNode) {
                  // Сохраняем активность вкладки "Заметки"
                  const wasActive = currentNotes.classList.contains('modern-tab-panel-active');
                  if (wasActive) {
                    newNotes.classList.add('modern-tab-panel-active');
                    newNotes.classList.remove('hidden');
                  }
                  currentNotes.parentNode.replaceChild(newNotes, currentNotes);
                  if (window.initNoteInputAutogrow) window.initNoteInputAutogrow();
                  if (window.initNoteDraft) window.initNoteDraft('noteFormModernInline');
                }
              }
            } catch (_e) {
              // В случае ошибки тихо игнорируем — данные уже сохранены
            }
          } catch (err) {
            window.location.reload();
          }
        });
      }
    })();
  </script>
  <script>
    // Авто-рост поля заметки и вставка скриншотов по Ctrl+V (классический и современный вид)
    (function(){
      function initNoteTextarea(textarea) {
        if (!textarea || !textarea.classList.contains('note-input-autogrow') || textarea.getAttribute('data-note-autogrow-init')) return;
        textarea.setAttribute('data-note-autogrow-init', '1');
        var form = textarea.closest('form');
        if (!form) return;
        var fileInput = form.querySelector('input[name="attachments"]');
        function autogrow() {
          textarea.style.height = 'auto';
          textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        textarea.addEventListener('input', autogrow);
        autogrow();
        textarea.addEventListener('paste', function(e) {
          var items = e.clipboardData && e.clipboardData.items;
          if (!items || !fileInput) return;
          var toAdd = [];
          for (var i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image/') === 0) {
              var f = items[i].getAsFile();
              if (f) toAdd.push(f);
            }
          }
          if (toAdd.length === 0) return;
          e.preventDefault();
          for (var k = 0; k < toAdd.length; k++) {
            var f = toAdd[k];
            if (!f.name || !String(f.name).trim()) toAdd[k] = new File([f], 'image.png', { type: f.type || 'image/png' });
          }
          if (typeof DataTransfer === 'undefined') return;
          var dt = new DataTransfer();
          for (var j = 0; j < (fileInput.files || []).length; j++) dt.items.add(fileInput.files[j]);
          for (var k = 0; k < toAdd.length; k++) dt.items.add(toAdd[k]);
          fileInput.files = dt.files;
          fileInput.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }
      window.initNoteInputAutogrow = function() {
        document.querySelectorAll('textarea.note-input-autogrow').forEach(initNoteTextarea);
      };
      window.initNoteInputAutogrow();
    })();
  </script>
  <script>
    // Черновик заметки в modern режиме (inline-форма)
    (function(){
      function initDraft(formId) {
        const form = document.getElementById(formId);
        if (!form) return;

        const textarea = form.querySelector('textarea[name="text"]');
        if (!textarea) return;

        const companyId = form.getAttribute('data-company-id') || '';
        const userId = form.getAttribute('data-user-id') || '';
        const storageKey = `companyNoteDraft:v1:${userId}:${companyId}`;

        function normalize(s) {
          return String(s || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
        }

        function getDraft() {
          try { return localStorage.getItem(storageKey) || ''; } catch (_e) { return ''; }
        }
        function setDraft(v) {
          try { localStorage.setItem(storageKey, v); } catch (_e) {}
        }
        function clearDraft() {
          try { localStorage.removeItem(storageKey); } catch (_e) {}
        }

        // Если последний добавленный note совпадает с черновиком — считаем, что он сохранён, и очищаем.
        const draft = getDraft();
        if (draft) {
          const firstNoteBody = document.querySelector('[data-note-item] [data-note-body]');
          if (firstNoteBody) {
            const noteText = normalize(firstNoteBody.textContent || '');
            if (noteText && noteText === normalize(draft)) {
              clearDraft();
            }
          }
        }

        // Восстановление черновика (только если поле пустое/не тронуто сервером)
        const current = normalize(textarea.value);
        const draft2 = getDraft();
        let lastSavedValue = '';
        if (!current && draft2) {
          textarea.value = draft2;
          lastSavedValue = draft2;
          textarea.dispatchEvent(new Event('input', { bubbles: true }));
        } else {
          lastSavedValue = textarea.value || '';
        }

        // Автосохранение по мере ввода (debounce)
        let t = null;
        textarea.addEventListener('input', () => {
          const v = textarea.value || '';
          const normalized = normalize(v);
          // Если пользователь вручную очистил поле — сразу убираем черновик, чтобы после перезагрузки не подгружался
          if (!normalized) {
            clearDraft();
            lastSavedValue = '';
            if (t) window.clearTimeout(t);
            return;
          }
          if (t) window.clearTimeout(t);
          t = window.setTimeout(() => {
            const v2 = textarea.value || '';
            const normalized2 = normalize(v2);
            if (normalized2 !== normalize(lastSavedValue)) {
              setDraft(v2);
              lastSavedValue = v2;
            }
          }, 250);
        });

        // Сохраняем при уходе со страницы (только если значение изменилось)
        window.addEventListener('beforeunload', () => {
          const v = textarea.value || '';
          const normalized = normalize(v);
          if (normalized && normalized !== normalize(lastSavedValue)) {
            setDraft(v);
          }
        });

        // Очистка черновика после успешной отправки
        // Для AJAX-форм очистка происходит в обработчике submit (до обновления панели)
        // Для обычных форм (с редиректом) очищаем с задержкой
        form.addEventListener('submit', function(e) {
          // Если форма отправляется через AJAX (есть обработчик preventDefault выше), очистка уже произошла
          // Для обычных форм очищаем с задержкой
          if (!e.defaultPrevented) {
            setTimeout(() => clearDraft(), 500);
          }
        });
      }

      // Инициализируем для inline-формы и выставляем глобально для повторной инициализации после AJAX-подмены панели
      window.initNoteDraft = initDraft;
      initDraft('noteFormModernInline');
    })();
  </script>

  <script>
    // Вкладки Modern: переключение контента без перезагрузки
    (function() {
      const modernRoot = document.getElementById('companyDetailModern');
      if (!modernRoot) return;

      const tabBtns = Array.from(modernRoot.querySelectorAll('[data-modern-tab-btn]'));
      const panels = Array.from(modernRoot.querySelectorAll('[data-modern-tab-panel]'));
      if (!tabBtns.length || !panels.length) return;

      const ACTIVE = ['bg-brand-soft/30', 'text-brand-dark'];
      const INACTIVE = ['bg-white', 'text-brand-dark/70'];

      function isKnownTab(tab) {
        return tabBtns.some(b => b.getAttribute('data-modern-tab-btn') === tab);
      }

      function setActive(tab, opts) {
        const options = Object.assign({ save: true, updateHash: true, scrollToTop: true }, opts || {});
        const inlineSection = tab === 'notes' || tab === 'tasks';
        const target = inlineSection ? 'overview' : (isKnownTab(tab) ? tab : 'overview');

        panels.forEach(p => {
          const t = p.getAttribute('data-modern-tab-panel');
          const on = t === target;
          p.classList.toggle('hidden', !on);
          p.classList.toggle('modern-tab-panel-active', on);
        });

        tabBtns.forEach(b => {
          const t = b.getAttribute('data-modern-tab-btn');
          const on = t === target;
          b.classList.toggle(ACTIVE[0], on);
          b.classList.toggle(ACTIVE[1], on);
          b.classList.toggle(INACTIVE[0], !on);
          b.classList.toggle(INACTIVE[1], !on);
          b.setAttribute('aria-current', on ? 'page' : 'false');
        });

        if (options.save) {
          try { sessionStorage.setItem('company_modern_tab', inlineSection ? 'overview' : target); } catch (_e) {}
        }
        if (options.updateHash) {
          const hash = inlineSection ? tab : target;
          try { history.replaceState(null, '', '#' + hash); } catch (_e) {}
        }

        if (inlineSection) {
          const detailsId = tab === 'notes' ? 'modernNotesDetails' : 'modernTasksDetails';
          const details = modernRoot.querySelector('#' + detailsId);
          if (details) {
            details.open = true;
            details.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        } else if (options.scrollToTop) {
          modernRoot.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Экспортируем для onclick в шаблоне и хоткеев
      window.switchModernCompanyTab = function(tab) {
        setActive(tab, { scrollToTop: false });
      };

      // Инициализация: hash → sessionStorage → overview
      let initial = (location.hash || '').replace('#', '').trim();
      if (!isKnownTab(initial)) {
        try { initial = (sessionStorage.getItem('company_modern_tab') || '').trim(); } catch (_e) { initial = ''; }
      }
      if (!isKnownTab(initial)) initial = 'overview';
      setActive(initial, { save: false, updateHash: false, scrollToTop: false });

      tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const tab = this.getAttribute('data-modern-tab-btn');
          setActive(tab, { scrollToTop: false });
        });
      });

      // Мини-логика для формы создания сделки в Modern
      const openDealBtn = modernRoot.querySelector('#openDealCreateModern');
      const closeDealBtn = modernRoot.querySelector('#closeDealCreateModern');
      const dealForm = modernRoot.querySelector('#dealCreateFormModern');
      if (openDealBtn && closeDealBtn && dealForm) {
        openDealBtn.addEventListener('click', () => {
          dealForm.classList.remove('hidden');
          dealForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
        closeDealBtn.addEventListener('click', () => {
          dealForm.classList.add('hidden');
        });
      }
    })();
  </script>

  <script>
    // Горячие клавиши для Modern режима
    (function() {
      const modernView = document.getElementById('companyDetailModern');
      if (!modernView) return;

      document.addEventListener('keydown', function(e) {
        // Работаем только если Modern режим активен
        if (modernView.classList.contains('hidden')) return;
        
        // Игнорируем если пользователь вводит текст
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
          // Разрешаем только Ctrl+K для поиска
          if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('quickSearchBtnModern')?.click();
          }
          return;
        }

        // N - новая заметка
        if (e.key === 'n' || e.key === 'N') {
          e.preventDefault();
          // В modern-режиме приоритет за modern-модалкой
          if (!modernView.classList.contains('hidden') && typeof window.openNoteCreateModern === 'function') {
            window.openNoteCreateModern();
          } else if (window.openNoteCreate) {
            window.openNoteCreate();
          } else {
            window.switchModernCompanyTab?.('notes');
            const noteForm = document.getElementById('noteFormModernInline');
            const textarea = noteForm ? noteForm.querySelector('textarea[name="text"]') : null;
            if (textarea) {
              setTimeout(() => textarea.focus(), 50);
              noteForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        }

        // T - новая задача
        if (e.key === 't' || e.key === 'T') {
          e.preventDefault();
          const taskBtn = document.querySelector('[data-quick-action="task"]');
          if (taskBtn) taskBtn.click();
        }

        // C - позвонить
        if (e.key === 'c' || e.key === 'C') {
          e.preventDefault();
          const callBtn = document.querySelector('[data-quick-action="call"]') || document.querySelector('.js-call-phone[data-company="{{ company.id }}"]');
          if (callBtn) callBtn.click();
        }

        // . - открыть меню действий
        if (e.key === '.') {
          e.preventDefault();
          document.getElementById('companyActionsBtnModern')?.click();
        }

        // / - поиск по карточке
        if (e.key === '/') {
          e.preventDefault();
          document.getElementById('quickSearchBtnModern')?.click();
        }
      });
    })();
  </script>

  <script>
    // Поиск по карточке в Modern режиме
    (function() {
      const searchBtn = document.getElementById('quickSearchBtnModern');
      const searchPanel = document.getElementById('cardSearchModern');
      const searchInput = document.getElementById('cardSearchInputModern');
      const searchResults = document.getElementById('cardSearchResultsModern');
      const searchClose = document.getElementById('cardSearchCloseModern');

      if (!searchBtn || !searchPanel || !searchInput) return;

      function toggleSearch() {
        searchPanel.classList.toggle('hidden');
        if (!searchPanel.classList.contains('hidden')) {
          searchInput.focus();
        } else {
          searchInput.value = '';
          searchResults.classList.add('hidden');
        }
      }

      searchBtn.addEventListener('click', toggleSearch);
      if (searchClose) searchClose.addEventListener('click', toggleSearch);

      // Ctrl+K
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k' && !document.getElementById('companyDetailModern')?.classList.contains('hidden')) {
          e.preventDefault();
          toggleSearch();
        }
      });

      // Поиск при вводе
      searchInput.addEventListener('input', function() {
        const query = this.value.trim().toLowerCase();
        if (!query) {
          searchResults.classList.add('hidden');
          // Убираем подсветку
          document.querySelectorAll('.search-highlight').forEach(el => {
            el.classList.remove('search-highlight');
            el.style.backgroundColor = '';
          });
          return;
        }

        const results = [];
        const modernView = document.getElementById('companyDetailModern');
        if (!modernView) return;

        // Убираем предыдущую подсветку
        document.querySelectorAll('.search-highlight').forEach(el => {
          el.classList.remove('search-highlight');
          el.style.backgroundColor = '';
        });

        // Ищем по ключевым полям
        const searchFields = [
          { selector: '[data-company-inn]', label: 'ИНН' },
          { selector: '[data-company-phone]', label: 'Телефон' },
          { selector: '.card', label: 'Блок' },
        ];

        // Поиск по ИНН
        const innEl = modernView.querySelector('[data-inline-field="inn"] .inline-field-display, .font-mono');
        if (innEl) {
          const innText = innEl.textContent || '';
          if (innText.toLowerCase().includes(query)) {
            results.push({ element: innEl.closest('.inline-field-wrapper') || innEl, text: `ИНН: ${innText}`, label: 'ИНН' });
            innEl.style.backgroundColor = '#fef3c7';
            innEl.classList.add('search-highlight');
          }
        }

        // Поиск по телефону
        const phoneEls = modernView.querySelectorAll('[data-phone], .font-mono');
        phoneEls.forEach(el => {
          const phoneText = el.textContent || el.getAttribute('data-phone') || '';
          if (phoneText.toLowerCase().includes(query)) {
            const parent = el.closest('.card, [class*="phone"]');
            if (parent && !results.find(r => r.element === parent)) {
              results.push({ element: parent, text: `Телефон: ${phoneText}`, label: 'Телефон' });
              el.style.backgroundColor = '#fef3c7';
              el.classList.add('search-highlight');
            }
          }
        });

        // Поиск по заметкам
        const noteEls = modernView.querySelectorAll('[data-note-body], #displayNoteText');
        noteEls.forEach(el => {
          const noteText = el.textContent || '';
          if (noteText.toLowerCase().includes(query)) {
            const parent = el.closest('.card, [data-note-item]');
            if (parent && !results.find(r => r.element === parent)) {
              results.push({ element: parent, text: `Заметка: ${noteText.substring(0, 50)}...`, label: 'Заметка' });
              // Подсветка текста внутри заметки
              const regex = new RegExp(`(${query})`, 'gi');
              if (el.innerHTML) {
                el.innerHTML = el.innerHTML.replace(regex, '<mark style="background-color:#fef3c7">$1</mark>');
              }
            }
          }
        });

        // Поиск по задачам
        const taskEls = modernView.querySelectorAll('[data-task-id]');
        taskEls.forEach(el => {
          const taskText = el.textContent || '';
          if (taskText.toLowerCase().includes(query)) {
            if (!results.find(r => r.element === el)) {
              results.push({ element: el, text: `Задача: ${taskText.substring(0, 50)}...`, label: 'Задача' });
              el.style.borderColor = '#f59e0b';
              el.style.borderWidth = '2px';
            }
          }
        });

        if (results.length > 0) {
          searchResults.innerHTML = results.slice(0, 8).map((r, idx) => 
            `<div class="p-2 hover:bg-brand-soft/20 rounded cursor-pointer border-b border-brand-soft/30 last:border-0" onclick="const el = document.querySelectorAll('[data-task-id], .inline-field-wrapper, .card')[${idx}]; if(el) { el.scrollIntoView({behavior:'smooth',block:'center'}); setTimeout(() => { document.getElementById('cardSearchModern').classList.add('hidden'); }, 300); }">
              <div class="text-xs text-brand-dark/50 mb-0.5">${r.label}</div>
              <div class="text-sm">${r.text.substring(0, 80)}${r.text.length > 80 ? '...' : ''}</div>
            </div>`
          ).join('');
          searchResults.classList.remove('hidden');
        } else {
          searchResults.innerHTML = '<div class="p-2 text-brand-dark/50 text-center">Ничего не найдено</div>';
          searchResults.classList.remove('hidden');
        }
      });
    })();
  </script>

  <script>
    // Шаблоны заметок
    (function() {
      const templates = {
        important: '⭐ ВАЖНО:\n\n',
        callback: '📞 Перезвон:\nДата: ' + new Date().toLocaleDateString('ru-RU') + '\nРезультат: ',
        quote: '💰 КП/Счёт:\nСумма: \nСрок действия: \nКомментарий: ',
        reject: '❌ Отказ:\nПричина: \nКомментарий: '
      };

      document.querySelectorAll('.note-template-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const template = templates[this.dataset.template];
          if (!template) return;

          const form = document.getElementById('noteFormModernInline');
          if (!form) return;

          const textarea = form.querySelector('textarea[name="text"]');
          if (textarea) {
            textarea.value = template;
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
          }
        });
      });
    })();
  </script>

  <script>
    // Копирование текста (универсальное)
    (function() {
      document.addEventListener('click', function(e) {
        const copyBtn = e.target.closest('[data-copy-text]');
        if (!copyBtn) return;
        
        const text = copyBtn.getAttribute('data-copy-text');
        if (!text) return;
        
        navigator.clipboard.writeText(text).then(() => {
          const originalHTML = copyBtn.innerHTML;
          copyBtn.innerHTML = '<svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
          setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
          }, 1000);
        }).catch(err => {
          console.error('Не удалось скопировать:', err);
        });
      });
    })();
  </script>

  <script>
    // Быстрые действия в Modern режиме
    (function() {
      // Добавить заметку
      const quickNoteBtn = document.querySelector('[data-quick-action="note"]');
      if (quickNoteBtn) {
        quickNoteBtn.addEventListener('click', function() {
          // В modern-режиме стараемся сразу открыть modern-модалку
          if (typeof window.openNoteCreateModern === 'function') {
            window.openNoteCreateModern();
          } else if (window.openNoteCreate) {
            window.openNoteCreate();
          } else {
            // Фоллбек на старое поведение
            window.switchModernCompanyTab?.('notes');
            const form = document.getElementById('noteFormModernInline');
            if (form) {
              const textarea = form.querySelector('textarea[name="text"]');
              if (textarea) {
                setTimeout(() => textarea.focus(), 50);
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            }
          }
        });
      }

      // Создать задачу
      document.querySelector('[data-quick-action="task"]')?.addEventListener('click', function() {
        const companyId = this.dataset.companyId;
        if (companyId) {
          const taskBtn = document.querySelector(`[data-create-task][data-company-id="${companyId}"]`);
          if (taskBtn) taskBtn.click();
        }
      });
    })();
  </script>

  <script>
    // Завершение задачи и перенос сроков
    (function() {
      // Завершение задачи
      document.querySelectorAll('.task-complete-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', async function() {
          const taskId = this.dataset.taskId;
          if (!taskId) return;

          const formData = new FormData();
          formData.append('status', this.checked ? 'done' : 'in_progress');
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');

          try {
            const res = await fetch(`/tasks/${taskId}/update-status/`, {
              method: 'POST',
              body: formData,
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (res.ok) {
              location.reload(); // Перезагружаем для обновления списка
            }
          } catch (err) {
            console.error('Ошибка обновления задачи:', err);
            this.checked = !this.checked; // Откатываем изменение
          }
        });
      });

      // Перенос сроков
      document.querySelectorAll('.task-reschedule-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const taskId = this.dataset.taskId;
          const days = parseInt(this.dataset.days) || 0;
          if (!taskId || !days) return;

          // Получаем текущую дату из data-атрибута или используем сегодня
          let newDate = new Date();
          const dueDateAttr = this.dataset.dueDate;
          if (dueDateAttr) {
            try {
              newDate = new Date(dueDateAttr.replace(' ', 'T'));
            } catch (e) {
              console.warn('Не удалось распарсить дату:', dueDateAttr);
            }
          }
          newDate.setDate(newDate.getDate() + days);

          const formData = new FormData();
          formData.append('due_at', newDate.toISOString().slice(0, 16));
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');

          try {
            const res = await fetch(`/tasks/${taskId}/edit/`, {
              method: 'POST',
              body: formData,
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (res.ok) {
              const data = await res.json();
              if (data.ok) {
                location.reload();
              }
            }
          } catch (err) {
            console.error('Ошибка переноса задачи:', err);
          }
        });
      });
    })();
  </script>

  <script>
    // Быстрое изменение статуса компании
    (function() {
      const statusSelect = document.getElementById('quickStatusChangeModern');
      if (!statusSelect) return;

      statusSelect.addEventListener('change', async function() {
        const statusId = this.value;
        const companyId = this.dataset.companyId;
        if (!statusId || !companyId) return;

        const formData = new FormData();
        formData.append('field', 'status');
        formData.append('value', statusId);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');

        try {
          const res = await fetch(`/companies/${companyId}/inline/`, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          if (res.ok) {
            location.reload();
          }
        } catch (err) {
          console.error('Ошибка изменения статуса:', err);
        }
      });
    })();
  </script>

  <script>
    // Индикатор несохранённых изменений
    (function() {
      const indicator = document.getElementById('unsavedChangesIndicatorModern');
      if (!indicator) return;

      let unsavedFields = new Set();

      function updateIndicator() {
        if (unsavedFields.size > 0) {
          indicator.classList.remove('hidden');
        } else {
          indicator.classList.add('hidden');
        }
      }

      // Отслеживаем открытие inline-редактирования
      document.addEventListener('click', function(e) {
        const editBtn = e.target.closest('[data-inline-edit]');
        if (editBtn) {
          const wrapper = editBtn.closest('.inline-field-wrapper');
          if (wrapper) {
            unsavedFields.add(wrapper);
            updateIndicator();
          }
        }

        const saveBtn = e.target.closest('[data-inline-save]');
        if (saveBtn) {
          const wrapper = saveBtn.closest('.inline-field-wrapper');
          if (wrapper) {
            // Удаляем после успешного сохранения (будет обработано в основном обработчике)
            setTimeout(() => {
              unsavedFields.delete(wrapper);
              updateIndicator();
            }, 500);
          }
        }

        const cancelBtn = e.target.closest('[data-inline-cancel]');
        if (cancelBtn) {
          const wrapper = cancelBtn.closest('.inline-field-wrapper');
          if (wrapper) {
            unsavedFields.delete(wrapper);
            updateIndicator();
          }
        }
      });

      // Сохранить всё
      document.getElementById('saveAllChangesModern')?.addEventListener('click', function() {
        unsavedFields.forEach(wrapper => {
          const saveBtn = wrapper.querySelector('[data-inline-save]');
          if (saveBtn) saveBtn.click();
        });
      });

      // Отменить всё
      document.getElementById('cancelAllChangesModern')?.addEventListener('click', function() {
        unsavedFields.forEach(wrapper => {
          const cancelBtn = wrapper.querySelector('[data-inline-cancel]');
          if (cancelBtn) cancelBtn.click();
        });
        unsavedFields.clear();
        updateIndicator();
      });
    })();
  </script>

  <script>
    // Обработка кнопок "Развернуть/Свернуть" для заметок в modern режиме (основная + превью)
    (function() {
      function updateExpandVisibility() {
        // Основная заметка
        const mainText = document.getElementById('displayNoteText');
        const mainBtn = document.querySelector('[data-note-expand-toggle]');
        if (mainText && mainBtn) {
          const needExpand = mainText.scrollHeight > mainText.clientHeight + 1;
          mainBtn.classList.toggle('hidden', !needExpand);
        }

        // Превью заметок
        document.querySelectorAll('[data-note-preview-text]').forEach(el => {
          const id = el.getAttribute('data-note-preview-text');
          const btn = id ? document.querySelector(`[data-note-preview-toggle="${id}"]`) : null;
          if (!btn) return;
          const needExpand = el.scrollHeight > el.clientHeight + 1;
          btn.classList.toggle('hidden', !needExpand);
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateExpandVisibility);
      } else {
        updateExpandVisibility();
      }
      window.addEventListener('resize', updateExpandVisibility);
      window.updateOverviewNoteExpand = updateExpandVisibility;

      document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-note-expand-toggle], [data-note-preview-toggle]');
        if (!btn) return;

        let textEl = null;
        // Основная заметка на обзоре
        if (btn.hasAttribute('data-note-expand-toggle')) {
          textEl = document.getElementById('displayNoteText');
        } else {
          // Превью заметка: ищем по data-атрибуту
          const id = btn.getAttribute('data-note-preview-toggle');
          if (id) {
            textEl = document.querySelector(`[data-note-preview-text="${id}"]`);
          }
        }
        if (!textEl) return;

        const expandText = btn.querySelector('.expand-text');
        const collapseText = btn.querySelector('.collapse-text');
        const isExpanded = !textEl.classList.contains('line-clamp-4');

        if (isExpanded) {
          textEl.classList.add('line-clamp-4');
          if (expandText) expandText.classList.remove('hidden');
          if (collapseText) collapseText.classList.add('hidden');
        } else {
          textEl.classList.remove('line-clamp-4');
          if (expandText) expandText.classList.add('hidden');
          if (collapseText) collapseText.classList.remove('hidden');
        }
      });
    })();
  </script>
{% endblock %}


