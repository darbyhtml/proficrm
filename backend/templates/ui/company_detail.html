{% extends "ui/base.html" %}
{% block title %}{{ company.name }} ‚Äî CRM –ü–†–û–§–ò{% endblock %}

{% block content %}
  <div class="space-y-6">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm text-brand-dark/70"><a class="underline" href="/companies/">–ö–æ–º–ø–∞–Ω–∏–∏</a> /</div>
        <h1 class="text-2xl font-semibold">{{ company.name }}</h1>
        <div class="text-sm text-brand-dark/80">
          {% if company.inn %}–ò–ù–ù: <span class="font-mono">{{ company.inn }}</span>{% endif %}
          {% if company.kpp %} ¬∑ –ö–ü–ü: <span class="font-mono">{{ company.kpp }}</span>{% endif %}
        </div>
        {% if can_edit_company %}
          <div class="mt-2">
            <a class="btn btn-outline" href="/companies/{{ company.id }}/edit/">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</a>
          </div>
        {% endif %}
      </div>
      <div class="text-sm text-brand-dark/80">
        <div><span class="text-brand-dark/50">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</span> {{ company.responsible }}</div>
        <div><span class="text-brand-dark/50">–§–∏–ª–∏–∞–ª:</span> {{ company.branch }}</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card card-pad lg:col-span-2">
        <div class="font-medium mb-3">–î–∞–Ω–Ω—ã–µ</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <div>
            <div class="text-brand-dark/50">–Æ—Ä. –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
            <div>{{ company.legal_name|default:"‚Äî" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">–°–∞–π—Ç</div>
            <div>{% if company.website %}<a class="link" href="{{ company.website }}" target="_blank">{{ company.website }}</a>{% else %}‚Äî{% endif %}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">–¢–µ–ª–µ—Ñ–æ–Ω (–æ—Å–Ω–æ–≤–Ω–æ–π)</div>
            <div class="flex items-center justify-between gap-2">
              <div class="font-mono text-xs">{{ company.phone|default:"‚Äî" }}</div>
              {% if company.phone %}
                <button
                  type="button"
                  class="btn btn-outline js-call-phone"
                  style="padding:.25rem .5rem;font-size:.75rem"
                  data-phone="{{ company.phone }}"
                  data-company="{{ company.id }}"
                  data-contact=""
                >
                  –ü–æ–∑–≤–æ–Ω–∏—Ç—å —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                </button>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Email (–æ—Å–Ω–æ–≤–Ω–æ–π)</div>
            <div>
              {% if company.email %}
                <a class="link font-mono text-xs" href="mailto:{{ company.email }}">{{ company.email }}</a>
              {% else %}
                ‚Äî
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">–ö–æ–Ω—Ç–∞–∫—Ç (–§–ò–û)</div>
            <div>{{ company.contact_name|default:"‚Äî" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">–ö–æ–Ω—Ç–∞–∫—Ç (–¥–æ–ª–∂–Ω–æ—Å—Ç—å)</div>
            <div>{{ company.contact_position|default:"‚Äî" }}</div>
          </div>
          <div class="md:col-span-2">
            <div class="text-brand-dark/50">–ê–¥—Ä–µ—Å</div>
            <div class="whitespace-pre-line">{{ company.address|default:"‚Äî" }}</div>
          </div>
        </div>
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">–ë—ã—Å—Ç—Ä–æ</div>
        {% if can_edit_company %}
          <a class="btn btn-primary w-full" href="/tasks/new/?company={{ company.id }}">+ –ü–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</a>
          <div class="mt-3">
            <div class="text-xs text-brand-dark/70 mb-1">–ü–µ—Ä–µ–¥–∞—Ç—å –¥—Ä—É–≥–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É</div>
            <form method="post" action="/companies/{{ company.id }}/transfer/" class="flex gap-2">
              {% csrf_token %}
              <select name="responsible_id" class="select">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞‚Ä¶</option>
                {% for u in transfer_targets %}
                  <option value="{{ u.id }}">{{ u }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-outline" type="submit">–ü–µ—Ä–µ–¥–∞—Ç—å</button>
            </form>
            <div class="text-xs muted-2 mt-1">–ü—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ —Ñ–∏–ª–∏–∞–ª –∫–æ–º–ø–∞–Ω–∏–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ–¥ —Ñ–∏–ª–∏–∞–ª –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ.</div>
          </div>
        {% else %}
          <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
            –£ –≤–∞—Å –¥–æ—Å—Ç—É–ø <b>—Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä</b>. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—å/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π/–¥–∏—Ä–µ–∫—Ç–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞/—É–ø—Ä–∞–≤–ª—è—é—â–∏–π.
          </div>
        {% endif %}
        <div class="mt-4 border-t pt-4">
          <div class="font-medium mb-2">–°—Ç–∞—Ç—É—Å –∏ —Å—Ñ–µ—Ä—ã</div>
          {% if can_edit_company %}
            <form method="post" action="/companies/{{ company.id }}/update/" class="space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">–°—Ç–∞—Ç—É—Å</label>
                {{ quick_form.status|safe }}
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">–°—Ñ–µ—Ä—ã</label>
                <div class="ms" data-ms="1" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ñ–µ—Ä—ã">
                  <button type="button" class="ms-btn">
                    <span class="ms-value"></span>
                    <span class="ms-muted">‚ñº</span>
                  </button>
                  <div class="ms-panel hidden">
                    <div class="ms-top">
                      <input class="input ms-search" placeholder="–ü–æ–∏—Å–∫" />
                      <a href="#" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" data-ms-clear>–°–Ω—è—Ç—å</a>
                    </div>
                    <div class="ms-list"></div>
                  </div>
                  <div class="hidden">
                    {{ quick_form.spheres }}
                  </div>
                </div>
              </div>
              <button class="btn btn-outline w-full" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
          {% else %}
            <div class="text-sm text-brand-dark/70 space-y-2">
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">–°—Ç–∞—Ç—É—Å</div>
                <div>{{ company.status|default:"‚Äî" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">–°—Ñ–µ—Ä—ã</div>
                <div class="flex flex-wrap gap-1">
                  {% for s in company.spheres.all %}
                    <span class="badge">{{ s.name }}</span>
                  {% empty %}
                    <span class="text-brand-dark/70">‚Äî</span>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <section class="card card-pad">
        <div class="flex items-end justify-between gap-3 mb-3">
          <div class="font-medium">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
          {% if can_edit_company %}
            <a class="btn btn-outline" href="/companies/{{ company.id }}/contacts/new/">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</a>
          {% endif %}
        </div>
        {% if contacts %}
          <div class="space-y-3">
            {% for c in contacts %}
              <div class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">{{ c.last_name }} {{ c.first_name }}</div>
                    <div class="text-xs text-brand-dark/70">{{ c.position }}</div>
                  </div>
                  {% if can_edit_company %}
                    <a class="text-sm link" href="/contacts/{{ c.id }}/edit/">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                  {% endif %}
                </div>
                <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                  <div>
                    <div class="text-brand-dark/50 text-xs">Email</div>
                    {% for e in c.emails.all %}
                      <div>{{ e.value }}</div>
                    {% empty %}
                      <div class="text-brand-dark/70">‚Äî</div>
                    {% endfor %}
                  </div>
                  <div>
                    <div class="text-brand-dark/50 text-xs">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                    {% for p in c.phones.all %}
                      <div class="flex items-center justify-between gap-2">
                        <div class="font-mono text-xs">{{ p.value }}</div>
                        <button
                          type="button"
                          class="btn btn-outline js-call-phone"
                          style="padding:.25rem .5rem;font-size:.75rem"
                          data-phone="{{ p.value }}"
                          data-company="{{ company.id }}"
                          data-contact="{{ c.id }}"
                        >
                          –ü–æ–∑–≤–æ–Ω–∏—Ç—å —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                        </button>
                      </div>
                    {% empty %}
                      <div class="text-brand-dark/70">‚Äî</div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–µ—Ç.</div>
        {% endif %}
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏</div>
        {% if tasks %}
          <div class="space-y-2">
            {% for t in tasks %}
              <div class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">{{ t.title }}</div>
                    <div class="text-xs text-brand-dark/70">
                      {{ t.get_status_display }}
                      {% if t.type %} ¬∑ {{ t.type.name }}{% endif %}
                      {% if t.assigned_to %} ¬∑ {{ t.assigned_to }}{% endif %}
                    </div>
                  </div>
                  <div class="text-xs text-brand-dark/70">
                    {% if t.due_at %}–¥–µ–¥–ª–∞–π–Ω: {{ t.due_at }}{% else %}‚Äî{% endif %}
                  </div>
                </div>
                {% if t.description %}
                  <div class="mt-2 text-sm text-brand-dark/80">{{ t.description|truncatechars:160 }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">–ó–∞–¥–∞—á –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
        {% endif %}
        <div class="mt-3">
          {% if can_edit_company %}
            <a class="btn btn-outline" href="/tasks/new/?company={{ company.id }}">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</a>
          {% endif %}
        </div>
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">–ó–∞–º–µ—Ç–∫–∏</div>
        <form class="space-y-2" method="post" action="/companies/{{ company.id }}/notes/add/" enctype="multipart/form-data" id="noteForm">
          {% csrf_token %}
          <div class="space-y-2">
            {{ note_form.text }}
            <div class="flex items-center justify-between gap-2">
              <input id="noteFile" type="file" name="attachment" class="hidden" />
              <button type="button" class="btn btn-outline" id="noteAttachBtn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" style="padding:.35rem .6rem;font-size:.75rem">
                üìé –§–∞–π–ª
              </button>
              <div class="text-xs muted-2 truncate" id="noteFileName"></div>
              <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="text-xs muted-2">–§–∞–π–ª –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –î–æ 15 –ú–ë. PDF/DOC/XLS/–∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –¥—Ä.</div>
          </div>
        </form>

        <div class="mt-4 space-y-3">
          {% for n in notes %}
            <div class="rounded-lg border p-3">
              <div class="flex items-start justify-between gap-3">
                <div class="text-xs text-brand-dark/70 mb-1">{{ n.created_at }} ¬∑ {{ n.author }}</div>
                {% if n.author_id == request.user.id or request.user.is_superuser or request.user.role == 'admin' or request.user.role == 'group_manager' %}
                  <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/delete/" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem">–£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                {% endif %}
              </div>
              <div class="text-sm whitespace-pre-line">{{ n.text }}</div>
              {% if n.attachment %}
                <div class="mt-2 rounded-lg border border-brand-soft bg-brand-soft/15 px-3 py-2">
                  <div class="flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        {% with ext=n.attachment_ext|upper %}
                          {% if ext == "PDF" %}
                            <span class="badge badge-warn">PDF</span>
                          {% elif ext == "DOC" or ext == "DOCX" %}
                            <span class="badge">DOC</span>
                          {% elif ext == "XLS" or ext == "XLSX" %}
                            <span class="badge">XLS</span>
                          {% elif ext == "PPT" or ext == "PPTX" %}
                            <span class="badge">PPT</span>
                          {% elif ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                            <span class="badge">IMG</span>
                          {% elif ext %}
                            <span class="badge">{{ ext }}</span>
                          {% else %}
                            <span class="badge">FILE</span>
                          {% endif %}
                        {% endwith %}
                        <div class="text-sm font-medium truncate">{{ n.attachment_name|default:"–§–∞–π–ª" }}</div>
                        {% if n.attachment_size %}<div class="text-xs muted-2">{{ n.attachment_size|filesizeformat }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="flex flex-wrap gap-2 shrink-0">
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/open/">–û—Ç–∫—Ä—ã—Ç—å</a>
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/download/">–°–∫–∞—á–∞—Ç—å</a>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          {% empty %}
            <div class="text-sm text-brand-dark/70">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫.</div>
          {% endfor %}
        </div>
      </section>
    </div>

    <script>
      (function(){
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }
        const csrftoken = getCookie('csrftoken');
        document.querySelectorAll('.js-call-phone').forEach(btn => {
          btn.addEventListener('click', async () => {
            const phone = btn.dataset.phone || '';
            const companyId = btn.dataset.company || '';
            const contactId = btn.dataset.contact || '';
            btn.disabled = true;
            const old = btn.textContent;
            btn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é...';
            try {
              const body = new URLSearchParams({phone, company_id: companyId, contact_id: contactId});
              const res = await fetch('/phone/call/', {
                method: 'POST',
                headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
                body: body.toString()
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok || !data.ok) throw new Error(data.detail || '–û—à–∏–±–∫–∞');
              btn.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úì';
              setTimeout(() => { btn.textContent = old; btn.disabled = false; }, 1200);
            } catch (e) {
              btn.textContent = old;
              btn.disabled = false;
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω: ' + (e && e.message ? e.message : e));
            }
          });
        });
      })();
    </script>

    <script>
      (function(){
        const btn = document.getElementById('noteAttachBtn');
        const input = document.getElementById('noteFile');
        const name = document.getElementById('noteFileName');
        if (!btn || !input) return;
        btn.addEventListener('click', () => input.click());
        input.addEventListener('change', () => {
          const f = input.files && input.files.length ? input.files[0] : null;
          if (name) name.textContent = f ? f.name : '';
        });
      })();
    </script>

    <details class="card card-pad">
      <summary class="cursor-pointer font-medium">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</summary>
      <div class="mt-3">
        {% if activity %}
          <div class="space-y-2">
            {% for ev in activity %}
              <div class="rounded-lg border p-3 text-sm">
                <div class="text-xs text-brand-dark/70 mb-1">{{ ev.created_at }} ¬∑ {{ ev.actor|default:"‚Äî" }}</div>
                <div>{{ ev.message|default:ev.get_verb_display }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>
        {% endif %}
      </div>
    </details>
  </div>
{% endblock %}


