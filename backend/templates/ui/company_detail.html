{% extends "ui/base.html" %}
{% block title %}{{ company.name }} — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-6">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm text-brand-dark/70"><a class="underline" href="/companies/">Компании</a> /</div>
        <h1 class="text-2xl font-semibold">{{ company.name }}</h1>
        <div class="text-sm text-brand-dark/80">
          {% if company.inn %}ИНН: <span class="font-mono">{{ company.inn }}</span>{% endif %}
          {% if company.kpp %} · КПП: <span class="font-mono">{{ company.kpp }}</span>{% endif %}
        </div>
        {% if pinned_note %}
          <div class="mt-3 rounded-xl border border-brand-soft bg-brand-soft/15 px-3 py-2">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Закреплено</span>
                  <div class="text-xs muted-2 truncate">{{ pinned_note.author|default:"—" }} · {{ pinned_note.created_at }}</div>
                </div>
                {% if pinned_note.text %}
                  <div class="mt-1 text-sm whitespace-pre-line">{{ pinned_note.text|truncatechars:220 }}</div>
                {% endif %}
                {% if pinned_note.attachment %}
                  <div class="mt-2 flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        {% with ext=pinned_note.attachment_ext|upper %}
                          {% if ext == "PDF" %}
                            <span class="badge badge-warn">PDF</span>
                          {% elif ext == "DOC" or ext == "DOCX" %}
                            <span class="badge">DOC</span>
                          {% elif ext == "XLS" or ext == "XLSX" %}
                            <span class="badge">XLS</span>
                          {% elif ext == "PPT" or ext == "PPTX" %}
                            <span class="badge">PPT</span>
                          {% elif ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                            <span class="badge">IMG</span>
                          {% elif ext %}
                            <span class="badge">{{ ext }}</span>
                          {% else %}
                            <span class="badge">FILE</span>
                          {% endif %}
                        {% endwith %}
                        <div class="text-xs font-medium truncate">{{ pinned_note.attachment_name|default:"Файл" }}</div>
                        {% if pinned_note.attachment_size %}<div class="text-xs muted-2">{{ pinned_note.attachment_size|filesizeformat }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="flex gap-2 shrink-0">
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/file/open/">Открыть</a>
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/file/download/">Скачать</a>
                    </div>
                  </div>
                {% endif %}
              </div>
              {% if can_edit_company %}
                <form method="post" action="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/pin/">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" title="Открепить" aria-label="Открепить">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M14 4l6 6-3 3v5H7v-5L4 10l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 22v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endif %}
        {% if can_edit_company %}
          <div class="mt-2">
            <a class="btn btn-outline" href="/companies/{{ company.id }}/edit/">Редактировать данные</a>
          </div>
        {% endif %}
      </div>
      <div class="text-sm text-brand-dark/80">
        <div><span class="text-brand-dark/50">Ответственный:</span> {{ company.responsible }}</div>
        <div><span class="text-brand-dark/50">Филиал:</span> {{ company.branch }}</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card card-pad lg:col-span-2">
        <div class="font-medium mb-3">Данные</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <div>
            <div class="text-brand-dark/50">Юр. название</div>
            <div>{{ company.legal_name|default:"—" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Сайт</div>
            <div>{% if company.website %}<a class="link" href="{{ company.website }}" target="_blank">{{ company.website }}</a>{% else %}—{% endif %}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Телефон (основной)</div>
            <div class="flex items-center justify-between gap-2">
              <div class="font-mono text-xs">{{ company.phone|default:"—" }}</div>
              {% if company.phone %}
                <button
                  type="button"
                  class="btn btn-outline js-call-phone"
                  style="padding:.25rem .5rem;font-size:.75rem"
                  data-phone="{{ company.phone }}"
                  data-company="{{ company.id }}"
                  data-contact=""
                >
                  Позвонить с телефона
                </button>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Email (основной)</div>
            <div>
              {% if company.email %}
                <a class="link font-mono text-xs" href="mailto:{{ company.email }}">{{ company.email }}</a>
              {% else %}
                —
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Контакт (ФИО)</div>
            <div>{{ company.contact_name|default:"—" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Контакт (должность)</div>
            <div>{{ company.contact_position|default:"—" }}</div>
          </div>
          <div class="md:col-span-2">
            <div class="text-brand-dark/50">Адрес</div>
            <div class="whitespace-pre-line">{{ company.address|default:"—" }}</div>
          </div>
        </div>
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Быстро</div>
        {% if can_edit_company %}
          <a class="btn btn-primary w-full" href="/tasks/new/?company={{ company.id }}">+ Поставить задачу</a>
          <div class="mt-3">
            <div class="text-xs text-brand-dark/70 mb-1">Передать другому менеджеру</div>
            <form method="post" action="/companies/{{ company.id }}/transfer/" class="flex gap-2">
              {% csrf_token %}
              <select name="responsible_id" class="select">
                <option value="">Выберите менеджера…</option>
                {% for u in transfer_targets %}
                  <option value="{{ u.id }}">{{ u }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-outline" type="submit">Передать</button>
            </form>
            <div class="text-xs muted-2 mt-1">При передаче филиал компании обновится под филиал нового ответственного.</div>
          </div>
        {% else %}
          <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
            У вас доступ <b>только на просмотр</b>. Редактировать может создатель/ответственный/директор филиала/управляющий.
          </div>
        {% endif %}
        <div class="mt-4 border-t pt-4">
          <div class="font-medium mb-2">Статус и сферы</div>
          {% if can_edit_company %}
            <form method="post" action="/companies/{{ company.id }}/update/" class="space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Статус</label>
                {{ quick_form.status|safe }}
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Сферы</label>
                <div class="ms" data-ms="1" data-placeholder="Выберите сферы">
                  <button type="button" class="ms-btn">
                    <span class="ms-value"></span>
                    <span class="ms-muted">▼</span>
                  </button>
                  <div class="ms-panel hidden">
                    <div class="ms-top">
                      <input class="input ms-search" placeholder="Поиск" />
                      <a href="#" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" data-ms-clear>Снять</a>
                    </div>
                    <div class="ms-list"></div>
                  </div>
                  <div class="hidden">
                    {{ quick_form.spheres }}
                  </div>
                </div>
              </div>
              <button class="btn btn-outline w-full" type="submit">Сохранить</button>
            </form>
          {% else %}
            <div class="text-sm text-brand-dark/70 space-y-2">
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">Статус</div>
                <div>{{ company.status|default:"—" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">Сферы</div>
                <div class="flex flex-wrap gap-1">
                  {% for s in company.spheres.all %}
                    <span class="badge">{{ s.name }}</span>
                  {% empty %}
                    <span class="text-brand-dark/70">—</span>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <section class="card card-pad">
        <div class="flex items-end justify-between gap-3 mb-3">
          <div class="font-medium">Контакты</div>
          {% if can_edit_company %}
            <a class="btn btn-outline" href="/companies/{{ company.id }}/contacts/new/">+ Добавить контакт</a>
          {% endif %}
        </div>
        {% if contacts %}
          <div class="space-y-3">
            {% for c in contacts %}
              <div class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">{{ c.last_name }} {{ c.first_name }}</div>
                    <div class="text-xs text-brand-dark/70">{{ c.position }}</div>
                  </div>
                  {% if can_edit_company %}
                    <a class="text-sm link" href="/contacts/{{ c.id }}/edit/">Редактировать</a>
                  {% endif %}
                </div>
                <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                  <div>
                    <div class="text-brand-dark/50 text-xs">Email</div>
                    {% for e in c.emails.all %}
                      <div>{{ e.value }}</div>
                    {% empty %}
                      <div class="text-brand-dark/70">—</div>
                    {% endfor %}
                  </div>
                  <div>
                    <div class="text-brand-dark/50 text-xs">Телефон</div>
                    {% for p in c.phones.all %}
                      <div class="flex items-center justify-between gap-2">
                        <div class="font-mono text-xs">{{ p.value }}</div>
                        <button
                          type="button"
                          class="btn btn-outline js-call-phone"
                          style="padding:.25rem .5rem;font-size:.75rem"
                          data-phone="{{ p.value }}"
                          data-company="{{ company.id }}"
                          data-contact="{{ c.id }}"
                        >
                          Позвонить с телефона
                        </button>
                      </div>
                    {% empty %}
                      <div class="text-brand-dark/70">—</div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">Контактов нет.</div>
        {% endif %}
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Последние задачи</div>
        {% if tasks %}
          <div class="space-y-2">
            {% for t in tasks %}
              <div class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">{{ t.title }}</div>
                    <div class="text-xs text-brand-dark/70">
                      {{ t.get_status_display }}
                      {% if t.type %} · {{ t.type.name }}{% endif %}
                      {% if t.assigned_to %} · {{ t.assigned_to }}{% endif %}
                    </div>
                  </div>
                  <div class="text-xs text-brand-dark/70">
                    {% if t.due_at %}дедлайн: {{ t.due_at }}{% else %}—{% endif %}
                  </div>
                </div>
                {% if t.description %}
                  <div class="mt-2 text-sm text-brand-dark/80">{{ t.description|truncatechars:160 }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">Задач по компании пока нет.</div>
        {% endif %}
        <div class="mt-3">
          {% if can_edit_company %}
            <a class="btn btn-outline" href="/tasks/new/?company={{ company.id }}">+ Добавить задачу</a>
          {% endif %}
        </div>
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Заметки</div>
        <form class="space-y-2" method="post" action="/companies/{{ company.id }}/notes/add/" enctype="multipart/form-data" id="noteForm">
          {% csrf_token %}
          <div class="space-y-2">
            {{ note_form.text }}
            <div class="flex items-center justify-between gap-2">
              <input id="noteFile" type="file" name="attachment" class="hidden" />
              <button type="button" class="btn btn-outline" id="noteAttachBtn" title="Прикрепить файл" style="padding:.35rem .6rem;font-size:.75rem">
                <span class="inline-flex items-center gap-1">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M8 12.5l7.1-7.1a3 3 0 014.2 4.2l-8.5 8.5a5 5 0 01-7.1-7.1l8.2-8.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>Файл</span>
                </span>
              </button>
              <div class="text-xs muted-2 truncate" id="noteFileName"></div>
              <button class="btn btn-primary" type="submit">Добавить</button>
            </div>
            <div class="text-xs muted-2">Файл опционально. До 15 МБ. PDF/DOC/XLS/картинки и др.</div>
          </div>
        </form>

        <div class="mt-4 space-y-3">
          {% for n in notes %}
            <div class="rounded-lg border p-3">
              <div class="flex items-start justify-between gap-3">
                <div class="text-xs text-brand-dark/70 mb-1">
                  {{ n.created_at }} · {{ n.author }}
                  {% if n.is_pinned %}· <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Закреплено</span>{% endif %}
                </div>
                {% if n.author_id == request.user.id or request.user.is_superuser or request.user.role == 'admin' or request.user.role == 'group_manager' %}
                  <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/delete/" onsubmit="return confirm('Удалить заметку?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem">Удалить</button>
                  </form>
                {% endif %}
              </div>
              {% if can_edit_company %}
                <div class="mt-1">
                  <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/pin/" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" title="{% if n.is_pinned %}Открепить{% else %}Закрепить{% endif %}" aria-label="{% if n.is_pinned %}Открепить{% else %}Закрепить{% endif %}">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M14 4l6 6-3 3v5H7v-5L4 10l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 22v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </form>
                </div>
              {% endif %}
              <div class="text-sm whitespace-pre-line">{{ n.text }}</div>
              {% if n.attachment %}
                <div class="mt-2 rounded-lg border border-brand-soft bg-brand-soft/15 px-3 py-2">
                  <div class="flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        {% with ext=n.attachment_ext|upper %}
                          {% if ext == "PDF" %}
                            <span class="badge badge-warn">PDF</span>
                          {% elif ext == "DOC" or ext == "DOCX" %}
                            <span class="badge">DOC</span>
                          {% elif ext == "XLS" or ext == "XLSX" %}
                            <span class="badge">XLS</span>
                          {% elif ext == "PPT" or ext == "PPTX" %}
                            <span class="badge">PPT</span>
                          {% elif ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                            <span class="badge">IMG</span>
                          {% elif ext %}
                            <span class="badge">{{ ext }}</span>
                          {% else %}
                            <span class="badge">FILE</span>
                          {% endif %}
                        {% endwith %}
                        <div class="text-sm font-medium truncate">{{ n.attachment_name|default:"Файл" }}</div>
                        {% if n.attachment_size %}<div class="text-xs muted-2">{{ n.attachment_size|filesizeformat }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="flex flex-wrap gap-2 shrink-0">
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/open/">Открыть</a>
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/download/">Скачать</a>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          {% empty %}
            <div class="text-sm text-brand-dark/70">Пока нет заметок.</div>
          {% endfor %}
        </div>
      </section>
    </div>

    <script>
      (function(){
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }
        const csrftoken = getCookie('csrftoken');
        document.querySelectorAll('.js-call-phone').forEach(btn => {
          btn.addEventListener('click', async () => {
            const phone = btn.dataset.phone || '';
            const companyId = btn.dataset.company || '';
            const contactId = btn.dataset.contact || '';
            btn.disabled = true;
            const old = btn.textContent;
            btn.textContent = 'Отправляю...';
            try {
              const body = new URLSearchParams({phone, company_id: companyId, contact_id: contactId});
              const res = await fetch('/phone/call/', {
                method: 'POST',
                headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
                body: body.toString()
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok || !data.ok) throw new Error(data.detail || 'Ошибка');
              btn.textContent = 'Отправлено ✓';
              setTimeout(() => { btn.textContent = old; btn.disabled = false; }, 1200);
            } catch (e) {
              btn.textContent = old;
              btn.disabled = false;
              alert('Не удалось отправить команду на телефон: ' + (e && e.message ? e.message : e));
            }
          });
        });
      })();
    </script>

    <script>
      (function(){
        const btn = document.getElementById('noteAttachBtn');
        const input = document.getElementById('noteFile');
        const name = document.getElementById('noteFileName');
        if (!btn || !input) return;
        btn.addEventListener('click', () => input.click());
        input.addEventListener('change', () => {
          const f = input.files && input.files.length ? input.files[0] : null;
          if (name) name.textContent = f ? f.name : '';
        });
      })();
    </script>

    <details class="card card-pad">
      <summary class="cursor-pointer font-medium">История действий</summary>
      <div class="mt-3">
        {% if activity %}
          <div class="space-y-2">
            {% for ev in activity %}
              <div class="rounded-lg border p-3 text-sm">
                <div class="text-xs text-brand-dark/70 mb-1">{{ ev.created_at }} · {{ ev.actor|default:"—" }}</div>
                <div>{{ ev.message|default:ev.get_verb_display }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">Пока пусто.</div>
        {% endif %}
      </div>
    </details>
  </div>
{% endblock %}


