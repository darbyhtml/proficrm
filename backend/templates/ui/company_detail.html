{% extends "ui/base.html" %}
{% load ui_extras %}
{% block title %}{{ company.name }} — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-6">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm text-brand-dark/70"><a class="underline" href="/companies/">Компании</a> /</div>
        <div class="flex items-start justify-between gap-3">
          <h1 class="text-2xl font-semibold">
            {{ company.name }}
            {% if is_cold_company %}
              <span class="badge badge-warn ml-2" style="padding:.15rem .45rem;font-size:.7rem">Холодный контакт</span>
            {% else %}
              <span class="badge ml-2" style="padding:.15rem .45rem;font-size:.7rem">Теплый контакт</span>
            {% endif %}
          </h1>
          <div class="flex items-center gap-2 shrink-0">
            {% if can_delete_company %}
              <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem;border-color:rgba(239,68,68,.35);color:#b91c1c;background:rgba(239,68,68,.06)" id="openDeleteCompanyModal">Удалить</button>
            {% elif can_request_delete %}
              <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem;border-color:rgba(239,68,68,.35);color:#b91c1c;background:rgba(239,68,68,.06)" id="openDeleteRequestModal">
                {% if delete_req %}Запрос отправлен{% else %}Запросить удаление{% endif %}
              </button>
            {% endif %}
            {% if can_request_lead_state %}
              <button
                type="button"
                class="btn btn-outline"
                style="padding:.35rem .6rem;font-size:.75rem"
                id="openLeadStateReqModal"
                {% if lead_state_req %}disabled{% endif %}
                title="{% if lead_state_req %}Запрос уже отправлен{% else %}Запросить смену состояния{% endif %}"
              >
                {% if lead_state_req %}
                  Запрос состояния
                {% else %}
                  Сделать теплым
                {% endif %}
              </button>
            {% endif %}
          </div>
        </div>
        <div class="text-sm text-brand-dark/80">
          {% if company.inn %}ИНН: <span class="font-mono">{{ company.inn }}</span>{% endif %}
          {% if company.kpp %} · КПП: <span class="font-mono">{{ company.kpp }}</span>{% endif %}
        </div>

        {% if delete_req %}
          {% if can_delete_company or can_request_delete %}
          <div class="mt-3 rounded-xl border border-brand-orange/60 bg-brand-orange/15 px-4 py-3 text-sm text-brand-dark">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-medium">Запрос на удаление</div>
                <div class="text-xs muted-2 mt-1">
                  От: <b>{{ delete_req.requested_by|default:"—" }}</b> · {{ delete_req.created_at }}
                </div>
                {% if delete_req.note %}
                  <div class="mt-2 whitespace-pre-line">{{ delete_req.note }}</div>
                {% endif %}
              </div>
              {% if can_delete_company %}
                <div class="flex flex-col gap-2 shrink-0">
                  <button type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" id="openCancelDeleteReqModal">Отменить запрос</button>
                  <form method="post" action="/companies/{{ company.id }}/delete-request/{{ delete_req.id }}/approve/" onsubmit="return confirm('Подтвердить удаление компании?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary" style="padding:.35rem .6rem;font-size:.75rem;background:#b91c1c">Подтвердить удаление</button>
                  </form>
                </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        {% endif %}
        {% if lead_state_req %}
          {% if can_decide_lead_state or can_request_lead_state %}
            <div class="mt-3 rounded-xl border border-brand-orange/60 bg-brand-orange/15 px-4 py-3 text-sm text-brand-dark">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="font-medium">Запрос смены состояния</div>
                  <div class="text-xs muted-2 mt-1">
                    От: <b>{{ lead_state_req.requested_by|default:"—" }}</b> · {{ lead_state_req.created_at }}
                  </div>
                  <div class="mt-2 flex flex-wrap items-center gap-2">
                    <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Нужно изменить</span>
                    <span class="text-sm">
                      → <b>{% if lead_state_req.requested_state == "warm" %}Теплый контакт{% else %}Холодный контакт{% endif %}</b>
                    </span>
                  </div>
                  {% if lead_state_req.note %}
                    <div class="mt-2 whitespace-pre-line">{{ lead_state_req.note }}</div>
                  {% endif %}
                  <div class="text-xs muted-2 mt-2">
                    После решения запрос будет закрыт, а уведомление у второго руководителя исчезнет.
                  </div>
                </div>
                {% if can_decide_lead_state %}
                  <div class="flex flex-col gap-2 shrink-0">
                    <button
                      type="button"
                      class="btn btn-outline"
                      style="padding:.35rem .6rem;font-size:.75rem;border-color:rgba(239,68,68,.35);color:#b91c1c;background:rgba(239,68,68,.06)"
                      id="openCancelLeadStateReqModal"
                    >
                      Отклонить
                    </button>
                    <form method="post" action="/companies/{{ company.id }}/lead-state/request/{{ lead_state_req.id }}/approve/" onsubmit="return confirm('Подтвердить смену состояния карточки?');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-primary" style="padding:.35rem .6rem;font-size:.75rem">Подтвердить</button>
                    </form>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endif %}
        {% if pinned_note %}
          <div class="mt-3 rounded-xl border border-brand-soft bg-brand-soft/15 px-3 py-2">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Закреплено</span>
                  <div class="text-xs muted-2 truncate">{{ pinned_note.author|default:"—" }} · {{ pinned_note.created_at }}</div>
                </div>
                {% if pinned_note.text %}
                  <div class="mt-1 text-sm whitespace-pre-line">{{ pinned_note.text|truncatechars:220 }}</div>
                {% endif %}
                {% if pinned_note.attachment %}
                  <div class="mt-2 flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        {% with ext=pinned_note.attachment_ext|upper %}
                          {% if ext == "PDF" %}
                            <span class="badge badge-warn">PDF</span>
                          {% elif ext == "DOC" or ext == "DOCX" %}
                            <span class="badge">DOC</span>
                          {% elif ext == "XLS" or ext == "XLSX" %}
                            <span class="badge">XLS</span>
                          {% elif ext == "PPT" or ext == "PPTX" %}
                            <span class="badge">PPT</span>
                          {% elif ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                            <span class="badge">IMG</span>
                          {% elif ext %}
                            <span class="badge">{{ ext }}</span>
                          {% else %}
                            <span class="badge">FILE</span>
                          {% endif %}
                        {% endwith %}
                        <div class="text-xs font-medium truncate">{{ pinned_note.attachment_name|default:"Файл" }}</div>
                        {% if pinned_note.attachment_size %}<div class="text-xs muted-2">{{ pinned_note.attachment_size|filesizeformat }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="flex gap-2 shrink-0">
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/file/open/">Открыть</a>
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/file/download/">Скачать</a>
                    </div>
                  </div>
                {% endif %}
              </div>
              {% if can_edit_company %}
                <form method="post" action="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/pin/">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" title="Открепить" aria-label="Открепить">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 17v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endif %}
        {% if can_edit_company %}
          <div class="mt-2">
            <a class="btn btn-outline" href="/companies/{{ company.id }}/edit/">Редактировать данные</a>
          </div>
        {% endif %}
      </div>
      <div class="text-sm text-brand-dark/80">
        <div><span class="text-brand-dark/50">Ответственный:</span> {{ company.responsible }}</div>
        <div><span class="text-brand-dark/50">Филиал:</span> {{ company.branch }}</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card card-pad lg:col-span-2">
        <div class="font-medium mb-3">Данные</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <div class="md:col-span-2">
            <div class="text-brand-dark/50">Организация</div>
            <div class="flex flex-wrap items-center gap-2">
              {% if org_head %}
                {% if org_head.id == company.id %}
                  <span class="badge">Головная</span>
                  <div class="font-medium">{{ org_head.name }}</div>
                {% else %}
                  <span class="badge">Филиал</span>
                  <a class="link font-medium" href="/companies/{{ org_head.id }}/">{{ org_head.name }}</a>
                {% endif %}
              {% else %}
                <span class="text-brand-dark/70">—</span>
              {% endif %}
              {% if org_branches %}
                <span class="muted-2 text-xs">· филиалов: {{ org_branches|length }}</span>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Юр. название</div>
            <div>{{ company.legal_name|default:"—" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Сайт</div>
            <div>
              {% if company.website %}
                {% if "://" in company.website %}
                  <a class="link" href="{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                {% elif company.website|slice:":2" == "//" %}
                  <a class="link" href="https:{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                {% else %}
                  <a class="link" href="https://{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                {% endif %}
              {% else %}
                —
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Вид деятельности</div>
            <div>{{ company.activity_kind|default:"—" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Руководитель</div>
            <div>{{ company.contact_name|default:"—" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Состояние</div>
            <div class="flex flex-wrap items-center gap-2">
              {% if is_cold_company %}
                <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Холодный контакт</span>
              {% else %}
                <span class="badge" style="padding:.1rem .35rem;font-size:.65rem">Теплый контакт</span>
              {% endif %}
              {% if can_set_warm %}
                <form method="post" action="/companies/{{ company.id }}/lead-state/set/">
                  {% csrf_token %}
                  <input type="hidden" name="lead_state" value="warm" />
                  <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" type="submit">
                    Сделать теплым
                  </button>
                </form>
              {% elif can_revert_lead_state %}
                <form method="post" action="/companies/{{ company.id }}/lead-state/set/">
                  {% csrf_token %}
                  <input type="hidden" name="lead_state" value="cold" />
                  <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem;border-color:rgba(239,68,68,.35);color:#b91c1c;background:rgba(239,68,68,.06)" type="submit" onclick="return confirm('Вернуть в «Холодный контакт»?');">
                    Вернуть в холодный (админ)
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
          <div class="{% if contract_alert == 'danger' %}rounded-xl border border-red-400/40 bg-red-500/5 p-2 -m-2{% elif contract_alert == 'warn' %}rounded-xl border border-brand-orange/50 bg-brand-orange/10 p-2 -m-2{% endif %}">
            <div class="text-brand-dark/50 flex items-center gap-2">
              <span>Договор</span>
              {% if contract_alert == 'danger' %}
                <span class="badge badge-danger" style="padding:.1rem .35rem;font-size:.65rem">Срочно</span>
              {% elif contract_alert == 'warn' %}
                <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Остался месяц</span>
              {% endif %}
            </div>
            <div class="flex items-start justify-between gap-2">
              <div class="text-sm">
                {% if company.contract_type %}{{ company.get_contract_type_display }}{% else %}—{% endif %}
                {% if company.contract_until %}
                  <span class="muted-2">· до {{ company.contract_until|date:"d.m.Y" }}</span>
                  {% if contract_days_left is not None %}
                    <span class="muted-2">· осталось {{ contract_days_left }} дн.</span>
                  {% endif %}
                {% endif %}
              </div>
              {% if can_edit_company %}
                <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" id="openContractModal">Изменить</button>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Телефон (основной)</div>
            <div class="flex items-center justify-between gap-2">
              <div class="font-mono text-xs">{{ company.phone|format_phone|default:"—" }}</div>
              {% if company.phone %}
                <div class="flex items-center gap-2 shrink-0">
                  {% if can_edit_company %}
                    {% if not company.primary_contact_is_cold_call and not company.primary_cold_marked_at %}
                      <form method="post" action="/companies/{{ company.id }}/cold-call/toggle/" style="display:inline" class="js-cold-call-form" data-confirm="Вы действительно хотите отметить звонок как холодный?">
                        {% csrf_token %}
                        <input type="hidden" name="confirmed" value="1">
                        <button
                          type="submit"
                          class="btn btn-outline js-cold-mark"
                          data-cold-btn="primary"
                          style="padding:.25rem .5rem;font-size:.75rem;"
                          title="Отметить холодный звонок"
                          aria-label="Отметить холодный звонок"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M12 2v20M4 6l16 12M20 6 4 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 4l12 16M18 4 6 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity=".35"/>
                          </svg>
                        </button>
                      </form>
                    {% elif is_admin %}
                      {% if company.primary_contact_is_cold_call or company.primary_cold_marked_at %}
                      <form method="post" action="/companies/{{ company.id }}/cold-call/reset/" style="display:inline">
                        {% csrf_token %}
                        <button
                          type="submit"
                          class="btn btn-outline"
                          style="padding:.25rem .5rem;font-size:.75rem;background:#003D38;color:#fff;border-color:rgba(0,61,56,.35);"
                          title="Откатить отметку холодного звонка (только для администраторов)"
                          aria-label="Откатить отметку холодного звонка"
                          onclick="return confirm('Откатить отметку холодного звонка?');"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </form>
                      {% endif %}
                    {% endif %}
                  {% endif %}
                  <button
                    type="button"
                    class="btn btn-outline js-call-phone"
                    style="padding:.25rem .5rem"
                    data-phone="{{ company.phone }}"
                    data-company="{{ company.id }}"
                    data-contact=""
                    title="Позвонить с телефона"
                    aria-label="Позвонить с телефона"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              {% endif %}
            </div>
            {% if company.primary_contact_is_cold_call or company.primary_cold_marked_at %}
              <div class="mt-1 text-xs text-brand-dark/60">
                <span class="font-medium">Холодный звонок:</span>
                {% if company.primary_cold_marked_at %}
                  {{ company.primary_cold_marked_at|date:"d.m.Y H:i" }}
                {% endif %}
                {% if company.primary_cold_marked_by %}
                  ({{ company.primary_cold_marked_by }})
                {% endif %}
                {% if not company.primary_contact_is_cold_call and company.primary_cold_marked_at %}
                  <span class="text-brand-dark/40 ml-1">(откат)</span>
                {% endif %}
              </div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Дополнительные телефоны</div>
            <div class="space-y-2">
              {% for phone in company.phones.all %}
                <div>
                  <div class="flex items-center justify-between gap-2">
                    <div class="font-mono text-xs">{{ phone.value|format_phone }}</div>
                    {% if phone.value %}
                      <div class="flex items-center gap-2 shrink-0">
                        {% if can_edit_company %}
                          {% if not phone.is_cold_call and not phone.cold_marked_at %}
                            <form method="post" action="/company-phones/{{ phone.id }}/cold-call/toggle/" style="display:inline" class="js-cold-call-form" data-confirm="Вы действительно хотите отметить звонок как холодный?">
                              {% csrf_token %}
                              <input type="hidden" name="confirmed" value="1">
                              <button
                                type="submit"
                                class="btn btn-outline"
                                style="padding:.25rem .5rem;font-size:.75rem;"
                                title="Отметить холодный звонок"
                                aria-label="Отметить холодный звонок"
                              >
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                  <path d="M12 2v20M4 6l16 12M20 6 4 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  <path d="M6 4l12 16M18 4 6 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity=".35"/>
                                </svg>
                              </button>
                            </form>
                          {% elif is_admin %}
                            {% if phone.is_cold_call or phone.cold_marked_at %}
                              <form method="post" action="/company-phones/{{ phone.id }}/cold-call/reset/" style="display:inline">
                                {% csrf_token %}
                                <button
                                  type="submit"
                                  class="btn btn-outline"
                                  style="padding:.25rem .5rem;font-size:.75rem;background:#003D38;color:#fff;border-color:rgba(0,61,56,.35);"
                                  title="Откатить отметку холодного звонка (только для администраторов)"
                                  aria-label="Откатить отметку холодного звонка"
                                  onclick="return confirm('Откатить отметку холодного звонка?');"
                                >
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                    <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  </svg>
                                </button>
                              </form>
                            {% endif %}
                          {% endif %}
                        {% endif %}
                        <button
                          type="button"
                          class="btn btn-outline js-call-phone"
                          style="padding:.25rem .5rem"
                          data-phone="{{ phone.value }}"
                          data-company="{{ company.id }}"
                          data-contact=""
                          title="Позвонить с телефона"
                          aria-label="Позвонить с телефона"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    {% endif %}
                  </div>
                  {% if phone.is_cold_call or phone.cold_marked_at %}
                    <div class="mt-1 text-xs text-brand-dark/60">
                      <span class="font-medium">Холодный звонок:</span>
                      {% if phone.cold_marked_at %}
                        {{ phone.cold_marked_at|date:"d.m.Y H:i" }}
                      {% endif %}
                      {% if phone.cold_marked_by %}
                        ({{ phone.cold_marked_by.first_name }} {{ phone.cold_marked_by.last_name|default:"" }})
                      {% endif %}
                      {% if not phone.is_cold_call and phone.cold_marked_at %}
                        <span class="text-brand-dark/40 ml-1">(откат)</span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              {% empty %}
                —
              {% endfor %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Email адреса</div>
            <div class="space-y-1">
              {% if company.email %}
                <div>
                  <a class="link font-mono text-xs" href="mailto:{{ company.email }}">{{ company.email }}</a>
                  <span class="text-xs text-brand-dark/50 ml-1">(основной)</span>
                </div>
              {% endif %}
              {% for email in company.emails.all %}
                <div>
                  <a class="link font-mono text-xs" href="mailto:{{ email.value }}">{{ email.value }}</a>
                </div>
              {% endfor %}
              {% if not company.email and not company.emails.all %}
                —
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Контакт (ФИО)</div>
            <div>{{ company.contact_name|default:"—" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Контакт (должность)</div>
            <div>{{ company.contact_position|default:"—" }}</div>
          </div>
          <div class="md:col-span-2">
            <div class="text-brand-dark/50">Адрес</div>
            <div class="whitespace-pre-line">{{ company.address|default:"—" }}</div>
          </div>
        </div>

      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Быстро</div>
        {% if can_edit_company %}
          <a class="btn btn-primary w-full" href="/tasks/new/?company={{ company.id }}">+ Поставить задачу</a>
        {# переносим отметку холодного звонка (осн. контакт) к телефону в "Данные" #}
          <div class="mt-4 border-t pt-4">
            <div class="font-medium mb-2">Состояние контакта</div>
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="text-sm">
                {% if is_cold_company %}
                  <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Холодный контакт</span>
                {% else %}
                  <span class="badge" style="padding:.1rem .35rem;font-size:.65rem">Теплый контакт</span>
                {% endif %}
              </div>
              <div class="shrink-0">
                {% if can_set_warm %}
                  <form method="post" action="/companies/{{ company.id }}/lead-state/set/">
                    {% csrf_token %}
                    <input type="hidden" name="lead_state" value="warm" />
                    <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" type="submit">
                      Сделать теплым
                    </button>
                  </form>
                {% elif can_revert_lead_state %}
                  <form method="post" action="/companies/{{ company.id }}/lead-state/set/">
                    {% csrf_token %}
                    <input type="hidden" name="lead_state" value="cold" />
                    <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem;border-color:rgba(239,68,68,.35);color:#b91c1c;background:rgba(239,68,68,.06)" type="submit" onclick="return confirm('Вернуть в «Холодный контакт»?');">
                      Вернуть в холодный (админ)
                    </button>
                  </form>
                {% else %}
                  <div class="text-xs muted-2">Нет прав на смену состояния.</div>
                {% endif %}
              </div>
            </div>
            {% if lead_state_req %}
              <div class="text-xs muted-2 mt-2">Есть запрос на смену состояния — дождитесь решения руководителя.</div>
            {% endif %}
          </div>
          <div class="mt-3">
            <div class="text-xs text-brand-dark/70 mb-1">Передать другому менеджеру</div>
            <form method="post" action="/companies/{{ company.id }}/transfer/" class="flex gap-2">
              {% csrf_token %}
              <select name="responsible_id" class="select">
                <option value="">Выберите ответственного…</option>
                {% for u in transfer_targets %}
                  <option value="{{ u.id }}">{{ u }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-outline" type="submit">Передать</button>
            </form>
            <div class="text-xs muted-2 mt-1">При передаче филиал компании обновится под филиал нового ответственного.</div>
          </div>
        {% else %}
          <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
            У вас доступ <b>только на просмотр</b>. Редактировать может ответственный / руководитель филиала / управляющий / администратор.
          </div>
        {% endif %}
        <div class="mt-4 border-t pt-4">
          <div class="font-medium mb-2">Статус и сферы</div>
          {% if can_edit_company %}
            <form method="post" action="/companies/{{ company.id }}/update/" class="space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Статус</label>
                {{ quick_form.status|safe }}
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Сферы</label>
                <div class="ms" data-ms="1" data-placeholder="Выберите сферы">
                  <button type="button" class="ms-btn">
                    <span class="ms-value"></span>
                    <span class="ms-muted">▼</span>
                  </button>
                  <div class="ms-panel hidden">
                    <div class="ms-top">
                      <input class="input ms-search" placeholder="Поиск" />
                      <a href="#" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" data-ms-clear>Снять</a>
                    </div>
                    <div class="ms-list"></div>
                  </div>
                  <div class="hidden">
                    {{ quick_form.spheres }}
                  </div>
                </div>
              </div>
              <button class="btn btn-outline w-full" type="submit">Сохранить</button>
            </form>
          {% else %}
            <div class="text-sm text-brand-dark/70 space-y-2">
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">Статус</div>
                <div>{{ company.status|default:"—" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">Сферы</div>
                <div class="flex flex-wrap gap-1">
                  {% for s in company.spheres.all %}
                    <span class="badge">{{ s.name }}</span>
                  {% empty %}
                    <span class="text-brand-dark/70">—</span>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {% if org_head and org_head.id == company.id and org_branches %}
        <section class="card card-pad">
          <div class="font-medium mb-3">Филиалы организации</div>
          <div class="space-y-2">
            {% for b in org_branches %}
              <a class="block rounded-lg border p-3 hover:bg-brand-soft/20" href="/companies/{{ b.id }}/">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">{{ b.name }}</div>
                    <div class="text-xs muted-2">ИНН: {{ b.inn|default:"—" }} · Ответственный: {{ b.responsible|default:"—" }} · Филиал: {{ b.branch|default:"—" }}</div>
                  </div>
                </div>
              </a>
            {% endfor %}
          </div>
        </section>
      {% endif %}

      <section class="card card-pad">
        <div class="flex items-end justify-between gap-3 mb-3">
          <div class="font-medium">Контакты</div>
          {% if can_edit_company %}
            <a class="btn btn-outline" href="/companies/{{ company.id }}/contacts/new/">+ Добавить контакт</a>
          {% endif %}
        </div>
        {% if contacts %}
          <div class="space-y-3">
            {% for c in contacts %}
              <div class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <div class="text-sm font-medium">{{ c.last_name }} {{ c.first_name }}</div>
                    <div class="text-xs text-brand-dark/70">
                      {{ c.position }}
                    </div>
                  </div>
                  {% if can_edit_company %}
                    <div class="flex items-center gap-2">
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" href="/contacts/{{ c.id }}/edit/" title="Редактировать" aria-label="Редактировать">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </a>
                      <form method="post" action="/contacts/{{ c.id }}/delete/" onsubmit="return confirm('Удалить контакт?');" style="display:inline">
                        {% csrf_token %}
                        <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem;border-color:rgba(220,38,38,.5);color:#b91c1c;" title="Удалить контакт" aria-label="Удалить контакт">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  {% endif %}
                </div>
                <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                  <div>
                    <div class="text-brand-dark/50 text-xs">Email</div>
                    {% for e in c.emails.all %}
                      <div>{{ e.value }}</div>
                    {% empty %}
                      <div class="text-brand-dark/70">—</div>
                    {% endfor %}
                  </div>
                  <div>
                    <div class="text-brand-dark/50 text-xs">Телефон</div>
                    {% for p in c.phones.all %}
                      <div class="mb-2">
                        <div class="flex items-center justify-between gap-2">
                          <div class="flex-1">
                            <div class="font-mono text-xs">{{ p.value|format_phone }}</div>
                            {% if p.is_cold_call %}
                              <div class="mt-0.5 text-[10px] text-brand-dark/60">
                                <span class="font-medium">Холодный звонок:</span>
                                {% if p.cold_marked_at %}
                                  {{ p.cold_marked_at|date:"d.m.Y H:i" }}
                                {% endif %}
                                {% if p.cold_marked_by %}
                                  ({{ p.cold_marked_by.first_name }} {{ p.cold_marked_by.last_name|default:"" }})
                                {% endif %}
                              </div>
                            {% endif %}
                          </div>
                          <div class="flex items-center gap-1 shrink-0">
                            {% if can_edit_company %}
                              {% if not p.is_cold_call %}
                                <form method="post" action="/contact-phones/{{ p.id }}/cold-call/toggle/" class="js-cold-call-form" data-confirm="Вы действительно хотите отметить звонок как холодный?">
                                  {% csrf_token %}
                                  <input type="hidden" name="confirmed" value="1">
                                  <button
                                    class="btn btn-outline js-cold-mark"
                                    style="padding:.25rem .5rem"
                                    type="submit"
                                    data-cold-btn="phone-{{ p.id }}"
                                    title="Отметить холодный звонок"
                                    aria-label="Отметить холодный звонок"
                                  >
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                      <path d="M12 2v20M4 6l16 12M20 6 4 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                      <path d="M6 4l12 16M18 4 6 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity=".35"/>
                                    </svg>
                                  </button>
                                </form>
                              {% else %}
                                {% if is_admin %}
                                  <form method="post" action="/contact-phones/{{ p.id }}/cold-call/reset/" style="display:inline">
                                    {% csrf_token %}
                                    <button
                                      type="submit"
                                      class="btn btn-outline"
                                      style="padding:.25rem .5rem;background:#003D38;color:#fff;border-color:rgba(0,61,56,.35);"
                                      title="Откатить отметку холодного звонка (только для администраторов)"
                                      aria-label="Откатить отметку холодного звонка"
                                      onclick="return confirm('Откатить отметку холодного звонка?');"
                                    >
                                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                      </svg>
                                    </button>
                                  </form>
                                {% endif %}
                              {% endif %}
                            {% endif %}
                            <button
                              type="button"
                              class="btn btn-outline js-call-phone"
                              style="padding:.25rem .5rem"
                              data-phone="{{ p.value }}"
                              data-company="{{ company.id }}"
                              data-contact="{{ c.id }}"
                              title="Позвонить с телефона"
                              aria-label="Позвонить с телефона"
                            >
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>
                    {% empty %}
                      <div class="text-brand-dark/70">—</div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">Контактов нет.</div>
        {% endif %}
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Последние задачи</div>
        {% if tasks %}
          <div class="space-y-2">
            {% for t in tasks %}
              <div class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="mb-0.5">
                      {% if t.type %}
                        {% include "ui/partials/task_type_badge.html" with task_type=t.type only %}
                      {% elif t.title %}
                        <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-800">
                          {{ t.title }}
                        </span>
                      {% else %}
                        <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">Без статуса</span>
                      {% endif %}
                    </div>
                    <div class="text-xs text-brand-dark/70">
                      {{ t.get_status_display }}
                      {% if t.assigned_to %} · {{ t.assigned_to }}{% endif %}
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-brand-dark/70">
                      {% if t.due_at %}дедлайн: {{ t.due_at }}{% else %}—{% endif %}
                    </div>
                    <div class="mt-1 inline-flex gap-1 justify-end flex-wrap">
                      {% if t.can_edit_task %}
                        <button
                          type="button"
                          class="flex items-center justify-center w-6 h-6 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors"
                          data-edit-task
                          data-task-id="{{ t.id }}"
                          title="Редактировать"
                          aria-label="Редактировать"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                          </svg>
                        </button>
                      {% endif %}

                      {% if t.can_manage_status and t.status != 'in_progress' %}
                        <form method="post" action="/tasks/{{ t.id }}/status/" class="inline">
                          {% csrf_token %}
                          <button
                            name="status"
                            value="in_progress"
                            class="flex items-center justify-center w-6 h-6 rounded bg-brand-orange hover:opacity-90 text-white transition-colors"
                            title="В работу"
                            aria-label="В работу"
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
                              <path d="M8 2v4"/>
                              <path d="M16 2v4"/>
                              <path d="M8 10h8"/>
                              <path d="M8 14h8"/>
                            </svg>
                          </button>
                        </form>
                      {% endif %}

                      {% if t.can_manage_status and t.status != 'done' %}
                        <form method="post" action="/tasks/{{ t.id }}/status/" class="inline">
                          {% csrf_token %}
                          <button
                            name="status"
                            value="done"
                            class="flex items-center justify-center w-6 h-6 rounded bg-brand-teal hover:bg-brand-dark text-white transition-colors"
                            title="Выполнено"
                            aria-label="Выполнено"
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <polyline points="20 6 9 17 4 12"/>
                            </svg>
                          </button>
                        </form>
                      {% endif %}

                      {% if t.can_delete_task %}
                        <form method="post" action="/tasks/{{ t.id }}/delete/" onsubmit="return confirm('Удалить задачу?');" class="inline">
                          {% csrf_token %}
                          <button
                            class="flex items-center justify-center w-6 h-6 rounded bg-white border border-red-200 hover:bg-red-50 transition-colors"
                            title="Удалить"
                            aria-label="Удалить"
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7"/>
                            </svg>
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% if t.description %}
                  <div class="mt-2 text-sm text-brand-dark/80">{{ t.description|truncatechars:160 }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">Задач по компании пока нет.</div>
        {% endif %}
        <div class="mt-3">
          {% if can_edit_company %}
            <a class="btn btn-outline" href="/tasks/new/?company={{ company.id }}">+ Добавить задачу</a>
          {% endif %}
        </div>
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Заметки</div>
        {% if can_edit_company %}
          <form class="space-y-2" method="post" action="/companies/{{ company.id }}/notes/add/" enctype="multipart/form-data" id="noteForm">
            {% csrf_token %}
            <div class="space-y-2">
              {{ note_form.text }}
              <div class="flex items-center justify-between gap-2">
                <input id="noteFile" type="file" name="attachment" class="hidden" />
                <button type="button" class="btn btn-outline" id="noteAttachBtn" title="Прикрепить файл" style="padding:.35rem .6rem;font-size:.75rem">
                  <span class="inline-flex items-center gap-1">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M8 12.5l7.1-7.1a3 3 0 014.2 4.2l-8.5 8.5a5 5 0 01-7.1-7.1l8.2-8.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Файл</span>
                  </span>
                </button>
                <div class="text-xs muted-2 truncate" id="noteFileName"></div>
                <button class="btn btn-primary" type="submit">Добавить</button>
              </div>
              <div class="text-xs muted-2">Файл опционально. До 15 МБ. PDF/DOC/XLS/картинки и др.</div>
            </div>
          </form>
        {% else %}
          <div class="text-sm text-brand-dark/70">Нет прав на добавление заметок по этой компании.</div>
        {% endif %}

        <div class="mt-4 space-y-3">
          {% for n in notes %}
            <div class="rounded-lg border p-3">
              <div class="flex items-start justify-between gap-3">
                <div class="text-xs text-brand-dark/70 mb-1">
                  {{ n.created_at }} · {{ n.author }}
                  {% if n.is_pinned %}· <span class="badge badge-warn" style="padding:.1rem .35rem;font-size:.65rem">Закреплено</span>{% endif %}
                  {% if n.edited_at %}· <span class="muted-2">ред. {{ n.edited_at|date:"d.m.Y" }}</span>{% endif %}
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  {% if can_edit_company %}
                    <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/pin/" style="display:inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" title="{% if n.is_pinned %}Открепить{% else %}Закрепить{% endif %}" aria-label="{% if n.is_pinned %}Открепить{% else %}Закрепить{% endif %}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M12 17v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </form>
                  {% endif %}

                  {% if n.author_id == request.user.id or is_admin or is_group_manager %}
                    <button
                      type="button"
                      class="btn btn-outline"
                      style="padding:.25rem .5rem;font-size:.75rem"
                      title="Редактировать"
                      aria-label="Редактировать"
                      data-note-edit
                      data-note-id="{{ n.id }}"
                      data-note-text="{{ n.text|default:''|escapejs }}"
                      data-note-file="{{ n.attachment_name|default:''|escapejs }}"
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/delete/" onsubmit="return confirm('Удалить заметку?');" style="display:inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem;border-color:rgba(239,68,68,.35);color:#b91c1c;background:rgba(239,68,68,.06)" title="Удалить" aria-label="Удалить">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
              <div class="text-sm whitespace-pre-line wrap-anywhere">{{ n.text }}</div>
              {% if n.attachment %}
                <div class="mt-2 rounded-lg border border-brand-soft bg-brand-soft/15 px-3 py-2">
                  <div class="flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        {% with ext=n.attachment_ext|upper %}
                          {% if ext == "PDF" %}
                            <span class="badge badge-warn">PDF</span>
                          {% elif ext == "DOC" or ext == "DOCX" %}
                            <span class="badge">DOC</span>
                          {% elif ext == "XLS" or ext == "XLSX" %}
                            <span class="badge">XLS</span>
                          {% elif ext == "PPT" or ext == "PPTX" %}
                            <span class="badge">PPT</span>
                          {% elif ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                            <span class="badge">IMG</span>
                          {% elif ext %}
                            <span class="badge">{{ ext }}</span>
                          {% else %}
                            <span class="badge">FILE</span>
                          {% endif %}
                        {% endwith %}
                        <div class="text-sm font-medium truncate">{{ n.attachment_name|default:"Файл" }}</div>
                        {% if n.attachment_size %}<div class="text-xs muted-2">{{ n.attachment_size|filesizeformat }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="flex flex-wrap gap-2 shrink-0">
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/open/">Открыть</a>
                      <a class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/download/">Скачать</a>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          {% empty %}
            <div class="text-sm text-brand-dark/70">Пока нет заметок.</div>
          {% endfor %}
        </div>
      </section>
    </div>

    <div id="noteEditModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-noteedit></div>
      <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-medium">Редактировать заметку</div>
              <div class="text-xs muted-2 mt-1">После сохранения появится метка «ред.»</div>
            </div>
            <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-noteedit aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <form method="post" id="noteEditForm" class="mt-3 space-y-2" enctype="multipart/form-data">
            {% csrf_token %}
            <div>
              <label class="block text-xs text-brand-dark/70 mb-1">Текст</label>
              <textarea name="text" id="noteEditText" class="textarea" rows="5" placeholder="Текст заметки..."></textarea>
              <div class="text-xs muted-2 mt-1">Можно заменить/добавить файл или удалить текущий.</div>
            </div>
            <div class="rounded-xl border border-brand-soft bg-brand-soft/10 p-3">
              <div class="flex items-center justify-between gap-2">
                <div class="text-xs text-brand-dark/70">Файл</div>
                <label class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem;cursor:pointer">
                  Выбрать файл
                  <input type="file" name="attachment" id="noteEditFile" class="hidden" />
                </label>
              </div>
              <div class="mt-2 text-xs">
                <div class="muted-2" id="noteEditFileCurrent">Текущий файл: —</div>
                <div class="muted-2" id="noteEditFileSelected"></div>
              </div>
              <div class="mt-2 flex items-center justify-between gap-2">
                <label class="inline-flex items-center gap-2 text-xs">
                  <input type="checkbox" id="noteEditRemoveFile" />
                  <span>Удалить текущий файл</span>
                </label>
                <input type="hidden" name="remove_attachment" id="noteEditRemoveHidden" value="0" />
              </div>
              <div class="text-[11px] muted-2 mt-2">Если выбрать новый файл — старый будет удалён с сервера.</div>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary" type="submit">Сохранить</button>
              <button class="btn btn-outline" type="button" data-close-noteedit>Отмена</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% if can_request_delete %}
      <div id="deleteRequestModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-delreq></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Запросить удаление компании</div>
                <div class="text-xs muted-2 mt-1">Опишите причину — запрос уйдёт РОП и директору филиала.</div>
              </div>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-delreq aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete-request/" class="mt-3 space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Примечание</label>
                <textarea name="note" class="textarea" rows="5" placeholder="Почему нужно удалить карточку?">{{ delete_req.note|default:"" }}</textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary" type="submit">Отправить запрос</button>
                <button class="btn btn-outline" type="button" data-close-delreq>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if can_request_lead_state %}
      <div id="leadStateReqModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-leadstate></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Запросить смену состояния карточки</div>
                <div class="text-xs muted-2 mt-1">Запрос уйдёт РОП и директору филиала (после решения у второго уведомление исчезнет).</div>
              </div>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-leadstate aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/lead-state/request/" class="mt-3 space-y-2">
              {% csrf_token %}
              <input type="hidden" name="requested_state" value="warm" />
              <div class="text-sm">
                Запрос: <b>сделать теплым</b>
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Примечание (почему меняем)</label>
                <textarea name="note" class="textarea" rows="4" placeholder="Коротко поясните причину"></textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary" type="submit">Отправить</button>
                <button class="btn btn-outline" type="button" data-close-leadstate>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if can_delete_company %}
      <div id="deleteCompanyModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-delcompany></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium" style="color:#b91c1c">Удалить компанию</div>
                <div class="text-xs muted-2 mt-1">
                  Удаление необратимо. Заметки будут удалены, задачи/контакты отвяжутся от компании.
                  Если у компании есть клиентские филиалы — они станут самостоятельными (головными).
                </div>
              </div>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-delcompany aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete/" class="mt-3 space-y-2" onsubmit="return confirm('Точно удалить компанию?');">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Комментарий (не обязательно)</label>
                <textarea name="reason" class="textarea" rows="3" placeholder="Причина удаления"></textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary" type="submit" style="background:#b91c1c">Удалить</button>
                <button class="btn btn-outline" type="button" data-close-delcompany>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if can_delete_company and delete_req %}
      <div id="cancelDeleteReqModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-cancelreq></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Отменить запрос на удаление</div>
                <div class="text-xs muted-2 mt-1">Менеджеру уйдёт уведомление с причиной.</div>
              </div>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-cancelreq aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete-request/{{ delete_req.id }}/cancel/" class="mt-3 space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Почему отменили?</label>
                <textarea name="decision_note" class="textarea" rows="4" placeholder="Причина отмены" required></textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-outline" type="submit">Отменить запрос</button>
                <button class="btn btn-outline" type="button" data-close-cancelreq>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if can_decide_lead_state and lead_state_req %}
      <div id="cancelLeadStateReqModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-cancelleadstate></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Отклонить запрос смены состояния</div>
                <div class="text-xs muted-2 mt-1">Менеджеру уйдёт уведомление с причиной.</div>
              </div>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-cancelleadstate aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/lead-state/request/{{ lead_state_req.id }}/cancel/" class="mt-3 space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Почему отклонили?</label>
                <textarea name="decision_note" class="textarea" rows="4" placeholder="Причина" required></textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-outline" type="submit">Отклонить</button>
                <button class="btn btn-outline" type="button" data-close-cancelleadstate>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if can_edit_company %}
      <div id="contractModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-contract></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Изменить договор</div>
                <div class="text-xs muted-2 mt-1">Меняем только вид договора и срок действия.</div>
              </div>
              <button type="button" class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" data-close-contract aria-label="Закрыть" title="Закрыть">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/contract/update/" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Вид</label>
                {{ contract_form.contract_type }}
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Действует до (не обязательно)</label>
                {{ contract_form.contract_until }}
              </div>
              <div class="md:col-span-2 flex gap-2">
                <button class="btn btn-primary" type="submit">Сохранить</button>
                <button class="btn btn-outline" type="button" data-close-contract>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    <script>
      (function(){
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }
        
        const contractModal = document.getElementById('contractModal');
        const openContract = document.getElementById('openContractModal');
        if (contractModal && openContract) {
          const closeBtns = contractModal.querySelectorAll('[data-close-contract]');
          function openM() { contractModal.classList.remove('hidden'); }
          function closeM() { contractModal.classList.add('hidden'); }
          openContract.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeM();
          });
        }

        const delReqModal = document.getElementById('deleteRequestModal');
        const openDelReq = document.getElementById('openDeleteRequestModal');
        if (delReqModal && openDelReq) {
          const closeBtns = delReqModal.querySelectorAll('[data-close-delreq]');
          function openM() { delReqModal.classList.remove('hidden'); }
          function closeM() { delReqModal.classList.add('hidden'); }
          openDelReq.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }

        const delCompanyModal = document.getElementById('deleteCompanyModal');
        const openDelCompany = document.getElementById('openDeleteCompanyModal');
        if (delCompanyModal && openDelCompany) {
          const closeBtns = delCompanyModal.querySelectorAll('[data-close-delcompany]');
          function openM() { delCompanyModal.classList.remove('hidden'); }
          function closeM() { delCompanyModal.classList.add('hidden'); }
          openDelCompany.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }

        const cancelReqModal = document.getElementById('cancelDeleteReqModal');
        const openCancelReq = document.getElementById('openCancelDeleteReqModal');
        if (cancelReqModal && openCancelReq) {
          const closeBtns = cancelReqModal.querySelectorAll('[data-close-cancelreq]');
          function openM() { cancelReqModal.classList.remove('hidden'); }
          function closeM() { cancelReqModal.classList.add('hidden'); }
          openCancelReq.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }

        const leadStateReqModal = document.getElementById('leadStateReqModal');
        const openLeadStateReq = document.getElementById('openLeadStateReqModal');
        if (leadStateReqModal && openLeadStateReq && !openLeadStateReq.disabled) {
          const closeBtns = leadStateReqModal.querySelectorAll('[data-close-leadstate]');
          function openM() { leadStateReqModal.classList.remove('hidden'); }
          function closeM() { leadStateReqModal.classList.add('hidden'); }
          openLeadStateReq.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }
        const openLeadStateReq2 = document.getElementById('openLeadStateReqModal2');
        if (leadStateReqModal && openLeadStateReq2 && !openLeadStateReq2.disabled) {
          function openM() { leadStateReqModal.classList.remove('hidden'); }
          openLeadStateReq2.addEventListener('click', openM);
        }
        const openLeadStateReqQuick = document.getElementById('openLeadStateReqModalQuick');
        if (leadStateReqModal && openLeadStateReqQuick && !openLeadStateReqQuick.disabled) {
          function openM() { leadStateReqModal.classList.remove('hidden'); }
          openLeadStateReqQuick.addEventListener('click', openM);
        }

        const cancelLeadStateReqModal = document.getElementById('cancelLeadStateReqModal');
        const openCancelLeadStateReq = document.getElementById('openCancelLeadStateReqModal');
        if (cancelLeadStateReqModal && openCancelLeadStateReq) {
          const closeBtns = cancelLeadStateReqModal.querySelectorAll('[data-close-cancelleadstate]');
          function openM() { cancelLeadStateReqModal.classList.remove('hidden'); }
          function closeM() { cancelLeadStateReqModal.classList.add('hidden'); }
          openCancelLeadStateReq.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }

        // Ждем, пока DOM готов и uiToast определена
        function initCallPhone() {
          const uiToast = window.uiToast || function(text, type) {
            try {
              console.log('[toast]', text, type);
              // Простой fallback: показываем alert, если uiToast не загружена
              if (type === 'error') {
                alert('Ошибка: ' + text);
              } else {
                alert(text);
              }
            } catch(_e) {}
          };
          const csrftoken = getCookie('csrftoken');
          
          // Подтверждение перед отметкой холодного звонка обрабатывается в base.html

          // Старая логика с data-disabled больше не используется - кнопка показывается только если is_cold_call = False

          document.querySelectorAll('.js-call-phone').forEach(btn => {
            btn.addEventListener('click', async () => {
              // Получаем номер из data-phone (в БД хранится в виде +7XXXXXXXXXX)
              let phone = btn.dataset.phone || '';
              // Убираем все нецифровые символы, кроме ведущего +
              phone = phone.replace(/[^\d+]/g, '');
              
              // Если номер уже в формате +7XXXXXXXXXX (12 символов), оставляем как есть
              if (phone.startsWith('+7') && phone.length === 12) {
                // Уже нормализован, ничего не делаем
              }
              // Если начинается с +7, но длина не 12 - возможно лишние символы
              else if (phone.startsWith('+7')) {
                // Оставляем только +7 и следующие 10 цифр
                const digits = phone.substring(2).replace(/\D/g, '');
                if (digits.length === 10) {
                  phone = '+7' + digits;
                }
              }
              // Если начинается с 8 и 11 цифр => +7XXXXXXXXXX
              else if (phone.startsWith('8') && phone.length === 11) {
                phone = '+7' + phone.substring(1);
              }
              // Если начинается с 7 и 11 цифр => +7XXXXXXXXXX
              else if (phone.startsWith('7') && phone.length === 11) {
                phone = '+7' + phone.substring(1);
              }
              // Если 10 цифр => +7XXXXXXXXXX
              else if (/^\d{10}$/.test(phone)) {
                phone = '+7' + phone;
              }
              // Если ничего не подошло, пытаемся извлечь 10 цифр из конца
              else {
                const digits = phone.replace(/\D/g, '');
                if (digits.length >= 10) {
                  const last10 = digits.slice(-10);
                  phone = '+7' + last10;
                }
              }
              const companyId = btn.dataset.company || '';
              const contactId = btn.dataset.contact || '';
              // Не делаем btn.disabled=true: на disabled в ряде браузеров пропадает подсказка (title).
              // Вместо этого ставим лок и защищаемся от повторных кликов.
              if (btn.dataset.busy === '1') return;
              btn.dataset.busy = '1';
              btn.classList.add('opacity-60');
              uiToast('Отправляю команду на телефон…', 'info');
              try {
                const body = new URLSearchParams({phone, company_id: companyId, contact_id: contactId});
                const res = await fetch('/phone/call/', {
                  method: 'POST',
                  headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
                  body: body.toString()
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.ok) throw new Error(data.detail || 'Ошибка');
                uiToast('Отправлено на телефон ✓', 'success');
                // Новая логика: кнопка "отметить холодный" больше не активируется автоматически
                // Пользователь может отметить холодный звонок в любое время через кнопку
                btn.dataset.busy = '0';
                btn.classList.remove('opacity-60');
              } catch (e) {
                btn.dataset.busy = '0';
                btn.classList.remove('opacity-60');
                uiToast('Не удалось отправить на телефон: ' + (e && e.message ? e.message : e), 'error');
              }
            });
          });
        }
        
        // Инициализируем после загрузки DOM и проверяем, что uiToast доступна
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCallPhone);
        } else {
          // Если DOM уже загружен, ждем немного, чтобы uiToast успела определиться
          setTimeout(initCallPhone, 100);
        }

        // Note edit modal
        const noteEditModal = document.getElementById('noteEditModal');
        const noteEditForm = document.getElementById('noteEditForm');
        const noteEditText = document.getElementById('noteEditText');
        const noteEditFile = document.getElementById('noteEditFile');
        const noteEditFileCurrent = document.getElementById('noteEditFileCurrent');
        const noteEditFileSelected = document.getElementById('noteEditFileSelected');
        const noteEditRemoveFile = document.getElementById('noteEditRemoveFile');
        const noteEditRemoveHidden = document.getElementById('noteEditRemoveHidden');
        if (noteEditModal && noteEditForm && noteEditText) {
          const closeBtns = noteEditModal.querySelectorAll('[data-close-noteedit]');
          function openNoteEdit(noteId, noteText, fileName) {
            noteEditForm.action = `/companies/{{ company.id }}/notes/${noteId}/edit/`;
            noteEditText.value = noteText || '';
            if (noteEditFile) noteEditFile.value = '';
            if (noteEditFileSelected) noteEditFileSelected.textContent = '';
            if (noteEditRemoveFile) noteEditRemoveFile.checked = false;
            if (noteEditRemoveHidden) noteEditRemoveHidden.value = '0';
            if (noteEditFileCurrent) noteEditFileCurrent.textContent = 'Текущий файл: ' + (fileName ? fileName : '—');
            noteEditModal.classList.remove('hidden');
            setTimeout(() => { try{ noteEditText.focus(); }catch(_e){} }, 0);
          }
          function closeNoteEdit() { noteEditModal.classList.add('hidden'); }
          document.querySelectorAll('[data-note-edit]').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.getAttribute('data-note-id');
              const txt = btn.getAttribute('data-note-text') || '';
              const fn = btn.getAttribute('data-note-file') || '';
              if (id) openNoteEdit(id, txt, fn);
            });
          });
          closeBtns.forEach(b => b.addEventListener('click', closeNoteEdit));
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeNoteEdit();
          });
          if (noteEditFile && noteEditFileSelected) {
            noteEditFile.addEventListener('change', () => {
              const f = noteEditFile.files && noteEditFile.files.length ? noteEditFile.files[0] : null;
              noteEditFileSelected.textContent = f ? ('Выбран: ' + f.name) : '';
              if (noteEditRemoveFile) noteEditRemoveFile.checked = false;
              if (noteEditRemoveHidden) noteEditRemoveHidden.value = '0';
            });
          }
          if (noteEditRemoveFile) {
            noteEditRemoveFile.addEventListener('change', () => {
              if (noteEditRemoveHidden) noteEditRemoveHidden.value = noteEditRemoveFile.checked ? '1' : '0';
              if (noteEditRemoveFile.checked && noteEditFile) {
                noteEditFile.value = '';
                if (noteEditFileSelected) noteEditFileSelected.textContent = '';
              }
            });
          }
        }
      })();
    </script>

    <script>
      (function(){
        const btn = document.getElementById('noteAttachBtn');
        const input = document.getElementById('noteFile');
        const name = document.getElementById('noteFileName');
        if (!btn || !input) return;
        btn.addEventListener('click', () => input.click());
        input.addEventListener('change', () => {
          const f = input.files && input.files.length ? input.files[0] : null;
          if (name) name.textContent = f ? f.name : '';
        });
      })();
    </script>

    {% if can_view_activity %}
      <details class="card card-pad">
        <summary class="cursor-pointer font-medium">История действий</summary>
        <div class="mt-3">
          {% if activity %}
            <div class="space-y-2">
              {% for ev in activity %}
                <div class="rounded-lg border p-3 text-sm">
                  <div class="text-xs text-brand-dark/70 mb-1">{{ ev.created_at }} · {{ ev.actor|default:"—" }}</div>
                  <div>{{ ev.message|default:ev.get_verb_display }}</div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-brand-dark/70">Пока пусто.</div>
          {% endif %}
        </div>
      </details>
    {% endif %}
  </div>

  <!-- Модальное окно для редактирования задач -->
  <div id="taskEditModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
      <div id="taskEditModalContent"></div>
    </div>
  </div>

  <script>
    (function() {
      const modal = document.getElementById('taskEditModal');
      const modalContent = document.getElementById('taskEditModalContent');
      if (!modal || !modalContent) return;

      // Закрытие модалки
      function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
      }
      // Делегирование для динамически добавленных кнопок закрытия
      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-close-task-modal]');
        if (closeBtn) {
          e.preventDefault();
          closeModal();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });

      // Редактирование задачи
      document.querySelectorAll('[data-edit-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const taskId = this.dataset.taskId;
          const url = `/tasks/${taskId}/edit/?modal=1`;
          
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Ошибка загрузки формы');
            const html = await res.text();
            modalContent.innerHTML = html;
            modal.classList.remove('hidden');
            
            // Обработка формы
            const form = modalContent.querySelector('[data-task-edit-form]');
            if (form) {
              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                try {
                  const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                  });
                  const data = await res.json();
                  if (data.ok) {
                    closeModal();
                    // Обновляем блок задачи в карточке компании без перезагрузки страницы
                    const taskItem = document.querySelector(`[data-task-id="${taskId}"]`)?.closest('.rounded-lg.border');
                    if (taskItem) {
                      // Обновляем бейдж статуса
                      const badgeDiv = taskItem.querySelector('[data-task-badge]');
                      if (badgeDiv && data.type_name) {
                        // Здесь можно обновить бейдж через AJAX или просто перезагрузить страницу
                        location.reload();
                      } else {
                        location.reload();
                      }
                    } else {
                      location.reload();
                    }
                  } else {
                    alert('Ошибка: ' + (data.error || 'Не удалось сохранить'));
                  }
                } catch (err) {
                  alert('Ошибка при сохранении: ' + err.message);
                }
              });
            }
          } catch (err) {
            alert('Ошибка загрузки формы: ' + err.message);
          }
        });
      });
    })();
  </script>
{% endblock %}


