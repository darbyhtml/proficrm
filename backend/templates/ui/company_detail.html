{% extends "ui/base.html" %}
{% load ui_extras %}
{% block title %}{{ company.name }} — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-6">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm text-brand-dark/70"><a class="underline" href="/companies/">Компании</a> /</div>
        <div class="flex items-start justify-between gap-3">
          {% if can_edit_company %}
            <div class="inline-field-wrapper" data-inline-field="name" data-company-id="{{ company.id }}">
              <h1 class="text-2xl font-semibold inline-field-display cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit>
                {{ company.name }}
              </h1>
              <div class="inline-field-edit hidden mt-2">
                <input class="input w-full" data-inline-input maxlength="255" value="{{ company.name|default:'' }}" />
                <div class="flex gap-1 mt-2">
                  <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                  <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                </div>
                <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
              </div>
            </div>
          {% else %}
            <h1 class="text-2xl font-semibold">
              {{ company.name }}
            </h1>
          {% endif %}
          <div class="flex items-center gap-2 shrink-0">
            {% if can_delete_company %}
              <button type="button" class="btn btn-outline btn-sm btn-danger" id="openDeleteCompanyModal">Удалить</button>
            {% elif can_request_delete %}
              <button type="button" class="btn btn-outline btn-sm btn-danger" id="openDeleteRequestModal">
                {% if delete_req %}Запрос отправлен{% else %}Запросить удаление{% endif %}
              </button>
            {% endif %}
          </div>
        </div>
        <div class="text-sm text-brand-dark/80">
          {% if can_edit_company %}
            <span>ИНН:</span>
            <span class="inline-field-wrapper" data-inline-field="inn" data-company-id="{{ company.id }}">
              <span class="font-mono inline-field-display cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit>
                {{ company.inn|default:"—" }}
              </span>
              <span class="inline-field-edit hidden ml-2 align-middle">
                <input class="input" data-inline-input maxlength="255" value="{{ company.inn|default:'' }}" style="width:320px" placeholder="Можно несколько: через /, запятую, пробел" />
                <button type="button" class="btn btn-primary btn-xs ml-1" data-inline-save>Сохранить</button>
                <button type="button" class="btn btn-outline btn-xs ml-1" data-inline-cancel>Отмена</button>
                <span class="text-xs text-red-600 ml-2 hidden" data-inline-error></span>
              </span>
            </span>

            <span class="mx-1">·</span>
            <span>КПП:</span>
            <span class="inline-field-wrapper" data-inline-field="kpp" data-company-id="{{ company.id }}">
              <span class="font-mono inline-field-display cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit>
                {{ company.kpp|default:"—" }}
              </span>
              <span class="inline-field-edit hidden ml-2 align-middle">
                <input class="input" data-inline-input maxlength="20" value="{{ company.kpp|default:'' }}" style="width:220px" />
                <button type="button" class="btn btn-primary btn-xs ml-1" data-inline-save>Сохранить</button>
                <button type="button" class="btn btn-outline btn-xs ml-1" data-inline-cancel>Отмена</button>
                <span class="text-xs text-red-600 ml-2 hidden" data-inline-error></span>
              </span>
            </span>
          {% else %}
            {% if company.inn %}ИНН: <span class="font-mono">{{ company.inn }}</span>{% endif %}
            {% if company.kpp %} · КПП: <span class="font-mono">{{ company.kpp }}</span>{% endif %}
          {% endif %}
        </div>

        {% if delete_req %}
          {% if can_delete_company or can_request_delete %}
          <div class="mt-3 rounded-xl border border-brand-orange/60 bg-brand-orange/15 px-4 py-3 text-sm text-brand-dark">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-medium">Запрос на удаление</div>
                <div class="text-xs muted-2 mt-1">
                  От: <b>{{ delete_req.requested_by|default:"—" }}</b> · {{ delete_req.created_at }}
                </div>
                {% if delete_req.note %}
                  <div class="mt-2 whitespace-pre-line">{{ delete_req.note }}</div>
                {% endif %}
              </div>
              {% if can_delete_company %}
                <div class="flex flex-col gap-2 shrink-0">
                  <button type="button" class="btn btn-outline btn-sm" id="openCancelDeleteReqModal">Отменить запрос</button>
                  <form method="post" action="/companies/{{ company.id }}/delete-request/{{ delete_req.id }}/approve/" onsubmit="return confirm('Подтвердить удаление компании?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-sm btn-danger">Подтвердить удаление</button>
                  </form>
                </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        {% endif %}
        {% if pinned_note %}
          <div class="mt-3 rounded-xl border border-brand-orange/35 bg-white px-3 py-2 shadow-sm" style="border-left-width:6px;">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <span class="badge badge-warn badge-sm">Закреплено</span>
                  <div class="text-xs muted-2 truncate">{{ pinned_note.author|default:"—" }} · {{ pinned_note.created_at }}</div>
                </div>
                {% if pinned_note.text %}
                  <div class="mt-1 text-sm whitespace-pre-line">{{ pinned_note.text|truncatechars:220 }}</div>
                {% endif %}
                {% if pinned_note.attachment %}
                  <div class="mt-2 flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        {% with ext=pinned_note.attachment_ext|upper %}
                          {% if ext == "PDF" %}
                            <span class="badge badge-warn">PDF</span>
                          {% elif ext == "DOC" or ext == "DOCX" %}
                            <span class="badge">DOC</span>
                          {% elif ext == "XLS" or ext == "XLSX" %}
                            <span class="badge">XLS</span>
                          {% elif ext == "PPT" or ext == "PPTX" %}
                            <span class="badge">PPT</span>
                          {% elif ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                            <span class="badge">IMG</span>
                          {% elif ext %}
                            <span class="badge">{{ ext }}</span>
                          {% else %}
                            <span class="badge">FILE</span>
                          {% endif %}
                        <div class="text-xs font-medium truncate">{{ pinned_note.attachment_name|default:"Файл" }}</div>
                        {% if pinned_note.attachment_size %}<div class="text-xs muted-2">{{ pinned_note.attachment_size|filesizeformat }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="flex gap-2 shrink-0">
                      {% if ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                        <button
                          type="button"
                          class="btn btn-outline btn-sm js-image-open"
                          data-img-url="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/file/open/"
                          data-img-download="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/file/download/"
                          data-img-title="{{ pinned_note.attachment_name|default:'Изображение' }}"
                        >Открыть</button>
                      {% else %}
                        <a class="btn btn-outline btn-sm" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/file/open/">Открыть</a>
                      {% endif %}
                      <a class="btn btn-outline btn-sm" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/file/download/">Скачать</a>
                    </div>
                    {% endwith %}
                  </div>
                {% endif %}
              </div>
              {% if can_edit_company %}
                <form method="post" action="/companies/{{ company.id }}/notes/{{ pinned_note.id }}/pin/">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline btn-sm" title="Открепить" aria-label="Открепить">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 17v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endif %}
        {% if can_edit_company %}
          <div class="mt-2">
            <a class="btn btn-outline" href="/companies/{{ company.id }}/edit/">Редактировать данные</a>
          </div>
        {% endif %}
      </div>
      <div class="text-sm text-brand-dark/80">
        <div><span class="text-brand-dark/50">Ответственный:</span> {{ company.responsible }}</div>
        <div><span class="text-brand-dark/50">Филиал:</span> {{ company.branch }}</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card card-pad lg:col-span-2">
        <div class="font-medium mb-3">Данные</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <div class="md:col-span-2">
            <div class="text-brand-dark/50">Организация</div>
            <div class="flex flex-wrap items-center gap-2">
              {% if org_head %}
                {% if org_head.id == company.id %}
                  <span class="badge">Головная</span>
                  <div class="font-medium">{{ org_head.name }}</div>
                {% else %}
                  <span class="badge">Филиал</span>
                  <a class="link font-medium" href="/companies/{{ org_head.id }}/">{{ org_head.name }}</a>
                {% endif %}
              {% else %}
                <span class="text-brand-dark/70">—</span>
              {% endif %}
              {% if org_branches %}
                <span class="muted-2 text-xs">· филиалов: {{ org_branches|length }}</span>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Юр. название</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="legal_name" data-company-id="{{ company.id }}">
                <div class="inline-field-display cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit>
                  {{ company.legal_name|default:"—" }}
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <input class="input w-full" data-inline-input maxlength="255" value="{{ company.legal_name|default:'' }}" />
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div>{{ company.legal_name|default:"—" }}</div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Сайт</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="website" data-company-id="{{ company.id }}" data-inline-display-kind="website">
                <div class="inline-field-display flex items-center gap-2" data-inline-display>
                  {% if company.website %}
                    {% if "://" in company.website %}
                      <a class="link break-all" data-inline-website-link href="{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                    {% elif company.website|slice:":2" == "//" %}
                      <a class="link break-all" data-inline-website-link href="https:{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                    {% else %}
                      <a class="link break-all" data-inline-website-link href="https://{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                    {% endif %}
                  {% else %}
                    <span class="text-brand-dark/70" data-inline-website-empty>—</span>
                  {% endif %}
                  <button type="button" class="btn btn-outline btn-xs" data-inline-edit title="Редактировать сайт">Изменить</button>
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <input class="input w-full" data-inline-input maxlength="255" value="{{ company.website|default:'' }}" placeholder="https://example.com" />
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div class="max-w-full">
                {% if company.website %}
                  {% if "://" in company.website %}
                    <a class="link break-all" href="{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                  {% elif company.website|slice:":2" == "//" %}
                    <a class="link break-all" href="https:{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                  {% else %}
                    <a class="link break-all" href="https://{{ company.website }}" target="_blank" rel="noopener">{{ company.website }}</a>
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Вид деятельности</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="activity_kind" data-company-id="{{ company.id }}" data-inline-display-kind="multiline">
                <div class="inline-field-display whitespace-pre-line cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit>
                  {{ company.activity_kind|default:"—" }}
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <textarea class="input w-full" data-inline-input rows="3" maxlength="255" style="min-height:88px;resize:vertical">{{ company.activity_kind|default:'' }}</textarea>
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div class="whitespace-pre-line">{{ company.activity_kind|default:"—" }}</div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Численность сотрудников</div>
            <div>{{ company.employees_count|default:"—" }}</div>
          </div>
          {# "Рабочее время" убрано: дублировало "Режим работы" #}
          <div>
            <div class="text-brand-dark/50">Часовой пояс</div>
            {# приоритет: сохранённый вручную, затем авто по адресу #}
            {% with guessed=company.address|guess_ru_tz %}
            {% with tz=company.work_timezone|default:guessed %}
              {% if can_edit_company %}
                <div class="inline-field-wrapper" data-inline-field="work_timezone" data-company-id="{{ company.id }}" data-inline-display-kind="timezone">
                  <div class="inline-field-display cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit>
                    {% if tz %}
                      <span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1">
                        <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                        · {{ tz|tz_label }}
                      </span>
                    {% else %}
                      —
                    {% endif %}
                  </div>
                  <div class="inline-field-edit hidden mt-1">
                    <select class="select w-full" data-inline-input>
                      <option value="" {% if not company.work_timezone %}selected{% endif %}>Авто (по адресу)</option>
                      <option value="Europe/Kaliningrad" {% if company.work_timezone == "Europe/Kaliningrad" %}selected{% endif %}>Калининград (UTC+02)</option>
                      <option value="Europe/Moscow" {% if company.work_timezone == "Europe/Moscow" %}selected{% endif %}>Москва / СПБ (UTC+03)</option>
                      <option value="Europe/Samara" {% if company.work_timezone == "Europe/Samara" %}selected{% endif %}>Самара (UTC+04)</option>
                      <option value="Asia/Yekaterinburg" {% if company.work_timezone == "Asia/Yekaterinburg" %}selected{% endif %}>Екатеринбург / Тюмень (UTC+05)</option>
                      <option value="Asia/Omsk" {% if company.work_timezone == "Asia/Omsk" %}selected{% endif %}>Омск (UTC+06)</option>
                      <option value="Asia/Novosibirsk" {% if company.work_timezone == "Asia/Novosibirsk" %}selected{% endif %}>Новосибирск (UTC+07)</option>
                      <option value="Asia/Krasnoyarsk" {% if company.work_timezone == "Asia/Krasnoyarsk" %}selected{% endif %}>Красноярск (UTC+07)</option>
                      <option value="Asia/Irkutsk" {% if company.work_timezone == "Asia/Irkutsk" %}selected{% endif %}>Иркутск (UTC+08)</option>
                      <option value="Asia/Yakutsk" {% if company.work_timezone == "Asia/Yakutsk" %}selected{% endif %}>Якутск (UTC+09)</option>
                      <option value="Asia/Vladivostok" {% if company.work_timezone == "Asia/Vladivostok" %}selected{% endif %}>Владивосток (UTC+10)</option>
                      <option value="Asia/Sakhalin" {% if company.work_timezone == "Asia/Sakhalin" %}selected{% endif %}>Сахалин (UTC+11)</option>
                      <option value="Asia/Magadan" {% if company.work_timezone == "Asia/Magadan" %}selected{% endif %}>Магадан (UTC+11)</option>
                      <option value="Asia/Kamchatka" {% if company.work_timezone == "Asia/Kamchatka" %}selected{% endif %}>Камчатка (UTC+12)</option>
                    </select>
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                  </div>
                </div>
              {% else %}
                {% if tz %}
                  <div>
                    <span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1">
                      <span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span>
                      · {{ tz|tz_label }}
                    </span>
                  </div>
                {% else %}
                  —
                {% endif %}
              {% endif %}
            {% endwith %}
            {% endwith %}
          </div>
          <div>
            <div class="text-brand-dark/50">Режим работы</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="work_schedule" data-company-id="{{ company.id }}" data-inline-display-kind="multiline">
                <div class="inline-field-display whitespace-pre-line font-mono text-xs cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit data-work-schedule-display="1" data-company-id="{{ company.id }}">
                  {{ company.work_schedule|default:"—" }}
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <textarea class="input w-full font-mono text-xs" data-inline-input rows="5" style="min-height:96px;resize:vertical">{{ company.work_schedule|default:'' }}</textarea>
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="muted-2 mt-1" style="font-size:0.6875rem;">Можно вставить как с сайта (любой формат) — при сохранении приведётся к виду «Пн–Пт: 09:00–18:00».</div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div class="whitespace-pre-line font-mono text-xs" data-work-schedule-display="1" data-company-id="{{ company.id }}">{{ company.work_schedule|default:"—" }}</div>
            {% endif %}
          </div>
          <div>
            <div class="text-brand-dark/50">Руководитель</div>
            <div>{{ company.contact_name|default:"—" }}</div>
          </div>
          <div class="{% if contract_alert == 'danger' %}rounded-xl border border-red-400/40 bg-red-500/5 p-2 -m-2{% elif contract_alert == 'warn' %}rounded-xl border border-brand-orange/50 bg-brand-orange/10 p-2 -m-2{% endif %}">
            <div class="text-brand-dark/50 flex items-center gap-2">
              <span>Договор</span>
              {% if contract_alert == 'danger' %}
                <span class="badge badge-danger badge-sm">Срочно</span>
              {% elif contract_alert == 'warn' %}
                <span class="badge badge-warn badge-sm">Остался месяц</span>
              {% endif %}
            </div>
            <div class="flex items-start justify-between gap-2">
              <div class="text-sm">
                {% if company.contract_type %}{{ company.get_contract_type_display }}{% else %}—{% endif %}
                {% if company.contract_until %}
                  <span class="muted-2">· до {{ company.contract_until|date:"d.m.Y" }}</span>
                  {% if contract_days_left is not None %}
                    <span class="muted-2">· осталось {{ contract_days_left }} дн.</span>
                  {% endif %}
                {% endif %}
              </div>
              {% if can_edit_company %}
                <button type="button" class="btn btn-outline btn-sm" id="openContractModal">Изменить</button>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Телефон (основной)</div>
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="font-mono text-xs" data-company-main-phone-display>{{ company.phone|format_phone|default:"—" }}</div>
                {% with info=company.phone|phone_local_info %}
                  {% if info %}<div class="mt-1" data-company-main-phone-local><span class="badge badge-warn badge-xxxs">{{ info }}</span></div>{% endif %}
                {% endwith %}
                {% if not company.phone|phone_local_info %}
                  {% with guessed=company.address|guess_ru_tz %}
                  {% with tz=company.work_timezone|default:guessed %}
                    {% if tz %}<div class="mt-1"><span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1"><span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span> · {{ tz|tz_label }}</span></div>{% endif %}
                  {% endwith %}
                  {% endwith %}
                {% endif %}
                {% if can_edit_company %}
                  <div class="hidden mt-1" data-company-main-phone-edit>
                    <input class="input text-xs" data-company-main-phone-input value="{{ company.phone|default:'' }}" placeholder="+7..." style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:240px" />
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-company-main-phone-save>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-company-main-phone-cancel>Отмена</button>
                    </div>
                    <div class="text-xs text-red-600 mt-1 hidden" data-company-main-phone-error></div>
                  </div>
                {% endif %}
              </div>

              {% if company.phone %}
                <div class="relative shrink-0" data-dd-root>
                  <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                  <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-call-phone" data-phone="{{ company.phone }}" data-company="{{ company.id }}" data-contact="">Позвонить</button>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-copy-phone="{{ company.phone }}">Скопировать</button>

                    {% if can_edit_company %}
                      {# Важно: для AJAX-режима обе формы должны быть в DOM, иначе после отметки нечего показывать. #}
                      <form
                        method="post"
                        action="/companies/{{ company.id }}/cold-call/toggle/"
                        class="js-cold-call-form"
                        data-confirm="Вы действительно хотите отметить звонок как холодный?"
                        data-cold-entity="company"
                        data-cold-id="{{ company.id }}"
                        data-cold-kind="toggle"
                        style="{% if company.primary_contact_is_cold_call or company.primary_cold_marked_at %}display:none{% endif %}"
                      >
                        {% csrf_token %}
                        <input type="hidden" name="confirmed" value="1">
                        <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Отметить холодным</button>
                      </form>
                      {% if is_admin %}
                        <form
                          method="post"
                          action="/companies/{{ company.id }}/cold-call/reset/"
                          class="js-cold-call-form"
                          data-confirm="Откатить отметку холодного звонка?"
                          data-cold-entity="company"
                          data-cold-id="{{ company.id }}"
                          data-cold-kind="reset"
                          style="{% if not company.primary_contact_is_cold_call %}display:none{% endif %}"
                        >
                          {% csrf_token %}
                          <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Снять отметку</button>
                        </form>
                      {% endif %}

                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-main-phone>Изменить</button>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="mt-1 text-xs text-brand-dark/70 {% if not company.primary_contact_is_cold_call and not company.primary_cold_marked_at %}hidden{% endif %}" data-cold-info="company:{{ company.id }}">
              <span class="font-medium">Холодный звонок:</span>
              {% if company.primary_cold_marked_at %}
                <span>{{ company.primary_cold_marked_at|date:"d.m.Y H:i" }}</span>
              {% endif %}
              {% if company.primary_cold_marked_by %}
                <span>({{ company.primary_cold_marked_by }})</span>
              {% endif %}
              {% if not company.primary_contact_is_cold_call and company.primary_cold_marked_at %}
                <span class="opacity-80">(откат)</span>
              {% endif %}
            </div>
            <div class="mt-1">
              {% if can_edit_company %}
                <div class="phone-comment-wrapper" data-phone-type="main" data-company-id="{{ company.id }}">
                  <div class="phone-comment-display text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70 transition-colors" data-edit-comment style="white-space: pre-wrap;">{% if company.phone_comment %}{{ company.phone_comment }}{% else %}Комментарий{% endif %}</div>
                  <div class="phone-comment-edit hidden mt-1">
                    <textarea class="input text-xs" placeholder="Комментарий к номеру" maxlength="255" data-comment-input rows="2" style="padding:.35rem .5rem;font-size:.75rem;min-height:3.25rem;resize:vertical">{{ company.phone_comment|default:'' }}</textarea>
                    <div class="flex gap-1 mt-1">
                      <button type="button" class="btn btn-primary btn-sm" data-save-comment>Сохранить</button>
                      <button type="button" class="btn btn-outline btn-sm" data-cancel-comment>Отмена</button>
                    </div>
                  </div>
                </div>
              {% elif company.phone_comment %}
                <div class="text-xs text-brand-dark/50 mt-1" style="white-space: pre-wrap;">{{ company.phone_comment }}</div>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between gap-2">
              <div class="text-brand-dark/50">Дополнительные телефоны</div>
              {% if can_edit_company %}
                <div class="relative shrink-0" data-dd-root>
                  <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                  <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                    <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-add-company-phone>Добавить телефон</button>
                    <a class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" href="/companies/{{ company.id }}/edit/">Открыть редактирование</a>
                  </div>
                </div>
              {% endif %}
            </div>

            {% if can_edit_company %}
              <div class="hidden mt-2" data-company-phone-add>
                <div class="flex items-start gap-2 flex-wrap">
                  <input class="input text-xs" data-company-phone-add-input placeholder="+7..." style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:240px" />
                  <button type="button" class="btn btn-primary btn-sm" data-company-phone-add-save>Сохранить</button>
                  <button type="button" class="btn btn-outline btn-sm" data-company-phone-add-cancel>Отмена</button>
                </div>
                <div class="text-xs text-red-600 mt-1 hidden" data-company-phone-add-error></div>
                <div class="muted-2 mt-1" style="font-size:0.6875rem;">Можно вставить несколько (Enter/запятая/точка с запятой) — добавится несколько номеров.</div>
              </div>
            {% endif %}

            <div class="space-y-2 mt-2" data-company-phones-list>
              {% for phone in company.phones.all %}
                <div>
                  <div class="flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="font-mono text-xs" data-company-phone-display="{{ phone.id }}">{{ phone.value|format_phone }}</div>
                      {% with info=phone.value|phone_local_info %}
                        {% if info %}<div class="mt-1" data-company-phone-local="{{ phone.id }}"><span class="badge badge-warn badge-xxxs">{{ info }}</span></div>{% endif %}
                      {% endwith %}
                      {% if not phone.value|phone_local_info %}
                        {% with guessed=company.address|guess_ru_tz %}
                        {% with tz=company.work_timezone|default:guessed %}
                          {% if tz %}<div class="mt-1"><span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1"><span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span> · {{ tz|tz_label }}</span></div>{% endif %}
                        {% endwith %}
                        {% endwith %}
                      {% endif %}
                      {% if can_edit_company %}
                        <div class="hidden mt-1" data-company-phone-edit="{{ phone.id }}">
                          <input class="input text-xs" data-company-phone-input value="{{ phone.value|default:'' }}" placeholder="+7..." style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:240px" />
                          <div class="flex gap-1 mt-1">
                            <button type="button" class="btn btn-primary btn-sm" data-company-phone-save="{{ phone.id }}">Сохранить</button>
                            <button type="button" class="btn btn-outline btn-sm" data-company-phone-cancel="{{ phone.id }}">Отмена</button>
                          </div>
                          <div class="text-xs text-red-600 mt-1 hidden" data-company-phone-error="{{ phone.id }}"></div>
                        </div>
                      {% endif %}
                    </div>
                    {% if phone.value %}
                      <div class="relative shrink-0" data-dd-root>
                        <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                        <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                          <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-call-phone" data-phone="{{ phone.value }}" data-company="{{ company.id }}" data-contact="">Позвонить</button>
                          <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-copy-phone="{{ phone.value }}">Скопировать</button>

                          {% if can_edit_company %}
                            <form
                              method="post"
                              action="/company-phones/{{ phone.id }}/cold-call/toggle/"
                              class="js-cold-call-form"
                              data-confirm="Вы действительно хотите отметить звонок как холодный?"
                              data-cold-entity="company_phone"
                              data-cold-id="{{ phone.id }}"
                              data-cold-kind="toggle"
                              style="{% if phone.is_cold_call or phone.cold_marked_at %}display:none{% endif %}"
                            >
                              {% csrf_token %}
                              <input type="hidden" name="confirmed" value="1">
                              <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Отметить холодным</button>
                            </form>
                            {% if is_admin %}
                              <form
                                method="post"
                                action="/company-phones/{{ phone.id }}/cold-call/reset/"
                                class="js-cold-call-form"
                                data-confirm="Откатить отметку холодного звонка?"
                                data-cold-entity="company_phone"
                                data-cold-id="{{ phone.id }}"
                                data-cold-kind="reset"
                                style="{% if not phone.is_cold_call %}display:none{% endif %}"
                              >
                                {% csrf_token %}
                                <button type="submit" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25">Снять отметку</button>
                              </form>
                            {% endif %}

                            <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-company-phone="{{ phone.id }}">Изменить</button>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}
                  </div>
                  <div class="mt-1 text-xs text-brand-dark/70 {% if not phone.is_cold_call and not phone.cold_marked_at %}hidden{% endif %}" data-cold-info="company_phone:{{ phone.id }}">
                    <span class="font-medium">Холодный звонок:</span>
                    {% if phone.cold_marked_at %}
                      <span>{{ phone.cold_marked_at|date:"d.m.Y H:i" }}</span>
                    {% endif %}
                    {% if phone.cold_marked_by %}
                      <span>({{ phone.cold_marked_by.first_name }} {{ phone.cold_marked_by.last_name|default:"" }})</span>
                    {% endif %}
                    {% if not phone.is_cold_call and phone.cold_marked_at %}
                      <span class="opacity-80">(откат)</span>
                    {% endif %}
                  </div>
                  <div class="mt-1">
                    {% if can_edit_company %}
                      <div class="phone-comment-wrapper" data-phone-type="company" data-phone-id="{{ phone.id }}">
                        <div class="phone-comment-display text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70 transition-colors" data-edit-comment style="white-space: pre-wrap;">{% if phone.comment %}{{ phone.comment }}{% else %}Комментарий{% endif %}</div>
                        <div class="phone-comment-edit hidden mt-1">
                          <textarea class="input text-xs" placeholder="Комментарий к номеру" maxlength="255" data-comment-input rows="2" style="padding:.35rem .5rem;font-size:.75rem;min-height:3.25rem;resize:vertical">{{ phone.comment|default:'' }}</textarea>
                          <div class="flex gap-1 mt-1">
                            <button type="button" class="btn btn-primary btn-sm" data-save-comment>Сохранить</button>
                            <button type="button" class="btn btn-outline btn-sm" data-cancel-comment>Отмена</button>
                          </div>
                        </div>
                      </div>
                    {% elif phone.comment %}
                      <div class="text-xs text-brand-dark/50 mt-1" style="white-space: pre-wrap;">{{ phone.comment }}</div>
                    {% endif %}
                  </div>
                </div>
              {% empty %}
                <div class="text-xs muted-2">—</div>
              {% endfor %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Email адреса</div>
            <div class="space-y-1">
              {% if company.email %}
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <div class="font-mono text-xs" data-company-main-email-display>{{ company.email }}</div>
                    <div class="text-xs text-brand-dark/50">(основной)</div>
                    {% if can_edit_company %}
                      <div class="hidden mt-1" data-company-main-email-edit>
                        <input class="input text-xs" data-company-main-email-input value="{{ company.email|default:'' }}" placeholder="email@example.com" style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:280px" />
                        <div class="flex gap-1 mt-1">
                          <button type="button" class="btn btn-primary btn-sm" data-company-main-email-save>Сохранить</button>
                          <button type="button" class="btn btn-outline btn-sm" data-company-main-email-cancel>Отмена</button>
                        </div>
                        <div class="text-xs text-red-600 mt-1 hidden" data-company-main-email-error></div>
                      </div>
                    {% endif %}
                  </div>
                  <div class="relative shrink-0" data-dd-root>
                    <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                    <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-copy-email" data-email="{{ company.email }}">Скопировать</button>
                      {% if can_edit_company %}
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-main-email>Изменить</button>
                      {% endif %}
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-add-email-to-campaign" data-email="{{ company.email }}" data-company-id="{{ company.id }}">Добавить в рассылку</button>
                    </div>
                  </div>
                </div>
              {% endif %}
              {% for email in company.emails.all %}
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <div class="font-mono text-xs" data-company-email-display="{{ email.id }}">{{ email.value }}</div>
                    {% if can_edit_company %}
                      <div class="hidden mt-1" data-company-email-edit="{{ email.id }}">
                        <input class="input text-xs" data-company-email-input value="{{ email.value|default:'' }}" placeholder="email@example.com" style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:280px" />
                        <div class="flex gap-1 mt-1">
                          <button type="button" class="btn btn-primary btn-sm" data-company-email-save="{{ email.id }}">Сохранить</button>
                          <button type="button" class="btn btn-outline btn-sm" data-company-email-cancel="{{ email.id }}">Отмена</button>
                        </div>
                        <div class="text-xs text-red-600 mt-1 hidden" data-company-email-error="{{ email.id }}"></div>
                      </div>
                    {% endif %}
                  </div>
                  <div class="relative shrink-0" data-dd-root>
                    <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                    <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-copy-email" data-email="{{ email.value }}">Скопировать</button>
                      {% if can_edit_company %}
                        <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-company-email="{{ email.id }}">Изменить</button>
                      {% endif %}
                      <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-add-email-to-campaign" data-email="{{ email.value }}" data-company-id="{{ company.id }}">Добавить в рассылку</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
              {% if not company.email and not company.emails.all %}
                —
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-brand-dark/50">Контакт (ФИО)</div>
            <div>{{ company.contact_name|default:"—" }}</div>
          </div>
          <div>
            <div class="text-brand-dark/50">Контакт (должность)</div>
            <div>{{ company.contact_position|default:"—" }}</div>
          </div>
          <div class="md:col-span-2">
            <div class="text-brand-dark/50">Адрес</div>
            {% if can_edit_company %}
              <div class="inline-field-wrapper" data-inline-field="address" data-company-id="{{ company.id }}" data-inline-display-kind="multiline">
                <div class="inline-field-display whitespace-pre-line cursor-pointer hover:text-brand-dark/80 transition-colors" data-inline-edit>
                  {{ company.address|default:"—" }}
                </div>
                <div class="inline-field-edit hidden mt-1">
                  <textarea class="input w-full" data-inline-input rows="3" maxlength="500" style="min-height:88px;resize:vertical">{{ company.address|default:'' }}</textarea>
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-inline-save>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-inline-cancel>Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-inline-error></div>
                </div>
              </div>
            {% else %}
              <div class="whitespace-pre-line">{{ company.address|default:"—" }}</div>
            {% endif %}
          </div>
        </div>

      </section>

      {# Модалка: добавить email в кампанию #}
      <div id="addEmailToCampaignModal" class="fixed inset-0 bg-black/35 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-5 w-full max-w-md space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Добавить email в кампанию</div>
            <button type="button" class="text-brand-dark/60 hover:text-red-600 transition-colors js-close-add-email-modal" title="Закрыть">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="text-xs muted-2">Email: <span id="addEmailValue" class="font-mono"></span></div>
          <div>
            <label class="block text-xs muted mb-1">Кампания</label>
            <select id="addEmailCampaignSelect" class="select"></select>
          </div>
          <div class="flex gap-2 justify-end pt-1">
            <button type="button" class="btn btn-outline js-close-add-email-modal">Отмена</button>
            <button type="button" class="btn btn-primary" id="addEmailConfirmBtn">Добавить</button>
          </div>
        </div>
      </div>

      {# Немодальная панель: создать/редактировать контакт (фон НЕ блокируем, чтобы можно было копировать) #}
      <div id="contactPanel" class="fixed right-4 bottom-4 z-[120] hidden" style="width: min(720px, calc(100vw - 2rem));">
        <div class="bg-white border border-brand-soft rounded-2xl shadow-2xl p-5 max-h-[85vh] overflow-auto">
          <div id="contactPanelBody"></div>
        </div>
      </div>

      <section class="card card-pad">
        <div class="font-medium mb-3">Быстро</div>
        {% if can_edit_company %}
          <button type="button" class="btn btn-primary w-full" data-create-task data-company-id="{{ company.id }}">+ Поставить задачу</button>
          <div class="mt-3">
            <div class="text-xs text-brand-dark/70 mb-1">Передать другому менеджеру</div>
            <form method="post" action="/companies/{{ company.id }}/transfer/" class="flex gap-2">
              {% csrf_token %}
              <select name="responsible_id" class="select">
                <option value="">Выберите ответственного…</option>
                {% regroup transfer_targets by branch as branches_list %}
                {% for branch_group in branches_list %}
                  <optgroup label="Филиал: {{ branch_group.grouper.name|default:"Без филиала" }}">
                    {% for u in branch_group.list %}
                      <option value="{{ u.id }}">{{ u }} ({{ u.get_role_display }})</option>
                    {% endfor %}
                  </optgroup>
                {% endfor %}
              </select>
              <button class="btn btn-outline" type="submit">Передать</button>
            </form>
            <div class="text-xs muted-2 mt-1">При передаче филиал компании обновится под филиал нового ответственного.</div>
          </div>
        {% else %}
          <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
            У вас доступ <b>только на просмотр</b>. Редактировать может ответственный / руководитель филиала / управляющий / администратор.
          </div>
        {% endif %}
        <div class="mt-4 border-t pt-4">
          <div class="font-medium mb-2">Статус и сферы</div>
          {% if can_edit_company %}
            <form method="post" action="/companies/{{ company.id }}/update/" class="space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Статус</label>
                {{ quick_form.status|safe }}
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Сферы</label>
                <div class="ms" data-ms="1" data-placeholder="Выберите сферы">
                  <button type="button" class="ms-btn">
                    <span class="ms-value"></span>
                    <span class="ms-muted">▼</span>
                  </button>
                  <div class="ms-panel hidden">
                    <div class="ms-top">
                      <input class="input ms-search" placeholder="Поиск" />
                      <a href="#" class="btn btn-outline btn-sm" data-ms-clear>Снять</a>
                    </div>
                    <div class="ms-list"></div>
                  </div>
                  <div class="hidden">
                    {{ quick_form.spheres }}
                  </div>
                </div>
              </div>
              <button class="btn btn-outline w-full" type="submit">Сохранить</button>
            </form>
          {% else %}
            <div class="text-sm text-brand-dark/70 space-y-2">
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">Статус</div>
                <div>{{ company.status|default:"—" }}</div>
              </div>
              <div>
                <div class="text-xs text-brand-dark/50 mb-1">Сферы</div>
                <div class="flex flex-wrap gap-1">
                  {% for s in company.spheres.all %}
                    <span class="badge">{{ s.name }}</span>
                  {% empty %}
                    <span class="text-brand-dark/70">—</span>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {% if org_head and org_head.id == company.id %}
        {% if org_branches %}
          <section class="card card-pad">
            <div class="font-medium mb-3">Филиалы организации</div>
            <div class="space-y-2">
              {% for b in org_branches %}
                <a class="block rounded-lg border p-3 hover:bg-brand-soft/20" href="/companies/{{ b.id }}/">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="text-sm font-medium">{{ b.name }}</div>
                      <div class="text-xs muted-2">ИНН: {{ b.inn|default:"—" }} · Ответственный: {{ b.responsible|default:"—" }} · Филиал: {{ b.branch|default:"—" }}</div>
                    </div>
                  </div>
                </a>
              {% endfor %}
            </div>
          </section>
        {% endif %}
      {% endif %}

      <section class="card card-pad">
        <div class="flex items-end justify-between gap-3 mb-3">
          <div class="font-medium">Контакты</div>
          {% if can_edit_company %}
            <a class="btn btn-outline" href="/companies/{{ company.id }}/contacts/new/?modal=1" data-contact-panel-open>+ Добавить контакт</a>
          {% endif %}
        </div>
        {% if contacts %}
          <div class="space-y-3">
            {% for c in contacts %}
              <div class="rounded-lg border p-3">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <div class="text-sm font-medium">{{ c.last_name }} {{ c.first_name }}</div>
                    <div class="text-xs text-brand-dark/70">
                      {{ c.position }}
                    </div>
                    {% if c.is_cold_call or c.cold_marked_at %}
                      <div class="mt-1 text-xs text-brand-dark/70">
                        <span class="font-medium">Холодный звонок:</span>
                        {% if c.cold_marked_at %}
                          <span>{{ c.cold_marked_at|date:"d.m.Y H:i" }}</span>
                        {% endif %}
                        {% if c.cold_marked_by %}
                          <span>({{ c.cold_marked_by.first_name }} {{ c.cold_marked_by.last_name|default:"" }})</span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                  {% if can_edit_company %}
                    <div class="flex items-center gap-2">
                      <a class="btn btn-outline btn-sm" href="/contacts/{{ c.id }}/edit/" title="Редактировать" aria-label="Редактировать">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </a>
                      <form method="post" action="/contacts/{{ c.id }}/delete/" onsubmit="return confirm('Удалить контакт?');" style="display:inline">
                        {% csrf_token %}
                        <button class="btn btn-outline btn-sm btn-danger" title="Удалить контакт" aria-label="Удалить контакт">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  {% endif %}
                </div>
                <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                  <div>
                    <div class="text-brand-dark/50 text-xs">Email</div>
                    {% for e in c.emails.all %}
                      <div class="flex items-center gap-2">
                        <a class="link font-mono text-xs js-copy-email" href="#" data-email="{{ e.value }}" onclick="event.preventDefault(); return false;">{{ e.value }}</a>
                        <button type="button" class="btn btn-outline btn-xs js-add-email-to-campaign" data-email="{{ e.value }}" data-company-id="{{ company.id }}" title="Добавить в рассылочную кампанию">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                          </svg>
                        </button>
                      </div>
                    {% empty %}
                      <div class="text-brand-dark/70">—</div>
                    {% endfor %}
                  </div>
                  <div>
                    <div class="text-brand-dark/50 text-xs">Телефон</div>
                    {% for p in c.phones.all %}
                      <div class="mb-2">
                        <div class="flex items-center justify-between gap-2">
                          <div class="flex-1">
                            <div class="font-mono text-xs">{{ p.value|format_phone }}</div>
                            {% with info=p.value|phone_local_info %}
                              {% if info %}<div class="mt-1"><span class="badge badge-warn badge-xxxs">{{ info }}</span></div>{% endif %}
                            {% endwith %}
                            {% if not p.value|phone_local_info %}
                              {% with guessed=company.address|guess_ru_tz %}
                              {% with tz=company.work_timezone|default:guessed %}
                                {% if tz %}<div class="mt-1"><span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="{{ company.id }}" data-live-worktime="1"><span data-live-time data-live-tz="{{ tz }}">{{ tz|tz_now_hhmm }}</span> · {{ tz|tz_label }}</span></div>{% endif %}
                              {% endwith %}
                              {% endwith %}
                            {% endif %}
                            <div class="mt-0.5 text-xs text-brand-dark/70 {% if not p.is_cold_call and not p.cold_marked_at %}hidden{% endif %}" data-cold-info="contact_phone:{{ p.id }}">
                              <span class="font-medium">Холодный звонок:</span>
                              {% if p.cold_marked_at %}
                                {{ p.cold_marked_at|date:"d.m.Y H:i" }}
                              {% endif %}
                              {% if p.cold_marked_by %}
                                ({{ p.cold_marked_by.first_name }} {{ p.cold_marked_by.last_name|default:"" }})
                              {% endif %}
                              {% if not p.is_cold_call and p.cold_marked_at %}
                                <span class="opacity-80">(откат)</span>
                              {% endif %}
                            </div>
                            <div class="mt-1">
                              {% if can_edit_company %}
                                <div class="phone-comment-wrapper" data-phone-type="contact" data-phone-id="{{ p.id }}">
                                  <div class="phone-comment-display text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70 transition-colors" data-edit-comment style="white-space: pre-wrap;">{% if p.comment %}{{ p.comment }}{% else %}Комментарий{% endif %}</div>
                                  <div class="phone-comment-edit hidden mt-1">
                                    <textarea class="input text-xs" placeholder="Комментарий к номеру" maxlength="255" data-comment-input rows="2" style="padding:.35rem .5rem;font-size:.75rem;min-height:3.25rem;resize:vertical">{{ p.comment|default:'' }}</textarea>
                                    <div class="flex gap-1 mt-1">
                                      <button type="button" class="btn btn-primary btn-sm" data-save-comment>Сохранить</button>
                                      <button type="button" class="btn btn-outline btn-sm" data-cancel-comment>Отмена</button>
                                    </div>
                                  </div>
                                </div>
                              {% elif p.comment %}
                                <div class="text-xs text-brand-dark/50 mt-1" style="white-space: pre-wrap;">{{ p.comment }}</div>
                              {% endif %}
                            </div>
                          </div>
                          <div class="flex items-center gap-1 shrink-0">
                            {% if can_edit_company %}
                              <form
                                method="post"
                                action="/contact-phones/{{ p.id }}/cold-call/toggle/"
                                class="js-cold-call-form"
                                data-confirm="Вы действительно хотите отметить звонок как холодный?"
                                data-cold-entity="contact_phone"
                                data-cold-id="{{ p.id }}"
                                data-cold-kind="toggle"
                                style="{% if p.is_cold_call or p.cold_marked_at %}display:none{% endif %}"
                              >
                                {% csrf_token %}
                                <input type="hidden" name="confirmed" value="1">
                                <button
                                  type="submit"
                                  class="btn btn-outline btn-xs js-cold-mark"
                                  style="padding:4px 8px;"
                                  data-cold-btn="phone-{{ p.id }}"
                                  title="Отметить холодный звонок"
                                  aria-label="Отметить холодный звонок"
                                >
                                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                    <path d="M12 2v20M4 6l16 12M20 6 4 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 4l12 16M18 4 6 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity=".35"/>
                                  </svg>
                                </button>
                              </form>
                              {% if is_admin %}
                                <form
                                  method="post"
                                  action="/contact-phones/{{ p.id }}/cold-call/reset/"
                                  class="js-cold-call-form"
                                  data-confirm="Откатить отметку холодного звонка?"
                                  data-cold-entity="contact_phone"
                                  data-cold-id="{{ p.id }}"
                                  data-cold-kind="reset"
                                  style="display:inline;{% if not p.is_cold_call %}display:none{% endif %}"
                                >
                                  {% csrf_token %}
                                  <button
                                    type="submit"
                                    class="btn btn-outline btn-xs"
                                    style="padding:4px 8px;"
                                    title="Откатить отметку холодного звонка (только для администраторов)"
                                    aria-label="Откатить отметку холодного звонка"
                                  >
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                      <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                  </button>
                                </form>
                              {% endif %}
                            {% endif %}
                            {# Убрали отдельный квадрат-статус (дублировал смысл). #}
                            <button
                              type="button"
                              class="btn btn-outline btn-xs js-call-phone"
                              style="padding:4px 8px;"
                              data-phone="{{ p.value }}"
                              data-company="{{ company.id }}"
                              data-contact="{{ c.id }}"
                              title="Позвонить с телефона"
                              aria-label="Позвонить с телефона"
                            >
                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>
                    {% empty %}
                      <div class="text-brand-dark/70">—</div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">Контактов нет.</div>
        {% endif %}
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Последние задачи</div>
        {% if tasks %}
          <div class="space-y-2">
            {% for t in tasks %}
              <div class="rounded-lg border p-3 {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}task-overdue{% endif %} cursor-pointer hover:bg-brand-soft/20 transition-colors" data-view-task data-task-id="{{ t.id }}" onclick="event.stopPropagation();">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <div class="flex items-start gap-2 mb-0.5">
                      {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}
                        <div class="flex items-center justify-center w-5 h-5 rounded-full border-2 border-red-600 flex-shrink-0 mt-0.5" title="Просрочено">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 8v4"/>
                            <path d="M12 16h.01"/>
                          </svg>
                        </div>
                      {% endif %}
                      <div class="flex-1">
                        {% if t.type %}
                          {% include "ui/partials/task_type_badge.html" with task_type=t.type only %}
                        {% elif t.title %}
                          <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-800">
                            {{ t.title }}
                          </span>
                        {% else %}
                          <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">Без статуса</span>
                        {% endif %}
                      </div>
                    </div>
                    {% if t.description %}
                      <div class="text-xs text-brand-dark/70 mt-1" style="line-height:1.3">{{ t.description|truncatechars:120 }}</div>
                    {% endif %}
                    <div class="text-xs text-brand-dark/70 mt-1">
                      {{ t.get_status_display }}
                      {% if t.assigned_to %} · {{ t.assigned_to }}{% endif %}
                    </div>
                  </div>
                  <div class="text-right flex-shrink-0">
                    <div class="text-xs {% if t.due_at and t.due_at < local_now and t.status != 'done' and t.status != 'cancelled' %}text-red-700 font-medium{% else %}text-brand-dark/70{% endif %}">
                      {% if t.due_at %}дедлайн: {{ t.due_at }}{% else %}—{% endif %}
                    </div>
                    <div class="mt-1 inline-flex gap-1 justify-end flex-wrap">
                      {% if t.can_edit_task %}
                        <button
                          type="button"
                          class="flex items-center justify-center w-6 h-6 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors"
                          data-edit-task
                          data-task-id="{{ t.id }}"
                          title="Редактировать"
                          aria-label="Редактировать"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                          </svg>
                        </button>
                      {% endif %}

                      {% if t.can_manage_status and t.status != 'in_progress' %}
                        <form method="post" action="/tasks/{{ t.id }}/status/" class="inline">
                          {% csrf_token %}
                          <button
                            name="status"
                            value="in_progress"
                            class="flex items-center justify-center w-6 h-6 rounded bg-brand-orange hover:opacity-90 text-white transition-colors"
                            title="В работу"
                            aria-label="В работу"
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
                              <path d="M8 2v4"/>
                              <path d="M16 2v4"/>
                              <path d="M8 10h8"/>
                              <path d="M8 14h8"/>
                            </svg>
                          </button>
                        </form>
                      {% endif %}

                      {% if t.can_manage_status and t.status != 'done' %}
                        <button
                          type="button"
                          class="flex items-center justify-center w-6 h-6 rounded bg-brand-teal hover:bg-brand-dark text-white transition-colors"
                          title="Выполнено"
                          aria-label="Выполнено"
                          data-task-complete
                          data-task-id="{{ t.id }}"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"/>
                          </svg>
                        </button>
                      {% endif %}

                      {% if t.can_delete_task %}
                        <button
                          type="button"
                          class="flex items-center justify-center w-6 h-6 rounded bg-white border border-red-200 hover:bg-red-50 transition-colors"
                          title="Удалить"
                          aria-label="Удалить"
                          data-task-delete
                          data-task-id="{{ t.id }}"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7"/>
                          </svg>
                        </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-brand-dark/70">Задач по компании пока нет.</div>
        {% endif %}
        <div class="mt-3">
          {% if can_edit_company %}
            <button type="button" class="btn btn-outline" data-create-task data-company-id="{{ company.id }}">+ Добавить задачу</button>
          {% endif %}
        </div>
      </section>

      <section class="card card-pad">
        <div class="font-medium mb-3">Заметки</div>
        {% if can_edit_company %}
          <form class="space-y-2" method="post" action="/companies/{{ company.id }}/notes/add/" enctype="multipart/form-data" id="noteForm" data-company-id="{{ company.id }}" data-user-id="{{ request.user.id }}">
            {% csrf_token %}
            <div class="space-y-2">
              {{ note_form.text }}
              <div class="flex items-center justify-between gap-2">
                <input id="noteFile" type="file" name="attachment" class="hidden" />
                <button type="button" class="btn btn-outline btn-sm" id="noteAttachBtn" title="Прикрепить файл">
                  <span class="inline-flex items-center gap-1">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M8 12.5l7.1-7.1a3 3 0 014.2 4.2l-8.5 8.5a5 5 0 01-7.1-7.1l8.2-8.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Файл</span>
                  </span>
                </button>
                <div class="text-xs muted-2 truncate" id="noteFileName"></div>
                <button class="btn btn-primary" type="submit">Добавить</button>
              </div>
              <div class="text-xs muted-2">Файл опционально. До 15 МБ. PDF/DOC/XLS/картинки и др.</div>
            </div>
          </form>
        {% else %}
          <div class="text-sm text-brand-dark/70">Нет прав на добавление заметок по этой компании.</div>
        {% endif %}

        <div class="mt-4">
          <div class="max-h-96 overflow-y-auto pr-1 space-y-3">
            {% for n in notes %}
            <div class="rounded-lg border p-3 bg-white/80 hover:bg-white transition-colors" data-note-item>
              <div class="flex items-start justify-between gap-3">
                <div class="text-xs text-brand-dark/70 mb-1">
                  {{ n.created_at }} · {{ n.author|default:"—" }}
                  {% if n.is_pinned %}· <span class="badge badge-warn badge-sm">Закреплено</span>{% endif %}
                  {% if n.edited_at %}· <span class="muted-2">ред. {{ n.edited_at|date:"d.m.Y" }}</span>{% endif %}
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  {% if can_edit_company %}
                    <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/pin/" style="display:inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline btn-sm" title="{% if n.is_pinned %}Открепить{% else %}Закрепить{% endif %}" aria-label="{% if n.is_pinned %}Открепить{% else %}Закрепить{% endif %}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M9 3h6l1 7 2 2v2H6v-2l2-2 1-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M12 17v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </form>
                  {% endif %}

                  {% if n.author_id == request.user.id or is_admin or is_group_manager or not n.author_id and company.responsible_id == request.user.id %}
                    <button
                      type="button"
                      class="btn btn-outline btn-sm"
                      title="Редактировать"
                      aria-label="Редактировать"
                      data-note-edit
                      data-note-id="{{ n.id }}"
                      data-note-text="{{ n.text|default:'' }}"
                      data-note-file="{{ n.attachment_name|default:'' }}"
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <form method="post" action="/companies/{{ company.id }}/notes/{{ n.id }}/delete/" onsubmit="return confirm('Удалить заметку?');" style="display:inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline btn-sm btn-danger" title="Удалить" aria-label="Удалить">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
              <div class="text-sm whitespace-pre-line wrap-anywhere" data-note-body>{{ n.text }}</div>
              {% if n.attachment %}
                <div class="mt-2 rounded-lg border border-brand-soft bg-brand-soft/15 px-3 py-2">
                  <div class="flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        {% with ext=n.attachment_ext|upper %}
                          {% if ext == "PDF" %}
                            <span class="badge badge-warn">PDF</span>
                          {% elif ext == "DOC" or ext == "DOCX" %}
                            <span class="badge">DOC</span>
                          {% elif ext == "XLS" or ext == "XLSX" %}
                            <span class="badge">XLS</span>
                          {% elif ext == "PPT" or ext == "PPTX" %}
                            <span class="badge">PPT</span>
                          {% elif ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                            <span class="badge">IMG</span>
                          {% elif ext %}
                            <span class="badge">{{ ext }}</span>
                          {% else %}
                            <span class="badge">FILE</span>
                          {% endif %}
                        <div class="text-sm font-medium truncate">{{ n.attachment_name|default:"Файл" }}</div>
                        {% if n.attachment_size %}<div class="text-xs muted-2">{{ n.attachment_size|filesizeformat }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="flex flex-wrap gap-2 shrink-0">
                      {% if ext == "PNG" or ext == "JPG" or ext == "JPEG" or ext == "GIF" or ext == "WEBP" %}
                        <button
                          type="button"
                          class="btn btn-outline btn-sm js-image-open"
                          data-img-url="/companies/{{ company.id }}/notes/{{ n.id }}/file/open/"
                          data-img-download="/companies/{{ company.id }}/notes/{{ n.id }}/file/download/"
                          data-img-title="{{ n.attachment_name|default:'Изображение' }}"
                        >Открыть</button>
                      {% else %}
                        <a class="btn btn-outline btn-sm" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/open/">Открыть</a>
                      {% endif %}
                      <a class="btn btn-outline btn-sm" target="_blank" rel="noopener" href="/companies/{{ company.id }}/notes/{{ n.id }}/file/download/">Скачать</a>
                    </div>
                    {% endwith %}
                  </div>
                </div>
              {% endif %}
            </div>
            {% empty %}
              <div class="text-sm text-brand-dark/70">Пока нет заметок.</div>
            {% endfor %}
          </div>
        </div>
      </section>
    </div>

    <div id="noteEditModal" class="fixed inset-0 z-[200] hidden">
      <div class="fixed inset-0 bg-black/35" data-close-noteedit></div>
      <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
        <div class="card card-pad">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-medium">Редактировать заметку</div>
              <div class="text-xs muted-2 mt-1">После сохранения появится метка «ред.»</div>
            </div>
            <button type="button" class="btn btn-outline btn-sm" data-close-noteedit aria-label="Закрыть" title="Закрыть">✕</button>
          </div>
          <form method="post" id="noteEditForm" class="mt-3 space-y-2" enctype="multipart/form-data">
            {% csrf_token %}
            <div>
              <label class="block text-xs text-brand-dark/70 mb-1">Текст</label>
              <textarea name="text" id="noteEditText" class="textarea" rows="5" placeholder="Текст заметки..."></textarea>
              <div class="text-xs muted-2 mt-1">Можно заменить/добавить файл или удалить текущий.</div>
            </div>
            <div class="rounded-xl border border-brand-soft bg-brand-soft/10 p-3">
              <div class="flex items-center justify-between gap-2">
                <div class="text-xs text-brand-dark/70">Файл</div>
                <label class="btn btn-outline btn-sm" style="cursor:pointer">
                  Выбрать файл
                  <input type="file" name="attachment" id="noteEditFile" class="hidden" />
                </label>
              </div>
              <div class="mt-2 text-xs">
                <div class="muted-2" id="noteEditFileCurrent">Текущий файл: —</div>
                <div class="muted-2" id="noteEditFileSelected"></div>
              </div>
              <div class="mt-2 flex items-center justify-between gap-2">
                <label class="inline-flex items-center gap-2 text-xs">
                  <input type="checkbox" id="noteEditRemoveFile" />
                  <span>Удалить текущий файл</span>
                </label>
                <input type="hidden" name="remove_attachment" id="noteEditRemoveHidden" value="0" />
              </div>
              <div class="muted-2 mt-2" style="font-size:0.6875rem;">Если выбрать новый файл — старый будет удалён с сервера.</div>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary" type="submit">Сохранить</button>
              <button class="btn btn-outline" type="button" data-close-noteedit>Отмена</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {# Просмотр изображений (вложения заметок) в модалке #}
    <div id="imagePreviewModal" class="fixed inset-0 z-[220] hidden">
      <div class="fixed inset-0 bg-black/60" data-close-img></div>
      <div class="absolute inset-x-4 top-10 mx-auto max-w-5xl">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
          <div class="flex items-center justify-between gap-3 px-4 py-3 border-b">
            <div class="min-w-0">
              <div class="text-sm font-medium truncate" id="imagePreviewTitle">Изображение</div>
              <div class="text-xs muted-2 truncate" id="imagePreviewHint">Esc — закрыть · колесо/тач — масштаб в браузере</div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <a class="btn btn-outline btn-sm" id="imagePreviewOpenLink" href="#" target="_blank" rel="noopener">В новой вкладке</a>
              <a class="btn btn-outline btn-sm" id="imagePreviewDownloadLink" href="#" target="_blank" rel="noopener">Скачать</a>
              <button type="button" class="btn btn-outline btn-sm" data-close-img aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
          </div>
          <div class="bg-black/5 p-3 flex items-center justify-center" style="max-height:85vh;">
            <div id="imagePreviewLoader" class="text-sm text-brand-dark/70 py-10">Загрузка…</div>
            <img id="imagePreviewImg" alt="" class="hidden rounded-xl border border-brand-soft bg-white" style="max-height:80vh; max-width:100%; object-fit:contain;" />
          </div>
        </div>
      </div>
    </div>

    {% if can_request_delete %}
      <div id="deleteRequestModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-delreq></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Запросить удаление компании</div>
                <div class="text-xs muted-2 mt-1">Опишите причину — запрос уйдёт РОП и директору филиала.</div>
              </div>
              <button type="button" class="btn btn-outline btn-sm" data-close-delreq aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete-request/" class="mt-3 space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Примечание</label>
                <div class="flex flex-wrap gap-2 mb-2">
                  <button type="button" class="btn btn-outline btn-xs" data-delreq-template="Карточка задвоена">Карточка задвоена</button>
                  <button type="button" class="btn btn-outline btn-xs" data-delreq-template="Предприятие ликвидировано">Предприятие ликвидировано</button>
                </div>
                <textarea name="note" class="textarea" rows="5" placeholder="Почему нужно удалить карточку?">{{ delete_req.note|default:"" }}</textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary" type="submit">Отправить запрос</button>
                <button class="btn btn-outline" type="button" data-close-delreq>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}


    {% if can_delete_company %}
      <div id="deleteCompanyModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-delcompany></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium" style="color:#b91c1c">Удалить компанию</div>
                <div class="text-xs muted-2 mt-1">
                  Удаление необратимо. Заметки будут удалены, задачи/контакты отвяжутся от компании.
                  Если у компании есть клиентские филиалы — они станут самостоятельными (головными).
                </div>
              </div>
              <button type="button" class="btn btn-outline btn-sm" data-close-delcompany aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete/" class="mt-3 space-y-2" onsubmit="return confirm('Точно удалить компанию?');">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Комментарий (не обязательно)</label>
                <textarea name="reason" class="textarea" rows="3" placeholder="Причина удаления"></textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary btn-danger" type="submit">Удалить</button>
                <button class="btn btn-outline" type="button" data-close-delcompany>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if can_delete_company and delete_req %}
      <div id="cancelDeleteReqModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-cancelreq></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Отменить запрос на удаление</div>
                <div class="text-xs muted-2 mt-1">Менеджеру уйдёт уведомление с причиной.</div>
              </div>
              <button type="button" class="btn btn-outline btn-sm" data-close-cancelreq aria-label="Закрыть" title="Закрыть">✕</button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/delete-request/{{ delete_req.id }}/cancel/" class="mt-3 space-y-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Почему отменили?</label>
                <textarea name="decision_note" class="textarea" rows="4" placeholder="Причина отмены" required></textarea>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-outline" type="submit">Отменить запрос</button>
                <button class="btn btn-outline" type="button" data-close-cancelreq>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}


    {% if can_edit_company %}
      <div id="contractModal" class="fixed inset-0 z-[200] hidden">
        <div class="fixed inset-0 bg-black/35" data-close-contract></div>
        <div class="absolute inset-x-4 top-24 mx-auto max-w-lg">
          <div class="card card-pad">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium">Изменить договор</div>
                <div class="text-xs muted-2 mt-1">Меняем только вид договора и срок действия.</div>
              </div>
              <button type="button" class="btn btn-outline btn-sm" data-close-contract aria-label="Закрыть" title="Закрыть">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <form method="post" action="/companies/{{ company.id }}/contract/update/" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
              {% csrf_token %}
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Вид</label>
                {{ contract_form.contract_type }}
              </div>
              <div>
                <label class="block text-xs text-brand-dark/70 mb-1">Действует до (не обязательно)</label>
                {{ contract_form.contract_until }}
              </div>
              <div class="md:col-span-2 flex gap-2">
                <button class="btn btn-primary" type="submit">Сохранить</button>
                <button class="btn btn-outline" type="button" data-close-contract>Отмена</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    <script>
      (function(){
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }
        
        const contractModal = document.getElementById('contractModal');
        const openContract = document.getElementById('openContractModal');
        if (contractModal && openContract) {
          const closeBtns = contractModal.querySelectorAll('[data-close-contract]');
          function openM() { contractModal.classList.remove('hidden'); }
          function closeM() { contractModal.classList.add('hidden'); }
          openContract.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeM();
          });
        }

        const delReqModal = document.getElementById('deleteRequestModal');
        const openDelReq = document.getElementById('openDeleteRequestModal');
        if (delReqModal && openDelReq) {
          const closeBtns = delReqModal.querySelectorAll('[data-close-delreq]');
          const noteTa = delReqModal.querySelector('textarea[name="note"]');
          function openM() {
            delReqModal.classList.remove('hidden');
            try { noteTa && noteTa.focus(); } catch(_e) {}
          }
          function closeM() { delReqModal.classList.add('hidden'); }
          openDelReq.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });

          // Быстрые варианты примечаний
          delReqModal.querySelectorAll('[data-delreq-template]').forEach(btn => {
            btn.addEventListener('click', function() {
              if (!noteTa) return;
              const tpl = (this.getAttribute('data-delreq-template') || '').trim();
              if (!tpl) return;
              const cur = (noteTa.value || '');
              const curTrim = cur.trim();
              if (curTrim) {
                const next = curTrim + '\n' + tpl;
                noteTa.value = next;
              } else {
                noteTa.value = tpl;
              }
              try {
                noteTa.focus();
                noteTa.selectionStart = noteTa.selectionEnd = noteTa.value.length;
              } catch(_e) {}
            });
          });
        }

        const delCompanyModal = document.getElementById('deleteCompanyModal');
        const openDelCompany = document.getElementById('openDeleteCompanyModal');
        if (delCompanyModal && openDelCompany) {
          const closeBtns = delCompanyModal.querySelectorAll('[data-close-delcompany]');
          function openM() { delCompanyModal.classList.remove('hidden'); }
          function closeM() { delCompanyModal.classList.add('hidden'); }
          openDelCompany.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }

        const cancelReqModal = document.getElementById('cancelDeleteReqModal');
        const openCancelReq = document.getElementById('openCancelDeleteReqModal');
        if (cancelReqModal && openCancelReq) {
          const closeBtns = cancelReqModal.querySelectorAll('[data-close-cancelreq]');
          function openM() { cancelReqModal.classList.remove('hidden'); }
          function closeM() { cancelReqModal.classList.add('hidden'); }
          openCancelReq.addEventListener('click', openM);
          closeBtns.forEach(b => b.addEventListener('click', closeM));
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeM(); });
        }


        // Ждем, пока DOM готов и uiToast определена
        function initCallPhone() {
          const uiToast = window.uiToast || function(text, type) {
            try {
              console.log('[toast]', text, type);
              // Простой fallback: показываем alert, если uiToast не загружена
              if (type === 'error') {
                alert('Ошибка: ' + text);
              } else {
                alert(text);
              }
            } catch(_e) {}
          };
          const csrftoken = getCookie('csrftoken');
          
          // Подтверждение перед отметкой холодного звонка обрабатывается в base.html

          // Старая логика с data-disabled больше не используется - кнопка показывается только если is_cold_call = False

          document.querySelectorAll('.js-call-phone').forEach(btn => {
            btn.addEventListener('click', async () => {
              // Получаем номер из data-phone (в БД хранится в виде +7XXXXXXXXXX)
              let phone = btn.dataset.phone || '';
              // Убираем все нецифровые символы, кроме ведущего +
              phone = phone.replace(/[^\d+]/g, '');
              
              // Если номер уже в формате +7XXXXXXXXXX (12 символов), оставляем как есть
              if (phone.startsWith('+7') && phone.length === 12) {
                // Уже нормализован, ничего не делаем
              }
              // Если начинается с +7, но длина не 12 - возможно лишние символы
              else if (phone.startsWith('+7')) {
                // Оставляем только +7 и следующие 10 цифр
                const digits = phone.substring(2).replace(/\D/g, '');
                if (digits.length === 10) {
                  phone = '+7' + digits;
                }
              }
              // Если начинается с 8 и 11 цифр => +7XXXXXXXXXX
              else if (phone.startsWith('8') && phone.length === 11) {
                phone = '+7' + phone.substring(1);
              }
              // Если начинается с 7 и 11 цифр => +7XXXXXXXXXX
              else if (phone.startsWith('7') && phone.length === 11) {
                phone = '+7' + phone.substring(1);
              }
              // Если 10 цифр => +7XXXXXXXXXX
              else if (/^\d{10}$/.test(phone)) {
                phone = '+7' + phone;
              }
              // Если ничего не подошло, пытаемся извлечь 10 цифр из конца
              else {
                const digits = phone.replace(/\D/g, '');
                if (digits.length >= 10) {
                  const last10 = digits.slice(-10);
                  phone = '+7' + last10;
                }
              }
              const companyId = btn.dataset.company || '';
              const contactId = btn.dataset.contact || '';
              // Не делаем btn.disabled=true: на disabled в ряде браузеров пропадает подсказка (title).
              // Вместо этого ставим лок и защищаемся от повторных кликов.
              if (btn.dataset.busy === '1') return;
              btn.dataset.busy = '1';
              btn.classList.add('opacity-60');
              uiToast('Отправляю команду на телефон…', 'info');
              try {
                const body = new URLSearchParams({phone, company_id: companyId, contact_id: contactId});
                const res = await fetch('/phone/call/', {
                  method: 'POST',
                  headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
                  body: body.toString()
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.ok) throw new Error(data.detail || 'Ошибка');
                uiToast('Отправлено на телефон ✓', 'success');
                // Новая логика: кнопка "отметить холодный" больше не активируется автоматически
                // Пользователь может отметить холодный звонок в любое время через кнопку
                btn.dataset.busy = '0';
                btn.classList.remove('opacity-60');
              } catch (e) {
                btn.dataset.busy = '0';
                btn.classList.remove('opacity-60');
                uiToast('Не удалось отправить на телефон: ' + (e && e.message ? e.message : e), 'error');
              }
            });
          });
        }
        
        // Инициализируем после загрузки DOM и проверяем, что uiToast доступна
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCallPhone);
        } else {
          // Если DOM уже загружен, ждем немного, чтобы uiToast успела определиться
          setTimeout(initCallPhone, 100);
        }

        // Note edit modal
        const noteEditModal = document.getElementById('noteEditModal');
        const noteEditForm = document.getElementById('noteEditForm');
        const noteEditText = document.getElementById('noteEditText');
        const noteEditFile = document.getElementById('noteEditFile');
        const noteEditFileCurrent = document.getElementById('noteEditFileCurrent');
        const noteEditFileSelected = document.getElementById('noteEditFileSelected');
        const noteEditRemoveFile = document.getElementById('noteEditRemoveFile');
        const noteEditRemoveHidden = document.getElementById('noteEditRemoveHidden');
        if (noteEditModal && noteEditForm && noteEditText) {
          const closeBtns = noteEditModal.querySelectorAll('[data-close-noteedit]');
          function openNoteEdit(noteId, noteText, fileName) {
            noteEditForm.action = `/companies/{{ company.id }}/notes/${noteId}/edit/`;
            noteEditText.value = noteText || '';
            if (noteEditFile) noteEditFile.value = '';
            if (noteEditFileSelected) noteEditFileSelected.textContent = '';
            if (noteEditRemoveFile) noteEditRemoveFile.checked = false;
            if (noteEditRemoveHidden) noteEditRemoveHidden.value = '0';
            if (noteEditFileCurrent) noteEditFileCurrent.textContent = 'Текущий файл: ' + (fileName ? fileName : '—');
            noteEditModal.classList.remove('hidden');
            setTimeout(() => { try{ noteEditText.focus(); }catch(_e){} }, 0);
          }
          function closeNoteEdit() { noteEditModal.classList.add('hidden'); }
          document.querySelectorAll('[data-note-edit]').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.getAttribute('data-note-id');
              // Получаем текст напрямую из атрибута (без escapejs, чтобы избежать двойного экранирования)
              const txt = btn.getAttribute('data-note-text') || '';
              const fn = btn.getAttribute('data-note-file') || '';
              if (id) openNoteEdit(id, txt, fn);
            });
          });
          closeBtns.forEach(b => b.addEventListener('click', closeNoteEdit));
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeNoteEdit();
          });
          if (noteEditFile && noteEditFileSelected) {
            noteEditFile.addEventListener('change', () => {
              const f = noteEditFile.files && noteEditFile.files.length ? noteEditFile.files[0] : null;
              noteEditFileSelected.textContent = f ? ('Выбран: ' + f.name) : '';
              if (noteEditRemoveFile) noteEditRemoveFile.checked = false;
              if (noteEditRemoveHidden) noteEditRemoveHidden.value = '0';
            });
          }
          if (noteEditRemoveFile) {
            noteEditRemoveFile.addEventListener('change', () => {
              if (noteEditRemoveHidden) noteEditRemoveHidden.value = noteEditRemoveFile.checked ? '1' : '0';
              if (noteEditRemoveFile.checked && noteEditFile) {
                noteEditFile.value = '';
                if (noteEditFileSelected) noteEditFileSelected.textContent = '';
              }
            });
          }
        }
      })();
    </script>

    <script>
      (function(){
        const btn = document.getElementById('noteAttachBtn');
        const input = document.getElementById('noteFile');
        const name = document.getElementById('noteFileName');
        if (!btn || !input) return;
        btn.addEventListener('click', () => input.click());
        input.addEventListener('change', () => {
          const f = input.files && input.files.length ? input.files[0] : null;
          if (name) name.textContent = f ? f.name : '';
        });
      })();
    </script>

    <script>
      // Черновик заметки в карточке компании: сохраняем текст локально, чтобы не терялся при переходах.
      (function(){
        const form = document.getElementById('noteForm');
        if (!form) return;

        const textarea = form.querySelector('textarea[name="text"]');
        if (!textarea) return;

        const companyId = form.getAttribute('data-company-id') || '';
        const userId = form.getAttribute('data-user-id') || '';
        const storageKey = `companyNoteDraft:v1:${userId}:${companyId}`;

        function normalize(s) {
          return String(s || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
        }

        function getDraft() {
          try { return localStorage.getItem(storageKey) || ''; } catch (_e) { return ''; }
        }
        function setDraft(v) {
          try { localStorage.setItem(storageKey, v); } catch (_e) {}
        }
        function clearDraft() {
          try { localStorage.removeItem(storageKey); } catch (_e) {}
        }

        // Если последний добавленный note совпадает с черновиком — считаем, что он сохранён, и очищаем.
        const draft = getDraft();
        if (draft) {
          const firstNoteBody = document.querySelector('[data-note-item] [data-note-body]');
          if (firstNoteBody) {
            const noteText = normalize(firstNoteBody.textContent || '');
            if (noteText && noteText === normalize(draft)) {
              clearDraft();
            }
          }
        }

        // Восстановление черновика (только если поле пустое/не тронуто сервером)
        const current = normalize(textarea.value);
        const draft2 = getDraft();
        if (!current && draft2) {
          textarea.value = draft2;
        }

        // Автосохранение по мере ввода (debounce)
        let t = null;
        textarea.addEventListener('input', () => {
          if (t) window.clearTimeout(t);
          t = window.setTimeout(() => {
            const v = textarea.value || '';
            if (normalize(v)) setDraft(v);
            else clearDraft();
          }, 250);
        });

        // На случай быстрых переходов — сохраняем при уходе со страницы
        window.addEventListener('beforeunload', () => {
          const v = textarea.value || '';
          if (normalize(v)) setDraft(v);
        });
      })();
    </script>

    {% if can_view_activity %}
      <details class="card card-pad">
        <summary class="cursor-pointer font-medium">История действий</summary>
        <div class="mt-3">
          {% if activity %}
            <div class="space-y-2">
              {% for ev in activity %}
                <div class="rounded-lg border p-3 text-sm">
                  <div class="text-xs text-brand-dark/70 mb-1">{{ ev.created_at }} · {{ ev.actor|default:"—" }}</div>
                  <div>{{ ev.message|default:ev.get_verb_display }}</div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-brand-dark/70">Пока пусто.</div>
          {% endif %}
        </div>
      </details>
    {% endif %}
  </div>

  <!-- Модальное окно для создания задачи -->
  <div id="taskCreateModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-create-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
      <div id="taskCreateModalContent"></div>
    </div>
  </div>

  <!-- Модальное окно для редактирования задач -->
  <div id="taskEditModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-lg max-h-[90vh] overflow-y-auto">
      <div id="taskEditModalContent"></div>
    </div>
  </div>

  <script>
    (function() {
      // Просмотр изображений (вложения заметок) без новой вкладки
      const imgModal = document.getElementById('imagePreviewModal');
      const imgEl = document.getElementById('imagePreviewImg');
      const imgTitle = document.getElementById('imagePreviewTitle');
      const imgLoader = document.getElementById('imagePreviewLoader');
      const openLink = document.getElementById('imagePreviewOpenLink');
      const dlLink = document.getElementById('imagePreviewDownloadLink');

      function closeImgModal() {
        if (!imgModal) return;
        imgModal.classList.add('hidden');
        if (imgEl) {
          imgEl.classList.add('hidden');
          imgEl.removeAttribute('src');
          imgEl.alt = '';
        }
        if (imgLoader) imgLoader.style.display = '';
        if (imgTitle) imgTitle.textContent = 'Изображение';
        if (openLink) openLink.setAttribute('href', '#');
        if (dlLink) dlLink.setAttribute('href', '#');
      }

      function openImgModal(url, downloadUrl, title) {
        if (!imgModal || !imgEl) return;
        const u = (url || '').toString().trim();
        if (!u) return;
        if (imgTitle) imgTitle.textContent = (title || 'Изображение').toString();
        if (openLink) openLink.setAttribute('href', u);
        if (dlLink) dlLink.setAttribute('href', (downloadUrl || u).toString());
        if (imgLoader) imgLoader.style.display = '';
        imgEl.classList.add('hidden');
        imgEl.alt = (title || 'Изображение').toString();
        imgEl.onload = function() {
          if (imgLoader) imgLoader.style.display = 'none';
          imgEl.classList.remove('hidden');
        };
        imgEl.onerror = function() {
          if (imgLoader) imgLoader.textContent = 'Не удалось загрузить изображение.';
        };
        imgEl.src = u;
        imgModal.classList.remove('hidden');
      }

      // Делегирование кликов по кнопке "Открыть" для картинок
      document.addEventListener('click', function(e) {
        const btn = e.target.closest('.js-image-open');
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        openImgModal(
          btn.getAttribute('data-img-url') || '',
          btn.getAttribute('data-img-download') || '',
          btn.getAttribute('data-img-title') || 'Изображение'
        );
      });

      // Закрытие модалки
      if (imgModal) {
        imgModal.querySelectorAll('[data-close-img]').forEach(b => b.addEventListener('click', function(e){ e.preventDefault(); closeImgModal(); }));
        imgModal.querySelector('[data-close-img]')?.addEventListener('click', function(e){ e.preventDefault(); closeImgModal(); });
        imgModal.querySelector('.bg-black\\/60')?.addEventListener('click', function(e){
          if (e.target === e.currentTarget) closeImgModal();
        });
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && !imgModal.classList.contains('hidden')) closeImgModal();
        });
      }

      // Модальное окно для создания задачи
      const createModal = document.getElementById('taskCreateModal');
      const createModalContent = document.getElementById('taskCreateModalContent');
      if (createModal && createModalContent) {
        function closeCreateModal() {
          createModal.classList.add('hidden');
          createModalContent.innerHTML = '';
        }
        
        document.addEventListener('click', (e) => {
          const closeBtn = e.target.closest('[data-close-task-create-modal]');
          if (closeBtn) {
            e.preventDefault();
            closeCreateModal();
          }
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !createModal.classList.contains('hidden')) closeCreateModal();
        });
        createModal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) closeCreateModal();
        });
        
        // Создание задачи
        document.querySelectorAll('[data-create-task]').forEach(btn => {
          btn.addEventListener('click', async function() {
            const companyId = this.dataset.companyId || '';
            const url = `/tasks/new/?modal=1${companyId ? '&company=' + companyId : ''}`;
            
            try {
              const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
              if (!res.ok) throw new Error('Ошибка загрузки формы');
              const html = await res.text();
              createModalContent.innerHTML = html;
              createModal.classList.remove('hidden');
              
              // Инициализация select с небольшой задержкой для гарантии обновления DOM
              setTimeout(function() {
                if (window.initTaskTypeSelects) {
                  window.initTaskTypeSelects();
                }
                // Инициализация виджета выбора компании
                if (window.initMsSingleWidgets) {
                  window.initMsSingleWidgets(createModalContent);
                  
                  // Устанавливаем выбранную компанию после инициализации виджета
                  if (companyId) {
                    const companySelect = createModalContent.querySelector('select[name="company"], select#id_company');
                    if (companySelect) {
                      // Проверяем, есть ли опция с нужным значением
                      const optionExists = Array.from(companySelect.options).some(opt => opt.value === companyId);
                      if (optionExists) {
                        companySelect.value = companyId;
                        // Триггерим событие change для обновления виджета
                        companySelect.dispatchEvent(new Event('change', { bubbles: true }));
                        // Обновляем визуальное отображение виджета
                        const msWidget = companySelect.closest('[data-ms-single="1"]');
                        if (msWidget) {
                          const valueEl = msWidget.querySelector('.ms-value');
                          const selectedOption = companySelect.options[companySelect.selectedIndex];
                          if (valueEl && selectedOption) {
                            valueEl.textContent = selectedOption.textContent.trim();
                          }
                        }
                      } else {
                        // Если опции нет в списке, загружаем компанию через AJAX
                        fetch(`/companies/autocomplete/?q=${encodeURIComponent(companyId)}`, {
                          headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                        .then(res => res.json())
                        .then(data => {
                          if (data.items && data.items.length > 0) {
                            const company = data.items.find(item => item.id === companyId);
                            if (company) {
                              // Добавляем опцию в select
                              const opt = document.createElement('option');
                              opt.value = company.id;
                              opt.textContent = company.name;
                              if (company.inn) opt.textContent += ` (ИНН: ${company.inn})`;
                              companySelect.appendChild(opt);
                              companySelect.value = companyId;
                              // Триггерим событие change для обновления виджета
                              companySelect.dispatchEvent(new Event('change', { bubbles: true }));
                              // Обновляем визуальное отображение виджета
                              const msWidget = companySelect.closest('[data-ms-single="1"]');
                              if (msWidget) {
                                const valueEl = msWidget.querySelector('.ms-value');
                                if (valueEl) {
                                  valueEl.textContent = opt.textContent.trim();
                                }
                              }
                            }
                          }
                        })
                        .catch(err => console.error('Ошибка загрузки компании:', err));
                      }
                    }
                  }
                }
              }, 150);
              
              const form = createModalContent.querySelector('[data-task-create-form]');
              if (form) {
                const typeSelect = form.querySelector('#id_type');
                const typeErrorBox = form.querySelector('[data-task-type-error]');
                const defaultTypeErrorMsg = 'Пожалуйста, выберите тип задачи в поле «Задача».';

                function setTypeError(msg) {
                  if (!typeErrorBox) return;
                  const m = (msg || '').trim();
                  typeErrorBox.textContent = m;
                  typeErrorBox.classList.toggle('hidden', !m);
                }

                if (typeSelect) {
                  typeSelect.addEventListener('change', () => {
                    const hasValue = Boolean(typeSelect.value && typeSelect.value !== '0');
                    setTypeError(hasValue ? '' : defaultTypeErrorMsg);
                  });
                }

                form.addEventListener('submit', async function(e) {
                  e.preventDefault();
                  const formData = new FormData(form);
                  try {
                    const res = await fetch(form.action, {
                      method: 'POST',
                      headers: { 'X-Requested-With': 'XMLHttpRequest' },
                      body: formData
                    });
                    
                    // Проверяем, является ли ответ JSON
                    const contentType = res.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                      const text = await res.text();
                      throw new Error('Сервер вернул не JSON ответ. Возможно, произошла ошибка на сервере.');
                    }
                    
                    const data = await res.json();
                    if (data.ok) {
                      closeCreateModal();
                      location.reload();
                    } else {
                      // Мягкая подсветка ошибки: показываем сообщение под полем «Задача»
                      let fieldMessage = '';
                      if (data.errors && data.errors.type) {
                        if (Array.isArray(data.errors.type)) {
                          fieldMessage = data.errors.type.join(', ');
                        } else if (typeof data.errors.type === 'object' && data.errors.type.length) {
                          fieldMessage = Array.from(data.errors.type).join(', ');
                        } else {
                          fieldMessage = String(data.errors.type);
                        }
                      }

                      const msg = fieldMessage || data.error || 'Проверьте заполнение формы задачи.';

                      setTypeError(fieldMessage || '');

                      if (!fieldMessage && window.uiToast) {
                        window.uiToast(msg, 'error');
                      } else if (!fieldMessage) {
                        console.warn('Ошибка создания задачи:', msg);
                      }
                    }
                  } catch (err) {
                    if (window.uiToast) {
                      window.uiToast('Ошибка при создании задачи: ' + err.message, 'error');
                    } else {
                      console.error('Ошибка при создании задачи:', err);
                    }
                  }
                }, { once: true });
              }
            } catch (err) {
              alert('Ошибка загрузки формы: ' + err.message);
            }
          });
        });
      }
      
      const modal = document.getElementById('taskEditModal');
      const modalContent = document.getElementById('taskEditModalContent');
      if (!modal || !modalContent) return;

      // Закрытие модалки
      function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
      }
      // Делегирование для динамически добавленных кнопок закрытия
      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-close-task-modal]');
        if (closeBtn) {
          e.preventDefault();
          closeModal();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
      modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
      });

      // Редактирование задачи
      document.querySelectorAll('[data-edit-task]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const taskId = this.dataset.taskId;
          const url = `/tasks/${taskId}/edit/?modal=1`;
          
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Ошибка загрузки формы');
            const html = await res.text();
            modalContent.innerHTML = html;
            modal.classList.remove('hidden');
            
            // Инициализация select для типа задачи с задержкой
            setTimeout(function() {
              if (window.initTaskTypeSelects) {
                window.initTaskTypeSelects();
              }
              // Инициализация виджета выбора компании
              if (window.initMsSingleWidgets) {
                window.initMsSingleWidgets(modalContent);
              }
            }, 100);
            
            // Обработка формы
            const form = modalContent.querySelector('[data-task-edit-form]');
            if (form) {
              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                
                try {
                  const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                  });
                  const data = await res.json();
                  if (data.ok) {
                    closeModal();
                    location.reload();
                  } else {
                    alert('Ошибка: ' + (data.error || 'Не удалось сохранить'));
                  }
                } catch (err) {
                  alert('Ошибка при сохранении: ' + err.message);
                }
              }, { once: true });
            }
          } catch (err) {
            alert('Ошибка загрузки формы: ' + err.message);
          }
        });
      });
    })();
  </script>

  <!-- Модальное окно для подтверждения удаления задачи с переносом в заметки -->
  <div id="taskDeleteModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-delete-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-md">
      <div class="bg-white border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Удалить задачу?</h2>
          <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-delete-modal aria-label="Закрыть" title="Закрыть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <p class="text-sm text-brand-dark/70">Нужно ли перенести данные задачи в заметки?</p>
          <div class="flex gap-2 pt-2 border-t">
            <button type="button" class="btn btn-primary flex-1" id="taskDeleteWithNote">Да, перенести</button>
            <button type="button" class="btn btn-outline flex-1" id="taskDeleteWithoutNote">Нет, удалить</button>
            <button type="button" class="btn btn-outline" data-close-task-delete-modal>Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для подтверждения выполнения задачи с переносом в заметки -->
  <div id="taskCompleteModal" class="fixed inset-0 z-[200] hidden">
    <div class="fixed inset-0 bg-black/35" data-close-task-complete-modal></div>
    <div class="absolute inset-x-4 top-12 mx-auto max-w-md">
      <div class="bg-white border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Отметить задачу как выполненную?</h2>
          <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-complete-modal aria-label="Закрыть" title="Закрыть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <p class="text-sm text-brand-dark/70">Нужно ли перенести данные задачи в заметки?</p>
          <div class="flex gap-2 pt-2 border-t">
            <button type="button" class="btn btn-primary flex-1" id="taskCompleteWithNote">Да, перенести</button>
            <button type="button" class="btn btn-outline flex-1" id="taskCompleteWithoutNote">Нет, только выполнить</button>
            <button type="button" class="btn btn-outline" data-close-task-complete-modal>Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      let currentTaskId = null;
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name=csrf-token]')?.content;

      // Модальное окно удаления задачи
      const deleteModal = document.getElementById('taskDeleteModal');
      const deleteBtns = document.querySelectorAll('[data-task-delete]');
      
      deleteBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          currentTaskId = this.dataset.taskId;
          deleteModal.classList.remove('hidden');
        });
      });

      function closeDeleteModal() {
        deleteModal.classList.add('hidden');
        currentTaskId = null;
      }

      deleteModal.querySelectorAll('[data-close-task-delete-modal]').forEach(b => {
        b.addEventListener('click', closeDeleteModal);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !deleteModal.classList.contains('hidden')) closeDeleteModal();
      });
      deleteModal.querySelector('.bg-black\\/35')?.addEventListener('click', function(e) {
        if (e.target === this) closeDeleteModal();
      });

      document.getElementById('taskDeleteWithNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('save_to_notes', '1');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/delete/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при удалении задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      document.getElementById('taskDeleteWithoutNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('save_to_notes', '0');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/delete/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при удалении задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      // Модальное окно выполнения задачи
      const completeModal = document.getElementById('taskCompleteModal');
      const completeBtns = document.querySelectorAll('[data-task-complete]');
      
      completeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          currentTaskId = this.dataset.taskId;
          completeModal.classList.remove('hidden');
        });
      });

      function closeCompleteModal() {
        completeModal.classList.add('hidden');
        currentTaskId = null;
      }

      completeModal.querySelectorAll('[data-close-task-complete-modal]').forEach(b => {
        b.addEventListener('click', closeCompleteModal);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !completeModal.classList.contains('hidden')) closeCompleteModal();
      });
      completeModal.querySelector('.bg-black\\/35')?.addEventListener('click', function(e) {
        if (e.target === this) closeCompleteModal();
      });

      document.getElementById('taskCompleteWithNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('status', 'done');
        formData.append('save_to_notes', '1');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/status/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при изменении статуса задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      document.getElementById('taskCompleteWithoutNote')?.addEventListener('click', function() {
        if (!currentTaskId) return;
        const formData = new FormData();
        formData.append('status', 'done');
        formData.append('save_to_notes', '0');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(`/tasks/${currentTaskId}/status/`, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Ошибка при изменении статуса задачи');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });
    })();

    // Обработка комментариев к телефонам
    (function() {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name=csrf-token]')?.content;
      
      // Обработчик клика на комментарий для редактирования
      document.addEventListener('click', function(e) {
        const editBtn = e.target.closest('[data-edit-comment]');
        if (!editBtn) return;
        
        const wrapper = editBtn.closest('.phone-comment-wrapper');
        if (!wrapper) return;
        
        const display = wrapper.querySelector('.phone-comment-display');
        const edit = wrapper.querySelector('.phone-comment-edit');
        const input = wrapper.querySelector('[data-comment-input]');
        
        if (display && edit && input) {
          display.classList.add('hidden');
          edit.classList.remove('hidden');
          input.focus();
          input.select();
        }
      });

      // Сохранение комментария
      document.addEventListener('click', function(e) {
        const saveBtn = e.target.closest('[data-save-comment]');
        if (!saveBtn) return;
        
        const wrapper = saveBtn.closest('.phone-comment-wrapper');
        if (!wrapper) return;
        
        const phoneType = wrapper.dataset.phoneType;
        const phoneId = wrapper.dataset.phoneId;
        const companyId = wrapper.dataset.companyId;
        const input = wrapper.querySelector('[data-comment-input]');
        
        if (!input) return;
        
        const comment = input.value.trim();
        let url = '';
        
        if (phoneType === 'main') {
          url = `/companies/${companyId}/main-phone/comment/`;
        } else if (phoneType === 'company') {
          url = `/company-phones/${phoneId}/comment/`;
        } else if (phoneType === 'contact') {
          url = `/contact-phones/${phoneId}/comment/`;
        } else {
          return;
        }
        
        const formData = new FormData();
        formData.append('comment', comment);
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch(url, {
          method: 'POST',
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            const display = wrapper.querySelector('.phone-comment-display');
            const edit = wrapper.querySelector('.phone-comment-edit');
            
            if (display && edit) {
              display.textContent = data.comment || 'Комментарий';
              display.classList.remove('hidden');
              edit.classList.add('hidden');
            }
          } else {
            alert(data.error || 'Ошибка при сохранении комментария');
          }
        })
        .catch(err => {
          alert('Ошибка: ' + err.message);
        });
      });

      // Отмена редактирования
      document.addEventListener('click', function(e) {
        const cancelBtn = e.target.closest('[data-cancel-comment]');
        if (!cancelBtn) return;
        
        const wrapper = cancelBtn.closest('.phone-comment-wrapper');
        if (!wrapper) return;
        
        const display = wrapper.querySelector('.phone-comment-display');
        const edit = wrapper.querySelector('.phone-comment-edit');
        const input = wrapper.querySelector('[data-comment-input]');
        
        if (display && edit && input) {
          // Восстанавливаем исходное значение
          const originalComment = display.textContent.trim();
          input.value = originalComment === 'Комментарий' ? '' : originalComment;
          
          display.classList.remove('hidden');
          edit.classList.add('hidden');
        }
      });

      // Сохранение по Enter, отмена по Escape
      document.addEventListener('keydown', function(e) {
        const input = e.target.closest('[data-comment-input]');
        if (!input) return;
        
        const wrapper = input.closest('.phone-comment-wrapper');
        if (!wrapper) return;
        
        // В textarea Enter/Shift+Enter должны вставлять перенос строки.
        // Быстрое сохранение: Ctrl+Enter / Cmd+Enter.
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          const saveBtn = wrapper.querySelector('[data-save-comment]');
          if (saveBtn) saveBtn.click();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          const cancelBtn = wrapper.querySelector('[data-cancel-comment]');
          if (cancelBtn) cancelBtn.click();
        }
      });

      // Инлайн-редактирование базовых полей компании (как комментарии)
      (function() {
        // Не запускаем, если нет доступа к редактированию (инлайн-блоков нет)
        if (!document.querySelector('.inline-field-wrapper[data-company-id]')) return;

        function showError(wrapper, msg) {
          const err = wrapper.querySelector('[data-inline-error]');
          if (!err) return;
          err.textContent = (msg || '').trim();
          err.classList.toggle('hidden', !err.textContent);
        }

        function openEdit(wrapper) {
          const display = wrapper.querySelector('.inline-field-display');
          const edit = wrapper.querySelector('.inline-field-edit');
          const input = wrapper.querySelector('[data-inline-input]');
          if (!display || !edit || !input) return;
          if (wrapper.dataset.inlineOriginal === undefined) {
            wrapper.dataset.inlineOriginal = (input.value !== undefined ? input.value : (input.textContent || ''));
          }
          showError(wrapper, '');
          display.classList.add('hidden');
          edit.classList.remove('hidden');
          try {
            input.focus();
            if (input.select) input.select();
          } catch (e) {}
        }

        function closeEdit(wrapper, restore) {
          const display = wrapper.querySelector('.inline-field-display');
          const edit = wrapper.querySelector('.inline-field-edit');
          const input = wrapper.querySelector('[data-inline-input]');
          if (!display || !edit || !input) return;
          if (restore && wrapper.dataset.inlineOriginal !== undefined) {
            if (input.value !== undefined) input.value = wrapper.dataset.inlineOriginal;
            else input.textContent = wrapper.dataset.inlineOriginal;
          }
          showError(wrapper, '');
          display.classList.remove('hidden');
          edit.classList.add('hidden');
        }

        function normalizeWebsiteHref(raw) {
          const v = (raw || '').trim();
          if (!v) return '';
          if (v.includes('://')) return v;
          if (v.startsWith('//')) return 'https:' + v;
          return 'https://' + v;
        }

        function updateWebsiteDisplay(wrapper, newValue) {
          const display = wrapper.querySelector('[data-inline-display]');
          if (!display) return;
          const href = normalizeWebsiteHref(newValue);
          display.innerHTML = '';
          if (newValue && newValue.trim()) {
            const a = document.createElement('a');
            a.className = 'link break-all';
            a.href = href;
            a.target = '_blank';
            a.rel = 'noopener';
            a.textContent = newValue.trim();
            display.appendChild(a);
          } else {
            const span = document.createElement('span');
            span.className = 'text-brand-dark/70';
            span.textContent = '—';
            display.appendChild(span);
          }
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-outline btn-xs';
          btn.setAttribute('data-inline-edit', '');
          btn.title = 'Редактировать сайт';
          btn.textContent = 'Изменить';
          display.appendChild(btn);
        }

        function escapeHtml(s){
          return String(s || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        function updateTimezoneDisplay(wrapper, payload){
          const display = wrapper.querySelector('.inline-field-display');
          if (!display) return;
          const companyId = (wrapper.dataset.companyId || '').trim();
          const effectiveTz = (payload && payload.effective_tz) ? String(payload.effective_tz) : '';
          const label = (payload && payload.effective_label) ? String(payload.effective_label) : '';
          const nowHhmm = (payload && payload.effective_now_hhmm) ? String(payload.effective_now_hhmm) : '';

          if (!effectiveTz) {
            display.textContent = '—';
            return;
          }

          display.innerHTML =
            `<span class="badge badge-warn badge-xxxs" data-company-tz-badge="1" data-company-id="${escapeHtml(companyId)}">` +
              `<span data-live-time data-live-tz="${escapeHtml(effectiveTz)}">${escapeHtml(nowHhmm || '--:--')}</span>` +
              ` · ${escapeHtml(label || effectiveTz)}` +
            `</span>`;
        }

        function updateCompanyTimezoneEverywhere(companyId, payload){
          const cid = (companyId || '').toString().trim();
          if (!cid) return;
          const effectiveTz = (payload && payload.effective_tz) ? String(payload.effective_tz) : '';
          const label = (payload && payload.effective_label) ? String(payload.effective_label) : '';
          const nowHhmm = (payload && payload.effective_now_hhmm) ? String(payload.effective_now_hhmm) : '';
          if (!effectiveTz) return;

          // 1) Все "бейджи TZ" в карточке компании
          document.querySelectorAll(`[data-company-tz-badge="1"][data-company-id="${cid}"]`).forEach(el => {
            try{
              el.innerHTML =
                `<span data-live-time data-live-tz="${escapeHtml(effectiveTz)}">${escapeHtml(nowHhmm || '--:--')}</span>` +
                ` · ${escapeHtml(label || effectiveTz)}`;
            }catch(_e){}
          });

          // 2) Все live-time элементы, которые привязаны к компании (рабочее время/статус звонка)
          document.querySelectorAll(`[data-live-worktime="1"][data-company-id="${cid}"] [data-live-time]`).forEach(span => {
            try{
              span.setAttribute('data-live-tz', effectiveTz);
              if (nowHhmm) span.textContent = nowHhmm;
            }catch(_e){}
          });
        }

        // Открыть редактирование
        document.addEventListener('click', function(e) {
          const editBtn = e.target.closest('[data-inline-edit]');
          if (!editBtn) return;
          const wrapper = editBtn.closest('.inline-field-wrapper');
          if (!wrapper) return;
          e.preventDefault();
          openEdit(wrapper);
        });

        // Отмена
        document.addEventListener('click', function(e) {
          const cancelBtn = e.target.closest('[data-inline-cancel]');
          if (!cancelBtn) return;
          const wrapper = cancelBtn.closest('.inline-field-wrapper');
          if (!wrapper) return;
          e.preventDefault();
          closeEdit(wrapper, true);
        });

        // Сохранение
        document.addEventListener('click', function(e) {
          const saveBtn = e.target.closest('[data-inline-save]');
          if (!saveBtn) return;
          const wrapper = saveBtn.closest('.inline-field-wrapper');
          if (!wrapper) return;

          const field = (wrapper.dataset.inlineField || '').trim();
          const companyId = (wrapper.dataset.companyId || '').trim();
          const input = wrapper.querySelector('[data-inline-input]');
          if (!field || !companyId || !input) return;

          const value = (input.value !== undefined ? input.value : (input.textContent || '')).toString();

          const formData = new FormData();
          formData.append('field', field);
          formData.append('value', value);
          formData.append('csrfmiddlewaretoken', csrftoken);

          fetch(`/companies/${companyId}/inline/`, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
          .then(r => r.json().then(data => ({ ok: r.ok, status: r.status, data })))
          .then(({ ok, data }) => {
            if (!ok || !data.ok) {
              const msg = (data && (data.error || (data.errors && data.errors[field] && data.errors[field][0]))) || 'Ошибка сохранения.';
              showError(wrapper, msg);
              return;
            }

            const newVal = (data.value ?? '').toString();
            wrapper.dataset.inlineOriginal = newVal;

            // Обновляем display
            if (wrapper.dataset.inlineDisplayKind === 'website') {
              updateWebsiteDisplay(wrapper, newVal);
            } else if (wrapper.dataset.inlineDisplayKind === 'timezone') {
              updateTimezoneDisplay(wrapper, data);
              updateCompanyTimezoneEverywhere(companyId, data);
            } else {
              const display = wrapper.querySelector('.inline-field-display');
              if (display) {
                const placeholder = '—';
                display.textContent = newVal && newVal.trim() ? newVal : placeholder;
              }
            }

            closeEdit(wrapper, false);
            try {
              if (window.UIWorktime && typeof window.UIWorktime.tick === 'function') {
                window.UIWorktime.tick();
              }
            } catch (_e) {}
          })
          .catch(err => {
            showError(wrapper, 'Ошибка: ' + err.message);
          });
        });

        // Быстрые клавиши: Ctrl/Cmd+Enter сохранить, Esc отмена
        document.addEventListener('keydown', function(e) {
          const input = e.target.closest('[data-inline-input]');
          if (!input) return;
          const wrapper = input.closest('.inline-field-wrapper');
          if (!wrapper) return;

          if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            const saveBtn = wrapper.querySelector('[data-inline-save]');
            if (saveBtn) saveBtn.click();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            const cancelBtn = wrapper.querySelector('[data-inline-cancel]');
            if (cancelBtn) cancelBtn.click();
          }
        });
      })();

      // Добавление email в рассылочную кампанию (модалка)
      (function() {
        const modal = document.getElementById('addEmailToCampaignModal');
        const emailSpan = document.getElementById('addEmailValue');
        const select = document.getElementById('addEmailCampaignSelect');
        const confirmBtn = document.getElementById('addEmailConfirmBtn');
        if (!modal || !emailSpan || !select || !confirmBtn) return;

        let currentEmail = '';
        let currentCompanyId = '';

        function openModal(email, companyId) {
          currentEmail = email;
          currentCompanyId = companyId;
          emailSpan.textContent = email;
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        }

        function closeModal() {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          currentEmail = '';
          currentCompanyId = '';
        }

        async function loadCampaigns() {
          select.innerHTML = '<option value="">Загрузка...</option>';
          const res = await fetch('/mail/campaigns/pick/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || 'Не удалось загрузить кампании');
          const items = data.campaigns || [];
          if (!items.length) {
            select.innerHTML = '<option value="">Нет доступных кампаний</option>';
            return;
          }
          select.innerHTML = items.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        document.addEventListener('click', async (e) => {
          const btn = e.target.closest('.js-add-email-to-campaign');
          if (btn) {
            e.preventDefault();
            const email = btn.dataset.email || '';
            const companyId = btn.dataset.companyId || '';
            if (!email) return;
            openModal(email, companyId);
            try {
              await loadCampaigns();
            } catch (err) {
              alert('Ошибка: ' + err.message);
              closeModal();
            }
            return;
          }
          if (e.target === modal || e.target.closest('.js-close-add-email-modal')) {
            closeModal();
          }
        });

        confirmBtn.addEventListener('click', async () => {
          const campaignId = select.value;
          if (!campaignId) {
            alert('Выберите кампанию');
            return;
          }
          const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
          const fd = new FormData();
          fd.append('campaign_id', campaignId);
          fd.append('email', currentEmail);
          fd.append('company_id', currentCompanyId);
          if (csrf) fd.append('csrfmiddlewaretoken', csrf);

          try {
            const res = await fetch('/mail/campaigns/add-email/', { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await res.json();
            if (!data.ok) {
              alert(data.error || 'Не удалось добавить email');
              return;
            }
            alert(data.message || 'Email добавлен');
            closeModal();
          } catch (err) {
            alert('Ошибка: ' + err.message);
          }
        });
      })();
    })();
  </script>

  <script>
    // Копирование email при клике
    (function() {
      document.querySelectorAll('.js-copy-email').forEach(el => {
        el.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          const email = this.dataset.email || this.textContent.trim();
          if (!email) return;
          
          try {
            await navigator.clipboard.writeText(email);
            if (window.uiToast) {
              window.uiToast('Email скопирован: ' + email, 'success');
            }
          } catch (err) {
            // Fallback для старых браузеров
            const textarea = document.createElement('textarea');
            textarea.value = email;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand('copy');
              if (window.uiToast) {
                window.uiToast('Email скопирован: ' + email, 'success');
              }
            } catch (e) {
              if (window.uiToast) {
                window.uiToast('Не удалось скопировать email', 'error');
              }
            }
            document.body.removeChild(textarea);
          }
        });
      });
    })();
  </script>

  <script>
    // Dropdown меню для телефонов/email + копирование телефона + инлайн-редактирование phone/email
    (function() {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name=csrf-token]')?.content;

      function closeAll() {
        document.querySelectorAll('[data-dd-menu]').forEach(m => m.classList.add('hidden'));
      }

      document.addEventListener('click', function(e) {
        const toggle = e.target.closest('[data-dd-toggle]');
        if (toggle) {
          e.preventDefault();
          e.stopPropagation();
          const root = toggle.closest('[data-dd-root]');
          if (!root) return;
          const menu = root.querySelector('[data-dd-menu]');
          if (!menu) return;
          const isOpen = !menu.classList.contains('hidden');
          closeAll();
          if (!isOpen) menu.classList.remove('hidden');
          return;
        }
        // клик вне меню -> закрываем
        if (!e.target.closest('[data-dd-menu]')) closeAll();
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeAll();
      });

      // Copy phone
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-copy-phone]');
        if (!btn) return;
        e.preventDefault();
        const phone = (btn.getAttribute('data-copy-phone') || '').trim();
        if (!phone) return;
        try {
          await navigator.clipboard.writeText(phone);
          if (window.uiToast) window.uiToast('Телефон скопирован: ' + phone, 'success');
        } catch (_err) {
          const textarea = document.createElement('textarea');
          textarea.value = phone;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            if (window.uiToast) window.uiToast('Телефон скопирован: ' + phone, 'success');
          } catch (e2) {
            if (window.uiToast) window.uiToast('Не удалось скопировать телефон', 'error');
          }
          document.body.removeChild(textarea);
        }
      });

      function showErr(el, msg) {
        if (!el) return;
        el.textContent = (msg || '').trim();
        el.classList.toggle('hidden', !el.textContent);
      }

      // Open edit blocks from menu
      document.addEventListener('click', function(e) {
        const btnMainPhone = e.target.closest('[data-edit-main-phone]');
        if (btnMainPhone) {
          e.preventDefault();
          closeAll();
          const edit = document.querySelector('[data-company-main-phone-edit]');
          const display = document.querySelector('[data-company-main-phone-display]');
          if (edit && display) {
            display.classList.add('hidden');
            edit.classList.remove('hidden');
            edit.querySelector('[data-company-main-phone-input]')?.focus();
          }
          return;
        }
        const btnPhone = e.target.closest('[data-edit-company-phone]');
        if (btnPhone) {
          e.preventDefault();
          closeAll();
          const id = btnPhone.getAttribute('data-edit-company-phone');
          const edit = document.querySelector(`[data-company-phone-edit="${id}"]`);
          const display = document.querySelector(`[data-company-phone-display="${id}"]`);
          if (edit && display) {
            display.classList.add('hidden');
            edit.classList.remove('hidden');
            edit.querySelector('[data-company-phone-input]')?.focus();
          }
          return;
        }
        const btnMainEmail = e.target.closest('[data-edit-main-email]');
        if (btnMainEmail) {
          e.preventDefault();
          closeAll();
          const edit = document.querySelector('[data-company-main-email-edit]');
          const display = document.querySelector('[data-company-main-email-display]');
          if (edit && display) {
            display.classList.add('hidden');
            edit.classList.remove('hidden');
            edit.querySelector('[data-company-main-email-input]')?.focus();
          }
          return;
        }
        const btnEmail = e.target.closest('[data-edit-company-email]');
        if (btnEmail) {
          e.preventDefault();
          closeAll();
          const id = btnEmail.getAttribute('data-edit-company-email');
          const edit = document.querySelector(`[data-company-email-edit="${id}"]`);
          const display = document.querySelector(`[data-company-email-display="${id}"]`);
          if (edit && display) {
            display.classList.add('hidden');
            edit.classList.remove('hidden');
            edit.querySelector('[data-company-email-input]')?.focus();
          }
          return;
        }

        const btnAddCompanyPhone = e.target.closest('[data-add-company-phone]');
        if (btnAddCompanyPhone) {
          e.preventDefault();
          closeAll();
          const box = document.querySelector('[data-company-phone-add]');
          if (box) {
            box.classList.remove('hidden');
            box.querySelector('[data-company-phone-add-input]')?.focus();
          }
          return;
        }
      });

      // Cancel buttons
      document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-company-main-phone-cancel]');
        if (btn) {
          e.preventDefault();
          const edit = document.querySelector('[data-company-main-phone-edit]');
          const display = document.querySelector('[data-company-main-phone-display]');
          edit?.classList.add('hidden');
          display?.classList.remove('hidden');
          showErr(document.querySelector('[data-company-main-phone-error]'), '');
          return;
        }
        const btn2 = e.target.closest('[data-company-phone-cancel]');
        if (btn2) {
          e.preventDefault();
          const id = btn2.getAttribute('data-company-phone-cancel');
          document.querySelector(`[data-company-phone-edit="${id}"]`)?.classList.add('hidden');
          document.querySelector(`[data-company-phone-display="${id}"]`)?.classList.remove('hidden');
          showErr(document.querySelector(`[data-company-phone-error="${id}"]`), '');
          return;
        }
        const b3 = e.target.closest('[data-company-main-email-cancel]');
        if (b3) {
          e.preventDefault();
          document.querySelector('[data-company-main-email-edit]')?.classList.add('hidden');
          document.querySelector('[data-company-main-email-display]')?.classList.remove('hidden');
          showErr(document.querySelector('[data-company-main-email-error]'), '');
          return;
        }
        const b4 = e.target.closest('[data-company-email-cancel]');
        if (b4) {
          e.preventDefault();
          const id = b4.getAttribute('data-company-email-cancel');
          document.querySelector(`[data-company-email-edit="${id}"]`)?.classList.add('hidden');
          document.querySelector(`[data-company-email-display="${id}"]`)?.classList.remove('hidden');
          showErr(document.querySelector(`[data-company-email-error="${id}"]`), '');
          return;
        }

        const addCancel = e.target.closest('[data-company-phone-add-cancel]');
        if (addCancel) {
          e.preventDefault();
          const box = document.querySelector('[data-company-phone-add]');
          box?.classList.add('hidden');
          showErr(document.querySelector('[data-company-phone-add-error]'), '');
          return;
        }
      });

      async function postForm(url, data) {
        const fd = new FormData();
        for (const [k, v] of Object.entries(data)) fd.append(k, v);
        if (csrftoken) fd.append('csrfmiddlewaretoken', csrftoken);
        const res = await fetch(url, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const json = await res.json().catch(() => ({}));
        return { ok: res.ok, data: json };
      }

      // Save: main phone
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-main-phone-save]');
        if (!btn) return;
        e.preventDefault();
        const input = document.querySelector('[data-company-main-phone-input]');
        const err = document.querySelector('[data-company-main-phone-error]');
        const display = document.querySelector('[data-company-main-phone-display]');
        if (!input || !display) return;
        const val = (input.value || '').trim();
        const companyId = '{{ company.id }}';
        const { ok, data } = await postForm(`/companies/${companyId}/main-phone/update/`, { phone: val });
        if (!ok || !data.success) {
          showErr(err, data.error || 'Ошибка сохранения телефона.');
          return;
        }
        display.textContent = data.display || '—';
        const local = document.querySelector('[data-company-main-phone-local]');
        if (local && data.local_info !== undefined) {
          // local может быть контейнером с badge внутри
          const badge = local.querySelector('.badge');
          if (badge) {
            badge.textContent = data.local_info || '';
          } else {
            local.textContent = data.local_info || '';
          }
          local.classList.toggle('hidden', !(data.local_info || '').trim());
        }
        document.querySelector('[data-company-main-phone-edit]')?.classList.add('hidden');
        display.classList.remove('hidden');
        showErr(err, '');
      });

      // Save: company phone
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-phone-save]');
        if (!btn) return;
        e.preventDefault();
        const id = btn.getAttribute('data-company-phone-save');
        const input = document.querySelector(`[data-company-phone-edit="${id}"] [data-company-phone-input]`);
        const err = document.querySelector(`[data-company-phone-error="${id}"]`);
        const display = document.querySelector(`[data-company-phone-display="${id}"]`);
        if (!input || !display) return;
        const val = (input.value || '').trim();
        const { ok, data } = await postForm(`/company-phones/${id}/update/`, { phone: val });
        if (!ok || !data.success) {
          showErr(err, data.error || 'Ошибка сохранения телефона.');
          return;
        }
        display.textContent = data.display || '—';
        const local = document.querySelector(`[data-company-phone-local="${id}"]`);
        if (local && data.local_info !== undefined) {
          const badge = local.querySelector('.badge');
          if (badge) {
            badge.textContent = data.local_info || '';
          } else {
            local.textContent = data.local_info || '';
          }
          local.classList.toggle('hidden', !(data.local_info || '').trim());
        }
        document.querySelector(`[data-company-phone-edit="${id}"]`)?.classList.add('hidden');
        display.classList.remove('hidden');
        showErr(err, '');
      });

      function extractPhonesForAdd(text) {
        const src = String(text || '');
        const re = /(\+?\d[\d()\s\-]{8,}\d)/g;
        const matches = [];
        let m;
        while ((m = re.exec(src)) !== null) matches.push(m[1]);
        const candidates = matches.length ? matches : src.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean);
        return candidates.map(s => (s || '').trim()).filter(Boolean);
      }

      function renderCompanyPhoneItem(phoneId, rawPhone, displayText) {
        const companyId = '{{ company.id }}';
        return `
          <div>
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="font-mono text-xs" data-company-phone-display="${phoneId}">${displayText || '—'}</div>
                <div class="text-[11px] muted-2 mt-0.5 ${rawPhone ? '' : 'hidden'}" data-company-phone-local="${phoneId}"></div>
                <div class="hidden mt-1" data-company-phone-edit="${phoneId}">
                  <input class="input text-xs" data-company-phone-input value="${rawPhone || ''}" placeholder="+7..." style="padding:.35rem .5rem;font-size:.75rem;min-height:2.25rem;width:240px" />
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-company-phone-save="${phoneId}">Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-company-phone-cancel="${phoneId}">Отмена</button>
                  </div>
                  <div class="text-xs text-red-600 mt-1 hidden" data-company-phone-error="${phoneId}"></div>
                </div>
              </div>
              <div class="relative shrink-0" data-dd-root>
                <button type="button" class="btn btn-outline btn-xs" data-dd-toggle title="Действия" aria-label="Действия">⋯</button>
                <div class="hidden absolute right-0 mt-2 w-56 card overflow-hidden" style="z-index: 60;" data-dd-menu>
                  <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25 js-call-phone" data-phone="${rawPhone || ''}" data-company="${companyId}" data-contact="">Позвонить</button>
                  <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-copy-phone="${rawPhone || ''}">Скопировать</button>
                  <button type="button" class="block w-full text-left px-3 py-2 text-sm hover:bg-brand-soft/25" data-edit-company-phone="${phoneId}">Изменить</button>
                </div>
              </div>
            </div>
            <div class="mt-1">
              <div class="phone-comment-wrapper" data-phone-type="company" data-phone-id="${phoneId}">
                <div class="phone-comment-display text-xs text-brand-dark/50 cursor-pointer hover:text-brand-dark/70 transition-colors" data-edit-comment style="white-space: pre-wrap;">Комментарий</div>
                <div class="phone-comment-edit hidden mt-1">
                  <textarea class="input text-xs" placeholder="Комментарий к номеру" maxlength="255" data-comment-input rows="2" style="padding:.35rem .5rem;font-size:.75rem;min-height:3.25rem;resize:vertical"></textarea>
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-primary btn-sm" data-save-comment>Сохранить</button>
                    <button type="button" class="btn btn-outline btn-sm" data-cancel-comment>Отмена</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Save: add company phone(s)
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-phone-add-save]');
        if (!btn) return;
        e.preventDefault();
        const companyId = '{{ company.id }}';
        const input = document.querySelector('[data-company-phone-add-input]');
        const err = document.querySelector('[data-company-phone-add-error]');
        const list = document.querySelector('[data-company-phones-list]');
        if (!input || !list) return;
        const raw = (input.value || '').trim();
        const items = extractPhonesForAdd(raw);
        if (!items.length) {
          showErr(err, 'Введите телефон.');
          return;
        }
        showErr(err, '');

        for (const phoneRaw of items) {
          const { ok, data } = await postForm(`/companies/${companyId}/phones/create/`, { phone: phoneRaw });
          if (!ok || !data.success) {
            showErr(err, data.error || 'Ошибка добавления телефона.');
            return;
          }
          // Убираем "—" если он был в пустом списке
          const emptyMark = list.querySelector('.muted-2');
          if (emptyMark && emptyMark.textContent.trim() === '—') emptyMark.remove();
          const wrapper = document.createElement('div');
          wrapper.innerHTML = renderCompanyPhoneItem(data.id, data.phone, data.display);
          // Добавляем как отдельный элемент списка (вверх)
          list.prepend(wrapper.firstElementChild);
          // Заполняем local_info если пришёл
          if (data.local_info) {
            const el = list.querySelector(`[data-company-phone-local="${data.id}"]`);
            if (el) {
              el.textContent = data.local_info;
              el.classList.remove('hidden');
            }
          }
        }

        input.value = '';
        document.querySelector('[data-company-phone-add]')?.classList.add('hidden');
      });

      // Bulk paste into add phone input
      document.addEventListener('paste', function(e) {
        const t = e.target;
        if (!t || !t.closest || !t.closest('[data-company-phone-add]')) return;
        if (!t.matches('[data-company-phone-add-input]')) return;
        const txt = (e.clipboardData || window.clipboardData).getData('text');
        const items = extractPhonesForAdd(txt);
        if (items.length <= 1) return;
        e.preventDefault();
        t.value = items.join('\n');
      });

      // Save: main email
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-main-email-save]');
        if (!btn) return;
        e.preventDefault();
        const input = document.querySelector('[data-company-main-email-input]');
        const err = document.querySelector('[data-company-main-email-error]');
        const display = document.querySelector('[data-company-main-email-display]');
        if (!input || !display) return;
        const val = (input.value || '').trim();
        const companyId = '{{ company.id }}';
        const { ok, data } = await postForm(`/companies/${companyId}/main-email/update/`, { email: val });
        if (!ok || !data.success) {
          showErr(err, data.error || 'Ошибка сохранения email.');
          return;
        }
        display.textContent = data.email || '';
        document.querySelector('[data-company-main-email-edit]')?.classList.add('hidden');
        display.classList.remove('hidden');
        showErr(err, '');
      });

      // Save: company email
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-company-email-save]');
        if (!btn) return;
        e.preventDefault();
        const id = btn.getAttribute('data-company-email-save');
        const input = document.querySelector(`[data-company-email-edit="${id}"] [data-company-email-input]`);
        const err = document.querySelector(`[data-company-email-error="${id}"]`);
        const display = document.querySelector(`[data-company-email-display="${id}"]`);
        if (!input || !display) return;
        const val = (input.value || '').trim();
        const { ok, data } = await postForm(`/company-emails/${id}/update/`, { email: val });
        if (!ok || !data.success) {
          showErr(err, data.error || 'Ошибка сохранения email.');
          return;
        }
        display.textContent = data.email || '';
        document.querySelector(`[data-company-email-edit="${id}"]`)?.classList.add('hidden');
        display.classList.remove('hidden');
        showErr(err, '');
      });
    })();
  </script>

  <script>
    // Открытие модалки задачи из карточки компании
    (function() {
      const modal = document.getElementById('taskViewModal');
      if (!modal) {
        // Создаем модалку, если её нет (как на dashboard)
        const modalHtml = `
          <div id="taskViewModal" class="fixed inset-0 z-[200] hidden">
            <div class="fixed inset-0 bg-black/35" data-close-task-view></div>
            <div class="absolute inset-x-4 top-12 mx-auto max-w-2xl max-h-[90vh] overflow-y-auto">
              <div class="card card-pad">
                <div class="flex items-start justify-between gap-3 mb-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2" id="taskViewBadges"></div>
                    <h2 class="text-xl font-semibold text-brand-dark" id="taskViewTitle">Загрузка...</h2>
                  </div>
                  <button type="button" class="btn btn-outline btn-sm flex-shrink-0" data-close-task-view aria-label="Закрыть" title="Закрыть">✕</button>
                </div>
                <div id="taskViewContent">
                  <div class="text-center py-8">
                    <svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 12a9 9 0 11-6.219-8.56"/>
                    </svg>
                    <div class="text-sm text-brand-dark/70">Загрузка задачи...</div>
                  </div>
                </div>
                <div class="flex flex-wrap items-center gap-2 pt-4 mt-4 border-t" id="taskViewActions" style="display:none">
                  <button type="button" class="btn btn-outline btn-sm" id="taskViewEdit" style="display:none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                    </svg>
                    Редактировать
                  </button>
                  <form method="post" action="" id="taskViewInProgressForm" style="display:none" class="inline">
                    {% csrf_token %}
                    <button type="submit" name="status" value="in_progress" class="btn btn-secondary text-sm">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
                        <path d="M8 2v4"/><path d="M16 2v4"/><path d="M8 10h8"/><path d="M8 14h8"/>
                      </svg>
                      В работу
                    </button>
                  </form>
                  <button type="button" class="btn btn-primary btn-sm" id="taskViewComplete" style="display:none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Выполнено
                  </button>
                  <button type="button" class="btn btn-outline btn-sm btn-danger" id="taskViewDelete" style="display:none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M6 7h12M10 11v6M14 11v6M9 7l1-3h4l1 3M19 7l-1 12H6L5 7"/>
                    </svg>
                    Удалить
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      const modalContent = document.getElementById('taskViewContent');
      const modalTitle = document.getElementById('taskViewTitle');
      const modalBadges = document.getElementById('taskViewBadges');
      const modalActions = document.getElementById('taskViewActions');
      const btnEdit = document.getElementById('taskViewEdit');
      const btnInProgress = document.getElementById('taskViewInProgressForm');
      const btnComplete = document.getElementById('taskViewComplete');
      const btnDelete = document.getElementById('taskViewDelete');
      
      function closeModal() {
        if (modal) modal.classList.add('hidden');
        if (modalContent) modalContent.innerHTML = '<div class="text-center py-8"><svg class="animate-spin w-6 h-6 text-brand-teal mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg><div class="text-sm text-brand-dark/70">Загрузка задачи...</div></div>';
        if (modalTitle) modalTitle.textContent = 'Загрузка...';
        if (modalBadges) modalBadges.innerHTML = '';
        if (modalActions) modalActions.style.display = 'none';
      }
      
      function openModal() {
        if (modal) modal.classList.remove('hidden');
      }
      
      // Закрытие модалки
      if (modal) {
        modal.querySelectorAll('[data-close-task-view]').forEach(btn => {
          btn.addEventListener('click', closeModal);
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
        });
        modal.querySelector('.bg-black\\/35')?.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) closeModal();
        });
      }
      
      // Открытие задачи в модальном окне
      document.querySelectorAll('[data-view-task]').forEach(btn => {
        btn.addEventListener('click', async function(e) {
          e.stopPropagation();
          const taskId = this.dataset.taskId;
          if (!taskId) return;
          
          openModal();
          
          try {
            const res = await fetch(`/tasks/${taskId}/`, {
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!res.ok) throw new Error('Ошибка загрузки задачи');
            const html = await res.text();
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const taskModal = doc.querySelector('#taskViewModal');
            
            if (taskModal) {
              const card = taskModal.querySelector('.card');
              if (card) {
                const contentDiv = card.querySelector('.space-y-3');
                if (contentDiv) {
                  if (modalContent) modalContent.innerHTML = contentDiv.outerHTML;
                } else {
                  const allContent = card.innerHTML;
                  const titleMatch = allContent.match(/<h2[^>]*>.*?<\/h2>/);
                  if (modalContent) modalContent.innerHTML = allContent.replace(titleMatch?.[0] || '', '');
                }
                
                const titleEl = taskModal.querySelector('h2');
                if (titleEl && modalTitle) modalTitle.textContent = titleEl.textContent.trim();
                
                const badgeContainer = taskModal.querySelector('.flex.items-center.gap-2');
                if (badgeContainer && modalBadges) {
                  const badge = badgeContainer.querySelector('.badge, .inline-flex.items-center.gap-1');
                  if (badge) modalBadges.innerHTML = badge.outerHTML;
                }
                
                const editLink = taskModal.querySelector('a[href*="/tasks/"][href*="/edit/"]');
                const editButton = taskModal.querySelector('button[data-edit-task]');
                const canEdit = editLink || editButton;
                
                const statusBadge = taskModal.querySelector('.badge');
                let status = 'new';
                if (statusBadge) {
                  const badgeText = statusBadge.textContent.toLowerCase();
                  if (badgeText.includes('работа') || badgeText.includes('progress')) status = 'in_progress';
                  else if (badgeText.includes('выполн') || badgeText.includes('done')) status = 'done';
                  else if (badgeText.includes('отмен') || badgeText.includes('cancel')) status = 'cancelled';
                }
                
                if (modalActions) {
                  modalActions.style.display = 'flex';
                  
                  if (btnEdit) {
                    btnEdit.style.display = canEdit ? 'inline-flex' : 'none';
                    if (canEdit) {
                      btnEdit.onclick = async () => {
                        const url = `/tasks/${taskId}/edit/?modal=1`;
                        try {
                          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                          if (!res.ok) throw new Error('Ошибка загрузки формы');
                          const html = await res.text();
                          const editModal = document.getElementById('taskEditModal');
                          const editModalContent = document.getElementById('taskEditModalContent');
                          if (editModal && editModalContent) {
                            editModalContent.innerHTML = html;
                            editModal.classList.remove('hidden');
                            if (modal) modal.classList.add('hidden');
                            if (window.initTaskTypeSelects) window.initTaskTypeSelects();
                            if (window.initMsSingleWidgets) window.initMsSingleWidgets(editModalContent);
                          }
                        } catch (err) {
                          console.error('Error loading edit form:', err);
                          if (window.uiToast) window.uiToast('Ошибка загрузки формы редактирования', 'error');
                        }
                      };
                    }
                  }
                  
                  if (btnInProgress) {
                    btnInProgress.style.display = (status === 'new' && canEdit) ? 'inline-block' : 'none';
                    if (status === 'new' && canEdit) {
                      btnInProgress.action = `/tasks/${taskId}/status/`;
                    }
                  }
                  
                  if (btnComplete) {
                    btnComplete.style.display = (status !== 'done' && status !== 'cancelled' && canEdit) ? 'inline-flex' : 'none';
                    if (status !== 'done' && status !== 'cancelled' && canEdit) {
                      btnComplete.onclick = () => {
                        const completeModal = document.getElementById('taskCompleteModal');
                        if (completeModal) {
                          completeModal.classList.remove('hidden');
                          if (modal) modal.classList.add('hidden');
                          const form = completeModal.querySelector('form');
                          if (form) form.action = `/tasks/${taskId}/status/`;
                        }
                      };
                    }
                  }
                  
                  if (btnDelete) {
                    btnDelete.style.display = canEdit ? 'inline-flex' : 'none';
                    if (canEdit) {
                      btnDelete.onclick = () => {
                        const deleteModal = document.getElementById('taskDeleteModal');
                        if (deleteModal) {
                          deleteModal.classList.remove('hidden');
                          if (modal) modal.classList.add('hidden');
                          const form = deleteModal.querySelector('form');
                          if (form) form.action = `/tasks/${taskId}/delete/`;
                        }
                      };
                    }
                  }
                }
              }
            }
          } catch (error) {
            console.error('Error loading task:', error);
            if (modalContent) modalContent.innerHTML = '<div class="text-center py-8 text-red-600">Ошибка загрузки задачи</div>';
            if (window.uiToast) window.uiToast('Ошибка загрузки задачи', 'error');
          }
        });
      });
    })();
  </script>
  <script>
    // Немодальная панель контакта: открывается поверх, но НЕ блокирует фон (можно копировать данные из карточки)
    (function() {
      const panel = document.getElementById('contactPanel');
      const body = document.getElementById('contactPanelBody');
      if (!panel || !body) return;

      let currentAbort = null;
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };

      function openPanel() {
        panel.classList.remove('hidden');
      }
      function closePanel() {
        panel.classList.add('hidden');
        body.innerHTML = '';
        if (currentAbort) {
          try { currentAbort.abort(); } catch (_e) {}
          currentAbort = null;
        }
      }

      // Drag & Drop для панели
      const panelHeader = panel.querySelector('.bg-white');
      if (panelHeader) {
        panelHeader.style.cursor = 'move';
        panelHeader.addEventListener('mousedown', (e) => {
          if (e.target.closest('button, input, select, textarea, a')) return;
          isDragging = true;
          const rect = panel.getBoundingClientRect();
          dragOffset.x = e.clientX - rect.left;
          dragOffset.y = e.clientY - rect.top;
          panel.style.cursor = 'move';
          e.preventDefault();
        });
      }

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const maxX = window.innerWidth - panel.offsetWidth;
        const maxY = window.innerHeight - panel.offsetHeight;
        let x = e.clientX - dragOffset.x;
        let y = e.clientY - dragOffset.y;
        x = Math.max(0, Math.min(x, maxX));
        y = Math.max(0, Math.min(y, maxY));
        panel.style.left = x + 'px';
        panel.style.right = 'auto';
        panel.style.top = y + 'px';
        panel.style.bottom = 'auto';
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          panel.style.cursor = '';
        }
      });

      async function loadForm(url) {
        currentAbort = new AbortController();
        const res = await fetch(url, { signal: currentAbort.signal, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (!res.ok) throw new Error('Ошибка загрузки формы');
        const html = await res.text();
        body.innerHTML = html;
        openPanel();
      }

      async function submitForm(form) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.textContent : '';
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Сохранение...';
        }
        
        try {
          const fd = new FormData(form);
          // Убеждаемся, что modal=1 всегда в форме
          if (!fd.has('modal')) {
            fd.append('modal', '1');
          }
          
          const res = await fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: fd
          });
          
          const ct = (res.headers.get('content-type') || '').toLowerCase();
          
          // Пробуем сначала как JSON
          if (ct.includes('application/json')) {
            const data = await res.json();
            if (data.ok) {
              // Успешно сохранено: закрываем панель и обновляем страницу
              closePanel();
              window.location.reload();
              return;
            }
            if (data.html) {
              body.innerHTML = data.html;
              return;
            }
            throw new Error(data.error || 'Ошибка сохранения');
          }
          
          // Если вернули HTML (не должно быть, но на всякий случай)
          const html = await res.text();
          // Проверяем, не редирект ли это
          if (res.redirected || res.status === 302 || html.includes('window.location') || html.includes('location.href')) {
            // Это редирект - просто обновляем страницу
            closePanel();
            window.location.reload();
            return;
          }
          
          // Иначе показываем HTML в панели (ошибка валидации)
          body.innerHTML = html;
          
        } catch (error) {
          console.error('Ошибка при сохранении контакта:', error);
          if (window.uiToast) {
            window.uiToast('Ошибка сохранения: ' + error.message, 'error');
          } else {
            alert('Ошибка сохранения: ' + error.message);
          }
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }
      }

      // Открытие панели по кнопке
      document.addEventListener('click', (e) => {
        const a = e.target.closest('[data-contact-panel-open]');
        if (a) {
          e.preventDefault();
          const url = a.getAttribute('href');
          if (!url) return;
          loadForm(url).catch(() => {
            if (window.uiToast) window.uiToast('Ошибка загрузки', 'error');
          });
          return;
        }
        if (e.target.closest('[data-contact-panel-close]')) {
          e.preventDefault();
          closePanel();
          return;
        }
      });

      // Submit внутри панели
      panel.addEventListener('submit', (e) => {
        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;
        if (!form.matches('[data-contact-panel-form]')) return;
        e.preventDefault();
        submitForm(form).catch(() => {
          if (window.uiToast) window.uiToast('Ошибка сохранения', 'error');
        });
      });
    })();
  </script>
{% endblock %}


