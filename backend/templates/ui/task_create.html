{% extends "ui/base.html" %}
{% block title %}Новая задача — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/tasks/">Задачи</a> /</div>
      <h1 class="text-2xl font-semibold">Новая задача</h1>
    </div>

    <form method="post" class="bg-white border rounded-2xl p-4 space-y-3">
      {% csrf_token %}

      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Задача</label>
        {{ form.type }}
        {% if form.type.errors %}
          <div class="text-xs text-red-600 mt-1" data-task-type-error>
            {{ form.type.errors|striptags }}
          </div>
        {% else %}
          <div class="text-xs text-red-600 mt-1 hidden" data-task-type-error></div>
        {% endif %}
      </div>

      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Описание</label>
        {{ form.description }}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Компания</label>
          <div class="space-y-1">
            <input
              type="text"
              id="task-company-search"
              placeholder="Начните вводить название компании…"
              class="w-full rounded-lg border px-3 py-2 text-sm"
              autocomplete="off"
            >
            {{ form.company }}
          </div>
        </div>
      </div>

      <div id="applyToOrgBranchesBox" class="rounded-xl border border-brand-soft bg-brand-soft/15 px-4 py-3 hidden">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          {{ form.apply_to_org_branches }}
          <span>Поставить задачу на <b>всю организацию (головная + филиалы)</b></span>
        </label>
        <div class="text-xs muted-2 mt-1">Полезно, если у клиента несколько филиалов и задача должна быть видна в каждой карточке.</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Кому</label>
          {{ form.assigned_to }}
          <div class="text-xs text-brand-dark/70 mt-1">Менеджер может назначать только себе.</div>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Дедлайн</label>
          {{ form.due_at }}
        </div>
      </div>

      <div>
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          {{ form.is_urgent }}
          <span>Срочная задача</span>
        </label>
        <div class="text-xs text-brand-dark/70 mt-1">Отметка "СРОЧНО" будет отображаться в уведомлениях и списках задач.</div>
      </div>

      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Повтор (RRULE)</label>
        {{ form.recurrence_rrule }}
        <div class="text-xs text-brand-dark/70 mt-1">Можно оставить пустым. Пример: <span class="font-mono">FREQ=WEEKLY;BYDAY=MO</span></div>
      </div>

      {% if form.errors %}
        <div class="rounded-lg border border-brand-orange/60 bg-brand-orange/20 p-3 text-sm text-brand-dark">
          Проверь поля формы.
        </div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">Создать</button>
        <a class="btn btn-outline" href="/tasks/">Отмена</a>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Защита от повторной отправки формы создания задачи (полная страница)
      const taskFormEl = document.querySelector('form[action="/tasks/create/"]') || document.querySelector('form[method="post"]');
      if (taskFormEl) {
        taskFormEl.addEventListener('submit', function(e) {
          const submitBtn = taskFormEl.querySelector('button[type="submit"]');
          if (!submitBtn) {
            return;
          }

          // Если уже отправляем форму — блокируем повторный submit
          if (submitBtn.disabled) {
            e.preventDefault();
            return;
          }

          const originalText = submitBtn.dataset.originalText || submitBtn.textContent || '';
          submitBtn.dataset.originalText = originalText;
          submitBtn.disabled = true;
          submitBtn.textContent = 'Создание...';
        });
      }

      const searchInput = document.getElementById('task-company-search');
      const companySelect = document.getElementById('id_company');
      const applyBox = document.getElementById('applyToOrgBranchesBox');
      const applyCheckbox = document.getElementById('id_apply_to_org_branches');
      if (!searchInput || !companySelect) return;

      const updateApplyToOrgVisibility = () => {
        if (!applyBox || !applyCheckbox) return;
        const opt = companySelect.options[companySelect.selectedIndex] || null;
        const isBranch = opt && opt.dataset && opt.dataset.isBranch === '1';
        const hasBranches = opt && opt.dataset && opt.dataset.hasBranches === '1';

        // Если чекбокс уже предустановлен на сервере (initial=True),
        // уважаем это и показываем блок даже при отсутствии флагов на option.
        const isPrechecked = applyCheckbox.checked;
        const show = Boolean(isBranch || hasBranches || isPrechecked);
        if (show) {
          applyBox.classList.remove('hidden');
        } else {
          applyBox.classList.add('hidden');
          applyCheckbox.checked = false;
        }
      };

      let searchTimeout = null;
      let currentAbortController = null;

      searchInput.addEventListener('input', () => {
        const q = searchInput.value.trim();
        
        // Отменяем предыдущий запрос
        if (currentAbortController) {
          currentAbortController.abort();
        }
        
        // Если запрос < 2 символов, ищем по существующим опциям
        if (!q || q.length < 2) {
          // Обычный поиск по существующим опциям
          let firstMatch = null;
          for (const opt of companySelect.options) {
            if (!opt.value) continue;
            const text = (opt.text || '').toLowerCase();
            if (text.includes(q.toLowerCase())) {
              firstMatch = opt;
              break;
            }
          }
          if (firstMatch) {
            companySelect.value = firstMatch.value;
          }
          return;
        }
        
        // AJAX поиск для запросов >= 2 символов
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        searchTimeout = setTimeout(() => {
          currentAbortController = new AbortController();
          
          fetch(`/companies/autocomplete/?q=${encodeURIComponent(q)}`, {
            signal: currentAbortController.signal,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
          .then(res => res.json())
          .then(data => {
            if (data.items && data.items.length > 0) {
              // Временно сохраняем текущее значение
              const currentValue = companySelect.value;
              
              // Очищаем опции (кроме пустой)
              const emptyOpt = companySelect.querySelector('option[value=""]');
              companySelect.innerHTML = '';
              if (emptyOpt) {
                companySelect.appendChild(emptyOpt);
              }
              
              // Добавляем найденные компании
              data.items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.name;
                if (item.inn) opt.textContent += ` (ИНН: ${item.inn})`;
                if (item.is_branch) {
                  opt.dataset.isBranch = '1';
                }
                if (item.has_branches) {
                  opt.dataset.hasBranches = '1';
                }
                companySelect.appendChild(opt);
              });
              
              // Восстанавливаем текущее значение, если оно было
              if (currentValue) {
                companySelect.value = currentValue;
              }
              
              // Автоматически выбираем первую найденную компанию
              if (companySelect.options.length > 1) {
                companySelect.value = companySelect.options[1].value;
              }

              updateApplyToOrgVisibility();
            }
          })
          .catch(err => {
            if (err.name !== 'AbortError') {
              console.error('Ошибка поиска компаний:', err);
            }
          });
        }, 300); // Debounce 300ms
      });
    });
  </script>
{% endblock %}


