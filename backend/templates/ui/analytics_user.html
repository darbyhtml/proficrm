{% extends "ui/base.html" %}
{% load ui_extras %}
{% block title %}Аналитика — {{ target }}{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="text-sm text-brand-dark/70">
      <a class="underline" href="/analytics/">Аналитика</a> /
      <span>{{ target }}</span>
    </div>

    <div class="flex items-end justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold">{{ target }}</h1>
        <div class="text-sm text-brand-dark/70">
          {% if target.branch %}Филиал: {{ target.branch.name }} · {% endif %}
          Период: <b>{% if period == "month" %}Месяц{% else %}День{% endif %}</b> · {{ period_label }}
        </div>
      </div>
      <div class="flex gap-2">
        <a class="btn btn-outline" href="/analytics/users/{{ target.id }}/?period=day">День</a>
        <a class="btn btn-outline" href="/analytics/users/{{ target.id }}/?period=month">Месяц</a>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="card card-pad">
        <div class="text-xs muted-2">Всего звонков</div>
        <div class="text-2xl font-semibold mt-1">{{ calls_count }}</div>
      </div>
      <div class="card card-pad">
        <div class="text-xs muted-2">Холодных (подтв., по кнопке)</div>
        <div class="text-2xl font-semibold mt-1">{{ cold_calls_count }}</div>
      </div>
    </div>
    
    {% if calls_count > 0 %}
      <div class="card card-pad bg-brand-soft/10 border-brand-soft/30">
        <div class="flex items-start gap-2">
          <span class="text-lg">ℹ️</span>
          <div>
            <div class="text-xs font-medium muted-2 mb-1">Информация о звонках</div>
            <div class="text-sm">
              Данные о статусе, времени начала и длительности звонков собираются автоматически из Android приложения.
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <section class="card card-pad">
      <div class="flex items-end justify-between gap-3">
        <div>
          <div class="font-medium">Холодные звонки</div>
          <div class="text-xs muted-2 mt-1">Только: “Позвонить с телефона” → в течение 8 часов подтверждено отметкой “холодный”.</div>
        </div>
        <div class="text-sm text-brand-dark/70">Всего: <b>{{ cold_calls_count }}</b></div>
      </div>
      <div class="mt-3 space-y-3 text-sm">
        {% for call in cold_page %}
          <div class="rounded-lg border p-4 hover:bg-brand-soft/10 transition">
            <div class="flex flex-wrap items-center gap-2 mb-3">
              <span class="font-mono text-xs text-brand-dark/70">{{ call.created_at|date:"d.m.Y H:i:s" }}</span>
              <span class="font-mono text-sm font-medium">{{ call.phone_raw|format_phone }}</span>
              <span class="badge badge-warn" style="padding:.2rem .5rem;font-size:.7rem">Холодный</span>
              {% if call.contact %}
                <span class="muted-2">· {{ call.contact }}</span>
              {% endif %}
              {% if call.company %}
                <a class="link font-medium" href="/companies/{{ call.company.id }}/">({{ call.company.name }})</a>
              {% endif %}
            </div>
            {% if call.call_status or call.call_started_at or call.call_duration_seconds %}
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3 pt-3 border-t border-brand-soft/50">
                {% if call.call_status %}
                  <div class="flex items-center gap-2">
                    <span class="text-xs muted-2">Статус:</span>
                    <span class="font-medium {% if call.call_status == 'connected' %}text-green-600{% elif call.call_status == 'no_answer' %}text-orange-600{% elif call.call_status == 'busy' %}text-yellow-600{% elif call.call_status == 'rejected' %}text-red-600{% else %}text-brand-dark{% endif %}">
                      {{ call.get_call_status_display }}
                    </span>
                  </div>
                {% endif %}
                {% if call.call_started_at %}
                  <div class="flex items-center gap-2">
                    <span class="text-xs muted-2">Начало:</span>
                    <span class="font-mono text-xs">{{ call.call_started_at|date:"d.m.Y H:i:s" }}</span>
                  </div>
                {% endif %}
                {% if call.duration_formatted %}
                  <div class="flex items-center gap-2">
                    <span class="text-xs muted-2">Длительность:</span>
                    <span class="font-medium">{{ call.duration_formatted }}</span>
                  </div>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% empty %}
          <div class="muted-2 text-center py-4">Нет холодных звонков за период.</div>
        {% endfor %}
      </div>
      <div class="border-t px-4 py-3 flex items-center justify-between gap-4 flex-wrap mt-3">
        <div class="flex items-center gap-2">
          <form method="get" class="flex items-center gap-2" id="perPageFormCold">
            <label class="text-sm text-brand-dark/70 whitespace-nowrap">На странице:</label>
            <select name="per_page" class="select" onchange="document.getElementById('perPageFormCold').submit()" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
              <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
            </select>
            <input type="hidden" name="period" value="{{ period }}" />
          </form>
        </div>
        <div>
          {% include "ui/_pagination.html" with page=cold_page qs=cold_qs page_param="cold_page" %}
        </div>
      </div>
    </section>

    <section class="card card-pad">
      <div class="flex items-end justify-between gap-3">
        <div>
          <div class="font-medium">Звонки</div>
          <div class="text-xs muted-2 mt-1">Все звонки за период (и тёплые, и холодные), инициированные кнопкой “Позвонить с телефона”.</div>
        </div>
        <div class="text-sm text-brand-dark/70">Всего: <b>{{ calls_count }}</b></div>
      </div>
      <div class="mt-3 space-y-3 text-sm">
        {% for call in calls_page %}
          <div class="rounded-lg border p-4 hover:bg-brand-soft/10 transition">
            <div class="flex flex-wrap items-center gap-2 mb-3">
              <span class="font-mono text-xs text-brand-dark/70">{{ call.created_at|date:"d.m.Y H:i:s" }}</span>
              <span class="font-mono text-sm font-medium">{{ call.phone_raw|format_phone }}</span>
              {% if call.is_cold_call %}
                <span class="badge badge-warn" style="padding:.2rem .5rem;font-size:.7rem">Холодный</span>
              {% else %}
                <span class="badge" style="padding:.2rem .5rem;font-size:.7rem">Тёплый</span>
              {% endif %}
              {% if call.contact %}
                <span class="muted-2">· {{ call.contact }}</span>
              {% endif %}
              {% if call.company %}
                <a class="link font-medium" href="/companies/{{ call.company.id }}/">({{ call.company.name }})</a>
              {% endif %}
            </div>
            {% if call.call_status or call.call_started_at or call.call_duration_seconds %}
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3 pt-3 border-t border-brand-soft/50">
                {% if call.call_status %}
                  <div class="flex items-center gap-2">
                    <span class="text-xs muted-2">Статус:</span>
                    <span class="font-medium {% if call.call_status == 'connected' %}text-green-600{% elif call.call_status == 'no_answer' %}text-orange-600{% elif call.call_status == 'busy' %}text-yellow-600{% elif call.call_status == 'rejected' %}text-red-600{% else %}text-brand-dark{% endif %}">
                      {{ call.get_call_status_display }}
                    </span>
                  </div>
                {% endif %}
                {% if call.call_started_at %}
                  <div class="flex items-center gap-2">
                    <span class="text-xs muted-2">Начало:</span>
                    <span class="font-mono text-xs">{{ call.call_started_at|date:"d.m.Y H:i:s" }}</span>
                  </div>
                {% endif %}
                {% if call.duration_formatted %}
                  <div class="flex items-center gap-2">
                    <span class="text-xs muted-2">Длительность:</span>
                    <span class="font-medium">{{ call.duration_formatted }}</span>
                  </div>
                {% endif %}
              </div>
            {% else %}
              <div class="text-xs muted-2 mt-2 italic">Данные о звонке не получены</div>
            {% endif %}
          </div>
        {% empty %}
          <div class="muted-2 text-center py-4">Нет звонков за период.</div>
        {% endfor %}
      </div>
      <div class="border-t px-4 py-3 flex items-center justify-between gap-4 flex-wrap mt-3">
        <div class="flex items-center gap-2">
          <form method="get" class="flex items-center gap-2" id="perPageFormCalls">
            <label class="text-sm text-brand-dark/70 whitespace-nowrap">На странице:</label>
            <select name="per_page" class="select" onchange="document.getElementById('perPageFormCalls').submit()" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
              <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
            </select>
            <input type="hidden" name="period" value="{{ period }}" />
            {% if calls_qs %}{% for key, value in calls_qs.items %}{% if key != 'per_page' and key != 'calls_page' %}<input type="hidden" name="{{ key }}" value="{{ value }}" />{% endif %}{% endfor %}{% endif %}
          </form>
        </div>
        <div>
          {% include "ui/_pagination.html" with page=calls_page qs=calls_qs page_param="calls_page" %}
        </div>
      </div>
    </section>

    <section class="card card-pad">
      <details>
        <summary class="flex items-center justify-between gap-3 cursor-pointer select-none">
          <div>
            <span class="font-medium">Последние действия в CRM</span>
            <span class="text-xs muted-2 ml-2">({{ events_count }})</span>
          </div>
          <span class="text-xs muted-2">Нажмите, чтобы развернуть</span>
        </summary>
        <div class="mt-3 space-y-2 text-sm">
          {% for e in events_page %}
            <div class="rounded-lg border p-3 flex flex-wrap items-center gap-2">
              <span class="font-mono text-xs">{{ e.created_at|date:"d.m.Y H:i:s" }}</span>
              <span class="badge" style="padding:.1rem .35rem;font-size:.65rem">{{ e.get_verb_display }}</span>
              <span class="muted-2">{{ e.message|default:e.entity_type }}</span>
              {% if e.company_id %}
                <a class="link" href="/companies/{{ e.company_id }}/">(компания)</a>
              {% endif %}
            </div>
          {% empty %}
            <div class="muted-2">Нет действий за период.</div>
          {% endfor %}
        </div>
        <div class="border-t px-4 py-3 flex items-center justify-between gap-4 flex-wrap mt-3">
          <div class="flex items-center gap-2">
            <form method="get" class="flex items-center gap-2" id="perPageFormEvents">
              <label class="text-sm text-brand-dark/70 whitespace-nowrap">На странице:</label>
              <select name="per_page" class="select" onchange="document.getElementById('perPageFormEvents').submit()" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
              </select>
              <input type="hidden" name="period" value="{{ period }}" />
            </form>
          </div>
          <div>
            {% include "ui/_pagination.html" with page=events_page qs=events_qs page_param="events_page" %}
          </div>
        </div>
      </details>
    </section>
  </div>
{% endblock %}


