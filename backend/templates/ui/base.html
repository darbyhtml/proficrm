<!doctype html>
<html lang="ru">
  <head>
    {% load static %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex" />
    <meta name="googlebot" content="noindex, nofollow" />
    <title>{% block title %}CRM ПРОФИ{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="{% static 'ui/favicon-v2.svg' %}">
    <link rel="shortcut icon" href="{% static 'ui/favicon-v2.svg' %}">
    <meta name="theme-color" content="#01948E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                teal: "#01948E",
                orange: "#FDAD3A",
                dark: "#003D38",
                soft: "#C2E2DE",
              },
            },
          },
        },
      };
    </script>
    <style>
      :root{
        --brand-teal:#01948E;
        --brand-orange:#FDAD3A;
        --brand-dark:#003D38;
        --brand-soft:#C2E2DE;
      }
      .card{border:1px solid rgba(194,226,222,.9); border-radius:16px; background:#fff; box-shadow:0 1px 0 rgba(0,61,56,.04)}
      .card-pad{padding:16px}
      .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:12px; padding:.55rem .9rem; font-size:.875rem; line-height:1.1; transition:background-color .15s ease, border-color .15s ease, transform .05s ease}
      .btn:active{transform:scale(.99)}
      .btn-primary{background:var(--brand-teal); color:#fff}
      .btn-primary:hover{background:var(--brand-dark)}
      .btn-secondary{background:rgba(194,226,222,.35); border:1px solid rgba(194,226,222,.9); color:var(--brand-dark)}
      .btn-secondary:hover{background:rgba(194,226,222,.55)}
      .btn-outline{background:#fff; border:1px solid rgba(194,226,222,.9); color:var(--brand-dark)}
      .btn-outline:hover{background:rgba(194,226,222,.35)}
      .input,.select,.textarea{width:100%; border-radius:12px; border:1px solid rgba(194,226,222,.95); padding:.55rem .75rem; background:#fff; color:var(--brand-dark)}
      .textarea{min-height:96px}
      .input:focus,.select:focus,.textarea:focus{outline:none; box-shadow:0 0 0 4px rgba(1,148,142,.14); border-color:rgba(1,148,142,.65)}
      .muted{color:rgba(0,61,56,.72)}
      .muted-2{color:rgba(0,61,56,.55)}
      .badge{display:inline-flex; align-items:center; border-radius:999px; padding:.15rem .55rem; font-size:.75rem; border:1px solid rgba(194,226,222,.95); background:rgba(194,226,222,.35); color:var(--brand-dark); white-space:nowrap}
      .badge-warn{background:rgba(253,173,58,.22); border-color:rgba(253,173,58,.45)}
      .badge-new{background:rgba(1,148,142,.12); border-color:rgba(1,148,142,.35)}
      .badge-progress{background:rgba(253,173,58,.22); border-color:rgba(253,173,58,.45)}
      .badge-done{background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.35)}
      .badge-cancel{background:rgba(148,163,184,.18); border-color:rgba(148,163,184,.35); color:rgba(0,61,56,.75)}
      .badge-danger{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.30)}
      .task-overdue{border-color:rgba(239,68,68,.45)!important; background:rgba(239,68,68,.06)}
      .wrap-anywhere{overflow-wrap:anywhere; word-break:break-word}
      .wrap-anywhere a{overflow-wrap:anywhere; word-break:break-all}
      .table{width:100%; font-size:.875rem}
      .table th{background:rgba(194,226,222,.35); color:rgba(0,61,56,.82); text-align:left; padding:.85rem 1rem}
      .table td{padding:.85rem 1rem; border-top:1px solid rgba(194,226,222,.7); vertical-align:top}
      .table tr:hover td{background:rgba(194,226,222,.20)}
      a.link{ text-decoration:underline; text-underline-offset:2px }
      /* Icon alignment */
      .nav-ico-wrap{width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;flex:none}
      .nav-ico-wrap svg{display:block}
      /* Multiselect (checkbox dropdown) */
      .ms{position:relative}
      .ms-btn{width:100%; display:flex; align-items:center; justify-content:space-between; gap:.5rem; border-radius:12px; border:1px solid rgba(194,226,222,.95); padding:.55rem .75rem; background:#fff; color:var(--brand-dark)}
      .ms-btn:hover{background:rgba(194,226,222,.20)}
      .ms-value{font-size:.875rem}
      .ms-panel{position:absolute; left:0; right:0; top:calc(100% + 8px); z-index:60; border-radius:16px; border:1px solid rgba(194,226,222,.95); background:#fff; box-shadow:0 12px 30px rgba(0,61,56,.10); overflow:hidden}
      .ms-panel .ms-top{padding:10px 12px; border-bottom:1px solid rgba(194,226,222,.7); display:flex; gap:8px; align-items:center}
      .ms-panel .ms-search{flex:1}
      .ms-panel .ms-list{max-height:260px; overflow:auto; padding:8px}
      .ms-item{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px}
      .ms-item:hover{background:rgba(194,226,222,.25)}
      .ms-muted{color:rgba(0,61,56,.65); font-size:.75rem}
    </style>
  </head>
  <body class="bg-brand-soft/40 text-brand-dark">
    <div class="min-h-screen">
      <header class="border-b border-brand-soft bg-white/80 backdrop-blur">
        <div class="mx-auto max-w-screen-2xl px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button id="menuBtn" type="button" class="md:hidden rounded-xl border border-brand-soft bg-white px-2.5 py-2 hover:bg-brand-soft/40 active:scale-[0.99]" aria-label="Меню">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
            </button>
            <a href="/" class="font-semibold tracking-tight text-brand-dark">CRM ПРОФИ</a>
            <span class="text-xs text-brand-dark/70">простая, как amo, но без лишнего</span>
          </div>
          <div class="flex items-center gap-3 text-sm">
            {% if is_admin %}
              <form method="post" action="{% url 'view_as_update' %}" class="hidden md:flex items-center gap-2 text-xs mr-2">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <div class="flex items-center gap-1">
                  <span class="text-brand-dark/60">Роль:</span>
                  <select name="view_role" class="select w-auto py-1 px-2 text-xs">
                    <option value="">Администратор</option>
                    {% for value,label in view_as_roles %}
                      <option value="{{ value }}" {% if view_as_role == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-brand-dark/60">Филиал:</span>
                  <select name="view_as_branch_id" class="select w-auto py-1 px-2 text-xs">
                    <option value="">Все</option>
                    {% for b in view_as_branches %}
                      <option value="{{ b.id }}" {% if view_as_branch and view_as_branch.id == b.id %}selected{% endif %}>{{ b.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" class="btn btn-outline py-1 px-2 text-xs">Применить</button>
                {% if view_as_role or view_as_branch %}
                  <a href="{% url 'view_as_reset' %}" class="text-xs text-brand-dark/60 underline">Сброс</a>
                {% endif %}
              </form>
            {% endif %}

            <div class="relative">
              <button id="notifBtn" type="button" class="relative rounded-xl border border-brand-soft bg-white px-2.5 py-2 hover:bg-brand-soft/40 active:scale-[0.99]" aria-label="Уведомления">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
                  <path d="M13.73 21a2 2 0 01-3.46 0"/>
                </svg>
                <span id="bellBadge" class="absolute -top-1 -right-1 inline-flex items-center justify-center min-w-[18px] h-[18px] px-1 rounded-full bg-brand-orange text-brand-dark text-[11px] font-semibold border border-white {% if not bell_count or bell_count <= 0 %}hidden{% endif %}">
                  {{ bell_count|default:0 }}
                </span>
              </button>

              <div id="notifPanel" class="hidden absolute right-0 mt-2 w-[360px] max-w-[90vw] card overflow-hidden z-50">
                <div class="px-4 py-3 border-b border-brand-soft bg-white">
                  <div class="flex items-center justify-between">
                    <div class="font-medium">Уведомления</div>
                    <div class="flex items-center gap-2">
                      <button id="notifEnableBrowser" type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" title="Разрешить уведомления браузера">Браузер</button>
                      <form method="post" action="/notifications/mark-all-read/" id="notifMarkAllForm">
                        {% csrf_token %}
                        <button class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" type="submit">Прочитано</button>
                      </form>
                    </div>
                  </div>
                  <div class="text-xs muted mt-1">
                    Новые: <b id="notifUnreadCount">{{ notif_unread_count|default:0 }}</b> · Напоминания: <b id="reminderCount">{{ reminder_count|default:0 }}</b>
                  </div>
                </div>

                <div class="max-h-[420px] overflow-auto bg-white">
                  {% if reminder_items %}
                    <div class="px-4 pt-3 pb-2 flex items-center justify-between">
                      <span class="text-xs muted">Напоминания</span>
                      {% if reminder_count > reminder_items|length %}
                        <a href="/notifications/reminders/all/" class="text-xs link">Показать все ({{ reminder_count }})</a>
                      {% endif %}
                    </div>
                    <div class="px-2 pb-2" id="reminderList">
                      {% for r in reminder_items %}
                        <a class="block rounded-xl border border-brand-soft px-3 py-2 mb-2 hover:bg-brand-soft/25" href="{{ r.url }}">
                          <div class="text-sm font-medium">{{ r.title }}</div>
                          {% if r.subtitle %}<div class="text-xs muted mt-0.5">{{ r.subtitle }}</div>{% endif %}
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}

                  <div class="px-4 pt-3 pb-2 flex items-center justify-between">
                    <span class="text-xs muted">Новые</span>
                    {% if notif_unread_count > notif_items|length %}
                      <a href="/notifications/all/" class="text-xs link">Показать все ({{ notif_unread_count }})</a>
                    {% endif %}
                  </div>
                  <div class="px-2 pb-3" id="notifList">
                    {% for n in notif_items %}
                      <div class="rounded-xl border border-brand-soft px-3 py-2 mb-2 bg-brand-soft/20" data-notif-id="{{ n.id }}">
                        <div class="flex items-start justify-between gap-2">
                          <div>
                            <div class="text-sm font-medium">{{ n.title }}</div>
                            {% if n.body %}<div class="text-xs muted mt-0.5">{{ n.body|truncatechars:140 }}</div>{% endif %}
                            <div class="text-[11px] muted-2 mt-1">{{ n.created_at }}</div>
                          </div>
                          <form method="post" action="/notifications/{{ n.id }}/read/" class="js-notif-read-form">
                            {% csrf_token %}
                            <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" type="submit" title="Отметить прочитанным">✓</button>
                          </form>
                        </div>
                        {% if n.url %}
                          <a class="link text-sm mt-2 inline-block" href="{{ n.url }}">Открыть</a>
                        {% endif %}
                      </div>
                    {% empty %}
                      <div class="px-2 pb-3 muted text-sm" id="notifEmpty">Уведомлений пока нет.</div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            <span class="text-brand-dark/80">
              {% if request.user.first_name or request.user.last_name %}
                {{ request.user.last_name }} {{ request.user.first_name }}
              {% else %}
                {{ request.user.get_username }}
              {% endif %}
            </span>
            <form method="post" action="/logout/">
              {% csrf_token %}
              <button class="rounded-lg border border-brand-soft bg-white px-3 py-1.5 hover:bg-brand-soft/40 active:scale-[0.99]">Выйти</button>
            </form>
          </div>
        </div>
        {% if is_admin %}
          {% if view_as_role or view_as_branch %}
            <div class="border-t border-brand-soft bg-amber-50/90">
              <div class="mx-auto max-w-screen-2xl px-4 py-1.5 text-[11px] md:text-xs text-amber-900 flex flex-col md:flex-row items-start md:items-center justify-between gap-1.5">
                <div>
                  <span class="font-semibold">Режим просмотра администратора:</span>
                  <span>
                    роль —
                    {% if view_as_role_label %}
                      {{ view_as_role_label }}
                    {% else %}
                      Администратор
                    {% endif %}
                  </span>
                  <span>
                    · филиал —
                    {% if view_as_branch %}
                      {{ view_as_branch.name }}
                    {% else %}
                      все
                    {% endif %}
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-amber-900/85">Права и ограничения не меняются, меняется только отображение и фильтры.</span>
                  <a href="{% url 'view_as_reset' %}" class="text-amber-900 underline">Сбросить</a>
                </div>
              </div>
            </div>
          {% endif %}
        {% endif %}
      </header>

      <div class="mx-auto max-w-screen-2xl px-4 py-6 flex flex-col md:flex-row gap-5">
        <div id="sidebarOverlay" class="hidden md:hidden fixed inset-0 bg-black/30 z-40"></div>
        <aside class="md:w-[200px] md:flex-shrink-0">
          <div id="sidebarDrawer" class="bg-white border border-brand-soft rounded-xl p-2 md:sticky md:top-4
               md:block fixed z-50 inset-y-0 left-0 w-[280px] max-w-[85vw] md:w-auto
               transform -translate-x-full md:translate-x-0 transition-transform duration-150 ease-out
               overflow-y-auto">

            <div class="md:hidden flex items-center justify-between px-2 py-2 border-b border-brand-soft mb-2">
              <div class="font-semibold">Меню</div>
              <button id="menuCloseBtn" type="button" class="rounded-xl border border-brand-soft bg-white px-2.5 py-2 hover:bg-brand-soft/40 active:scale-[0.99]" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <nav class="space-y-1">
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'dashboard' %}bg-brand-soft/50 font-medium{% endif %}" href="/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/></svg>
                </span>
                <span>Рабочий стол</span>
              </a>
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'task_list' or request.resolver_match.url_name == 'task_create' or request.resolver_match.url_name == 'task_edit' %}bg-brand-soft/50 font-medium{% endif %}" href="/tasks/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                </span>
                <span>Задачи</span>
              </a>
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'company_list' or request.resolver_match.url_name == 'company_detail' or request.resolver_match.url_name == 'company_create' or request.resolver_match.url_name == 'company_edit' %}bg-brand-soft/50 font-medium{% endif %}" href="/companies/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v14"/><path d="M9 21V9h6v12"/><path d="M9 13h6"/></svg>
                </span>
                <span>Списки (компании)</span>
              </a>
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.path|slice:':6' == '/mail/' %}bg-brand-soft/50 font-medium{% endif %}" href="/mail/campaigns/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 6h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"/>
                    <path d="m22 8-10 6L2 8"/>
                  </svg>
                </span>
                <span>Почта</span>
              </a>
              {% if view_can_view_activity %}
                <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'analytics' or request.resolver_match.url_name == 'analytics_user' %}bg-brand-soft/50 font-medium{% endif %}" href="/analytics/">
                  <span class="nav-ico-wrap">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 14l4-4 4 3 5-7"/></svg>
                  </span>
                  <span>Аналитика</span>
                </a>
              {% endif %}
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'help' %}bg-brand-soft/50 font-medium{% endif %}" href="/help/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <path d="M12 17h.01"/>
                  </svg>
                </span>
                <span>Помощь</span>
              </a>
              {% if view_is_admin %}
                <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name|slice:':9' == 'settings_' %}bg-brand-soft/50 font-medium{% endif %}" href="/settings/">
                  <span class="nav-ico-wrap">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 21v-7"/>
                      <path d="M4 10V3"/>
                      <path d="M12 21v-9"/>
                      <path d="M12 8V3"/>
                      <path d="M20 21v-5"/>
                      <path d="M20 12V3"/>
                      <path d="M2 14h4"/>
                      <path d="M10 12h4"/>
                      <path d="M18 16h4"/>
                    </svg>
                  </span>
                  <span>Настройки</span>
                </a>
              {% endif %}
              {% if view_is_admin %}
                <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm" href="/admin/">
                  <span class="nav-ico-wrap">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  </span>
                  <span>Админка</span>
                </a>
              {% endif %}
            </nav>
          </div>
        </aside>

        <main class="flex-1 min-w-0">
          {% if messages %}
            <div class="space-y-2 mb-4">
              {% for message in messages %}
                {% if 'error' in message.tags %}
                  <div class="rounded-xl border border-brand-orange/40 bg-brand-orange/15 px-4 py-3 text-sm text-brand-dark">
                    {{ message }}
                  </div>
                {% elif 'warning' in message.tags %}
                  <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
                    {{ message }}
                  </div>
                {% elif 'success' in message.tags %}
                  <div class="rounded-xl border border-brand-teal/40 bg-brand-teal/10 px-4 py-3 text-sm text-brand-dark">
                    {{ message }}
                  </div>
                {% else %}
                  <div class="rounded-xl border border-brand-soft bg-white px-4 py-3 text-sm text-brand-dark">
                    {{ message }}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
          {% block content %}{% endblock %}
        </main>
      </div>
    </div>

    {# Глобальный прогресс рассылки (показывается только если есть активная отправка) #}
    <a id="mailProgressWidget" href="#" class="hidden fixed bottom-5 left-5 z-50 bg-white border border-brand-soft rounded-2xl shadow-lg px-3 py-2 flex items-center gap-3 hover:bg-brand-soft/20" style="min-width:210px; position:fixed;">
      <div id="mailProgressCircle" class="w-10 h-10 rounded-full flex items-center justify-center text-xs font-semibold" style="background:conic-gradient(var(--brand-teal) 0deg, rgba(194,226,222,.6) 0deg); color:var(--brand-dark); border:1px solid rgba(194,226,222,.9)">
        <span id="mailProgressPct">0%</span>
      </div>
      <div class="leading-tight relative pr-5">
        <div class="text-xs muted">Рассылка</div>
        <div id="mailProgressText" class="text-sm font-medium">—</div>
        <div id="mailProgressCounts" class="text-[11px] muted-2">—</div>
        <button id="mailProgressClose" type="button" class="hidden absolute -top-1 -right-1 w-5 h-5 flex items-center justify-center rounded-full border border-brand-soft bg-white text-brand-dark/60 hover:text-red-500 hover:border-red-400 transition-colors" title="Закрыть">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18"/>
            <path d="M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </a>

    <script>
      (function(){
        const btn = document.getElementById('notifBtn');
        const panel = document.getElementById('notifPanel');
        if(!btn || !panel) return;
        function close(){ panel.classList.add('hidden'); }
        function toggle(){ panel.classList.toggle('hidden'); }
        btn.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
        panel.addEventListener('click', function(e){ e.stopPropagation(); });
        document.addEventListener('click', close);
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape') close(); });
      })();
    </script>
    <script>
      // Live notifications (polling). Без WebSocket, безопасно: если JS не работает — всё как раньше.
      (function(){
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }
        function escapeHtml(s){
          // replaceAll может отсутствовать в некоторых браузерах — используем регулярки
          return String(s || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        const csrftoken = getCookie('csrftoken');
        const badge = document.getElementById('bellBadge');
        const notifCountEl = document.getElementById('notifUnreadCount');
        const reminderCountEl = document.getElementById('reminderCount');
        const notifList = document.getElementById('notifList');
        const reminderList = document.getElementById('reminderList');
        const markAllForm = document.getElementById('notifMarkAllForm');
        const enableBrowserBtn = document.getElementById('notifEnableBrowser');

        const BROWSER_KEY = 'crm_notif_browser_enabled';

        function getBool(key, defVal){
          try{
            const v = localStorage.getItem(key);
            if(v === null || v === undefined) return !!defVal;
            return v === '1';
          }catch(_e){
            return !!defVal;
          }
        }
        function setBool(key, val){
          try{ localStorage.setItem(key, val ? '1' : '0'); }catch(_e){}
        }
        let browserEnabled = getBool(BROWSER_KEY, false);

        function updateTogglesUI(){
          if(enableBrowserBtn){
            enableBrowserBtn.classList.toggle('btn-primary', !!browserEnabled);
            enableBrowserBtn.classList.toggle('btn-outline', !browserEnabled);
          }
        }

        function showToast(text, kind){
          try{
            const id = 'notifToast';
            let el = document.getElementById(id);
            if(!el){
              el = document.createElement('div');
              el.id = id;
              el.style.position = 'fixed';
              el.style.right = '16px';
              el.style.bottom = '16px';
              el.style.zIndex = '90';
              el.style.maxWidth = '92vw';
              el.style.display = 'none';
              el.innerHTML = '<div style="border:1px solid rgba(194,226,222,.95);background:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 12px 30px rgba(0,61,56,.10);font-size:13px;color:#003D38"></div>';
              document.body.appendChild(el);
            }
            const box = el.firstElementChild;
            if(box){
              box.textContent = text || '';
              const k = String(kind || '');
              if(k === 'error'){
                box.style.borderColor = 'rgba(239,68,68,.30)';
                box.style.background = 'rgba(239,68,68,.08)';
              }else if(k === 'success'){
                box.style.borderColor = 'rgba(16,185,129,.30)';
                box.style.background = 'rgba(16,185,129,.06)';
              }else{
                box.style.borderColor = 'rgba(194,226,222,.95)';
                box.style.background = '#fff';
              }
            }
            el.style.display = 'block';
            clearTimeout(el.__t);
            el.__t = setTimeout(() => { el.style.display = 'none'; }, 2400);
          }catch(_e){}
        }

        // Глобальный toast для остальных страниц (company_detail и т.п.)
        window.uiToast = showToast;

        function showBrowserNotification(n){
          if(!browserEnabled) return;
          if(!('Notification' in window)) return;
          if(!window.isSecureContext) return; // браузерные уведомления в небезопасном контексте часто запрещены
          if(Notification.permission !== 'granted') return;
          try{
            const title = n.title || 'CRM ПРОФИ';
            const body = (n.body || '').slice(0, 180);
            const url = n.url || '';
            const notif = new Notification(title, {
              body,
              tag: 'crm_' + (n.id || ''),
              // Используем системный/браузерный звук уведомлений (если браузер/ОС его позволяют).
              silent: false,
              icon: '/static/ui/favicon-v2.svg',
            });
            notif.onclick = () => {
              try{ window.focus(); }catch(_e){}
              if(url) window.location.href = url;
              notif.close && notif.close();
            };
            setTimeout(() => { try{ notif.close && notif.close(); }catch(_e){} }, 8000);
          }catch(_e){}
        }

        let lastIds = new Set();
        document.querySelectorAll('[data-notif-id]').forEach(el => {
          const id = el.getAttribute('data-notif-id');
          if (id) lastIds.add(id);
        });

        function updateBadge(count){
          if(!badge) return;
          const c = Number(count || 0);
          badge.textContent = String(c);
          if(c > 0) badge.classList.remove('hidden');
          else badge.classList.add('hidden');
        }

        function bindNotifActions(){
          // AJAX mark read
          document.querySelectorAll('.js-notif-read-form').forEach(f => {
            if (f.__bound) return;
            f.__bound = true;
            f.addEventListener('submit', async (e) => {
              e.preventDefault();
              const action = f.getAttribute('action') || '';
              try{
                await fetch(action, {method:'POST', headers:{'X-CSRFToken': csrftoken}, credentials:'same-origin'});
              }catch(_e){}
              pollOnce();
            });
          });
          // AJAX mark all
          if(markAllForm && !markAllForm.__bound){
            markAllForm.__bound = true;
            markAllForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const action = markAllForm.getAttribute('action') || '';
              try{
                await fetch(action, {method:'POST', headers:{'X-CSRFToken': csrftoken}, credentials:'same-origin'});
              }catch(_e){}
              pollOnce();
            });
          }
        }

        function renderReminders(items, totalCount){
          if(!reminderList) return;
          const arr = Array.isArray(items) ? items : [];
          if(!arr.length){
            reminderList.innerHTML = '';
            return;
          }
          reminderList.innerHTML = arr.map(r => {
            const title = escapeHtml(r.title);
            const subtitle = escapeHtml(r.subtitle || '');
            const url = escapeHtml(r.url || '#');
            return `<a class="block rounded-xl border border-brand-soft px-3 py-2 mb-2 hover:bg-brand-soft/25" href="${url}">
              <div class="text-sm font-medium">${title}</div>
              ${subtitle ? `<div class="text-xs muted mt-0.5">${subtitle}</div>` : ''}
            </a>`;
          }).join('');
          
          // Обновляем заголовок с кнопкой "Показать все"
          const reminderHeader = reminderList.previousElementSibling;
          if(reminderHeader){
            const existingLink = reminderHeader.querySelector('a');
            if(totalCount && totalCount > arr.length){
              if(!existingLink){
                const showAllLink = document.createElement('a');
                showAllLink.href = '/notifications/reminders/all/';
                showAllLink.className = 'text-xs link';
                showAllLink.textContent = `Показать все (${totalCount})`;
                reminderHeader.appendChild(showAllLink);
              } else {
                existingLink.textContent = `Показать все (${totalCount})`;
              }
            } else if(existingLink){
              existingLink.remove();
            }
          }
        }

        function renderNotifs(items, totalCount){
          if(!notifList) return;
          const arr = Array.isArray(items) ? items : [];
          if(!arr.length){
            notifList.innerHTML = '<div class="px-2 pb-3 muted text-sm" id="notifEmpty">Уведомлений пока нет.</div>';
            return;
          }
          notifList.innerHTML = arr.map(n => {
            const id = escapeHtml(n.id);
            const title = escapeHtml(n.title);
            const body = escapeHtml(n.body || '');
            const created = escapeHtml(n.created_at || '');
            const url = escapeHtml(n.url || '');
            const openLink = url ? `<a class="link text-sm mt-2 inline-block" href="${url}">Открыть</a>` : '';
            const bodyShort = body ? (body.length > 140 ? body.slice(0, 140) + '…' : body) : '';
            return `<div class="rounded-xl border border-brand-soft px-3 py-2 mb-2 bg-brand-soft/20" data-notif-id="${id}">
              <div class="flex items-start justify-between gap-2">
                <div>
                  <div class="text-sm font-medium">${title}</div>
                  ${bodyShort ? `<div class="text-xs muted mt-0.5">${bodyShort}</div>` : ''}
                  <div class="text-[11px] muted-2 mt-1">${created}</div>
                </div>
                <form method="post" action="/notifications/${id}/read/" class="js-notif-read-form">
                  <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" type="submit" title="Отметить прочитанным">✓</button>
                </form>
              </div>
              ${openLink}
            </div>`;
          }).join('');
          
          // Обновляем заголовок с кнопкой "Показать все"
          const notifHeader = notifList.previousElementSibling;
          if(notifHeader){
            const existingLink = notifHeader.querySelector('a');
            if(totalCount && totalCount > arr.length){
              if(!existingLink){
                const showAllLink = document.createElement('a');
                showAllLink.href = '/notifications/all/';
                showAllLink.className = 'text-xs link';
                showAllLink.textContent = `Показать все (${totalCount})`;
                notifHeader.appendChild(showAllLink);
              } else {
                existingLink.textContent = `Показать все (${totalCount})`;
              }
            } else if(existingLink){
              existingLink.remove();
            }
          }
        }

        let pollInFlight = false;
        async function pollOnce(){
          if(pollInFlight) return;
          pollInFlight = true;
          try{
            const res = await fetch('/notifications/poll/', {credentials:'same-origin'});
            const data = await res.json().catch(() => null);
            if(!data || !data.ok) return;
            updateBadge(data.bell_count);
            if(notifCountEl) notifCountEl.textContent = String(data.notif_unread_count || 0);
            if(reminderCountEl) reminderCountEl.textContent = String(data.reminder_count || 0);

            const newIds = new Set((data.notif_items || []).map(n => String(n.id)));
            const hasNew = Array.from(newIds).some(id => !lastIds.has(id));
            const newest = (data.notif_items && data.notif_items.length) ? data.notif_items[0] : null;
            lastIds = newIds;

            renderReminders(data.reminder_items || [], data.reminder_count || 0);
            renderNotifs(data.notif_items || [], data.notif_unread_count || 0);
            bindNotifActions();

            // лёгкий лайв-сигнал: кольцо на колокольчике
            if(hasNew){
              const btn = document.getElementById('notifBtn');
              if(btn){
                btn.classList.add('ring-4','ring-brand-teal/15');
                setTimeout(() => btn.classList.remove('ring-4','ring-brand-teal/15'), 1200);
              }
              // Браузерное уведомление + системный/браузерный звук (если браузер/ОС его позволяют)
              if(newest) showBrowserNotification(newest);
            }
          }catch(_e){
          }finally{
            pollInFlight = false;
          }
        }

        bindNotifActions();
        updateTogglesUI();

        if(enableBrowserBtn && !enableBrowserBtn.__bound){
          enableBrowserBtn.__bound = true;
          enableBrowserBtn.addEventListener('click', async () => {
            if(!('Notification' in window)){
              showToast('Браузерные уведомления не поддерживаются.', 'error');
              return;
            }
            if(!window.isSecureContext){
              showToast('Браузерные уведомления работают только по HTTPS.', 'error');
              return;
            }
            try{
              const perm = await Notification.requestPermission();
              browserEnabled = (perm === 'granted');
              setBool(BROWSER_KEY, browserEnabled);
              updateTogglesUI();
              if(!browserEnabled) {
                showToast('Разрешение не выдано. Уведомления браузера отключены.', 'error');
              } else {
                showToast('Браузерные уведомления включены.', 'success');
                // тестовое уведомление, чтобы было понятно что всё включилось
                showBrowserNotification({id:'test', title:'CRM ПРОФИ', body:'Браузерные уведомления включены', url:''});
              }
            }catch(_e){}
          });
        }

        pollOnce();
        setInterval(pollOnce, 15000);
      })();
    </script>
    <script>
      (function(){
        const openBtn = document.getElementById('menuBtn');
        const closeBtn = document.getElementById('menuCloseBtn');
        const drawer = document.getElementById('sidebarDrawer');
        const overlay = document.getElementById('sidebarOverlay');
        if(!drawer) return;
        function open(){
          drawer.classList.remove('-translate-x-full');
          if(overlay){ overlay.classList.remove('hidden'); }
        }
        function close(){
          drawer.classList.add('-translate-x-full');
          if(overlay){ overlay.classList.add('hidden'); }
        }
        if(openBtn) openBtn.addEventListener('click', function(e){ e.stopPropagation(); open(); });
        if(closeBtn) closeBtn.addEventListener('click', function(e){ e.stopPropagation(); close(); });
        if(overlay) overlay.addEventListener('click', close);
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape') close(); });
      })();
    </script>
    <script>
      // Checkbox multiselect over <select multiple>
      (function(){
        function initOne(root){
          const select = root.querySelector('select[multiple]');
          if(!select) return;
          // hide original select but keep in DOM for submit
          select.classList.add('hidden');

          const btn = root.querySelector('.ms-btn');
          const valueEl = root.querySelector('.ms-value');
          const panel = root.querySelector('.ms-panel');
          const search = root.querySelector('.ms-search');
          const list = root.querySelector('.ms-list');
          const clearBtn = root.querySelector('[data-ms-clear]');

          function selectedTexts(){
            const selected = Array.from(select.options).filter(o => o.selected).map(o => o.text.trim()).filter(Boolean);
            return selected;
          }
          function renderValue(){
            const sel = selectedTexts();
            valueEl.textContent = sel.length ? sel.join(', ') : (root.getAttribute('data-placeholder') || 'Выберите…');
          }
          function renderList(filter){
            const f = (filter || '').toLowerCase().trim();
            list.innerHTML = '';
            const opts = Array.from(select.options);
            for(const o of opts){
              const label = (o.text || '').trim();
              if(!label) continue;
              if(f && !label.toLowerCase().includes(f)) continue;
              const row = document.createElement('label');
              row.className = 'ms-item';
              const cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.checked = !!o.selected;
              cb.addEventListener('change', () => {
                o.selected = cb.checked;
                renderValue();
              });
              const span = document.createElement('span');
              span.textContent = label;
              row.appendChild(cb);
              row.appendChild(span);
              list.appendChild(row);
            }
            if(!list.children.length){
              const empty = document.createElement('div');
              empty.className = 'ms-muted px-1 py-2';
              empty.textContent = 'Ничего не найдено';
              list.appendChild(empty);
            }
          }

          function open(){
            panel.classList.remove('hidden');
            renderList(search.value);
            search.focus();
          }
          function close(){
            panel.classList.add('hidden');
            search.value = '';
          }

          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if(panel.classList.contains('hidden')) open(); else close();
          });
          panel.addEventListener('click', (e) => e.stopPropagation());
          document.addEventListener('click', close);
          document.addEventListener('keydown', (e) => { if(e.key === 'Escape') close(); });

          search.addEventListener('input', () => renderList(search.value));
          if(clearBtn){
            clearBtn.addEventListener('click', (e) => {
              e.preventDefault();
              for(const o of Array.from(select.options)) o.selected = false;
              renderValue();
              renderList(search.value);
            });
          }

          // initial
          renderValue();
        }

        function initAll(){
          document.querySelectorAll('[data-ms="1"]').forEach(initOne);
        }
        document.addEventListener('DOMContentLoaded', initAll);
      })();
    </script>
    <script>
      // Searchable single select over <select> (not multiple)
      (function(){
        const MAX_RENDER = 200;

        function initOne(root){
          const select = root.querySelector('select:not([multiple])');
          if(!select) return;
          // hide original select but keep in DOM for submit
          select.classList.add('hidden');

          const btn = root.querySelector('.ms-btn');
          const valueEl = root.querySelector('.ms-value');
          const panel = root.querySelector('.ms-panel');
          const search = root.querySelector('.ms-search');
          const list = root.querySelector('.ms-list');
          const clearBtn = root.querySelector('[data-ms-clear]');

          function selectedText(){
            const o = select.options[select.selectedIndex];
            const txt = (o && (o.text || '').trim()) || '';
            const val = (o && (o.value || '').trim()) || '';
            if(!val) return '';
            return txt;
          }
          function renderValue(){
            const txt = selectedText();
            valueEl.textContent = txt || (root.getAttribute('data-placeholder') || 'Выберите…');
          }
          function renderList(filter){
            const f = (filter || '').toLowerCase().trim();
            list.innerHTML = '';
            const opts = Array.from(select.options);

            // special "empty" option (value == "")
            const emptyOpt = opts.find(o => !((o.value || '').trim()));
            const emptyLabel = (emptyOpt && (emptyOpt.text || '').trim()) || '— Не выбрано —';
            const emptyRow = document.createElement('label');
            emptyRow.className = 'ms-item';
            const emptyRb = document.createElement('input');
            emptyRb.type = 'radio';
            emptyRb.name = '__ms_single_' + (select.name || 'x');
            emptyRb.checked = !((select.value || '').trim());
            emptyRb.addEventListener('change', () => {
              select.value = '';
              renderValue();
            });
            const emptySpan = document.createElement('span');
            emptySpan.textContent = emptyLabel;
            emptyRow.appendChild(emptyRb);
            emptyRow.appendChild(emptySpan);
            if(!f || emptyLabel.toLowerCase().includes(f)) {
              list.appendChild(emptyRow);
            }

            let rendered = 0;
            let matched = 0;
            for(const o of opts){
              const val = (o.value || '').trim();
              const label = (o.text || '').trim();
              if(!val) continue; // skip empty option (rendered above)
              if(!label) continue;
              if(f && !label.toLowerCase().includes(f)) continue;
              matched += 1;
              if(rendered >= MAX_RENDER) continue;

              const row = document.createElement('label');
              row.className = 'ms-item';
              const rb = document.createElement('input');
              rb.type = 'radio';
              rb.name = '__ms_single_' + (select.name || 'x');
              rb.checked = (select.value || '') === o.value;
              rb.addEventListener('change', () => {
                select.value = o.value;
                renderValue();
              });
              const span = document.createElement('span');
              span.textContent = label;
              row.appendChild(rb);
              row.appendChild(span);
              list.appendChild(row);
              rendered += 1;
            }

            if(!list.children.length){
              const empty = document.createElement('div');
              empty.className = 'ms-muted px-1 py-2';
              empty.textContent = 'Ничего не найдено';
              list.appendChild(empty);
              return;
            }

            if(matched > MAX_RENDER){
              const more = document.createElement('div');
              more.className = 'ms-muted px-1 py-2';
              more.textContent = 'Показаны первые ' + MAX_RENDER + '. Уточните запрос, чтобы найти нужное.';
              list.appendChild(more);
            }
          }

          function open(){
            panel.classList.remove('hidden');
            renderList(search.value);
            search.focus();
          }
          function close(){
            panel.classList.add('hidden');
            search.value = '';
          }

          if(btn){
            btn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              if(panel.classList.contains('hidden')) open(); else close();
            });
          }
          panel.addEventListener('click', (e) => e.stopPropagation());
          document.addEventListener('click', close);
          document.addEventListener('keydown', (e) => { if(e.key === 'Escape') close(); });

          if(search){
            search.addEventListener('input', () => renderList(search.value));
          }
          if(clearBtn){
            clearBtn.addEventListener('click', (e) => {
              e.preventDefault();
              select.value = '';
              renderValue();
              renderList(search.value);
            });
          }

          // initial
          renderValue();
        }

        function initAll(){
          document.querySelectorAll('[data-ms-single="1"]').forEach(initOne);
        }
        document.addEventListener('DOMContentLoaded', initAll);
      })();
    </script>
    <script>
      // Автоматическое форматирование номеров телефонов при вводе
      function formatPhoneInput(input) {
        let value = input.value.replace(/\D/g, ''); // Убираем все нецифровые символы
        
        // Если начинается с 7 и длина 11, убираем первую 7 (оставляем 10 цифр)
        if (value.startsWith('7') && value.length === 11) {
          value = value.substring(1);
        }
        
        // Если начинается с 8 и длина 11, заменяем на 7 и убираем первую 7 (оставляем 10 цифр)
        if (value.startsWith('8') && value.length === 11) {
          value = value.substring(1); // Убираем 8, остается 10 цифр
        }
        
        // Если начинается с 78 и длина 12, убираем 78 (оставляем 10 цифр)
        if (value.startsWith('78') && value.length === 12) {
          value = value.substring(2); // Убираем 78, остается 10 цифр
        }
        
        // Форматируем только если 10 цифр
        if (value.length === 10) {
          input.value = `+7 (${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6, 10)}`;
        } else if (value.length > 10) {
          // Если больше 10, берем последние 10
          value = value.substring(value.length - 10);
          input.value = `+7 (${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6, 10)}`;
        } else if (value.length > 0) {
          // Если меньше 10, оставляем как есть (пользователь еще вводит)
          input.value = value;
        }
      }
      
      // Применяем форматирование ко всем полям телефонов при загрузке страницы
      document.addEventListener('DOMContentLoaded', function() {
        // Поля с name="phone" или id содержащим "phone"
        document.querySelectorAll('input[name="phone"], input[id*="phone"], input[name*="phone"]').forEach(input => {
          // Форматируем текущее значение, если оно есть
          if (input.value) {
            formatPhoneInput(input);
          }
          
          // Форматируем при вводе
          input.addEventListener('input', function() {
            formatPhoneInput(this);
          });
          
          // Форматируем при потере фокуса
          input.addEventListener('blur', function() {
            formatPhoneInput(this);
          });
        });
        
        // Для форм контактов (динамические поля) - используем делегирование событий
        // ВАЖНО: не трогаем email поля (type="email" или родительский контейнер с email)
        document.addEventListener('input', function(e) {
          if (e.target && e.target.tagName === 'INPUT') {
            // Пропускаем email поля
            if (e.target.type === 'email') return;
            // Пропускаем поля, которые находятся в секции Email
            const parentSection = e.target.closest('section');
            if (parentSection) {
              const sectionLabel = parentSection.querySelector('.font-medium');
              if (sectionLabel && sectionLabel.textContent.trim().toLowerCase().includes('email')) {
                return;
              }
            }
            // Применяем форматирование только к телефонным полям
            if (e.target.name && e.target.name.includes('phone') || 
                e.target.id && e.target.id.includes('phone') ||
                (e.target.name && e.target.name.includes('value') && e.target.type !== 'email')) {
              formatPhoneInput(e.target);
            }
          }
        });
        
        // Очищаем форматирование перед отправкой формы (сохраняем только цифры)
        document.querySelectorAll('form').forEach(form => {
          form.addEventListener('submit', function(e) {
            // Находим все поля телефонов в форме (исключаем email поля)
            form.querySelectorAll('input[name="phone"], input[name*="phone"], input[name*="value"]').forEach(input => {
              // Пропускаем email поля
              if (input.type === 'email') return;
              // Пропускаем поля в секции Email
              const parentSection = input.closest('section');
              if (parentSection) {
                const sectionLabel = parentSection.querySelector('.font-medium');
                if (sectionLabel && sectionLabel.textContent.trim().toLowerCase().includes('email')) {
                  return;
                }
              }
              
              if (input.value) {
                // Убираем все нецифровые символы
                let value = input.value.replace(/\D/g, '');
                
                // Если начинается с 7 и длина 11, убираем первую 7 (оставляем 10 цифр)
                if (value.startsWith('7') && value.length === 11) {
                  value = value.substring(1);
                }
                // Если начинается с 8 и длина 11, убираем 8 (оставляем 10 цифр)
                else if (value.startsWith('8') && value.length === 11) {
                  value = value.substring(1);
                }
                // Если начинается с 78 и длина 12, убираем 78 (оставляем 10 цифр)
                else if (value.startsWith('78') && value.length === 12) {
                  value = value.substring(2);
                }
                
                // Если 10 цифр, добавляем +7
                if (value.length === 10) {
                  input.value = '+7' + value;
                } else if (value.length > 0) {
                  // Сохраняем как есть, если не подходит под формат
                  input.value = value;
                }
              }
            });
          });
        });
      });

      // Обработчик подтверждения для форм холодного звонка
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.js-cold-call-form').forEach(function(form) {
          if (form.__coldCallBound) return;
          form.__coldCallBound = true;
          form.addEventListener('submit', function(e) {
            const confirmMessage = form.getAttribute('data-confirm');
            if (confirmMessage && !confirm(confirmMessage)) {
              e.preventDefault();
              return false;
            }
          });
        });
      });

      // Глобальный прогресс рассылки (polling)
      (function() {
        const widget = document.getElementById('mailProgressWidget');
        const circle = document.getElementById('mailProgressCircle');
        const pct = document.getElementById('mailProgressPct');
        const text = document.getElementById('mailProgressText');
        const counts = document.getElementById('mailProgressCounts');
        const closeBtn = document.getElementById('mailProgressClose');
        if (!widget || !circle || !pct || !text || !counts || !closeBtn) return;

        const STORAGE_KEY = 'mail_progress_dismissed_campaign';
        let dismissedForCampaignId = null;
        try {
          dismissedForCampaignId = window.localStorage.getItem(STORAGE_KEY) || null;
        } catch (_e) {
          dismissedForCampaignId = null;
        }

        async function poll() {
          try {
            const res = await fetch('/mail/progress/poll/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await res.json();
            if (!data || !data.ok || !data.active) {
              widget.classList.add('hidden');
              dismissedForCampaignId = null;
              return;
            }
            const a = data.active;
            const status = (a.status || '').toLowerCase();

            // Как только начинается отправка любой кампании — сбрасываем прежний dismiss,
            // чтобы прогресс новой отправки всегда был виден.
            if (status === 'sending') {
              dismissedForCampaignId = null;
              try { window.localStorage.removeItem(STORAGE_KEY); } catch (_e) {}
            }

            // Если пользователь закрыл виджет для этой завершённой кампании — не показываем
            if (status === 'sent' && dismissedForCampaignId === a.id) {
              widget.classList.add('hidden');
              return;
            }

            const p = Number(a.percent || 0);
            const deg = Math.max(0, Math.min(100, p)) * 3.6;
            widget.href = a.url || ('/mail/campaigns/' + a.id + '/');
            widget.classList.remove('hidden');
            pct.textContent = `${p}%`;
            text.textContent = a.name || 'Кампания';
            counts.textContent = `Отпр.: ${a.sent} · Ошибки: ${a.failed} · В очереди: ${a.pending}`;
            circle.style.background = `conic-gradient(var(--brand-teal) ${deg}deg, rgba(194,226,222,.6) ${deg}deg)`;

            // Крестик показываем только после завершения (SENT)
            if (status === 'sent') {
              closeBtn.classList.remove('hidden');
            } else {
              closeBtn.classList.add('hidden');
            }
          } catch (e) {
            // тихо: не мешаем работе
          }
        }

        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          widget.classList.add('hidden');
          // Запоминаем кампанию, для которой пользователь закрыл виджет
          const href = widget.getAttribute('href') || '';
          const match = href.match(/\/mail\/campaigns\/([^/]+)\//);
          if (match && match[1]) {
            dismissedForCampaignId = match[1];
            try {
              window.localStorage.setItem(STORAGE_KEY, dismissedForCampaignId);
            } catch (_e) {}
          }
        });

        // Первичный запуск + периодический polling
        poll();
        setInterval(poll, 4000);
      })();
    </script>
  </body>
</html>


