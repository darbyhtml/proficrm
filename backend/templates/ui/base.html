<!doctype html>
<html lang="ru">
  <head>
    {% load static %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex" />
    <meta name="googlebot" content="noindex, nofollow" />
    <title>{% block title %}CRM ПРОФИ{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="{% static 'ui/favicon-v2.svg' %}">
    <link rel="shortcut icon" href="{% static 'ui/favicon-v2.svg' %}">
    <meta name="theme-color" content="#01948E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                teal: "#01948E",
                orange: "#FDAD3A",
                dark: "#003D38",
                soft: "#C2E2DE",
              },
            },
          },
        },
      };
    </script>
    <style>
      :root{
        --brand-teal:#01948E;
        --brand-orange:#FDAD3A;
        --brand-dark:#003D38;
        --brand-soft:#C2E2DE;
      }
      .card{border:1px solid rgba(194,226,222,.9); border-radius:16px; background:#fff; box-shadow:0 1px 0 rgba(0,61,56,.04)}
      .card-pad{padding:16px}
      .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:12px; padding:.55rem .9rem; font-size:.875rem; line-height:1.1; transition:background-color .15s ease, border-color .15s ease, transform .05s ease}
      .btn:active{transform:scale(.99)}
      .btn-primary{background:var(--brand-teal); color:#fff}
      .btn-primary:hover{background:var(--brand-dark)}
      .btn-secondary{background:rgba(194,226,222,.35); border:1px solid rgba(194,226,222,.9); color:var(--brand-dark)}
      .btn-secondary:hover{background:rgba(194,226,222,.55)}
      .btn-outline{background:#fff; border:1px solid rgba(194,226,222,.9); color:var(--brand-dark)}
      .btn-outline:hover{background:rgba(194,226,222,.35)}
      .input,.select,.textarea{width:100%; border-radius:12px; border:1px solid rgba(194,226,222,.95); padding:.55rem .75rem; background:#fff; color:var(--brand-dark)}
      .textarea{min-height:96px}
      .input:focus,.select:focus,.textarea:focus{outline:none; box-shadow:0 0 0 4px rgba(1,148,142,.14); border-color:rgba(1,148,142,.65)}
      .muted{color:rgba(0,61,56,.72)}
      .muted-2{color:rgba(0,61,56,.55)}
      .badge{display:inline-flex; align-items:center; border-radius:999px; padding:.15rem .55rem; font-size:.75rem; border:1px solid rgba(194,226,222,.95); background:rgba(194,226,222,.35); color:var(--brand-dark); white-space:nowrap}
      .badge-warn{background:rgba(253,173,58,.22); border-color:rgba(253,173,58,.45)}
      .badge-new{background:rgba(1,148,142,.12); border-color:rgba(1,148,142,.35)}
      .badge-progress{background:rgba(253,173,58,.22); border-color:rgba(253,173,58,.45)}
      .badge-done{background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.35)}
      .badge-cancel{background:rgba(148,163,184,.18); border-color:rgba(148,163,184,.35); color:rgba(0,61,56,.75)}
      .badge-danger{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.30)}
      .task-overdue{border-color:rgba(239,68,68,.45)!important; background:rgba(239,68,68,.06)}
      .wrap-anywhere{overflow-wrap:anywhere; word-break:break-word}
      .wrap-anywhere a{overflow-wrap:anywhere; word-break:break-all}
      .table{width:100%; font-size:.875rem}
      .table th{background:rgba(194,226,222,.35); color:rgba(0,61,56,.82); text-align:left; padding:.85rem 1rem}
      .table td{padding:.85rem 1rem; border-top:1px solid rgba(194,226,222,.7); vertical-align:top}
      .table tr:hover td{background:rgba(194,226,222,.20)}
      a.link{ text-decoration:underline; text-underline-offset:2px }
      /* Icon alignment */
      .nav-ico-wrap{width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;flex:none}
      .nav-ico-wrap svg{display:block}
      /* Multiselect (checkbox dropdown) */
      .ms{position:relative}
      .ms-btn{width:100%; display:flex; align-items:center; justify-content:space-between; gap:.5rem; border-radius:12px; border:1px solid rgba(194,226,222,.95); padding:.55rem .75rem; background:#fff; color:var(--brand-dark)}
      .ms-btn:hover{background:rgba(194,226,222,.20)}
      .ms-value{font-size:.875rem}
      .ms-panel{position:absolute; left:0; right:0; top:calc(100% + 8px); z-index:60; border-radius:16px; border:1px solid rgba(194,226,222,.95); background:#fff; box-shadow:0 12px 30px rgba(0,61,56,.10); overflow:hidden}
      .ms-panel .ms-top{padding:10px 12px; border-bottom:1px solid rgba(194,226,222,.7); display:flex; gap:8px; align-items:center}
      .ms-panel .ms-search{flex:1}
      .ms-panel .ms-list{max-height:260px; overflow:auto; padding:8px}
      .ms-item{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px}
      .ms-item:hover{background:rgba(194,226,222,.25)}
      .ms-muted{color:rgba(0,61,56,.65); font-size:.75rem}
      
      /* Стилизация календарика (datetime-local и date) */
      input[type="datetime-local"],
      input[type="date"] {
        color-scheme: light;
      }
      
      /* Стилизация календарика в цветах проекта */
      input[type="datetime-local"]::-webkit-calendar-picker-indicator,
      input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 0.7;
        filter: invert(27%) sepia(51%) saturate(2878%) hue-rotate(142deg) brightness(94%) contrast(101%);
      }
      
      input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover,
      input[type="date"]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
      }
      
      /* Стилизация календарика для datetime-local (время) */
      input[type="datetime-local"]::-webkit-datetime-edit-text {
        color: var(--brand-dark);
      }
      
      input[type="datetime-local"]::-webkit-datetime-edit-month-field,
      input[type="datetime-local"]::-webkit-datetime-edit-day-field,
      input[type="datetime-local"]::-webkit-datetime-edit-year-field,
      input[type="datetime-local"]::-webkit-datetime-edit-hour-field,
      input[type="datetime-local"]::-webkit-datetime-edit-minute-field {
        color: var(--brand-dark);
      }
      
      input[type="datetime-local"]::-webkit-datetime-edit-month-field:focus,
      input[type="datetime-local"]::-webkit-datetime-edit-day-field:focus,
      input[type="datetime-local"]::-webkit-datetime-edit-year-field:focus,
      input[type="datetime-local"]::-webkit-datetime-edit-hour-field:focus,
      input[type="datetime-local"]::-webkit-datetime-edit-minute-field:focus {
        background-color: rgba(1,148,142,.1);
        color: var(--brand-teal);
        outline: none;
      }
      
      /* Стилизация календарика для date */
      input[type="date"]::-webkit-datetime-edit-text {
        color: var(--brand-dark);
      }
      
      input[type="date"]::-webkit-datetime-edit-month-field,
      input[type="date"]::-webkit-datetime-edit-day-field,
      input[type="date"]::-webkit-datetime-edit-year-field {
        color: var(--brand-dark);
      }
      
      input[type="date"]::-webkit-datetime-edit-month-field:focus,
      input[type="date"]::-webkit-datetime-edit-day-field:focus,
      input[type="date"]::-webkit-datetime-edit-year-field:focus {
        background-color: rgba(1,148,142,.15);
        color: var(--brand-teal);
        outline: none;
        border-radius: 4px;
      }
      
      /* Стилизация всплывающего календарика браузера через CSS переменные */
      input[type="datetime-local"],
      input[type="date"] {
        --calendar-bg: #fff;
        --calendar-border: rgba(194,226,222,.95);
        --calendar-text: var(--brand-dark);
        --calendar-selected-bg: var(--brand-teal);
        --calendar-selected-text: #fff;
        --calendar-hover-bg: rgba(194,226,222,.25);
        --calendar-today-border: var(--brand-teal);
        --calendar-time-selected-bg: var(--brand-teal);
        --calendar-time-selected-text: #fff;
      }
      
      /* Кастомный календарик */
      .custom-datetime-picker {
        position: relative;
      }
      
      .custom-datetime-picker input {
        width: 100%;
      }
      
      .custom-datetime-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
        pointer-events: none;
        display: none;
      }
      
      .custom-datetime-overlay.active {
        display: block;
        pointer-events: auto;
        background: rgba(0, 0, 0, 0.3);
      }
      
      .custom-datetime-popup {
        position: absolute;
        background: #fff;
        border: 1px solid rgba(194,226,222,.95);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,61,56,.15), 0 2px 4px rgba(0,61,56,.1);
        padding: 12px;
        z-index: 10001;
        width: 360px;
        max-height: none;
        overflow: visible;
        font-family: system-ui, -apple-system, sans-serif;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        min-height: 0;
      }
      
      .custom-datetime-popup .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        padding-bottom: 0;
        border-bottom: none;
      }
      
      .custom-datetime-popup .calendar-header .month-year {
        font-size: 14px;
        font-weight: 600;
        color: var(--brand-dark);
        cursor: pointer;
        padding: 4px 10px;
        border-radius: 6px;
        transition: all 0.2s ease;
        user-select: none;
      }
      
      .custom-datetime-popup .calendar-header .month-year:hover {
        background: rgba(194,226,222,.2);
      }
      
      .custom-datetime-popup .month-year-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding: 12px;
        max-height: 280px;
        overflow-y: auto;
      }
      
      .custom-datetime-popup .month-year-item {
        padding: 12px 8px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--brand-dark);
        transition: all 0.2s ease;
        border: 1px solid rgba(194,226,222,.3);
        background: #fff;
      }
      
      .custom-datetime-popup .month-year-item:hover {
        background: rgba(194,226,222,.15);
        border-color: var(--brand-teal);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,61,56,.1);
      }
      
      .custom-datetime-popup .month-year-item.selected {
        background: var(--brand-teal);
        color: #fff;
        font-weight: 600;
        border-color: var(--brand-teal);
        box-shadow: 0 2px 8px rgba(1,148,142,.3);
      }
      
      .custom-datetime-popup .year-selector {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        max-height: 320px;
        overflow-y: auto;
      }
      
      .custom-datetime-popup .year-decade-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 4px;
        margin-bottom: 4px;
      }
      
      .custom-datetime-popup .year-decade-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--brand-dark);
      }
      
      .custom-datetime-popup .year-decade-nav {
        display: flex;
        gap: 4px;
      }
      
      .custom-datetime-popup .year-decade-nav button {
        width: 24px;
        height: 24px;
        border: 1px solid rgba(194,226,222,.5);
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--brand-dark);
        font-size: 12px;
        transition: all 0.2s ease;
        padding: 0;
      }
      
      .custom-datetime-popup .year-decade-nav button:hover {
        background: rgba(194,226,222,.25);
        border-color: var(--brand-teal);
      }
      
      .custom-datetime-popup .year-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }
      
      .custom-datetime-popup .year-item {
        padding: 10px 8px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--brand-dark);
        transition: all 0.2s ease;
        border: 1px solid rgba(194,226,222,.3);
        background: #fff;
      }
      
      .custom-datetime-popup .year-item:hover {
        background: rgba(194,226,222,.15);
        border-color: var(--brand-teal);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,61,56,.1);
      }
      
      .custom-datetime-popup .year-item.selected {
        background: var(--brand-teal);
        color: #fff;
        font-weight: 600;
        border-color: var(--brand-teal);
        box-shadow: 0 2px 8px rgba(1,148,142,.3);
      }
      
      .custom-datetime-popup .calendar-header .nav-buttons {
        display: flex;
        gap: 2px;
      }
      
      .custom-datetime-popup .calendar-header button {
        width: 26px;
        height: 26px;
        border: 1px solid rgba(194,226,222,.5);
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--brand-dark);
        font-size: 16px;
        font-weight: 600;
        transition: all 0.2s ease;
        padding: 0;
      }
      
      .custom-datetime-popup .calendar-header button:hover {
        background: rgba(194,226,222,.2);
        border-color: var(--brand-teal);
      }
      
      .custom-datetime-popup .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 3px;
        margin-bottom: 6px;
      }
      
      .custom-datetime-popup .calendar-weekdays span {
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        color: rgba(0,61,56,.6);
        padding: 3px;
      }
      
      .custom-datetime-popup .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-bottom: 0;
      }
      
      .custom-datetime-popup .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: var(--brand-dark);
        transition: all 0.2s ease;
        min-height: 30px;
      }
      
      .custom-datetime-popup .calendar-day:hover {
        background: rgba(194,226,222,.2);
      }
      
      .custom-datetime-popup .calendar-day.other-month {
        color: rgba(0,61,56,.25);
        opacity: 0.6;
      }
      
      .custom-datetime-popup .calendar-day.today {
        border: 1px solid var(--brand-teal);
        font-weight: 600;
        background: rgba(194,226,222,.1);
      }
      
      .custom-datetime-popup .calendar-day.selected {
        background: var(--brand-teal);
        color: #fff;
        border-color: var(--brand-teal);
        font-weight: 600;
      }
      
      .custom-datetime-popup .calendar-time-wrapper {
        display: flex;
        gap: 12px;
        align-items: stretch;
        padding-top: 8px;
        border-top: 1px solid rgba(194,226,222,.7);
        flex: 1;
        min-height: 0;
      }
      
      .custom-datetime-popup .calendar-section {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      
      .custom-datetime-popup .time-picker {
        display: flex;
        gap: 8px;
        flex: 0 0 auto;
        min-width: 90px;
        padding-left: 10px;
        border-left: 1px solid rgba(194,226,222,.5);
        align-self: stretch;
        min-height: 0;
      }
      
      .custom-datetime-popup .time-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 0;
        height: 100%;
      }
      
      .custom-datetime-popup .time-column-label {
        font-size: 10px;
        font-weight: 600;
        color: rgba(0,61,56,.7);
        margin-bottom: 4px;
        flex-shrink: 0;
      }
      
      .custom-datetime-popup .time-scroll {
        width: 100%;
        flex: 1 1 auto;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        gap: 2px;
        padding: 4px 0;
        scrollbar-width: thin;
        scrollbar-color: rgba(194,226,222,.6) transparent;
        min-height: 0;
        max-height: 100%;
      }
      
      .custom-datetime-popup .time-item {
        padding: 4px 6px;
        text-align: center;
        border-radius: 5px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
        color: var(--brand-dark);
        transition: all 0.2s ease;
        min-height: 20px;
        height: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
        flex-shrink: 0;
      }
      
      /* Кастомный скроллбар для WebKit */
      .custom-datetime-popup .time-scroll::-webkit-scrollbar {
        width: 4px;
      }
      
      .custom-datetime-popup .time-scroll::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 2px;
      }
      
      .custom-datetime-popup .time-scroll::-webkit-scrollbar-thumb {
        background: rgba(194,226,222,.6);
        border-radius: 2px;
        transition: background 0.2s ease;
      }
      
      .custom-datetime-popup .time-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(1,148,142,.7);
      }
      
      .custom-datetime-popup .time-item {
        padding: 5px 8px;
        text-align: center;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        color: var(--brand-dark);
        transition: all 0.2s ease;
        min-height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
      }
      
      .custom-datetime-popup .time-item:hover {
        background: rgba(194,226,222,.2);
        border-color: rgba(194,226,222,.5);
      }
      
      .custom-datetime-popup .time-item.selected {
        background: var(--brand-teal);
        color: #fff;
        font-weight: 600;
        border-color: var(--brand-teal);
      }
      
      .custom-datetime-popup .calendar-actions {
        display: flex;
        justify-content: space-between;
        gap: 6px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(194,226,222,.7);
        flex-shrink: 0;
        flex-grow: 0;
      }
      
      .custom-datetime-popup .calendar-actions button {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid rgba(194,226,222,.6);
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
        color: var(--brand-dark);
        transition: all 0.2s ease;
      }
      
      .custom-datetime-popup .calendar-actions button.btn-primary {
        background: var(--brand-teal);
        color: #fff;
        border-color: var(--brand-teal);
      }
      
      .custom-datetime-popup .calendar-actions button.btn-delete {
        color: #dc2626;
        border-color: rgba(220,38,38,.3);
      }
      
      .custom-datetime-popup .calendar-actions button.btn-delete:hover {
        background: rgba(220,38,38,.1);
        border-color: rgba(220,38,38,.5);
      }
      
      .custom-datetime-popup .calendar-actions button:hover {
        box-shadow: 0 1px 4px rgba(0,61,56,.1);
      }
      
      .custom-datetime-popup .calendar-actions button.btn-primary:hover {
        box-shadow: 0 2px 8px rgba(1,148,142,.3);
      }
        background: rgba(194,226,222,.25);
      }
      
      .custom-datetime-popup .calendar-actions button.btn-primary {
        background: var(--brand-teal);
        color: #fff;
        border-color: var(--brand-teal);
      }
      
      .custom-datetime-popup .calendar-actions button.btn-primary:hover {
        background: var(--brand-dark);
      }
    </style>
  </head>
  <body class="bg-brand-soft/40 text-brand-dark">
    <div class="min-h-screen">
      <header class="border-b border-brand-soft bg-white/80 backdrop-blur">
        <div class="mx-auto max-w-screen-2xl px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button id="menuBtn" type="button" class="md:hidden rounded-xl border border-brand-soft bg-white px-2.5 py-2 hover:bg-brand-soft/40 active:scale-[0.99]" aria-label="Меню">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
            </button>
            <a href="/" class="font-semibold tracking-tight text-brand-dark">CRM ПРОФИ</a>
            <span class="text-xs text-brand-dark/70">простая, как amo, но без лишнего</span>
          </div>
          <div class="flex items-center gap-3 text-sm">
            {% if is_admin and view_as_enabled %}
              <form method="post" action="{% url 'view_as_update' %}" class="hidden md:flex items-center gap-2 text-xs mr-2">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <div class="flex items-center gap-1">
                  <span class="text-brand-dark/60">Роль:</span>
                  <select name="view_role" class="select w-auto py-1 px-2 text-xs">
                    <option value="">Администратор</option>
                    {% for value,label in view_as_roles %}
                      <option value="{{ value }}" {% if view_as_role == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-brand-dark/60">Филиал:</span>
                  <select name="view_as_branch_id" class="select w-auto py-1 px-2 text-xs">
                    <option value="">Все</option>
                    {% for b in view_as_branches %}
                      <option value="{{ b.id }}" {% if view_as_branch and view_as_branch.id == b.id %}selected{% endif %}>{{ b.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" class="btn btn-outline py-1 px-2 text-xs">Применить</button>
                {% if view_as_role or view_as_branch %}
                  <a href="{% url 'view_as_reset' %}" class="text-xs text-brand-dark/60 underline">Сброс</a>
                {% endif %}
              </form>
            {% endif %}

            <div class="relative">
              <button id="notifBtn" type="button" class="relative rounded-xl border border-brand-soft bg-white px-2.5 py-2 hover:bg-brand-soft/40 active:scale-[0.99]" aria-label="Уведомления">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
                  <path d="M13.73 21a2 2 0 01-3.46 0"/>
                </svg>
                <span id="bellBadge" class="absolute -top-1 -right-1 inline-flex items-center justify-center min-w-[18px] h-[18px] px-1 rounded-full bg-brand-orange text-brand-dark text-[11px] font-semibold border border-white {% if not bell_count or bell_count <= 0 %}hidden{% endif %}">
                  {{ bell_count|default:0 }}
                </span>
              </button>

              <div id="notifPanel" class="hidden absolute right-0 mt-2 w-[360px] max-w-[90vw] card overflow-hidden z-[300]">
                <div class="px-4 py-3 border-b border-brand-soft bg-white">
                  <div class="flex items-center justify-between">
                    <div class="font-medium">Уведомления</div>
                    <div class="flex items-center gap-2">
                      <button id="notifEnableBrowser" type="button" class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" title="Разрешить уведомления браузера">Браузер</button>
                      <form method="post" action="/notifications/mark-all-read/" id="notifMarkAllForm">
                        {% csrf_token %}
                        <button class="btn btn-outline" style="padding:.35rem .6rem;font-size:.75rem" type="submit">Прочитано</button>
                      </form>
                    </div>
                  </div>
                  <div class="text-xs muted mt-1">
                    Новые: <b id="notifUnreadCount">{{ notif_unread_count|default:0 }}</b> · Напоминания: <b id="reminderCount">{{ reminder_count|default:0 }}</b>
                  </div>
                </div>

                <div class="max-h-[420px] overflow-auto bg-white">
                  {% if reminder_items %}
                    <div class="px-4 pt-3 pb-2 flex items-center justify-between">
                      <span class="text-xs muted">Напоминания</span>
                      {% if reminder_count > reminder_items|length %}
                        <a href="/notifications/reminders/all/" class="text-xs link">Показать все ({{ reminder_count }})</a>
                      {% endif %}
                    </div>
                    <div class="px-2 pb-2" id="reminderList">
                      {% for r in reminder_items %}
                        <a class="block rounded-xl border border-brand-soft px-3 py-2 mb-2 hover:bg-brand-soft/25" href="{{ r.url }}">
                          <div class="text-sm font-medium">{{ r.title }}</div>
                          {% if r.subtitle %}<div class="text-xs muted mt-0.5">{{ r.subtitle }}</div>{% endif %}
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}

                  <div class="px-4 pt-3 pb-2 flex items-center justify-between">
                    <span class="text-xs muted">Новые</span>
                    {% if notif_unread_count > notif_items|length %}
                      <a href="/notifications/all/" class="text-xs link">Показать все ({{ notif_unread_count }})</a>
                    {% endif %}
                  </div>
                  <div class="px-2 pb-3" id="notifList">
                    {% for n in notif_items %}
                      <div class="rounded-xl border border-brand-soft px-3 py-2 mb-2 bg-brand-soft/20" data-notif-id="{{ n.id }}">
                        <div class="flex items-start justify-between gap-2">
                          <div>
                            <div class="text-sm font-medium">{{ n.title }}</div>
                            {% if n.body %}<div class="text-xs muted mt-0.5">{{ n.body|truncatechars:140 }}</div>{% endif %}
                            <div class="text-[11px] muted-2 mt-1">{{ n.created_at }}</div>
                          </div>
                          <form method="post" action="/notifications/{{ n.id }}/read/" class="js-notif-read-form">
                            {% csrf_token %}
                            <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" type="submit" title="Отметить прочитанным">✓</button>
                          </form>
                        </div>
                        {% if n.url %}
                          <a class="link text-sm mt-2 inline-block" href="{{ n.url }}">Открыть</a>
                        {% endif %}
                      </div>
                    {% empty %}
                      <div class="px-2 pb-3 muted text-sm" id="notifEmpty">Уведомлений пока нет.</div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            <span class="text-brand-dark/80">
              {% if request.user.first_name or request.user.last_name %}
                {{ request.user.last_name }} {{ request.user.first_name }}
              {% else %}
                {{ request.user.get_username }}
              {% endif %}
            </span>
            <form method="post" action="/logout/">
              {% csrf_token %}
              <button class="rounded-lg border border-brand-soft bg-white px-3 py-1.5 hover:bg-brand-soft/40 active:scale-[0.99]">Выйти</button>
            </form>
          </div>
        </div>
        {% if is_admin %}
          {% if view_as_enabled %}
            {% if view_as_role or view_as_branch %}
            <div class="border-t border-brand-soft bg-amber-50/90">
              <div class="mx-auto max-w-screen-2xl px-4 py-1.5 text-[11px] md:text-xs text-amber-900 flex flex-col md:flex-row items-start md:items-center justify-between gap-1.5">
                <div>
                  <span class="font-semibold">Режим просмотра администратора:</span>
                  <span>
                    роль —
                    {% if view_as_role_label %}
                      {{ view_as_role_label }}
                    {% else %}
                      Администратор
                    {% endif %}
                  </span>
                  <span>
                    · филиал —
                    {% if view_as_branch %}
                      {{ view_as_branch.name }}
                    {% else %}
                      все
                    {% endif %}
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-amber-900/85">Права и ограничения не меняются, меняется только отображение и фильтры.</span>
                  <a href="{% url 'view_as_reset' %}" class="text-amber-900 underline">Сбросить</a>
                </div>
              </div>
            </div>
            {% endif %}
          {% endif %}
        {% endif %}
      </header>

      <div class="mx-auto max-w-screen-2xl px-4 py-6 flex flex-col md:flex-row gap-5">
        <div id="sidebarOverlay" class="hidden md:hidden fixed inset-0 bg-black/30 z-40"></div>
        <aside class="md:w-[200px] md:flex-shrink-0">
          <div id="sidebarDrawer" class="bg-white border border-brand-soft rounded-xl p-2 md:sticky md:top-4
               md:block fixed z-50 inset-y-0 left-0 w-[280px] max-w-[85vw] md:w-auto
               transform -translate-x-full md:translate-x-0 transition-transform duration-150 ease-out
               overflow-y-auto">

            <div class="md:hidden flex items-center justify-between px-2 py-2 border-b border-brand-soft mb-2">
              <div class="font-semibold">Меню</div>
              <button id="menuCloseBtn" type="button" class="rounded-xl border border-brand-soft bg-white px-2.5 py-2 hover:bg-brand-soft/40 active:scale-[0.99]" aria-label="Закрыть">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <nav class="space-y-1">
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'dashboard' %}bg-brand-soft/50 font-medium{% endif %}" href="/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/></svg>
                </span>
                <span>Рабочий стол</span>
              </a>
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'task_list' or request.resolver_match.url_name == 'task_create' or request.resolver_match.url_name == 'task_edit' %}bg-brand-soft/50 font-medium{% endif %}" href="/tasks/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                </span>
                <span>Задачи</span>
              </a>
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'company_list' or request.resolver_match.url_name == 'company_detail' or request.resolver_match.url_name == 'company_create' or request.resolver_match.url_name == 'company_edit' %}bg-brand-soft/50 font-medium{% endif %}" href="/companies/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v14"/><path d="M9 21V9h6v12"/><path d="M9 13h6"/></svg>
                </span>
                <span>Списки (компании)</span>
              </a>
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.path|slice:':6' == '/mail/' %}bg-brand-soft/50 font-medium{% endif %}" href="/mail/campaigns/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 6h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"/>
                    <path d="m22 8-10 6L2 8"/>
                  </svg>
                </span>
                <span>Почта</span>
              </a>
              {% if view_can_view_activity %}
                <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'analytics' or request.resolver_match.url_name == 'analytics_user' %}bg-brand-soft/50 font-medium{% endif %}" href="/analytics/">
                  <span class="nav-ico-wrap">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 14l4-4 4 3 5-7"/></svg>
                  </span>
                  <span>Аналитика</span>
                </a>
              {% endif %}
              <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name == 'help' %}bg-brand-soft/50 font-medium{% endif %}" href="/help/">
                <span class="nav-ico-wrap">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <path d="M12 17h.01"/>
                  </svg>
                </span>
                <span>Помощь</span>
              </a>
              {% if view_is_admin %}
                <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm {% if request.resolver_match.url_name|slice:':9' == 'settings_' %}bg-brand-soft/50 font-medium{% endif %}" href="/settings/">
                  <span class="nav-ico-wrap">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 21v-7"/>
                      <path d="M4 10V3"/>
                      <path d="M12 21v-9"/>
                      <path d="M12 8V3"/>
                      <path d="M20 21v-5"/>
                      <path d="M20 12V3"/>
                      <path d="M2 14h4"/>
                      <path d="M10 12h4"/>
                      <path d="M18 16h4"/>
                    </svg>
                  </span>
                  <span>Настройки</span>
                </a>
              {% endif %}
              {% if view_is_admin %}
                <a class="flex items-center gap-2 px-2.5 py-2 rounded-lg hover:bg-brand-soft/40 text-sm" href="/admin/">
                  <span class="nav-ico-wrap">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  </span>
                  <span>Админка</span>
                </a>
              {% endif %}
            </nav>
            
            <!-- Плитка "Мобильное приложение" под меню -->
            <div class="mt-4 pt-4 border-t border-brand-soft">
              <a href="{% url 'mobile_app_page' %}" class="block rounded-xl border border-brand-soft bg-gradient-to-br from-brand-soft/30 to-white p-3 hover:bg-brand-soft/50 transition-colors">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 mt-0.5">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#003D38" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z"/>
                    </svg>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-sm text-brand-dark">Мобильное приложение</div>
                    <div class="text-xs text-brand-dark/70 mt-0.5">Быстрая установка и вход по QR</div>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </aside>

        <main class="flex-1 min-w-0">
          {% if messages %}
            <div class="space-y-2 mb-4">
              {% for message in messages %}
                {% if 'error' in message.tags %}
                  <div class="rounded-xl border border-brand-orange/40 bg-brand-orange/15 px-4 py-3 text-sm text-brand-dark">
                    {{ message }}
                  </div>
                {% elif 'warning' in message.tags %}
                  <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
                    {{ message }}
                  </div>
                {% elif 'success' in message.tags %}
                  <div class="rounded-xl border border-brand-teal/40 bg-brand-teal/10 px-4 py-3 text-sm text-brand-dark">
                    {{ message }}
                  </div>
                {% else %}
                  <div class="rounded-xl border border-brand-soft bg-white px-4 py-3 text-sm text-brand-dark">
                    {{ message }}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
          {% block content %}{% endblock %}
        </main>
      </div>
    </div>

    {# Глобальный прогресс рассылки (показывается только если есть активная отправка) #}
    <a id="mailProgressWidget" href="#" class="hidden fixed bottom-5 left-5 z-50 bg-white border border-brand-soft rounded-2xl shadow-lg px-3 py-2 flex items-center gap-3 hover:bg-brand-soft/20" style="min-width:210px; position:fixed;">
      <div id="mailProgressCircle" class="w-10 h-10 rounded-full flex items-center justify-center text-xs font-semibold" style="background:conic-gradient(var(--brand-teal) 0deg, rgba(194,226,222,.6) 0deg); color:var(--brand-dark); border:1px solid rgba(194,226,222,.9)">
        <span id="mailProgressPct">0%</span>
      </div>
      <div class="leading-tight relative pr-5">
        <div class="text-xs muted">Рассылка</div>
        <div id="mailProgressText" class="text-sm font-medium">—</div>
        <div id="mailProgressCounts" class="text-[11px] muted-2">—</div>
        <button id="mailProgressClose" type="button" class="hidden absolute -top-1 -right-1 w-5 h-5 flex items-center justify-center rounded-full border border-brand-soft bg-white text-brand-dark/60 hover:text-red-500 hover:border-red-400 transition-colors" title="Закрыть">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18"/>
            <path d="M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </a>

    <script>
      (function(){
        const btn = document.getElementById('notifBtn');
        const panel = document.getElementById('notifPanel');
        if(!btn || !panel) return;
        function close(){ panel.classList.add('hidden'); }
        function toggle(){ panel.classList.toggle('hidden'); }
        btn.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
        panel.addEventListener('click', function(e){ e.stopPropagation(); });
        document.addEventListener('click', close);
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape') close(); });
      })();
    </script>
    <script>
      // Live notifications (polling). Без WebSocket, безопасно: если JS не работает — всё как раньше.
      (function(){
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return '';
        }
        function escapeHtml(s){
          // replaceAll может отсутствовать в некоторых браузерах — используем регулярки
          return String(s || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        const csrftoken = getCookie('csrftoken');
        const badge = document.getElementById('bellBadge');
        const notifCountEl = document.getElementById('notifUnreadCount');
        const reminderCountEl = document.getElementById('reminderCount');
        const notifList = document.getElementById('notifList');
        const reminderList = document.getElementById('reminderList');
        const markAllForm = document.getElementById('notifMarkAllForm');
        const enableBrowserBtn = document.getElementById('notifEnableBrowser');

        const BROWSER_KEY = 'crm_notif_browser_enabled';

        function getBool(key, defVal){
          try{
            const v = localStorage.getItem(key);
            if(v === null || v === undefined) return !!defVal;
            return v === '1';
          }catch(_e){
            return !!defVal;
          }
        }
        function setBool(key, val){
          try{ localStorage.setItem(key, val ? '1' : '0'); }catch(_e){}
        }
        let browserEnabled = getBool(BROWSER_KEY, false);

        function updateTogglesUI(){
          if(enableBrowserBtn){
            enableBrowserBtn.classList.toggle('btn-primary', !!browserEnabled);
            enableBrowserBtn.classList.toggle('btn-outline', !browserEnabled);
          }
        }

        function showToast(text, kind){
          try{
            const id = 'notifToast';
            let el = document.getElementById(id);
            if(!el){
              el = document.createElement('div');
              el.id = id;
              el.style.position = 'fixed';
              el.style.right = '16px';
              el.style.bottom = '16px';
              el.style.zIndex = '90';
              el.style.maxWidth = '92vw';
              el.style.display = 'none';
              el.innerHTML = '<div style="border:1px solid rgba(194,226,222,.95);background:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 12px 30px rgba(0,61,56,.10);font-size:13px;color:#003D38"></div>';
              document.body.appendChild(el);
            }
            const box = el.firstElementChild;
            if(box){
              box.textContent = text || '';
              const k = String(kind || '');
              if(k === 'error'){
                box.style.borderColor = 'rgba(239,68,68,.30)';
                box.style.background = 'rgba(239,68,68,.08)';
              }else if(k === 'success'){
                box.style.borderColor = 'rgba(16,185,129,.30)';
                box.style.background = 'rgba(16,185,129,.06)';
              }else{
                box.style.borderColor = 'rgba(194,226,222,.95)';
                box.style.background = '#fff';
              }
            }
            el.style.display = 'block';
            clearTimeout(el.__t);
            el.__t = setTimeout(() => { el.style.display = 'none'; }, 2400);
          }catch(_e){}
        }

        // Глобальный toast для остальных страниц (company_detail и т.п.)
        window.uiToast = showToast;

        function showBrowserNotification(n){
          if(!browserEnabled) return;
          if(!('Notification' in window)) return;
          if(!window.isSecureContext) return; // браузерные уведомления в небезопасном контексте часто запрещены
          if(Notification.permission !== 'granted') return;
          try{
            const title = n.title || 'CRM ПРОФИ';
            const body = (n.body || '').slice(0, 180);
            const url = n.url || '';
            const notif = new Notification(title, {
              body,
              tag: 'crm_' + (n.id || ''),
              // Используем системный/браузерный звук уведомлений (если браузер/ОС его позволяют).
              silent: false,
              icon: '/static/ui/favicon-v2.svg',
            });
            notif.onclick = () => {
              try{ window.focus(); }catch(_e){}
              if(url) window.location.href = url;
              notif.close && notif.close();
            };
            setTimeout(() => { try{ notif.close && notif.close(); }catch(_e){} }, 8000);
          }catch(_e){}
        }

        let lastIds = new Set();
        document.querySelectorAll('[data-notif-id]').forEach(el => {
          const id = el.getAttribute('data-notif-id');
          if (id) lastIds.add(id);
        });

        function updateBadge(count){
          if(!badge) return;
          const c = Number(count || 0);
          badge.textContent = String(c);
          if(c > 0) badge.classList.remove('hidden');
          else badge.classList.add('hidden');
        }

        function bindNotifActions(){
          // AJAX mark read
          document.querySelectorAll('.js-notif-read-form').forEach(f => {
            if (f.__bound) return;
            f.__bound = true;
            f.addEventListener('submit', async (e) => {
              e.preventDefault();
              const action = f.getAttribute('action') || '';
              try{
                await fetch(action, {method:'POST', headers:{'X-CSRFToken': csrftoken}, credentials:'same-origin'});
              }catch(_e){}
              pollOnce();
            });
          });
          // AJAX mark all
          if(markAllForm && !markAllForm.__bound){
            markAllForm.__bound = true;
            markAllForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const action = markAllForm.getAttribute('action') || '';
              try{
                await fetch(action, {method:'POST', headers:{'X-CSRFToken': csrftoken}, credentials:'same-origin'});
              }catch(_e){}
              pollOnce();
            });
          }
        }

        function renderReminders(items, totalCount){
          if(!reminderList) return;
          const arr = Array.isArray(items) ? items : [];
          if(!arr.length){
            reminderList.innerHTML = '';
            return;
          }
          reminderList.innerHTML = arr.map(r => {
            const title = escapeHtml(r.title);
            const subtitle = escapeHtml(r.subtitle || '');
            const url = escapeHtml(r.url || '#');
            return `<a class="block rounded-xl border border-brand-soft px-3 py-2 mb-2 hover:bg-brand-soft/25" href="${url}">
              <div class="text-sm font-medium">${title}</div>
              ${subtitle ? `<div class="text-xs muted mt-0.5">${subtitle}</div>` : ''}
            </a>`;
          }).join('');
          
          // Обновляем заголовок с кнопкой "Показать все"
          const reminderHeader = reminderList.previousElementSibling;
          if(reminderHeader){
            const existingLink = reminderHeader.querySelector('a');
            if(totalCount && totalCount > arr.length){
              if(!existingLink){
                const showAllLink = document.createElement('a');
                showAllLink.href = '/notifications/reminders/all/';
                showAllLink.className = 'text-xs link';
                showAllLink.textContent = `Показать все (${totalCount})`;
                reminderHeader.appendChild(showAllLink);
              } else {
                existingLink.textContent = `Показать все (${totalCount})`;
              }
            } else if(existingLink){
              existingLink.remove();
            }
          }
        }

        function renderNotifs(items, totalCount){
          if(!notifList) return;
          const arr = Array.isArray(items) ? items : [];
          if(!arr.length){
            notifList.innerHTML = '<div class="px-2 pb-3 muted text-sm" id="notifEmpty">Уведомлений пока нет.</div>';
            return;
          }
          notifList.innerHTML = arr.map(n => {
            const id = escapeHtml(n.id);
            const title = escapeHtml(n.title);
            const body = escapeHtml(n.body || '');
            const created = escapeHtml(n.created_at || '');
            const url = escapeHtml(n.url || '');
            const openLink = url ? `<a class="link text-sm mt-2 inline-block" href="${url}">Открыть</a>` : '';
            const bodyShort = body ? (body.length > 140 ? body.slice(0, 140) + '…' : body) : '';
            return `<div class="rounded-xl border border-brand-soft px-3 py-2 mb-2 bg-brand-soft/20" data-notif-id="${id}">
              <div class="flex items-start justify-between gap-2">
                <div>
                  <div class="text-sm font-medium">${title}</div>
                  ${bodyShort ? `<div class="text-xs muted mt-0.5">${bodyShort}</div>` : ''}
                  <div class="text-[11px] muted-2 mt-1">${created}</div>
                </div>
                <form method="post" action="/notifications/${id}/read/" class="js-notif-read-form">
                  <button class="btn btn-outline" style="padding:.25rem .5rem;font-size:.75rem" type="submit" title="Отметить прочитанным">✓</button>
                </form>
              </div>
              ${openLink}
            </div>`;
          }).join('');
          
          // Обновляем заголовок с кнопкой "Показать все"
          const notifHeader = notifList.previousElementSibling;
          if(notifHeader){
            const existingLink = notifHeader.querySelector('a');
            if(totalCount && totalCount > arr.length){
              if(!existingLink){
                const showAllLink = document.createElement('a');
                showAllLink.href = '/notifications/all/';
                showAllLink.className = 'text-xs link';
                showAllLink.textContent = `Показать все (${totalCount})`;
                notifHeader.appendChild(showAllLink);
              } else {
                existingLink.textContent = `Показать все (${totalCount})`;
              }
            } else if(existingLink){
              existingLink.remove();
            }
          }
        }

        let pollInFlight = false;
        async function pollOnce(){
          if(pollInFlight) return;
          pollInFlight = true;
          try{
            const res = await fetch('/notifications/poll/', {credentials:'same-origin'});
            const data = await res.json().catch(() => null);
            if(!data || !data.ok) return;
            updateBadge(data.bell_count);
            if(notifCountEl) notifCountEl.textContent = String(data.notif_unread_count || 0);
            if(reminderCountEl) reminderCountEl.textContent = String(data.reminder_count || 0);

            const newIds = new Set((data.notif_items || []).map(n => String(n.id)));
            const hasNew = Array.from(newIds).some(id => !lastIds.has(id));
            const newest = (data.notif_items && data.notif_items.length) ? data.notif_items[0] : null;
            lastIds = newIds;

            renderReminders(data.reminder_items || [], data.reminder_count || 0);
            renderNotifs(data.notif_items || [], data.notif_unread_count || 0);
            bindNotifActions();

            // лёгкий лайв-сигнал: кольцо на колокольчике
            if(hasNew){
              const btn = document.getElementById('notifBtn');
              if(btn){
                btn.classList.add('ring-4','ring-brand-teal/15');
                setTimeout(() => btn.classList.remove('ring-4','ring-brand-teal/15'), 1200);
              }
              // Браузерное уведомление + системный/браузерный звук (если браузер/ОС его позволяют)
              if(newest) showBrowserNotification(newest);
            }
          }catch(_e){
          }finally{
            pollInFlight = false;
          }
        }

        bindNotifActions();
        updateTogglesUI();

        if(enableBrowserBtn && !enableBrowserBtn.__bound){
          enableBrowserBtn.__bound = true;
          enableBrowserBtn.addEventListener('click', async () => {
            if(!('Notification' in window)){
              showToast('Браузерные уведомления не поддерживаются.', 'error');
              return;
            }
            if(!window.isSecureContext){
              showToast('Браузерные уведомления работают только по HTTPS.', 'error');
              return;
            }
            try{
              const perm = await Notification.requestPermission();
              browserEnabled = (perm === 'granted');
              setBool(BROWSER_KEY, browserEnabled);
              updateTogglesUI();
              if(!browserEnabled) {
                showToast('Разрешение не выдано. Уведомления браузера отключены.', 'error');
              } else {
                showToast('Браузерные уведомления включены.', 'success');
                // тестовое уведомление, чтобы было понятно что всё включилось
                showBrowserNotification({id:'test', title:'CRM ПРОФИ', body:'Браузерные уведомления включены', url:''});
              }
            }catch(_e){}
          });
        }

        pollOnce();
        setInterval(pollOnce, 15000);
      })();
    </script>
    <script>
      (function(){
        const openBtn = document.getElementById('menuBtn');
        const closeBtn = document.getElementById('menuCloseBtn');
        const drawer = document.getElementById('sidebarDrawer');
        const overlay = document.getElementById('sidebarOverlay');
        if(!drawer) return;
        function open(){
          drawer.classList.remove('-translate-x-full');
          if(overlay){ overlay.classList.remove('hidden'); }
        }
        function close(){
          drawer.classList.add('-translate-x-full');
          if(overlay){ overlay.classList.add('hidden'); }
        }
        if(openBtn) openBtn.addEventListener('click', function(e){ e.stopPropagation(); open(); });
        if(closeBtn) closeBtn.addEventListener('click', function(e){ e.stopPropagation(); close(); });
        if(overlay) overlay.addEventListener('click', close);
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape') close(); });
      })();
    </script>
    <script>
      // Checkbox multiselect over <select multiple>
      (function(){
        function initOne(root){
          const select = root.querySelector('select[multiple]');
          if(!select) return;
          // hide original select but keep in DOM for submit
          select.classList.add('hidden');

          const btn = root.querySelector('.ms-btn');
          const valueEl = root.querySelector('.ms-value');
          const panel = root.querySelector('.ms-panel');
          const search = root.querySelector('.ms-search');
          const list = root.querySelector('.ms-list');
          const clearBtn = root.querySelector('[data-ms-clear]');

          function selectedTexts(){
            const selected = Array.from(select.options).filter(o => o.selected).map(o => o.text.trim()).filter(Boolean);
            return selected;
          }
          function renderValue(){
            const sel = selectedTexts();
            valueEl.textContent = sel.length ? sel.join(', ') : (root.getAttribute('data-placeholder') || 'Выберите…');
          }
          function renderList(filter){
            const f = (filter || '').toLowerCase().trim();
            list.innerHTML = '';
            const opts = Array.from(select.options);
            for(const o of opts){
              const label = (o.text || '').trim();
              if(!label) continue;
              if(f && !label.toLowerCase().includes(f)) continue;
              const row = document.createElement('label');
              row.className = 'ms-item';
              const cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.checked = !!o.selected;
              cb.addEventListener('change', () => {
                o.selected = cb.checked;
                renderValue();
              });
              const span = document.createElement('span');
              span.textContent = label;
              row.appendChild(cb);
              row.appendChild(span);
              list.appendChild(row);
            }
            if(!list.children.length){
              const empty = document.createElement('div');
              empty.className = 'ms-muted px-1 py-2';
              empty.textContent = 'Ничего не найдено';
              list.appendChild(empty);
            }
          }

          function open(){
            panel.classList.remove('hidden');
            renderList(search.value);
            search.focus();
          }
          function close(){
            panel.classList.add('hidden');
            search.value = '';
          }

          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if(panel.classList.contains('hidden')) open(); else close();
          });
          panel.addEventListener('click', (e) => e.stopPropagation());
          document.addEventListener('click', close);
          document.addEventListener('keydown', (e) => { if(e.key === 'Escape') close(); });

          search.addEventListener('input', () => renderList(search.value));
          if(clearBtn){
            clearBtn.addEventListener('click', (e) => {
              e.preventDefault();
              for(const o of Array.from(select.options)) o.selected = false;
              renderValue();
              renderList(search.value);
            });
          }

          // initial
          renderValue();
        }

        function initAll(){
          document.querySelectorAll('[data-ms="1"]').forEach(initOne);
        }
        document.addEventListener('DOMContentLoaded', initAll);
      })();
    </script>
    <script>
      // Searchable single select over <select> (not multiple)
      (function(){
        const MAX_RENDER = 200;

        function initOne(root){
          const select = root.querySelector('select:not([multiple])');
          if(!select) return;
          // hide original select but keep in DOM for submit
          select.classList.add('hidden');

          const btn = root.querySelector('.ms-btn');
          const valueEl = root.querySelector('.ms-value');
          const panel = root.querySelector('.ms-panel');
          const search = root.querySelector('.ms-search');
          const list = root.querySelector('.ms-list');
          const clearBtn = root.querySelector('[data-ms-clear]');

          function selectedText(){
            const o = select.options[select.selectedIndex];
            const txt = (o && (o.text || '').trim()) || '';
            const val = (o && (o.value || '').trim()) || '';
            if(!val) return '';
            return txt;
          }
          function renderValue(){
            const txt = selectedText();
            valueEl.textContent = txt || (root.getAttribute('data-placeholder') || 'Выберите…');
          }
          function renderList(filter){
            const f = (filter || '').toLowerCase().trim();
            list.innerHTML = '';
            const opts = Array.from(select.options);

            // special "empty" option (value == "")
            const emptyOpt = opts.find(o => !((o.value || '').trim()));
            const emptyLabel = (emptyOpt && (emptyOpt.text || '').trim()) || '— Не выбрано —';
            const emptyRow = document.createElement('label');
            emptyRow.className = 'ms-item';
            const emptyRb = document.createElement('input');
            emptyRb.type = 'radio';
            emptyRb.name = '__ms_single_' + (select.name || 'x');
            emptyRb.checked = !((select.value || '').trim());
            emptyRb.addEventListener('change', () => {
              select.value = '';
              renderValue();
            });
            const emptySpan = document.createElement('span');
            emptySpan.textContent = emptyLabel;
            emptyRow.appendChild(emptyRb);
            emptyRow.appendChild(emptySpan);
            if(!f || emptyLabel.toLowerCase().includes(f)) {
              list.appendChild(emptyRow);
            }

            let rendered = 0;
            let matched = 0;
            for(const o of opts){
              const val = (o.value || '').trim();
              const label = (o.text || '').trim();
              if(!val) continue; // skip empty option (rendered above)
              if(!label) continue;
              if(f && !label.toLowerCase().includes(f)) continue;
              matched += 1;
              if(rendered >= MAX_RENDER) continue;

              const row = document.createElement('label');
              row.className = 'ms-item';
              const rb = document.createElement('input');
              rb.type = 'radio';
              rb.name = '__ms_single_' + (select.name || 'x');
              rb.checked = (select.value || '') === o.value;
              rb.addEventListener('change', () => {
                select.value = o.value;
                renderValue();
              });
              const span = document.createElement('span');
              span.textContent = label;
              row.appendChild(rb);
              row.appendChild(span);
              list.appendChild(row);
              rendered += 1;
            }

            if(!list.children.length){
              const empty = document.createElement('div');
              empty.className = 'ms-muted px-1 py-2';
              empty.textContent = 'Ничего не найдено';
              list.appendChild(empty);
              return;
            }

            if(matched > MAX_RENDER){
              const more = document.createElement('div');
              more.className = 'ms-muted px-1 py-2';
              more.textContent = 'Показаны первые ' + MAX_RENDER + '. Уточните запрос, чтобы найти нужное.';
              list.appendChild(more);
            }
          }

          function open(){
            panel.classList.remove('hidden');
            renderList(search.value);
            search.focus();
          }
          function close(){
            panel.classList.add('hidden');
            search.value = '';
          }

          if(btn){
            btn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              if(panel.classList.contains('hidden')) open(); else close();
            });
          }
          panel.addEventListener('click', (e) => e.stopPropagation());
          document.addEventListener('click', close);
          document.addEventListener('keydown', (e) => { if(e.key === 'Escape') close(); });

          if(search){
            search.addEventListener('input', () => renderList(search.value));
          }
          if(clearBtn){
            clearBtn.addEventListener('click', (e) => {
              e.preventDefault();
              select.value = '';
              renderValue();
              renderList(search.value);
            });
          }

          // initial
          renderValue();
        }

        function initAll(){
          document.querySelectorAll('[data-ms-single="1"]').forEach(initOne);
        }
        document.addEventListener('DOMContentLoaded', initAll);
        
        // Экспортируем функцию для инициализации виджетов в динамически загруженном контенте
        window.initMsSingleWidgets = function(container) {
          const widgets = container ? container.querySelectorAll('[data-ms-single="1"]') : document.querySelectorAll('[data-ms-single="1"]');
          widgets.forEach(initOne);
        };
      })();
    </script>
    <script>
      // Автоматическое форматирование номеров телефонов при вводе
      function formatPhoneInput(input) {
        let value = input.value.replace(/\D/g, ''); // Убираем все нецифровые символы
        
        // Если начинается с 7 и длина 11, убираем первую 7 (оставляем 10 цифр)
        if (value.startsWith('7') && value.length === 11) {
          value = value.substring(1);
        }
        
        // Если начинается с 8 и длина 11, заменяем на 7 и убираем первую 7 (оставляем 10 цифр)
        if (value.startsWith('8') && value.length === 11) {
          value = value.substring(1); // Убираем 8, остается 10 цифр
        }
        
        // Если начинается с 78 и длина 12, убираем 78 (оставляем 10 цифр)
        if (value.startsWith('78') && value.length === 12) {
          value = value.substring(2); // Убираем 78, остается 10 цифр
        }
        
        // Форматируем только если 10 цифр
        if (value.length === 10) {
          input.value = `+7 (${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6, 10)}`;
        } else if (value.length > 10) {
          // Если больше 10, берем последние 10
          value = value.substring(value.length - 10);
          input.value = `+7 (${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6, 10)}`;
        } else if (value.length > 0) {
          // Если меньше 10, оставляем как есть (пользователь еще вводит)
          input.value = value;
        }
      }
      
      // Применяем форматирование ко всем полям телефонов при загрузке страницы
      document.addEventListener('DOMContentLoaded', function() {
        // Поля с name="phone" или id содержащим "phone"
        document.querySelectorAll('input[name="phone"], input[id*="phone"], input[name*="phone"]').forEach(input => {
          // Форматируем текущее значение, если оно есть
          if (input.value) {
            formatPhoneInput(input);
          }
          
          // Форматируем при вводе
          input.addEventListener('input', function() {
            formatPhoneInput(this);
          });
          
          // Форматируем при потере фокуса
          input.addEventListener('blur', function() {
            formatPhoneInput(this);
          });
        });
        
        // Для форм контактов (динамические поля) - используем делегирование событий
        // ВАЖНО: не трогаем email поля (type="email" или родительский контейнер с email)
        document.addEventListener('input', function(e) {
          if (e.target && e.target.tagName === 'INPUT') {
            // Пропускаем email поля
            if (e.target.type === 'email') return;
            // Пропускаем поля, которые находятся в секции Email
            const parentSection = e.target.closest('section');
            if (parentSection) {
              const sectionLabel = parentSection.querySelector('.font-medium');
              if (sectionLabel && sectionLabel.textContent.trim().toLowerCase().includes('email')) {
                return;
              }
            }
            // Применяем форматирование только к телефонным полям
            if (e.target.name && e.target.name.includes('phone') || 
                e.target.id && e.target.id.includes('phone') ||
                (e.target.name && e.target.name.includes('value') && e.target.type !== 'email')) {
              formatPhoneInput(e.target);
            }
          }
        });
        
        // Очищаем форматирование перед отправкой формы (сохраняем только цифры)
        document.querySelectorAll('form').forEach(form => {
          form.addEventListener('submit', function(e) {
            // Находим все поля телефонов в форме (исключаем email поля)
            form.querySelectorAll('input[name="phone"], input[name*="phone"], input[name*="value"]').forEach(input => {
              // Пропускаем email поля
              if (input.type === 'email') return;
              // Пропускаем поля в секции Email
              const parentSection = input.closest('section');
              if (parentSection) {
                const sectionLabel = parentSection.querySelector('.font-medium');
                if (sectionLabel && sectionLabel.textContent.trim().toLowerCase().includes('email')) {
                  return;
                }
              }
              
              if (input.value) {
                // Убираем все нецифровые символы
                let value = input.value.replace(/\D/g, '');
                
                // Если начинается с 7 и длина 11, убираем первую 7 (оставляем 10 цифр)
                if (value.startsWith('7') && value.length === 11) {
                  value = value.substring(1);
                }
                // Если начинается с 8 и длина 11, убираем 8 (оставляем 10 цифр)
                else if (value.startsWith('8') && value.length === 11) {
                  value = value.substring(1);
                }
                // Если начинается с 78 и длина 12, убираем 78 (оставляем 10 цифр)
                else if (value.startsWith('78') && value.length === 12) {
                  value = value.substring(2);
                }
                
                // Если 10 цифр, добавляем +7
                if (value.length === 10) {
                  input.value = '+7' + value;
                } else if (value.length > 0) {
                  // Сохраняем как есть, если не подходит под формат
                  input.value = value;
                }
              }
            });
          });
        });
      });

      // Обработчик подтверждения для форм холодного звонка
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.js-cold-call-form').forEach(function(form) {
          if (form.__coldCallBound) return;
          form.__coldCallBound = true;
          form.addEventListener('submit', function(e) {
            const confirmMessage = form.getAttribute('data-confirm');
            if (confirmMessage && !confirm(confirmMessage)) {
              e.preventDefault();
              return false;
            }
          });
        });
      });

      // Глобальный прогресс рассылки (polling)
      (function() {
        const widget = document.getElementById('mailProgressWidget');
        const circle = document.getElementById('mailProgressCircle');
        const pct = document.getElementById('mailProgressPct');
        const text = document.getElementById('mailProgressText');
        const counts = document.getElementById('mailProgressCounts');
        const closeBtn = document.getElementById('mailProgressClose');
        if (!widget || !circle || !pct || !text || !counts || !closeBtn) return;

        const STORAGE_KEY = 'mail_progress_dismissed_campaign';
        let dismissedForCampaignId = null;
        try {
          dismissedForCampaignId = window.localStorage.getItem(STORAGE_KEY) || null;
        } catch (_e) {
          dismissedForCampaignId = null;
        }

        async function poll() {
          try {
            const res = await fetch('/mail/progress/poll/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await res.json();
            if (!data || !data.ok || !data.active) {
              widget.classList.add('hidden');
              dismissedForCampaignId = null;
              return;
            }
            const a = data.active;
            const status = (a.status || '').toLowerCase();

            // Как только начинается отправка любой кампании — сбрасываем прежний dismiss,
            // чтобы прогресс новой отправки всегда был виден.
            if (status === 'sending') {
              dismissedForCampaignId = null;
              try { window.localStorage.removeItem(STORAGE_KEY); } catch (_e) {}
            }

            // Если пользователь закрыл виджет для этой завершённой кампании — не показываем
            if (status === 'sent' && dismissedForCampaignId === a.id) {
              widget.classList.add('hidden');
              return;
            }

            const p = Number(a.percent || 0);
            const deg = Math.max(0, Math.min(100, p)) * 3.6;
            widget.href = a.url || ('/mail/campaigns/' + a.id + '/');
            widget.classList.remove('hidden');
            pct.textContent = `${p}%`;
            text.textContent = a.name || 'Кампания';
            counts.textContent = `Отпр.: ${a.sent} · Ошибки: ${a.failed} · В очереди: ${a.pending}`;
            circle.style.background = `conic-gradient(var(--brand-teal) ${deg}deg, rgba(194,226,222,.6) ${deg}deg)`;

            // Крестик показываем только после завершения (SENT)
            if (status === 'sent') {
              closeBtn.classList.remove('hidden');
            } else {
              closeBtn.classList.add('hidden');
            }
          } catch (e) {
            // тихо: не мешаем работе
          }
        }

        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          widget.classList.add('hidden');
          // Запоминаем кампанию, для которой пользователь закрыл виджет
          const href = widget.getAttribute('href') || '';
          const match = href.match(/\/mail\/campaigns\/([^/]+)\//);
          if (match && match[1]) {
            dismissedForCampaignId = match[1];
            try {
              window.localStorage.setItem(STORAGE_KEY, dismissedForCampaignId);
            } catch (_e) {}
          }
        });

        // Первичный запуск + периодический polling
        poll();
        setInterval(poll, 4000);
      })();
    </script>
    <script>
      // Кастомный dropdown для выбора типа задачи с иконками и цветами
      (function() {
        window.initTaskTypeSelects = function() {
          document.querySelectorAll('select.task-type-select').forEach(function(select) {
            if (select.dataset.customDropdown) return;
            select.dataset.customDropdown = 'true';
            
            // Скрываем оригинальный select
            select.style.display = 'none';
            
            // Создаем кастомный dropdown
            const wrapper = document.createElement('div');
            wrapper.className = 'relative';
            wrapper.style.position = 'relative';
            
            const button = document.createElement('button');
            button.type = 'button';
            button.className = select.className + ' text-left';
            button.style.cssText = 'display: flex; align-items: center; justify-content: space-between; width: 100%;';
            
            const dropdown = document.createElement('div');
            dropdown.className = 'absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-auto hidden';
            dropdown.style.top = '100%';
            dropdown.style.left = '0';
            dropdown.style.right = '0';
            
            // Функция для получения иконки (поддерживает emoji и названия SVG иконок)
            function getIconHtml(iconValue) {
              if (!iconValue) return '';
              
              // Если это emoji (1-2 символа Unicode), возвращаем как есть
              if (iconValue.length <= 2 || /^[\u{1F300}-\u{1F9FF}]/u.test(iconValue)) {
                return '<span style="font-size: 16px; line-height: 1;">' + iconValue + '</span>';
              }
              
              // Библиотека SVG иконок
              const icons = {
                'phone': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 9.9a16 16 0 0 0 6 6l1.5-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6a2 2 0 0 1 1.8 2.1z"/></svg>',
                'mail': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v16H4z"/><path d="M4 7l8 5 8-5"/></svg>',
                'document': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 2h8l4 4v16H7z"/><path d="M15 2v4h4"/></svg>',
                'calendar': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
                'question': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17h.01"/><path d="M9.1 9a3 3 0 0 1 5.8 1c0 2-2 2.5-2 4"/><circle cx="12" cy="12" r="9"/></svg>',
                'alert': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v5"/><path d="M12 16h.01"/><path d="M4.5 19h15L12 4z"/></svg>',
                'education': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 10l8-4 8 4-8 4-8-4z"/><path d="M6 12v4l6 3 6-3v-4"/></svg>',
                'send': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4l16 8-16 8 4-8-4-8z"/></svg>',
                'check': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 13l4 4L19 7"/></svg>',
                'clock': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>',
                'repeat': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h9a4 4 0 014 4v1"/><path d="M9 20H4a4 4 0 01-4-4v-1"/><path d="M8 4L4 0 0 4"/><path d="M16 24l4-4 4 4"/></svg>',
                'target': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="5"/><circle cx="12" cy="12" r="2"/></svg>',
                'user': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20a8 8 0 0116 0"/></svg>',
                'team': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="9" r="3"/><circle cx="16" cy="9" r="3"/><path d="M2 20a6 6 0 0112 0"/><path d="M10 20a6 6 0 0112 0"/></svg>',
                'money': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><circle cx="12" cy="12" r="3"/></svg>',
                'cart': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M3 3h2l3 12h11l2-8H8"/></svg>',
                'chat': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 5h16v10H5l-3 3V5z"/></svg>',
                'star': '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" stroke="none"><path d="M12 2.5l2.9 5.9 6.6.9-4.8 4.7 1.1 6.5L12 17.8 6.2 20.5l1.1-6.5-4.8-4.7 6.6-.9z"/></svg>',
              };
              // Возвращаем SVG иконку или emoji как есть
              return icons[iconValue] || '<span style="font-size: 16px; line-height: 1;">' + iconValue + '</span>';
            }
            
            function getColorClasses(color) {
              const colorMap = {
                'badge-blue': 'bg-blue-100 text-blue-800',
                'badge-green': 'bg-green-100 text-green-800',
                'badge-red': 'bg-red-100 text-red-800',
                'badge-amber': 'bg-amber-100 text-amber-800',
                'badge-orange': 'bg-orange-100 text-orange-800',
                'badge-teal': 'bg-teal-100 text-teal-800',
                'badge-indigo': 'bg-indigo-100 text-indigo-800',
                'badge-purple': 'bg-purple-100 text-purple-800',
                'badge-pink': 'bg-pink-100 text-pink-800',
                'badge-gray': 'bg-gray-100 text-gray-800',
              };
              return colorMap[color] || 'bg-gray-100 text-gray-800';
            }
            
            function updateButton() {
              const selectedOption = select.options[select.selectedIndex];
              if (!selectedOption) {
                button.innerHTML = '<span class="text-gray-500">----------</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>';
                return;
              }
              
              // Читаем data-атрибуты (проверяем и dataset, и getAttribute для совместимости)
              const icon = selectedOption.dataset.icon || selectedOption.getAttribute('data-icon') || '';
              const color = selectedOption.dataset.color || selectedOption.getAttribute('data-color') || '';
              const text = selectedOption.textContent || '';
              
              // Отладка (можно убрать позже)
              if (!icon && !color && text && text !== '----------') {
                console.log('TaskType select: нет иконки/цвета для', text, 'value:', selectedOption.value, 'dataset:', selectedOption.dataset);
              }
              
              const colorClasses = getColorClasses(color);
              const iconHtml = icon ? getIconHtml(icon) : '';
              
              button.innerHTML = `
                <span class="inline-flex items-center gap-1.5 ${colorClasses} px-2 py-0.5 rounded-full text-sm">
                  ${iconHtml ? '<span class="inline-flex items-center justify-center">' + iconHtml + '</span>' : ''}
                  <span>${text}</span>
                </span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
              `;
            }
            
            function buildDropdown() {
              dropdown.innerHTML = '';
              for (let i = 0; i < select.options.length; i++) {
                const option = select.options[i];
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'w-full text-left px-3 py-2 hover:bg-gray-50 flex items-center gap-2';
                
                // Читаем data-атрибуты (проверяем и dataset, и getAttribute для совместимости)
                const icon = option.dataset.icon || option.getAttribute('data-icon') || '';
                const color = option.dataset.color || option.getAttribute('data-color') || '';
                const text = option.textContent || '';
                
                if (option.value === '') {
                  item.className += ' text-gray-500 border-b border-gray-200';
                  item.innerHTML = `<span>${text}</span>`;
                } else {
                  const colorClasses = getColorClasses(color);
                  const iconHtml = icon ? getIconHtml(icon) : '';
                  item.innerHTML = `
                    <span class="inline-flex items-center gap-1.5 ${colorClasses} px-2 py-0.5 rounded-full text-sm">
                      ${iconHtml ? '<span class="inline-flex items-center justify-center">' + iconHtml + '</span>' : ''}
                      <span>${text}</span>
                    </span>
                  `;
                }
                
                item.addEventListener('click', () => {
                  select.value = option.value;
                  select.dispatchEvent(new Event('change', { bubbles: true }));
                  dropdown.classList.add('hidden');
                  updateButton();
                });
                
                dropdown.appendChild(item);
              }
            }
            
            button.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              dropdown.classList.toggle('hidden');
            });
            
            document.addEventListener('click', (e) => {
              if (!wrapper.contains(e.target)) {
                dropdown.classList.add('hidden');
              }
            });
            
            select.addEventListener('change', updateButton);
            
            updateButton();
            buildDropdown();
            
            wrapper.appendChild(button);
            wrapper.appendChild(dropdown);
            select.parentNode.insertBefore(wrapper, select);
            wrapper.appendChild(select);
          });
        };
        
        // Инициализация при загрузке
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', window.initTaskTypeSelects);
        } else {
          window.initTaskTypeSelects();
        }
        
        // Также инициализируем при динамическом добавлении элементов
        const observer = new MutationObserver(function(mutations) {
          window.initTaskTypeSelects();
        });
        observer.observe(document.body, { childList: true, subtree: true });
      })();
    </script>
    <script>
      // Кастомный календарик для datetime-local и date с подписями "Часы" и "Минуты"
      (function() {
        function initCustomDatetimePicker() {
          document.querySelectorAll('input[type="datetime-local"], input[type="date"]').forEach(function(input) {
            if (input.dataset.customPickerInitialized) return;
            input.dataset.customPickerInitialized = 'true';
            
            // Скрываем нативный календарик
            input.style.position = 'absolute';
            input.style.opacity = '0';
            input.style.width = '100%';
            input.style.height = '100%';
            input.style.pointerEvents = 'none';
            
            // Создаем обёртку
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-datetime-picker';
            wrapper.style.position = 'relative';
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);
            
            // Создаем визуальный input
            const visualInput = document.createElement('div');
            visualInput.className = 'input';
            visualInput.style.cursor = 'pointer';
            visualInput.style.display = 'flex';
            visualInput.style.alignItems = 'center';
            visualInput.style.justifyContent = 'space-between';
            visualInput.style.position = 'relative';
            
            // Добавляем текст
            const textSpan = document.createElement('span');
            textSpan.style.flex = '1';
            visualInput.appendChild(textSpan);
            
            // Добавляем иконку календаря справа
            const calendarIcon = document.createElement('div');
            calendarIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: rgba(0,61,56,.6); flex-shrink: 0;"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>';
            calendarIcon.style.display = 'flex';
            calendarIcon.style.alignItems = 'center';
            calendarIcon.style.pointerEvents = 'none';
            visualInput.appendChild(calendarIcon);
            wrapper.appendChild(visualInput);
            
            // Обновляем визуальный input
            function updateVisualInput() {
              if (input.value) {
                const date = new Date(input.value);
                if (input.type === 'datetime-local') {
                  const formatted = date.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  });
                  textSpan.textContent = formatted;
                } else {
                  const formatted = date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                  });
                  textSpan.textContent = formatted;
                }
                textSpan.style.color = 'var(--brand-dark)';
              } else {
                textSpan.textContent = input.type === 'datetime-local' ? 'Выберите дату и время' : 'Выберите дату';
                textSpan.style.color = 'rgba(0,61,56,.5)';
              }
            }
            updateVisualInput();
            
            // Создаем overlay и popup (один раз для всех input)
            let overlay = document.querySelector('.custom-datetime-overlay');
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.className = 'custom-datetime-overlay';
              document.body.appendChild(overlay);
            }
            
            let popup = overlay.querySelector('.custom-datetime-popup');
            if (!popup) {
              popup = document.createElement('div');
              popup.className = 'custom-datetime-popup';
              overlay.appendChild(popup);
            }
            
            let currentDate = input.value ? new Date(input.value) : new Date();
            let selectedDate = currentDate;
            let selectedHour = input.type === 'datetime-local' ? currentDate.getHours() : 0;
            let selectedMinute = input.type === 'datetime-local' ? currentDate.getMinutes() : 0;
            let showMonthYearSelector = false;
            let showYearSelector = false;
            
            function renderCalendar() {
              const year = currentDate.getFullYear();
              const month = currentDate.getMonth();
              const firstDay = new Date(year, month, 1);
              const lastDay = new Date(year, month + 1, 0);
              const daysInMonth = lastDay.getDate();
              const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
              
              const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
              const weekdays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
              
              const today = new Date();
              today.setHours(0, 0, 0, 0);
              
              if (showYearSelector) {
                // Показываем выбор года с навигацией по десятилетиям
                const currentYear = currentDate.getFullYear();
                const decadeStart = Math.floor(currentYear / 10) * 10;
                const startYear = decadeStart - 5;
                const endYear = decadeStart + 14;
                
                popup.innerHTML = `
                  <div class="calendar-header">
                    <div class="month-year" style="cursor: pointer;">Выберите год</div>
                    <div class="nav-buttons">
                      <button class="close-year-selector" type="button" style="font-size: 18px; line-height: 1;">✕</button>
                    </div>
                  </div>
                  <div class="year-selector">
                    <div class="year-decade-header">
                      <div class="year-decade-title">${decadeStart} - ${decadeStart + 9}</div>
                      <div class="year-decade-nav">
                        <button class="prev-decade" type="button">‹‹</button>
                        <button class="next-decade" type="button">››</button>
                      </div>
                    </div>
                    <div class="year-grid">
                      ${Array(endYear - startYear + 1).fill(0).map((_, i) => {
                        const y = startYear + i;
                        return `<div class="year-item ${y === year ? 'selected' : ''}" data-year="${y}">${y}</div>`;
                      }).join('')}
                    </div>
                  </div>
                `;
                
                popup.querySelectorAll('.year-item').forEach(item => {
                  item.addEventListener('click', () => {
                    const selectedYear = parseInt(item.dataset.year);
                    currentDate.setFullYear(selectedYear);
                    showYearSelector = false;
                    renderCalendar();
                  });
                });
                
                popup.querySelector('.prev-decade').addEventListener('click', () => {
                  currentDate.setFullYear(currentDate.getFullYear() - 10);
                  renderCalendar();
                });
                
                popup.querySelector('.next-decade').addEventListener('click', () => {
                  currentDate.setFullYear(currentDate.getFullYear() + 10);
                  renderCalendar();
                });
                
                popup.querySelector('.close-year-selector').addEventListener('click', () => {
                  showYearSelector = false;
                  renderCalendar();
                });
                
                return;
              }
              
              if (showMonthYearSelector) {
                // Показываем выбор месяца
                popup.innerHTML = `
                  <div class="calendar-header">
                    <div class="month-year" style="cursor: pointer;">Выберите месяц</div>
                    <div class="nav-buttons">
                      <button class="show-year-selector" type="button" style="min-width: 60px; font-weight: 600;">${year}</button>
                      <button class="close-month-selector" type="button" style="font-size: 18px; line-height: 1;">✕</button>
                    </div>
                  </div>
                  <div class="month-year-selector">
                    ${monthNames.map((name, idx) => {
                      return `<div class="month-year-item ${idx === month ? 'selected' : ''}" data-month="${idx}">${name}</div>`;
                    }).join('')}
                  </div>
                `;
                
                popup.querySelectorAll('.month-year-item').forEach(item => {
                  item.addEventListener('click', () => {
                    const selectedMonth = parseInt(item.dataset.month);
                    currentDate.setMonth(selectedMonth);
                    showMonthYearSelector = false;
                    renderCalendar();
                  });
                });
                
                popup.querySelector('.show-year-selector').addEventListener('click', () => {
                  showMonthYearSelector = false;
                  showYearSelector = true;
                  renderCalendar();
                });
                
                popup.querySelector('.close-month-selector').addEventListener('click', () => {
                  showMonthYearSelector = false;
                  renderCalendar();
                });
                
                return;
              }
              
              popup.innerHTML = `
                <div class="calendar-header">
                  <div class="month-year" data-action="select-month-year">${monthNames[month]} ${year}</div>
                  <div class="nav-buttons">
                    <button class="prev-month" type="button">‹</button>
                    <button class="next-month" type="button">›</button>
                  </div>
                </div>
                <div class="calendar-time-wrapper">
                  <div class="calendar-section">
                    <div class="calendar-weekdays">
                      ${weekdays.map(day => `<span>${day}</span>`).join('')}
                    </div>
                    <div class="calendar-days">
                      ${Array(startDay).fill(0).map((_, i) => {
                        const date = new Date(year, month, -startDay + i + 1);
                        return `<div class="calendar-day other-month">${date.getDate()}</div>`;
                      }).join('')}
                      ${Array(daysInMonth).fill(0).map((_, i) => {
                        const day = i + 1;
                        const date = new Date(year, month, day);
                        date.setHours(0, 0, 0, 0);
                        const isToday = date.getTime() === today.getTime();
                        const isSelected = selectedDate && date.getTime() === selectedDate.getTime();
                        return `<div class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}" data-day="${day}">${day}</div>`;
                      }).join('')}
                      ${Array(42 - startDay - daysInMonth).fill(0).map((_, i) => {
                        const date = new Date(year, month + 1, i + 1);
                        return `<div class="calendar-day other-month">${date.getDate()}</div>`;
                      }).join('')}
                    </div>
                  </div>
                  ${input.type === 'datetime-local' ? `
                  <div class="time-picker">
                    <div class="time-column">
                      <div class="time-column-label">Часы</div>
                      <div class="time-scroll" id="hours-scroll">
                        ${Array(24).fill(0).map((_, i) => {
                          const hour = String(i).padStart(2, '0');
                          return `<div class="time-item ${i === selectedHour ? 'selected' : ''}" data-hour="${i}">${hour}</div>`;
                        }).join('')}
                      </div>
                    </div>
                    <div class="time-column">
                      <div class="time-column-label">Минуты</div>
                      <div class="time-scroll" id="minutes-scroll">
                        ${Array(60).fill(0).map((_, i) => {
                          const minute = String(i).padStart(2, '0');
                          return `<div class="time-item ${i === selectedMinute ? 'selected' : ''}" data-minute="${i}">${minute}</div>`;
                        }).join('')}
                      </div>
                    </div>
                  </div>
                  ` : ''}
                </div>
                <div class="calendar-actions">
                  <button class="btn-delete" type="button">Удалить</button>
                  <button class="btn-today" type="button">Сегодня</button>
                  <button class="btn-primary btn-apply" type="button">Применить</button>
                </div>
              `;
              
              // Обработчики событий
              popup.querySelector('[data-action="select-month-year"]').addEventListener('click', () => {
                showMonthYearSelector = true;
                renderCalendar();
              });
              
              popup.querySelector('.prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
              });
              
              popup.querySelector('.next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
              });
              
              popup.querySelectorAll('.calendar-day:not(.other-month)').forEach(day => {
                day.addEventListener('click', () => {
                  const dayNum = parseInt(day.dataset.day);
                  selectedDate = new Date(year, month, dayNum);
                  renderCalendar();
                });
              });
              
              popup.querySelectorAll('.time-item[data-hour]').forEach(item => {
                item.addEventListener('click', () => {
                  selectedHour = parseInt(item.dataset.hour);
                  renderCalendar();
                  setTimeout(() => {
                    const selectedElement = popup.querySelector(`.time-item[data-hour="${selectedHour}"]`);
                    if (selectedElement) {
                      selectedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                  }, 50);
                });
              });
              
              popup.querySelectorAll('.time-item[data-minute]').forEach(item => {
                item.addEventListener('click', () => {
                  selectedMinute = parseInt(item.dataset.minute);
                  renderCalendar();
                  setTimeout(() => {
                    const selectedElement = popup.querySelector(`.time-item[data-minute="${selectedMinute}"]`);
                    if (selectedElement) {
                      selectedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                  }, 50);
                });
              });
              
              // Прокручиваем к выбранным значениям при открытии
              setTimeout(() => {
                const selectedHourEl = popup.querySelector(`.time-item[data-hour="${selectedHour}"]`);
                const selectedMinuteEl = popup.querySelector(`.time-item[data-minute="${selectedMinute}"]`);
                if (selectedHourEl) {
                  selectedHourEl.scrollIntoView({ behavior: 'auto', block: 'center' });
                }
                if (selectedMinuteEl) {
                  selectedMinuteEl.scrollIntoView({ behavior: 'auto', block: 'center' });
                }
              }, 100);
              
              popup.querySelector('.btn-delete').addEventListener('click', () => {
                input.value = '';
                updateVisualInput();
                closePopup();
              });
              
              popup.querySelector('.btn-today').addEventListener('click', () => {
                const now = new Date();
                currentDate = new Date(now);
                selectedDate = new Date(now);
                if (input.type === 'datetime-local') {
                  selectedHour = now.getHours();
                  selectedMinute = now.getMinutes();
                }
                renderCalendar();
              });
              
              popup.querySelector('.btn-apply').addEventListener('click', () => {
                if (selectedDate) {
                  if (input.type === 'datetime-local') {
                    selectedDate.setHours(selectedHour, selectedMinute, 0, 0);
                    // Преобразуем в локальное время для datetime-local
                    const localDate = new Date(selectedDate.getTime() - selectedDate.getTimezoneOffset() * 60000);
                    const isoString = localDate.toISOString().slice(0, 16);
                    input.value = isoString;
                  } else {
                    // Для date используем формат YYYY-MM-DD
                    const year = selectedDate.getFullYear();
                    const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
                    const day = String(selectedDate.getDate()).padStart(2, '0');
                    input.value = `${year}-${month}-${day}`;
                  }
                  updateVisualInput();
                  // Триггерим события для обновления формы
                  input.dispatchEvent(new Event('input', { bubbles: true }));
                  input.dispatchEvent(new Event('change', { bubbles: true }));
                }
                closePopup();
              });
              
              // Выбранные значения уже видны, так как показываем только элементы вокруг них
            }
            
            function openPopup() {
              overlay.classList.add('active');
              const rect = visualInput.getBoundingClientRect();
              // Позиционируем popup прямо под полем ввода
              popup.style.top = (rect.bottom + 4) + 'px';
              popup.style.left = rect.left + 'px';
              popup.style.transform = 'none';
              // Убеждаемся, что popup не выходит за границы экрана
              setTimeout(() => {
                const popupRect = popup.getBoundingClientRect();
                if (popupRect.right > window.innerWidth) {
                  popup.style.left = (window.innerWidth - popupRect.width - 8) + 'px';
                }
                // Если popup не помещается снизу, открываем сверху
                if (popupRect.bottom > window.innerHeight) {
                  popup.style.top = (rect.top - popupRect.height - 4) + 'px';
                }
                // Если и сверху не помещается, открываем снизу и добавляем прокрутку
                const checkRect = popup.getBoundingClientRect();
                if (checkRect.top < 0) {
                  popup.style.top = (rect.bottom + 4) + 'px';
                  popup.style.maxHeight = (window.innerHeight - rect.bottom - 12) + 'px';
                }
              }, 0);
              renderCalendar();
            }
            
            function closePopup() {
              overlay.classList.remove('active');
            }
            
            // Обработчик Escape для закрытия
            function handleEscape(e) {
              if (e.key === 'Escape' && overlay.classList.contains('active')) {
                closePopup();
              }
            }
            
            visualInput.addEventListener('click', function(e) {
              e.stopPropagation();
              openPopup();
            });
            
            overlay.addEventListener('click', (e) => {
              if (e.target === overlay) {
                closePopup();
              }
            });
            
            // Предотвращаем закрытие при клике на popup
            popup.addEventListener('click', (e) => {
              e.stopPropagation();
            });
            
            // Закрытие по Escape
            document.addEventListener('keydown', handleEscape);
            
            input.addEventListener('change', updateVisualInput);
          });
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCustomDatetimePicker);
        } else {
          initCustomDatetimePicker();
        }
        
        const observer = new MutationObserver(initCustomDatetimePicker);
        observer.observe(document.body, { childList: true, subtree: true });
      })();
    </script>
  </body>
</html>


