{% extends "ui/base.html" %}
{% block title %}Компании — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="flex items-end justify-between gap-3">
        <div>
          <h1 class="text-2xl font-semibold">Компании</h1>
            <div class="text-sm text-brand-dark/70 flex flex-wrap items-center gap-2">
              <span>Поиск по названию, ИНН, адресу</span>
              <span class="badge">Всего: <b class="ml-1">{{ companies_total }}</b></span>
              {% if filter_active and companies_filtered != companies_total %}
                <span class="badge badge-warn">По фильтру: <b class="ml-1">{{ companies_filtered }}</b></span>
              {% endif %}
            </div>
        </div>
        <div class="flex gap-2">
          <a href="/companies/new/" class="btn btn-primary">+ Добавить компанию</a>
          {% if is_admin %}
            <a href="/companies/export/?q={{ q }}&responsible={{ responsible }}&status={{ status }}&branch={{ branch }}&sphere={{ sphere }}&contract_type={{ contract_type }}&overdue={{ overdue }}&sort={{ sort }}&dir={{ dir }}" class="btn btn-outline">Экспорт CSV</a>
          {% endif %}
        </div>
      </div>
    </div>

    <form class="card card-pad space-y-4" method="get">
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Поиск</label>
        <div class="relative">
          <input name="q" value="{{ q }}" id="company-search-input" class="input w-full" placeholder="ИНН / название / адрес" autocomplete="off" />
          <div id="company-autocomplete-dropdown" class="absolute left-0 right-0 top-full mt-1 bg-white border border-brand-soft rounded-lg shadow-lg z-50 hidden max-h-64 overflow-y-auto"></div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-3 items-end">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Ответственный</label>
          <select name="responsible" class="select w-full">
            <option value="">Любой</option>
            {% if has_companies_without_responsible %}
              <option value="none" {% if responsible == "none" %}selected{% endif %}>None</option>
            {% endif %}
            {% regroup responsibles by branch as branches_list %}
            {% for branch_group in branches_list %}
              <optgroup label="Филиал: {{ branch_group.grouper.name|default:"Без филиала" }}">
                {% for u in branch_group.list %}
                  <option value="{{ u.id }}" {% if responsible == u.id|stringformat:"s" %}selected{% endif %}>
                    {{ u }}
                  </option>
                {% endfor %}
              </optgroup>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Статус</label>
          <select name="status" class="select w-full">
            <option value="">Любой</option>
            {% for s in statuses %}
              <option value="{{ s.id }}" {% if status == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Филиал</label>
          <select name="branch" class="select w-full">
            <option value="">Любой</option>
            {% for b in branches %}
              <option value="{{ b.id }}" {% if branch == b.id|stringformat:"s" %}selected{% endif %}>{{ b.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Сфера</label>
          <select name="sphere" class="select w-full">
            <option value="">Любая</option>
            {% for s in spheres %}
              <option value="{{ s.id }}" {% if sphere == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Вид договора</label>
          <select name="contract_type" class="select w-full">
            <option value="">Любой</option>
            {% for val, label in contract_types %}
              <option value="{{ val }}" {% if contract_type == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="flex flex-col md:flex-row md:items-center md:flex-wrap gap-2 justify-between">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          <input type="checkbox" name="overdue" value="1" {% if overdue == '1' %}checked{% endif %} />
          Только с просрочками
        </label>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-primary" type="submit">Поиск</button>
          <a class="btn btn-outline" href="/companies/">Сброс</a>
        </div>
      </div>
    </form>

    <form method="post" action="/companies/bulk-transfer/" class="card card-pad" id="bulkTransferForm" style="display:none">
      {% csrf_token %}
      <input type="hidden" name="apply_mode" id="bulkApplyMode" value="selected" />
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="hidden" name="responsible" value="{{ responsible }}" />
      <input type="hidden" name="status" value="{{ status }}" />
      <input type="hidden" name="branch" value="{{ branch }}" />
      <input type="hidden" name="sphere" value="{{ sphere }}" />
      <input type="hidden" name="contract_type" value="{{ contract_type }}" />
      <input type="hidden" name="cold_call" value="{{ cold_call }}" />
      <input type="hidden" name="overdue" value="{{ overdue }}" />

      <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
        <div class="text-sm text-brand-dark/80">
          Выбрано: <b id="bulkSelectedCount">0</b>
          <span class="muted-2 ml-2" id="bulkModeHint"></span>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <select name="responsible_id" class="select" style="min-width:260px">
            <option value="">Новый ответственный…</option>
            {% regroup transfer_targets by branch as branches_list %}
            {% for branch_group in branches_list %}
              <optgroup label="Филиал: {{ branch_group.grouper.name|default:"Без филиала" }}">
                {% for u in branch_group.list %}
                  <option value="{{ u.id }}">{{ u }} ({{ u.get_role_display }})</option>
                {% endfor %}
              </optgroup>
            {% endfor %}
          </select>
          <button class="btn btn-primary" type="submit" id="bulkTransferBtn" onclick="return confirm('Переназначить выбранные компании?');" title="">Переназначить</button>
          <button class="btn btn-outline" type="button" id="bulkSelectFiltered">Выбрать все по фильтру</button>
          <button class="btn btn-outline" type="button" id="bulkClear">Снять выделение</button>
        </div>
      </div>
      <div class="text-xs muted-2 mt-2">
        Совет: чтобы переназначить “все компании сотрудника”, отфильтруйте по ответственному → нажмите <b>Выбрать все по фильтру</b> → выберите нового ответственного → Переназначить.
      </div>
    </form>

    <div class="card overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th class="text-left px-4 py-3" style="width:44px">
                <input type="checkbox" id="bulkSelectAll" />
              </th>
              {% if "name" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="?{% if qs %}{{ qs }}&{% endif %}sort=name&dir={% if sort_field == 'name' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'name' %}text-brand-orange font-bold{% endif %}">
                    Компания
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'name' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'name' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "overdue" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  Просрочки
                </th>
              {% endif %}
              {% if "inn" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="?{% if qs %}{{ qs }}&{% endif %}sort=inn&dir={% if sort_field == 'inn' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'inn' %}text-brand-orange font-bold{% endif %}">
                    ИНН
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'inn' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'inn' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "status" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="?{% if qs %}{{ qs }}&{% endif %}sort=status&dir={% if sort_field == 'status' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'status' %}text-brand-orange font-bold{% endif %}">
                    Статус
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'status' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'status' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "spheres" in company_list_columns %}
                <th class="text-left px-4 py-3">Сферы</th>
              {% endif %}
              {% if "responsible" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="?{% if qs %}{{ qs }}&{% endif %}sort=responsible&dir={% if sort_field == 'responsible' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'responsible' %}text-brand-orange font-bold{% endif %}">
                    Ответственный
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'responsible' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'responsible' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "branch" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="?{% if qs %}{{ qs }}&{% endif %}sort=branch&dir={% if sort_field == 'branch' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'branch' %}text-brand-orange font-bold{% endif %}">
                    Филиал
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "updated_at" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="?{% if qs %}{{ qs }}&{% endif %}sort=updated_at&dir={% if sort_field == 'updated_at' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'updated_at' %}text-brand-orange font-bold{% endif %}">
                    Обновлено
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'updated_at' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'updated_at' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for c in page.object_list %}
              <tr onclick="window.location='/companies/{{ c.id }}/'" style="cursor:pointer" class="{% if c.has_overdue %}company-row-overdue{% endif %}">
                <td onclick="event.stopPropagation()">
                  <input class="bulk-company" type="checkbox" name="company_ids" value="{{ c.id }}" form="bulkTransferForm" data-can-transfer="{% if c.can_transfer %}1{% else %}0{% endif %}" />
                </td>
                {% if "name" in company_list_columns %}
                  <td>
                    <a class="link" href="/companies/{{ c.id }}/" onclick="event.stopPropagation()">{{ c.name }}</a>
                    {% if "address" in company_list_columns %}
                      <div class="text-xs text-brand-dark/70">{{ c.address }}</div>
                    {% endif %}
                  </td>
                {% endif %}
                {% if "overdue" in company_list_columns %}
                  <td>
                    {% if c.has_overdue %}
                      <span class="badge badge-warn">Да</span>
                    {% else %}
                      <span class="muted-2">—</span>
                    {% endif %}
                  </td>
                {% endif %}
                {% if "inn" in company_list_columns %}<td>{{ c.inn }}</td>{% endif %}
                {% if "status" in company_list_columns %}
                  <td>
                    {% if c.status %}
                      <span class="badge">{{ c.status.name }}</span>
                    {% else %}
                      <span class="muted-2">—</span>
                    {% endif %}
                  </td>
                {% endif %}
                {% if "spheres" in company_list_columns %}
                  <td>
                    {% for s in c.spheres.all %}
                      <span class="badge mr-1 mb-1">{{ s.name }}</span>
                    {% empty %}
                      <span class="text-brand-dark/70">—</span>
                    {% endfor %}
                  </td>
                {% endif %}
                {% if "responsible" in company_list_columns %}<td>{{ c.responsible }}</td>{% endif %}
                {% if "branch" in company_list_columns %}<td>{{ c.branch }}</td>{% endif %}
                {% if "updated_at" in company_list_columns %}
                  <td class="muted">
                    <div>{{ c.updated_at|date:"d.m.Y H:i" }}</div>
                    <div class="text-xs text-brand-dark/60 mt-0.5" data-updated-at="{{ c.updated_at|date:'c' }}"></div>
                  </td>
                {% endif %}
              </tr>
            {% empty %}
              <tr><td class="muted" colspan="20" style="padding:1.25rem 1rem">Ничего не найдено.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="border-t px-4 py-3 flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-2">
          <form method="get" class="flex items-center gap-2" id="perPageForm">
            <label class="text-sm text-brand-dark/70 whitespace-nowrap">На странице:</label>
            <select name="per_page" class="select" onchange="document.getElementById('perPageForm').submit()" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
              <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
            </select>
            {% if q %}<input type="hidden" name="q" value="{{ q }}" />{% endif %}
            {% if responsible %}<input type="hidden" name="responsible" value="{{ responsible }}" />{% endif %}
            {% if status %}<input type="hidden" name="status" value="{{ status }}" />{% endif %}
            {% if branch %}<input type="hidden" name="branch" value="{{ branch }}" />{% endif %}
            {% if sphere %}<input type="hidden" name="sphere" value="{{ sphere }}" />{% endif %}
            {% if contract_type %}<input type="hidden" name="contract_type" value="{{ contract_type }}" />{% endif %}
            {% if overdue %}<input type="hidden" name="overdue" value="{{ overdue }}" />{% endif %}
            {% if sort %}<input type="hidden" name="sort" value="{{ sort }}" />{% endif %}
            {% if dir %}<input type="hidden" name="dir" value="{{ dir }}" />{% endif %}
          </form>
        </div>
        <div>
          {% include "ui/_pagination.html" with page=page qs=qs %}
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const form = document.getElementById('bulkTransferForm');
      const selectAll = document.getElementById('bulkSelectAll');
      const items = Array.from(document.querySelectorAll('.bulk-company'));
      const countEl = document.getElementById('bulkSelectedCount');
      const clearBtn = document.getElementById('bulkClear');
      const selectFilteredBtn = document.getElementById('bulkSelectFiltered');
      const modeEl = document.getElementById('bulkApplyMode');
      const hintEl = document.getElementById('bulkModeHint');

      function selectedCount() {
        return items.filter(i => i.checked).length;
      }

      function update() {
        const cnt = selectedCount();
        if (countEl) countEl.textContent = String(cnt);
        if (form) form.style.display = (cnt > 0) ? 'block' : 'none';
        if (selectAll) selectAll.checked = (cnt > 0 && cnt === items.length);
        if (modeEl) modeEl.value = 'selected';
        if (hintEl) hintEl.textContent = cnt ? ' (выбранные на странице)' : '';
      }

      if (selectAll) {
        selectAll.addEventListener('change', () => {
          const v = !!selectAll.checked;
          items.forEach(i => { i.checked = v; });
          update();
        });
      }

      items.forEach(i => i.addEventListener('change', update));

      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          items.forEach(i => { i.checked = false; });
          update();
        });
      }

      if (selectFilteredBtn) {
        selectFilteredBtn.addEventListener('click', () => {
          // включает режим "по фильтру", но всё равно требует подтверждения на submit
          if (!confirm('Переназначить ВСЕ компании по текущему фильтру?')) return;
          if (modeEl) modeEl.value = 'filtered';
          if (hintEl) hintEl.textContent = ' (все по фильтру)';
          if (form) form.style.display = 'block';
          if (countEl) countEl.textContent = '{{ companies_filtered }}';
        });
      }

      // Проверка прав на передачу выбранных компаний
      function checkTransferRights() {
        const checked = items.filter(i => i.checked);
        const transferBtn = document.getElementById('bulkTransferBtn');
        if (!transferBtn) return;
        
        if (checked.length === 0) {
          transferBtn.disabled = false;
          transferBtn.title = '';
          transferBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          return;
        }
        
        // Проверяем, все ли выбранные компании можно передать
        const forbidden = checked.filter(i => i.dataset.canTransfer === '0');
        
        if (forbidden.length > 0) {
          transferBtn.disabled = true;
          transferBtn.title = 'Одна или несколько выбранных компаний не принадлежат вам (вы не ответственный). Уберите их из выбора или откройте только свои компании.';
          transferBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          transferBtn.disabled = false;
          transferBtn.title = '';
          transferBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
      
      // Обновляем функцию update для проверки прав
      const originalUpdate = update;
      update = function() {
        originalUpdate();
        checkTransferRights();
      };
      
      update();
    })();
  </script>

  <script>
    // Автодополнение для поля поиска
    (function() {
      const searchInput = document.getElementById('company-search-input');
      const dropdown = document.getElementById('company-autocomplete-dropdown');
      if (!searchInput || !dropdown) return;

      let debounceTimer = null;
      let abortController = null;

      function formatRelativeTime(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'только что';
        if (diffMins < 60) return `${diffMins} мин. назад`;
        if (diffHours < 24) return `${diffHours} ч. назад`;
        if (diffDays < 7) return `${diffDays} дн. назад`;
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      function updateRelativeTimes() {
        document.querySelectorAll('[data-updated-at]').forEach(el => {
          const dateStr = el.getAttribute('data-updated-at');
          if (dateStr) {
            el.textContent = formatRelativeTime(dateStr);
          }
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function highlightMatch(text, query) {
        if (!query || !text) return escapeHtml(text);
        const escapedText = escapeHtml(text);
        
        // Нормализуем запрос и текст (убираем пробелы, скобки, дефисы для телефонных номеров)
        const normalizeForSearch = (str) => str.replace(/[\s\-()]/g, '').toLowerCase();
        const normalizedQuery = normalizeForSearch(query);
        const normalizedText = normalizeForSearch(escapedText);
        
        // Сначала пробуем найти точное совпадение в оригинальном тексте
        const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        let regex = new RegExp(`(${escapedQuery})`, 'gi');
        let result = escapedText.replace(regex, '<span style="font-weight: bold !important; color: #f97316 !important; background-color: #fff7ed !important;">$1</span>');
        
        // Если не нашли, пробуем найти нормализованный запрос
        if (!result.includes('<span') && normalizedQuery && normalizedQuery.length > 0) {
          // Находим все вхождения нормализованного запроса в нормализованном тексте
          const escapedNormalizedQuery = normalizedQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const normalizedRegex = new RegExp(escapedNormalizedQuery, 'gi');
          const matches = [...normalizedText.matchAll(normalizedRegex)];
          
          if (matches.length > 0) {
            // Строим результат, вставляя подсветку в нужные места оригинального текста
            let highlightedText = escapedText;
            // Идем с конца, чтобы не сбить позиции при вставке
            for (let i = matches.length - 1; i >= 0; i--) {
              const match = matches[i];
              const normalizedStart = match.index;
              const normalizedEnd = normalizedStart + match[0].length;
              
              // Находим соответствующие позиции в оригинальном тексте
              let origStart = 0, origEnd = 0;
              let normalizedPos = 0;
              
              for (let j = 0; j < escapedText.length; j++) {
                const char = escapedText[j];
                if (!/[\s\-()]/.test(char)) {
                  if (normalizedPos === normalizedStart) origStart = j;
                  if (normalizedPos === normalizedEnd - 1) {
                    origEnd = j + 1;
                    break;
                  }
                  normalizedPos++;
                }
              }
              
              if (origEnd > origStart) {
                const before = highlightedText.substring(0, origStart);
                const matchText = highlightedText.substring(origStart, origEnd);
                const after = highlightedText.substring(origEnd);
                highlightedText = before + '<span style="font-weight: bold !important; color: #f97316 !important; background-color: #fff7ed !important;">' + matchText + '</span>' + after;
              }
            }
            result = highlightedText;
          }
        }
        
        return result;
      }

      function renderDropdown(items) {
        dropdown.innerHTML = '';
        if (!items || items.length === 0) {
          dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-brand-dark/70">Ничего не найдено</div>';
          dropdown.classList.remove('hidden');
          return;
        }

        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'px-4 py-2 hover:bg-brand-soft/40 cursor-pointer border-b border-brand-soft/50 last:border-b-0';
          
          const query = item.query || '';
          
          // Подсвечиваем совпадения везде, где встречается запрос
          let nameHtml = highlightMatch(item.name || '', query);
          
          // Подсвечиваем совпадения в ИНН
          let innHtml = '';
          if (item.inn) {
            innHtml = `<div class="text-xs text-brand-dark/70 mt-0.5">ИНН: ${highlightMatch(item.inn, query)}</div>`;
          }
          
          // Подсвечиваем совпадения в адресе
          let addressHtml = '';
          if (item.address) {
            addressHtml = `<div class="text-xs text-brand-dark/70 mt-0.5">${highlightMatch(item.address, query)}</div>`;
          }
          
          // Показываем телефон, если поиск был по телефону или есть совпадение
          let phoneHtml = '';
          if (item.phone) {
            phoneHtml = `<div class="text-xs text-brand-dark/70 mt-0.5">Телефон: ${highlightMatch(item.phone, query)}</div>`;
          }
          
          // Показываем email, если поиск был по email или есть совпадение
          let emailHtml = '';
          if (item.email) {
            emailHtml = `<div class="text-xs text-brand-dark/70 mt-0.5">Email: ${highlightMatch(item.email, query)}</div>`;
          }
          
          div.innerHTML = `
            <div class="font-medium text-sm">${nameHtml}</div>
            ${innHtml}
            ${addressHtml}
            ${phoneHtml}
            ${emailHtml}
          `;
          div.addEventListener('click', () => {
            window.location.href = item.url;
          });
          dropdown.appendChild(div);
        });
        dropdown.classList.remove('hidden');
      }

      function fetchAutocomplete(query) {
        // Отменяем предыдущий запрос, если он есть
        if (abortController) {
          abortController.abort();
        }

        if (query.length < 2) {
          dropdown.classList.add('hidden');
          return;
        }

        // Создаем новый AbortController для этого запроса
        abortController = new AbortController();

        fetch(`/companies/autocomplete/?q=${encodeURIComponent(query)}`, {
          signal: abortController.signal
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.items && data.items.length > 0) {
              renderDropdown(data.items);
            } else {
              dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-brand-dark/70">Ничего не найдено</div>';
              dropdown.classList.remove('hidden');
            }
            abortController = null;
          })
          .catch(err => {
            if (err.name !== 'AbortError') {
              console.error('Autocomplete error:', err);
              dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-red-600">Ошибка загрузки</div>';
              dropdown.classList.remove('hidden');
            }
            abortController = null;
          });
      }

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          fetchAutocomplete(query);
        }, 300);
      });

      searchInput.addEventListener('focus', () => {
        const query = searchInput.value.trim();
        if (query.length >= 2) {
          fetchAutocomplete(query);
        }
      });

      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });

      // Обновляем относительное время при загрузке страницы
      updateRelativeTimes();
      // Обновляем каждую минуту
      setInterval(updateRelativeTimes, 60000);
    })();
  </script>
{% endblock %}


