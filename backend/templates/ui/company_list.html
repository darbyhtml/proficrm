{% extends "ui/base.html" %}
{% block title %}Компании — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="flex items-end justify-between gap-3">
        <div>
          <h1 class="text-2xl font-semibold">Компании</h1>
            <div class="text-sm text-brand-dark/70 flex flex-wrap items-center gap-2">
              <span>Поиск по названию, ИНН, адресу</span>
              <span class="badge">Всего: <b class="ml-1">{{ companies_total }}</b></span>
              {% if filter_active and companies_filtered != companies_total %}
                <span class="badge badge-warn">По фильтру: <b class="ml-1">{{ companies_filtered }}</b></span>
              {% endif %}
            </div>
        </div>
        <div class="flex gap-2">
          <a href="/companies/new/" class="btn btn-primary">+ Добавить компанию</a>
          {% if request.user.is_superuser or request.user.role == 'admin' %}
            <a href="/companies/export/?q={{ q }}&responsible={{ responsible }}&status={{ status }}&branch={{ branch }}&sphere={{ sphere }}&contract_type={{ contract_type }}&cold_call={{ cold_call }}&overdue={{ overdue }}" class="btn btn-outline">Экспорт CSV</a>
          {% endif %}
        </div>
      </div>
    </div>

    <form class="card card-pad grid grid-cols-1 md:grid-cols-10 gap-3" method="get">
      <div class="md:col-span-2">
        <label class="block text-sm text-brand-dark/80 mb-1">Поиск</label>
        <input name="q" value="{{ q }}" class="input" placeholder="ИНН / название / адрес" />
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Ответственный</label>
        <select name="responsible" class="select">
          <option value="">Любой</option>
          {% for u in responsibles %}
            <option value="{{ u.id }}" {% if responsible == u.id|stringformat:"s" %}selected{% endif %}>
              {{ u }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Статус</label>
        <select name="status" class="select">
          <option value="">Любой</option>
          {% for s in statuses %}
            <option value="{{ s.id }}" {% if status == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Филиал</label>
        <select name="branch" class="select">
          <option value="">Любой</option>
          {% for b in branches %}
            <option value="{{ b.id }}" {% if branch == b.id|stringformat:"s" %}selected{% endif %}>{{ b.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Сфера</label>
        <select name="sphere" class="select">
          <option value="">Любая</option>
          {% for s in spheres %}
            <option value="{{ s.id }}" {% if sphere == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Вид договора</label>
        <select name="contract_type" class="select">
          <option value="">Любой</option>
          {% for val, label in contract_types %}
            <option value="{{ val }}" {% if contract_type == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Холодный звонок</label>
        <select name="cold_call" class="select">
          <option value="">Любой</option>
          <option value="1" {% if cold_call == "1" %}selected{% endif %}>Да</option>
          <option value="0" {% if cold_call == "0" %}selected{% endif %}>Нет</option>
        </select>
      </div>
      <div class="md:col-span-10 flex flex-col md:flex-row md:items-end md:flex-wrap gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80 md:mr-2">
          <input type="checkbox" name="overdue" value="1" {% if overdue == '1' %}checked{% endif %} />
          Только с просрочками
        </label>
        <div class="w-full md:w-auto">
          <label class="block text-xs text-brand-dark/70 mb-1">Сортировка</label>
          <select name="sort" class="select w-full md:w-auto">
            <option value="updated_at" {% if sort == 'updated_at' %}selected{% endif %}>По обновлению</option>
            <option value="name" {% if sort == 'name' %}selected{% endif %}>По названию</option>
            <option value="inn" {% if sort == 'inn' %}selected{% endif %}>По ИНН</option>
            <option value="status" {% if sort == 'status' %}selected{% endif %}>По статусу</option>
            <option value="responsible" {% if sort == 'responsible' %}selected{% endif %}>По ответственному</option>
            <option value="branch" {% if sort == 'branch' %}selected{% endif %}>По филиалу</option>
          </select>
        </div>
        <div class="w-full md:w-auto">
          <label class="block text-xs text-brand-dark/70 mb-1">Направление</label>
          <select name="dir" class="select w-full md:w-auto">
            <option value="asc" {% if dir == 'asc' %}selected{% endif %}>А → Я</option>
            <option value="desc" {% if dir == 'desc' %}selected{% endif %}>Я → А</option>
          </select>
        </div>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-primary" type="submit">Поиск</button>
          <a class="btn btn-outline" href="/companies/">Сброс</a>
        </div>
      </div>
    </form>

    <form method="post" action="/companies/bulk-transfer/" class="card card-pad" id="bulkTransferForm" style="display:none">
      {% csrf_token %}
      <input type="hidden" name="apply_mode" id="bulkApplyMode" value="selected" />
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="hidden" name="responsible" value="{{ responsible }}" />
      <input type="hidden" name="status" value="{{ status }}" />
      <input type="hidden" name="branch" value="{{ branch }}" />
      <input type="hidden" name="sphere" value="{{ sphere }}" />
      <input type="hidden" name="contract_type" value="{{ contract_type }}" />
      <input type="hidden" name="cold_call" value="{{ cold_call }}" />
      <input type="hidden" name="overdue" value="{{ overdue }}" />

      <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
        <div class="text-sm text-brand-dark/80">
          Выбрано: <b id="bulkSelectedCount">0</b>
          <span class="muted-2 ml-2" id="bulkModeHint"></span>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <select name="responsible_id" class="select" style="min-width:260px">
            <option value="">Новый ответственный…</option>
            {% for u in transfer_targets %}
              <option value="{{ u.id }}">{{ u }} ({{ u.get_role_display }})</option>
            {% endfor %}
          </select>
          <button class="btn btn-primary" type="submit" onclick="return confirm('Переназначить выбранные компании?');">Переназначить</button>
          <button class="btn btn-outline" type="button" id="bulkSelectFiltered">Выбрать все по фильтру</button>
          <button class="btn btn-outline" type="button" id="bulkClear">Снять выделение</button>
        </div>
      </div>
      <div class="text-xs muted-2 mt-2">
        Совет: чтобы переназначить “все компании сотрудника”, отфильтруйте по ответственному → нажмите <b>Выбрать все по фильтру</b> → выберите нового ответственного → Переназначить.
      </div>
    </form>

    <div class="card overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th class="text-left px-4 py-3" style="width:44px">
                <input type="checkbox" id="bulkSelectAll" />
              </th>
              {% if "name" in company_list_columns %}<th class="text-left px-4 py-3">Компания</th>{% endif %}
              {% if "overdue" in company_list_columns %}<th class="text-left px-4 py-3">Просрочки</th>{% endif %}
              {% if "inn" in company_list_columns %}<th class="text-left px-4 py-3">ИНН</th>{% endif %}
              {% if "status" in company_list_columns %}<th class="text-left px-4 py-3">Статус</th>{% endif %}
              {% if "spheres" in company_list_columns %}<th class="text-left px-4 py-3">Сферы</th>{% endif %}
              {% if "responsible" in company_list_columns %}<th class="text-left px-4 py-3">Ответственный</th>{% endif %}
              {% if "branch" in company_list_columns %}<th class="text-left px-4 py-3">Филиал</th>{% endif %}
              {% if "updated_at" in company_list_columns %}<th class="text-left px-4 py-3">Обновлено</th>{% endif %}
            </tr>
          </thead>
          <tbody>
            {% for c in page.object_list %}
              <tr onclick="window.location='/companies/{{ c.id }}/'" style="cursor:pointer">
                <td onclick="event.stopPropagation()">
                  <input class="bulk-company" type="checkbox" name="company_ids" value="{{ c.id }}" form="bulkTransferForm" />
                </td>
                {% if "name" in company_list_columns %}
                  <td>
                    <a class="link" href="/companies/{{ c.id }}/" onclick="event.stopPropagation()">{{ c.name }}</a>
                    {% if c.is_cold_call %}
                      <span class="badge badge-warn ml-2" style="padding:.1rem .35rem;font-size:.65rem">Холодный</span>
                    {% endif %}
                    {% if "address" in company_list_columns %}
                      <div class="text-xs text-brand-dark/70">{{ c.address }}</div>
                    {% endif %}
                  </td>
                {% endif %}
                {% if "overdue" in company_list_columns %}
                  <td>
                    {% if c.has_overdue %}
                      <span class="badge badge-warn">Да</span>
                    {% else %}
                      <span class="muted-2">—</span>
                    {% endif %}
                  </td>
                {% endif %}
                {% if "inn" in company_list_columns %}<td>{{ c.inn }}</td>{% endif %}
                {% if "status" in company_list_columns %}<td>{{ c.status|default:"—" }}</td>{% endif %}
                {% if "spheres" in company_list_columns %}
                  <td>
                    {% for s in c.spheres.all %}
                      <span class="badge mr-1 mb-1">{{ s.name }}</span>
                    {% empty %}
                      <span class="text-brand-dark/70">—</span>
                    {% endfor %}
                  </td>
                {% endif %}
                {% if "responsible" in company_list_columns %}<td>{{ c.responsible }}</td>{% endif %}
                {% if "branch" in company_list_columns %}<td>{{ c.branch }}</td>{% endif %}
                {% if "updated_at" in company_list_columns %}<td class="muted">{{ c.updated_at }}</td>{% endif %}
              </tr>
            {% empty %}
              <tr><td class="muted" colspan="20" style="padding:1.25rem 1rem">Ничего не найдено.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="flex items-center justify-between px-4 py-3 border-t text-sm">
        <div class="text-brand-dark/70">Стр. {{ page.number }} / {{ page.paginator.num_pages }}</div>
        <div class="flex gap-2">
          {% if page.has_previous %}
            <a class="rounded-lg border border-brand-soft px-3 py-1.5 hover:bg-brand-soft/40" href="?q={{ q }}&responsible={{ responsible }}&status={{ status }}&branch={{ branch }}&sphere={{ sphere }}&contract_type={{ contract_type }}&cold_call={{ cold_call }}&overdue={{ overdue }}&sort={{ sort }}&dir={{ dir }}&page={{ page.previous_page_number }}">Назад</a>
          {% endif %}
          {% if page.has_next %}
            <a class="rounded-lg border border-brand-soft px-3 py-1.5 hover:bg-brand-soft/40" href="?q={{ q }}&responsible={{ responsible }}&status={{ status }}&branch={{ branch }}&sphere={{ sphere }}&contract_type={{ contract_type }}&cold_call={{ cold_call }}&overdue={{ overdue }}&sort={{ sort }}&dir={{ dir }}&page={{ page.next_page_number }}">Вперёд</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const form = document.getElementById('bulkTransferForm');
      const selectAll = document.getElementById('bulkSelectAll');
      const items = Array.from(document.querySelectorAll('.bulk-company'));
      const countEl = document.getElementById('bulkSelectedCount');
      const clearBtn = document.getElementById('bulkClear');
      const selectFilteredBtn = document.getElementById('bulkSelectFiltered');
      const modeEl = document.getElementById('bulkApplyMode');
      const hintEl = document.getElementById('bulkModeHint');

      function selectedCount() {
        return items.filter(i => i.checked).length;
      }

      function update() {
        const cnt = selectedCount();
        if (countEl) countEl.textContent = String(cnt);
        if (form) form.style.display = (cnt > 0) ? 'block' : 'none';
        if (selectAll) selectAll.checked = (cnt > 0 && cnt === items.length);
        if (modeEl) modeEl.value = 'selected';
        if (hintEl) hintEl.textContent = cnt ? ' (выбранные на странице)' : '';
      }

      if (selectAll) {
        selectAll.addEventListener('change', () => {
          const v = !!selectAll.checked;
          items.forEach(i => { i.checked = v; });
          update();
        });
      }

      items.forEach(i => i.addEventListener('change', update));

      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          items.forEach(i => { i.checked = false; });
          update();
        });
      }

      if (selectFilteredBtn) {
        selectFilteredBtn.addEventListener('click', () => {
          // включает режим "по фильтру", но всё равно требует подтверждения на submit
          if (!confirm('Переназначить ВСЕ компании по текущему фильтру?')) return;
          if (modeEl) modeEl.value = 'filtered';
          if (hintEl) hintEl.textContent = ' (все по фильтру)';
          if (form) form.style.display = 'block';
          if (countEl) countEl.textContent = '{{ companies_filtered }}';
        });
      }

      update();
    })();
  </script>
{% endblock %}


