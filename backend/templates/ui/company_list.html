{% extends "ui/base.html" %}
{% block title %}Компании — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="flex items-end justify-between gap-3">
        <div>
          <h1 class="text-2xl font-semibold">Компании</h1>
            <div class="text-sm text-brand-dark/70 flex flex-wrap items-center gap-2">
              <span>Поиск по названию, ИНН, адресу</span>
              <span class="badge" id="companiesTotalBadge">Всего: <b class="ml-1">{{ companies_total }}</b></span>
              <span
                class="badge badge-warn {% if not filter_active or companies_filtered == companies_total %}hidden{% endif %}"
                id="companiesFilteredBadge"
              >
                По фильтру: <b class="ml-1">{{ companies_filtered }}</b>
              </span>
            </div>
        </div>
        <div class="flex gap-2">
          <a href="/companies/new/" class="btn btn-primary">+ Добавить компанию</a>
          {% if is_admin %}
            <a href="/companies/export/?q={{ q }}&responsible={{ responsible }}&status={{ status }}&branch={{ branch }}&sphere={{ sphere }}&contract_type={{ contract_type }}&region={{ region }}&overdue={{ overdue }}&sort={{ sort }}&dir={{ dir }}" class="btn btn-outline">Экспорт CSV</a>
          {% endif %}
        </div>
      </div>
    </div>

    <form class="card card-pad space-y-4" method="get" id="companyFilterForm">
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Поиск</label>
        <div class="relative">
          <input name="q" value="{{ q }}" id="company-search-input" class="input w-full" placeholder="ИНН / название / адрес" autocomplete="off" />
          <div id="company-search-loading" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
            <div class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-brand-teal border-t-transparent"></div>
          </div>
        </div>
        <div class="text-xs text-brand-dark/60 mt-1">Результаты поиска отображаются в таблице ниже</div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3 items-end">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Ответственный</label>
          <select name="responsible" class="select w-full">
            <option value="">Любой</option>
            {% if has_companies_without_responsible %}
              <option value="none" {% if responsible == "none" %}selected{% endif %}>None</option>
            {% endif %}
            {% regroup responsibles by branch as branches_list %}
            {% for branch_group in branches_list %}
              <optgroup label="Филиал: {{ branch_group.grouper.name|default:"Без филиала" }}">
                {% for u in branch_group.list %}
                  <option value="{{ u.id }}" {% if responsible == u.id|stringformat:"s" %}selected{% endif %}>
                    {{ u }}
                  </option>
                {% endfor %}
              </optgroup>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Статус</label>
          <select name="status" class="select w-full">
            <option value="">Любой</option>
            {% for s in statuses %}
              <option value="{{ s.id }}" {% if status == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Филиал</label>
          <select name="branch" class="select w-full">
            <option value="">Любой</option>
            {% for b in branches %}
              <option value="{{ b.id }}" {% if branch == b.id|stringformat:"s" %}selected{% endif %}>{{ b.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Сфера</label>
          <select name="sphere" class="select w-full">
            <option value="">Любая</option>
            {% for s in spheres %}
              <option value="{{ s.id }}" {% if sphere == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Вид договора</label>
          <select name="contract_type" class="select w-full">
            <option value="">Любой</option>
            {% for ct in contract_types %}
              <option value="{{ ct.id }}" {% if contract_type == ct.id|stringformat:"s" %}selected{% endif %}>{{ ct.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Область</label>
          <select name="region" class="select w-full">
            <option value="">Любая</option>
            {% for r in regions %}
              <option value="{{ r.id }}" {% if region == r.id|stringformat:"s" %}selected{% endif %}>{{ r.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="flex flex-col md:flex-row md:items-center md:flex-wrap gap-2 justify-between">
        <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
          <input type="checkbox" name="overdue" value="1" {% if overdue == '1' %}checked{% endif %} />
          Только с просрочками
        </label>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-primary" type="submit" id="filterSubmitBtn">Поиск</button>
          <a class="btn btn-outline" href="/companies/" id="filterResetBtn">Сброс</a>
        </div>
      </div>
    </form>

    <form method="post" action="/companies/bulk-transfer/" class="card card-pad" id="bulkTransferForm" style="display:none">
      {% csrf_token %}
      <input type="hidden" name="apply_mode" id="bulkApplyMode" value="selected" />
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="hidden" name="responsible" value="{{ responsible }}" />
      <input type="hidden" name="status" value="{{ status }}" />
      <input type="hidden" name="branch" value="{{ branch }}" />
      <input type="hidden" name="sphere" value="{{ sphere }}" />
      <input type="hidden" name="contract_type" value="{{ contract_type }}" />
      <input type="hidden" name="region" value="{{ region }}" />
      <input type="hidden" name="cold_call" value="{{ cold_call }}" />
      <input type="hidden" name="overdue" value="{{ overdue }}" />

      <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
        <div class="text-sm text-brand-dark/80">
          Выбрано: <b id="bulkSelectedCount">0</b>
          <span class="muted-2 ml-2" id="bulkModeHint"></span>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <select name="responsible_id" class="select" style="min-width:260px">
            <option value="">Новый ответственный…</option>
            {% regroup transfer_targets by branch as branches_list %}
            {% for branch_group in branches_list %}
              <optgroup label="Филиал: {{ branch_group.grouper.name|default:"Без филиала" }}">
                {% for u in branch_group.list %}
                  <option value="{{ u.id }}">{{ u }} ({{ u.get_role_display }})</option>
                {% endfor %}
              </optgroup>
            {% endfor %}
          </select>
          <button class="btn btn-primary" type="button" id="bulkTransferBtn" title="">Переназначить</button>
          <button class="btn btn-outline" type="button" id="bulkSelectFiltered">Выбрать все по фильтру</button>
          <button class="btn btn-outline" type="button" id="bulkClear">Снять выделение</button>
        </div>
      </div>
      <div class="text-xs muted-2 mt-2">
        Совет: чтобы переназначить “все компании сотрудника”, отфильтруйте по ответственному → нажмите <b>Выбрать все по фильтру</b> → выберите нового ответственного → Переназначить.
      </div>
    </form>

    <!-- Индикатор загрузки -->
    <div id="companyListLoading" class="hidden fixed inset-0 z-40 flex items-center justify-center" style="background: rgba(0, 61, 56, 0.15);">
      <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center gap-4" style="border: 1px solid rgba(194, 226, 222, 0.9);">
        <div class="inline-block animate-spin rounded-full h-12 w-12" style="border: 3px solid rgba(194, 226, 222, 0.3); border-top-color: #01948E;"></div>
        <div style="color: #003D38; font-weight: 500;">Загрузка компаний...</div>
      </div>
    </div>

      <div class="card overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th class="text-left px-4 py-3" style="width:44px">
                <input type="checkbox" id="bulkSelectAll" />
              </th>
              {% if "name" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="#" data-sort="name" class="sort-link flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'name' %}text-brand-orange font-bold{% endif %}">
                    Компания
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'name' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'name' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "overdue" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  Просрочки
                </th>
              {% endif %}
              {% if "inn" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="#" data-sort="inn" class="sort-link flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'inn' %}text-brand-orange font-bold{% endif %}">
                    ИНН
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'inn' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'inn' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "status" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="#" data-sort="status" class="sort-link flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'status' %}text-brand-orange font-bold{% endif %}">
                    Статус
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'status' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'status' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "spheres" in company_list_columns %}
                <th class="text-left px-4 py-3">Сферы</th>
              {% endif %}
              {% if "responsible" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="#" data-sort="responsible" class="sort-link flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'responsible' %}text-brand-orange font-bold{% endif %}">
                    Ответственный
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'responsible' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'responsible' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "branch" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="#" data-sort="branch" class="sort-link flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'branch' %}text-brand-orange font-bold{% endif %}">
                    Филиал
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "region" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="#" data-sort="region" class="sort-link flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'region' %}text-brand-orange font-bold{% endif %}">
                    Область
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'region' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'region' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
              {% if "updated_at" in company_list_columns %}
                <th class="text-left px-4 py-3">
                  <a href="#" data-sort="updated_at" class="sort-link flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'updated_at' %}text-brand-orange font-bold{% endif %}">
                    Обновлено
                    <div class="flex flex-col gap-0.5">
                      <svg class="w-3 h-3 {% if sort_field == 'updated_at' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                      </svg>
                      <svg class="w-3 h-3 {% if sort_field == 'updated_at' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>
                  </a>
                </th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="companyListBody">
            {% for c in page.object_list %}
              <tr onclick="window.location='/companies/{{ c.id }}/'" style="cursor:pointer" class="{% if c.has_overdue %}company-row-overdue{% endif %}">
                <td onclick="event.stopPropagation()">
                  <input class="bulk-company" type="checkbox" name="company_ids" value="{{ c.id }}" form="bulkTransferForm" data-can-transfer="{% if c.can_transfer %}1{% else %}0{% endif %}" />
                </td>
                {% if "name" in company_list_columns %}
                  <td>
                    <a class="link" href="/companies/{{ c.id }}/" onclick="event.stopPropagation()">{{ c.name }}</a>
                    {% if "address" in company_list_columns %}
                      <div class="text-xs text-brand-dark/70">{{ c.address }}</div>
                    {% endif %}
                  </td>
                {% endif %}
                {% if "overdue" in company_list_columns %}
                  <td>
                    {% if c.has_overdue %}
                      <span class="badge badge-warn">Да</span>
                    {% else %}
                      <span class="muted-2">—</span>
                    {% endif %}
                  </td>
                {% endif %}
                {% if "inn" in company_list_columns %}<td>{{ c.inn }}</td>{% endif %}
                {% if "status" in company_list_columns %}
                  <td>
                    {% if c.status %}
                      <span class="badge">{{ c.status.name }}</span>
                    {% else %}
                      <span class="muted-2">—</span>
                    {% endif %}
                  </td>
                {% endif %}
                {% if "spheres" in company_list_columns %}
                  <td>
                    {% for s in c.spheres.all %}
                      <span class="badge mr-1 mb-1">{{ s.name }}</span>
                    {% empty %}
                      <span class="text-brand-dark/70">—</span>
                    {% endfor %}
                  </td>
                {% endif %}
                {% if "responsible" in company_list_columns %}<td>{{ c.responsible }}</td>{% endif %}
                {% if "branch" in company_list_columns %}<td>{{ c.branch }}</td>{% endif %}
                {% if "region" in company_list_columns %}<td>{{ c.region }}</td>{% endif %}
                {% if "updated_at" in company_list_columns %}
                  <td class="muted">
                    <div>{{ c.updated_at|date:"d.m.Y H:i" }}</div>
                    <div class="text-xs text-brand-dark/60 mt-0.5" data-updated-at="{{ c.updated_at|date:'c' }}"></div>
                  </td>
                {% endif %}
              </tr>
            {% empty %}
              <tr><td class="muted" colspan="20" style="padding:1.25rem 1rem">Ничего не найдено.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="border-t px-4 py-3 flex items-center justify-between gap-4 flex-wrap" id="companyListPagination">
        <div class="flex items-center gap-2">
          <form method="get" class="flex items-center gap-2" id="perPageForm">
            <label class="text-sm text-brand-dark/70 whitespace-nowrap">На странице:</label>
            <select name="per_page" class="select" id="perPageSelect" style="padding:.25rem .5rem;font-size:.875rem;min-width:auto">
              <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
            </select>
            {% if q %}<input type="hidden" name="q" value="{{ q }}" />{% endif %}
            {% if responsible %}<input type="hidden" name="responsible" value="{{ responsible }}" />{% endif %}
            {% if status %}<input type="hidden" name="status" value="{{ status }}" />{% endif %}
            {% if branch %}<input type="hidden" name="branch" value="{{ branch }}" />{% endif %}
            {% if sphere %}<input type="hidden" name="sphere" value="{{ sphere }}" />{% endif %}
            {% if contract_type %}<input type="hidden" name="contract_type" value="{{ contract_type }}" />{% endif %}
            {% if region %}<input type="hidden" name="region" value="{{ region }}" />{% endif %}
            {% if overdue %}<input type="hidden" name="overdue" value="{{ overdue }}" />{% endif %}
            {% if sort %}<input type="hidden" name="sort" value="{{ sort }}" />{% endif %}
            {% if dir %}<input type="hidden" name="dir" value="{{ dir }}" />{% endif %}
          </form>
        </div>
        <div id="paginationContainer">
          {% include "ui/_pagination.html" with page=page qs=qs %}
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для превью массового переназначения -->
  <div id="bulkTransferModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center" style="display: none;">
    <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
      <div class="px-6 py-4 border-b border-brand-soft flex items-center justify-between">
        <h2 class="text-xl font-semibold">Подтверждение массового переназначения</h2>
        <button type="button" id="bulkTransferModalClose" class="text-brand-dark/60 hover:text-brand-dark text-2xl leading-none">&times;</button>
      </div>
      <div class="px-6 py-4 overflow-y-auto flex-1" id="bulkTransferModalContent">
        <div class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-brand-teal"></div>
          <p class="mt-4 text-brand-dark/70">Загрузка превью...</p>
        </div>
      </div>
      <div class="px-6 py-4 border-t border-brand-soft flex items-center justify-end gap-3">
        <button type="button" id="bulkTransferModalCancel" class="btn btn-outline">Отмена</button>
        <button type="button" id="bulkTransferModalConfirm" class="btn btn-primary" disabled>Подтвердить переназначение</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const form = document.getElementById('bulkTransferForm');
      const selectAll = document.getElementById('bulkSelectAll');
      const items = Array.from(document.querySelectorAll('.bulk-company'));
      const countEl = document.getElementById('bulkSelectedCount');
      const clearBtn = document.getElementById('bulkClear');
      const selectFilteredBtn = document.getElementById('bulkSelectFiltered');
      const modeEl = document.getElementById('bulkApplyMode');
      const hintEl = document.getElementById('bulkModeHint');

      function selectedCount() {
        return items.filter(i => i.checked).length;
      }

      function update() {
        const cnt = selectedCount();
        if (countEl) countEl.textContent = String(cnt);
        if (form) form.style.display = (cnt > 0) ? 'block' : 'none';
        if (selectAll) selectAll.checked = (cnt > 0 && cnt === items.length);
        if (modeEl) modeEl.value = 'selected';
        if (hintEl) hintEl.textContent = cnt ? ' (выбранные на странице)' : '';
      }

      if (selectAll) {
        selectAll.addEventListener('change', () => {
          const v = !!selectAll.checked;
          items.forEach(i => { i.checked = v; });
          update();
        });
      }

      items.forEach(i => i.addEventListener('change', update));

      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          items.forEach(i => { i.checked = false; });
          update();
        });
      }

      if (selectFilteredBtn) {
        selectFilteredBtn.addEventListener('click', () => {
          // включает режим "по фильтру", но всё равно требует подтверждения на submit
          if (!confirm('Переназначить ВСЕ компании по текущему фильтру?')) return;
          if (modeEl) modeEl.value = 'filtered';
          if (hintEl) hintEl.textContent = ' (все по фильтру)';
          if (form) form.style.display = 'block';
          if (countEl) countEl.textContent = '{{ companies_filtered }}';
        });
      }

      // Проверка прав на передачу выбранных компаний
      function checkTransferRights() {
        const checked = items.filter(i => i.checked);
        const transferBtn = document.getElementById('bulkTransferBtn');
        if (!transferBtn) return;
        
        if (checked.length === 0) {
          transferBtn.disabled = false;
          transferBtn.title = '';
          transferBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          return;
        }
        
        // Проверяем, все ли выбранные компании можно передать
        const forbidden = checked.filter(i => i.dataset.canTransfer === '0');
        
        if (forbidden.length > 0) {
          transferBtn.disabled = true;
          transferBtn.title = 'Одна или несколько выбранных компаний не принадлежат вам (вы не ответственный). Уберите их из выбора или откройте только свои компании.';
          transferBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          transferBtn.disabled = false;
          transferBtn.title = '';
          transferBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
      
      // Обновляем функцию update для проверки прав
      const originalUpdate = update;
      update = function() {
        originalUpdate();
        checkTransferRights();
      };
      
      // Модальное окно для превью
      const modal = document.getElementById('bulkTransferModal');
      const modalContent = document.getElementById('bulkTransferModalContent');
      const modalClose = document.getElementById('bulkTransferModalClose');
      const modalCancel = document.getElementById('bulkTransferModalCancel');
      const modalConfirm = document.getElementById('bulkTransferModalConfirm');
      const transferBtn = document.getElementById('bulkTransferBtn');
      
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      function showModal() {
        if (modal) modal.style.display = 'flex';
      }
      
      function hideModal() {
        if (modal) modal.style.display = 'none';
      }
      
      if (modalClose) modalClose.addEventListener('click', hideModal);
      if (modalCancel) modalCancel.addEventListener('click', hideModal);
      
      // Обработчик клика вне модального окна
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) hideModal();
        });
      }
      
      // Обработчик кнопки "Переназначить"
      if (transferBtn) {
        transferBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          
          const responsibleSelect = form.querySelector('select[name="responsible_id"]');
          const responsibleId = responsibleSelect ? responsibleSelect.value : '';
          
          if (!responsibleId) {
            alert('Выберите нового ответственного');
            return;
          }
          
          // Собираем данные формы
          const formData = new FormData(form);
          formData.append('responsible_id', responsibleId);
          
          // Показываем модальное окно с загрузкой
          showModal();
          modalContent.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-brand-teal"></div><p class="mt-4 text-brand-dark/70">Загрузка превью...</p></div>';
          modalConfirm.disabled = true;
          
          try {
            const response = await fetch('/companies/bulk-transfer/preview/', {
              method: 'POST',
              body: formData,
              headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
              }
            });
            
            const data = await response.json();
            
            if (!response.ok) {
              modalContent.innerHTML = `<div class="py-8"><div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">${data.error || 'Ошибка загрузки превью'}</div></div>`;
              return;
            }
            
            // Отображаем превью
            let html = '<div class="space-y-4">';
            
            // Общая информация
            html += '<div class="bg-brand-soft/30 rounded-lg p-4 space-y-2">';
            const allowedCount = data.allowed_count !== undefined ? data.allowed_count : data.total_count;
            const forbiddenCount = data.forbidden_count || 0;
            html += `<div class="font-semibold">Будет переназначено компаний: <span class="text-brand-teal">${allowedCount}</span>`;
            if (forbiddenCount > 0) {
              html += ` <span class="text-red-600">(пропущено: ${forbiddenCount})</span>`;
            }
            html += '</div>';
            html += `<div class="text-sm text-brand-dark/70">Новый ответственный: <b>${escapeHtml(data.new_responsible.name)}</b> (${escapeHtml(data.new_responsible.role)})`;
            if (data.new_responsible.branch !== '—') {
              html += `, филиал: ${escapeHtml(data.new_responsible.branch)}`;
            }
            html += '</div>';
            
            // Список запрещённых компаний с причинами
            if (forbiddenCount > 0 && data.forbidden && data.forbidden.length > 0) {
              html += '<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">';
              html += `<div class="text-sm font-semibold text-red-800 mb-2">Пропущено компаний (${forbiddenCount}):</div>`;
              html += '<ul class="space-y-1 text-xs text-red-700">';
              data.forbidden.slice(0, 10).forEach(f => {
                html += `<li>• ${escapeHtml(f.name)}: <span class="text-red-600">${escapeHtml(f.reason || 'Недостаточно прав')}</span></li>`;
              });
              if (forbiddenCount > 10) {
                html += `<li class="text-red-600 italic">... и ещё ${forbiddenCount - 10}</li>`;
              }
              html += '</ul></div>';
            }
            
            // Старые ответственные
            if (data.old_responsibles && data.old_responsibles.length > 0) {
              html += '<div class="text-sm text-brand-dark/70 mt-2">';
              html += 'Текущие ответственные: ';
              html += data.old_responsibles.map(r => `${escapeHtml(r.name)} (${r.count})`).join(', ');
              html += '</div>';
            }
            html += '</div>';
            
            // Список компаний (первые 50)
            if (data.companies && data.companies.length > 0) {
              html += '<div class="border border-brand-soft rounded-lg overflow-hidden">';
              html += '<div class="bg-brand-soft/40 px-4 py-2 text-sm font-semibold">Список компаний (первые ' + data.companies.length + (data.total_count > data.companies.length ? ` из ${data.total_count}` : '') + '):</div>';
              html += '<div class="max-h-96 overflow-y-auto">';
              html += '<table class="min-w-full text-sm">';
              html += '<thead class="bg-brand-soft/20"><tr><th class="text-left px-4 py-2">Компания</th><th class="text-left px-4 py-2">ИНН</th><th class="text-left px-4 py-2">Текущий ответственный</th><th class="text-left px-4 py-2">Филиал</th></tr></thead>';
              html += '<tbody>';
              data.companies.forEach(c => {
                html += '<tr class="border-t border-brand-soft/50">';
                html += `<td class="px-4 py-2">${escapeHtml(c.name)}</td>`;
                html += `<td class="px-4 py-2 text-brand-dark/70">${c.inn || '—'}</td>`;
                html += `<td class="px-4 py-2 text-brand-dark/70">${escapeHtml(c.old_responsible)}</td>`;
                html += `<td class="px-4 py-2 text-brand-dark/70">${escapeHtml(c.old_branch)}</td>`;
                html += '</tr>';
              });
              html += '</tbody></table></div></div>';
            }
            
            html += '</div>';
            modalContent.innerHTML = html;
            // Блокируем кнопку подтверждения, если нет разрешённых компаний
            modalConfirm.disabled = (allowedCount === 0);
            
            // Обработчик подтверждения
            modalConfirm.onclick = function() {
              form.submit();
            };
            
          } catch (error) {
            console.error('Error loading preview:', error);
            modalContent.innerHTML = '<div class="py-8"><div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">Ошибка загрузки превью. Попробуйте обновить страницу.</div></div>';
          }
        });
      }
      
      update();
    })();
  </script>

  <script>
    // AJAX-фильтрация и виртуальный скроллинг
    (function() {
      const filterForm = document.getElementById('companyFilterForm');
      const companyListBody = document.getElementById('companyListBody');
      const loadingIndicator = document.getElementById('companyListLoading');
      const paginationContainer = document.getElementById('paginationContainer');
      const perPageSelect = document.getElementById('perPageSelect');
      const sortLinks = document.querySelectorAll('.sort-link');
      const filterSubmitBtn = document.getElementById('filterSubmitBtn');
      const filterResetBtn = document.getElementById('filterResetBtn');
      
      let currentSort = '{{ sort_field }}';
      let currentDir = '{{ sort_dir }}';
      let currentPage = 1;
      let isLoading = false;
      let hasMore = true;
      
      function showLoading() {
        if (loadingIndicator) loadingIndicator.classList.remove('hidden');
        isLoading = true;
      }
      
      function hideLoading() {
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
        isLoading = false;
      }
      
      function buildQueryParams() {
        const formData = new FormData(filterForm);
        const params = new URLSearchParams();
        
        // Добавляем все поля формы
        for (const [key, value] of formData.entries()) {
          if (value) params.append(key, value);
        }
        
        // Добавляем сортировку
        params.append('sort', currentSort);
        params.append('dir', currentDir);
        
        // Добавляем пагинацию
        params.append('page', currentPage);
        
        // Добавляем per_page
        if (perPageSelect) {
          params.append('per_page', perPageSelect.value);
        }
        
        return params;
      }
      
      async function loadCompanies(resetPage = true) {
        if (isLoading) return;
        
        if (resetPage) {
          currentPage = 1;
          hasMore = true;
        }
        
        showLoading();
        
        try {
          const params = buildQueryParams();
          const response = await fetch(`/companies/ajax/?${params.toString()}`);
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'Ошибка загрузки');
          }
          
          // Обновляем тело таблицы (всегда заменяем, не добавляем)
          if (companyListBody) {
            companyListBody.innerHTML = data.html;
            
            // Применяем подсветку совпадений после вставки HTML
            if (typeof window.highlightMatch === 'function') {
              const searchInput = document.getElementById('company-search-input');
              const query = searchInput ? searchInput.value.trim() : '';
              
              if (query) {
                companyListBody.querySelectorAll('.highlight-target').forEach(el => {
                  const text = el.getAttribute('data-text') || el.textContent || '';
                  const highlighted = window.highlightMatch(text, query);
                  el.innerHTML = highlighted;
                });
              }
            }
          }
          
          // Обновляем пагинацию
          if (paginationContainer) {
            const paginationHtml = `
              <div class="flex items-center justify-between px-4 py-3 border-t text-sm">
                <div class="text-brand-dark/70">Стр. ${data.page} / ${data.num_pages}</div>
                <div class="flex gap-2">
                  ${data.has_previous ? `<a href="#" class="pagination-link rounded-lg border border-brand-soft px-3 py-1.5 hover:bg-brand-soft/40" data-page="${data.page - 1}">Назад</a>` : ''}
                  ${data.has_next ? `<a href="#" class="pagination-link rounded-lg border border-brand-soft px-3 py-1.5 hover:bg-brand-soft/40" data-page="${data.page + 1}">Вперёд</a>` : ''}
                </div>
              </div>
            `;
            paginationContainer.innerHTML = paginationHtml;
            
            // Добавляем обработчики для ссылок пагинации
            paginationContainer.querySelectorAll('.pagination-link').forEach(link => {
              link.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = parseInt(link.dataset.page);
                loadCompanies(false);
              });
            });
          }
          
          // Обновляем счетчики
          const totalBadge = document.getElementById('companiesTotalBadge');
          const filteredBadge = document.getElementById('companiesFilteredBadge');
          const totalEl = totalBadge ? totalBadge.querySelector('b') : null;
          const filteredEl = filteredBadge ? filteredBadge.querySelector('b') : null;

          if (totalEl && data.total !== undefined) {
            totalEl.textContent = data.total;
          }

          if (filteredBadge && filteredEl && data.filtered !== undefined && data.total !== undefined) {
            filteredEl.textContent = data.filtered;
            if (data.filtered !== data.total) {
              filteredBadge.classList.remove('hidden');
            } else {
              filteredBadge.classList.add('hidden');
            }
          }
          
          hasMore = data.has_next;
          
          // Обновляем относительное время (если функция доступна)
          setTimeout(() => {
            const updateRelativeTimesEl = document.querySelector('[data-updated-at]');
            if (updateRelativeTimesEl && typeof updateRelativeTimes === 'function') {
              updateRelativeTimes();
            }
          }, 100);
          
          // Обновляем чекбоксы для массового переназначения (если функция доступна)
          setTimeout(() => {
            if (typeof update === 'function') {
              update();
            }
          }, 100);
          
        } catch (error) {
          console.error('Error loading companies:', error);
          if (companyListBody) {
            companyListBody.innerHTML = '<tr><td class="muted" colspan="20" style="padding:1.25rem 1rem">Ошибка загрузки данных.</td></tr>';
          }
        } finally {
          hideLoading();
        }
      }
      
      // Обработчик формы фильтрации
      if (filterForm) {
        filterForm.addEventListener('submit', (e) => {
          e.preventDefault();
          loadCompanies(true);
        });
      }
      
      // Обработчик кнопки сброса
      if (filterResetBtn) {
        filterResetBtn.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = '/companies/';
        });
      }
      
      // Обработчики сортировки
      sortLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const sortField = link.dataset.sort;
          if (currentSort === sortField) {
            currentDir = currentDir === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort = sortField;
            currentDir = 'asc';
          }
          loadCompanies(true);
        });
      });
      
      // Обработчик изменения per_page
      if (perPageSelect) {
        perPageSelect.addEventListener('change', () => {
          loadCompanies(true);
        });
      }
      
      // Автоматическая подгрузка при изменении фильтров
      let filterDebounceTimer = null;
      const filterInputs = filterForm ? filterForm.querySelectorAll('input, select') : [];
      
      filterInputs.forEach(input => {
        // Пропускаем скрытые поля и кнопки
        if (input.type === 'hidden' || input.type === 'submit' || input.type === 'button') {
          return;
        }

        // Поле общего поиска теперь триггерит обновление таблицы
        if (input.id === 'company-search-input') {
          // Обработчик для лайв-поиска в таблице
          let searchDebounceTimer = null;
          input.addEventListener('input', () => {
            const query = input.value.trim();
            const loadingIndicator = document.getElementById('company-search-loading');
            
            // Показываем индикатор загрузки
            if (loadingIndicator) {
              loadingIndicator.classList.remove('hidden');
            }
            
            // Очищаем предыдущий таймер
            if (searchDebounceTimer) {
              clearTimeout(searchDebounceTimer);
            }
            
            // Устанавливаем новый таймер (300ms задержка для лайв-поиска)
            searchDebounceTimer = setTimeout(async () => {
              try {
                await loadCompanies(true);
              } finally {
                // Скрываем индикатор загрузки после завершения
                if (loadingIndicator) {
                  loadingIndicator.classList.add('hidden');
                }
              }
            }, 300);
          });
          return;
        }
        
        input.addEventListener('change', () => {
          // Очищаем предыдущий таймер
          if (filterDebounceTimer) {
            clearTimeout(filterDebounceTimer);
          }
          
          // Устанавливаем новый таймер (500ms задержка)
          filterDebounceTimer = setTimeout(() => {
            loadCompanies(true);
          }, 500);
        });
        
        // Для текстовых полей фильтров (кроме основного поиска) также слушаем input
        if (input.type === 'text') {
          input.addEventListener('input', () => {
            if (filterDebounceTimer) {
              clearTimeout(filterDebounceTimer);
            }
            
            filterDebounceTimer = setTimeout(() => {
              loadCompanies(true);
            }, 500);
          });
        }
      });
    })();
  </script>

  <script>
    // Функция подсветки совпадений (используется в таблице)
    (function() {
      window.highlightMatch = function(text, query) {
        if (!query || !text) return text;
        
        // Экранируем HTML
        const escapeHtml = (str) => {
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        };
        
        const escapedText = escapeHtml(text);
        const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        
        // Нормализуем для поиска: убираем тире, пробелы и т.д.
        const normalize = (str) => {
          return str.replace(/[-—–\s_]/g, '').toLowerCase();
        };
        
        const normalizedQuery = normalize(query);
        const normalizedText = normalize(escapedText);
        
        // Сначала пробуем найти точное совпадение в оригинальном тексте
        let regex = new RegExp(`(${escapedQuery})`, 'gi');
        let result = escapedText.replace(regex, '<span style="font-weight: bold !important; color: #f97316 !important; background-color: #fff7ed !important;">$1</span>');
        
        // Если не нашли, пробуем найти через нормализованные варианты
        if (!result.includes('<span')) {
          // Создаем паттерн, который допускает тире, пробелы между символами
          const patternParts = [];
          for (let i = 0; i < normalizedQuery.length; i++) {
            if (i > 0) {
              patternParts.push("[-\\s_]*");
            }
            patternParts.push(normalizedQuery[i].replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
          }
          const flexiblePattern = patternParts.join('');
          
          // Ищем совпадения в нормализованном тексте
          const flexibleRegex = new RegExp(flexiblePattern, 'i');
          if (flexibleRegex.test(normalizedText)) {
            // Находим позиции в оригинальном тексте
            let highlightedText = escapedText;
            const matches = [...escapedText.matchAll(new RegExp(escapedQuery.replace(/[-—–\s_]/g, '[-—–\\s_]*'), 'gi'))];
            
            for (let i = matches.length - 1; i >= 0; i--) {
              const match = matches[i];
              const before = highlightedText.substring(0, match.index);
              const matchText = highlightedText.substring(match.index, match.index + match[0].length);
              const after = highlightedText.substring(match.index + match[0].length);
              highlightedText = before + '<span style="font-weight: bold !important; color: #f97316 !important; background-color: #fff7ed !important;">' + matchText + '</span>' + after;
            }
            
            result = highlightedText;
          }
        }

        // Если фраза не нашлась, но запрос многословный — подсвечиваем по токенам (не ломая старую логику).
        // Это важно для кейсов типа "пат таштагол" vs "ПАТ', г.Таштагол".
        if (!result.includes('<span') && /\s/.test(query)) {
          // Берем "слова" (кириллица/латиница/цифры), отбрасываем 1-символьные
          const tokens = (query.match(/[0-9A-Za-zА-Яа-яЁё]+/g) || [])
            .map(s => (s || '').toString().trim())
            .filter(s => s.length > 1);
          if (tokens.length) {
            let tokResult = escapedText;
            tokens.forEach(tok => {
              const tokEsc = tok.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const tokRe = new RegExp(`(${tokEsc})`, 'gi');
              tokResult = tokResult.replace(tokRe, '<span style="font-weight: bold !important; color: #f97316 !important; background-color: #fff7ed !important;">$1</span>');
            });
            result = tokResult;
          }
        }
        
        return result;
      };
    })();
    
    // Старый код автодополнения (отключен, но оставлен для совместимости)
    (function() {
      const searchInput = document.getElementById('company-search-input');
      if (!searchInput) return;

      let debounceTimer = null;
      let abortController = null;

      function formatRelativeTime(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'только что';
        if (diffMins < 60) return `${diffMins} мин. назад`;
        if (diffHours < 24) return `${diffHours} ч. назад`;
        if (diffDays < 7) return `${diffDays} дн. назад`;
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      function updateRelativeTimes() {
        document.querySelectorAll('[data-updated-at]').forEach(el => {
          const dateStr = el.getAttribute('data-updated-at');
          if (dateStr) {
            el.textContent = formatRelativeTime(dateStr);
          }
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function highlightMatch(text, query) {
        if (!query || !text) return escapeHtml(text);
        const escapedText = escapeHtml(text);
        
        // Нормализуем для поиска: убираем пробелы, скобки, дефисы, приводим к нижнему регистру
        const normalizePhone = (str) => {
          return str.replace(/[\s\-()]/g, '').toLowerCase();
        };
        
        const normalizedQuery = normalizePhone(query);
        const normalizedText = normalizePhone(escapedText);
        
        // Варианты запроса: исходный и с заменой начальной 8 на +7 (для российских номеров)
        const queryVariants = [normalizedQuery];
        if (normalizedQuery.startsWith('8') && normalizedQuery.length >= 11) {
          queryVariants.push('+7' + normalizedQuery.substring(1));
        }
        if (normalizedQuery.startsWith('+7')) {
          queryVariants.push('8' + normalizedQuery.substring(2));
        }
        
        // Варианты текста: исходный и с заменой начальной +7 на 8
        const textVariants = [normalizedText];
        if (normalizedText.startsWith('+7')) {
          textVariants.push('8' + normalizedText.substring(2));
        }
        if (normalizedText.startsWith('8') && normalizedText.length >= 11) {
          textVariants.push('+7' + normalizedText.substring(1));
        }
        
        // Сначала пробуем найти точное совпадение в оригинальном тексте
        const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        let regex = new RegExp(`(${escapedQuery})`, 'gi');
        let result = escapedText.replace(regex, '<span style="font-weight: bold !important; color: #f97316 !important; background-color: #fff7ed !important;">$1</span>');
        
        // Если не нашли, пробуем найти через нормализованные варианты
        if (!result.includes('<span')) {
          for (const queryVariant of queryVariants) {
            if (!queryVariant) continue;
            
            for (const textVariant of textVariants) {
              if (!textVariant) continue;
              
              const escapedVariant = queryVariant.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const variantRegex = new RegExp(escapedVariant, 'gi');
              const matches = [...textVariant.matchAll(variantRegex)];
              
              if (matches.length > 0) {
                // Находим позиции в оригинальном тексте
                let highlightedText = escapedText;
                
                // Идем с конца, чтобы не сбить позиции при вставке
                for (let i = matches.length - 1; i >= 0; i--) {
                  const match = matches[i];
                  const variantStart = match.index;
                  const variantEnd = variantStart + match[0].length;
                  
                  // Находим соответствующие позиции в оригинальном тексте
                  let origStart = 0, origEnd = 0;
                  let variantPos = 0;
                  
                  for (let j = 0; j < escapedText.length; j++) {
                    const char = escapedText[j];
                    if (!/[\s\-()]/.test(char)) {
                      if (variantPos === variantStart) {
                        origStart = j;
                      }
                      if (variantPos === variantEnd - 1) {
                        origEnd = j + 1;
                        break;
                      }
                      variantPos++;
                    }
                  }
                  
                  if (origEnd > origStart) {
                    const before = highlightedText.substring(0, origStart);
                    const matchText = highlightedText.substring(origStart, origEnd);
                    const after = highlightedText.substring(origEnd);
                    highlightedText = before + '<span style="font-weight: bold !important; color: #f97316 !important; background-color: #fff7ed !important;">' + matchText + '</span>' + after;
                  }
                }
                
                result = highlightedText;
                break;
              }
            }
            
            if (result.includes('<span')) break;
          }
        }
        
        return result;
      }

      function renderDropdown(items) {
        dropdown.innerHTML = '';
        if (!items || items.length === 0) {
          dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-brand-dark/70">Ничего не найдено</div>';
          dropdown.classList.remove('hidden');
          return;
        }

        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'px-4 py-2 hover:bg-brand-soft/40 cursor-pointer border-b border-brand-soft/50 last:border-b-0';
          
          const query = item.query || '';
          
          // Подсвечиваем совпадения везде, где встречается запрос
          let nameHtml = highlightMatch(item.name || '', query);
          
          // Подсвечиваем совпадения в ИНН
          let innHtml = '';
          if (item.inn) {
            innHtml = `<div class="text-xs text-brand-dark/70 mt-0.5">ИНН: ${highlightMatch(item.inn, query)}</div>`;
          }
          
          // Подсвечиваем совпадения в адресе
          let addressHtml = '';
          if (item.address) {
            addressHtml = `<div class="text-xs text-brand-dark/70 mt-0.5">${highlightMatch(item.address, query)}</div>`;
          }
          
          // Показываем телефон, если поиск был по телефону или есть совпадение
          let phoneHtml = '';
          if (item.phone) {
            phoneHtml = `<div class="text-xs text-brand-dark/70 mt-0.5">Телефон: ${highlightMatch(item.phone, query)}</div>`;
          }
          
          // Показываем email, если поиск был по email или есть совпадение
          let emailHtml = '';
          if (item.email) {
            emailHtml = `<div class="text-xs text-brand-dark/70 mt-0.5">Email: ${highlightMatch(item.email, query)}</div>`;
          }

          // Ответственный
          let responsibleHtml = '';
          if (item.responsible) {
            responsibleHtml = `<div class="text-xs mt-0.5" style="color: #003D38; font-weight: 600;">Ответственный: ${escapeHtml(item.responsible)}</div>`;
          }
          
          div.innerHTML = `
            <div class="font-medium text-sm">${nameHtml}</div>
            ${innHtml}
            ${addressHtml}
            ${phoneHtml}
            ${emailHtml}
            ${responsibleHtml}
          `;
          div.addEventListener('click', () => {
            window.location.href = item.url;
          });
          dropdown.appendChild(div);
        });
        dropdown.classList.remove('hidden');
      }

      function fetchAutocomplete(query) {
        // Отменяем предыдущий запрос, если он есть
        if (abortController) {
          abortController.abort();
        }

        if (query.length < 2) {
          dropdown.classList.add('hidden');
          return;
        }

        // Создаем новый AbortController для этого запроса
        abortController = new AbortController();

        fetch(`/companies/autocomplete/?q=${encodeURIComponent(query)}`, {
          signal: abortController.signal
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.items && data.items.length > 0) {
              renderDropdown(data.items);
            } else {
              dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-brand-dark/70">Ничего не найдено</div>';
              dropdown.classList.remove('hidden');
            }
            abortController = null;
          })
          .catch(err => {
            if (err.name !== 'AbortError') {
              console.error('Autocomplete error:', err);
              dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-red-600">Ошибка загрузки</div>';
              dropdown.classList.remove('hidden');
            }
            abortController = null;
          });
      }

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          fetchAutocomplete(query);
        }, 300);
      });

      searchInput.addEventListener('focus', () => {
        const query = searchInput.value.trim();
        if (query.length >= 2) {
          fetchAutocomplete(query);
        }
      });

      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });

      // Обновляем относительное время при загрузке страницы
      updateRelativeTimes();
      // Обновляем каждую минуту
      setInterval(updateRelativeTimes, 60000);
    })();
  </script>
{% endblock %}


