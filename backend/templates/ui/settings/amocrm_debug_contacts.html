{% extends "ui/base.html" %}
{% block title %}amoCRM ‚Äî –æ—Ç–ª–∞–¥–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> / <a class="underline" href="/settings/amocrm/">amoCRM</a> / <a class="underline" href="/settings/amocrm/migrate/">–ú–∏–≥—Ä–∞—Ü–∏—è</a> /</div>
      <h1 class="text-2xl font-semibold">üîç –û—Ç–ª–∞–¥–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ AmoCRM</h1>
      <div class="text-sm text-brand-dark/70 mt-2">
        –≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ AmoCRM API, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∏–µ –ø–æ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞.
      </div>
    </div>

    <div class="card card-pad">
      <div class="mb-4">
        <a class="btn btn-outline" href="/settings/amocrm/migrate/">‚Üê –ù–∞–∑–∞–¥ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏</a>
        <a class="btn btn-primary ml-2" href="?limit={{ limit }}{% if responsible_user_id %}&responsible_user_id={{ responsible_user_id }}{% endif %}">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</a>
      </div>

      <div class="mb-4 p-3 bg-blue-50 rounded border border-blue-200">
        <div class="text-sm">
          <b>–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:</b> {{ stats.total_contacts }}
          {% if responsible_user_id %}
            <br><b>–§–∏–ª—å—Ç—Ä:</b> –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID = {{ responsible_user_id }}
          {% endif %}
        </div>
      </div>

      {% if stats.field_types %}
        <div class="mb-4 p-3 bg-gray-50 rounded border">
          <div class="font-medium mb-2">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø–æ–ª—è–º:</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div>
              <b>–¢–∏–ø—ã –ø–æ–ª–µ–π:</b>
              <ul class="list-disc list-inside mt-1">
                {% for field_type, count in stats.field_types.items %}
                  <li>{{ field_type }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            <div>
              <b>–ö–æ–¥—ã –ø–æ–ª–µ–π (—Ç–æ–ø-10):</b>
              <ul class="list-disc list-inside mt-1">
                {% for field_code, count in stats.field_codes.items|slice:":10" %}
                  <li>{{ field_code }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            <div>
              <b>–ù–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π (—Ç–æ–ø-10):</b>
              <ul class="list-disc list-inside mt-1">
                {% for field_name, count in stats.field_names.items|slice:":10" %}
                  <li>{{ field_name }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="space-y-6">
        {% for contact in contacts %}
          <div class="border rounded-lg p-4">
            <div class="font-medium text-lg mb-3">
              –ö–æ–Ω—Ç–∞–∫—Ç #{{ forloop.counter }} (ID: {{ contact.id }})
              {% if contact.name %}
                ‚Äî {{ contact.name }}
              {% endif %}
            </div>

            <div class="space-y-4">
              <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è -->
              {% if contact.standard_fields %}
                <div>
                  <div class="font-medium mb-2">üìù –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è:</div>
                  <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                    {% for key, value in contact.standard_fields.items %}
                      <div><b>{{ key }}:</b> {{ value|default:"‚Äî" }}</div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è -->
              {% if contact.custom_fields %}
                <div>
                  <div class="font-medium mb-2">üìã –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è ({{ contact.custom_fields|length }}):</div>
                  <div class="space-y-2">
                    {% for cf in contact.custom_fields %}
                      <div class="p-2 bg-gray-50 rounded border text-sm">
                        <div class="font-medium mb-1">
                          –ü–æ–ª–µ #{{ forloop.counter }}:
                          <span class="text-gray-600">ID={{ cf.field_id }}, code={{ cf.field_code|default:"‚Äî" }}, type={{ cf.field_type|default:"‚Äî" }}</span>
                        </div>
                        <div class="mb-1"><b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {{ cf.field_name|default:"‚Äî" }}</div>
                        <div>
                          <b>–ó–Ω–∞—á–µ–Ω–∏—è ({{ cf.values|length }}):</b>
                          <ul class="list-disc list-inside mt-1 ml-4">
                            {% for val in cf.values %}
                              <li>
                                {% if val.value %}
                                  value: {{ val.value|truncatewords:20 }}
                                {% endif %}
                                {% if val.enum_code %}
                                  <span class="text-gray-600">(enum_code: {{ val.enum_code }})</span>
                                {% endif %}
                                {% if val.enum_id %}
                                  <span class="text-gray-600">(enum_id: {{ val.enum_id }})</span>
                                {% endif %}
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% else %}
                <div class="text-sm text-gray-600">–ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>
              {% endif %}

              <!-- –í–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
              {% if contact.embedded %}
                <div>
                  <div class="font-medium mb-2">üîó –í–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (_embedded):</div>
                  <div class="space-y-2 text-sm">
                    {% for key, value in contact.embedded.items %}
                      <div>
                        <b>{{ key }}:</b>
                        {% if value|length %}
                          {{ value|length }} —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                          {% if value|length <= 5 %}
                            <ul class="list-disc list-inside mt-1 ml-4">
                              {% for item in value %}
                                <li>{{ item }}</li>
                              {% endfor %}
                            </ul>
                          {% endif %}
                        {% else %}
                          {{ value }}
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              <!-- –í—Å–µ –∫–ª—é—á–∏ -->
              <div>
                <div class="font-medium mb-2">üîë –í—Å–µ –∫–ª—é—á–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ ({{ contact.all_keys|length }}):</div>
                <div class="text-xs text-gray-600">{{ contact.all_keys|join:", " }}</div>
              </div>

              <!-- –ü–æ–ª–Ω–∞—è JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ -->
              <details class="mt-2">
                <summary class="font-medium cursor-pointer text-sm">üìÑ –ü–æ–ª–Ω–∞—è JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</summary>
                <pre class="mt-2 text-xs bg-gray-100 p-3 rounded overflow-auto max-h-96">{{ contact.full_json }}</pre>
              </details>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="mt-6 p-4 bg-yellow-50 rounded border border-yellow-200">
        <div class="text-sm">
          <b>üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ:</b>
          <ol class="list-decimal list-inside mt-2 space-y-1">
            <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª–Ω—É—é JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ç–∞–∫—Ç–∞ (—Ä–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ "–ü–æ–ª–Ω–∞—è JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞")</li>
            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</li>
            <li>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –≤—Ä—É—á–Ω—É—é</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
