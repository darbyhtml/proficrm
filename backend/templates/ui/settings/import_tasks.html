{% extends "ui/base.html" %}
{% block title %}Импорт задач — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">Настройки</a> / <a class="underline" href="/settings/import/">Импорт</a> /</div>
      <h1 class="text-2xl font-semibold">Импорт задач (amo .ics)</h1>
      <div class="text-sm text-brand-dark/70">
        Импортирует задачи из <b>iCal (.ics)</b>, который даёт amoCRM.
        Привязка к компании делается по строке <span class="font-mono text-xs">CONTACT: ... Компания: ...</span> (если она есть) и по best‑effort эвристике.
      </div>
      <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
        Важно: в формате .ics обычно <b>нет ID компании</b>, поэтому 100% точность привязки возможна только через API amoCRM.
        Этот импорт покажет, что привязалось, а что нет.
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="bg-white border rounded-2xl p-4 space-y-3">
      {% csrf_token %}

      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">ICS файл</label>
        {{ form.ics_file }}
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Лимит задач</label>
          <input class="input" type="number" name="limit_events" value="{{ form.limit_events.value|default:500 }}" min="1" max="20000" />
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="dry_run" value="on" {% if form.dry_run.value %}checked{% endif %} />
            Только проверить (dry-run)
          </label>
        </div>
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Если компания не найдена</label>
        {{ form.unmatched_mode }}
        <div class="text-xs muted-2 mt-1">
          Рекомендуем: сначала “Пропустить” на dry-run, посмотреть сколько не сопоставилось, затем выбрать нужный режим.
        </div>
      </div>

      {% if form.errors %}
        <div class="rounded-lg border border-brand-orange/60 bg-brand-orange/20 p-3 text-sm text-brand-dark">Проверь форму.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">Запустить</button>
        <a class="btn btn-outline" href="/settings/import/">Назад</a>
      </div>
    </form>

    {% if result %}
      <div class="card card-pad">
        <div class="font-medium mb-2">Результат</div>
        <div class="text-sm text-brand-dark/80">
          Прочитано событий: <b>{{ result.total_events }}</b>,
          добавлено задач: <b>{{ result.created_tasks }}</b>,
          пропущено (уже было): <b>{{ result.skipped_existing }}</b>,
          привязано к компании: <b>{{ result.linked_to_company }}</b>,
          без компании: <b>{{ result.without_company }}</b>,
          пропущено (нет компании): <b>{{ result.skipped_unmatched|default:0 }}</b>,
          создано компаний-заглушек: <b>{{ result.created_companies|default:0 }}</b>
        </div>

        {% if result.preview %}
          <div class="mt-3">
            <div class="text-sm text-brand-dark/70 mb-2">Превью</div>
            <div class="space-y-2 text-sm">
              {% for t in result.preview %}
                <div class="rounded-lg border p-3">
                  <div class="font-medium">{{ t.title }}</div>
                  <div class="text-xs muted-2 mt-1">Дедлайн: {{ t.due_at|default:"—" }}</div>
                  <div class="text-xs muted-2 mt-1">Компания (угадали): {{ t.company|default:"—" }}</div>
                  {% if not t.company %}
                    <div class="text-xs text-brand-dark/70 mt-1">Строка для сопоставления: <span class="font-mono text-xs">{{ t.company_guess }}</span></div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock %}


