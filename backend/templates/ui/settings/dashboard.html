{% extends "ui/base.html" %}
{% block title %}Настройки — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-8 bg-gradient-to-b from-brand-soft/30 via-white to-white px-4 pt-4 pb-6 rounded-3xl shadow-sm">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Настройки</h1>
        <div class="text-sm text-brand-dark/70">Доступно только администратору</div>
      </div>
      <button
        type="button"
        id="settings-layout-toggle"
        class="inline-flex items-center gap-2 rounded-full border border-brand-soft bg-white/80 px-3 py-1.5 text-xs font-medium text-brand-dark shadow-sm hover:bg-brand-soft/40 hover:shadow transition"
      >
        <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-brand-teal/10 text-[10px] text-brand-teal">
          ⋮⋮
        </span>
        <span>Настроить разделы</span>
      </button>
    </div>

    {# --- Настройки CRM: доступы, пользователи, филиалы, справочники и т.д. --- #}
    <section class="space-y-3" aria-labelledby="settings-crm-heading">
      <h2 id="settings-crm-heading" class="text-lg font-semibold text-brand-dark border-b border-brand-soft/60 pb-2">Настройки CRM</h2>
      <div
        id="settings-sections-grid"
        class="grid grid-cols-1 md:grid-cols-3 gap-4"
        data-user-id="{{ request.user.id }}"
        data-edit-mode="0"
      >
      <a
        href="/settings/access/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="access"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-teal/10 text-brand-teal">
            <!-- Heroicons lock-closed outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Доступы</div>
            <div class="text-sm text-brand-dark/70">страницы/действия по ролям + режим observe/enforce</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/users/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="users"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-orange/10 text-brand-orange">
            <!-- Heroicons users outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Пользователи</div>
            <div class="text-sm text-brand-dark/70">учётки, роли, доступ к базе</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/branches/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="branches"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-teal/10 text-brand-teal">
            <!-- Heroicons map-pin outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Филиалы</div>
            <div class="text-sm text-brand-dark/70">ЕКБ / КРД / ТМН и т.д.</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/dicts/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="dicts"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-orange/10 text-brand-orange">
            <!-- Heroicons document-text outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Справочники</div>
            <div class="text-sm text-brand-dark/70">статусы, сферы, типы задач</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/activity/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="activity"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-teal/10 text-brand-teal">
            <!-- Heroicons chart-bar-square outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Журнал действий</div>
            <div class="text-sm text-brand-dark/70">кто что сделал и когда</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/import/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="import"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-orange/10 text-brand-orange">
            <!-- Heroicons arrow-up-tray outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Импорт</div>
            <div class="text-sm text-brand-dark/70">amo CSV компаний + .ics задач</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/amocrm/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="amocrm"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-teal/10 text-brand-teal">
            <!-- Heroicons list-bullet outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">amoCRM (API)</div>
            <div class="text-sm text-brand-dark/70">точная миграция по фильтрам</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/company-columns/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="company-columns"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-orange/10 text-brand-orange">
            <!-- Heroicons view-columns outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5H7.5a3 3 0 0 0-3 3v9a3 3 0 0 0 3 3h9a3 3 0 0 0 3-3v-9a3 3 0 0 0-3-3H15m0-3.75H9M9 4.5v13.5m0-13.5h5.625c.621 0 1.125.504 1.125 1.125v13.5c0 .621-.504 1.125-1.125 1.125H9V4.5Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Колонки компаний</div>
            <div class="text-sm text-brand-dark/70">что показывать в таблице</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/security/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="security"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-teal/10 text-brand-teal">
            <!-- Heroicons shield-check outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Безопасность</div>
            <div class="text-sm text-brand-dark/70">экспорты, попытки, подозрительные действия</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/mobile/overview/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="mobile"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-orange/10 text-brand-orange">
            <!-- Смартфон: прямоугольник + точка (кнопка) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <rect x="6" y="3" width="12" height="18" rx="2" stroke-linecap="round" stroke-linejoin="round" />
              <circle cx="12" cy="18.5" r="1" fill="currentColor" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Мобильное приложение</div>
            <div class="text-sm text-brand-dark/70">обзор, устройства, статус опроса, версия приложения</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/calls/stats/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="calls-stats"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-teal/10 text-brand-teal">
            <!-- Heroicons chart-bar outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Статистика звонков</div>
            <div class="text-sm text-brand-dark/70">звонки менеджеров за день/месяц, статусы, длительность</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
      <a
        href="/settings/error-log/"
        class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        data-section-key="error-log"
      >
        <div class="flex items-start gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-orange/10 text-brand-orange">
            <!-- Heroicons exclamation-triangle outline -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
          </div>
          <div class="space-y-1">
            <div class="font-medium text-brand-dark">Лог ошибок</div>
            <div class="text-sm text-brand-dark/70">ошибки, исключения, предупреждения на сайте</div>
          </div>
        </div>
        <div class="settings-drag-hint pointer-events-none absolute inset-x-4 bottom-3 hidden items-center justify-between text-[11px] text-brand-dark/60">
          <span>Потяните, чтобы изменить порядок</span>
          <span class="rounded-full border border-brand-soft/60 bg-white/80 px-2 py-0.5 text-[10px]">⋮⋮</span>
        </div>
      </a>
    </div>
    </section>

    {# --- Live-chat: отдельный блок, не смешиваем с настройками CRM --- #}
    {% if MESSENGER_ENABLED %}
    <section class="space-y-3" aria-labelledby="settings-livechat-heading">
      <h2 id="settings-livechat-heading" class="text-lg font-semibold text-brand-dark border-b border-brand-soft/60 pb-2">Live-chat</h2>
      <p class="text-sm text-brand-dark/70">Источники (виджет на сайте), маршрутизация диалогов, диагностика и аналитика чата.</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a
          href="/settings/messenger/"
          class="group relative flex flex-col gap-3 bg-white/90 border border-brand-soft rounded-2xl p-4 shadow-sm backdrop-blur-sm hover:bg-white hover:-translate-y-0.5 hover:shadow-xl hover:border-brand-teal/40 hover:ring-1 hover:ring-brand-teal/30 transition-all"
        >
          <div class="flex items-start gap-3">
            <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-brand-teal/10 text-brand-teal">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
              </svg>
            </div>
            <div class="space-y-1">
              <div class="font-medium text-brand-dark">Источники и виджет</div>
              <div class="text-sm text-brand-dark/70">входящие, код вставки на сайт, правила маршрутизации</div>
            </div>
          </div>
        </a>
      </div>
    </section>
    {% endif %}

    <div
      id="settings-layout-panel"
      class="hidden items-center justify-between rounded-2xl border border-dashed border-brand-soft bg-white/70 px-4 py-3 text-xs text-brand-dark/80"
    >
      <div class="space-y-1">
        <div class="font-medium text-brand-dark text-sm">Режим настройки</div>
        <div class="text-[11px]">
          Потяните карточки, чтобы изменить порядок. Настройки сохраняются локально для вашего браузера.
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <label class="flex items-center gap-1.5">
          <span>Столбцов:</span>
          <select
            id="settings-columns-select"
            class="rounded-lg border border-brand-soft bg-white px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-brand-teal"
          >
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <style>
    #settings-sections-grid[data-edit-mode="1"] a[data-section-key] {
      cursor: grab;
      transition: box-shadow 150ms ease, transform 150ms ease, outline 120ms ease;
    }

    #settings-sections-grid[data-edit-mode="1"] a[data-section-key].settings-dragging {
      cursor: grabbing;
      opacity: 0.95;
      transform: translateY(-2px);
      box-shadow: 0 18px 45px rgba(0, 61, 56, 0.16);
    }

    #settings-sections-grid[data-edit-mode="1"] a[data-section-key].settings-drop-target {
      outline: 2px dashed #01948E;
      outline-offset: 3px;
    }
  </style>

  <script>
    (function () {
      const grid = document.getElementById("settings-sections-grid");
      const toggleBtn = document.getElementById("settings-layout-toggle");
      const panel = document.getElementById("settings-layout-panel");
      const columnsSelect = document.getElementById("settings-columns-select");

      if (!grid || !toggleBtn || !panel || !columnsSelect) {
        return;
      }

      const userId = grid.getAttribute("data-user-id") || "anonymous";
      const storageKey = "crm_settings_dashboard_layout_v1_" + userId;

      function readState() {
        try {
          const raw = localStorage.getItem(storageKey);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          return null;
        }
      }

      function writeState(state) {
        try {
          localStorage.setItem(storageKey, JSON.stringify(state));
        } catch (e) {
          // ignore quota errors
        }
      }

      function getCards() {
        return Array.from(grid.querySelectorAll("a[data-section-key]"));
      }

      function applyOrder(order) {
        if (!Array.isArray(order) || !order.length) return;
        const byKey = new Map();
        getCards().forEach((card) => {
          byKey.set(card.getAttribute("data-section-key"), card);
        });
        order.forEach((key) => {
          const card = byKey.get(key);
          if (card) {
            grid.appendChild(card);
          }
        });
      }

      function applyColumns(columns) {
        const cols = Number(columns) || 3;
        columnsSelect.value = String(cols);
        grid.style.gridTemplateColumns = "repeat(" + cols + ", minmax(0, 1fr))";
      }

      function saveCurrentState() {
        const order = getCards().map((card) => card.getAttribute("data-section-key"));
        const columns = Number(columnsSelect.value) || 3;
        writeState({ order, columns });
      }

      function setEditMode(on) {
        grid.setAttribute("data-edit-mode", on ? "1" : "0");
        panel.classList.toggle("hidden", !on);
        panel.classList.toggle("flex", on);
        toggleBtn.classList.toggle("bg-brand-soft/40", on);
        toggleBtn.classList.toggle("border-brand-teal", on);
        toggleBtn.querySelector("span:nth-child(2)").textContent = on ? "Готово" : "Настроить разделы";

        getCards().forEach((card) => {
          card.setAttribute("draggable", on ? "true" : "false");
          if (!on) {
            card.classList.remove("cursor-grab", "settings-dragging", "settings-drop-target");
          } else {
            card.classList.add("cursor-grab");
          }
        });
      }

      // Drag & drop
      let draggedKey = null;
      let draggedCardEl = null;
      let dropTarget = null;

      grid.addEventListener("dragstart", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const card = target.closest("a[data-section-key]");
        if (grid.getAttribute("data-edit-mode") !== "1") {
          event.preventDefault();
          return;
        }
        if (!card) return;
        draggedKey = card.getAttribute("data-section-key");
        draggedCardEl = card;
        card.classList.add("settings-dragging");
        card.classList.remove("cursor-grab");
        if (!event.dataTransfer) return;
        event.dataTransfer.effectAllowed = "move";
        event.dataTransfer.setData("text/plain", draggedKey || "");
      });

      grid.addEventListener("dragover", (event) => {
        if (grid.getAttribute("data-edit-mode") !== "1") return;
        event.preventDefault();
        if (event.dataTransfer) {
          event.dataTransfer.dropEffect = "move";
        }
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const card = target.closest("a[data-section-key]");
        if (!card || card.getAttribute("data-section-key") === draggedKey) return;
        if (dropTarget && dropTarget !== card) {
          dropTarget.classList.remove("settings-drop-target");
        }
        dropTarget = card;
        dropTarget.classList.add("settings-drop-target");
      });

      grid.addEventListener("drop", (event) => {
        if (grid.getAttribute("data-edit-mode") !== "1") return;
        event.preventDefault();
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const card = target.closest("a[data-section-key]");
        if (!card || !draggedKey) return;
        const draggedCard = grid.querySelector('a[data-section-key="' + draggedKey + '"]');
        if (!draggedCard || draggedCard === card) return;
        const cards = getCards();
        const targetIndex = cards.indexOf(card);
        if (targetIndex === -1) return;
        const referenceNode = cards[targetIndex];
        grid.insertBefore(draggedCard, referenceNode);
        if (dropTarget) {
          dropTarget.classList.remove("settings-drop-target");
          dropTarget = null;
        }
        saveCurrentState();
      });

      grid.addEventListener("dragend", () => {
        if (draggedCardEl) {
          draggedCardEl.classList.remove("settings-dragging");
          draggedCardEl.classList.add("cursor-grab");
        }
        if (dropTarget) {
          dropTarget.classList.remove("settings-drop-target");
          dropTarget = null;
        }
        draggedCardEl = null;
        draggedKey = null;
      });

      // Не переходим по ссылкам в режиме редактирования
      grid.addEventListener("click", (event) => {
        if (grid.getAttribute("data-edit-mode") === "1") {
          event.preventDefault();
        }
      });

      toggleBtn.addEventListener("click", () => {
        const isEdit = grid.getAttribute("data-edit-mode") === "1";
        if (isEdit) {
          saveCurrentState();
        }
        setEditMode(!isEdit);
      });

      columnsSelect.addEventListener("change", () => {
        applyColumns(columnsSelect.value);
        saveCurrentState();
      });

      // Инициализация из localStorage
      const initial = readState();
      if (initial) {
        applyOrder(initial.order);
        applyColumns(initial.columns);
      } else {
        applyColumns(3);
      }

      setEditMode(false);
    })();
  </script>
{% endblock %}


