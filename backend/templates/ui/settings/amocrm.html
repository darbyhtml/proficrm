{% extends "ui/base.html" %}
{% block title %}amoCRM ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> /</div>
      <h1 class="text-2xl font-semibold">amoCRM (API)</h1>
      <div class="text-sm text-brand-dark/70">
        –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ OAuth –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–∫–æ–º–ø–∞–Ω–∏–∏/–∑–∞–¥–∞—á–∏/–∑–∞–º–µ—Ç–∫–∏) –∏ —Ç–æ—á–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏.
      </div>
    </div>

    {% if cfg.last_error %}
      <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
        <b>–û—à–∏–±–∫–∞:</b> {{ cfg.last_error }}
      </div>
    {% endif %}

    <div class="card card-pad space-y-3">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="text-sm text-brand-dark/80">
          –°—Ç–∞—Ç—É—Å: {% if cfg.is_connected %}<span class="badge badge-done">–ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>{% else %}<span class="badge badge-warn">–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>{% endif %}
        </div>
        <div class="flex gap-2">
          {% if cfg.is_connected %}
            <a class="btn btn-outline" href="/settings/amocrm/migrate/">–ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ —Ñ–∏–ª—å—Ç—Ä—É</a>
            <a class="btn btn-outline" href="/settings/amocrm/disconnect/" onclick="return confirm('–û—Ç–∫–ª—é—á–∏—Ç—å amoCRM –∏ —É–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω—ã?');">–û—Ç–∫–ª—é—á–∏—Ç—å</a>
          {% endif %}
        </div>
      </div>

      <form method="post" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        {% csrf_token %}
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–î–æ–º–µ–Ω</label>
          <input class="input" type="text" name="domain" value="{{ form.domain.value|default:'kmrprofi.amocrm.ru' }}" placeholder="kmrprofi.amocrm.ru" />
          <div class="text-xs muted-2 mt-1">–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Å https:// ‚Äî –º—ã —É–±–µ—Ä—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Redirect URI</label>
          <input class="input" type="text" name="redirect_uri" value="{{ form.redirect_uri.value|default:'' }}" placeholder="https://–≤–∞—à-–¥–æ–º–µ–Ω/settings/amocrm/callback/" />
          <div class="text-xs muted-2 mt-1">–£–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ amo.</div>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Client ID</label>
          <input class="input" type="text" name="client_id" value="{{ form.client_id.value|default:'' }}" />
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Client Secret</label>
          <input class="input" type="password" name="client_secret" value="{{ form.client_secret.value|default:'' }}" />
          <div class="text-xs muted-2 mt-1">–•—Ä–∞–Ω–∏–º –≤ –ë–î. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Ç–∏—Ä–∞—Ç—å.</div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-brand-dark/80 mb-1">–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏)</label>
          <textarea class="w-full rounded-lg border px-3 py-2" rows="3" name="long_lived_token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ long-lived token –∏–∑ amoCRM">{{ form.long_lived_token.value|default:'' }}</textarea>
          <div class="text-xs muted-2 mt-1">–ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî OAuth –Ω–µ –Ω—É–∂–µ–Ω. –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤ amoCRM: ¬´–ö–ª—é—á–∏ –∏ –¥–æ—Å—Ç—É–ø—ã¬ª ‚Üí ¬´–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω¬ª.</div>
        </div>

        <div class="md:col-span-2 flex gap-2">
          <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          {% if auth_url and not cfg.long_lived_token %}
            <a class="btn btn-outline" href="{{ auth_url }}">–ü–æ–¥–∫–ª—é—á–∏—Ç—å (OAuth)</a>
          {% endif %}
        </div>
      </form>

      <div class="text-xs muted-2">
        –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—É—Ç—å –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏: long-lived token (–±–µ–∑ OAuth).<br>
        –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: OAuth (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ).
      </div>
    </div>

    <div class="card card-pad space-y-4">
      <h2 class="text-lg font-semibold">üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ OAuth</h2>
      
      <div class="space-y-3 text-sm">
        <div class="border-l-4 border-brand-blue pl-4">
          <h3 class="font-semibold mb-1">–®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ AmoCRM</h3>
          <ol class="list-decimal list-inside space-y-1 text-brand-dark/80">
            <li>–í–æ–π–¥–∏—Ç–µ –≤ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç AmoCRM: <strong>{{ cfg.domain|default:"kmrprofi.amocrm.ru" }}</strong></li>
            <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ <strong>—Ç—Ä–∏ —Ç–æ—á–∫–∏ (‚ãØ)</strong> –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>"amoMarket"</strong> –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <strong>"–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"</strong></li>
            <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é"</strong> –∏–ª–∏ <strong>"–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é"</strong></li>
            <li>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:
              <ul class="list-disc list-inside ml-4 mt-1">
                <li><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> –ª—é–±–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "CRM –ò–º–ø–æ—Ä—Ç")</li>
                <li><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</li>
              </ul>
            </li>
            <li>–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ AmoCRM –ø–æ–∫–∞–∂–µ—Ç –≤–∞–º <strong>Client ID</strong> –∏ <strong>Secret key</strong></li>
          </ol>
        </div>

        <div class="border-l-4 border-brand-blue pl-4">
          <h3 class="font-semibold mb-1">–®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redirect URI</h3>
          <ol class="list-decimal list-inside space-y-1 text-brand-dark/80">
            <li>–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ <strong>"Redirect URI"</strong> –∏–ª–∏ <strong>"URI –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è"</strong></li>
            <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL –∏–∑ –ø–æ–ª—è –≤—ã—à–µ (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π):</li>
            <li class="ml-4">
              <code class="bg-brand-dark/5 px-2 py-1 rounded text-xs break-all">
                {{ redirect_uri_display }}
              </code>
            </li>
            <li>–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ AmoCRM</li>
            <li><strong>–í–∞–∂–Ω–æ:</strong> URL –¥–æ–ª–∂–µ–Ω —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—Ç–æ–∫–æ–ª https:// –∏ –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Å–ª—ç—à)</li>
          </ol>
        </div>

        <div class="border-l-4 border-brand-blue pl-4">
          <h3 class="font-semibold mb-1">–®–∞–≥ 3: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–µ –≤—ã—à–µ</h3>
          <ol class="list-decimal list-inside space-y-1 text-brand-dark/80">
            <li><strong>–î–æ–º–µ–Ω:</strong> –≤–∞—à –¥–æ–º–µ–Ω AmoCRM (–Ω–∞–ø—Ä–∏–º–µ—Ä, <code>kmrprofi.amocrm.ru</code>)</li>
            <li><strong>Client ID:</strong> —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ AmoCRM</li>
            <li><strong>Client Secret:</strong> —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ <strong>Secret key</strong> –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</li>
            <li><strong>Redirect URI:</strong> –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ —É–∫–∞–∑–∞–Ω –≤ AmoCRM (–æ–±—ã—á–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</li>
            <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"</strong></li>
          </ol>
        </div>

        <div class="border-l-4 border-brand-green pl-4">
          <h3 class="font-semibold mb-1">–®–∞–≥ 4: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ OAuth</h3>
          <ol class="list-decimal list-inside space-y-1 text-brand-dark/80">
            <li>–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ <strong>"–ü–æ–¥–∫–ª—é—á–∏—Ç—å (OAuth)"</strong></li>
            <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ—ë ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ AmoCRM</li>
            <li>–í–æ–π–¥–∏—Ç–µ –≤ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç AmoCRM (–µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã)</li>
            <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∫ –¥–∞–Ω–Ω—ã–º –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</li>
            <li>–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</li>
            <li>–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ <span class="badge badge-done">–ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span></li>
          </ol>
        </div>

        <div class="border-l-4 border-brand-orange pl-4">
          <h3 class="font-semibold mb-1">‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è</h3>
          <ul class="list-disc list-inside space-y-1 text-brand-dark/80">
            <li><strong>OAuth —Ç–æ–∫–µ–Ω</strong> –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (–≤–∫–ª—é—á–∞—è —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)</li>
            <li><strong>Access token</strong> –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 24 —á–∞—Å–∞, –∑–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ <strong>Refresh token</strong></li>
            <li><strong>Refresh token</strong> –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 3 –º–µ—Å—è—Ü–∞, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</li>
            <li>–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ <strong>long-lived token</strong>, OAuth –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∞–≤)</li>
            <li>–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ <a href="/settings/amocrm/migrate/" class="underline">–º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö</a></li>
          </ul>
        </div>

        <div class="bg-brand-blue/10 border border-brand-blue/30 rounded-lg p-3">
          <p class="text-sm text-brand-dark/90">
            <strong>üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:</strong> 
            <a href="https://www.amocrm.ru/developers/content/oauth/oauth" target="_blank" class="underline">OAuth 2.0 –≤ AmoCRM</a> | 
            <a href="https://www.amocrm.ru/developers/content/oauth/oauth-step-by-step" target="_blank" class="underline">–ü—Ä–∏–º–µ—Ä –ø–æ —à–∞–≥–∞–º</a>
          </p>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


