{% extends "ui/base.html" %}
{% block title %}amoCRM — настройки{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">Настройки</a> /</div>
      <h1 class="text-2xl font-semibold">amoCRM (API)</h1>
      <div class="text-sm text-brand-dark/70">
        Подключение по OAuth для одноразовой миграции данных (компании/задачи/заметки) и точной привязки.
      </div>
    </div>

    {% if cfg.last_error %}
      <div class="rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-3 text-sm text-brand-dark">
        <b>Ошибка:</b> {{ cfg.last_error }}
      </div>
    {% endif %}

    <div class="card card-pad space-y-3">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="text-sm text-brand-dark/80">
          Статус: {% if cfg.is_connected %}<span class="badge badge-done">подключено</span>{% else %}<span class="badge badge-warn">не подключено</span>{% endif %}
        </div>
        <div class="flex gap-2">
          {% if cfg.is_connected %}
            <a class="btn btn-outline" href="/settings/amocrm/migrate/">Миграция по фильтру</a>
            <a class="btn btn-outline" href="/settings/amocrm/disconnect/" onclick="return confirm('Отключить amoCRM и удалить токены?');">Отключить</a>
          {% endif %}
        </div>
      </div>

      <form method="post" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        {% csrf_token %}
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Домен</label>
          <input class="input" type="text" name="domain" value="{{ form.domain.value|default:'kmrprofi.amocrm.ru' }}" placeholder="kmrprofi.amocrm.ru" />
          <div class="text-xs muted-2 mt-1">Можно вставить с https:// — мы уберём автоматически.</div>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Redirect URI</label>
          <input class="input" type="text" name="redirect_uri" value="{{ form.redirect_uri.value|default:'' }}" placeholder="https://ваш-домен/settings/amocrm/callback/" />
          <div class="text-xs muted-2 mt-1">Укажите этот URL в настройках интеграции amo.</div>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Client ID</label>
          <input class="input" type="text" name="client_id" value="{{ form.client_id.value|default:'' }}" />
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Client Secret</label>
          <input class="input" type="password" name="client_secret" value="{{ form.client_secret.value|default:'' }}" />
          <div class="text-xs muted-2 mt-1">Храним в БД. Можно оставить пустым, чтобы не перетирать.</div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-brand-dark/80 mb-1">Долгосрочный токен (рекомендуем для миграции)</label>
          <textarea class="w-full rounded-lg border px-3 py-2" rows="3" name="long_lived_token" placeholder="Вставьте long-lived token из amoCRM">{{ form.long_lived_token.value|default:'' }}</textarea>
          <div class="text-xs muted-2 mt-1">Если заполнено — OAuth не нужен. Можно получить в amoCRM: «Ключи и доступы» → «Долгосрочный токен».</div>
        </div>

        <div class="md:col-span-2 flex gap-2">
          <button class="btn btn-primary" type="submit">Сохранить</button>
          {% if auth_url and not cfg.long_lived_token %}
            <a class="btn btn-outline" href="{{ auth_url }}">Подключить (OAuth)</a>
          {% endif %}
        </div>
      </form>

      <div class="text-xs muted-2">
        Рекомендуемый путь для миграции: long-lived token (без OAuth).<br>
        Альтернатива: OAuth (если доступен в вашем аккаунте).
      </div>
    </div>
  </div>
{% endblock %}


