{% extends "ui/base.html" %}
{% block title %}amoCRM ‚Äî dry-run –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> / <a class="underline" href="/settings/amocrm/">amoCRM</a> / <a class="underline" href="/settings/amocrm/migrate/">–ú–∏–≥—Ä–∞—Ü–∏—è</a> /</div>
      <h1 class="text-2xl font-semibold">üìá Dry-run: –ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π</h1>
      <div class="text-sm text-brand-dark/70 mt-2">
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–∞—á–∫–∏. –≠—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã (–Ω–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–º–ø–∞–Ω–∏–∏).
      </div>
    </div>

    <div class="card card-pad">
      <div class="mb-4 flex gap-2">
        <a class="btn btn-outline" href="/settings/amocrm/migrate/">‚Üê –ù–∞–∑–∞–¥ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏</a>
        <a class="btn btn-primary" href="?responsible_user_id={{ responsible_user_id }}&limit_companies={{ limit_companies }}&offset={{ offset }}">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</a>
      </div>

      <div class="mb-4 p-4 bg-blue-50 rounded border border-blue-200">
        <div class="text-sm space-y-1">
          <div><b>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</b> ID {{ responsible_user_id }}</div>
          <div><b>–†–∞–∑–º–µ—Ä –ø–∞—á–∫–∏:</b> {{ limit_companies }} –∫–æ–º–ø–∞–Ω–∏–π</div>
          <div><b>–°–º–µ—â–µ–Ω–∏–µ:</b> {{ offset }}</div>
          <div class="mt-2"><b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b></div>
          <div class="pl-4 space-y-1">
            <div>–ö–æ–º–ø–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ: <b>{{ result.companies_seen|default:0 }}</b></div>
            <div>–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: <b>{{ result.contacts_seen|default:0 }}</b></div>
            {% if result.contacts_preview %}
              <div>–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ preview: <b>{{ result.contacts_preview|length }}</b></div>
            {% endif %}
          </div>
        </div>
      </div>

      {% if result.contacts_seen == 0 %}
        <div class="p-4 bg-yellow-50 rounded border border-yellow-200">
          <div class="text-sm text-yellow-800">
            ‚ö†Ô∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
            <ul class="list-disc list-inside mt-2 space-y-1">
              <li>–£ –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–∞—á–∫–∏ –Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ AmoCRM</li>
              <li>–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä with=contacts –≤ –∑–∞–ø—Ä–æ—Å–µ)</li>
              <li>–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</li>
            </ul>
          </div>
        </div>
      {% elif not result.contacts_preview or result.contacts_preview|length == 0 %}
        <div class="p-4 bg-yellow-50 rounded border border-yellow-200">
          <div class="text-sm text-yellow-800">
            ‚ö†Ô∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–∞–π–¥–µ–Ω—ã ({{ result.contacts_seen }}), –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ preview.
            <div class="mt-2">–í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∏ –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å –∫–æ–º–ø–∞–Ω–∏—è–º–∏ –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–∞—á–∫–∏ –∏–ª–∏ –±—ã–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã.</div>
          </div>
        </div>
      {% else %}
        <div class="space-y-4">
          <div class="text-sm text-gray-600">
            –ü–æ–∫–∞–∑–∞–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: <b>{{ result.contacts_preview|length }}</b> –∏–∑ {{ result.contacts_seen }}
            {% if result.contacts_preview|length < result.contacts_seen %}
              <span class="text-orange-600">(–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ {{ result.contacts_preview|length }})</span>
            {% endif %}
          </div>

          {% for c in result.contacts_preview %}
            <div class="border rounded-lg p-4 {% if c.status == 'NO_CONTACTS_FOUND' or c.status == 'SKIPPED_NO_COMPANY_LINK' or c.status == 'SKIPPED_NO_LOCAL_COMPANY' %}bg-red-50{% elif c.status == 'INFO' %}bg-yellow-50{% elif c.status == 'UPDATED' or c.status == 'CREATED' %}bg-green-50{% else %}bg-gray-50{% endif %}">
              {% if c.status == 'INFO' %}
                <div class="font-medium mb-2 text-yellow-700">‚ÑπÔ∏è {{ c.message }}</div>
              {% elif c.status == 'NO_CONTACTS_FOUND' %}
                <div class="font-medium mb-2 text-red-600">‚ö†Ô∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                <div class="space-y-1 text-sm">
                  <div><b>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π:</b> {{ c.companies_checked }}</div>
                  <div><b>ID –∫–æ–º–ø–∞–Ω–∏–π:</b> {{ c.company_ids|join:", " }}</div>
                  <div class="text-xs muted-2 mt-1">{{ c.message }}</div>
                </div>
              {% elif c.status == 'SKIPPED_NO_LOCAL_COMPANY' %}
                <div class="font-medium mb-2 text-orange-600">‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω: –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>
                <div class="space-y-2 text-sm">
                  <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                  <div><b>amo company_id:</b> {{ c.amo_company_id_for_contact|default:"‚Äî" }}</div>
                  
                  {% if c.all_custom_fields %}
                    <div class="border-t pt-2 mt-2">
                      <div class="font-medium text-xs mb-1">üìã –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è ({{ c.custom_fields_count|default:0 }}):</div>
                      <div class="space-y-1 mt-1">
                        {% for cf in c.all_custom_fields %}
                          <div class="text-xs p-2 rounded border bg-gray-50">
                            <div><b>ID:</b> {{ cf.field_id }}, <b>code:</b> {{ cf.field_code|default:"‚Äî" }}, <b>name:</b> {{ cf.field_name|default:"‚Äî" }}, <b>type:</b> {{ cf.field_type|default:"‚Äî" }}</div>
                            {% if cf.values %}
                              <div class="mt-1 pl-2">
                                {% for val in cf.values %}
                                  <div>‚Ä¢ {{ val.value|default:"‚Äî" }}{% if val.enum_code %} ({{ val.enum_code }}){% endif %}</div>
                                {% endfor %}
                              </div>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% elif c.status == 'UPDATED' or c.status == 'CREATED' %}
                <div class="font-medium mb-3 text-lg">
                  {% if c.status == 'CREATED' %}‚úÖ –°–æ–∑–¥–∞–Ω: –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç{% else %}‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω: –∫–æ–Ω—Ç–∞–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏{% endif %}
                </div>
                <div class="space-y-3">
                  <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }}</div>
                    <div><b>amo id:</b> {{ c.amo_contact_id }}</div>
                    {% if c.company_name %}
                      <div class="col-span-2"><b>–ö–æ–º–ø–∞–Ω–∏—è:</b> {{ c.company_name }}{% if c.company_id %} (ID: {{ c.company_id }}){% endif %}</div>
                    {% endif %}
                  </div>
                  
                  <div class="border-t pt-2">
                    <div class="font-medium text-xs mb-1">üìû –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—á—Ç–æ –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ):</div>
                    <div class="space-y-1 text-xs">
                      <div><b>–¢–µ–ª–µ—Ñ–æ–Ω—ã:</b> 
                        {% if c.extracted_phones %}
                          {% for p in c.extracted_phones %}
                            <span class="inline-block bg-blue-100 px-2 py-0.5 rounded mr-1">{{ p.value }} ({{ p.type }}){% if p.comment %} ‚Äî {{ p.comment }}{% endif %}</span>
                          {% endfor %}
                        {% else %}‚Äî{% endif %}
                      </div>
                      <div><b>Email:</b> 
                        {% if c.extracted_emails %}
                          {% for e in c.extracted_emails %}
                            <span class="inline-block bg-green-100 px-2 py-0.5 rounded mr-1">{{ e.value }} ({{ e.type }})</span>
                          {% endfor %}
                        {% else %}‚Äî{% endif %}
                      </div>
                      <div><b>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</b> {{ c.extracted_position|default:"‚Äî" }}</div>
                      <div><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> {{ c.extracted_note_text|default:"‚Äî"|truncatewords:30 }}</div>
                      {% if c.extracted_cold_call %}
                        <div><b>–•–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫:</b> {{ c.extracted_cold_call }}</div>
                      {% endif %}
                      {% if c.extracted_birthday %}
                        <div><b>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è:</b> {{ c.extracted_birthday }}</div>
                      {% endif %}
                    </div>
                  </div>
                  
                  {% if c.all_custom_fields %}
                    <div class="border-t pt-2">
                      <div class="font-medium text-xs mb-1">üìã –í–°–ï –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è ({{ c.custom_fields_count|default:0 }}):</div>
                      <div class="space-y-2 mt-1 max-h-96 overflow-y-auto">
                        {% for cf in c.all_custom_fields %}
                          <div class="text-xs p-2 rounded border {% if cf.is_used %}bg-green-50 border-green-300{% else %}bg-gray-50{% endif %}">
                            <div class="font-medium flex items-center gap-2">
                              {% if cf.is_used %}<span class="text-green-600">‚úì</span>{% endif %}
                              <span><b>ID:</b> {{ cf.field_id|default:"‚Äî" }}</span>
                              <span><b>code:</b> {{ cf.field_code|default:"‚Äî" }}</span>
                              <span><b>type:</b> {{ cf.field_type|default:"‚Äî" }}</span>
                            </div>
                            <div class="mt-1"><b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {{ cf.field_name|default:"‚Äî" }}</div>
                            <div class="mt-1"><b>–ó–Ω–∞—á–µ–Ω–∏–π:</b> {{ cf.values_count|default:0 }}</div>
                            {% if cf.values %}
                              <div class="mt-1 pl-2 border-l-2 space-y-1">
                                {% for val in cf.values %}
                                  <div class="text-xs">
                                    ‚Ä¢ <b>value:</b> {{ val.value|default:"‚Äî"|truncatewords:15 }}
                                    {% if val.enum_code %}<span class="text-gray-600">(enum_code: {{ val.enum_code }})</span>{% endif %}
                                    {% if val.enum_id %}<span class="text-gray-600">(enum_id: {{ val.enum_id }})</span>{% endif %}
                                  </div>
                                {% endfor %}
                              </div>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                  
                  {% if c.embedded_tags or c.embedded_companies or c.embedded_leads or c.embedded_customers or c.embedded_notes %}
                    <div class="border-t pt-2">
                      <div class="font-medium text-xs mb-1">üîó –í–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (_embedded):</div>
                      <div class="space-y-1 text-xs">
                        {% if c.embedded_tags %}
                          <div><b>–¢–µ–≥–∏:</b> {% for tag in c.embedded_tags %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                        {% endif %}
                        {% if c.embedded_companies %}
                          <div><b>–ö–æ–º–ø–∞–Ω–∏–∏:</b> {% for comp in c.embedded_companies %}ID: {{ comp.id }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                        {% endif %}
                        {% if c.embedded_leads %}
                          <div><b>–°–¥–µ–ª–∫–∏:</b> {% for lead in c.embedded_leads %}ID: {{ lead.id }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                        {% endif %}
                        {% if c.embedded_customers %}
                          <div><b>–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏:</b> {% for cust in c.embedded_customers %}ID: {{ cust.id }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                        {% endif %}
                        {% if c.embedded_notes %}
                          <div><b>–ó–∞–º–µ—Ç–∫–∏:</b> {{ c.embedded_notes_count|default:0 }} —à—Ç.
                            {% for note in c.embedded_notes|slice:":3" %}
                              <div class="pl-2 text-xs text-gray-600">‚Ä¢ type: {{ note.note_type|default:"‚Äî" }}, text: {{ note.text|default:"‚Äî"|truncatewords:10 }}</div>
                            {% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                  
                  {% if c.standard_fields %}
                    <div class="border-t pt-2">
                      <div class="font-medium text-xs mb-1">üìù –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è:</div>
                      <div class="text-xs space-y-0.5">
                        {% for key, value in c.standard_fields.items %}
                          <div><b>{{ key }}:</b> {{ value|default:"‚Äî" }}</div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                  
                  {% if c.full_structure %}
                    <details class="border-t pt-2">
                      <summary class="font-medium text-xs cursor-pointer">üîç –ü–æ–ª–Ω–∞—è JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞</summary>
                      <pre class="text-xs mt-2 p-2 bg-gray-100 rounded overflow-auto max-h-64">{{ c.full_structure }}</pre>
                    </details>
                  {% endif %}
                </div>
              {% else %}
                <div class="font-medium mb-2">{{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                <div class="space-y-1 text-sm">
                  <div><b>–°—Ç–∞—Ç—É—Å:</b> {{ c.status|default:"‚Äî" }}</div>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
