{% extends "ui/base.html" %}
{% block title %}Пользователи — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">Настройки</a> /</div>
        <h1 class="text-2xl font-semibold">Пользователи</h1>
      </div>
      <a href="/settings/users/new/" class="btn btn-primary">+ Добавить пользователя</a>
    </div>

    <form method="post" class="bg-white border rounded-2xl p-4">
      {% csrf_token %}
      <div class="flex items-center gap-2">
        <input type="checkbox" name="view_as_enabled" id="view_as_enabled" {% if view_as_enabled %}checked{% endif %} onchange="this.form.submit()" />
        <label for="view_as_enabled" class="text-sm text-brand-dark/80">
          Режим просмотра администратора
        </label>
        <input type="hidden" name="toggle_view_as" value="1" />
      </div>
      <div class="text-xs text-brand-dark/60 mt-1">
        Позволяет администратору просматривать систему с точки зрения другой роли или филиала
      </div>
    </form>

    <div class="bg-white border rounded-2xl overflow-hidden">
      <table class="min-w-full text-sm">
        <thead class="bg-brand-soft/40 text-brand-dark/80">
          <tr>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=username&dir={% if sort_field == 'username' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'username' %}text-brand-orange font-bold{% endif %}">
                Логин
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'username' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'username' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=full_name&dir={% if sort_field == 'full_name' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'full_name' %}text-brand-orange font-bold{% endif %}">
                ФИО
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'full_name' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'full_name' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=role&dir={% if sort_field == 'role' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'role' %}text-brand-orange font-bold{% endif %}">
                Роль
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'role' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'role' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=branch&dir={% if sort_field == 'branch' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'branch' %}text-brand-orange font-bold{% endif %}">
                Филиал
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=is_active&dir={% if sort_field == 'is_active' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'is_active' %}text-brand-orange font-bold{% endif %}">
                Активен
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'is_active' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'is_active' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr class="border-t">
              <td class="px-4 py-3 font-mono">{{ u.username }}</td>
              <td class="px-4 py-3">{{ u.get_full_name|default:"—" }}</td>
              <td class="px-4 py-3">{{ u.get_role_display }}</td>
              <td class="px-4 py-3">{{ u.branch|default:"—" }}</td>
              <td class="px-4 py-3">{% if u.is_active %}Да{% else %}Нет{% endif %}</td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    class="flex items-center justify-center w-8 h-8 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors{% if not u.is_active %} opacity-40 cursor-not-allowed{% endif %}"
                    title="Сгенерировать ключ доступа"
                    aria-label="Сгенерировать ключ доступа"
                    data-magic-link-generate
                    data-user-id="{{ u.id }}"
                    data-user-name="{{ u.get_full_name|default:u.username }}"
                    {% if not u.is_active %}disabled aria-disabled="true"{% endif %}
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="7.5" cy="12" r="3.25"/>
                      <path d="M10.75 12H20"/>
                      <path d="M15.5 9.25V14.75"/>
                    </svg>
                  </button>
                  <a href="/settings/users/{{ u.id }}/edit/" class="flex items-center justify-center w-8 h-8 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors" title="Редактировать" aria-label="Редактировать">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9"/>
                      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                    </svg>
                  </a>
                  <form method="post" action="/settings/users/{{ u.id }}/logout/" onsubmit="return confirm('Вы уверены, что хотите разлогинить этого пользователя? Все его активные сессии будут завершены.');" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" class="flex items-center justify-center w-8 h-8 rounded bg-white border border-red-300 hover:bg-red-50 transition-colors" title="Разлогинить пользователя" aria-label="Разлогинить пользователя" style="border-color:rgba(220,38,38,.5);color:#b91c1c;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr><td class="px-4 py-6 text-brand-dark/70" colspan="6">Пользователей нет.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <div
    id="magic-link-modal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/30 px-4"
  >
    <div class="w-full max-w-lg rounded-2xl bg-white shadow-2xl border border-brand-soft/60">
      <div class="flex items-start justify-between gap-3 border-b border-brand-soft/60 px-5 py-4">
        <div>
          <div class="text-xs uppercase tracking-wide text-brand-dark/60">Ключ доступа</div>
          <div class="text-base font-semibold text-brand-dark">
            Для пользователя <span id="magic-link-user-name"></span>
          </div>
        </div>
        <button
          type="button"
          id="magic-link-modal-close"
          class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-soft/70 text-brand-dark/70 hover:bg-brand-soft/30 hover:text-brand-dark transition"
          aria-label="Закрыть"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
      <div class="space-y-4 px-5 py-4">
        <div class="space-y-1">
          <div class="text-xs font-medium text-brand-dark/70 uppercase">Ключ (для ввода на странице входа)</div>
          <div class="flex items-center gap-2 rounded-xl border border-brand-soft bg-brand-soft/10 px-3 py-2">
            <code id="magic-link-token" class="font-mono text-sm text-brand-dark break-all"></code>
            <button
              type="button"
              id="magic-link-copy-token"
              class="ml-auto inline-flex items-center gap-1 rounded-lg border border-brand-soft bg-white px-2 py-1 text-xs font-medium text-brand-dark hover:bg-brand-soft/40 transition"
            >
              Скопировать ключ
            </button>
          </div>
        </div>
        <div class="space-y-1">
          <div class="text-xs font-medium text-brand-dark/70 uppercase">Прямая ссылка</div>
          <div class="flex items-center gap-2 rounded-xl border border-brand-soft bg-brand-soft/5 px-3 py-2">
            <div id="magic-link-url" class="text-xs text-brand-dark/80 break-all"></div>
            <button
              type="button"
              id="magic-link-copy-url"
              class="ml-auto inline-flex items-center gap-1 rounded-lg border border-brand-soft bg-white px-2 py-1 text-xs font-medium text-brand-dark hover:bg-brand-soft/40 transition"
            >
              Скопировать ссылку
            </button>
          </div>
        </div>
        <div class="text-xs text-brand-dark/70">
          Ключ действует в течение 24 часов и одноразовый. Передайте его пользователю удобным способом (чат, почта и т.п.).
        </div>
        <div id="magic-link-error" class="hidden text-xs text-red-600"></div>
      </div>
      <div class="flex items-center justify-end gap-2 border-t border-brand-soft/60 bg-brand-soft/10 px-5 py-3 text-xs text-brand-dark/70">
        <button
          type="button"
          class="px-3 py-1.5 rounded-lg border border-brand-soft bg-white hover:bg-brand-soft/40 transition"
          id="magic-link-modal-close-bottom"
        >
          Закрыть
        </button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById("magic-link-modal");
      const userNameEl = document.getElementById("magic-link-user-name");
      const tokenEl = document.getElementById("magic-link-token");
      const urlEl = document.getElementById("magic-link-url");
      const errorEl = document.getElementById("magic-link-error");
      const btnCopyToken = document.getElementById("magic-link-copy-token");
      const btnCopyUrl = document.getElementById("magic-link-copy-url");
      const btnClose = document.getElementById("magic-link-modal-close");
      const btnCloseBottom = document.getElementById("magic-link-modal-close-bottom");

      if (!modal || !userNameEl || !tokenEl || !urlEl || !btnCopyToken || !btnCopyUrl) {
        return;
      }

      function getCsrfToken() {
        const input = document.querySelector("input[name=csrfmiddlewaretoken]");
        return input ? input.value : null;
      }

      function openModal(data) {
        errorEl.classList.add("hidden");
        errorEl.textContent = "";
        userNameEl.textContent = data.userName || "";
        tokenEl.textContent = data.token || "";
        urlEl.textContent = data.link || "";
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function closeModal() {
        modal.classList.remove("flex");
        modal.classList.add("hidden");
      }

      function copyText(text) {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).catch(function () {});
        } else {
          const temp = document.createElement("textarea");
          temp.value = text;
          temp.style.position = "fixed";
          temp.style.left = "-9999px";
          document.body.appendChild(temp);
          temp.select();
          try {
            document.execCommand("copy");
          } catch (e) {}
          document.body.removeChild(temp);
        }
      }

      btnCopyToken.addEventListener("click", function () {
        copyText(tokenEl.textContent.trim());
      });

      btnCopyUrl.addEventListener("click", function () {
        copyText(urlEl.textContent.trim());
      });

      [btnClose, btnCloseBottom].forEach(function (btn) {
        if (btn) {
          btn.addEventListener("click", closeModal);
        }
      });

      modal.addEventListener("click", function (event) {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.querySelectorAll("[data-magic-link-generate]").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const userId = btn.getAttribute("data-user-id");
          const userName = btn.getAttribute("data-user-name") || "";
          if (!userId || btn.disabled) {
            return;
          }

          btn.disabled = true;
          const originalText = btn.innerHTML;
          btn.innerHTML = '<svg class="animate-spin h-4 w-4 text-brand-dark" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.5-3.5L12 0v4a8 8 0 00-8 8h4z"></path></svg>';

          const csrfToken = getCsrfToken();
          fetch("/settings/users/" + userId + "/magic-link/generate/", {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "Content-Type": "application/json",
              ...(csrfToken ? { "X-CSRFToken": csrfToken } : {}),
            },
            body: "{}",
          })
            .then(function (response) {
              const contentType = response.headers.get("Content-Type") || "";
              if (!contentType.includes("application/json")) {
                throw new Error("unexpected_response");
              }
              return response.json();
            })
            .then(function (data) {
              if (!data || data.success !== true) {
                throw new Error("error_response");
              }
              openModal({ userName: userName, token: data.token, link: data.link });
            })
            .catch(function () {
              errorEl.textContent = "Не удалось сгенерировать ключ доступа. Попробуйте ещё раз через несколько секунд.";
              errorEl.classList.remove("hidden");
              openModal({ userName: userName, token: "", link: "" });
            })
            .finally(function () {
              btn.disabled = false;
              btn.innerHTML = originalText;
            });
        });
      });
    })();
  </script>
{% endblock %}

