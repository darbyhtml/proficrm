{% extends "ui/base.html" %}
{% block title %}Пользователи — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">Настройки</a> /</div>
        <h1 class="text-2xl font-semibold">Пользователи</h1>
      </div>
      <a href="/settings/users/new/" class="btn btn-primary">+ Добавить пользователя</a>
    </div>

    <form method="post" class="bg-white border rounded-2xl p-4">
      {% csrf_token %}
      <div class="flex items-center gap-2">
        <input type="checkbox" name="view_as_enabled" id="view_as_enabled" {% if view_as_enabled %}checked{% endif %} onchange="this.form.submit()" />
        <label for="view_as_enabled" class="text-sm text-brand-dark/80">
          Режим просмотра администратора
        </label>
        <input type="hidden" name="toggle_view_as" value="1" />
      </div>
      <div class="text-xs text-brand-dark/60 mt-1">
        Позволяет администратору просматривать систему с точки зрения другой роли или филиала
      </div>
    </form>

    <form method="get" class="bg-white border rounded-2xl p-4 shadow-sm">
      <div class="flex flex-wrap items-end gap-3">
        <div class="flex-1 min-w-[200px]">
          <label for="users-search" class="block text-xs font-medium text-brand-dark/70 uppercase mb-1.5">Поиск</label>
          <div class="relative">
            <input
              id="users-search"
              type="text"
              name="q"
              value="{{ q }}"
              placeholder="ФИО, логин или email"
              class="w-full rounded-xl border border-brand-soft/80 px-3 py-2 text-sm text-brand-dark focus:outline-none focus:ring-2 focus:ring-brand-teal/30 focus:border-brand-teal bg-white transition-all"
            />
            <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-brand-dark/40 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
        </div>
        <div class="min-w-[140px]">
          <label for="users-status" class="block text-xs font-medium text-brand-dark/70 uppercase mb-1.5">Активность</label>
          <select
            id="users-status"
            name="status"
            class="w-full rounded-xl border border-brand-soft/80 bg-white px-3 py-2 text-sm text-brand-dark focus:outline-none focus:ring-2 focus:ring-brand-teal/30 focus:border-brand-teal transition-all"
          >
            <option value="" {% if not status_filter %}selected{% endif %}>Все</option>
            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Активные</option>
            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Заблокированные</option>
          </select>
        </div>
        <div class="min-w-[160px]">
          <label for="users-role" class="block text-xs font-medium text-brand-dark/70 uppercase mb-1.5">Роль</label>
          <select
            id="users-role"
            name="role"
            class="w-full rounded-xl border border-brand-soft/80 bg-white px-3 py-2 text-sm text-brand-dark focus:outline-none focus:ring-2 focus:ring-brand-teal/30 focus:border-brand-teal transition-all"
          >
            <option value="" {% if not role_filter %}selected{% endif %}>Все</option>
            <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Администраторы</option>
            <option value="manager" {% if role_filter == 'manager' %}selected{% endif %}>Менеджеры</option>
            <option value="branch_director" {% if role_filter == 'branch_director' %}selected{% endif %}>Директоры филиалов</option>
            <option value="sales_head" {% if role_filter == 'sales_head' %}selected{% endif %}>Руководители отдела продаж</option>
            <option value="group_manager" {% if role_filter == 'group_manager' %}selected{% endif %}>Управляющие группой</option>
          </select>
        </div>
        <div class="min-w-[140px]">
          <label for="users-branch" class="block text-xs font-medium text-brand-dark/70 uppercase mb-1.5">Филиал</label>
          <select
            id="users-branch"
            name="branch"
            class="w-full rounded-xl border border-brand-soft/80 bg-white px-3 py-2 text-sm text-brand-dark focus:outline-none focus:ring-2 focus:ring-brand-teal/30 focus:border-brand-teal transition-all"
          >
            <option value="" {% if not branch_filter %}selected{% endif %}>Все</option>
            {% for branch in branches %}
              <option value="{{ branch.id }}" {% if branch_filter == branch.id|stringformat:"s" %}selected{% endif %}>{{ branch.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="min-w-[120px]">
          <label for="users-online" class="block text-xs font-medium text-brand-dark/70 uppercase mb-1.5">Онлайн</label>
          <select
            id="users-online"
            name="online"
            class="w-full rounded-xl border border-brand-soft/80 bg-white px-3 py-2 text-sm text-brand-dark focus:outline-none focus:ring-2 focus:ring-brand-teal/30 focus:border-brand-teal transition-all"
          >
            <option value="" {% if not online_filter %}selected{% endif %}>Все</option>
            <option value="online" {% if online_filter == 'online' %}selected{% endif %}>Онлайн</option>
            <option value="offline" {% if online_filter == 'offline' %}selected{% endif %}>Офлайн</option>
          </select>
        </div>
        <input type="hidden" name="sort" value="{{ sort_field }}" />
        <input type="hidden" name="dir" value="{{ sort_dir }}" />
        <button
          type="submit"
          class="inline-flex items-center gap-2 rounded-xl bg-brand-teal text-white px-5 py-2 text-sm font-medium shadow-sm hover:bg-emerald-600 hover:shadow-md transition-all"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
          </svg>
          Применить
        </button>
      </div>
      {% if q or status_filter or role_filter or branch_filter or online_filter %}
        <div class="mt-3 pt-3 border-t border-brand-soft/60">
          <a href="/settings/users/" class="inline-flex items-center gap-1.5 text-xs text-brand-dark/60 hover:text-brand-teal transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Сбросить фильтры
          </a>
        </div>
      {% endif %}
    </form>

    <div class="bg-white border rounded-2xl overflow-hidden">
      <table class="min-w-full text-sm">
        <thead class="bg-brand-soft/40 text-brand-dark/80">
          <tr>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=username&dir={% if sort_field == 'username' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'username' %}text-brand-orange font-bold{% endif %}">
                Логин
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'username' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'username' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=full_name&dir={% if sort_field == 'full_name' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'full_name' %}text-brand-orange font-bold{% endif %}">
                ФИО
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'full_name' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'full_name' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=role&dir={% if sort_field == 'role' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'role' %}text-brand-orange font-bold{% endif %}">
                Роль
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'role' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'role' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=branch&dir={% if sort_field == 'branch' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'branch' %}text-brand-orange font-bold{% endif %}">
                Филиал
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=is_active&dir={% if sort_field == 'is_active' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'is_active' %}text-brand-orange font-bold{% endif %}">
                Активен
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'is_active' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'is_active' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=last_login&dir={% if sort_field == 'last_login' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'last_login' %}text-brand-orange font-bold{% endif %}">
                Последний вход
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'last_login' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'last_login' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr class="border-t hover:bg-brand-soft/20 transition-colors">
              <td class="px-4 py-3 font-mono text-brand-dark/90">{{ u.username }}</td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  {% if u.is_online %}
                    <span class="inline-flex items-center justify-center h-2.5 w-2.5 rounded-full bg-emerald-500 ring-2 ring-emerald-500/30" title="Онлайн">
                      <span class="inline-block h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                    </span>
                  {% else %}
                    <span class="inline-block h-2.5 w-2.5 rounded-full bg-gray-300" title="Офлайн"></span>
                  {% endif %}
                  <div class="flex flex-col">
                    <span class="text-brand-dark">{{ u.get_full_name|default:"—" }}</span>
                    <span class="text-xs text-brand-dark/60">{{ u.email|default:"" }}</span>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3">
                {% if u.role == 'admin' %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 text-emerald-800 px-2 py-0.5 text-xs font-medium border border-emerald-100">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                    {{ u.get_role_display }}
                  </span>
                {% elif u.role == 'manager' %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-blue-50 text-blue-800 px-2 py-0.5 text-xs font-medium border border-blue-100">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-blue-500"></span>
                    {{ u.get_role_display }}
                  </span>
                {% elif u.role == 'branch_director' %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-purple-50 text-purple-800 px-2 py-0.5 text-xs font-medium border border-purple-100">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-purple-500"></span>
                    {{ u.get_role_display }}
                  </span>
                {% elif u.role == 'sales_head' %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 text-amber-800 px-2 py-0.5 text-xs font-medium border border-amber-100">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-amber-500"></span>
                    {{ u.get_role_display }}
                  </span>
                {% elif u.role == 'group_manager' %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-indigo-50 text-indigo-800 px-2 py-0.5 text-xs font-medium border border-indigo-100">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-indigo-500"></span>
                    {{ u.get_role_display }}
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-slate-50 text-slate-700 px-2 py-0.5 text-xs font-medium border border-slate-200">
                    {{ u.get_role_display }}
                  </span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                {% if u.branch %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-brand-soft/30 text-brand-dark px-2 py-0.5 text-xs border border-brand-soft/70">
                    {{ u.branch }}
                  </span>
                {% else %}
                  <span class="text-xs text-brand-dark/50">—</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                {% if u.is_active %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 text-emerald-800 px-2 py-0.5 text-xs border border-emerald-100">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                    Активен
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-red-50 text-red-700 px-2 py-0.5 text-xs border border-red-100">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-red-500"></span>
                    Заблокирован
                  </span>
                {% endif %}
              </td>
              <td class="px-4 py-3 text-xs text-brand-dark/80 whitespace-nowrap">
                {% if u.last_login %}
                  {{ u.last_login|date:"d.m.Y H:i" }}
                {% else %}
                  <span class="text-brand-dark/50">никогда</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    class="flex items-center justify-center w-8 h-8 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors{% if not u.is_active %} opacity-40 cursor-not-allowed{% endif %}"
                    title="Сгенерировать ключ доступа"
                    aria-label="Сгенерировать ключ доступа"
                    data-magic-link-generate
                    data-user-id="{{ u.id }}"
                    data-user-name="{{ u.get_full_name|default:u.username }}"
                    {% if not u.is_active %}disabled aria-disabled="true"{% endif %}
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="8" cy="9" r="4" />
                      <circle cx="8" cy="9" r="2" />
                      <path d="M12 9h2.5" />
                      <path d="M14.5 5.5H19v2h-1.5v2H19v2h-1.5v2H14.5V5.5z" />
                    </svg>
                  </button>
                  <button
                    type="button"
                    class="flex items-center justify-center w-8 h-8 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors"
                    title="Редактировать"
                    aria-label="Редактировать"
                    data-user-edit
                    data-user-id="{{ u.id }}"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9"/>
                      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                    </svg>
                  </button>
                  <form method="post" action="/settings/users/{{ u.id }}/logout/" onsubmit="return confirm('Вы уверены, что хотите разлогинить этого пользователя? Все его активные сессии будут завершены.');" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" class="flex items-center justify-center w-8 h-8 rounded bg-white border border-red-300 hover:bg-red-50 transition-colors" title="Разлогинить пользователя" aria-label="Разлогинить пользователя" style="border-color:rgba(220,38,38,.5);color:#b91c1c;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td class="px-4 py-6 text-brand-dark/70 text-sm" colspan="7">
                {% if q or status_filter or role_filter or branch_filter or online_filter %}
                  По текущим фильтрам пользователей не найдено.
                  <a href="/settings/users/" class="underline text-brand-teal">Сбросить фильтры</a>
                {% else %}
                  Пользователей нет.
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <div
    id="magic-link-modal"
    class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/30 px-4"
  >
    <div class="w-full max-w-lg rounded-2xl bg-white shadow-2xl border border-brand-soft/60">
      <div class="flex items-start justify-between gap-3 border-b border-brand-soft/60 px-5 py-4">
        <div>
          <div class="text-xs uppercase tracking-wide text-brand-dark/60">Ключ доступа</div>
          <div class="text-base font-semibold text-brand-dark">
            Для пользователя <span id="magic-link-user-name"></span>
          </div>
        </div>
        <button
          type="button"
          id="magic-link-modal-close"
          class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-soft/70 text-brand-dark/70 hover:bg-brand-soft/30 hover:text-brand-dark transition"
          aria-label="Закрыть"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
      <div class="space-y-4 px-5 py-4">
        <div class="space-y-1">
          <div class="text-xs font-medium text-brand-dark/70 uppercase">Ключ (для ввода на странице входа)</div>
          <div class="flex items-center gap-2 rounded-xl border border-brand-soft bg-brand-soft/10 px-3 py-2">
            <code id="magic-link-token" class="font-mono text-sm text-brand-dark break-all"></code>
            <button
              type="button"
              id="magic-link-copy-token"
              class="ml-auto inline-flex items-center gap-1 rounded-lg border border-brand-soft bg-white px-2 py-1 text-xs font-medium text-brand-dark hover:bg-brand-soft/40 transition"
            >
              Скопировать ключ
            </button>
          </div>
        </div>
        <div class="space-y-1">
          <div class="text-xs font-medium text-brand-dark/70 uppercase">Прямая ссылка</div>
          <div class="flex items-center gap-2 rounded-xl border border-brand-soft bg-brand-soft/5 px-3 py-2">
            <div id="magic-link-url" class="text-xs text-brand-dark/80 break-all"></div>
            <button
              type="button"
              id="magic-link-copy-url"
              class="ml-auto inline-flex items-center gap-1 rounded-lg border border-brand-soft bg-white px-2 py-1 text-xs font-medium text-brand-dark hover:bg-brand-soft/40 transition"
            >
              Скопировать ссылку
            </button>
          </div>
        </div>
        <div class="text-xs text-brand-dark/70">
          Ключ действует в течение 24 часов и одноразовый. Передайте его пользователю удобным способом (чат, почта и т.п.).
        </div>
        <div id="magic-link-error" class="hidden text-xs text-red-600"></div>
      </div>
      <div class="flex items-center justify-end gap-2 border-t border-brand-soft/60 bg-brand-soft/10 px-5 py-3 text-xs text-brand-dark/70">
        <button
          type="button"
          class="px-3 py-1.5 rounded-lg border border-brand-soft bg-white hover:bg-brand-soft/40 transition"
          id="magic-link-modal-close-bottom"
        >
          Закрыть
        </button>
      </div>
    </div>
  </div>

  <div
    id="user-edit-panel"
    class="fixed inset-y-0 right-0 z-[90] w-full max-w-2xl bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto"
  >
    <div class="sticky top-0 z-20 bg-white border-b border-brand-soft/60 px-6 py-4 flex items-center justify-between">
      <div>
        <div class="text-xs uppercase tracking-wide text-brand-dark/60">Редактирование</div>
        <div class="text-lg font-semibold text-brand-dark" id="user-edit-panel-title">Пользователь</div>
      </div>
      <button
        type="button"
        id="user-edit-panel-close"
        class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-soft/70 text-brand-dark/70 hover:bg-brand-soft/30 hover:text-brand-dark transition"
        aria-label="Закрыть"
      >
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>
    <div class="p-6" id="user-edit-panel-content">
      <div class="flex items-center justify-center py-12">
        <div class="animate-spin h-8 w-8 border-2 border-brand-teal border-t-transparent rounded-full"></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById("magic-link-modal");
      const userNameEl = document.getElementById("magic-link-user-name");
      const tokenEl = document.getElementById("magic-link-token");
      const urlEl = document.getElementById("magic-link-url");
      const errorEl = document.getElementById("magic-link-error");
      const btnCopyToken = document.getElementById("magic-link-copy-token");
      const btnCopyUrl = document.getElementById("magic-link-copy-url");
      const btnClose = document.getElementById("magic-link-modal-close");
      const btnCloseBottom = document.getElementById("magic-link-modal-close-bottom");

      if (!modal || !userNameEl || !tokenEl || !urlEl || !btnCopyToken || !btnCopyUrl) {
        return;
      }

      function getCsrfToken() {
        const input = document.querySelector("input[name=csrfmiddlewaretoken]");
        return input ? input.value : null;
      }

      function openModal(data) {
        // Закрываем панель редактирования если она открыта
        const editPanel = document.getElementById("user-edit-panel");
        const editOverlay = document.getElementById("user-edit-overlay");
        if (editPanel && !editPanel.classList.contains("translate-x-full")) {
          editPanel.classList.add("translate-x-full");
          if (editOverlay) editOverlay.classList.add("hidden");
          document.body.style.overflow = "";
        }
        
        errorEl.classList.add("hidden");
        errorEl.textContent = "";
        userNameEl.textContent = data.userName || "";
        tokenEl.textContent = data.token || "";
        urlEl.textContent = data.link || "";
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function closeModal() {
        modal.classList.remove("flex");
        modal.classList.add("hidden");
      }

      function copyText(text) {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).catch(function () {});
        } else {
          const temp = document.createElement("textarea");
          temp.value = text;
          temp.style.position = "fixed";
          temp.style.left = "-9999px";
          document.body.appendChild(temp);
          temp.select();
          try {
            document.execCommand("copy");
          } catch (e) {}
          document.body.removeChild(temp);
        }
      }

      btnCopyToken.addEventListener("click", function () {
        copyText(tokenEl.textContent.trim());
      });

      btnCopyUrl.addEventListener("click", function () {
        copyText(urlEl.textContent.trim());
      });

      [btnClose, btnCloseBottom].forEach(function (btn) {
        if (btn) {
          btn.addEventListener("click", closeModal);
        }
      });

      modal.addEventListener("click", function (event) {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.querySelectorAll("[data-magic-link-generate]").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const userId = btn.getAttribute("data-user-id");
          const userName = btn.getAttribute("data-user-name") || "";
          if (!userId || btn.disabled) {
            return;
          }

          btn.disabled = true;
          const originalText = btn.innerHTML;
          btn.innerHTML = '<svg class="animate-spin h-4 w-4 text-brand-dark" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.5-3.5L12 0v4a8 8 0 00-8 8h4z"></path></svg>';

          const csrfToken = getCsrfToken();
          fetch("/settings/users/" + userId + "/magic-link/generate/", {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "Content-Type": "application/json",
              ...(csrfToken ? { "X-CSRFToken": csrfToken } : {}),
            },
            body: "{}",
          })
            .then(function (response) {
              const contentType = response.headers.get("Content-Type") || "";
              if (!contentType.includes("application/json")) {
                throw new Error("unexpected_response");
              }
              return response.json();
            })
            .then(function (data) {
              if (!data || data.success !== true) {
                throw new Error("error_response");
              }
              openModal({ userName: userName, token: data.token, link: data.link });
            })
            .catch(function () {
              errorEl.textContent = "Не удалось сгенерировать ключ доступа. Попробуйте ещё раз через несколько секунд.";
              errorEl.classList.remove("hidden");
              openModal({ userName: userName, token: "", link: "" });
            })
            .finally(function () {
              btn.disabled = false;
              btn.innerHTML = originalText;
            });
        });
      });
    })();

    (function () {
      const editPanel = document.getElementById("user-edit-panel");
      const editPanelContent = document.getElementById("user-edit-panel-content");
      const editPanelTitle = document.getElementById("user-edit-panel-title");
      const editPanelClose = document.getElementById("user-edit-panel-close");
      const overlay = document.createElement("div");
      overlay.id = "user-edit-overlay";
      overlay.className = "fixed inset-0 z-[85] bg-black/30 hidden";
      document.body.appendChild(overlay);

      let isLoadingForm = false; // Флаг для предотвращения множественных загрузок

      function getCsrfToken() {
        const input = document.querySelector("input[name=csrfmiddlewaretoken]");
        return input ? input.value : null;
      }

      function openPanel() {
        // Закрываем модалку ключа если она открыта
        const magicModal = document.getElementById("magic-link-modal");
        if (magicModal && !magicModal.classList.contains("hidden")) {
          magicModal.classList.remove("flex");
          magicModal.classList.add("hidden");
        }
        
        overlay.classList.remove("hidden");
        editPanel.classList.remove("translate-x-full");
        document.body.style.overflow = "hidden";
      }

      function closePanel() {
        editPanel.classList.add("translate-x-full");
        overlay.classList.add("hidden");
        document.body.style.overflow = "";
        // Сбрасываем содержимое панели (это также сбросит флаг handlersAttached при следующей загрузке)
        editPanelContent.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin h-8 w-8 border-2 border-brand-teal border-t-transparent rounded-full"></div></div>';
        isLoadingForm = false; // Сбрасываем флаг загрузки при закрытии панели
      }

      overlay.addEventListener("click", closePanel);
      if (editPanelClose) {
        editPanelClose.addEventListener("click", closePanel);
      }

      function setupEditForm(userId) {
        const form = editPanelContent.querySelector("#user-edit-form-inline");
        if (!form) return;

        // Проверяем, не были ли уже добавлены обработчики (предотвращаем дублирование)
        if (form.dataset.handlersAttached === "true") {
          return;
        }
        form.dataset.handlersAttached = "true";

        const toggleBtn = editPanelContent.querySelector("#toggle-new-password-inline");
        const passwordField = editPanelContent.querySelector("#id_new_password");
        const eyeIcon = editPanelContent.querySelector("#eye-icon-new-password-inline");
        const eyeOffIcon = editPanelContent.querySelector("#eye-off-icon-new-password-inline");

        if (toggleBtn && passwordField && eyeIcon && eyeOffIcon) {
          toggleBtn.addEventListener("click", function () {
            if (passwordField.type === "password") {
              passwordField.type = "text";
              eyeIcon.classList.add("hidden");
              eyeOffIcon.classList.remove("hidden");
            } else {
              passwordField.type = "password";
              eyeIcon.classList.remove("hidden");
              eyeOffIcon.classList.add("hidden");
            }
          });
        }

        const cancelBtn = editPanelContent.querySelector("#user-edit-panel-cancel");
        if (cancelBtn) {
          cancelBtn.addEventListener("click", closePanel);
        }

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn ? submitBtn.innerHTML : "";
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.5-3.5L12 0v4a8 8 0 00-8 8h4z"></path></svg>';
          }

          const formData = new FormData(form);
          const csrfToken = getCsrfToken();

          fetch("/settings/users/" + userId + "/update/", {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              ...(csrfToken ? { "X-CSRFToken": csrfToken } : {}),
            },
            body: formData,
          })
            .then(function (response) {
              if (!response.ok) {
                throw new Error("HTTP " + response.status);
              }
              const contentType = response.headers.get("Content-Type") || "";
              if (!contentType.includes("application/json")) {
                throw new Error("Неверный формат ответа");
              }
              return response.json();
            })
            .then(function (data) {
              if (data.ok) {
                // При успешном сохранении ВСЕГДА перезагружаем страницу, даже если панель была закрыта
                // Данные изменились на сервере, пользователь должен видеть актуальные данные
                if (!editPanel.classList.contains("translate-x-full")) {
                  closePanel();
                }
                window.location.reload();
              } else {
                // При ошибке валидации проверяем, что панель все еще открыта
                if (editPanel.classList.contains("translate-x-full")) {
                  return; // Панель закрыта, игнорируем ошибки валидации
                }
                
                // Сохраняем состояние кнопки перед заменой HTML
                const savedOriginalText = originalText;
                
                editPanelContent.innerHTML = data.html || '<div class="text-red-600 p-4 rounded-lg border border-red-200 bg-red-50">Ошибка сохранения: ' + (data.error || "Неизвестная ошибка") + '</div>';
                
                // Повторно привязываем обработчики для формы с ошибками
                setupEditForm(userId);
                
                // Восстанавливаем состояние кнопки если форма была загружена
                const newForm = editPanelContent.querySelector("#user-edit-form-inline");
                if (newForm) {
                  const newSubmitBtn = newForm.querySelector('button[type="submit"]');
                  if (newSubmitBtn) {
                    newSubmitBtn.disabled = false;
                    newSubmitBtn.innerHTML = savedOriginalText;
                  }
                }
              }
            })
            .catch(function (error) {
              // Проверяем, что панель все еще открыта перед установкой ошибки
              if (editPanel.classList.contains("translate-x-full")) {
                return; // Панель закрыта, игнорируем ошибку
              }
              
              console.error("Ошибка сохранения:", error);
              const errorHtml = '<div class="space-y-3 text-red-600 p-4 rounded-lg border border-red-200 bg-red-50">' +
                '<div class="font-medium">Ошибка сохранения</div>' +
                '<div class="text-sm">' + (error.message || "Неизвестная ошибка") + '. Попробуйте ещё раз или обновите страницу.</div>' +
                '<button type="button" onclick="document.getElementById(\'user-edit-panel-close\').click()" class="text-xs underline hover:no-underline">Закрыть панель</button>' +
                '</div>';
              editPanelContent.innerHTML = errorHtml;
            });
        });
      }
      
      document.querySelectorAll("[data-user-edit]").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const userId = btn.getAttribute("data-user-id");
          if (!userId || isLoadingForm) return; // Предотвращаем множественные клики

          isLoadingForm = true;
          openPanel();
          editPanelContent.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin h-8 w-8 border-2 border-brand-teal border-t-transparent rounded-full"></div></div>';

          const csrfToken = getCsrfToken();
          fetch("/settings/users/" + userId + "/form/", {
            method: "GET",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              ...(csrfToken ? { "X-CSRFToken": csrfToken } : {}),
            },
          })
            .then(function (response) {
              if (!response.ok) {
                throw new Error("HTTP " + response.status);
              }
              const contentType = response.headers.get("Content-Type") || "";
              if (!contentType.includes("application/json")) {
                throw new Error("Неверный формат ответа");
              }
              return response.json();
            })
            .then(function (data) {
              // Проверяем, что панель все еще открыта (пользователь мог закрыть её во время загрузки)
              if (editPanel.classList.contains("translate-x-full")) {
                isLoadingForm = false;
                return;
              }
              
              if (!data || !data.ok) {
                throw new Error(data.error || "Ошибка загрузки формы");
              }
              if (!data.html || !data.user) {
                throw new Error("Неполные данные формы");
              }
              editPanelTitle.textContent = data.user.full_name || data.user.username || "Пользователь";
              editPanelContent.innerHTML = data.html;
              setupEditForm(userId);
              isLoadingForm = false; // Сбрасываем флаг после успешной загрузки
            })
            .catch(function (error) {
              // Проверяем, что панель все еще открыта перед установкой ошибки
              if (editPanel.classList.contains("translate-x-full")) {
                isLoadingForm = false;
                return;
              }
              
              console.error("Ошибка загрузки формы:", error);
              const errorHtml = '<div class="space-y-3 text-red-600 p-4 rounded-lg border border-red-200 bg-red-50">' +
                '<div class="font-medium">Ошибка загрузки формы</div>' +
                '<div class="text-sm">' + (error.message || "Неизвестная ошибка") + '. Попробуйте ещё раз или обновите страницу.</div>' +
                '<button type="button" onclick="document.getElementById(\'user-edit-panel-close\').click()" class="text-xs underline hover:no-underline">Закрыть панель</button>' +
                '</div>';
              editPanelContent.innerHTML = errorHtml;
              isLoadingForm = false; // Сбрасываем флаг при ошибке
            });
        });
      });
    })();
  </script>
{% endblock %}

