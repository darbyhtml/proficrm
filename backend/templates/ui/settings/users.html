{% extends "ui/base.html" %}
{% block title %}Пользователи — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-end justify-between gap-3">
      <div>
        <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">Настройки</a> /</div>
        <h1 class="text-2xl font-semibold">Пользователи</h1>
      </div>
      <a href="/settings/users/new/" class="btn btn-primary">+ Добавить пользователя</a>
    </div>

    <form method="post" class="bg-white border rounded-2xl p-4">
      {% csrf_token %}
      <div class="flex items-center gap-2">
        <input type="checkbox" name="view_as_enabled" id="view_as_enabled" {% if view_as_enabled %}checked{% endif %} onchange="this.form.submit()" />
        <label for="view_as_enabled" class="text-sm text-brand-dark/80">
          Режим просмотра администратора
        </label>
        <input type="hidden" name="toggle_view_as" value="1" />
      </div>
      <div class="text-xs text-brand-dark/60 mt-1">
        Позволяет администратору просматривать систему с точки зрения другой роли или филиала
      </div>
    </form>

    <div class="bg-white border rounded-2xl overflow-hidden">
      <table class="min-w-full text-sm">
        <thead class="bg-brand-soft/40 text-brand-dark/80">
          <tr>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=username&dir={% if sort_field == 'username' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'username' %}text-brand-orange font-bold{% endif %}">
                Логин
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'username' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'username' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=full_name&dir={% if sort_field == 'full_name' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'full_name' %}text-brand-orange font-bold{% endif %}">
                ФИО
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'full_name' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'full_name' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=role&dir={% if sort_field == 'role' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'role' %}text-brand-orange font-bold{% endif %}">
                Роль
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'role' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'role' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=branch&dir={% if sort_field == 'branch' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'branch' %}text-brand-orange font-bold{% endif %}">
                Филиал
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'branch' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">
              <a href="?{% if qs %}{{ qs }}&{% endif %}sort=is_active&dir={% if sort_field == 'is_active' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-1 hover:text-brand-orange cursor-pointer select-none {% if sort_field == 'is_active' %}text-brand-orange font-bold{% endif %}">
                Активен
                <div class="flex flex-col gap-0.5">
                  <svg class="w-3 h-3 {% if sort_field == 'is_active' and sort_dir == 'asc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                  <svg class="w-3 h-3 {% if sort_field == 'is_active' and sort_dir == 'desc' %}text-brand-orange{% else %}opacity-30{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </a>
            </th>
            <th class="text-left px-4 py-3">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr class="border-t">
              <td class="px-4 py-3 font-mono">{{ u.username }}</td>
              <td class="px-4 py-3">{{ u.get_full_name|default:"—" }}</td>
              <td class="px-4 py-3">{{ u.get_role_display }}</td>
              <td class="px-4 py-3">{{ u.branch|default:"—" }}</td>
              <td class="px-4 py-3">{% if u.is_active %}Да{% else %}Нет{% endif %}</td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <a href="/settings/users/{{ u.id }}/edit/" class="flex items-center justify-center w-8 h-8 rounded bg-white border border-brand-soft hover:bg-brand-soft/40 transition-colors" title="Редактировать" aria-label="Редактировать">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9"/>
                      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                    </svg>
                  </a>
                  <form method="post" action="/settings/users/{{ u.id }}/logout/" onsubmit="return confirm('Вы уверены, что хотите разлогинить этого пользователя? Все его активные сессии будут завершены.');" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" class="flex items-center justify-center w-8 h-8 rounded bg-white border border-red-300 hover:bg-red-50 transition-colors" title="Разлогинить пользователя" aria-label="Разлогинить пользователя" style="border-color:rgba(220,38,38,.5);color:#b91c1c;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr><td class="px-4 py-6 text-brand-dark/70" colspan="6">Пользователей нет.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}


