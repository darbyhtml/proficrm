{% extends "ui/base.html" %}
{% block title %}{% if rule %}Редактирование правила{% else %}Создание правила{% endif %} маршрутизации — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4 max-w-3xl">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">Настройки</a> / <a class="underline" href="/settings/messenger/">Messenger</a> / <a class="underline" href="/settings/messenger/routing/">Маршрутизация</a> /</div>
      <h1 class="text-2xl font-semibold">{% if rule %}Редактирование правила{% else %}Создание правила{% endif %} маршрутизации</h1>
    </div>

    <form method="post" class="space-y-4">
      {% csrf_token %}
      
      <div class="card">
        <div class="card-pad">
          <h2 class="text-lg font-semibold mb-4">Основные настройки</h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Название *</label>
              <input type="text" name="name" value="{{ rule.name|default:'' }}" class="input" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Inbox *</label>
              <select name="inbox" class="select" required>
                <option value="">Выберите Inbox</option>
                {% for inbox in inboxes %}
                  <option value="{{ inbox.id }}" {% if rule and rule.inbox_id == inbox.id %}selected{% endif %}>{{ inbox.name }} ({{ inbox.branch.name }})</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Филиал *</label>
              <select name="branch" class="select" required>
                <option value="">Выберите филиал</option>
                {% for branch in branches %}
                  <option value="{{ branch.id }}" {% if rule and rule.branch_id == branch.id %}selected{% endif %}>{{ branch.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Регионы</label>
              <select name="regions" multiple class="select" style="min-height: 120px;">
                {% for region in regions %}
                  <option value="{{ region.id }}" {% if region.id in selected_region_ids %}selected{% endif %}>{{ region.name }}</option>
                {% endfor %}
              </select>
              <div class="text-xs text-brand-dark/60 mt-1">Выберите регионы (можно несколько, зажмите Ctrl/Cmd)</div>
            </div>

            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Приоритет</label>
              <input type="number" name="priority" value="{{ rule.priority|default:100 }}" class="input" min="0" max="1000">
              <div class="text-xs text-brand-dark/60 mt-1">Меньше значение = выше приоритет</div>
            </div>

            <div class="space-y-2">
              <label class="flex items-center gap-2">
                <input type="checkbox" name="is_fallback" {% if rule.is_fallback %}checked{% endif %} class="rounded">
                <span class="text-sm font-medium text-brand-dark/80">Фолбэк-правило</span>
              </label>
              <div class="text-xs text-brand-dark/60 ml-6">Используется, если не найдено подходящего правила по региону</div>

              <label class="flex items-center gap-2">
                <input type="checkbox" name="is_active" {% if rule.is_active or not rule %}checked{% endif %} class="rounded">
                <span class="text-sm font-medium text-brand-dark/80">Активно</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button type="submit" class="btn btn-primary">Сохранить</button>
        <a href="/settings/messenger/routing/" class="btn btn-outline">Отмена</a>
      </div>
    </form>
  </div>
{% endblock %}
