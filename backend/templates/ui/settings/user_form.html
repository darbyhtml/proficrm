{% extends "ui/base.html" %}
{% block title %}{% if mode == 'edit' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% else %}–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å{% endif %} ‚Äî CRM –ü–†–û–§–ò{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> / <a class="underline" href="/settings/users/">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a> /</div>
      <h1 class="text-2xl font-semibold">{% if mode == 'edit' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% else %}–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å{% endif %}</h1>
    </div>

    <form method="post" class="bg-white border rounded-2xl p-4 space-y-3">
      {% csrf_token %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–õ–æ–≥–∏–Ω</label>
          {{ form.username }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Email</label>
          {{ form.email }}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–ò–º—è</label>
          {{ form.first_name }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–§–∞–º–∏–ª–∏—è</label>
          {{ form.last_name }}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–†–æ–ª—å</label>
          {{ form.role }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–§–∏–ª–∏–∞–ª</label>
          {{ form.branch }}
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm">
        {{ form.is_active }}
        <label>–ê–∫—Ç–∏–≤–µ–Ω</label>
      </div>

      {% if mode == 'create' %}
        <div class="rounded-lg border border-brand-teal/60 bg-brand-teal/10 p-3 text-sm text-brand-dark">
          <div class="font-semibold mb-1">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ö–æ–¥–µ</div>
          <div>–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞. –ü–∞—Ä–æ–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.</div>
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="rounded-lg border border-brand-orange/60 bg-brand-orange/20 p-3 text-sm text-brand-dark">–ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—è —Ñ–æ—Ä–º—ã.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a class="btn btn-outline" href="/settings/users/">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>

    {% if mode == 'edit' and u.is_active %}
      <div class="bg-white border rounded-2xl p-4 space-y-3 mt-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg font-semibold">–ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞</div>
            <div class="text-sm text-brand-dark/70">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
          </div>
          <form method="post" action="/settings/users/{{ u.id }}/magic-link/generate/" id="magicLinkGenerateForm">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline" id="generateMagicLinkBtn">üîó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
          </form>
        </div>

        {% if user_created %}
          <div class="rounded-lg border border-brand-teal/60 bg-brand-teal/10 p-3 text-sm text-brand-dark">
            <div class="font-semibold mb-1">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω</div>
            <div>–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ.</div>
          </div>
        {% endif %}

        {% if magic_link_generated %}
          <div class="rounded-lg border border-brand-teal/60 bg-brand-teal/10 p-4 space-y-2">
            <div class="text-sm font-semibold text-brand-dark">–ù–æ–≤—ã–π –∫–ª—é—á —Å–æ–∑–¥–∞–Ω:</div>
            <div class="flex items-center gap-2">
              <input type="text" id="magicLinkInput" value="{{ magic_link_generated.link }}" readonly class="input flex-1 font-mono text-xs" />
              <button type="button" class="btn btn-outline text-sm" onclick="copyMagicLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div class="text-xs text-brand-dark/70">
              –ò—Å—Ç–µ–∫–∞–µ—Ç: {{ magic_link_generated.expires_at|date:"d.m.Y H:i" }} (—á–µ—Ä–µ–∑ 24 —á–∞—Å–∞)
            </div>
            <div class="text-xs text-brand-dark/60">
              ‚ö†Ô∏è –ö–ª—é—á –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ.
            </div>
          </div>
        {% endif %}

        {% if all_magic_link_tokens %}
          <div class="space-y-2">
            <div class="text-sm font-semibold text-brand-dark">–ò—Å—Ç–æ—Ä–∏—è –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–∞:</div>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              {% for token in all_magic_link_tokens %}
                <div class="rounded-lg border border-brand-soft p-3 space-y-1 text-xs">
                  <div class="flex items-center justify-between">
                    <div class="font-mono text-xs text-brand-dark/70 break-all">
                      {{ token.token_hash|slice:":16" }}...
                    </div>
                    <div>
                      {% if token.used_at %}
                        <span class="badge badge-warn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</span>
                      {% elif token.expires_at < now %}
                        <span class="badge badge-warn">–ò—Å—Ç—ë–∫</span>
                      {% else %}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                      {% endif %}
                    </div>
                  </div>
                  <div class="text-brand-dark/70">
                    –°–æ–∑–¥–∞–Ω: {{ token.created_at|date:"d.m.Y H:i" }}
                    {% if token.created_by %}
                      –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {{ token.created_by }}
                    {% endif %}
                  </div>
                  <div class="text-brand-dark/70">
                    –ò—Å—Ç–µ–∫–∞–µ—Ç: {{ token.expires_at|date:"d.m.Y H:i" }}
                  </div>
                  {% if token.used_at %}
                    <div class="text-brand-dark/70">
                      –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {{ token.used_at|date:"d.m.Y H:i" }}
                      {% if token.ip_address %}
                        —Å IP {{ token.ip_address }}
                      {% endif %}
                    </div>
                  {% endif %}
                  {% if token.ip_address and not token.used_at %}
                    <div class="text-brand-dark/70">
                      IP –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏: {{ token.ip_address }}
                    </div>
                  {% endif %}
                  {% if token.user_agent %}
                    <div class="text-brand-dark/60 truncate" title="{{ token.user_agent }}">
                      User-Agent: {{ token.user_agent|truncatewords:5 }}
                    </div>
                  {% endif %}
                  {% if active_sessions %}
                    {% for session in active_sessions %}
                      {% if token.used_at and token.used_at|date:"Y-m-d H:i" == session.last_activity|date:"Y-m-d H:i"|slice:":16" %}
                        <div class="text-brand-teal font-semibold">
                          ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è (–∏—Å—Ç–µ–∫–∞–µ—Ç {{ session.expire_date|date:"d.m.Y H:i" }})
                        </div>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <div class="rounded-lg border border-brand-soft p-3 text-sm text-brand-dark/70">
            –ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å.
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <script>
    function copyMagicLink() {
      const input = document.getElementById('magicLinkInput');
      if (input) {
        input.select();
        input.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        document.execCommand('copy');
        alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ AJAX (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('magicLinkGenerateForm');
      if (form) {
        form.addEventListener('submit', (e) => {
          // –û–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã (–Ω–µ AJAX) - —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —Å–µ—Å—Å–∏–∏
        });
      }
    });
  </script>

{% endblock %}


