{% extends "ui/base.html" %}
{% block title %}{% if mode == 'edit' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% else %}–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å{% endif %} ‚Äî CRM –ü–†–û–§–ò{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> / <a class="underline" href="/settings/users/">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a> /</div>
      <h1 class="text-2xl font-semibold">{% if mode == 'edit' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% else %}–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å{% endif %}</h1>
    </div>

    <form method="post" class="bg-white border rounded-2xl p-4 space-y-3">
      {% csrf_token %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–õ–æ–≥–∏–Ω</label>
          {{ form.username }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Email</label>
          {{ form.email }}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–ò–º—è</label>
          {{ form.first_name }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–§–∞–º–∏–ª–∏—è</label>
          {{ form.last_name }}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–†–æ–ª—å</label>
          {{ form.role }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–§–∏–ª–∏–∞–ª</label>
          {{ form.branch }}
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm">
        {{ form.is_active }}
        <label>–ê–∫—Ç–∏–≤–µ–Ω</label>
      </div>

      {% if mode == 'create' %}
        <div class="rounded-lg border border-brand-teal/60 bg-brand-teal/10 p-3 text-sm text-brand-dark">
          <div class="font-semibold mb-1">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ö–æ–¥–µ</div>
          <div id="create-info-text">–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞. –ü–∞—Ä–æ–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.</div>
        </div>
      {% else %}
        {% if u.role == 'admin' %}
        <div class="space-y-3">
          <div class="flex items-center gap-2">
            <button type="button" id="generate-password-btn" class="btn btn-outline text-sm">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å</button>
          </div>
            <div>
              <label class="block text-sm text-brand-dark/80 mb-1">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)</label>
          <div class="relative">
            {{ form.new_password }}
            <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-brand-dark/60 hover:text-brand-dark" id="toggle-new-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-icon-new-password">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              <svg class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-off-icon-new-password">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.29 3.29m0 0A9.976 9.976 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
              </svg>
            </button>
              </div>
              <div class="text-xs text-brand-dark/60 mt-1">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª—å. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.</div>
          </div>
        </div>
        {% endif %}
      {% endif %}

      {% if form.errors %}
        <div class="rounded-lg border border-brand-orange/60 bg-brand-orange/20 p-3 text-sm text-brand-dark">–ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—è —Ñ–æ—Ä–º—ã.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a class="btn btn-outline" href="/settings/users/">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>

    {% if mode == 'edit' and u.is_active %}
      <div class="bg-white border rounded-2xl p-4 space-y-3 mt-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg font-semibold">–ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞</div>
            <div class="text-sm text-brand-dark/70">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
          </div>
          <form method="post" action="/settings/users/{{ u.id }}/magic-link/generate/" id="magicLinkGenerateForm">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline" id="generateMagicLinkBtn">üîó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
          </form>
        </div>

        {% if user_created %}
          <div class="rounded-lg border border-brand-teal/60 bg-brand-teal/10 p-3 text-sm text-brand-dark">
            <div class="font-semibold mb-1">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω</div>
            {% if u.role == 'admin' %}
              <div>–ü–∞—Ä–æ–ª—å –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏.</div>
            {% else %}
              <div>–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ.</div>
            {% endif %}
          </div>
        {% endif %}

        {% if magic_link_generated %}
          <div class="rounded-lg border border-brand-teal/60 bg-brand-teal/10 p-4 space-y-2">
            <div class="text-sm font-semibold text-brand-dark">–ù–æ–≤—ã–π –∫–ª—é—á —Å–æ–∑–¥–∞–Ω:</div>
            
            <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –∫–ª—é—á–æ–º –∏ —Å—Å—ã–ª–∫–æ–π -->
            <div class="flex border-b border-brand-soft">
              <button 
                type="button"
                id="tab-key-token"
                class="flex-1 px-4 py-2 text-sm font-medium text-center transition-colors bg-brand-teal text-white"
                onclick="switchAccessKeyTab('token')"
              >
                –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞
              </button>
              <button 
                type="button"
                id="tab-key-link"
                class="flex-1 px-4 py-2 text-sm font-medium text-center transition-colors text-brand-dark/60 hover:text-brand-dark hover:bg-brand-soft/20"
                onclick="switchAccessKeyTab('link')"
              >
                –°—Å—ã–ª–∫–∞
              </button>
            </div>
            
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞" -->
            <div id="access-key-token-content" class="space-y-2">
              <div class="flex items-center gap-2">
                <input type="text" id="magicTokenInput" value="{{ magic_link_generated.token }}" readonly class="input flex-1 font-mono text-xs" />
                <button type="button" class="btn btn-outline text-sm" onclick="copyMagicToken()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </div>
            
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–°—Å—ã–ª–∫–∞" -->
            <div id="access-key-link-content" class="space-y-2 hidden">
              <div class="flex items-center gap-2">
                <input type="text" id="magicLinkInput" value="{{ magic_link_generated.link }}" readonly class="input flex-1 font-mono text-xs" />
                <button type="button" class="btn btn-outline text-sm" onclick="copyMagicLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </div>
            
            <div class="text-xs text-brand-dark/70">
              –ò—Å—Ç–µ–∫–∞–µ—Ç: {{ magic_link_generated.expires_at|date:"d.m.Y H:i" }} (—á–µ—Ä–µ–∑ 24 —á–∞—Å–∞)
            </div>
            <div class="text-xs text-brand-dark/60">
              ‚ö†Ô∏è –ö–ª—é—á –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ.
            </div>
          </div>
        {% endif %}
        
        {% if admin_password_generated %}
          <div class="rounded-lg border border-brand-teal/60 bg-brand-teal/10 p-4 space-y-2">
            <div class="text-sm font-semibold text-brand-dark">–ü–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–æ–∑–¥–∞–Ω:</div>
            <div class="flex items-center gap-2">
              <div class="relative flex-1">
                <input type="password" id="adminPasswordInput" value="{{ admin_password_generated.password }}" readonly class="input w-full font-mono text-xs pr-10" />
                <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-brand-dark/60 hover:text-brand-dark" id="toggle-admin-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-icon-admin-password">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                  <svg class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-off-icon-admin-password">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.29 3.29m0 0A9.976 9.976 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                  </svg>
                </button>
              </div>
              <button type="button" class="btn btn-outline text-sm" onclick="copyAdminPassword()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div class="text-xs text-brand-dark/60">
              ‚ö†Ô∏è –ü–∞—Ä–æ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ.
            </div>
          </div>
        {% endif %}

        {% if all_magic_link_tokens %}
          <div class="space-y-2">
            <div class="text-sm font-semibold text-brand-dark">–ò—Å—Ç–æ—Ä–∏—è –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–∞:</div>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              {% for token in all_magic_link_tokens %}
                <div class="rounded-lg border border-brand-soft p-3 space-y-1 text-xs">
                  <div class="flex items-center justify-between">
                    <div class="font-mono text-xs text-brand-dark/70 break-all">
                      {{ token.token_hash|slice:":16" }}...
                    </div>
                    <div>
                      {% if token.used_at %}
                        <span class="badge badge-warn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</span>
                      {% elif token.expires_at < now %}
                        <span class="badge badge-warn">–ò—Å—Ç—ë–∫</span>
                      {% else %}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                      {% endif %}
                    </div>
                  </div>
                  <div class="text-brand-dark/70">
                    –°–æ–∑–¥–∞–Ω: {{ token.created_at|date:"d.m.Y H:i" }}
                    {% if token.created_by %}
                      –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {{ token.created_by }}
                    {% endif %}
                  </div>
                  <div class="text-brand-dark/70">
                    –ò—Å—Ç–µ–∫–∞–µ—Ç: {{ token.expires_at|date:"d.m.Y H:i" }}
                  </div>
                  {% if token.used_at %}
                    <div class="text-brand-dark/70">
                      –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {{ token.used_at|date:"d.m.Y H:i" }}
                      {% if token.ip_address %}
                        —Å IP {{ token.ip_address }}
                      {% endif %}
                    </div>
                    {% if token.last_activity %}
                      <div class="text-brand-teal font-semibold">
                        –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {{ token.last_activity|date:"d.m.Y H:i" }}
                      </div>
                    {% endif %}
                  {% endif %}
                  {% if token.ip_address and not token.used_at %}
                    <div class="text-brand-dark/70">
                      IP –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏: {{ token.ip_address }}
                    </div>
                  {% endif %}
                  {% if token.user_agent %}
                    <div class="text-brand-dark/60 truncate" title="{{ token.user_agent }}">
                      User-Agent: {{ token.user_agent|truncatewords:5 }}
                    </div>
                  {% endif %}
                  {% if active_sessions %}
                    {% for session in active_sessions %}
                      {% if token.used_at and token.used_at|date:"Y-m-d H:i" == session.last_activity|date:"Y-m-d H:i"|slice:":16" %}
                        <div class="text-brand-teal font-semibold">
                          ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è (–∏—Å—Ç–µ–∫–∞–µ—Ç {{ session.expire_date|date:"d.m.Y H:i" }})
                        </div>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <div class="rounded-lg border border-brand-soft p-3 text-sm text-brand-dark/70">
            –ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å.
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <script>
    function switchAccessKeyTab(tab) {
      const tokenTab = document.getElementById('tab-key-token');
      const linkTab = document.getElementById('tab-key-link');
      const tokenContent = document.getElementById('access-key-token-content');
      const linkContent = document.getElementById('access-key-link-content');
      
      if (tab === 'token') {
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É "–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞"
        tokenTab.classList.remove('text-brand-dark/60', 'hover:text-brand-dark', 'hover:bg-brand-soft/20');
        tokenTab.classList.add('bg-brand-teal', 'text-white');
        linkTab.classList.remove('bg-brand-teal', 'text-white');
        linkTab.classList.add('text-brand-dark/60', 'hover:text-brand-dark', 'hover:bg-brand-soft/20');
        
        tokenContent.classList.remove('hidden');
        linkContent.classList.add('hidden');
      } else {
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É "–°—Å—ã–ª–∫–∞"
        linkTab.classList.remove('text-brand-dark/60', 'hover:text-brand-dark', 'hover:bg-brand-soft/20');
        linkTab.classList.add('bg-brand-teal', 'text-white');
        tokenTab.classList.remove('bg-brand-teal', 'text-white');
        tokenTab.classList.add('text-brand-dark/60', 'hover:text-brand-dark', 'hover:bg-brand-soft/20');
        
        linkContent.classList.remove('hidden');
        tokenContent.classList.add('hidden');
      }
    }
    
    function copyMagicLink() {
      const input = document.getElementById('magicLinkInput');
      if (input) {
        input.select();
        input.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        document.execCommand('copy');
        alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
      }
    }
    
    function copyMagicToken() {
      const input = document.getElementById('magicTokenInput');
      if (input) {
        input.select();
        input.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        document.execCommand('copy');
        alert('–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
      }
    }
    
    function copyAdminPassword() {
      const input = document.getElementById('adminPasswordInput');
      if (input) {
        input.select();
        input.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        document.execCommand('copy');
        alert('–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
      }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª—è
    function generatePassword(length = 16) {
      const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const lowercase = 'abcdefghijklmnopqrstuvwxyz';
      const numbers = '0123456789';
      const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
      const all = uppercase + lowercase + numbers + symbols;
      
      let password = '';
      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–∏–Ω–∏–º—É–º –ø–æ –æ–¥–Ω–æ–º—É —Å–∏–º–≤–æ–ª—É –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
      password += uppercase[Math.floor(Math.random() * uppercase.length)];
      password += lowercase[Math.floor(Math.random() * lowercase.length)];
      password += numbers[Math.floor(Math.random() * numbers.length)];
      password += symbols[Math.floor(Math.random() * symbols.length)];
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–ª—É—á–∞–π–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
      for (let i = password.length; i < length; i++) {
        password += all[Math.floor(Math.random() * all.length)];
      }
      
      // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–∏–º–≤–æ–ª—ã
      return password.split('').sort(() => Math.random() - 0.5).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
    function handleGeneratePassword() {
      const password = generatePassword(16);
      const newPasswordField = document.getElementById('id_new_password');
      if (newPasswordField) {
        newPasswordField.value = password;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫ —Å–∫—Ä—ã—Ç–æ–º—É –≤–∏–¥—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏
        if (newPasswordField.type === 'text') {
          newPasswordField.type = 'password';
          document.getElementById('eye-icon-new-password').classList.remove('hidden');
          document.getElementById('eye-off-icon-new-password').classList.add('hidden');
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª—è
    function togglePasswordVisibility(fieldId, toggleBtnId, eyeIconId, eyeOffIconId) {
      const field = document.getElementById(fieldId);
      const toggleBtn = document.getElementById(toggleBtnId);
      const eyeIcon = document.getElementById(eyeIconId);
      const eyeOffIcon = document.getElementById(eyeOffIconId);
      
      if (!field || !toggleBtn || !eyeIcon || !eyeOffIcon) return;
      
      toggleBtn.addEventListener('click', () => {
        if (field.type === 'password') {
          field.type = 'text';
          eyeIcon.classList.add('hidden');
          eyeOffIcon.classList.remove('hidden');
        } else {
          field.type = 'password';
          eyeIcon.classList.remove('hidden');
          eyeOffIcon.classList.add('hidden');
        }
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      // –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è
      const generateBtn = document.getElementById('generate-password-btn');
      if (generateBtn) {
        generateBtn.addEventListener('click', handleGeneratePassword);
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è new_password
      togglePasswordVisibility('id_new_password', 'toggle-new-password', 'eye-icon-new-password', 'eye-off-icon-new-password');
      
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è admin password (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
      const toggleAdminPassword = document.getElementById('toggle-admin-password');
      const adminPasswordInput = document.getElementById('adminPasswordInput');
      const eyeIconAdminPassword = document.getElementById('eye-icon-admin-password');
      const eyeOffIconAdminPassword = document.getElementById('eye-off-icon-admin-password');
      
      if (toggleAdminPassword && adminPasswordInput && eyeIconAdminPassword && eyeOffIconAdminPassword) {
        toggleAdminPassword.addEventListener('click', () => {
          if (adminPasswordInput.type === 'password') {
            adminPasswordInput.type = 'text';
            eyeIconAdminPassword.classList.add('hidden');
            eyeOffIconAdminPassword.classList.remove('hidden');
          } else {
            adminPasswordInput.type = 'password';
            eyeIconAdminPassword.classList.remove('hidden');
            eyeOffIconAdminPassword.classList.add('hidden');
          }
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ AJAX (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      const form = document.getElementById('magicLinkGenerateForm');
      if (form) {
        form.addEventListener('submit', (e) => {
          // –û–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã (–Ω–µ AJAX) - —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —Å–µ—Å—Å–∏–∏
        });
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
      const roleSelect = document.getElementById('id_role');
      const createInfoText = document.getElementById('create-info-text');
      if (roleSelect && createInfoText) {
        roleSelect.addEventListener('change', () => {
          if (roleSelect.value === 'admin') {
            createInfoText.textContent = '–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–∞—Ä–æ–ª—å. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏.';
          } else {
            createInfoText.textContent = '–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞. –ü–∞—Ä–æ–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.';
          }
        });
      }
    });
  </script>

{% endblock %}


