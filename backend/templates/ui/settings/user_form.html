{% extends "ui/base.html" %}
{% block title %}{% if mode == 'edit' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% else %}–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å{% endif %} ‚Äî CRM –ü–†–û–§–ò{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> / <a class="underline" href="/settings/users/">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a> /</div>
      <h1 class="text-2xl font-semibold">{% if mode == 'edit' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% else %}–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å{% endif %}</h1>
    </div>

    <form method="post" class="bg-white border rounded-2xl p-4 space-y-3">
      {% csrf_token %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–õ–æ–≥–∏–Ω</label>
          {{ form.username }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">Email</label>
          {{ form.email }}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–ò–º—è</label>
          {{ form.first_name }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–§–∞–º–∏–ª–∏—è</label>
          {{ form.last_name }}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–†–æ–ª—å</label>
          {{ form.role }}
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–§–∏–ª–∏–∞–ª</label>
          {{ form.branch }}
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm">
        {{ form.is_active }}
        <label>–ê–∫—Ç–∏–≤–µ–Ω</label>
      </div>

      {% if mode == 'create' %}
        <div class="space-y-3">
          <div class="flex items-center gap-2">
            <button type="button" id="generate-password-btn" class="btn btn-outline text-sm">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-brand-dark/80 mb-1">–ü–∞—Ä–æ–ª—å</label>
              <div class="relative">
                {{ form.password1 }}
                <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-brand-dark/60 hover:text-brand-dark" id="toggle-password1" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-icon-password1">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                  <svg class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-off-icon-password1">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.29 3.29m0 0A9.976 9.976 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm text-brand-dark/80 mb-1">–ü–∞—Ä–æ–ª—å –µ—â—ë —Ä–∞–∑</label>
              <div class="relative">
                {{ form.password2 }}
                <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-brand-dark/60 hover:text-brand-dark" id="toggle-password2" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-icon-password2">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                  <svg class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-off-icon-password2">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.29 3.29m0 0A9.976 9.976 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <div>
          <div class="flex items-center gap-2 mb-2">
            <button type="button" id="generate-password-btn" class="btn btn-outline text-sm">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å</button>
          </div>
          <label class="block text-sm text-brand-dark/80 mb-1">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <div class="relative">
            {{ form.new_password }}
            <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-brand-dark/60 hover:text-brand-dark" id="toggle-new-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-icon-new-password">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              <svg class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="eye-off-icon-new-password">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.29 3.29m0 0A9.976 9.976 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
              </svg>
            </button>
          </div>
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="rounded-lg border border-brand-orange/60 bg-brand-orange/20 p-3 text-sm text-brand-dark">–ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—è —Ñ–æ—Ä–º—ã.</div>
      {% endif %}

      <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a class="btn btn-outline" href="/settings/users/">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>
  </div>

  <script>
    // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª—è
    function generatePassword(length = 16) {
      const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const lowercase = 'abcdefghijklmnopqrstuvwxyz';
      const numbers = '0123456789';
      const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
      const all = uppercase + lowercase + numbers + symbols;
      
      let password = '';
      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–∏–Ω–∏–º—É–º –ø–æ –æ–¥–Ω–æ–º—É —Å–∏–º–≤–æ–ª—É –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
      password += uppercase[Math.floor(Math.random() * uppercase.length)];
      password += lowercase[Math.floor(Math.random() * lowercase.length)];
      password += numbers[Math.floor(Math.random() * numbers.length)];
      password += symbols[Math.floor(Math.random() * symbols.length)];
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–ª—É—á–∞–π–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
      for (let i = password.length; i < length; i++) {
        password += all[Math.floor(Math.random() * all.length)];
      }
      
      // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–∏–º–≤–æ–ª—ã
      return password.split('').sort(() => Math.random() - 0.5).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
    function handleGeneratePassword() {
      const password = generatePassword(16);
      
      {% if mode == 'create' %}
      const password1Field = document.getElementById('id_password1');
      const password2Field = document.getElementById('id_password2');
      if (password1Field && password2Field) {
        password1Field.value = password;
        password2Field.value = password;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫ —Å–∫—Ä—ã—Ç–æ–º—É –≤–∏–¥—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏
        if (password1Field.type === 'text') {
          password1Field.type = 'password';
          document.getElementById('eye-icon-password1').classList.remove('hidden');
          document.getElementById('eye-off-icon-password1').classList.add('hidden');
        }
        if (password2Field.type === 'text') {
          password2Field.type = 'password';
          document.getElementById('eye-icon-password2').classList.remove('hidden');
          document.getElementById('eye-off-icon-password2').classList.add('hidden');
        }
      }
      {% else %}
      const newPasswordField = document.getElementById('id_new_password');
      if (newPasswordField) {
        newPasswordField.value = password;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫ —Å–∫—Ä—ã—Ç–æ–º—É –≤–∏–¥—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏
        if (newPasswordField.type === 'text') {
          newPasswordField.type = 'password';
          document.getElementById('eye-icon-new-password').classList.remove('hidden');
          document.getElementById('eye-off-icon-new-password').classList.add('hidden');
        }
      }
      {% endif %}
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª—è
    function togglePasswordVisibility(fieldId, toggleBtnId, eyeIconId, eyeOffIconId) {
      const field = document.getElementById(fieldId);
      const toggleBtn = document.getElementById(toggleBtnId);
      const eyeIcon = document.getElementById(eyeIconId);
      const eyeOffIcon = document.getElementById(eyeOffIconId);
      
      if (!field || !toggleBtn || !eyeIcon || !eyeOffIcon) return;
      
      toggleBtn.addEventListener('click', () => {
        if (field.type === 'password') {
          field.type = 'text';
          eyeIcon.classList.add('hidden');
          eyeOffIcon.classList.remove('hidden');
        } else {
          field.type = 'password';
          eyeIcon.classList.remove('hidden');
          eyeOffIcon.classList.add('hidden');
        }
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      // –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è
      const generateBtn = document.getElementById('generate-password-btn');
      if (generateBtn) {
        generateBtn.addEventListener('click', handleGeneratePassword);
      }

      {% if mode == 'create' %}
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è password1
      togglePasswordVisibility('id_password1', 'toggle-password1', 'eye-icon-password1', 'eye-off-icon-password1');
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è password2
      togglePasswordVisibility('id_password2', 'toggle-password2', 'eye-icon-password2', 'eye-off-icon-password2');
      {% else %}
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è new_password
      togglePasswordVisibility('id_new_password', 'toggle-new-password', 'eye-icon-new-password', 'eye-off-icon-new-password');
      {% endif %}
    });
  </script>
{% endblock %}


