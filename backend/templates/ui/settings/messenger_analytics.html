{% extends "ui/base.html" %}
{% load static %}
{% block title %}Messenger — Аналитика — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4 max-w-5xl">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="{% url 'settings_dashboard' %}">Настройки</a> / <a class="underline" href="{% url 'settings_messenger_overview' %}">Live-chat</a> / Аналитика /</div>
      <h1 class="text-2xl font-semibold">Аналитика Messenger</h1>
      <p class="text-sm text-brand-dark/70 mt-1">Период: последние {{ days }} дней</p>
    </div>
    {% include "ui/settings/messenger_nav.html" with active="analytics" %}

    <div class="flex gap-2 flex-wrap">
      <a class="btn btn-outline btn-sm {% if days == 7 %}btn-primary{% endif %}" href="?days=7">7 дней</a>
      <a class="btn btn-outline btn-sm {% if days == 30 %}btn-primary{% endif %}" href="?days=30">30 дней</a>
      <a class="btn btn-outline btn-sm {% if days == 90 %}btn-primary{% endif %}" href="?days=90">90 дней</a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card"><div class="card-pad">
        <div class="text-sm text-brand-dark/60">Диалогов (в период)</div>
        <div class="text-2xl font-semibold">{{ totals.total }}</div>
      </div></div>
      <div class="card"><div class="card-pad">
        <div class="text-sm text-brand-dark/60">Открыто / В ожидании</div>
        <div class="text-2xl font-semibold">{{ totals.open_pending }}</div>
      </div></div>
      <div class="card"><div class="card-pad">
        <div class="text-sm text-brand-dark/60">Среднее время 1-го ответа</div>
        <div class="text-2xl font-semibold">{{ avg_first_response|default:"—" }}</div>
      </div></div>
    </div>

    <div class="card">
      <div class="card-pad">
        <h2 class="text-lg font-semibold mb-3">Диалоги по дням</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-brand-dark/70">
              <tr class="border-b border-brand-soft/60">
                <th class="text-left py-2 pr-4">Дата</th>
                <th class="text-left py-2">Количество</th>
              </tr>
            </thead>
            <tbody>
              {% for row in by_day %}
                <tr class="border-b border-brand-soft/40">
                  <td class="py-1 pr-4">{{ row.day }}</td>
                  <td class="py-1 font-medium">{{ row.count }}</td>
                </tr>
              {% empty %}
                <tr><td class="py-3 text-brand-dark/60" colspan="2">Нет данных</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card">
        <div class="card-pad">
          <h2 class="text-lg font-semibold mb-3">Топ операторов</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-brand-dark/70">
                <tr class="border-b border-brand-soft/60">
                  <th class="text-left py-2 pr-4">Оператор</th>
                  <th class="text-left py-2 pr-4">Диалогов</th>
                  <th class="text-left py-2">Средний 1-й ответ</th>
                </tr>
              </thead>
              <tbody>
                {% for row in by_operator %}
                  <tr class="border-b border-brand-soft/40">
                    <td class="py-1 pr-4">{{ row.name }}</td>
                    <td class="py-1 pr-4 font-medium">{{ row.count }}</td>
                    <td class="py-1">{{ row.avg_first_response|default:"—" }}</td>
                  </tr>
                {% empty %}
                  <tr><td class="py-3 text-brand-dark/60" colspan="3">Нет данных</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-pad">
          <h2 class="text-lg font-semibold mb-3">По филиалам</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-brand-dark/70">
                <tr class="border-b border-brand-soft/60">
                  <th class="text-left py-2 pr-4">Филиал</th>
                  <th class="text-left py-2 pr-4">Диалогов</th>
                  <th class="text-left py-2">Средний 1-й ответ</th>
                </tr>
              </thead>
              <tbody>
                {% for row in by_branch %}
                  <tr class="border-b border-brand-soft/40">
                    <td class="py-1 pr-4">{{ row.name }}</td>
                    <td class="py-1 pr-4 font-medium">{{ row.count }}</td>
                    <td class="py-1">{{ row.avg_first_response|default:"—" }}</td>
                  </tr>
                {% empty %}
                  <tr><td class="py-3 text-brand-dark/60" colspan="3">Нет данных</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

