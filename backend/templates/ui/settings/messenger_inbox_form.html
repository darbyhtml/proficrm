{% extends "ui/base.html" %}
{% load static %}
{% block title %}{% if inbox %}Редактирование Inbox{% else %}Создание Inbox{% endif %} — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4 max-w-3xl">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">Настройки</a> / <a class="underline" href="/settings/messenger/">Messenger</a> /</div>
      <h1 class="text-2xl font-semibold">{% if inbox %}Редактирование Inbox{% else %}Создание Inbox{% endif %}</h1>
    </div>

    <form method="post" class="space-y-4">
      {% csrf_token %}
      
      <div class="card">
        <div class="card-pad">
          <h2 class="text-lg font-semibold mb-4">Основные настройки</h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Название *</label>
              <input type="text" name="name" value="{{ inbox.name|default:'' }}" class="input" required>
            </div>

            {% if inbox %}
              <div>
                <label class="block text-sm font-medium text-brand-dark/80 mb-1">Филиал</label>
                <div class="text-sm text-brand-dark/60 bg-brand-soft/20 p-2 rounded">
                  {% if inbox.branch %}{{ inbox.branch.name }} (нельзя изменить после создания){% else %}Глобальный inbox — филиал определяется по GeoIP и правилам маршрутизации{% endif %}
                </div>
              </div>
            {% else %}
              <div>
                <label class="block text-sm font-medium text-brand-dark/80 mb-1">Филиал</label>
                <select name="branch" class="select">
                  <option value="">Глобальный (общий) inbox — по GeoIP и правилам</option>
                  {% for branch in branches %}
                    <option value="{{ branch.id }}">{{ branch.name }}</option>
                  {% endfor %}
                </select>
                <p class="text-xs text-brand-dark/50 mt-1">Оставьте «Глобальный», чтобы филиал диалога определялся по региону клиента (IP) и правилам маршрутизации.</p>
              </div>
            {% endif %}

            <div>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="is_active" {% if inbox.is_active or not inbox %}checked{% endif %} class="rounded">
                <span class="text-sm font-medium text-brand-dark/80">Активен</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      {% if inbox %}
        <div class="card">
          <div class="card-pad">
            <h2 class="text-lg font-semibold mb-4">Widget Token</h2>
            
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-brand-dark/80 mb-1">Токен виджета <span class="text-brand-dark/50 font-normal" title="Секретный ключ для подключения виджета на сайте">(?)</span></label>
                <div class="flex items-center gap-2 flex-wrap">
                  <code class="flex-1 min-w-0 bg-brand-soft/30 p-2 rounded text-xs break-all">{{ inbox.widget_token }}</code>
                  <button type="button" onclick="copyToken()" class="btn btn-outline btn-sm" title="Скопировать токен">Скопировать токен</button>
                  <a href="/widget-demo/?token={{ inbox.widget_token }}" target="_blank" rel="noopener" class="btn btn-outline btn-sm" title="Открыть страницу с виджетом для проверки">Открыть демо</a>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-brand-dark/80 mb-1">Код вставки на сайт <span class="text-brand-dark/50 font-normal" title="Вставьте этот код перед &lt;/body&gt; на вашем сайте">(?)</span></label>
                <pre class="bg-brand-dark text-white p-3 rounded text-xs overflow-x-auto"><code>&lt;link rel="stylesheet" href="{{ base_url }}/static/messenger/widget.css"&gt;
&lt;script src="{{ base_url }}/static/messenger/widget.js" data-widget-token="{{ inbox.widget_token }}"&gt;&lt;/script&gt;</code></pre>
                <div class="flex items-center gap-2 mt-2">
                  <button type="button" onclick="copyCode()" class="btn btn-outline btn-sm">Скопировать код вставки</button>
                </div>
              </div>

              <div class="border-t border-brand-soft/60 pt-3">
                <form method="post" onsubmit="return confirm('Внимание! Старый токен перестанет работать. Все виджеты на сайтах нужно будет обновить. Продолжить?');">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="regenerate_token">
                  <button type="submit" class="btn btn-danger btn-sm">Сгенерировать новый токен</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="card">
        <div class="card-pad">
          <h2 class="text-lg font-semibold mb-4">Настройки виджета</h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Название в шапке виджета</label>
              <input type="text" name="widget_title" value="{{ inbox.settings.title|default:'Чат с поддержкой' }}" class="input" placeholder="Чат с поддержкой">
            </div>

            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Приветствие</label>
              <textarea name="widget_greeting" class="textarea" rows="2" placeholder="Добро пожаловать! Как мы можем вам помочь?">{{ inbox.settings.greeting|default:'' }}</textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-brand-dark/80 mb-1">Основной цвет</label>
              <input type="color" name="widget_color" value="{{ inbox.settings.color|default:'#01948E' }}" class="input" style="width: 100px; height: 40px;">
            </div>

            <div class="space-y-2">
              <label class="flex items-center gap-2">
                <input type="checkbox" name="widget_show_email" {% if inbox.settings.show_email|default:False %}checked{% endif %} class="rounded">
                <span class="text-sm font-medium text-brand-dark/80">Показывать поле email</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="widget_show_phone" {% if inbox.settings.show_phone|default:False %}checked{% endif %} class="rounded">
                <span class="text-sm font-medium text-brand-dark/80">Показывать поле телефона</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button type="submit" class="btn btn-primary">Сохранить</button>
        <a href="/settings/messenger/" class="btn btn-outline">Отмена</a>
      </div>
    </form>
  </div>

  <script>
    function copyToken() {
      const token = '{{ inbox.widget_token }}';
      navigator.clipboard.writeText(token).then(() => {
        alert('Токен скопирован в буфер обмена');
      });
    }
    function copyCode() {
      const code = `<link rel="stylesheet" href="{{ base_url }}/static/messenger/widget.css">
<script src="{{ base_url }}/static/messenger/widget.js" data-widget-token="{{ inbox.widget_token }}"></script>`;
      navigator.clipboard.writeText(code).then(() => {
        alert('Код скопирован в буфер обмена');
      });
    }
  </script>
{% endblock %}
