{% extends "ui/base.html" %}
{% block title %}amoCRM ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> / <a class="underline" href="/settings/amocrm/">amoCRM</a> /</div>
      <h1 class="text-2xl font-semibold">–ú–∏–≥—Ä–∞—Ü–∏—è –∏–∑ amoCRM</h1>
    </div>

    <div class="card card-pad space-y-3">
      <div id="import-running-status" class="hidden rounded-xl border border-amber-500/60 bg-amber-500/20 px-4 py-3 text-sm text-amber-800 mb-2">
        <b>–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.</b> –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –ö–Ω–æ–ø–∫–∞ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å¬ª –±—É–¥–µ—Ç —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è.
      </div>
      <form method="post" id="migrate-form" class="grid grid-cols-1 md:grid-cols-2 gap-3" data-progress-url="{% url 'settings_amocrm_migrate_progress' %}">
        {% csrf_token %}
        <input type="hidden" name="offset" value="{{ form.offset.value|default:0 }}" />

        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="dry_run" value="on" {% if form.dry_run.value %}checked{% endif %} />
            –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (dry-run)
          </label>
        </div>

        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–†–∞–∑–º–µ—Ä –ø–∞—á–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π</label>
          <input class="input" type="number" name="limit_companies" value="{{ form.limit_companies.value|default:10 }}" min="1" max="5000" />
          <div class="text-xs muted-2 mt-1">
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞.
            –ü—Ä–∏ 504 –æ—à–∏–±–∫–µ —É–º–µ–Ω—å—à–∏—Ç–µ –¥–æ 3‚Äì5 –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç nginx.
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm text-brand-dark/80 mb-1">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (amo) ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ–≥–æ</label>
          <select class="select w-full" name="responsible_user_id" id="migrate-responsible-select" required>
            <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî</option>
            {% for u in users %}
              <option value="{{ u.id }}"
                {% if request.POST.responsible_user_id %}
                  {% if request.POST.responsible_user_id == u.id|stringformat:"s" %}selected{% endif %}
                {% elif form.responsible_user_id.value %}
                  {% if form.responsible_user_id.value|stringformat:"s" == u.id|stringformat:"s" %}selected{% endif %}
                {% endif %}
              >{{ u.name }} (id={{ u.id }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="migrate_all_companies" value="on" {% if form.migrate_all_companies.value %}checked{% endif %} id="migrate_all_checkbox" />
            –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ø–æ–ª—é)
          </label>
          <div class="text-xs muted-2 mt-1">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –±—É–¥—É—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É –ø–æ–ª—é.</div>
        </div>

        <div class="md:col-span-2" id="custom_field_container">
          <label class="block text-sm text-brand-dark/80 mb-1">–ö–∞—Å—Ç–æ–º–Ω–æ–µ –ø–æ–ª–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
          <select class="select w-full" name="custom_field_id" id="custom_field_select">
            <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª–µ ‚Äî</option>
            {% for f in fields %}
              <option value="{{ f.id }}" {% if form.custom_field_id.value|stringformat:"s" == f.id|stringformat:"s" %}selected{% endif %}>{{ f.name }} (id={{ f.id }})</option>
            {% endfor %}
          </select>
          <div class="text-xs muted-2 mt-1">–¢—Ä–µ–±—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è "–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ".</div>
        </div>

        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–ó–Ω–∞—á–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç)</label>
          <input class="input" type="text" name="custom_value_label" value="{{ form.custom_value_label.value|default:'–ù–æ–≤–∞—è CRM' }}" placeholder="–ù–æ–≤–∞—è CRM" />
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–ó–Ω–∞—á–µ–Ω–∏–µ (enum id, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input class="input" type="number" name="custom_value_enum_id" value="{{ form.custom_value_enum_id.value|default:'' }}" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 123456" />
        </div>

        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="import_tasks" value="on" {% if form.import_tasks.value %}checked{% endif %} />
            –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏
          </label>
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="import_notes" value="on" {% if form.import_notes.value %}checked{% endif %} />
            –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏
          </label>
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="import_contacts" value="on" {% if form.import_contacts.value %}checked{% endif %} />
            –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã
            <span class="text-xs muted-2">(–º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ)</span>
          </label>
        </div>

        <div class="md:col-span-2 flex gap-2">
          <button class="btn btn-primary" type="submit" id="migrate-start-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <a class="btn btn-outline" href="/settings/amocrm/contacts-dry-run/?responsible_user_id={{ form.responsible_user_id.value|default:'' }}&limit_companies={{ form.limit_companies.value|default:250 }}&offset={{ form.offset.value|default:0 }}" target="_blank">üìá Dry-run –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</a>
          <a class="btn btn-outline" href="/settings/amocrm/debug-contacts/?limit=250{% if form.responsible_user_id.value %}&responsible_user_id={{ form.responsible_user_id.value }}{% endif %}" target="_blank">üîç –û—Ç–ª–∞–¥–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (250)</a>
          <a class="btn btn-outline" href="/settings/amocrm/">–ù–∞–∑–∞–¥</a>
        </div>
      </form>
    </div>

    {% if result %}
      <div class="card card-pad" id="result-container">
        <div class="font-medium mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        {% if form.dry_run.value %}
          <div class="mb-4 rounded-xl border border-orange-500/60 bg-orange-500/20 px-4 py-3 text-sm text-orange-700">
            <b>Dry-run: –¥–∞–Ω–Ω—ã–µ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</b>
          </div>
        {% endif %}
        {% if result.error %}
          <div class="mb-4 rounded-xl border border-red-500/60 bg-red-500/20 px-4 py-3 text-sm text-red-700">
            <div class="font-medium mb-1">‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:</div>
            <div>{{ result.error }}</div>
            {% if result.error_traceback %}
              <details class="mt-2">
                <summary class="cursor-pointer text-xs">–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏</summary>
                <pre class="mt-2 text-xs overflow-auto max-h-60 bg-red-50 p-2 rounded">{{ result.error_traceback }}</pre>
              </details>
            {% endif %}
          </div>
        {% endif %}
        <div class="text-sm text-brand-dark/80">
          –ö–æ–º–ø–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ —É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ: <b>{{ result.companies_seen }}</b>,
          –ø–æ —Ñ–∏–ª—å—Ç—Ä—É: <b>{{ result.companies_matched }}</b>,
          –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —ç—Ç–æ–π –ø–∞—á–∫–µ: <b>{{ result.companies_batch }}</b>,
          –ø—Ä–æ–≥—Ä–µ—Å—Å: <b>{{ result.companies_next_offset }}</b> / <b>{{ result.companies_matched }}</b>
          —Å–æ–∑–¥–∞–Ω–æ: <b>{{ result.companies_created }}</b>,
          –æ–±–Ω–æ–≤–ª–µ–Ω–æ: <b>{{ result.companies_updated }}</b>
        </div>
        <div class="text-sm text-brand-dark/80 mt-2">
          –ó–∞–¥–∞—á: –Ω–∞–π–¥–µ–Ω–æ <b>{{ result.tasks_seen }}</b>, –¥–æ–±–∞–≤–ª–µ–Ω–æ <b>{{ result.tasks_created }}</b>, –ø—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –±—ã–ª–æ) <b>{{ result.tasks_skipped_existing }}</b>{% if result.tasks_skipped_old %}, –ø—Ä–æ–ø—É—â–µ–Ω–æ (—Å—Ç–∞—Ä—ã–µ, –¥–æ 2026 –≥–æ–¥–∞) <b>{{ result.tasks_skipped_old }}</b>{% endif %}
        </div>
        <div class="text-sm text-brand-dark/80 mt-1">
          {% if form.dry_run.value %}
            –ó–∞–º–µ—Ç–æ–∫: –Ω–∞–π–¥–µ–Ω–æ <b>{{ result.notes_seen }}</b>, {% if result.notes_would_add %}–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ <b>{{ result.notes_would_add }}</b>{% else %}–¥–æ–±–∞–≤–ª–µ–Ω–æ <b>0</b>{% endif %}, {% if result.notes_would_update %}–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ <b>{{ result.notes_would_update }}</b>{% else %}–æ–±–Ω–æ–≤–ª–µ–Ω–æ <b>0</b>{% endif %}, –ø—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –±—ã–ª–æ) <b>{{ result.notes_skipped_existing|default:0 }}</b>
          {% else %}
            –ó–∞–º–µ—Ç–æ–∫: –Ω–∞–π–¥–µ–Ω–æ <b>{{ result.notes_seen }}</b>, –¥–æ–±–∞–≤–ª–µ–Ω–æ <b>{{ result.notes_created }}</b>, –æ–±–Ω–æ–≤–ª–µ–Ω–æ <b>{{ result.notes_updated|default:0 }}</b>, –ø—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –±—ã–ª–æ) <b>{{ result.notes_skipped_existing }}</b>
          {% endif %}
        </div>
        {% if form.import_contacts.value %}
          <div class="text-sm text-brand-dark/80 mt-1">
            {% if form.dry_run.value %}
              –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤: –Ω–∞–π–¥–µ–Ω–æ <b>{{ result.contacts_seen|default:0 }}</b>, {% if result.contacts_would_create %}–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ <b>{{ result.contacts_would_create }}</b>{% else %}—Å–æ–∑–¥–∞–Ω–æ <b>0</b>{% endif %}, {% if result.contacts_would_update %}–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ <b>{{ result.contacts_would_update }}</b>{% else %}–æ–±–Ω–æ–≤–ª–µ–Ω–æ <b>0</b>{% endif %}
            {% else %}
              –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤: –Ω–∞–π–¥–µ–Ω–æ <b>{{ result.contacts_seen|default:0 }}</b>, —Å–æ–∑–¥–∞–Ω–æ <b>{{ result.contacts_created|default:0 }}</b>, –æ–±–Ω–æ–≤–ª–µ–Ω–æ <b>{{ result.contacts_updated|default:0 }}</b>
            {% endif %}
          </div>
        {% endif %}

        {% if result.preview %}
          <div class="mt-3">
            <div class="text-sm text-brand-dark/70 mb-2">–ü—Ä–µ–≤—å—é –∫–æ–º–ø–∞–Ω–∏–π</div>
            <div class="space-y-2 text-sm">
              {% for p in result.preview %}
                <div class="rounded-lg border p-3">
                  <div class="font-medium">{{ p.company }}</div>
                  <div class="text-xs muted-2 mt-1">amo id: {{ p.amo_id }}</div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if form.dry_run.value and result.companies_updates_preview %}
          <div class="mt-4 border-t pt-4">
            <div class="font-medium mb-3">–ß—Ç–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ</div>
            <div class="space-y-3 text-sm">
              {% for update in result.companies_updates_preview %}
                <div class="rounded-lg border p-4 {% if update.is_new %}bg-green-50 border-green-200{% else %}bg-blue-50 border-blue-200{% endif %}">
                  <div class="font-medium mb-2 flex items-center gap-2">
                    {% if update.is_new %}
                      <span class="text-green-600">üÜï</span>
                      <span>–ù–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è: {{ update.company_name }}</span>
                    {% else %}
                      <span class="text-blue-600">üîÑ</span>
                      <span>{{ update.company_name }}</span>
                    {% endif %}
                    {% if update.company_id %}
                      <span class="text-xs muted-2">(ID: {{ update.company_id }})</span>
                    {% endif %}
                    <span class="text-xs muted-2">(amo id: {{ update.amo_id }})</span>
                  </div>
                  {% if update.updates %}
                    <div class="space-y-2 mt-3">
                      {% for field_name, diff in update.updates.items %}
                        <div class="bg-white rounded border p-2">
                          <div class="font-medium text-xs mb-1">
                            {% if field_name == "legal_name" %}–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                            {% elif field_name == "inn" %}–ò–ù–ù
                            {% elif field_name == "kpp" %}–ö–ü–ü
                            {% elif field_name == "address" %}–ê–¥—Ä–µ—Å
                            {% elif field_name == "phone" %}–¢–µ–ª–µ—Ñ–æ–Ω
                            {% elif field_name == "email" %}Email
                            {% elif field_name == "website" %}–°–∞–π—Ç
                            {% elif field_name == "phone_comment" %}–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–µ–ª–µ—Ñ–æ–Ω—É (–∫–æ–º–ø–∞–Ω–∏—è)
                            {% elif field_name == "contact_name" %}–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å
                            {% elif field_name == "activity_kind" %}–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                            {% elif field_name == "employees_count" %}–ß–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                            {% elif field_name == "workday_start" %}–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
                            {% elif field_name == "workday_end" %}–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
                            {% elif field_name == "work_timezone" %}–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                            {% else %}{{ field_name }}{% endif %}
                          </div>
                          <div class="flex gap-3 text-xs">
                            <div class="flex-1">
                              <div class="text-red-600 font-medium mb-1">–ë—ã–ª–æ:</div>
                              <div class="bg-red-50 p-2 rounded border border-red-200 break-words">
                                {{ diff.old|default:"‚Äî"|truncatewords:30 }}
                              </div>
                            </div>
                            <div class="flex-1">
                              <div class="text-green-600 font-medium mb-1">–ë—É–¥–µ—Ç:</div>
                              <div class="bg-green-50 p-2 rounded border border-green-200 break-words">
                                {{ diff.new|default:"‚Äî"|truncatewords:30 }}
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if form.dry_run.value and form.import_contacts.value and result.contacts_updates_preview %}
          <div class="mt-4 border-t pt-4">
            <div class="font-medium mb-3">–ß—Ç–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî –∫–æ–Ω—Ç–∞–∫—Ç—ã</div>
            <div class="space-y-3 text-sm">
              {% for c in result.contacts_updates_preview %}
                <div class="rounded-lg border p-4 {% if c.is_new %}bg-green-50 border-green-200{% else %}bg-blue-50 border-blue-200{% endif %}">
                  <div class="font-medium mb-1 flex flex-wrap items-center gap-2">
                    {% if c.is_new %}
                      <span class="text-green-600">üÜï</span>
                      <span>–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç: {{ c.contact_name }}</span>
                    {% else %}
                      <span class="text-blue-600">üîÑ</span>
                      <span>{{ c.contact_name }}</span>
                    {% endif %}
                    <span class="text-xs muted-2">(amo id: {{ c.amo_contact_id }})</span>
                  </div>
                  <div class="text-xs muted-2 mb-3">
                    –ö–æ–º–ø–∞–Ω–∏—è: {{ c.company_name }}{% if c.company_id %} (ID: {{ c.company_id }}){% endif %}
                  </div>

                  {% if c.field_changes %}
                    <div class="space-y-2">
                      {% for field_name, diff in c.field_changes.items %}
                        <div class="bg-white rounded border p-2">
                          <div class="font-medium text-xs mb-1">
                            {% if field_name == "position" %}–î–æ–ª–∂–Ω–æ—Å—Ç—å
                            {% elif field_name == "cold_call" %}–•–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫
                            {% elif field_name == "first_phone_comment" %}–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–µ—Ä–≤–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
                            {% else %}{{ field_name }}{% endif %}
                          </div>
                          <div class="flex gap-3 text-xs">
                            <div class="flex-1">
                              <div class="text-red-600 font-medium mb-1">–ë—ã–ª–æ:</div>
                              <div class="bg-red-50 p-2 rounded border border-red-200 break-words">{{ diff.old|default:"‚Äî"|truncatewords:30 }}</div>
                            </div>
                            <div class="flex-1">
                              <div class="text-green-600 font-medium mb-1">–ë—É–¥–µ—Ç:</div>
                              <div class="bg-green-50 p-2 rounded border border-green-200 break-words">{{ diff.new|default:"‚Äî"|truncatewords:30 }}</div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}

                  {% if c.phones_add %}
                    <div class="mt-3">
                      <div class="font-medium text-xs mb-2">–î–æ–±–∞–≤—è—Ç—Å—è —Ç–µ–ª–µ—Ñ–æ–Ω—ã:</div>
                      <div class="space-y-1 text-xs">
                        {% for p in c.phones_add %}
                          <div class="bg-white rounded border px-2 py-1">
                            <b>{{ p.value }}</b>
                            <span class="muted-2">({{ p.type }})</span>
                            {% if p.comment %}<span class="ml-2 text-brand-dark/70">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {{ p.comment|truncatewords:20 }}</span>{% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  {% if c.emails_add %}
                    <div class="mt-3">
                      <div class="font-medium text-xs mb-2">–î–æ–±–∞–≤—è—Ç—Å—è email:</div>
                      <div class="space-y-1 text-xs">
                        {% for e in c.emails_add %}
                          <div class="bg-white rounded border px-2 py-1">
                            <b>{{ e.value }}</b>
                            <span class="muted-2">({{ e.type }})</span>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  {% if c.all_custom_fields %}
                    <div class="mt-3">
                      <div class="font-medium text-xs mb-2">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è ({{ c.all_custom_fields|length }}):</div>
                      <div class="space-y-2 text-xs">
                        {% for cf in c.all_custom_fields %}
                          <div class="bg-white rounded border p-2 {% if cf.is_used %}border-green-300 bg-green-50{% endif %}">
                            <div class="font-medium mb-1">
                              {% if cf.is_used %}<span class="text-green-600">‚úì</span>{% endif %}
                              {{ cf.name|default:"(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)" }}
                              {% if cf.code %}<span class="muted-2">({{ cf.code }})</span>{% endif %}
                              {% if cf.usage_info %}
                                <span class="text-xs text-green-600">‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∫–∞–∫: {{ cf.usage_info|join:", " }}</span>
                              {% endif %}
                            </div>
                            <div class="text-xs muted-2 mb-1">
                              ID: {{ cf.field_id|default:"‚Äî" }}, —Ç–∏–ø: {{ cf.type|default:"‚Äî" }}
                            </div>
                            {% if cf.values %}
                              <div class="mt-1">
                                <b>–ó–Ω–∞—á–µ–Ω–∏—è ({{ cf.values|length }}):</b>
                                <div class="mt-1 pl-2 border-l-2 space-y-1">
                                  {% for val in cf.values %}
                                    <div>‚Ä¢ {{ val|truncatewords:30 }}</div>
                                  {% endfor %}
                                </div>
                              </div>
                            {% else %}
                              <div class="text-xs muted-2">–ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if form.dry_run.value %}
          <div class="mt-4 border-t pt-4">
            <div class="font-medium mb-2">Debug (dry-run)</div>
            {% if result.tasks_preview %}
              <div class="text-sm text-brand-dark/80">
                <div class="font-medium">–ó–∞–¥–∞—á–∏ (–ø–µ—Ä–≤—ã–µ 5)</div>
                <div class="space-y-2 mt-2">
                  {% for t in result.tasks_preview %}
                    <div class="rounded-lg border p-3 text-xs">
                      <div><b>id:</b> {{ t.id }} ¬∑ <b>raw_ts:</b> {{ t.raw_ts }} ¬∑ <b>parsed:</b> {{ t.parsed_due|default:"‚Äî" }}</div>
                      <div class="muted-2 mt-1"><b>keys:</b> {{ t.keys }}</div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if result.notes_preview %}
              <div class="text-sm text-brand-dark/80 mt-4">
                <div class="font-medium">–ó–∞–º–µ—Ç–∫–∏ (–ø–µ—Ä–≤—ã–µ 5)</div>
                <div class="space-y-2 mt-2">
                  {% for n in result.notes_preview %}
                    <div class="rounded-lg border p-3 text-xs">
                      <div><b>id:</b> {{ n.id }} ¬∑ <b>type:</b> {{ n.type|default:"‚Äî" }}</div>
                      <div class="mt-1 whitespace-pre-line">{{ n.text_head }}</div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if form.import_contacts.value and result.contacts_preview %}
              <div class="text-sm text-brand-dark/80 mt-4">
                <div class="font-medium">üìá –ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π ‚Äî –æ—Ç–ª–∞–¥–∫–∞ (dry-run)</div>
                <div class="text-xs text-gray-600 mb-2">
                  –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–∞—á–∫–∏. 
                  {% if not form.import_contacts.value %}
                    <span class="text-orange-600 font-medium">‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤—ã–∫–ª—é—á–µ–Ω ‚Äî –≤–∫–ª—é—á–∏—Ç–µ –æ–ø—Ü–∏—é –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞.</span>
                  {% endif %}
                </div>
                <div class="space-y-2 mt-2">
                  {% for c in result.contacts_preview %}
                    <div class="rounded-lg border p-3 text-xs {% if c.status == 'NO_CONTACTS_FOUND' or c.status == 'SKIPPED_NO_COMPANY_LINK' or c.status == 'SKIPPED_NO_LOCAL_COMPANY' %}bg-red-50{% elif c.status == 'INFO' %}bg-yellow-50{% endif %}">
                      {% if c.status == 'INFO' %}
                        <div class="font-medium mb-2 text-yellow-700">‚ÑπÔ∏è {{ c.message }}</div>
                        {% if c.companies_count %}
                          <div class="text-xs">–ö–æ–º–ø–∞–Ω–∏–π –≤ –ø–∞—á–∫–µ: {{ c.companies_count }}</div>
                        {% endif %}
                      {% elif c.status == 'NO_CONTACTS_FOUND' %}
                        <div class="font-medium mb-2 text-red-600">‚ö†Ô∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                        <div class="space-y-1">
                          <div><b>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π:</b> {{ c.companies_checked }}</div>
                          <div><b>ID –∫–æ–º–ø–∞–Ω–∏–π:</b> {{ c.company_ids|join:", " }}</div>
                          <div class="text-xs muted-2 mt-1">{{ c.message }}</div>
                        </div>
                      {% elif c.status == 'SKIPPED_NO_COMPANY_LINK' %}
                        <div class="font-medium mb-2 text-orange-600">‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω: –Ω–µ—Ç —Å–≤—è–∑–∏ —Å –∫–æ–º–ø–∞–Ω–∏–µ–π</div>
                        <div class="space-y-1">
                          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                          <div><b>company_id –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ:</b> {{ c.company_id_in_contact|default:"‚Äî" }}</div>
                          <div><b>–í—Ö–æ–¥–∏—Ç –≤ amo_ids_set:</b> {{ c.company_id_in_amo_ids_set|yesno:"–î–∞,–ù–µ—Ç" }}</div>
                          <div><b>–ï—Å—Ç—å company_id:</b> {{ c.has_company_id|yesno:"–î–∞,–ù–µ—Ç" }}</div>
                          <div><b>–ï—Å—Ç—å _embedded.companies:</b> {{ c.has_embedded_companies|yesno:"–î–∞,–ù–µ—Ç" }}</div>
                          <div class="text-xs muted-2 mt-1"><b>–ö–ª—é—á–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞:</b> {{ c.raw_contact_keys|join:", " }}</div>
                        </div>
                      {% elif c.status == 'SKIPPED_NO_LOCAL_COMPANY' %}
                        <div class="font-medium mb-2 text-orange-600">‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω: –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>
                        <div class="space-y-1">
                          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                          <div><b>ID –∫–æ–º–ø–∞–Ω–∏–π –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ:</b> {{ c.company_ids_in_contact|join:", "|default:"‚Äî" }}</div>
                        </div>
                      {% elif c.status == 'UPDATED' or c.status == 'CREATED' %}
                        <div class="font-medium mb-2 {% if c.status == 'CREATED' %}text-green-600{% else %}text-blue-600{% endif %}">
                          {% if c.status == 'CREATED' %}‚úÖ –°–æ–∑–¥–∞–Ω: –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç{% else %}‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω: –∫–æ–Ω—Ç–∞–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏{% endif %}
                        </div>
                        <div class="space-y-2">
                          <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }}</div>
                            <div><b>amo id:</b> {{ c.amo_contact_id }}</div>
                            {% if c.company_name %}
                              <div><b>–ö–æ–º–ø–∞–Ω–∏—è:</b> {{ c.company_name }}{% if c.company_id %} (ID: {{ c.company_id }}){% endif %}</div>
                            {% endif %}
                          </div>
                          
                          <div class="border-t pt-2">
                            <div class="font-medium text-xs mb-1">üìû –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—á—Ç–æ –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ):</div>
                            <div class="space-y-1 text-xs">
                              <div><b>–¢–µ–ª–µ—Ñ–æ–Ω—ã:</b> 
                                {% if c.extracted_phones %}
                                  {% for p in c.extracted_phones %}
                                    <span class="inline-block bg-blue-100 px-2 py-0.5 rounded mr-1">{{ p.value }} ({{ p.type }}){% if p.comment %} ‚Äî {{ p.comment }}{% endif %}</span>
                                  {% endfor %}
                                {% else %}‚Äî{% endif %}
                              </div>
                              <div><b>Email:</b> 
                                {% if c.extracted_emails %}
                                  {% for e in c.extracted_emails %}
                                    <span class="inline-block bg-green-100 px-2 py-0.5 rounded mr-1">{{ e.value }} ({{ e.type }})</span>
                                  {% endfor %}
                                {% else %}‚Äî{% endif %}
                              </div>
                              <div><b>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</b> {{ c.extracted_position|default:"‚Äî" }}</div>
                              <div><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> {{ c.extracted_note_text|default:"‚Äî"|truncatewords:30 }}</div>
                              {% if c.extracted_cold_call %}
                                <div><b>–•–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫:</b> {{ c.extracted_cold_call }}</div>
                              {% endif %}
                            </div>
                          </div>
                          
                          {% if c.all_custom_fields %}
                            <div class="border-t pt-2">
                              <div class="font-medium text-xs mb-1">üìã –í–°–ï –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è ({{ c.custom_fields_count|default:0 }}):</div>
                              <div class="space-y-2 mt-1 max-h-96 overflow-y-auto">
                                {% for cf in c.all_custom_fields %}
                                  <div class="text-xs p-2 rounded border {% if cf.is_used %}bg-green-50 border-green-300{% else %}bg-gray-50{% endif %}">
                                    <div class="font-medium flex items-center gap-2">
                                      {% if cf.is_used %}<span class="text-green-600">‚úì</span>{% endif %}
                                      <span><b>ID:</b> {{ cf.field_id|default:"‚Äî" }}</span>
                                      <span><b>code:</b> {{ cf.field_code|default:"‚Äî" }}</span>
                                      <span><b>type:</b> {{ cf.field_type|default:"‚Äî" }}</span>
                                    </div>
                                    <div class="mt-1"><b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {{ cf.field_name|default:"‚Äî" }}</div>
                                    <div class="mt-1"><b>–ó–Ω–∞—á–µ–Ω–∏–π:</b> {{ cf.values_count|default:0 }}</div>
                                    {% if cf.values %}
                                      <div class="mt-1 pl-2 border-l-2 space-y-1">
                                        {% for val in cf.values %}
                                          <div class="text-xs">
                                            ‚Ä¢ <b>value:</b> {{ val.value|default:"‚Äî"|truncatewords:15 }}
                                            {% if val.enum_code %}<span class="text-gray-600">(enum_code: {{ val.enum_code }})</span>{% endif %}
                                            {% if val.enum_id %}<span class="text-gray-600">(enum_id: {{ val.enum_id }})</span>{% endif %}
                                          </div>
                                        {% endfor %}
                                      </div>
                                    {% endif %}
                                  </div>
                                {% endfor %}
                              </div>
                            </div>
                          {% endif %}
                          
                          {% if c.embedded_tags or c.embedded_companies or c.embedded_leads or c.embedded_customers or c.embedded_notes %}
                            <div class="border-t pt-2">
                              <div class="font-medium text-xs mb-1">üîó –í–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (_embedded):</div>
                              <div class="space-y-1 text-xs">
                                {% if c.embedded_tags %}
                                  <div><b>–¢–µ–≥–∏:</b> {% for tag in c.embedded_tags %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                                {% endif %}
                                {% if c.embedded_companies %}
                                  <div><b>–ö–æ–º–ø–∞–Ω–∏–∏:</b> {% for comp in c.embedded_companies %}ID: {{ comp.id }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                                {% endif %}
                                {% if c.embedded_leads %}
                                  <div><b>–°–¥–µ–ª–∫–∏:</b> {% for lead in c.embedded_leads %}ID: {{ lead.id }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                                {% endif %}
                                {% if c.embedded_customers %}
                                  <div><b>–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏:</b> {% for cust in c.embedded_customers %}ID: {{ cust.id }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                                {% endif %}
                                {% if c.embedded_notes %}
                                  <div><b>–ó–∞–º–µ—Ç–∫–∏:</b> {{ c.embedded_notes_count|default:0 }} —à—Ç.
                                    {% for note in c.embedded_notes|slice:":3" %}
                                      <div class="pl-2 text-xs text-gray-600">‚Ä¢ type: {{ note.note_type|default:"‚Äî" }}, text: {{ note.text|default:"‚Äî"|truncatewords:10 }}</div>
                                    {% endfor %}
                                  </div>
                                {% endif %}
                              </div>
                            </div>
                          {% endif %}
                          
                          {% if c.standard_fields %}
                            <div class="border-t pt-2">
                              <div class="font-medium text-xs mb-1">üìù –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è:</div>
                              <div class="text-xs space-y-0.5">
                                {% for key, value in c.standard_fields.items %}
                                  <div><b>{{ key }}:</b> {{ value|default:"‚Äî" }}</div>
                                {% endfor %}
                              </div>
                            </div>
                          {% endif %}
                          
                          {% if c.note_search_info %}
                            <div class="border-t pt-2">
                              <div class="text-xs muted-2"><b>–ì–¥–µ –∏—Å–∫–∞–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è:</b> {{ c.note_search_info|join:", " }}</div>
                            </div>
                          {% endif %}
                          
                          {% if c.full_structure %}
                            <details class="border-t pt-2">
                              <summary class="font-medium text-xs cursor-pointer">üîç –ü–æ–ª–Ω–∞—è JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞</summary>
                              <pre class="text-xs mt-2 p-2 bg-gray-100 rounded overflow-auto max-h-64">{{ c.full_structure }}</pre>
                            </details>
                          {% endif %}
                        </div>
                      {% else %}
                        <div class="font-medium mb-2">{{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                        <div class="space-y-1">
                          <div><b>–¢–µ–ª–µ—Ñ–æ–Ω—ã –Ω–∞–π–¥–µ–Ω—ã:</b> {% if c.phones_found %}{{ c.phones_found|join:", " }}{% else %}‚Äî{% endif %}</div>
                          <div><b>Email –Ω–∞–π–¥–µ–Ω—ã:</b> {% if c.emails_found %}{{ c.emails_found|join:", " }}{% else %}‚Äî{% endif %}</div>
                          <div><b>–î–æ–ª–∂–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–∞:</b> {{ c.position_found|default:"‚Äî" }}</div>
                          <div><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ:</b> {{ c.note_text_found|default:"‚Äî"|truncatewords:30 }}</div>
                          {% if c.note_search_info %}
                            <div class="text-xs muted-2"><b>–ì–¥–µ –∏—Å–∫–∞–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è:</b> {{ c.note_search_info|join:", " }}</div>
                          {% endif %}
                          <div><b>custom_fields_values:</b> {{ c.custom_fields_count|default:0 }} –ø–æ–ª–µ–π</div>
                          {% if c.all_custom_fields %}
                            <div class="mt-2">
                              <b>–ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è ({{ c.custom_fields_count|default:0 }}):</b>
                              <div class="space-y-1 mt-1 pl-2 border-l-2">
                                {% for cf in c.all_custom_fields %}
                                  <div class="text-xs p-2 rounded border {% if cf.is_used %}bg-green-50 border-green-300{% else %}bg-gray-50{% endif %}">
                                    <div class="font-medium flex items-center gap-2">
                                      {% if cf.is_used %}<span class="text-green-600">‚úì</span>{% endif %}
                                      <span><b>ID:</b> {{ cf.field_id|default:"‚Äî" }}</span>
                                      <span><b>code:</b> {{ cf.field_code|default:"‚Äî" }}</span>
                                      <span><b>type:</b> {{ cf.field_type|default:"‚Äî" }}</span>
                                    </div>
                                    <div class="mt-1"><b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {{ cf.field_name|default:"‚Äî" }}</div>
                                    <div class="mt-1"><b>–ó–Ω–∞—á–µ–Ω–∏–π:</b> {{ cf.values_count|default:0 }}</div>
                                    {% if cf.values %}
                                      <div class="mt-1 pl-2 border-l-2 space-y-1">
                                        {% for val in cf.values %}
                                          <div class="text-xs">
                                            ‚Ä¢ <b>value:</b> {{ val.value|default:"‚Äî"|truncatewords:15 }}
                                            {% if val.enum_code %}<span class="text-gray-600">(enum_code: {{ val.enum_code }})</span>{% endif %}
                                            {% if val.enum_id %}<span class="text-gray-600">(enum_id: {{ val.enum_id }})</span>{% endif %}
                                          </div>
                                        {% endfor %}
                                      </div>
                                    {% endif %}
                                  </div>
                                {% endfor %}
                              </div>
                            </div>
                          {% elif c.custom_fields_sample %}
                            <div class="mt-2">
                              <b>–ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è ({{ c.custom_fields_count|default:0 }}):</b>
                              <div class="space-y-1 mt-1 pl-2 border-l-2">
                                {% for cf in c.custom_fields_sample %}
                                  <div class="text-xs {% if cf.all_values %}bg-blue-50 p-2 rounded border{% endif %}">
                                    <div class="font-medium">
                                      [{{ cf.index }}] <b>ID:</b> {{ cf.field_id|default:"‚Äî" }}, 
                                      <b>code:</b> {{ cf.code|default:"‚Äî" }}, 
                                      <b>name:</b> {{ cf.name|default:"‚Äî" }}, 
                                      <b>type:</b> {{ cf.type|default:"‚Äî" }}
                                    </div>
                                    <div class="mt-1">
                                      <b>–ó–Ω–∞—á–µ–Ω–∏–π:</b> {{ cf.values_count }}
                                      {% if cf.all_values %}
                                        <div class="mt-1 pl-2 border-l-2">
                                          {% for val in cf.all_values %}
                                            <div>‚Ä¢ {{ val|truncatewords:20 }}</div>
                                          {% endfor %}
                                        </div>
                                      {% elif cf.first_value %}
                                        <div class="mt-1 pl-2 border-l-2">‚Ä¢ {{ cf.first_value|truncatewords:20 }}</div>
                                      {% endif %}
                                    </div>
                                  </div>
                                {% endfor %}
                              </div>
                            </div>
                          {% else %}
                            <div class="mt-1 text-xs text-orange-600">‚ö†Ô∏è custom_fields_sample –ø—É—Å—Ç (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö)</div>
                          {% endif %}
                          <div class="mt-1 text-xs muted-2">
                            <b>–ö–ª—é—á–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞:</b> {{ c.raw_contact_keys|join:", "|default:"‚Äî" }}
                          </div>
                          <div class="mt-1 text-xs muted-2">
                            <b>has_phone_field:</b> {{ c.has_phone_field|yesno:"–î–∞,–ù–µ—Ç" }}, 
                            <b>has_email_field:</b> {{ c.has_email_field|yesno:"–î–∞,–ù–µ—Ç" }}
                          </div>
                          {% if c.full_structure %}
                            <div class="mt-2 p-2 bg-gray-50 rounded text-xs font-mono overflow-auto max-h-60">
                              <b>–ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (JSON):</b>
                              <pre class="whitespace-pre-wrap break-words">{{ c.full_structure }}</pre>
                            </div>
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {% if result.companies_has_more and not form.dry_run.value %}
          <div class="mt-4 border-t pt-4">
            <div id="auto-continue-status" class="mb-3 rounded-xl border border-brand-blue/60 bg-brand-blue/20 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-brand-dark">
                  <b>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ:</b> —Å–ª–µ–¥—É—é—â–∞—è –ø–∞—á–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —á–µ—Ä–µ–∑ <span id="countdown">5</span> —Å–µ–∫.
                  <span class="text-xs muted-2 block mt-1">
                    –ü—Ä–æ–≥—Ä–µ—Å—Å: {{ result.companies_next_offset }} / {{ result.companies_matched }} –∫–æ–º–ø–∞–Ω–∏–π
                  </span>
                </div>
                <button id="stop-auto-continue" class="btn btn-outline text-sm" type="button">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
              </div>
            </div>
            <form id="continue-form" method="post" class="flex flex-wrap gap-2 items-center">
              {% csrf_token %}
              <input type="hidden" name="dry_run" value="" />
              <input type="hidden" name="limit_companies" value="{{ form.limit_companies.value|default:10 }}" />
              <input type="hidden" name="offset" value="{{ result.companies_next_offset }}" />
              <input type="hidden" name="responsible_user_id" value="{{ migrate_responsible_user_id|default:form.responsible_user_id.value }}" />
              <input type="hidden" name="custom_field_id" value="{{ form.custom_field_id.value }}" />
              <input type="hidden" name="custom_value_label" value="{{ form.custom_value_label.value }}" />
              <input type="hidden" name="custom_value_enum_id" value="{{ form.custom_value_enum_id.value }}" />
              {% if form.migrate_all_companies.value %}<input type="hidden" name="migrate_all_companies" value="on" />{% endif %}
              {% if form.import_tasks.value %}<input type="hidden" name="import_tasks" value="on" />{% endif %}
              {% if form.import_notes.value %}<input type="hidden" name="import_notes" value="on" />{% endif %}
              {% if form.import_contacts.value %}<input type="hidden" name="import_contacts" value="on" />{% endif %}
              <button class="btn btn-primary" type="submit">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å (—Å–ª–µ–¥—É—é—â–∞—è –ø–∞—á–∫–∞)</button>
              <span class="text-xs muted-2">–°–ª–µ–¥—É—é—â–∏–π offset: {{ result.companies_next_offset }}</span>
            </form>
          </div>
          <script>
            (function() {
              // –°–∫—Ä–æ–ª–ª –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
              const resultCard = document.querySelector('.card.card-pad');
              if (resultCard) {
                setTimeout(function() {
                  resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
              }
              
              // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
              let countdown = 5;
              let autoContinue = true;
              const countdownEl = document.getElementById('countdown');
              const statusEl = document.getElementById('auto-continue-status');
              const stopBtn = document.getElementById('stop-auto-continue');
              const form = document.getElementById('continue-form');
              
              if (!countdownEl || !statusEl || !stopBtn || !form) return;
              
              stopBtn.addEventListener('click', function() {
                autoContinue = false;
                statusEl.innerHTML = '<div class="text-sm text-brand-dark">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –≤—Ä—É—á–Ω—É—é.</div>';
              });
              
              const timer = setInterval(function() {
                if (!autoContinue) {
                  clearInterval(timer);
                  return;
                }
                countdown--;
                if (countdownEl) {
                  countdownEl.textContent = countdown;
                }
                if (countdown <= 0) {
                  clearInterval(timer);
                  if (autoContinue) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    statusEl.innerHTML = '<div class="text-sm text-brand-dark">–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è –ø–∞—á–∫–∞...</div>';
                    form.submit();
                  }
                }
              }, 1000);
            })();
          </script>
        {% endif %}
      </div>
    {% endif %}

  </div>

  <script>
    (function() {
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–µ–∫–±–æ–∫—Å–∞
      const migrateAllCheckbox = document.getElementById('migrate_all_checkbox');
      const customFieldContainer = document.getElementById('custom_field_container');
      const customFieldSelect = document.getElementById('custom_field_select');
      
      function updateCustomFieldVisibility() {
        if (migrateAllCheckbox && customFieldContainer && customFieldSelect) {
          if (migrateAllCheckbox.checked) {
            customFieldContainer.style.opacity = '0.5';
            customFieldSelect.removeAttribute('required');
          } else {
            customFieldContainer.style.opacity = '1';
            customFieldSelect.setAttribute('required', 'required');
          }
        }
      }
      
      if (migrateAllCheckbox) {
        migrateAllCheckbox.addEventListener('change', updateCustomFieldVisibility);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateCustomFieldVisibility();
      }
      
      // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã (–Ω–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç)
      const migrateForm = document.getElementById('migrate-form');
      const resultContainer = document.getElementById('result-container');
      
      if (migrateForm && resultContainer) {
        migrateForm.addEventListener('submit', function(e) {
          const offsetInput = migrateForm.querySelector('input[name="offset"]');
          const offsetValue = offsetInput ? offsetInput.value : '0';
          if (offsetValue === '0' || offsetValue === '') {
            resultContainer.style.display = 'none';
          }
        });
      }

      // –ü—Ä–æ–≥—Ä–µ—Å—Å –∏–º–ø–æ—Ä—Ç–∞: –æ–ø—Ä–æ—Å, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å¬ª –ø—Ä–∏ active_run, —Å–±—Ä–æ—Å –ø—Ä–∏ active_run: null.
      // Polling –Ω–∞ –∫–∞–∂–¥—ã–π onload; –ø–æ—Å–ª–µ POST (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞) ‚Äî —Å–Ω–æ–≤–∞ onload.
      (function() {
        var statusEl = document.getElementById('import-running-status');
        var btn = document.getElementById('migrate-start-btn');
        var form = document.getElementById('migrate-form');
        if (!statusEl || !btn || !form) return;
        var progressUrl = form.getAttribute('data-progress-url');
        if (!progressUrl) return;
        var pollTimer = null;
        var RUNNING_HTML = '<b>–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.</b> –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –ö–Ω–æ–ø–∫–∞ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å¬ª –±—É–¥–µ—Ç —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è.';
        var RUNNING_CLASS = 'rounded-xl border border-amber-500/60 bg-amber-500/20 px-4 py-3 text-sm text-amber-800 mb-2';

        function setRunning(active) {
          if (active) {
            statusEl.innerHTML = RUNNING_HTML;
            statusEl.className = RUNNING_CLASS;
            statusEl.classList.remove('hidden');
            btn.disabled = true;
          } else {
            statusEl.classList.add('hidden');
            btn.disabled = false;
          }
        }

        function showCompleted() {
          statusEl.className = 'rounded-xl border border-green-500/60 bg-green-500/20 px-4 py-3 text-sm text-green-800 mb-2';
          statusEl.innerHTML = '<b>–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω.</b> –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π.';
          statusEl.classList.remove('hidden');
          btn.disabled = false;
          setTimeout(function() {
            statusEl.innerHTML = RUNNING_HTML;
            statusEl.className = RUNNING_CLASS;
            statusEl.classList.add('hidden');
          }, 2500);
        }

        function check() {
          fetch(progressUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function(r) { return r.json(); })
            .then(function(d) {
              if (d && d.active_run) {
                setRunning(true);
                if (!pollTimer) pollTimer = setInterval(check, 3000);
              } else {
                if (pollTimer) {
                  clearInterval(pollTimer);
                  pollTimer = null;
                  showCompleted();
                } else {
                  setRunning(false);
                }
              }
            })
            .catch(function() {
              if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
              setRunning(false);
            });
        }

        check();
      })();
    })();
  </script>
{% endblock %}


