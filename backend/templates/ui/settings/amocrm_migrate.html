{% extends "ui/base.html" %}
{% block title %}amoCRM ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm text-brand-dark/70"><a class="underline" href="/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> / <a class="underline" href="/settings/amocrm/">amoCRM</a> /</div>
      <h1 class="text-2xl font-semibold">–ú–∏–≥—Ä–∞—Ü–∏—è –∏–∑ amoCRM</h1>
      <div class="text-sm text-brand-dark/70">
        –ú–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É –ø–æ–ª—é (–Ω–∞–ø—Ä–∏–º–µ—Ä "–°—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"/"–°—Ç–∞—Ç—É—Å—ã") —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º "–ù–æ–≤–∞—è CRM".
      </div>
      <div class="mt-2 rounded-xl border border-brand-orange/60 bg-brand-orange/20 px-4 py-2 text-sm text-brand-dark">
        –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–Ω–∞—á–∞–ª–∞ <b>dry-run</b> –Ω–∞ –ª–∏–º–∏—Ç–µ 50‚Äì100, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–∫–æ–ª—å–∫–æ –∫–æ–º–ø–∞–Ω–∏–π/–∑–∞–¥–∞—á/–∑–∞–º–µ—Ç–æ–∫ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ.
      </div>
      <div class="mt-2 rounded-xl border border-red-500/60 bg-red-500/20 px-4 py-2 text-sm text-brand-dark">
        <b>‚ö†Ô∏è –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ 504 Gateway Time-out:</b> —É–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç nginx –¥–ª—è —ç—Ç–æ–≥–æ endpoint (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –Ω–∏–∂–µ) –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –ø–∞—á–∫–∏ –¥–æ 3‚Äì5 –∫–æ–º–ø–∞–Ω–∏–π.
      </div>
    </div>

    <div class="card card-pad space-y-3">
      <form method="post" id="migrate-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        {% csrf_token %}
        <input type="hidden" name="offset" value="{{ form.offset.value|default:0 }}" />

        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="dry_run" value="on" {% if form.dry_run.value %}checked{% endif %} />
            –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (dry-run)
          </label>
        </div>

        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–†–∞–∑–º–µ—Ä –ø–∞—á–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π</label>
          <input class="input" type="number" name="limit_companies" value="{{ form.limit_companies.value|default:10 }}" min="1" max="5000" />
          <div class="text-xs muted-2 mt-1">
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞.
            –ü—Ä–∏ 504 –æ—à–∏–±–∫–µ —É–º–µ–Ω—å—à–∏—Ç–µ –¥–æ 3‚Äì5 –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç nginx.
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm text-brand-dark/80 mb-1">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (amo)</label>
          <select class="select w-full" name="responsible_user_id" required>
            <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
            {% regroup users by branch as branches_list %}
            {% for branch_group in branches_list %}
              {% if branch_group.grouper %}
                <optgroup label="–§–∏–ª–∏–∞–ª: {{ branch_group.grouper.name|default:"–ë–µ–∑ —Ñ–∏–ª–∏–∞–ª–∞" }}">
              {% else %}
                <optgroup label="–§–∏–ª–∏–∞–ª: –ë–µ–∑ —Ñ–∏–ª–∏–∞–ª–∞">
              {% endif %}
                {% for u in branch_group.list %}
                  <option value="{{ u.id }}" {% if form.responsible_user_id.value|stringformat:"s" == u.id|stringformat:"s" %}selected{% endif %}>{{ u.name }} (id={{ u.id }})</option>
                {% endfor %}
              </optgroup>
            {% endfor %}
          </select>
          <div class="text-xs muted-2 mt-1">–ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî —É—Ç–æ—á–Ω–∏—Ç–µ –∏–º—è –≤ amo (–≤ users list).</div>
        </div>

        <div class="md:col-span-2">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="migrate_all_companies" value="on" {% if form.migrate_all_companies.value %}checked{% endif %} id="migrate_all_checkbox" />
            –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ø–æ–ª—é)
          </label>
          <div class="text-xs muted-2 mt-1">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –±—É–¥—É—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É –ø–æ–ª—é.</div>
        </div>

        <div class="md:col-span-2" id="custom_field_container">
          <label class="block text-sm text-brand-dark/80 mb-1">–ö–∞—Å—Ç–æ–º–Ω–æ–µ –ø–æ–ª–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
          <select class="select w-full" name="custom_field_id" id="custom_field_select">
            <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª–µ ‚Äî</option>
            {% for f in fields %}
              <option value="{{ f.id }}" {% if form.custom_field_id.value|stringformat:"s" == f.id|stringformat:"s" %}selected{% endif %}>{{ f.name }} (id={{ f.id }})</option>
            {% endfor %}
          </select>
          <div class="text-xs muted-2 mt-1">–¢—Ä–µ–±—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è "–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ".</div>
        </div>

        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–ó–Ω–∞—á–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç)</label>
          <input class="input" type="text" name="custom_value_label" value="{{ form.custom_value_label.value|default:'–ù–æ–≤–∞—è CRM' }}" placeholder="–ù–æ–≤–∞—è CRM" />
          <div class="text-xs muted-2 mt-1">–û–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–µ–∫—Å—Ç–∞. –ï—Å–ª–∏ –ø–æ–ª–µ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç ‚Äî –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å enum id –Ω–∏–∂–µ.</div>
        </div>
        <div>
          <label class="block text-sm text-brand-dark/80 mb-1">–ó–Ω–∞—á–µ–Ω–∏–µ (enum id, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input class="input" type="number" name="custom_value_enum_id" value="{{ form.custom_value_enum_id.value|default:'' }}" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 123456" />
        </div>

        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="import_tasks" value="on" {% if form.import_tasks.value %}checked{% endif %} />
            –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏
          </label>
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="import_notes" value="on" {% if form.import_notes.value %}checked{% endif %} />
            –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏
          </label>
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-brand-dark/80">
            <input type="checkbox" name="import_contacts" value="on" {% if form.import_contacts.value %}checked{% endif %} />
            –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã
            <span class="text-xs muted-2">(–º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ)</span>
          </label>
        </div>

        <div class="md:col-span-2 flex gap-2">
          <button class="btn btn-primary" type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <a class="btn btn-outline" href="/settings/amocrm/">–ù–∞–∑–∞–¥</a>
        </div>
      </form>
    </div>

    {% if result %}
      <div class="card card-pad" id="result-container">
        <div class="font-medium mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        {% if result.error %}
          <div class="mb-4 rounded-xl border border-red-500/60 bg-red-500/20 px-4 py-3 text-sm text-red-700">
            <div class="font-medium mb-1">‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:</div>
            <div>{{ result.error }}</div>
            {% if result.error_traceback %}
              <details class="mt-2">
                <summary class="cursor-pointer text-xs">–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏</summary>
                <pre class="mt-2 text-xs overflow-auto max-h-60 bg-red-50 p-2 rounded">{{ result.error_traceback }}</pre>
              </details>
            {% endif %}
          </div>
        {% endif %}
        <div class="text-sm text-brand-dark/80">
          –ö–æ–º–ø–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ —É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ: <b>{{ result.companies_seen }}</b>,
          –ø–æ —Ñ–∏–ª—å—Ç—Ä—É: <b>{{ result.companies_matched }}</b>,
          –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —ç—Ç–æ–π –ø–∞—á–∫–µ: <b>{{ result.companies_batch }}</b>,
          –ø—Ä–æ–≥—Ä–µ—Å—Å: <b>{{ result.companies_next_offset }}</b> / <b>{{ result.companies_matched }}</b>
          —Å–æ–∑–¥–∞–Ω–æ: <b>{{ result.companies_created }}</b>,
          –æ–±–Ω–æ–≤–ª–µ–Ω–æ: <b>{{ result.companies_updated }}</b>
        </div>
        <div class="text-sm text-brand-dark/80 mt-2">
          –ó–∞–¥–∞—á: –Ω–∞–π–¥–µ–Ω–æ <b>{{ result.tasks_seen }}</b>, –¥–æ–±–∞–≤–ª–µ–Ω–æ <b>{{ result.tasks_created }}</b>, –ø—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –±—ã–ª–æ) <b>{{ result.tasks_skipped_existing }}</b>{% if result.tasks_skipped_old %}, –ø—Ä–æ–ø—É—â–µ–Ω–æ (—Å—Ç–∞—Ä—ã–µ, –¥–æ 2026 –≥–æ–¥–∞) <b>{{ result.tasks_skipped_old }}</b>{% endif %}
        </div>
        <div class="text-sm text-brand-dark/80 mt-1">
          –ó–∞–º–µ—Ç–æ–∫: –Ω–∞–π–¥–µ–Ω–æ <b>{{ result.notes_seen }}</b>, –¥–æ–±–∞–≤–ª–µ–Ω–æ <b>{{ result.notes_created }}</b>, –ø—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –±—ã–ª–æ) <b>{{ result.notes_skipped_existing }}</b>
        </div>
        {% if form.import_contacts.value %}
          <div class="text-sm text-brand-dark/80 mt-1">
            –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤: –Ω–∞–π–¥–µ–Ω–æ <b>{{ result.contacts_seen|default:0 }}</b>, —Å–æ–∑–¥–∞–Ω–æ <b>{{ result.contacts_created|default:0 }}</b>
          </div>
        {% endif %}

        {% if result.preview %}
          <div class="mt-3">
            <div class="text-sm text-brand-dark/70 mb-2">–ü—Ä–µ–≤—å—é –∫–æ–º–ø–∞–Ω–∏–π</div>
            <div class="space-y-2 text-sm">
              {% for p in result.preview %}
                <div class="rounded-lg border p-3">
                  <div class="font-medium">{{ p.company }}</div>
                  <div class="text-xs muted-2 mt-1">amo id: {{ p.amo_id }}</div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if form.dry_run.value and result.companies_updates_preview %}
          <div class="mt-4 border-t pt-4">
            <div class="font-medium mb-3">–ß—Ç–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ</div>
            <div class="space-y-3 text-sm">
              {% for update in result.companies_updates_preview %}
                <div class="rounded-lg border p-4 {% if update.is_new %}bg-green-50 border-green-200{% else %}bg-blue-50 border-blue-200{% endif %}">
                  <div class="font-medium mb-2 flex items-center gap-2">
                    {% if update.is_new %}
                      <span class="text-green-600">üÜï</span>
                      <span>–ù–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è: {{ update.company_name }}</span>
                    {% else %}
                      <span class="text-blue-600">üîÑ</span>
                      <span>{{ update.company_name }}</span>
                    {% endif %}
                    {% if update.company_id %}
                      <span class="text-xs muted-2">(ID: {{ update.company_id }})</span>
                    {% endif %}
                    <span class="text-xs muted-2">(amo id: {{ update.amo_id }})</span>
                  </div>
                  {% if update.updates %}
                    <div class="space-y-2 mt-3">
                      {% for field_name, diff in update.updates.items %}
                        <div class="bg-white rounded border p-2">
                          <div class="font-medium text-xs mb-1">
                            {% if field_name == "legal_name" %}–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                            {% elif field_name == "inn" %}–ò–ù–ù
                            {% elif field_name == "kpp" %}–ö–ü–ü
                            {% elif field_name == "address" %}–ê–¥—Ä–µ—Å
                            {% elif field_name == "phone" %}–¢–µ–ª–µ—Ñ–æ–Ω
                            {% elif field_name == "email" %}Email
                            {% elif field_name == "website" %}–°–∞–π—Ç
                            {% elif field_name == "contact_name" %}–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å
                            {% elif field_name == "activity_kind" %}–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                            {% elif field_name == "employees_count" %}–ß–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                            {% elif field_name == "workday_start" %}–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
                            {% elif field_name == "workday_end" %}–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
                            {% elif field_name == "work_timezone" %}–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                            {% else %}{{ field_name }}{% endif %}
                          </div>
                          <div class="flex gap-3 text-xs">
                            <div class="flex-1">
                              <div class="text-red-600 font-medium mb-1">–ë—ã–ª–æ:</div>
                              <div class="bg-red-50 p-2 rounded border border-red-200 break-words">
                                {{ diff.old|default:"‚Äî"|truncatewords:30 }}
                              </div>
                            </div>
                            <div class="flex-1">
                              <div class="text-green-600 font-medium mb-1">–ë—É–¥–µ—Ç:</div>
                              <div class="bg-green-50 p-2 rounded border border-green-200 break-words">
                                {{ diff.new|default:"‚Äî"|truncatewords:30 }}
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if form.dry_run.value %}
          <div class="mt-4 border-t pt-4">
            <div class="font-medium mb-2">Debug (dry-run)</div>
            {% if result.tasks_preview %}
              <div class="text-sm text-brand-dark/80">
                <div class="font-medium">–ó–∞–¥–∞—á–∏ (–ø–µ—Ä–≤—ã–µ 5)</div>
                <div class="space-y-2 mt-2">
                  {% for t in result.tasks_preview %}
                    <div class="rounded-lg border p-3 text-xs">
                      <div><b>id:</b> {{ t.id }} ¬∑ <b>raw_ts:</b> {{ t.raw_ts }} ¬∑ <b>parsed:</b> {{ t.parsed_due|default:"‚Äî" }}</div>
                      <div class="muted-2 mt-1"><b>keys:</b> {{ t.keys }}</div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if result.notes_preview %}
              <div class="text-sm text-brand-dark/80 mt-4">
                <div class="font-medium">–ó–∞–º–µ—Ç–∫–∏ (–ø–µ—Ä–≤—ã–µ 5)</div>
                <div class="space-y-2 mt-2">
                  {% for n in result.notes_preview %}
                    <div class="rounded-lg border p-3 text-xs">
                      <div><b>id:</b> {{ n.id }} ¬∑ <b>type:</b> {{ n.type|default:"‚Äî" }}</div>
                      <div class="mt-1 whitespace-pre-line">{{ n.text_head }}</div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if result.contacts_preview %}
              <div class="text-sm text-brand-dark/80 mt-4">
                <div class="font-medium">–ö–æ–Ω—Ç–∞–∫—Ç—ã ‚Äî –æ—Ç–ª–∞–¥–∫–∞</div>
                <div class="space-y-2 mt-2">
                  {% for c in result.contacts_preview %}
                    <div class="rounded-lg border p-3 text-xs {% if c.status == 'NO_CONTACTS_FOUND' or c.status == 'SKIPPED_NO_COMPANY_LINK' or c.status == 'SKIPPED_NO_LOCAL_COMPANY' %}bg-red-50{% endif %}">
                      {% if c.status == 'NO_CONTACTS_FOUND' %}
                        <div class="font-medium mb-2 text-red-600">‚ö†Ô∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                        <div class="space-y-1">
                          <div><b>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π:</b> {{ c.companies_checked }}</div>
                          <div><b>ID –∫–æ–º–ø–∞–Ω–∏–π:</b> {{ c.company_ids|join:", " }}</div>
                          <div class="text-xs muted-2 mt-1">{{ c.message }}</div>
                        </div>
                      {% elif c.status == 'SKIPPED_NO_COMPANY_LINK' %}
                        <div class="font-medium mb-2 text-orange-600">‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω: –Ω–µ—Ç —Å–≤—è–∑–∏ —Å –∫–æ–º–ø–∞–Ω–∏–µ–π</div>
                        <div class="space-y-1">
                          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                          <div><b>company_id –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ:</b> {{ c.company_id_in_contact|default:"‚Äî" }}</div>
                          <div><b>–í—Ö–æ–¥–∏—Ç –≤ amo_ids_set:</b> {{ c.company_id_in_amo_ids_set|yesno:"–î–∞,–ù–µ—Ç" }}</div>
                          <div><b>–ï—Å—Ç—å company_id:</b> {{ c.has_company_id|yesno:"–î–∞,–ù–µ—Ç" }}</div>
                          <div><b>–ï—Å—Ç—å _embedded.companies:</b> {{ c.has_embedded_companies|yesno:"–î–∞,–ù–µ—Ç" }}</div>
                          <div class="text-xs muted-2 mt-1"><b>–ö–ª—é—á–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞:</b> {{ c.raw_contact_keys|join:", " }}</div>
                        </div>
                      {% elif c.status == 'SKIPPED_NO_LOCAL_COMPANY' %}
                        <div class="font-medium mb-2 text-orange-600">‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω: –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>
                        <div class="space-y-1">
                          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                          <div><b>ID –∫–æ–º–ø–∞–Ω–∏–π –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ:</b> {{ c.company_ids_in_contact|join:", "|default:"‚Äî" }}</div>
                        </div>
                      {% elif c.status == 'UPDATED' %}
                        <div class="font-medium mb-2 text-blue-600">‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω: –∫–æ–Ω—Ç–∞–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</div>
                        <div class="space-y-1">
                          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                          <div><b>–¢–µ–ª–µ—Ñ–æ–Ω—ã –Ω–∞–π–¥–µ–Ω—ã:</b> {% if c.phones_found %}{{ c.phones_found|join:", " }}{% else %}‚Äî{% endif %}</div>
                          <div><b>Email –Ω–∞–π–¥–µ–Ω—ã:</b> {% if c.emails_found %}{{ c.emails_found|join:", " }}{% else %}‚Äî{% endif %}</div>
                          <div><b>–î–æ–ª–∂–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–∞:</b> {{ c.position_found|default:"‚Äî" }}</div>
                          <div><b>custom_fields_values:</b> {{ c.custom_fields_count|default:0 }} –ø–æ–ª–µ–π</div>
                          {% if c.custom_fields_sample %}
                            <div class="mt-2">
                              <b>–ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–µ–π (–ø–µ—Ä–≤—ã–µ 5):</b>
                              <div class="space-y-1 mt-1 pl-2 border-l-2">
                                {% for cf in c.custom_fields_sample %}
                                  <div class="text-xs">
                                    [{{ cf.index }}] <b>code:</b> {{ cf.code|default:"‚Äî" }}, 
                                    <b>name:</b> {{ cf.name|default:"‚Äî" }}, 
                                    <b>type:</b> {{ cf.type|default:"‚Äî" }}, 
                                    <b>values:</b> {{ cf.values_count }}, 
                                    <b>first_value:</b> {{ cf.first_value|default:"‚Äî"|truncatewords:15 }}
                                  </div>
                                {% endfor %}
                              </div>
                            </div>
                          {% endif %}
                        </div>
                      {% elif c.status == 'CREATED' %}
                        <div class="font-medium mb-2 text-green-600">‚úÖ –°–æ–∑–¥–∞–Ω: –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</div>
                        <div class="space-y-1">
                          <div><b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                          <div><b>–¢–µ–ª–µ—Ñ–æ–Ω—ã –Ω–∞–π–¥–µ–Ω—ã:</b> {% if c.phones_found %}{{ c.phones_found|join:", " }}{% else %}‚Äî{% endif %}</div>
                          <div><b>Email –Ω–∞–π–¥–µ–Ω—ã:</b> {% if c.emails_found %}{{ c.emails_found|join:", " }}{% else %}‚Äî{% endif %}</div>
                          <div><b>–î–æ–ª–∂–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–∞:</b> {{ c.position_found|default:"‚Äî" }}</div>
                          <div><b>custom_fields_values:</b> {{ c.custom_fields_count|default:0 }} –ø–æ–ª–µ–π</div>
                          {% if c.custom_fields_sample %}
                            <div class="mt-2">
                              <b>–ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–µ–π (–ø–µ—Ä–≤—ã–µ 5):</b>
                              <div class="space-y-1 mt-1 pl-2 border-l-2">
                                {% for cf in c.custom_fields_sample %}
                                  <div class="text-xs">
                                    [{{ cf.index }}] <b>code:</b> {{ cf.code|default:"‚Äî" }}, 
                                    <b>name:</b> {{ cf.name|default:"‚Äî" }}, 
                                    <b>type:</b> {{ cf.type|default:"‚Äî" }}, 
                                    <b>values:</b> {{ cf.values_count }}, 
                                    <b>first_value:</b> {{ cf.first_value|default:"‚Äî"|truncatewords:15 }}
                                  </div>
                                {% endfor %}
                              </div>
                            </div>
                          {% endif %}
                        </div>
                      {% else %}
                        <div class="font-medium mb-2">{{ c.last_name }} {{ c.first_name }} (amo id: {{ c.amo_contact_id }})</div>
                        <div class="space-y-1">
                          <div><b>–¢–µ–ª–µ—Ñ–æ–Ω—ã –Ω–∞–π–¥–µ–Ω—ã:</b> {% if c.phones_found %}{{ c.phones_found|join:", " }}{% else %}‚Äî{% endif %}</div>
                          <div><b>Email –Ω–∞–π–¥–µ–Ω—ã:</b> {% if c.emails_found %}{{ c.emails_found|join:", " }}{% else %}‚Äî{% endif %}</div>
                          <div><b>–î–æ–ª–∂–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–∞:</b> {{ c.position_found|default:"‚Äî" }}</div>
                          <div><b>custom_fields_values:</b> {{ c.custom_fields_count|default:0 }} –ø–æ–ª–µ–π</div>
                          {% if c.custom_fields_sample %}
                            <div class="mt-2">
                              <b>–ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–µ–π (–ø–µ—Ä–≤—ã–µ 5):</b>
                              <div class="space-y-1 mt-1 pl-2 border-l-2">
                                {% for cf in c.custom_fields_sample %}
                                  <div class="text-xs">
                                    [{{ cf.index }}] <b>code:</b> {{ cf.code|default:"‚Äî" }}, 
                                    <b>name:</b> {{ cf.name|default:"‚Äî" }}, 
                                    <b>type:</b> {{ cf.type|default:"‚Äî" }}, 
                                    <b>values:</b> {{ cf.values_count }}, 
                                    <b>first_value:</b> {{ cf.first_value|default:"‚Äî"|truncatewords:15 }}
                                  </div>
                                {% endfor %}
                              </div>
                            </div>
                          {% else %}
                            <div class="mt-1 text-xs text-orange-600">‚ö†Ô∏è custom_fields_sample –ø—É—Å—Ç (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö)</div>
                          {% endif %}
                          <div class="mt-1 text-xs muted-2">
                            <b>–ö–ª—é—á–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞:</b> {{ c.raw_contact_keys|join:", "|default:"‚Äî" }}
                          </div>
                          <div class="mt-1 text-xs muted-2">
                            <b>has_phone_field:</b> {{ c.has_phone_field|yesno:"–î–∞,–ù–µ—Ç" }}, 
                            <b>has_email_field:</b> {{ c.has_email_field|yesno:"–î–∞,–ù–µ—Ç" }}
                          </div>
                          {% if c.full_structure %}
                            <div class="mt-2 p-2 bg-gray-50 rounded text-xs font-mono overflow-auto max-h-60">
                              <b>–ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (JSON):</b>
                              <pre class="whitespace-pre-wrap break-words">{{ c.full_structure }}</pre>
                            </div>
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {% if result.companies_has_more and not form.dry_run.value %}
          <div class="mt-4 border-t pt-4">
            <div id="auto-continue-status" class="mb-3 rounded-xl border border-brand-blue/60 bg-brand-blue/20 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-brand-dark">
                  <b>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ:</b> —Å–ª–µ–¥—É—é—â–∞—è –ø–∞—á–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —á–µ—Ä–µ–∑ <span id="countdown">5</span> —Å–µ–∫.
                  <span class="text-xs muted-2 block mt-1">
                    –ü—Ä–æ–≥—Ä–µ—Å—Å: {{ result.companies_next_offset }} / {{ result.companies_matched }} –∫–æ–º–ø–∞–Ω–∏–π
                  </span>
                </div>
                <button id="stop-auto-continue" class="btn btn-outline text-sm" type="button">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
              </div>
            </div>
            <form id="continue-form" method="post" class="flex flex-wrap gap-2 items-center">
              {% csrf_token %}
              <input type="hidden" name="dry_run" value="" />
              <input type="hidden" name="limit_companies" value="{{ form.limit_companies.value|default:10 }}" />
              <input type="hidden" name="offset" value="{{ result.companies_next_offset }}" />
              <input type="hidden" name="responsible_user_id" value="{{ form.responsible_user_id.value }}" />
              <input type="hidden" name="custom_field_id" value="{{ form.custom_field_id.value }}" />
              <input type="hidden" name="custom_value_label" value="{{ form.custom_value_label.value }}" />
              <input type="hidden" name="custom_value_enum_id" value="{{ form.custom_value_enum_id.value }}" />
              {% if form.migrate_all_companies.value %}<input type="hidden" name="migrate_all_companies" value="on" />{% endif %}
              {% if form.import_tasks.value %}<input type="hidden" name="import_tasks" value="on" />{% endif %}
              {% if form.import_notes.value %}<input type="hidden" name="import_notes" value="on" />{% endif %}
              {% if form.import_contacts.value %}<input type="hidden" name="import_contacts" value="on" />{% endif %}
              <button class="btn btn-primary" type="submit">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å (—Å–ª–µ–¥—É—é—â–∞—è –ø–∞—á–∫–∞)</button>
              <span class="text-xs muted-2">–°–ª–µ–¥—É—é—â–∏–π offset: {{ result.companies_next_offset }}</span>
            </form>
          </div>
          <script>
            (function() {
              // –°–∫—Ä–æ–ª–ª –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
              const resultCard = document.querySelector('.card.card-pad');
              if (resultCard) {
                setTimeout(function() {
                  resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
              }
              
              // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
              let countdown = 5;
              let autoContinue = true;
              const countdownEl = document.getElementById('countdown');
              const statusEl = document.getElementById('auto-continue-status');
              const stopBtn = document.getElementById('stop-auto-continue');
              const form = document.getElementById('continue-form');
              
              if (!countdownEl || !statusEl || !stopBtn || !form) return;
              
              stopBtn.addEventListener('click', function() {
                autoContinue = false;
                statusEl.innerHTML = '<div class="text-sm text-brand-dark">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –≤—Ä—É—á–Ω—É—é.</div>';
              });
              
              const timer = setInterval(function() {
                if (!autoContinue) {
                  clearInterval(timer);
                  return;
                }
                countdown--;
                if (countdownEl) {
                  countdownEl.textContent = countdown;
                }
                if (countdown <= 0) {
                  clearInterval(timer);
                  if (autoContinue) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    statusEl.innerHTML = '<div class="text-sm text-brand-dark">–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è –ø–∞—á–∫–∞...</div>';
                    form.submit();
                  }
                }
              }, 1000);
            })();
          </script>
        {% endif %}
      </div>
    {% endif %}

    <div class="card card-pad">
      <div class="font-medium mb-2">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ nginx (–µ—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ 504)</div>
      <div class="text-sm text-brand-dark/80 space-y-2">
        <p>–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π <code class="bg-brand-soft px-1 rounded">504 Gateway Time-out</code>, –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç nginx –¥–ª—è —ç—Ç–æ–≥–æ endpoint.</p>
        <p><b>–í–∞—Ä–∏–∞–Ω—Ç 1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):</b> –î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Ñ–∏–≥ nginx (–æ–±—ã—á–Ω–æ <code class="bg-brand-soft px-1 rounded">/etc/nginx/sites-available/your-site</code>):</p>
        <pre class="bg-brand-soft p-3 rounded text-xs overflow-x-auto"><code>location /settings/amocrm/migrate/ {
    proxy_read_timeout 300s;  # 5 –º–∏–Ω—É—Ç
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ proxy_* –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
}</code></pre>
        <p><b>–í–∞—Ä–∏–∞–Ω—Ç 2:</b> –£–≤–µ–ª–∏—á—å—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –≤ <code class="bg-brand-soft px-1 rounded">http {}</code> –±–ª–æ–∫–µ:</p>
        <pre class="bg-brand-soft p-3 rounded text-xs overflow-x-auto"><code>http {
    proxy_read_timeout 300s;
    # ...
}</code></pre>
        <p>–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: <code class="bg-brand-soft px-1 rounded">sudo nginx -t && sudo systemctl reload nginx</code></p>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–µ–∫–±–æ–∫—Å–∞
      const migrateAllCheckbox = document.getElementById('migrate_all_checkbox');
      const customFieldContainer = document.getElementById('custom_field_container');
      const customFieldSelect = document.getElementById('custom_field_select');
      
      function updateCustomFieldVisibility() {
        if (migrateAllCheckbox && customFieldContainer && customFieldSelect) {
          if (migrateAllCheckbox.checked) {
            customFieldContainer.style.opacity = '0.5';
            customFieldSelect.removeAttribute('required');
          } else {
            customFieldContainer.style.opacity = '1';
            customFieldSelect.setAttribute('required', 'required');
          }
        }
      }
      
      if (migrateAllCheckbox) {
        migrateAllCheckbox.addEventListener('change', updateCustomFieldVisibility);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateCustomFieldVisibility();
      }
      
      // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã (–Ω–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç)
      const migrateForm = document.getElementById('migrate-form');
      const resultContainer = document.getElementById('result-container');
      
      if (migrateForm && resultContainer) {
        migrateForm.addEventListener('submit', function(e) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ offset —Ä–∞–≤–µ–Ω 0 –∏–ª–∏ –ø—É—Å—Ç–æ–π (–Ω–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç, –∞ –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)
          const offsetInput = migrateForm.querySelector('input[name="offset"]');
          const offsetValue = offsetInput ? offsetInput.value : '0';
          
          // –ï—Å–ª–∏ offset = 0, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –Ω–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É - –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          // –§–æ—Ä–º–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è (continue-form) –∏–º–µ–µ—Ç –¥—Ä—É–≥–æ–π ID –∏ –Ω–µ –∑–∞—Ç—Ä–æ–Ω–µ—Ç—Å—è
          if (offsetValue === '0' || offsetValue === '') {
            resultContainer.style.display = 'none';
          }
        });
      }
    })();
  </script>
{% endblock %}


