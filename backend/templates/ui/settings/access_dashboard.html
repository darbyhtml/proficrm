{% extends "ui/base.html" %}
{% block title %}Доступы — CRM ПРОФИ{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <h1 class="text-2xl font-semibold">Доступы (policy)</h1>
        <div class="text-sm text-brand-dark/70">Единые правила для UI / API / мобильного приложения</div>
      </div>
      <a class="btn btn-outline" href="/settings/">← Назад в настройки</a>
    </div>

    <div class="card card-pad">
      <div class="font-medium">Режим применения</div>
      <div class="text-sm text-brand-dark/70 mt-1">
        <div><b>observe_only</b> — не блокирует, только пишет решения в журнал.</div>
        <div><b>enforce</b> — запрещённые правилами ресурсы блокируются.</div>
        <div class="mt-2 text-xs muted">
          Активных правил: <b>{{ rules_total }}</b> (по ролям: <b>{{ rules_role_total }}</b>).
          Логи решений ищите в «Журнал действий» (entity_type = policy).
        </div>
      </div>

      <form method="post" class="mt-3 flex items-center gap-2 flex-wrap">
        {% csrf_token %}
        <select name="mode" class="select w-auto">
          <option value="observe_only" {% if cfg.mode == 'observe_only' %}selected{% endif %}>observe_only (наблюдение)</option>
          <option value="enforce" {% if cfg.mode == 'enforce' %}selected{% endif %}>enforce (применять)</option>
        </select>
        <label class="text-xs muted flex items-center gap-2">
          <input type="checkbox" name="confirm_enforce">
          Подтверждаю включение enforce
        </label>
        <button class="btn btn-primary" type="submit">Сохранить</button>
        <div class="text-xs muted">Текущий режим: <b>{{ cfg.mode }}</b></div>
      </form>
    </div>

    <div class="card card-pad">
      <div class="font-medium">Безопасный baseline</div>
      <div class="text-sm text-brand-dark/70 mt-1">
        Быстрый старт: запретить для роли <b>Менеджер</b> все ресурсы, помеченные как <b>sensitive</b>.
        Это снижает риск утечек и деструктивных действий.
      </div>
      <form method="post" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="action" value="baseline_manager_deny_sensitive">
        <button class="btn btn-outline" type="submit">Применить baseline для менеджера</button>
      </form>
    </div>

    <div class="card card-pad">
      <div class="font-medium">Правила по ролям</div>
      <div class="text-sm text-brand-dark/70 mt-1">Выберите роль и настройте доступы к ресурсам (страницы/действия).</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
        {% for value,label in roles %}
          <a href="{% url 'settings_access_role' role=value %}" class="bg-white border border-brand-soft rounded-2xl p-4 hover:bg-brand-soft/25">
            <div class="font-medium">{{ label }}</div>
            <div class="text-xs muted mt-1">{{ value }}</div>
          </a>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

