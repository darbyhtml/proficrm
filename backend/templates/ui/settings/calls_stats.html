{% extends "ui/base.html" %}
{% load ui_extras %}
{% block title %}Статистика звонков{% endblock %}

{% block content %}
  <div class="space-y-4">
    <div>
      <div class="text-sm muted">
        <a class="link" href="/settings/">Настройки</a> /
      </div>
      <h1 class="text-2xl font-semibold">Статистика звонков</h1>
      <div class="text-sm text-brand-dark/70">
        Период: <b>{{ period_label }}</b>
        {% if total_calls > 0 %}
          · Всего звонков: <b>{{ total_calls }}</b>
          · Дозвонились: <b>{{ total_connected }}</b>
          {% if connect_rate_all %}
            · Дозвоняемость: <b>{{ connect_rate_all }}%</b>
          {% endif %}
          {% if total_unknown %}
            · Не определено: <b>{{ total_unknown }}</b>
          {% endif %}
          · Средняя длительность разговора: <b>{{ avg_duration_all|floatformat:0 }} сек</b>
        {% endif %}
      </div>
    </div>

    <form method="get" class="card card-pad flex flex-wrap items-end gap-4">
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Период</label>
        <select name="period" id="periodSelect" class="select">
          <option value="day" {% if period == "day" %}selected{% endif %}>День</option>
          <option value="month" {% if period == "month" %}selected{% endif %}>Месяц</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Менеджер</label>
        <select name="manager" class="select">
          <option value="">Все менеджеры</option>
          {% for m in managers %}
            <option value="{{ m.id }}" {% if filter_manager == m.id|stringformat:"s" %}selected{% endif %}>
              {{ m.get_full_name|default:m.username }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm text-brand-dark/80 mb-1">Исход звонка</label>
        <select name="status" class="select">
          <option value="">Все исходы</option>
          <option value="connected" {% if filter_status == "connected" %}selected{% endif %}>Дозвонился</option>
          <option value="no_answer" {% if filter_status == "no_answer" %}selected{% endif %}>Не дозвонился</option>
          <option value="busy" {% if filter_status == "busy" %}selected{% endif %}>Занято</option>
          <option value="rejected" {% if filter_status == "rejected" %}selected{% endif %}>Отклонен</option>
          <option value="missed" {% if filter_status == "missed" %}selected{% endif %}>Пропущен</option>
          <option value="unknown" {% if filter_status == "unknown" %}selected{% endif %}>Не удалось определить</option>
        </select>
      </div>
      <div class="ml-auto flex gap-2">
        <button class="btn btn-primary" type="submit">Применить</button>
        <a href="/settings/calls/stats/" class="btn btn-outline">Сброс</a>
      </div>
    </form>

    {% if stats_list %}
      <div class="card card-pad overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Менеджер</th>
              <th>Филиал</th>
              <th class="text-right">Всего</th>
              <th class="text-right">Дозвонился</th>
              <th class="text-right">Не дозвонился</th>
              <th class="text-right">Занято</th>
              <th class="text-right">Отклонен</th>
              <th class="text-right">Пропущен</th>
              <th class="text-right">Средняя длительность</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in stats_list %}
              <tr>
                <td>
                  <div class="font-medium">
                    <a href="/settings/calls/stats/{{ stat.user.id }}/?period={{ period }}" class="link">
                      {{ stat.user.get_full_name|default:stat.user.username }}
                    </a>
                  </div>
                </td>
                <td>
                  <div class="text-sm text-brand-dark/70">
                    {{ stat.user.branch.name|default:"—" }}
                  </div>
                </td>
                <td class="text-right">
                  <span class="font-medium">{{ stat.total }}</span>
                </td>
                <td class="text-right">
                  <span class="text-green-600">{{ stat.connected }}</span>
                </td>
                <td class="text-right">
                  <span class="text-orange-600">{{ stat.no_answer }}</span>
                </td>
                <td class="text-right">
                  <span class="text-yellow-600">{{ stat.busy }}</span>
                </td>
                <td class="text-right">
                  <span class="text-red-600">{{ stat.rejected }}</span>
                </td>
                <td class="text-right">
                  <span class="text-gray-600">{{ stat.missed }}</span>
                </td>
                <td class="text-right">
                  {% if stat.unknown %}
                    <span class="text-purple-600">{{ stat.unknown }}</span>
                  {% else %}
                    <span class="text-brand-dark/50">—</span>
                  {% endif %}
                </td>
                <td class="text-right">
                  {% if stat.avg_duration > 0 %}
                    <span class="text-sm">{{ stat.avg_duration|floatformat:0 }} сек</span>
                  {% else %}
                    <span class="text-sm text-brand-dark/50">—</span>
                  {% endif %}
                </td>
                <td class="text-right">
                  {% if stat.connect_rate_percent %}
                    <span class="text-sm font-medium">{{ stat.connect_rate_percent }}%</span>
                  {% else %}
                    <span class="text-sm text-brand-dark/50">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
          {% if total_calls > 0 %}
            <tfoot>
              <tr class="border-t-2 border-brand-dark/20">
                <td colspan="2" class="font-medium">Итого</td>
                <td class="text-right font-medium">{{ total_calls }}</td>
                <td class="text-right font-medium text-green-600">{{ total_connected }}</td>
                <td class="text-right font-medium text-orange-600">{{ total_no_answer }}</td>
                <td class="text-right font-medium text-yellow-600">{{ total_busy }}</td>
                <td class="text-right font-medium text-red-600">{{ total_rejected }}</td>
                <td class="text-right font-medium text-gray-600">{{ total_missed }}</td>
                <td class="text-right font-medium text-purple-600">{{ total_unknown|default:0 }}</td>
                <td class="text-right font-medium">
                  {% if avg_duration_all > 0 %}
                    {{ avg_duration_all|floatformat:0 }} сек
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="text-right font-medium">
                  {% if connect_rate_all %}
                    {{ connect_rate_all }}%
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            </tfoot>
          {% endif %}
        </table>
      </div>
      
      {# ЭТАП 4: Блоки распределений (только если есть данные) #}
      {% if total_calls > 0 and total_by_direction %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          {# Распределение по направлению #}
          {% if total_by_direction.outgoing or total_by_direction.incoming or total_by_direction.missed %}
            <div class="card card-pad">
              <div class="text-xs muted-2 mb-2">По направлению</div>
              <div class="space-y-1 text-sm">
                {% if total_by_direction.outgoing %}
                  <div>Исходящие: <span class="font-medium">{{ total_by_direction.outgoing }}</span></div>
                {% endif %}
                {% if total_by_direction.incoming %}
                  <div>Входящие: <span class="font-medium">{{ total_by_direction.incoming }}</span></div>
                {% endif %}
                {% if total_by_direction.missed %}
                  <div>Пропущенные: <span class="font-medium">{{ total_by_direction.missed }}</span></div>
                {% endif %}
              </div>
            </div>
          {% endif %}
          
          {# Распределение по источнику #}
          {% if total_by_action_source.crm_ui or total_by_action_source.notification or total_by_action_source.history %}
            <div class="card card-pad">
              <div class="text-xs muted-2 mb-2">По источнику</div>
              <div class="space-y-1 text-sm">
                {% if total_by_action_source.crm_ui %}
                  <div>Из CRM: <span class="font-medium">{{ total_by_action_source.crm_ui }}</span></div>
                {% endif %}
                {% if total_by_action_source.notification %}
                  <div>Из уведомления: <span class="font-medium">{{ total_by_action_source.notification }}</span></div>
                {% endif %}
                {% if total_by_action_source.history %}
                  <div>Из истории: <span class="font-medium">{{ total_by_action_source.history }}</span></div>
                {% endif %}
              </div>
            </div>
          {% endif %}
          
          {# Распределение по способу определения #}
          {% if total_by_resolve_method.observer or total_by_resolve_method.retry %}
            <div class="card card-pad">
              <div class="text-xs muted-2 mb-2">По способу определения</div>
              <div class="space-y-1 text-sm">
                {% if total_by_resolve_method.observer %}
                  <div>Определено сразу: <span class="font-medium">{{ total_by_resolve_method.observer }}</span></div>
                {% endif %}
                {% if total_by_resolve_method.retry %}
                  <div>Определено проверками: <span class="font-medium">{{ total_by_resolve_method.retry }}</span></div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <div class="card card-pad text-center text-brand-dark/70">
        За выбранный период звонков не найдено.
      </div>
    {% endif %}
  </div>

{% endblock %}
