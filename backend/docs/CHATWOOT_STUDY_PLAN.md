# План изучения Chatwoot для улучшения нашего мессенджера

Этот документ описывает, какие части кода Chatwoot нужно изучить для улучшения нашего мессенджера.

**Важно:** Chatwoot написан на Ruby on Rails + React, наш проект на Django + vanilla JS. Мы изучаем **архитектурные решения и паттерны**, а не копируем код напрямую.

---

## Структура Chatwoot

```
chatwoot-reference/
├── app/
│   ├── models/              # Модели данных (Conversation, Message, Contact, Inbox)
│   ├── controllers/         # API контроллеры
│   ├── channels/            # ActionCable (WebSocket) каналы для real-time
│   ├── services/            # Бизнес-логика
│   ├── jobs/                # Фоновые задачи (Sidekiq)
│   └── javascript/          # Frontend (React)
│       ├── dashboard/       # Операторская панель
│       └── widget/          # Виджет для сайта
├── db/
│   └── migrate/            # Миграции БД (полезно для понимания схемы)
└── spec/                    # Тесты (показывают edge cases)
```

---

## Приоритетные области для изучения

### 1. Модели данных и связи (app/models/)

**Файлы для изучения:**
- `app/models/conversation.rb` — структура диалога, статусы, связи
- `app/models/message.rb` — структура сообщения, типы, вложения
- `app/models/contact.rb` — контакты, идентификация
- `app/models/inbox.rb` — настройки inbox, каналы
- `app/models/agent.rb` — операторы, статусы, capacity

**Что искать:**
- Как обрабатываются edge cases (удаление, архивация, статусы)
- Валидации и constraints
- Индексы для производительности
- Полиморфные связи (если есть)
- Callbacks и state machine (если используется)

**Вопросы:**
- Как Chatwoot обрабатывает race conditions при назначении диалога?
- Как хранятся метаданные (браузер, IP, referrer)?
- Как реализована система статусов (open, resolved, closed)?

---

### 2. Real-time обновления (app/channels/, app/javascript/)

**Файлы для изучения:**
- `app/channels/application_cable/connection.rb` — WebSocket подключение
- `app/channels/conversation_channel.rb` — канал для диалогов
- `app/javascript/dashboard/components/Conversation/` — React компоненты
- `app/javascript/dashboard/store/modules/conversations/` — состояние диалогов

**Что искать:**
- Как реализован real-time (ActionCable = WebSocket)
- Как обрабатываются reconnection и fallback на polling
- Как синхронизируется состояние между вкладками
- Как обрабатываются конфликты (два оператора одновременно редактируют)

**Вопросы:**
- Как Chatwoot обрабатывает ситуацию, когда оператор открыл диалог в двух вкладках?
- Как реализован typing indicator?
- Как обновляется список диалогов в реальном времени?

---

### 3. Виджет (app/javascript/widget/)

**Файлы для изучения:**
- `app/javascript/widget/index.js` — точка входа виджета
- `app/javascript/widget/components/` — компоненты виджета
- `app/controllers/public/api/v1/widgets/` — публичный API виджета

**Что искать:**
- Как обрабатывается идентификация посетителя (cookie, localStorage)
- Как реализован fallback при недоступности WebSocket
- Как обрабатываются вложения (drag & drop, paste)
- Как реализован offline режим
- Как работает lazy loading виджета

**Вопросы:**
- Как Chatwoot предотвращает спам в виджете?
- Как обрабатывается ситуация, когда посетитель закрыл виджет и вернулся?
- Как реализована поддержка нескольких inbox на одной странице?

---

### 4. Распределение и маршрутизация (app/services/)

**Файлы для изучения:**
- `app/services/` — поиск файлов с "assignment", "routing", "distribution"
- Возможно: `app/services/auto_assignment/` или похожие

**Что искать:**
- Алгоритм round-robin распределения
- Обработка capacity (нагрузка оператора)
- Эскалация по таймауту
- Передача диалога между операторами

**Вопросы:**
- Как Chatwoot учитывает текущую нагрузку оператора?
- Как обрабатывается ситуация, когда все операторы заняты?
- Как реализована передача диалога?

---

### 5. Безопасность и валидация

**Файлы для изучения:**
- `app/controllers/public/api/v1/widgets/` — публичный API
- `app/models/` — валидации моделей
- `app/services/` — сервисы безопасности

**Что искать:**
- Rate limiting для виджета
- Валидация входящих данных
- Защита от XSS, CSRF
- Обработка CAPTCHA (если есть)
- Политики доменов (CORS, Origin)

**Вопросы:**
- Как Chatwoot защищает публичный API от злоупотреблений?
- Как обрабатываются подозрительные запросы?
- Как реализована проверка домена для виджета?

---

### 6. UI/UX операторской панели (app/javascript/dashboard/)

**Файлы для изучения:**
- `app/javascript/dashboard/components/Conversation/` — компоненты диалога
- `app/javascript/dashboard/components/Chat/` — чат интерфейс
- `app/javascript/dashboard/components/ConversationList/` — список диалогов

**Что искать:**
- Трёхколоночный layout (список, диалог, информация)
- Компактные карточки диалогов
- Обработка скролла и виртуализация (если есть)
- Keyboard shortcuts
- Поиск и фильтры

**Вопросы:**
- Как Chatwoot обрабатывает большое количество диалогов (пагинация, виртуализация)?
- Как реализован поиск по диалогам?
- Как работает сортировка и фильтрация?

---

### 7. Вложения и файлы

**Файлы для изучения:**
- `app/models/attachment.rb` — модель вложений
- `app/controllers/api/v1/accounts/conversations/attachments_controller.rb`
- `app/javascript/dashboard/components/Attachment/` — компоненты вложений

**Что искать:**
- Обработка разных типов файлов (изображения, PDF, видео)
- Превью изображений
- Лимиты размера файлов
- Безопасная загрузка (проверка MIME типа, сканирование на вирусы?)

**Вопросы:**
- Как Chatwoot обрабатывает большие файлы?
- Как реализовано превью изображений?
- Как обрабатываются ошибки загрузки?

---

### 8. Тесты (spec/)

**Файлы для изучения:**
- `spec/models/conversation_spec.rb` — тесты диалогов
- `spec/models/message_spec.rb` — тесты сообщений
- `spec/services/` — тесты сервисов

**Что искать:**
- Edge cases, которые покрыты тестами
- Сценарии, которые мы могли пропустить
- Ожидаемое поведение в спорных ситуациях

**Вопросы:**
- Какие edge cases покрыты тестами Chatwoot?
- Как тестируется race condition при назначении?
- Как тестируется real-time функциональность?

---

## План действий

### Этап 1: Изучение моделей (1-2 дня)
1. Прочитать модели Conversation, Message, Contact, Inbox
2. Составить список edge cases и валидаций
3. Сравнить с нашими моделями, выявить пробелы

### Этап 2: Изучение real-time (1 день)
1. Понять архитектуру ActionCable (WebSocket)
2. Изучить fallback механизмы
3. Сравнить с нашей SSE реализацией

### Этап 3: Изучение виджета (1-2 дня)
1. Разобрать структуру виджета
2. Понять механизмы идентификации и сессий
3. Изучить обработку ошибок и fallback

### Этап 4: Изучение UI (1 день)
1. Разобрать трёхколоночный layout
2. Понять паттерны управления состоянием
3. Изучить оптимизации производительности

### Этап 5: Применение знаний (2-3 дня)
1. Составить список улучшений для нашего мессенджера
2. Приоритизировать по важности
3. Реализовать критические улучшения

---

## Конкретные вопросы для поиска ответов

1. **Race conditions:**
   - Как Chatwoot обрабатывает одновременное назначение диалога двум операторам?
   - Как обрабатывается ситуация, когда диалог закрыли, пока оператор отправлял сообщение?

2. **Производительность:**
   - Как Chatwoot оптимизирует запросы при большом количестве диалогов?
   - Используется ли виртуализация списка диалогов?
   - Как кэшируются данные?

3. **UX детали:**
   - Как обрабатывается ситуация, когда оператор печатает, а диалог уже закрыт?
   - Как показываются уведомления о новых сообщениях?
   - Как работает автосохранение черновиков?

4. **Безопасность:**
   - Как Chatwoot предотвращает спам в виджете?
   - Как обрабатываются подозрительные запросы?
   - Как реализована защита от XSS в сообщениях?

5. **Интеграции:**
   - Как Chatwoot обрабатывает webhooks?
   - Как реализованы интеграции с внешними системами?
   - Как обрабатываются ошибки внешних API?

---

## Полезные команды для изучения

```bash
# Найти все упоминания конкретной функциональности
cd chatwoot-reference
grep -r "typing" app/models app/controllers app/services

# Найти все тесты для модели
find spec -name "*conversation*" -type f

# Посмотреть миграции для понимания схемы БД
ls -la db/migrate/ | grep conversation

# Изучить структуру React компонентов
find app/javascript/dashboard/components -type d
```

---

## Результат изучения

После изучения Chatwoot мы должны:

1. **Составить список улучшений** для нашего мессенджера
2. **Выявить edge cases**, которые мы не учли
3. **Понять архитектурные паттерны**, которые можно применить
4. **Реализовать критические улучшения** для production-ready состояния

---

## Примечания

- Chatwoot использует Ruby on Rails, мы используем Django — синтаксис разный, но концепции похожи
- Chatwoot использует React, мы используем vanilla JS — изучаем логику, не копируем компоненты
- Фокус на **как**, а не на **что** — нас интересуют решения проблем, а не конкретная реализация

---

*Документ создан для систематического изучения Chatwoot с целью улучшения нашего мессенджера.*
