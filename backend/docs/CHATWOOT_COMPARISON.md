# Сравнение нашего мессенджера с Chatwoot

Документ фиксирует ключевые различия и находки при изучении кода Chatwoot.

---

## Ключевые находки из моделей Chatwoot

### 1. Conversation (Диалог)

#### Что есть в Chatwoot, чего нет у нас:

1. **`display_id`** — человекочитаемый номер диалога (уникальный в рамках account)
   - У нас: только UUID или числовой ID
   - **Вывод:** Можно добавить для удобства операторов ("Диалог #1234")

2. **`identifier`** — строка для идентификации диалога (например, из внешней системы)
   - У нас: нет
   - **Вывод:** Может быть полезно для интеграций

3. **`waiting_since`** — когда диалог начал ждать ответа
   - У нас: есть `assignee_assigned_at`, но нет `waiting_since`
   - **Вывод:** `waiting_since` более точно отражает время ожидания (может быть до назначения)

4. **`snoozed_until`** — отложенные диалоги
   - У нас: нет
   - **Вывод:** Полезная функция для операторов

5. **`first_reply_created_at`** — время первого ответа оператора
   - У нас: нет
   - **Вывод:** Важно для метрик (время первого ответа)

6. **`agent_last_seen_at`** и **`contact_last_seen_at`** — когда последний раз видели диалог
   - У нас: есть `assignee_last_read_at`, но нет `contact_last_seen_at`
   - **Вывод:** `contact_last_seen_at` полезен для виджета (показывать "был(а) недавно")

7. **`last_activity_at`** — время последней активности (обновляется автоматически)
   - У нас: используем `updated_at`, но это не то же самое
   - **Вывод:** Нужно явное поле `last_activity_at`, которое обновляется при сообщениях

8. **`custom_attributes`** и **`additional_attributes`** — JSONB для метаданных
   - У нас: есть `metadata` в Conversation
   - **Вывод:** Структура похожа, но можно улучшить

9. **Индексы:**
   - Chatwoot имеет составные индексы: `(account_id, inbox_id, status, assignee_id)`
   - У нас: отдельные индексы
   - **Вывод:** Составные индексы могут улучшить производительность запросов списка диалогов

#### Что есть у нас, чего нет в Chatwoot:

1. **`branch`** и **`region`** — интеграция с нашей CRM
2. **`rating_score`**, **`rating_comment`**, **`rated_at`** — оценка диалога (у Chatwoot это отдельная модель)

---

### 2. Message (Сообщение)

#### Что есть в Chatwoot, чего нет у нас:

1. **`echo_id`** — временный ID из фронтенда для синхронизации
   - У нас: нет
   - **Вывод:** Полезно для оптимистичных обновлений UI

2. **`processed_message_content`** — обработанный контент (после фильтрации, форматирования)
   - У нас: только `body`
   - **Вывод:** Может быть полезно для поиска и фильтрации

3. **`content_attributes`** (JSON) — структурированные данные:
   - `in_reply_to` — ответ на конкретное сообщение
   - `deleted` — удалённое сообщение
   - `external_created_at` — время создания во внешней системе
   - `translations` — переводы сообщения
   - У нас: нет такой гибкости
   - **Вывод:** JSON поле даёт гибкость для будущих расширений

4. **`external_source_ids`** (JSONB) — ID во внешних системах (Slack, Telegram и т.д.)
   - У нас: нет
   - **Вывод:** Полезно для интеграций

5. **`sentiment`** (JSONB) — анализ тональности сообщения
   - У нас: нет
   - **Вывод:** Может быть добавлено позже

6. **`source_id`** — ID источника сообщения (для дедупликации)
   - У нас: нет
   - **Вывод:** Полезно для предотвращения дублей при интеграциях

7. **Валидация длины:** максимум 150,000 символов
   - У нас: нужно проверить наши лимиты

8. **`prevent_message_flooding`** — защита от флуда
   - У нас: есть rate limiting на уровне API, но не на уровне модели
   - **Вывод:** Нужна валидация на уровне модели

9. **Индексы:**
   - `(conversation_id, account_id, message_type, created_at)` — составной индекс
   - `(account_id, content_type, created_at)` — для поиска
   - GIN индекс на `content` для полнотекстового поиска
   - У нас: базовые индексы
   - **Вывод:** Нужны составные индексы для производительности

#### Что есть у нас, чего нет в Chatwoot:

1. **`read_at`** — когда сообщение прочитано (у Chatwoot это статус `read`)

---

### 3. Contact (Контакт)

#### Что есть в Chatwoot, чего нет у нас:

1. **`contact_inbox`** — связь контакта с конкретным inbox (один контакт может быть в разных inbox)
   - У нас: контакт не привязан к inbox напрямую
   - **Вывод:** Может быть полезно для мультитенантности

2. **`identifier`** — уникальный идентификатор контакта
   - У нас: есть `external_id`, но не обязателен
   - **Вывод:** Похоже на наш `external_id`

---

## Архитектурные паттерны Chatwoot

### 1. Concerns (Mixins)

Chatwoot использует Ruby concerns для переиспользования логики:
- `AssignmentHandler` — логика назначения
- `AutoAssignmentHandler` — автоназначение
- `ActivityMessageHandler` — системные сообщения
- `ConversationMuteHelpers` — заглушка диалогов

**Вывод:** У нас можно использовать Django mixins или сервисы для переиспользования логики.

### 2. Callbacks и State Machine

Chatwoot использует callbacks (`before_save`, `after_create_commit`) для автоматизации:
- Обновление `last_activity_at`
- Отправка уведомлений
- Обновление индексов поиска

**Вывод:** У нас можно использовать Django signals или методы `save()`.

### 3. Scopes (QuerySets)

Chatwoot использует scopes для часто используемых запросов:
- `unassigned`, `assigned`, `assigned_to`
- `unattended` — диалоги без ответа
- `resolvable_not_waiting` — диалоги для авто-резолва

**Вывод:** У нас можно использовать Django QuerySet methods или менеджеры моделей.

---

## Критические улучшения для production

### Приоритет 1: Безопасность и надёжность

1. **Защита от флуда сообщений:**
   - Валидация на уровне модели (`prevent_message_flooding`)
   - Rate limiting на уровне API (у нас есть, но нужно проверить)

2. **Race conditions при назначении:**
   - Использовать `select_for_update()` при назначении диалога
   - Проверять, что диалог не назначен другому оператору

3. **Валидация длины сообщений:**
   - Установить лимит (например, 150,000 символов как в Chatwoot)
   - Проверять на уровне модели и API

### Приоритет 2: Производительность

1. **Составные индексы:**
   - `(inbox_id, status, assignee_id, created_at)` для списка диалогов
   - `(conversation_id, direction, created_at)` для сообщений

2. **Оптимизация запросов:**
   - Использовать `select_related()` и `prefetch_related()`
   - Избегать N+1 запросов

3. **Кэширование:**
   - Кэшировать список диалогов оператора
   - Кэшировать счётчики непрочитанных

### Приоритет 3: UX улучшения

1. **`display_id` для диалогов:**
   - Человекочитаемый номер (#1234)
   - Удобно для операторов

2. **`waiting_since` вместо `assignee_assigned_at`:**
   - Более точно отражает время ожидания
   - Учитывает время до назначения

3. **`first_reply_created_at`:**
   - Для метрик времени первого ответа
   - Важно для аналитики

4. **`contact_last_seen_at`:**
   - Показывать "был(а) недавно" в виджете
   - Улучшает UX

### Приоритет 4: Гибкость

1. **`content_attributes` (JSON) для сообщений:**
   - Ответы на сообщения (`in_reply_to`)
   - Удалённые сообщения (`deleted`)
   - Переводы (`translations`)

2. **`custom_attributes` для диалогов:**
   - Хранить метаданные (браузер, ОС, referrer)
   - Гибкость для будущих расширений

---

## План действий

### Фаза 1: Критические улучшения (1-2 недели)

1. ✅ Добавить защиту от флуда сообщений
2. ✅ Исправить race conditions при назначении
3. ✅ Добавить валидацию длины сообщений
4. ✅ Добавить составные индексы для производительности

### Фаза 2: UX улучшения (1 неделя)

1. ✅ Добавить `display_id` для диалогов
2. ✅ Добавить `waiting_since` и `first_reply_created_at`
3. ✅ Добавить `contact_last_seen_at`

### Фаза 3: Гибкость (1 неделя)

1. ✅ Расширить `content_attributes` для сообщений
2. ✅ Улучшить `metadata` для диалогов

---

## Полезные команды для изучения Chatwoot

```bash
# Изучить модель Conversation
cat chatwoot-reference/app/models/conversation.rb | less

# Изучить модель Message
cat chatwoot-reference/app/models/message.rb | less

# Найти все валидации
grep -r "validates" chatwoot-reference/app/models/conversation.rb

# Найти все индексы в миграциях
grep -r "add_index.*conversation" chatwoot-reference/db/migrate/

# Изучить контроллеры API
find chatwoot-reference/app/controllers/api/v1/accounts/conversations -name "*.rb"
```

---

*Документ обновляется по мере изучения Chatwoot.*
