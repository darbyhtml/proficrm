## План рефакторинга live-chat / messenger

- [ ] **Backend: Widget API**
  - [x] Расширить `widget_bootstrap` так, чтобы `initial_messages` включали сообщения направлений `IN` и `OUT` (кроме `INTERNAL`), и помечать `OUT` как доставленные при первой выдаче.
  - [ ] (Опционально) При необходимости расширить `widget_poll` и `widget_stream`, чтобы возвращать `IN`-сообщения; сейчас они отдают только `OUT`, а сообщения клиента показываются и хранятся на стороне виджета.
  - [x] Реализовать установку `delivered_at` для исходящих сообщений (`OUT`) при первой выдаче их в `poll/stream/bootstrap`.
  - [x] Добавить в ответ `widget_send` сериализованный список вложений через `build_message_attachments_payload`, расширить `WidgetSendResponseSerializer`.
  - [x] Добавить `prefetch_related("attachments")` в `ConversationViewSet.messages` для избежания N+1 запросов.

- [ ] **Frontend: widget.js**
  - [x] Обновить `sendMessage`, чтобы использовать вложения из ответа `widget_send` (а не собирать их локально из `File`).
  - [x] Убедиться, что оптимистичный рендер сообщений клиента не ломает dedup и корректно показывает вложения (используем payload от backend для вложений).
  - [x] Проставлять `data-message-id` на DOM-элементы сообщений.
  - [x] Реализовать метод, который вычисляет последний видимый `OUT`-message id и вызывает `POST /api/widget/mark_read/`.
  - [x] Встраивать вызов mark_read при открытии виджета, отображении initial/poll/SSE сообщений, когда исходящие сообщения видимы.

- [ ] **Frontend: operator-panel.js**
  - [ ] Проверить корректность работы polling по параметру `since` с учётом новой семантики сообщений.
  - [ ] Убедиться, что статусы доставлено/прочитано (иконки) используют `delivered_at` и `read_at` и отображаются ожидаемо.

- [ ] **Тесты и проверка**
  - [x] Добавить/расширить unit-/integration-тесты для Widget API (bootstrap/send/poll/mark_read/stream) с учётом новых полей (тесты на вложения и delivered_at).
  - [ ] Добавить тест на отсутствие N+1 по вложениям или хотя бы smoke-тест выборки сообщений с вложениями.
  - [x] Прогнать линтеры/тесты по изменённым файлам и убедиться в отсутствии ошибок (по затронутым модулям).

- [ ] **Финальный проход**
  - [ ] Ручной прогон сценария: виджет ↔ операторская панель (история, вложения, статусы, typing, rating).
  - [ ] Ещё раз просмотреть изменения в коде, свериться с этим планом и убедиться, что нет дыр по безопасности и edge-case’ам.

