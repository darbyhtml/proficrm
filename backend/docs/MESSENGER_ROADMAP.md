# Messenger: дорожная карта и приоритеты

Документ фиксирует приоритеты развития модуля Messenger (чат-виджет и операторская панель) и предлагаемое разбиение на фазы внедрения.

---

## 1. Приоритеты (полный перечень)

### Распределение и регионы

**1. Общий чат + GeoIP и регионы**  
Чаты не привязаны к одному филиалу — общий пул. Определение региона/области клиента по IP при открытии чата или заходе на сайт. Сопоставление «регион → ответственный регион» (например, Екатеринбург). Если регион не определён или не найден в правилах — используется филиал по умолчанию (настраивается в настройках).

**2. Равномерное распределение**  
Распределение чатов между сотрудниками филиала рандомно, но равномерно — чтобы нагрузка не концентрировалась на одном сотруднике.

**3. Эскалация по таймауту (4 минуты)**  
Если назначенный сотрудник не ответил в течение 4 минут — чат передаётся следующему. Таймер сбрасывается при первом открытии диалога сотрудником; после открытия переназначение по таймауту не выполняется.

**4. Передача на другой филиал**  
Возможность передать чат сотруднику другого филиала: выбор «первому свободному в филиале X» и отдельно — список всех сотрудников филиала для ручного выбора.

---

### Реал-тайм и UX

**5. WebSockets или SSE**  
Замена poll на WebSockets или Server-Sent Events для доставки сообщений в реальном времени.

**6. Индикатор «печатает»**  
В виджете: «Оператор печатает…». В панели оператора: отображение, когда клиент печатает.

**7. Статусы прочтения**  
Доставлено / прочитано (хотя бы для исходящих). В виде одной галочки (доставлено) и двух галочек (прочитано), как в Telegram.

**8. Звук и уведомления**  
При новом чате или сообщении: звук, браузерные уведомления, badge в пункте меню «Диалоги».

**9. Непрочитанные**  
Счётчик непрочитанных по диалогам и в пункте меню «Диалоги».

---

### Виджет: контент и поведение

**10. Вложения**  
Загрузка файлов и картинок из виджета с лимитом размера и типов. Возможность вставки скриншотов и картинок по Ctrl+V.

**11. Форматирование**  
Markdown или простой rich text в сообщениях, поддержка эмодзи.

**12. Офлайн-режим**  
Сообщение «Сейчас никого нет, оставьте заявку» и сохранение в диалог/заявку. Текст сообщения настраивается в админке (settings).

**13. Оценка диалога**  
После закрытия диалога — запрос оценки (1–5 или NPS).

**14. Ленивая загрузка виджета**  
Подключение `widget.js` после скролла или через N секунд, чтобы не грузить скрипт до первого взаимодействия.

---

### Расписание и статусы операторов

**15. Рабочие часы**  
Вне расписания — не создавать/не назначать новые чаты или показывать авто-сообщение «мы ответим в рабочее время». Настройка расписания в админке.

**16. Статус оператора**  
Онлайн / отошёл / занят. Назначение только на операторов в статусе «онлайн» (или с учётом статуса).

---

### Супервизия и аналитика

**17. Вмешательство супервизора**  
Просмотр любого диалога, возможность «взять себе» из очереди другого. Режим «только просмотр»: админ может только смотреть, не может отвечать. При просмотре админом у клиента не ставится статус «прочитано» (админ «невидимка»).

**18. Аналитика и отчёты**  
- Дашборд мессенджера: время первого ответа, время до закрытия, число диалогов по дням/неделям.  
- Отчёты: по операторам (назначено/закрыто), по филиалам, по регионам, по inbox.  
- Графики: сообщения/диалоги по времени суток, пиковые часы.  
Всё в существующем разделе «Аналитика», с опорой на текущие отчёты по менеджерам.

---

### Интеграции

**19. Интеграции**  
- Каналы: реальная работа Telegram, WhatsApp, VK (модель Channel уже есть).  
- Email-канал: входящие письма как диалоги, ответы как письма.  
- Webhook: при новом сообщении / новом диалоге / закрытии — вызов внешнего URL (CRM, ERP, скрипты).  
- Публичный API: создание/обновление диалогов и сообщений из внешних систем.  
- Интеграторы: Zapier / Make / n8n — триггеры и действия «новая беседа», «отправить сообщение».

---

### Безопасность и соответствие

**20. Безопасность и соответствие**  
- Журнал аудита: кто просматривал/редактировал диалог, смена назначения, статуса.  
- Срок хранения: авто-закрытие или архивация старых диалогов (например, старше N месяцев).  
- GDPR: экспорт данных контакта, удаление по запросу (вплоть до анонимизации диалогов).  
- CAPTCHA при подозрительной активности (много запросов с одного IP / много новых чатов).  
- Политики доменов: разрешать виджет только с заданного списка доменов (CSP / проверка referrer).

---

### Автоматизация и техника

**21. Автоматизация и боты**  
Гибкая настройка в админке: сценарии, автоответы, боты — чтобы было понятно и управляемо.

**22. Техника и качество**  
- E2E-тесты: полный сценарий виджет → сообщение → ответ в панели (Playwright/Selenium).  
- Нагрузочные тесты: виджет API под пиковой нагрузкой, проверка лимитов и Redis.  
- Мониторинг: алерты при недоступности Redis, росте доли 429, падении health.  
- Резерв при падении Redis: по возможности не падать полностью (например, только потеря сессий).  
- Feature flags по inbox: включение экспериментальных фич по отдельным виджетам.

---

## 2. Предлагаемое разбиение на фазы

Зависимости между пунктами учтены: сначала фундамент (регионы, статусы, расписание), затем эскалация и передача, затем реал-тайм и UX.

### Фаза A — фундамент

| №  | Пункт | Описание |
|----|--------|----------|
| 1  | Общий чат + GeoIP | Общий пул чатов, определение региона по IP, правила «регион → ответственный», дефолтный филиал в настройках |
| 15 | Рабочие часы      | Настройка расписания в админке, поведение вне часов |
| 16 | Статус оператора  | Онлайн / отошёл / занят, учёт при назначении |
| 2  | Равномерное распределение | Доработка распределения с учётом статуса и нагрузки |

### Фаза B — назначение и эскалация

| № | Пункт | Описание |
|---|--------|----------|
| 3 | Эскалация 4 мин | Таймер до первого открытия диалога, передача следующему при отсутствии ответа |
| 4 | Передача на филиал | «Первый свободный в филиале X» + выбор конкретного сотрудника |

### Фаза C — реал-тайм и UX

| № | Пункт | Описание |
|---|--------|----------|
| 5 | WebSockets/SSE | Замена poll |
| 6 | «Печатает» | В виджете и в панели |
| 7 | Доставлено/прочитано | Одна и две галочки |
| 8 | Звук, уведомления, badge | В меню «Диалоги» |
| 9 | Непрочитанные | Счётчики по диалогам и в меню |

### Фаза D — виджет и офлайн

| №  | Пункт | Описание |
|----|--------|----------|
| 10 | Вложения | Файлы/картинки, Ctrl+V |
| 11 | Форматирование | Markdown/rich text, эмодзи |
| 12 | Офлайн-режим | Настраиваемое сообщение, сохранение заявки |
| 13 | Оценка диалога | 1–5 или NPS после закрытия |
| 14 | Ленивая загрузка | Подключение виджета после скролла или через N сек |

### Фаза E — супервизия и аналитика

| №  | Пункт | Описание |
|----|--------|----------|
| 17 | Супервизор | Просмотр любого диалога, «взять себе», режим «невидимка» для прочтения |
| 18 | Аналитика | Дашборд, отчёты, графики в разделе «Аналитика» |

### Фаза F — интеграции, безопасность, автоматизация, техника

| №  | Пункт | Описание |
|----|--------|----------|
| 19 | Интеграции | Каналы, email, webhook, API, Zapier/Make/n8n |
| 20 | Безопасность | Аудит, хранение, GDPR, CAPTCHA, домены |
| 21 | Автоматизация и боты | Настраиваемые сценарии в админке |
| 22 | Техника | E2E, нагрузка, мониторинг, резерв Redis, feature flags по inbox |

---

## 3. Связанные документы

- **README_messenger.md** — обзор модуля, feature-флаг, БД, безопасность, production guide.
- **/settings/messenger/** — настройки виджета, inbox, маршрутизация, диагностика.

---

*Документ обновлён по приоритетам продукта. Фазы можно корректировать по срокам и ресурсам.*
