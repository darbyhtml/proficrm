# Messenger: дорожная карта и приоритеты

Документ фиксирует приоритеты развития модуля Messenger (чат-виджет и операторская панель) и предлагаемое разбиение на фазы внедрения.

---

## 1. Приоритеты (полный перечень)

### Распределение и регионы

**1. Общий чат + GeoIP и регионы**  
Чаты не привязаны к одному филиалу — общий пул. Определение региона/области клиента по IP при открытии чата или заходе на сайт. Сопоставление «регион → ответственный регион» (например, Екатеринбург). Если регион не определён или не найден в правилах — используется филиал по умолчанию (настраивается в настройках).

**2. Равномерное распределение**  
Распределение чатов между сотрудниками филиала рандомно, но равномерно — чтобы нагрузка не концентрировалась на одном сотруднике.

**3. Эскалация по таймауту (4 минуты)**  
Если назначенный сотрудник не ответил в течение 4 минут — чат передаётся следующему. Таймер сбрасывается при первом открытии диалога сотрудником; после открытия переназначение по таймауту не выполняется.

**4. Передача на другой филиал**  
Возможность передать чат сотруднику другого филиала: выбор «первому свободному в филиале X» и отдельно — список всех сотрудников филиала для ручного выбора.

---

### Реал-тайм и UX

**5. WebSockets или SSE ✅ (SSE)**  
SSE-стрим `/api/widget/stream/` + `EventSource` в виджете (fallback на poll), доставка сообщений/typing/оценки в реальном времени.

**6. Индикатор «печатает»**  
В виджете: «Оператор печатает…». В панели оператора: отображение, когда клиент печатает.

**7. Статусы прочтения**  
Доставлено / прочитано (хотя бы для исходящих). В виде одной галочки (доставлено) и двух галочек (прочитано), как в Telegram.

**8. Звук и уведомления**  
При новом чате или сообщении: звук, браузерные уведомления, badge в пункте меню «Диалоги».

**9. Непрочитанные**  
Счётчик непрочитанных по диалогам и в пункте меню «Диалоги».

---

### Виджет: контент и поведение

**10. Вложения**  
Загрузка файлов и картинок из виджета с лимитом размера и типов. Возможность вставки скриншотов и картинок по Ctrl+V.

**11. Форматирование ✅**  
Простое форматирование сообщений (Markdown-подобный синтаксис: **жирный**, ссылки, переводы строк), поддержка эмодзи.

**12. Офлайн-режим**  
Сообщение «Сейчас никого нет, оставьте заявку» и сохранение в диалог/заявку. Текст сообщения настраивается в админке (settings).

**13. Оценка диалога**  
После закрытия диалога — запрос оценки (1–5 или NPS).

**14. Ленивая загрузка виджета**  
Подключение `widget.js` после скролла или через N секунд, чтобы не грузить скрипт до первого взаимодействия.

---

### Расписание и статусы операторов

**15. Рабочие часы**  
Вне расписания — не создавать/не назначать новые чаты или показывать авто-сообщение «мы ответим в рабочее время». Настройка расписания в админке.

**16. Статус оператора**  
Онлайн / отошёл / занят. Назначение только на операторов в статусе «онлайн» (или с учётом статуса).

---

### Супервизия и аналитика

**17. Вмешательство супервизора**  
Просмотр любого диалога, возможность «взять себе» из очереди другого. Режим «только просмотр»: админ может только смотреть, не может отвечать. При просмотре админом у клиента не ставится статус «прочитано» (админ «невидимка»).

**18. Аналитика и отчёты**  
- Дашборд мессенджера: время первого ответа, время до закрытия, число диалогов по дням/неделям.  
- Отчёты: по операторам (назначено/закрыто), по филиалам, по регионам, по inbox.  
- Графики: сообщения/диалоги по времени суток, пиковые часы.  
Всё в существующем разделе «Аналитика», с опорой на текущие отчёты по менеджерам.

---

### Интеграции

**19. Интеграции**  
- Каналы: реальная работа Telegram, WhatsApp, VK (модель Channel уже есть).  
- Email-канал: входящие письма как диалоги, ответы как письма.  
- Webhook ✅: per-Inbox webhook в настройках (`/settings/messenger/inboxes/<id>/`), события `conversation.created` / `conversation.closed` / `message.in` / `message.out`, HMAC-подпись тела запроса (`X-Messenger-Signature`), описание формата в `README_messenger.md`.  
- Публичный API: создание/обновление диалогов и сообщений из внешних систем.  
- Интеграторы: Zapier / Make / n8n — триггеры и действия «новая беседа», «отправить сообщение».

---

### Безопасность и соответствие

**20. Безопасность и соответствие**  
- Журнал аудита ✅: логируем просмотр супервизором (невидимка), отправку сообщений, смену статуса/назначения/приоритета в `ActivityEvent`.  
- Срок хранения: авто-закрытие или архивация старых диалогов (например, старше N месяцев).  
- Срок хранения ✅: команда `close_old_messenger_conversations` (RESOLVED → CLOSED после N дней).  
- GDPR: экспорт данных контакта, удаление по запросу (вплоть до анонимизации диалогов).  
- GDPR ✅: management-команды экспорта/анонимизации контакта (`export_messenger_contact_data`, `anonymize_messenger_contact`).  
- CAPTCHA при подозрительной активности (много запросов с одного IP / много новых чатов).  
- CAPTCHA ✅: мат. challenge (включается после порога по IP), проверка в `/api/widget/send/` и UI в виджете.  
- Политики доменов ✅: allowlist доменов в Inbox (Origin/Referer), виджет работает только на заданных доменах.

---

### Автоматизация и техника

**21. Автоматизация и боты**  
- Автоответ ✅: per-Inbox настройка `automation.auto_reply` (в разделе «Автоматизация и автоответ» на странице редактирования Inbox) — автоответ на первый входящий месседж в открытом диалоге от назначенного оператора, пока у диалога нет исходящих сообщений.  
  В дальнейшем может быть расширено до более сложных сценариев и ботов.

**22. Техника и качество**  
- E2E-тесты ✅: `e2e/messenger-widget.spec.js` (Playwright) — сценарий виджет → сообщение → ответ в панели; запускается против живого backend'а с тестовым Inbox и админом.  
- Нагрузочные тесты ✅: `locustfile.py` (Locust) — сценарий `bootstrap → send → poll` для widget API под нагрузкой, с наблюдением 429/5xx и поведения Redis/кеша.  
- Мониторинг ✅:  
  - база: расширена страница `/settings/messenger/health/` (cache backend/REDIS_URL) для быстрой диагностики окружения;  
  - рекомендации по alerting в `README_messenger.md` (health-check, Redis, доля 429/5xx по widget API).  
- Резерв при падении Redis ✅: in-memory fallback для widget session/капчи (деградация: не шарится между воркерами).  
  - Feature flags по inbox ✅: добавлен флаг `features.sse` (вкл/выкл SSE real-time для конкретного inbox; при выкл — виджет работает через poll).

---

## 2. Предлагаемое разбиение на фазы

Зависимости между пунктами учтены: сначала фундамент (регионы, статусы, расписание), затем эскалация и передача, затем реал-тайм и UX.

### Фаза A — фундамент ✅

| №  | Пункт | Описание |
|----|--------|----------|
| 1  | Общий чат + GeoIP | Общий пул чатов, определение региона по IP, правила «регион → ответственный», дефолтный филиал в настройках |
| 15 | Рабочие часы      | Настройка расписания в админке, поведение вне часов |
| 16 | Статус оператора  | Онлайн / отошёл / занят, учёт при назначении |
| 2  | Равномерное распределение | Доработка распределения с учётом статуса и нагрузки (сортировка по числу открытых диалогов + round-robin) |

### Фаза B — назначение и эскалация

| № | Пункт | Описание |
|---|--------|----------|
| 3 | Эскалация 4 мин ✅ | Таймер до первого открытия диалога (`assignee_assigned_at` / `assignee_opened_at`), команда `escalate_messenger_conversations`, передача следующему при отсутствии ответа |
| 4 | Передача на филиал ✅ | «Первый свободный в филиале X» (блок на странице диалога для глобального inbox) + выбор конкретного сотрудника из любого филиала (филиал диалога подставляется по выбранному оператору) |

### Фаза C — реал-тайм и UX

| № | Пункт | Описание |
|---|--------|----------|
| 5 | WebSockets/SSE ✅ (SSE) | SSE-стрим `/api/widget/stream/` + `EventSource` в виджете (fallback на poll), доставка сообщений/typing/оценки в реальном времени |
| 6 | «Печатает» ✅ | Redis TTL 8 с, POST /api/widget/typing/, poll возвращает operator_typing; в панели GET/POST .../typing/, «Клиент/оператор печатает» в UI |
| 7 | Доставлено/прочитано ✅ | read_at в Message, poll/bootstrap возвращают read_at, POST /api/widget/mark_read/ |
| 8 | Звук, уведомления, badge ✅ | Badge в меню «Диалоги» с числом непрочитанных |
| 9 | Непрочитанные ✅ | assignee_last_read_at, счётчики по диалогам и в меню |

### Фаза D — виджет и офлайн

| №  | Пункт | Описание |
|----|--------|----------|
| 10 | Вложения ✅ | Файлы/картинки в виджете (лимит размера/типов), Ctrl+V; оператор — прикрепление к ответу; GET /api/widget/attachment/<id>/ |
| 11 | Форматирование ✅ | Markdown-подобный рендер (**жирный**, ссылки, переносы строк) в виджете и панели оператора + поддержка эмодзи |
| 12 | Офлайн-режим ✅ | Inbox.settings.offline (enabled, message), bootstrap возвращает offline_mode/offline_message, виджет показывает баннер; заявки сохраняются в диалог |
| 13 | Оценка диалога ✅ | Conversation.rating_score/rating_comment/rated_at, настройки в Inbox (stars/NPS), poll возвращает rating_requested, POST /api/widget/rate/, виджет показывает форму оценки |
| 14 | Ленивая загрузка ✅ | widget-loader.js (data-load-after, data-load-on-scroll), код в настройках Inbox и README |

### Фаза E — супервизия и аналитика

| №  | Пункт | Описание |
|----|--------|----------|
| 17 | Супервизор ✅ | Админ видит любой диалог; режим «только просмотр» для чужих диалогов (нельзя отвечать), кнопка «взять в работу» через назначение себе |
| 18 | Аналитика ✅ | Admin-дашборд `/settings/messenger/analytics/`: диалоги по дням, среднее время 1-го ответа, топ операторов/филиалов |

### Фаза F — интеграции, безопасность, автоматизация, техника

| №  | Пункт | Описание |
|----|--------|----------|
| 19 | Интеграции | Каналы, email, webhook, API, Zapier/Make/n8n |
| 20 | Безопасность ✅ (домены) | Allowlist доменов в Inbox (Origin/Referer) для публичного widget API |
| 21 | Автоматизация и боты | Настраиваемые сценарии в админке |
| 22 | Техника | E2E, нагрузка, мониторинг, резерв Redis, feature flags по inbox |

---

## 3. Связанные документы

- **README_messenger.md** — обзор модуля, feature-флаг, БД, безопасность, production guide.
- **/settings/messenger/** — настройки виджета, inbox, маршрутизация, диагностика.

---

*Документ обновлён по приоритетам продукта. Фазы можно корректировать по срокам и ресурсам.*
